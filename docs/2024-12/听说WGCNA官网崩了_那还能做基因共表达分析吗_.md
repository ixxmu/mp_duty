---
title: "听说WGCNA官网崩了？那还能做基因共表达分析吗？"
date: 2024-12-14T01:09:49Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
听说WGCNA官网崩了？那还能做基因共表达分析吗？ by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>WGCNA共表达分析已经深入人心，是非常多数据挖掘文章中经常用来挖掘重要基因模块以及筛选核心hub基因的首选方法。</span></h3><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">我们在生信技能树多次写教程分享WGCNA的实战细节，见：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491248&amp;idx=1&amp;sn=afb11345a1e89cd57ace7dcf827dddbf&amp;scene=21#wechat_redirect" data-linktype="2">一文看懂WGCNA 分析(2019更新版)</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491248&amp;idx=2&amp;sn=2ca3ae271eccfbbf0b719d0a0e03439b&amp;scene=21#wechat_redirect" data-linktype="2">通过WGCNA作者的测试数据来学习</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491373&amp;idx=1&amp;sn=72a6d5c354ecfdde5b0f048caf3ff5cc&amp;scene=21#wechat_redirect" data-linktype="2">重复一篇WGCNA分析的文章（代码版）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491373&amp;idx=2&amp;sn=5bcca3300c1202575f0d6452b6233a4e&amp;scene=21#wechat_redirect" data-linktype="2">重复一篇WGCNA分析的文章（解读版）（逆向收费读文献2019-19）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247491577&amp;idx=1&amp;sn=5367bc46023235fab680f263b4578fb3&amp;scene=21#wechat_redirect" data-linktype="2">关键问题答疑：WGCNA的输入矩阵到底是什么格式</a></section></li></ul></section><h3 data-tool="mdnice编辑器"><span>但，不幸的是wgcna官网现在已经挂了：</span></h3><p data-tool="mdnice编辑器"><span>http://www.genetics.ucla.edu/labs/horvath/CoexpressionNetwork/Rpackages/WGCNA/Tutorials/index.html</span></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052060" data-ratio="0.6083086053412463" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUfflgh4St66c8d17y5b80qKIde4OiaSs7YKiczMs9NjJ3jw6fUBjM3icg0mg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="674" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUfflgh4St66c8d17y5b80qKIde4OiaSs7YKiczMs9NjJ3jw6fUBjM3icg0mg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">现在网上只能找到一些比较非正式的资料：</p><p data-tool="mdnice编辑器"><span>https://systemsbio.ucsd.edu/WGCNAdemo/</span></p><p data-tool="mdnice编辑器"><span>https://edo98811.github.io/WGCNA_official_documentation/</span></p><p data-tool="mdnice编辑器">既然如此，何必在一个树上挂死呢！现在来看看另一个做基因共表达分析的包吧：</p><h4 data-tool="mdnice编辑器">Simple Tidy GeneCoEx：https://github.com/cxli233/SimpleTidy_GeneCoEx</h4><p data-tool="mdnice编辑器">文献信息：</p><blockquote data-tool="mdnice编辑器"><p>Li C, Deans NC, Buell CR. "Simple Tidy GeneCoEx": A gene co-expression analysis workflow powered by tidyverse and graph-based clustering in R. Plant Genome. 2023 Jun;16(2):e20323. doi: 10.1002/tpg2.20323. Epub 2023 Apr 16. PMID: 37063055.</p></blockquote><h4 data-tool="mdnice编辑器">此方法特点：</h4><ul data-tool="mdnice编辑器"><li><section>由<strong>tidyverse和graph分析工具支持</strong>的基因共表达分析工作流程，这个工作流程非常简单和整洁。</section></li></ul><p data-tool="mdnice编辑器"><span>现在来进行简单的探索</span></p><h3 data-tool="mdnice编辑器">示例数据</h3><p data-tool="mdnice编辑器">本次分析使用的数据来自： <strong>Shinozaki et al., 2018 :https://www.nature.com/articles/s41467-017-02782-9，是一个番茄果实发育转录组数据，包含10个发育阶段和11种组织。</strong></p><p data-tool="mdnice编辑器">下载地址：https://zenodo.org/records/7536040（国内访问不是很方便）</p><p data-tool="mdnice编辑器">github上面：https://github.com/cxli233/SimpleTidy_GeneCoEx/tree/main/Data</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052062" data-ratio="0.6137624861265261" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffjWkjVuK4ZMvItcPX9438HQASrwIwYib1ZlVicOniaPzGGAr6zLswIBpow/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="901" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffjWkjVuK4ZMvItcPX9438HQASrwIwYib1ZlVicOniaPzGGAr6zLswIBpow/640?wx_fmt=png&amp;from=appmsg"><figcaption>A tissue/cell-based transcript profiling of developing tomato fruit</figcaption></figure><h3 data-tool="mdnice编辑器">分析目标：识别与已知果实成熟相关基因共表达的基因</h3><h3 data-tool="mdnice编辑器">加载包</h3><pre data-tool="mdnice编辑器"><code>library(tidyverse)<br>library(igraph)<br>library(ggraph)<br>library(readxl)<br>library(patchwork)<br>library(RColorBrewer)<br>library(viridis)<br>set.seed(666)<br></code></pre><h3 data-tool="mdnice编辑器">数据输入要求</h3><p data-tool="mdnice编辑器">本教程的数据可以在github上下载：<strong>https://github.com/cxli233/SimpleTidy_GeneCoEx/tree/main/Data</strong></p><ul data-tool="mdnice编辑器"><li><section>基因表达矩阵：TPM or FPKM</section></li><li><section>Metadata：每个样本的表型信息</section></li><li><section>Bait genes：已知的感兴趣的基因，非必须</section></li></ul><pre data-tool="mdnice编辑器"><code><br><span># 有32496个基因和484列。第一列是基因ID，总共有483个样本</span><br>Exp_table &lt;- read_csv(<span>"Shinozaki_tpm_representative_transcripts.csv"</span>, col_types = cols())<br>head(Exp_table)<br>dim(Exp_table)<br><br><span># Metadata</span><br>Metadata &lt;- read_excel(<span>"SimpleTidy_GeneCoEx-main/Data/Shinozaki_datasets_SRA_info.xlsx"</span>)<br>head(Metadata)<br>dim(Metadata)<br></code></pre><p data-tool="mdnice编辑器">数据如下：<span><strong>有483个样本和17种不同的技术或样本表型</strong></span></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052061" data-ratio="0.22037037037037038" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffWANA6Gib7HZicOQbUIBdRXzo2N0IiaYrIqnF9q3X3Rqle4TL19fsoD9mg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffWANA6Gib7HZicOQbUIBdRXzo2N0IiaYrIqnF9q3X3Rqle4TL19fsoD9mg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">Bait genes</p><p data-tool="mdnice编辑器">在这个例子中，我们有两个诱饵基因，PG和PSY1。</p><ul data-tool="mdnice编辑器"><li><section>PG参与使果实变软：https://www.annualreviews.org/doi/pdf/10.1146/annurev.pp.42.060191.003331。</section></li><li><section>PSY1参与产生果实的红色：https://link.springer.com/article/10.1007/BF00047400。</section></li></ul><pre data-tool="mdnice编辑器"><code>Baits &lt;- read_delim(<span>"SimpleTidy_GeneCoEx-main/Data/Genes_of_interest.txt"</span>, delim = <span>"\t"</span>, col_names = F, col_types = cols())<br>head(Baits)<br><br><span># A tibble: 2 × 2</span><br>  X1    X2                 <br>  &lt;chr&gt; &lt;chr&gt;              <br>1 PG    Solly.M82.10G020850<br>2 PSY1  Solly.M82.03G005440<br></code></pre><h3 data-tool="mdnice编辑器">理解实验设计</h3><p data-tool="mdnice编辑器">在开始进行任何分析之前，我会首先尝试理解实验设计。对实验设计有良好的理解有助于我决定如何分析和可视化数据。</p><p data-tool="mdnice编辑器">关键问题包括：</p><p data-tool="mdnice编辑器">变异的来源是什么？复制的水平是什么？这metadata就派上用场了。</p><pre data-tool="mdnice编辑器"><code>Metadata %&gt;% <br>  group_by(dev_stage) %&gt;% <br>  count()<br>  <br><span># A tibble: 16 × 2</span><br><span># Groups:   dev_stage [16]</span><br>   dev_stage         n<br>   &lt;chr&gt;         &lt;int&gt;<br> 1 10 DPA           39<br> 2 20 DPA           39<br> 3 30 DPA           24<br> 4 5 DPA            36<br> 5 Anthesis         18<br> 6 Br-equatorial    39<br> 7 Br-stem          24<br> 8 Br-stylar        20<br> 9 LR               39<br>10 MG-equatorial    39<br>11 MG-stem          24<br>12 MG-stylar        20<br>13 Pk-equatorial    39<br>14 Pk-stem          24<br>15 Pk-stylar        20<br>16 RR               39<br></code></pre><p data-tool="mdnice编辑器">根据metadata数据，有16个发育阶段。根据论文，发育阶段的顺序是：这里的数据比文章中的多一些，后面可以筛选一下数据</p><pre data-tool="mdnice编辑器"><code>1. Anthesis<br>2. 5 DAP<br>3. 10 DAP<br>4. 20 DAP<br>5. 30 DAP<br>6. MG<br>7. Br<br>8. Pk<br>9. LR<br>10. RR<br></code></pre><p data-tool="mdnice编辑器">总共有11种组织：</p><pre data-tool="mdnice编辑器"><code>Metadata %&gt;% <br>  group_by(tissue) %&gt;% <br>  count()<br>  <br><span># A tibble: 11 × 2</span><br><span># Groups:   tissue [11]</span><br>   tissue              n<br>   &lt;chr&gt;           &lt;int&gt;<br> 1 Collenchyma        24<br> 2 Columella          51<br> 3 Inner epidermis    24<br> 4 Locular tissue     62<br> 5 Outer epidermis    24<br> 6 Parenchyma         24<br> 7 Placenta           62<br> 8 Seeds              62<br> 9 Septum             63<br>10 Total pericarp     63<br>11 Vascular tissue    24<br></code></pre><p data-tool="mdnice编辑器">这是一个双因素实验设计：<strong>发育阶段 * 组织</strong>。主要的变异来源是发育阶段、组织和重复样本。我通常会制作一个汇总表来指导我的下游分析：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052059" data-ratio="0.4103852596314908" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUff8hl67ibp3G7IcZwrq3pIg1RaGia7JhhzZOCjWXjLL8lFia4DSJI8EaKEA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="597" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUff8hl67ibp3G7IcZwrq3pIg1RaGia7JhhzZOCjWXjLL8lFia4DSJI8EaKEA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">发育阶段可以作为数值变量或定性变量进行分析。</p><p data-tool="mdnice编辑器">现在我们了解了实验设计，接下来我们将确定实验中变异的主要驱动因素。换句话说，<strong>在发育阶段和组织之间，哪个因素对实验中的变异贡献更大？</strong>这个问题的答案对于我们如何最有效地可视化数据至关重要。</p><p data-tool="mdnice编辑器">获得实验全局视图的一个好方法是进行主成分分析（PCA）。</p><pre data-tool="mdnice编辑器"><code>Exp_table_long &lt;- Exp_table %&gt;% <br>  rename(gene_ID = `...1`) %&gt;% <br>  pivot_longer(cols = !gene_ID, names_to = <span>"library"</span>, values_to = <span>"tpm"</span>) %&gt;% <br>  mutate(logTPM = log10(tpm + 1)) <br><br>head(Exp_table_long)<br><br><span># A tibble: 6 × 4</span><br>  gene_ID               library      tpm logTPM<br>  &lt;chr&gt;                 &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;<br>1 Solly.M82.08G017810.4 SRR5724446  66.8   1.83<br>2 Solly.M82.08G017810.4 SRR5724445  67.0   1.83<br>3 Solly.M82.08G017810.4 SRR5724444  88.0   1.95<br>4 Solly.M82.08G017810.4 SRR5724443  95.4   1.98<br>5 Solly.M82.08G017810.4 SRR5724044  92.1   1.97<br>6 Solly.M82.08G017810.4 SRR5724442 105.    2.03<br></code></pre><h3 data-tool="mdnice编辑器">PCA分析（质量控制）</h3><p>我们可以简单的看一下这个实验设计，数据的基本情况：<br></p><pre data-tool="mdnice编辑器"><code><span># 数据变换</span><br>Exp_table_log_wide &lt;- Exp_table_long %&gt;% <br>  select(gene_ID, library, logTPM) %&gt;% <br>  pivot_wider(names_from = library, values_from = logTPM)<br><br>head(Exp_table_log_wide)<br><br><span># pca分析</span><br>my_pca &lt;- prcomp(t(Exp_table_log_wide[, -1]))<br>pc_importance &lt;- as.data.frame(t(summary(my_pca)<span>$importance</span>))<br>head(pc_importance, 20)<br><br><span># 绘图</span><br>PCA_coord &lt;- my_pca<span>$x</span>[, 1:10] %&gt;% <br>  as.data.frame() %&gt;% <br>  mutate(Run = row.names(.)) %&gt;% <br>  full_join(Metadata %&gt;% <br>              select(Run, tissue, dev_stage, `Library Name`, `Sample Name`), by = <span>"Run"</span>)<br><br>head(PCA_coord)<br><br><span># 选择10个developmental stages</span><br>PCA_coord &lt;- PCA_coord %&gt;% <br>  mutate(stage = case_when(<br>    str_detect(dev_stage, <span>"MG|Br|Pk"</span>) ~ str_sub(dev_stage, start = 1, end = 2),<br>    T ~ dev_stage<br>  )) %&gt;% <br>  mutate(stage = factor(stage, levels = c(<br>   <span>"Anthesis"</span>,<span>"5 DPA"</span>,<span>"10 DPA"</span>,<span>"20 DPA"</span>,<span>"30 DPA"</span>,<span>"MG"</span>,<span>"Br"</span>,<span>"Pk"</span>,<span>"LR"</span>,<span>"RR"</span><br>  ))) %&gt;% <br>  mutate(dissection_method = case_when(<br>    str_detect(tissue, <span>"epidermis"</span>) ~ <span>"LM"</span>,<br>    str_detect(tissue, <span>"Collenchyma"</span>) ~ <span>"LM"</span>,<br>    str_detect(tissue, <span>"Parenchyma"</span>) ~ <span>"LM"</span>,<br>    str_detect(tissue, <span>"Vascular"</span>) ~ <span>"LM"</span>,<br>    str_detect(dev_stage, <span>"Anthesis"</span>) ~ <span>"LM"</span>,<br>    str_detect(dev_stage, <span>"5 DPA"</span>) &amp;<br>      str_detect(tissue, <span>"Locular tissue|Placenta|Seeds"</span>) ~ <span>"LM"</span>,<br>    T ~ <span>"Hand"</span><br>  ))<br><br>head(PCA_coord)<br></code></pre><p data-tool="mdnice编辑器">绘图：</p><pre data-tool="mdnice编辑器"><code>PCA_by_method &lt;- PCA_coord %&gt;% <br>  ggplot(aes(x = PC1, y = PC2)) +<br>  geom_point(aes(fill = dissection_method), color = <span>"grey20"</span>, shape = 21, size = 3, alpha = 0.8) +<br>  scale_fill_manual(values = brewer.pal(n = 3, <span>"Accent"</span>)) +<br>  labs(x = paste0(<span>"PC1 ("</span>, pc_importance[1, 2] %&gt;% signif(3)*100, <span>"% of Variance)"</span>), <br>       y = paste0(<span>"PC2 ("</span>, pc_importance[2, 2] %&gt;% signif(3)*100, <span>"% of Variance)"</span>, <span>"  "</span>),<br>       fill = NULL) +  <br>  theme_bw() +<br>  theme(<br>    text = element_text(size= 14),<br>    axis.text = element_text(color = <span>"black"</span>)<br>  )<br><br>PCA_by_method<br><br>ggsave(<span>"PCA_by_dissection_method.png"</span>, height = 3, width = 4, <span>bg</span> = <span>"white"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下：根据论文，5个果皮组织是通过激光捕获显微切割（LM）收集的。首先需要注意的是技术差异。<strong>看来解剖方法确实是变异的主要来源，与PC1完全对应。</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052063" data-ratio="0.7407407407407407" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffUOW1RCvwyktcD5WbNGH7MDcYtLDmZsAMhtyy7GGJZpqLdgU4CUvPibg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffUOW1RCvwyktcD5WbNGH7MDcYtLDmZsAMhtyy7GGJZpqLdgU4CUvPibg/640?wx_fmt=png&amp;from=appmsg"><figcaption>PCA结果</figcaption></figure><p data-tool="mdnice编辑器">对于生物学解释来说，那么最好查看PC2和PC3：</p><pre data-tool="mdnice编辑器"><code><span># by_tissue</span><br>PCA_by_tissue &lt;- PCA_coord %&gt;% <br>  ggplot(aes(x = PC2, y = PC3)) +<br>  geom_point(aes(fill = tissue), color = <span>"grey20"</span>, shape = 21, size = 3, alpha = 0.8) +<br>  scale_fill_manual(values = brewer.pal(11, <span>"Set3"</span>)) +<br>  labs(x = paste(<span>"PC2 ("</span>, pc_importance[2, 2] %&gt;% signif(3)*100, <span>"% of Variance)"</span>, sep = <span>""</span>), <br>       y = paste(<span>"PC3 ("</span>, pc_importance[3, 2] %&gt;% signif(3)*100, <span>"% of Variance)"</span>, <span>"  "</span>, sep = <span>""</span>),<br>       fill = <span>"tissue"</span>) +  <br>  theme_bw() +<br>  theme(<br>    text = element_text(size= 14),<br>    axis.text = element_text(color = <span>"black"</span>)<br>  )<br><br><span># by_stage</span><br>PCA_by_stage &lt;- PCA_coord %&gt;% <br>  ggplot(aes(x = PC2, y = PC3)) +<br>  geom_point(aes(fill = stage), color = <span>"grey20"</span>, shape = 21, size = 3, alpha = 0.8) +<br>  scale_fill_manual(values = viridis(10, option = <span>"D"</span>)) +<br>  labs(x = paste(<span>"PC2 ("</span>, pc_importance[2, 2] %&gt;% signif(3)*100, <span>"% of Variance)"</span>, sep = <span>""</span>), <br>       y = paste(<span>"PC3 ("</span>, pc_importance[3, 2] %&gt;% signif(3)*100, <span>"% of Variance)"</span>, <span>"  "</span>, sep = <span>""</span>),<br>       fill = <span>"stage"</span>) +  <br>  theme_bw() +<br>  theme(<br>    text = element_text(size= 14),<br>    axis.text = element_text(color = <span>"black"</span>)<br>  )<br><br>wrap_plots(PCA_by_stage, PCA_by_tissue, nrow = 1)<br>ggsave(<span>"PCA_by_stage_tissue.png"</span>, height = 3.5, width = 8.5, <span>bg</span> = <span>"white"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100052068" data-ratio="0.40925925925925927" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUff5naQNvf7GSAuCGyQoFn4FzjhiaM4TY66ibTOiaPyAicHhg3JYMqYLribyxg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUff5naQNvf7GSAuCGyQoFn4FzjhiaM4TY66ibTOiaPyAicHhg3JYMqYLribyxg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>现在x轴（PC2）明显区分了发育阶段：从左到右，从年轻到老年。y轴（PC3）明显区分了种子和所有其他东西。</strong></p><p data-tool="mdnice编辑器">因此，<strong>在变异贡献方面，解剖方法 &gt; 阶段 &gt; 组织</strong>。我们将使用这些信息来指导下游的可视化。为了最好地区分生物学变异和技术变异，我们应该对手收集和LM样本进行单独的基因共表达分析。</p><p data-tool="mdnice编辑器">下面使用手收集的样本。</p><h3 data-tool="mdnice编辑器"><span>Gene co-expression分析（接下来正式进行类似的wgcna的模块分析，共表达）</span></h3><h4 data-tool="mdnice编辑器">1.首先对重复的样本进行取均值</h4><p data-tool="mdnice编辑器">这不是一个必须的操作，只因为我们对组织-阶段组合之间的生物学变异感兴趣，而对同一处理中复制品之间的噪声不太感兴趣。<strong>（有点类似于mfuzz的时间序列分析）</strong></p><p data-tool="mdnice编辑器">再次强调，这是一个基于tidyverse的工作流程。</p><pre data-tool="mdnice编辑器"><code>Exp_table_long_averaged &lt;- Exp_table_long %&gt;% <br>  full_join(PCA_coord %&gt;% <br>              select(Run, `Sample Name`, tissue, dev_stage, dissection_method), <br>            by = c(<span>"library"</span>=<span>"Run"</span>)) %&gt;% <br>  filter(dissection_method == <span>"Hand"</span>) %&gt;% <br>  group_by(gene_ID, `Sample Name`, tissue, dev_stage) %&gt;% <br>  summarise(mean.logTPM = mean(logTPM)) %&gt;% <br>  ungroup()  <br><br>head(Exp_table_long_averaged)<br></code></pre><h4 data-tool="mdnice编辑器">2.Z score</h4><p data-tool="mdnice编辑器">它将每个基因的表达模式标准化为均值 = 0，标准差 = 1。</p><pre data-tool="mdnice编辑器"><code>Exp_table_long_averaged_z &lt;- Exp_table_long_averaged %&gt;% <br>  group_by(gene_ID) %&gt;% <br>  mutate(z.score = (mean.logTPM - mean(mean.logTPM))/sd(mean.logTPM)) %&gt;% <br>  ungroup()<br><br>head(Exp_table_long_averaged_z)<br><br><span># A tibble: 6 × 6</span><br>  gene_ID               `Sample Name` tissue         dev_stage mean.logTPM z.score<br>  &lt;chr&gt;                 &lt;chr&gt;         &lt;chr&gt;          &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;<br>1 Solly.M82.00G000010.1 J10           Placenta       10 DPA         0       -0.362<br>2 Solly.M82.00G000010.1 J11           Locular tissue 10 DPA         0       -0.362<br>3 Solly.M82.00G000010.1 J12           Seeds          10 DPA         0       -0.362<br>4 Solly.M82.00G000010.1 J14           Columella      20 DPA         0       -0.362<br>5 Solly.M82.00G000010.1 J15           Total pericarp 20 DPA         0       -0.362<br>6 Solly.M82.00G000010.1 J16           Septum         20 DPA         0.0552   2.91 <br></code></pre><h4 data-tool="mdnice编辑器">3.Gene selection</h4><p data-tool="mdnice编辑器">下一步是将每个基因与所有其他基因进行相关性分析。<strong>相关性的数量会随着基因数量的平方而增加。</strong>为了加速，我们可以选择只有高变异基因。<strong>背后的理念是，如果一个基因在所有样本中表达水平相似，那么它不太可能特别参与某个特定阶段或组织的生物学过程。</strong></p><p data-tool="mdnice编辑器">选择高变异基因有多种方法和多个截止值。例如，你可以计算所有基因的logTPM的基因级方差，并取上三分位数。<strong>你可以选择在所有组织中具有一定表达水平的基因（比如说&gt; 5 tpm），然后取高变异基因。这些都是任意的。</strong></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">Biostar创始人István Albert博士的生物信息书籍Biostar Handbook提到了几个原则：</p><ul data-tool="mdnice编辑器"><li><section><pre><code>规则1：没有“通用”的规则（所有的阈值都是可以人为指定）<br></code></pre></section></li><li><section><pre><code>规则2：每个看似基本的范例都有一个或多个例外（什么是基因，什么是非编码，什么是内含子）<br></code></pre></section></li><li><section><pre><code>规则3：生物信息学方法的有效性取决于数据的未知特征（mRNA表达量是否代表蛋白质表达量）<br></code></pre></section></li><li><section><pre><code>规则4：生物学总是比你想象的更复杂（比如所谓的通路上下调问题，多组学结合）<br></code></pre></section></li></ul></section><p data-tool="mdnice编辑器"><strong>你随意选择。</strong></p><pre data-tool="mdnice编辑器"><code><span># 高变基因选择</span><br>high_var_genes &lt;- Exp_table_long_averaged_z %&gt;% <br>  group_by(gene_ID) %&gt;% <br>  summarise(var = var(mean.logTPM)) %&gt;%  <span># 这计算了每个基因的logTPM的方差。</span><br>  ungroup() %&gt;% <br>  filter(var &gt; quantile(var, 0.667))<br><br>head(high_var_genes)<br>dim(high_var_genes)<br></code></pre><p data-tool="mdnice编辑器">本次示例中，我们只取方差最高的5000个基因作为一个快速练习。<strong>在实际分析中需要包含更多的基因，但是相关性分析中的基因越多，速度就会越慢。</strong></p><pre data-tool="mdnice编辑器"><code>high_var_genes5000 &lt;- high_var_genes %&gt;% <br>  slice_max(order_by = var, n = 5000) <br><br>head(high_var_genes5000)<br></code></pre><p data-tool="mdnice编辑器">检查分析中是否包含了足够多的基因，一<strong>个好方法是查看诱饵基因是否在方差最高的基因之中。前面找的两个诱饵基因为PG 、PSY1，都在数据中。</strong></p><pre data-tool="mdnice编辑器"><code>high_var_genes5000 %&gt;% <br>  filter(str_detect(gene_ID, Baits<span>$X2</span>[1]))<br><br>high_var_genes5000 %&gt;% <br>  filter(str_detect(gene_ID, Baits<span>$X2</span>[2]))<br>  <br><span># 提取这5000个基因对应的数据</span><br>Exp_table_long_averaged_z_high_var &lt;- Exp_table_long_averaged_z %&gt;% <br>  filter(gene_ID %<span>in</span>% high_var_genes5000<span>$gene_ID</span>)<br>head(Exp_table_long_averaged_z_high_var)<br></code></pre><h4 data-tool="mdnice编辑器">4.Gene-wise correlation</h4><p data-tool="mdnice编辑器">现在我们可以将每个基因与所有其他基因进行相关性分析。这个工作流程的本质是简单的，<span><strong>如果你愿意，你可以使用更复杂的方法，比如GENIE3。</strong></span></p><pre data-tool="mdnice编辑器"><code><span># 数据转换</span><br>z_score_wide &lt;- Exp_table_long_averaged_z_high_var %&gt;% <br>  select(gene_ID, `Sample Name`, z.score) %&gt;% <br>  pivot_wider(names_from = `Sample Name`, values_from = z.score) %&gt;% <br>  as.data.frame()<br>row.names(z_score_wide) &lt;- z_score_wide<span>$gene_ID</span><br>head(z_score_wide)<br><br><span># 相关性计算</span><br>cor_matrix &lt;- cor(t(z_score_wide[, -1])) <span># 使用cor()函数</span><br>dim(cor_matrix)<br>cor_matrix[1:5,1:5]<br></code></pre><h4 data-tool="mdnice编辑器">5.Edge selection</h4><p data-tool="mdnice编辑器">并不是所有的相关性都是统计上显著的，也不是所有的相关性在生物学上都是有意义的。我们如何选择在下游分析中使用哪些相关性。<strong>我将这一步称为“边的选择”，其中每个基因是一个节点，每个相关性是一条边</strong>。我有两种方法可以做到这一点。</p><ol data-tool="mdnice编辑器"><li><section>t分布近似 t distribution approximation</section></li><li><section>使用秩分布的经验确定 Empirical determination using rank distribution</section></li></ol><p data-tool="mdnice编辑器"><strong>t分布近似 t distribution approximation</strong></p><p data-tool="mdnice编辑器">我们有我们有84个独特的组织-阶段组合样本，从 r 计算t统计量，并使用t分布计算p值。</p><pre data-tool="mdnice编辑器"><code><span># 生成上三角矩阵</span><br>cor_matrix_upper_tri &lt;- cor_matrix<br>cor_matrix_upper_tri[lower.tri(cor_matrix_upper_tri)] &lt;- NA<br><br><br>number_of_tissue_stage &lt;- ncol(z_score_wide) - 1 <span># 样本数</span><br>edge_table &lt;- cor_matrix_upper_tri %&gt;% <br>  as.data.frame() %&gt;% <br>  mutate(from = row.names(cor_matrix)) %&gt;% <br>  pivot_longer(cols = !from, names_to = <span>"to"</span>, values_to = <span>"r"</span>) %&gt;% <br>  filter(is.na(r) == F) %&gt;% <br>  filter(from != to) %&gt;% <br>  mutate(t = r*sqrt((number_of_tissue_stage-2)/(1-r^2))) %&gt;% <br>  mutate(p.value = case_when(<br>    t &gt; 0 ~ pt(t, df = number_of_tissue_stage-2, lower.tail = F),<br>    t &lt;=0 ~ pt(t, df = number_of_tissue_stage-2, lower.tail = T)<br>  )) %&gt;% <br>  mutate(FDR = p.adjust(p.value, method = <span>"fdr"</span>)) <br><br>head(edge_table)<br><br><span># A tibble: 6 × 6</span><br>  from                  to                          r      t  p.value      FDR<br>  &lt;chr&gt;                 &lt;chr&gt;                   &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;<br>1 Solly.M82.00G000190.3 Solly.M82.00G000220.1 -0.0981 -0.892 1.87e- 1 2.13e- 1<br>2 Solly.M82.00G000190.3 Solly.M82.00G000230.1 -0.0307 -0.278 3.91e- 1 4.06e- 1<br>3 Solly.M82.00G000190.3 Solly.M82.00G000270.1  0.703   8.94  4.70e-14 2.81e-13<br>4 Solly.M82.00G000190.3 Solly.M82.00G000460.1  0.833  13.6   4.85e-23 9.13e-22<br>5 Solly.M82.00G000190.3 Solly.M82.00G000500.1  0.436   4.38  1.72e- 5 3.73e- 5<br>6 Solly.M82.00G000190.3 Solly.M82.00G000590.1 -0.116  -1.05  1.48e- 1 1.72e- 1<br></code></pre><p data-tool="mdnice编辑器">筛选边：查看R值分布</p><p data-tool="mdnice编辑器">随机抽取了20k条边并绘制了一个直方图。也可以绘制整个边表，当你抽样足够大时，它不会改变分布的形状。看起来在 r&gt;0.7（红线）时，分布迅速减少。因此，使用 r&gt;0.7<em>r</em>作为截止值。</p><pre data-tool="mdnice编辑器"><code>edge_table %&gt;% <br>  slice_sample(n = 20000) %&gt;% <br>  ggplot(aes(x = r)) +<br>  geom_histogram(color = <span>"white"</span>, bins = 100) +<br>  geom_vline(xintercept = 0.7, color = <span>"tomato1"</span>, size = 1.2) +<br>  theme_classic() +<br>  theme(<br>    text = element_text(size = 14),<br>    axis.text = element_text(color = <span>"black"</span>)<br>  )<br>ggsave(<span>"r_histogram.png"</span>, height = 3.5, width = 5, <span>bg</span> = <span>"white"</span>)<br><br><span># 选择边</span><br>edge_table_select &lt;- edge_table %&gt;% <br>  filter(r &gt;= 0.7)<br>dim(edge_table_select)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100052065" data-ratio="0.6842592592592592" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffjSxcJ449W9uuVDm8KhPeXXL33uyibZicZmWAtlhwCwAQbvon51ibOWA6Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffjSxcJ449W9uuVDm8KhPeXXL33uyibZicZmWAtlhwCwAQbvon51ibOWA6Q/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器">6.Module detection</h4><p data-tool="mdnice编辑器">使用Leiden算法来检测模块，这是一种基于图的聚类方法。Leiden方法产生的聚类中，成员之间高度相互连接<strong>。在基因共表达的术语中，它寻找彼此高度相关的基因组。</strong></p><p data-tool="mdnice编辑器">我们需要两样东西。</p><ol data-tool="mdnice编辑器"><li><section>来自边表的非冗余基因ID。</section></li><li><section>功能注释，我已经下载了。</section></li></ol><pre data-tool="mdnice编辑器"><code>M82_funct_anno &lt;- read_delim(<span>"SimpleTidy_GeneCoEx-main/Data/M82.functional_annotation.txt"</span>, delim = <span>"\t"</span>, col_names = F, col_types = cols())<br>head(M82_funct_anno)<br><br>node_table &lt;- data.frame(<br>  gene_ID = c(edge_table_select<span>$from</span>, edge_table_select<span>$to</span>) %&gt;% unique()<br>) %&gt;% <br>  left_join(M82_funct_anno, by = c(<span>"gene_ID"</span>=<span>"X1"</span>)) %&gt;% <br>  rename(functional_annotation = X2)<br>head(node_table)<br>dim(node_table)<br></code></pre><p data-tool="mdnice编辑器"><strong>创建网络对象</strong></p><p data-tool="mdnice编辑器">分辨率参数（resolution_parameter）控制你将获得多少个聚类。它的值越大，得到的聚类就越多。</p><pre data-tool="mdnice编辑器"><code>my_network &lt;- graph_from_data_frame(<br>  edge_table_select,<br>  vertices = node_table,<br>  directed = F<br>)<br><br><span># Graph based clustering</span><br>modules &lt;- cluster_leiden(my_network, resolution_parameter = 2, <br>                          objective_function = <span>"modularity"</span>)<br></code></pre><p data-tool="mdnice编辑器">接下来，我们需要将模块成员与基因ID关联起来</p><pre data-tool="mdnice编辑器"><code>my_network_modules &lt;- data.frame(<br>  gene_ID = names(membership(modules)),<br>  module = as.vector(membership(modules)) <br>) %&gt;% <br>  inner_join(node_table, by = <span>"gene_ID"</span>)<br>head(my_network_modules)<br><br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100052064" data-ratio="0.13703703703703704" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffxJUXDccBzz8ECgc4LOiaUZ6z0G0AF0cLicvOgGxN9UzucHsGygD7PN0g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffxJUXDccBzz8ECgc4LOiaUZ6z0G0AF0cLicvOgGxN9UzucHsGygD7PN0g/640?wx_fmt=png&amp;from=appmsg"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">接下来，我们将只使用包含5个或更多基因的模块。</p><pre data-tool="mdnice编辑器"><code>module_5 &lt;- my_network_modules %&gt;% <br>  group_by(module) %&gt;% <br>  count() %&gt;% <br>  arrange(-n) %&gt;% <br>  filter(n &gt;= 5)<br><br>my_network_modules &lt;- my_network_modules %&gt;% <br>  filter(module %<span>in</span>% module_5<span>$module</span>)<br><br>head(my_network_modules)<br></code></pre><h4 data-tool="mdnice编辑器">7.Module-treatment correspondance</h4><p data-tool="mdnice编辑器">下一个关键任务是理解聚类的表达模式</p><pre data-tool="mdnice编辑器"><code>Exp_table_long_averaged_z_high_var_modules &lt;- Exp_table_long_averaged_z_high_var %&gt;% <br>  inner_join(my_network_modules, by = <span>"gene_ID"</span>)<br>head(Exp_table_long_averaged_z_high_var_modules)<br></code></pre><p data-tool="mdnice编辑器">还可以通过折线图来对聚类进行质量控制（QC）。如果绘制所有模块的图，那会太多，所以我们只选择2个模块来查看。</p><p data-tool="mdnice编辑器">我选择了：</p><ul data-tool="mdnice编辑器"><li><section><p>模块1，它在5 DAP（天前收获）时表达最高——一个早期表达的聚类。</p></section></li><li><section><p>模块5，我们的诱饵基因所在的模块——一个晚期表达的聚类。</p></section></li></ul><pre data-tool="mdnice编辑器"><code><span>## QC</span><br>modules_mean_z &lt;- Exp_table_long_averaged_z_high_var_modules %&gt;% <br>  group_by(module, dev_stage, tissue, `Sample Name`) %&gt;% <br>  summarise(mean.z = mean(z.score)) %&gt;% <br>  ungroup()<br><br>module_line_plot &lt;- Exp_table_long_averaged_z_high_var_modules %&gt;% <br>  mutate(order_x = case_when(<br>    str_detect(dev_stage, <span>"5"</span>) ~ 1,<br>    str_detect(dev_stage, <span>"10"</span>) ~ 2,<br>    str_detect(dev_stage, <span>"20"</span>) ~ 3,<br>    str_detect(dev_stage, <span>"30"</span>) ~ 4,<br>    str_detect(dev_stage, <span>"MG"</span>) ~ 5,<br>    str_detect(dev_stage, <span>"Br"</span>) ~ 6,<br>    str_detect(dev_stage, <span>"Pk"</span>) ~ 7,<br>    str_detect(dev_stage, <span>"LR"</span>) ~ 8,<br>    str_detect(dev_stage, <span>"RR"</span>) ~ 9<br>  )) %&gt;% <br>  mutate(dev_stage = reorder(dev_stage, order_x)) %&gt;% <br>  filter(module == <span>"1"</span> |<br>           module == <span>"5"</span>) %&gt;% <br>  ggplot(aes(x = dev_stage, y = z.score)) +<br>  facet_grid(module ~ tissue) +<br>  geom_line(aes(group = gene_ID), alpha = 0.3, color = <span>"grey70"</span>) +<br>  geom_line(<br>    data = modules_mean_z %&gt;% <br>      filter(module == <span>"1"</span> |<br>               module == <span>"5"</span>) %&gt;% <br>      mutate(order_x = case_when(<br>        str_detect(dev_stage, <span>"5"</span>) ~ 1,<br>        str_detect(dev_stage, <span>"10"</span>) ~ 2,<br>        str_detect(dev_stage, <span>"20"</span>) ~ 3,<br>        str_detect(dev_stage, <span>"30"</span>) ~ 4,<br>        str_detect(dev_stage, <span>"MG"</span>) ~ 5,<br>        str_detect(dev_stage, <span>"Br"</span>) ~ 6,<br>        str_detect(dev_stage, <span>"Pk"</span>) ~ 7,<br>        str_detect(dev_stage, <span>"LR"</span>) ~ 8,<br>        str_detect(dev_stage, <span>"RR"</span>) ~ 9<br>      )) %&gt;% <br>      mutate(dev_stage = reorder(dev_stage, order_x)),<br>    aes(y = mean.z, group = module), <br>    size = 1.1, alpha = 0.8<br>  ) +<br>  labs(x = NULL,<br>       y = <span>"z score"</span>) +<br>  theme_classic() +<br>  theme(<br>    text = element_text(size = 14),<br>    axis.text = element_text(color = <span>"black"</span>),<br>    axis.text.x = element_blank(),<br>    panel.spacing = unit(1, <span>"line"</span>)<br>  )<br><br>module_lines_color_strip &lt;- expand.grid(<br>  tissue = unique(Metadata<span>$tissue</span>),<br>  dev_stage = unique(Metadata<span>$dev_stage</span>), <br>  stringsAsFactors = F<br>) %&gt;% <br>  filter(dev_stage != <span>"Anthesis"</span>) %&gt;% <br>  filter(str_detect(tissue, <span>"epider|chyma|Vasc"</span>) == F) %&gt;% <br>  mutate(order_x = case_when(<br>    str_detect(dev_stage, <span>"5"</span>) ~ 1,<br>    str_detect(dev_stage, <span>"10"</span>) ~ 2,<br>    str_detect(dev_stage, <span>"20"</span>) ~ 3,<br>    str_detect(dev_stage, <span>"30"</span>) ~ 4,<br>    str_detect(dev_stage, <span>"MG"</span>) ~ 5,<br>    str_detect(dev_stage, <span>"Br"</span>) ~ 6,<br>    str_detect(dev_stage, <span>"Pk"</span>) ~ 7,<br>    str_detect(dev_stage, <span>"LR"</span>) ~ 8,<br>    str_detect(dev_stage, <span>"RR"</span>) ~ 9<br>  )) %&gt;% <br>  mutate(stage = case_when(<br>    str_detect(dev_stage, <span>"MG|Br|Pk"</span>) ~ str_sub(dev_stage, start = 1, end = 2),<br>    T ~ dev_stage<br>  )) %&gt;% <br>  mutate(stage = factor(stage, levels = c(<br>    <span>"5 DPA"</span>,<br>    <span>"10 DPA"</span>,<br>    <span>"20 DPA"</span>,<br>    <span>"30 DPA"</span>,<br>    <span>"MG"</span>,<br>    <span>"Br"</span>,<br>    <span>"Pk"</span>,<br>    <span>"LR"</span>,<br>    <span>"RR"</span><br>  ))) %&gt;% <br>  mutate(dev_stage = reorder(dev_stage, order_x)) %&gt;% <br>  ggplot(aes(x = dev_stage, y = 1)) +<br>  facet_grid(. ~ tissue) +<br>  geom_tile(aes(fill = stage)) +<br>  scale_fill_manual(values = viridis(9, option = <span>"D"</span>)) +<br>  theme_void() +<br>  theme(<br>    legend.position = <span>"bottom"</span>,<br>    strip.text = element_blank(),<br>    text = element_text(size = 14),<br>    panel.spacing = unit(1, <span>"lines"</span>)<br>  )<br><br>wrap_plots(module_line_plot, module_lines_color_strip, nrow = 2, heights = c(1, 0.08))<br>ggsave(<span>"module_line_plots.png"</span>, height = 4, width = 8.2, <span>bg</span> = <span>"white"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100052066" data-ratio="0.46944444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffib9lV4BpPc9Ic7gKzZeVaywylIeofI4ic78mgNdjLkVGt8o8COhCFKdA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffib9lV4BpPc9Ic7gKzZeVaywylIeofI4ic78mgNdjLkVGt8o8COhCFKdA/640?wx_fmt=png&amp;from=appmsg"><figcaption>module_line_plots</figcaption></figure><p data-tool="mdnice编辑器"><strong>聚类热图表示</strong></p><p data-tool="mdnice编辑器">呈现这些模块的一个好方法是制作热图。</p><pre data-tool="mdnice编辑器"><code><span># 数据预处理 This sets z scores &gt; 1.5 or &lt; -1.5 to 1.5 or -1.5, respectively</span><br>modules_mean_z &lt;- modules_mean_z %&gt;% <br>  mutate(mean.z.clipped = case_when(<br>    mean.z &gt; 1.5 ~ 1.5,<br>    mean.z &lt; -1.5 ~ -1.5,<br>    T ~ mean.z<br>  ))<br>  <br><span># Reorder rows and columns</span><br>modules_mean_z &lt;- modules_mean_z %&gt;% <br>  mutate(order_x = case_when(<br>        str_detect(dev_stage, <span>"5"</span>) ~ 1,<br>        str_detect(dev_stage, <span>"10"</span>) ~ 2,<br>        str_detect(dev_stage, <span>"20"</span>) ~ 3,<br>        str_detect(dev_stage, <span>"30"</span>) ~ 4,<br>        str_detect(dev_stage, <span>"MG"</span>) ~ 5,<br>        str_detect(dev_stage, <span>"Br"</span>) ~ 6,<br>        str_detect(dev_stage, <span>"Pk"</span>) ~ 7,<br>        str_detect(dev_stage, <span>"LR"</span>) ~ 8,<br>        str_detect(dev_stage, <span>"RR"</span>) ~ 9<br>  )) %&gt;%  <br>  mutate(stage = case_when(<br>    str_detect(dev_stage, <span>"MG|Br|Pk"</span>) ~ str_sub(dev_stage, start = 1, end = 2),<br>    T ~ dev_stage<br>  )) %&gt;% <br>  mutate(stage = factor(stage, levels = c(<br>   <span>"5 DPA"</span>,<br>   <span>"10 DPA"</span>,<br>   <span>"20 DPA"</span>,<br>   <span>"30 DPA"</span>,<br>   <span>"MG"</span>,<br>   <span>"Br"</span>,<br>   <span>"Pk"</span>,<br>   <span>"LR"</span>,<br>   <span>"RR"</span><br>  ))) %&gt;% <br>  mutate(dev_stage = reorder(dev_stage, order_x)) <br>head(modules_mean_z)<br><br>module_peak_exp &lt;- modules_mean_z %&gt;% <br>  group_by(module) %&gt;% <br>  slice_max(order_by = mean.z, n = 1)<br>module_peak_exp<br><br>module_peak_exp &lt;- module_peak_exp %&gt;% <br>  mutate(order_y = case_when(<br>        str_detect(dev_stage, <span>"5"</span>) ~ 1,<br>        str_detect(dev_stage, <span>"10"</span>) ~ 2,<br>        str_detect(dev_stage, <span>"20"</span>) ~ 3,<br>        str_detect(dev_stage, <span>"30"</span>) ~ 4,<br>        str_detect(dev_stage, <span>"MG"</span>) ~ 5,<br>        str_detect(dev_stage, <span>"Br"</span>) ~ 6,<br>        str_detect(dev_stage, <span>"Pk"</span>) ~ 7,<br>        str_detect(dev_stage, <span>"LR"</span>) ~ 8,<br>        str_detect(dev_stage, <span>"RR"</span>) ~ 9<br>  )) %&gt;%  <br>  mutate(peak_exp = reorder(dev_stage, order_y)) <br><br>modules_mean_z_reorded &lt;- modules_mean_z %&gt;% <br>  full_join(module_peak_exp %&gt;% <br>              select(module, peak_exp, order_y), by = c(<span>"module"</span>)) %&gt;% <br>  mutate(module = reorder(module, -order_y))<br><br>head(modules_mean_z_reorded)<br><br>module_heatmap &lt;- modules_mean_z_reorded %&gt;% <br>  ggplot(aes(x = tissue, y = as.factor(module))) +<br>  facet_grid(.~ dev_stage, scales = <span>"free"</span>, space = <span>"free"</span>) +<br>  geom_tile(aes(fill = mean.z.clipped), color = <span>"grey80"</span>) +<br>  scale_fill_gradientn(colors = rev(brewer.pal(11, <span>"RdBu"</span>)), limits = c(-1.5, 1.5),<br>                       breaks = c(-1.5, 0, 1.5), labels = c(<span>"&lt; -1.5"</span>, <span>"0"</span>, <span>"&gt; 1.5"</span>)) +<br>  labs(x = NULL,<br>       y = <span>"Module"</span>,<br>       fill = <span>"z score"</span>) +<br>  theme_classic() +<br>  theme(<br>    text = element_text(size = 14),<br>    axis.text = element_text(color = <span>"black"</span>),<br>    axis.text.x = element_blank(),<br>    strip.text = element_blank(),<br>    legend.position = <span>"top"</span>,<br>    panel.spacing = unit(0.5, <span>"lines"</span>) <br>  )<br><br>heatmap_color_strip1 &lt;- expand.grid(<br>  tissue = unique(Metadata<span>$tissue</span>),<br>  dev_stage = unique(Metadata<span>$dev_stage</span>), <br>  stringsAsFactors = F<br>) %&gt;% <br>  filter(dev_stage != <span>"Anthesis"</span>) %&gt;% <br>  filter(str_detect(tissue, <span>"epider|chyma|Vasc"</span>) == F) %&gt;% <br>  filter((dev_stage == <span>"5 DPA"</span> &amp;<br>           str_detect(tissue, <span>"Locular tissue|Placenta|Seeds"</span>))==F) %&gt;% <br>  filter((str_detect(dev_stage, <span>"styla"</span>) &amp;<br>           str_detect(tissue, <span>"Colum"</span>))==F) %&gt;% <br>  mutate(order_x = case_when(<br>        str_detect(dev_stage, <span>"5"</span>) ~ 1,<br>        str_detect(dev_stage, <span>"10"</span>) ~ 2,<br>        str_detect(dev_stage, <span>"20"</span>) ~ 3,<br>        str_detect(dev_stage, <span>"30"</span>) ~ 4,<br>        str_detect(dev_stage, <span>"MG"</span>) ~ 5,<br>        str_detect(dev_stage, <span>"Br"</span>) ~ 6,<br>        str_detect(dev_stage, <span>"Pk"</span>) ~ 7,<br>        str_detect(dev_stage, <span>"LR"</span>) ~ 8,<br>        str_detect(dev_stage, <span>"RR"</span>) ~ 9<br>  )) %&gt;% <br>  mutate(stage = case_when(<br>    str_detect(dev_stage, <span>"MG|Br|Pk"</span>) ~ str_sub(dev_stage, start = 1, end = 2),<br>    T ~ dev_stage<br>  )) %&gt;% <br>  mutate(stage = factor(stage, levels = c(<br>   <span>"5 DPA"</span>,<br>   <span>"10 DPA"</span>,<br>   <span>"20 DPA"</span>,<br>   <span>"30 DPA"</span>,<br>   <span>"MG"</span>,<br>   <span>"Br"</span>,<br>   <span>"Pk"</span>,<br>   <span>"LR"</span>,<br>   <span>"RR"</span><br>  ))) %&gt;% <br>  mutate(dev_stage = reorder(dev_stage, order_x)) %&gt;% <br>  ggplot(aes(x = tissue, y = 1)) +<br>  facet_grid(.~ dev_stage, scales = <span>"free"</span>, space = <span>"free"</span>) +<br>  geom_tile(aes(fill = tissue)) +<br>  scale_fill_manual(values = brewer.pal(8, <span>"Set2"</span>)) +<br>  guides(fill = guide_legend(nrow = 1)) +<br>  theme_void() +<br>  theme(<br>    legend.position = <span>"bottom"</span>,<br>    strip.text = element_blank(),<br>    text = element_text(size = 14),<br>    panel.spacing = unit(0.5, <span>"lines"</span>),<br>    legend.key.height = unit(0.75, <span>"lines"</span>)<br>  )<br><br>heatmap_color_strip2 &lt;- expand.grid(<br>  tissue = unique(Metadata<span>$tissue</span>),<br>  dev_stage = unique(Metadata<span>$dev_stage</span>), <br>  stringsAsFactors = F<br>) %&gt;% <br>  filter(dev_stage != <span>"Anthesis"</span>) %&gt;% <br>  filter(str_detect(tissue, <span>"epider|chyma|Vasc"</span>) == F) %&gt;% <br>  filter((dev_stage == <span>"5 DPA"</span> &amp;<br>           str_detect(tissue, <span>"Locular tissue|Placenta|Seeds"</span>))==F) %&gt;% <br>  filter((str_detect(dev_stage, <span>"styla"</span>) &amp;<br>           str_detect(tissue, <span>"Colum"</span>))==F) %&gt;% <br>  mutate(order_x = case_when(<br>        str_detect(dev_stage, <span>"5"</span>) ~ 1,<br>        str_detect(dev_stage, <span>"10"</span>) ~ 2,<br>        str_detect(dev_stage, <span>"20"</span>) ~ 3,<br>        str_detect(dev_stage, <span>"30"</span>) ~ 4,<br>        str_detect(dev_stage, <span>"MG"</span>) ~ 5,<br>        str_detect(dev_stage, <span>"Br"</span>) ~ 6,<br>        str_detect(dev_stage, <span>"Pk"</span>) ~ 7,<br>        str_detect(dev_stage, <span>"LR"</span>) ~ 8,<br>        str_detect(dev_stage, <span>"RR"</span>) ~ 9<br>  )) %&gt;% <br>  mutate(stage = case_when(<br>    str_detect(dev_stage, <span>"MG|Br|Pk"</span>) ~ str_sub(dev_stage, start = 1, end = 2),<br>    T ~ dev_stage<br>  )) %&gt;% <br>  mutate(stage = factor(stage, levels = c(<br>   <span>"5 DPA"</span>,<br>   <span>"10 DPA"</span>,<br>   <span>"20 DPA"</span>,<br>   <span>"30 DPA"</span>,<br>   <span>"MG"</span>,<br>   <span>"Br"</span>,<br>   <span>"Pk"</span>,<br>   <span>"LR"</span>,<br>   <span>"RR"</span><br>  ))) %&gt;% <br>  mutate(dev_stage = reorder(dev_stage, order_x)) %&gt;% <br>  ggplot(aes(x = tissue, y = 1)) +<br>  facet_grid(.~ dev_stage, scales = <span>"free"</span>, space = <span>"free"</span>) +<br>  geom_tile(aes(fill = stage)) +<br>  scale_fill_manual(values = viridis(9, option = <span>"D"</span>)) +<br>  labs(fill = <span>"stage"</span>) +<br>  guides(fill = guide_legend(nrow = 1)) +<br>  theme_void() +<br>  theme(<br>    legend.position = <span>"bottom"</span>,<br>    strip.text = element_blank(),<br>    text = element_text(size = 14),<br>    panel.spacing = unit(0.5, <span>"lines"</span>),<br>    legend.key.height = unit(0.75, <span>"lines"</span>)<br>  )<br><br><br>wrap_plots(module_heatmap, heatmap_color_strip1, heatmap_color_strip2, <br>           nrow = 3, heights = c(1, 0.08, 0.08), guides = <span>"collect"</span>) &amp;<br>  theme(<br>    legend.position = <span>"bottom"</span>,<br>    legend.box = <span>"vertical"</span><br>  )<br>ggsave(<span>"module_heatmap.png"</span>, height = 4.8, width = 10, <span>bg</span> = <span>"white"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下：被模块9捕获的水果成熟基因，实际上直到Br阶段或之后才开始发挥作用</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052067" data-ratio="0.47962962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffEnvevnic24YxHJk54Ovj4gSFJwMiceUzZE3bRQq9xXxU46rjoRp1gDpA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffEnvevnic24YxHJk54Ovj4gSFJwMiceUzZE3bRQq9xXxU46rjoRp1gDpA/640?wx_fmt=png&amp;from=appmsg"><figcaption>module_heatmap</figcaption></figure><h4 data-tool="mdnice编辑器">8.Gene co-expression graphs</h4><p data-tool="mdnice编辑器">使用igraph对共表达网络进行可视化：</p><pre data-tool="mdnice编辑器"><code><span># 使用部分数据</span><br>neighbors_of_bait &lt;- c(<br>  neighbors(my_network, v = <span>"Solly.M82.10G020850.1"</span>), <span># PG</span><br>  neighbors(my_network, v = <span>"Solly.M82.03G005440.5"</span>), <span># PSY1 </span><br>  neighbors(my_network, v = <span>"Solly.M82.01G041430.1"</span>), <span>#  early fruit - SAUR</span><br>  neighbors(my_network, v = <span>"Solly.M82.03G024180.1"</span>) <span># seed specific - "oleosin"</span><br>) %&gt;% <br>  unique()  <br><br><span># make a sub-network object.</span><br>subnetwork_edges &lt;- edge_table_select %&gt;% <br>  filter(from %<span>in</span>% names(neighbors_of_bait) &amp;<br>           to %<span>in</span>% names(neighbors_of_bait)) %&gt;% <br>  group_by(from) %&gt;% <br>  slice_max(order_by = r, n = 5) %&gt;% <br>  ungroup() %&gt;% <br>  group_by(to) %&gt;% <br>  slice_max(order_by = r, n = 5) %&gt;% <br>  ungroup()<br><br>subnetwork_genes &lt;- c(subnetwork_edges<span>$from</span>, subnetwork_edges<span>$to</span>) %&gt;% unique()<br>length(subnetwork_genes)<br>dim(subnetwork_edges)<br><br><span># subset nodes in the network</span><br>subnetwork_nodes &lt;- node_table %&gt;% <br>  filter(gene_ID %<span>in</span>% subnetwork_genes) %&gt;% <br>  left_join(my_network_modules, by = <span>"gene_ID"</span>) %&gt;% <br>  left_join(module_peak_exp, by = <span>"module"</span>) %&gt;% <br>  mutate(module_annotation = case_when(<br>    str_detect(module, <span>"114|37|1|14|3|67|19|56"</span>) ~ <span>"early fruit"</span>,<br>    module == <span>"9"</span> ~ <span>"seed"</span>,<br>    module == <span>"5"</span> ~ <span>"ripening"</span>,<br>    T ~ <span>"other"</span><br>  ))<br><br>dim(subnetwork_nodes)<br><br><span># make sub-network object from subsetted edges and nodes.</span><br>my_subnetwork &lt;- graph_from_data_frame(subnetwork_edges,<br>                                     vertices = subnetwork_nodes,<br>                                     directed = F)<br>                                     <br><span># Use graph_from_data_frame() from igraph to build the sub-networ</span><br> my_subnetwork %&gt;% <br>  ggraph(layout = <span>"kk"</span>, circular = F) +<br>  geom_edge_diagonal(color = <span>"grey70"</span>, width = 0.5, alpha = 0.5) +<br>  geom_node_point(alpha = 0.8, color = <span>"white"</span>, shape = 21, size = 2,<br>                  aes(fill = module_annotation)) + <br>  scale_fill_manual(values = c(brewer.pal(8, <span>"Accent"</span>)[c(1,3,6)], <span>"grey30"</span>),<br>                    limits = c(<span>"early fruit"</span>, <span>"seed"</span>, <span>"ripening"</span>, <span>"other"</span>)) +<br>  labs(fill = <span>"Modules"</span>) +<br>  guides(size = <span>"none"</span>,<br>         fill = guide_legend(override.aes = list(size = 4), <br>                             title.position = <span>"top"</span>, nrow = 2)) +<br>  theme_void()+<br>  theme(<br>    text = element_text(size = 14), <br>    legend.position = <span>"bottom"</span>,<br>    legend.justification = 1,<br>    title = element_text(size = 12)<br>  )<br>ggsave(<span>"subnetwork_graph.png"</span>, height = 5, width = 4, <span>bg</span> = <span>"white"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052070" data-ratio="1.25" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffmvucCxjTVwSb6Rvib80hF7RCBo5FFbIg2NSQPTgsGh6SlHcNBcWKsdg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="808" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffmvucCxjTVwSb6Rvib80hF7RCBo5FFbIg2NSQPTgsGh6SlHcNBcWKsdg/640?wx_fmt=png&amp;from=appmsg"><figcaption>subnetwork_graph</figcaption></figure><h4 data-tool="mdnice编辑器">9.平均分离图：候选基因</h4><pre data-tool="mdnice编辑器"><code><span># Pull out direct neighbors</span><br>neighbors_of_PG_PSY1 &lt;- c(<br>  neighbors(my_network, v = <span>"Solly.M82.10G020850.1"</span>), <span># PG</span><br>  neighbors(my_network, v = <span>"Solly.M82.03G005440.5"</span>) <span># PSY1 </span><br>) %&gt;% <br>  unique()  <br><br>length(neighbors_of_PG_PSY1)<br><br><span>#  bHLH and GRAS type TFs</span><br>my_TFs &lt;- my_network_modules %&gt;% <br>  filter(gene_ID %<span>in</span>% names(neighbors_of_PG_PSY1)) %&gt;% <br>  filter(str_detect(functional_annotation, <span>"GRAS|bHLH"</span>))<br>  <br>TF_TPM &lt;- Exp_table_long %&gt;% <br>  filter(gene_ID %<span>in</span>% my_TFs<span>$gene_ID</span>) %&gt;% <br>  inner_join(PCA_coord, by = c(<span>"library"</span>=<span>"Run"</span>)) %&gt;% <br>  filter(dissection_method == <span>"Hand"</span>) %&gt;% <br>  mutate(order_x = case_when(<br>    str_detect(dev_stage, <span>"5"</span>) ~ 1,<br>    str_detect(dev_stage, <span>"10"</span>) ~ 2,<br>    str_detect(dev_stage, <span>"20"</span>) ~ 3,<br>    str_detect(dev_stage, <span>"30"</span>) ~ 4,<br>    str_detect(dev_stage, <span>"MG"</span>) ~ 5,<br>    str_detect(dev_stage, <span>"Br"</span>) ~ 6,<br>    str_detect(dev_stage, <span>"Pk"</span>) ~ 7,<br>    str_detect(dev_stage, <span>"LR"</span>) ~ 8,<br>    str_detect(dev_stage, <span>"RR"</span>) ~ 9<br>  )) %&gt;% <br>  mutate(dev_stage = reorder(dev_stage, order_x)) %&gt;% <br>  mutate(tag = str_remove(gene_ID, <span>"Solly.M82."</span>)) %&gt;% <br>  ggplot(aes(x = dev_stage, y = logTPM)) +<br>  facet_grid(tag ~ tissue, scales = <span>"free_y"</span>) +<br>  geom_point(aes(fill = tissue), color = <span>"white"</span>, size = 2, <br>             alpha = 0.8, shape = 21, position = position_jitter(0.1, seed = 666)) +<br>  stat_summary(geom = <span>"line"</span>, aes(group = gene_ID), <br>               fun = mean, alpha = 0.8, size = 1.1, color = <span>"grey20"</span>) +<br>  scale_fill_manual(values = brewer.pal(8, <span>"Set2"</span>)) +<br>  labs(x = NULL,<br>       y = <span>"log10(TPM)"</span>) +<br>  theme_bw() +<br>  theme(<br>    legend.position = <span>"none"</span>,<br>    panel.spacing = unit(1, <span>"lines"</span>),<br>    text = element_text(size = 14),<br>    axis.text = element_text(color = <span>"black"</span>),<br>    axis.text.x = element_blank(),<br>    strip.background = element_blank()<br>  )<br>  <br>wrap_plots(TF_TPM, module_lines_color_strip, nrow = 2, heights = c(1, 0.05))<br>ggsave(<span>"Candidate_genes_TPM.png"</span>, height = 4.8, width = 8, <span>bg</span> = <span>"white"</span>)<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052069" data-ratio="0.5888888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffBlKibdKQDEbOrqjjLSwibyv6MelEjEUxx80VnAUumSGxPJq9hQgsOECA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxZib2zicnz1UWpuVHr0jZUffBlKibdKQDEbOrqjjLSwibyv6MelEjEUxx80VnAUumSGxPJq9hQgsOECA/640?wx_fmt=png&amp;from=appmsg"><figcaption> </figcaption></figure><h4 data-tool="mdnice编辑器">10.输出结果</h4><pre data-tool="mdnice编辑器"><code>Bait_neighors &lt;- M82_funct_anno %&gt;% <br>  filter(X1 %<span>in</span>% names(neighbors_of_PG_PSY1)) %&gt;% <br>  rename(Gene_ID = X1,<br>         annotation = X2)<br><br>head(Bait_neighors)<br>write_excel_csv(Bait_neighors, <span>"PG_PSY1_neighbors.csv"</span>, col_names = T)<br></code></pre><p data-tool="mdnice编辑器">怎么说呢，感觉我个人不是很喜欢大篇幅使用tidyverse的代码，如果可以，我还是想用WGCNA吧！哈哈哈哈哈哈或。</p><p data-tool="mdnice编辑器"><span>去试试看，说不定是你的菜！</span></p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span>学徒作业</span><span></span></h3><p data-tool="mdnice编辑器">针对 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247492542&amp;idx=1&amp;sn=8133ffb764318b53322a928d4aa2e925&amp;scene=21#wechat_redirect" data-linktype="2">手把手10分文章WGCNA复现：小胶质细胞亚群在脑发育时髓鞘形成的作用</a> ，里面的数据集进行wgcna以及我们的提到的<span>Simple Tidy GeneCoEx</span><span>分析，然后对比这两个模块算法的结果的一致性。<span>这些</span><span>样本进行了RNASeq测序，数据在GEO可供下载：</span><span>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE78809</span><span>。当然我偷了个懒，</span><strong>该文章Supplemental material提供了整理之后的csv矩阵，大概1万3千个基因。</strong></span></p><p>该文章对五个处理组，共17个老鼠：<br></p><p><br></p><section data-tools="135编辑器" data-id="92737"><section data-width="100%"><section data-width="100%"><section data-role="list"><ul><li><p><span>orange represents neonatal CD11c+ microglia (n = 4),</span></p></li><li><p><span>green neonatal CD11c microglia (n = 4),</span></p></li><li><p><span>blue EAE CD11c+ microglia (n = 3),</span></p></li><li><p><span>purple EAE CD11c microglia (n = 3),</span></p></li><li><p>black adult microglia (n = 3).</p></li></ul></section></section></section></section></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/rqXaQ9a9iIZA0FrTEZWyDA",target="_blank" rel="noopener noreferrer">原文链接</a>
