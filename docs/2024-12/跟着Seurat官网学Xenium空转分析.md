---
title: "跟着Seurat官网学Xenium空转分析"
date: 2024-12-14T01:31:33Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
跟着Seurat官网学Xenium空转分析 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">Xenium是由 10x Genomics 推出的一种先进的空间转录组学技术，能够在单细胞分辨率的基础上，精确地检测和定位组织切片中的基因表达情况。这项技术结合了分子检测与空间定位的优势，为研究细胞在组织中的位置及其功能关系提供了重要工具。这里看一下AI对Xenium的理解，描述的非常详细：</p><ul data-tool="mdnice编辑器"><li><section><p><strong>Xenium 的核心原理：</strong>Xenium 的核心是基于高通量的原位杂交 (In Situ Hybridization, ISH) 技术。通过使用特异性探针捕获 RNA 分子，并在组织切片上直接检测信号，Xenium 能够实现以下目标：</p></section></li><ul><li><section><p><strong>单细胞分辨率</strong>：识别每个细胞的基因表达模式。</p></section></li><li><section><p><strong>空间信息整合</strong>：保留组织切片中细胞的物理位置，揭示细胞间的空间关系。</p></section></li><li><section><p><strong>高通量检测</strong>：同时检测数千个目标基因，满足复杂样本的多维度分析需求。</p></section></li></ul><li><section><p><strong>Xenium 的技术优势：</strong></p></section></li><ul><li><section><p><strong>空间与分子信息结合</strong>：能够同时获得基因表达的数量和细胞所在的组织位置。</p></section></li><li><section><p><strong>无需解离组织</strong>：保留了细胞与组织环境的原始结构关系，避免传统单细胞 RNA 测序中组织解离造成的信息丢失。</p></section></li><li><section><p><strong>高通量</strong>：相比于传统的空间转录组学方法，Xenium 提供了更高的基因检测通量和精度。</p></section></li></ul><li><section><p><strong>Xenium 的应用场景：</strong>Xenium 技术在许多生物医学研究领域具有广泛应用，包括但不限于：</p></section></li><ul><li><section><p><strong>肿瘤微环境研究</strong>：研究肿瘤细胞与免疫细胞之间的空间关系，揭示潜在的调控机制。</p></section></li><li><section><p><strong>神经科学</strong>：解析大脑组织中不同神经元的空间分布及基因表达特性。</p></section></li><li><section><p><strong>发育生物学</strong>：监测胚胎发育过程中细胞分化与空间分布的动态变化。</p></section></li><li><section><p><strong>免疫研究</strong>：探索免疫细胞在组织中的分布及其与病原体或其他细胞的交互。</p></section></li></ul></ul><p data-tool="mdnice编辑器">下面跟着Seurat学习Xenium的分析流程。Seurat官方教程在https://satijalab.org/seurat/articles/seurat5_spatial_vignette_2</p><p data-tool="mdnice编辑器">首先下载示例数据：</p><pre data-tool="mdnice编辑器"><span></span><code><span>## Mouse_Brain</span><br>wget https://cf.10xgenomics.com/samples/xenium/1.0.2/Xenium_V1_FF_Mouse_Brain_Coronal_Subset_CTX_HP/Xenium_V1_FF_Mouse_Brain_Coronal_Subset_CTX_HP_outs.zip<br><br>unzip Xenium_V1_FF_Mouse_Brain_Coronal_Subset_CTX_HP_outs.zip<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>一. 读入数据</span><span></span></h3><p data-tool="mdnice编辑器">首先，我们读取数据集并创建一个Seurat对象。提供Xenium运行的数据文件夹的路径作为输入路径。RNA数据存储在Seurat对象的Xenium分析中。这一步大概需要一分钟。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br><span>library</span>(qs)<br><span>library</span>(ggplot2)<br><span>library</span>(dplyr)<br><br>path &lt;- <span>"./Rawdata"</span><br><span># Load the Xenium data</span><br>xenium.obj &lt;- LoadXenium(path, fov = <span>"fov"</span>)<br><span># remove cells with 0 counts</span><br>xenium.obj &lt;- subset(xenium.obj, subset = nCount_Xenium &gt; <span>0</span>)<br></code></pre><p data-tool="mdnice编辑器">空间信息被加载到Seurat对象的插槽中。</p><p data-tool="mdnice编辑器">可视化每个细胞基因数量（nFeature_Xenium）和每个细胞的转录本计数情况（nCount_Xenium）：</p><pre data-tool="mdnice编辑器"><span></span><code>VlnPlot(xenium.obj, features = c(<span>"nFeature_Xenium"</span>, <span>"nCount_Xenium"</span>), ncol = <span>2</span>, pt.size = <span>0</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100046491" data-ratio="0.6694444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFGInA4spDydXULUrZribvGklKIIPm5wtOMUNChV7cuo6trqZuuokXibHg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFGInA4spDydXULUrZribvGklKIIPm5wtOMUNChV7cuo6trqZuuokXibHg/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20241212233704589</figcaption></figure><p data-tool="mdnice编辑器">Xenium数据使用<code>ImageDimPlot</code>进行spatial的可视化，这里可以使用这个函数展示一些感兴趣的marker基因：</p><pre data-tool="mdnice编辑器"><span></span><code>ImageDimPlot(xenium.obj, fov = <span>"fov"</span>, molecules = c(<span>"Gad1"</span>, <span>"Sst"</span>, <span>"Pvalb"</span>, <span>"Gfap"</span>), nmols = <span>20000</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100046492" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFT83jWfOP69P9NicOUAbh2h7nAjmCMAYoNfLoJBiaMaeCDcMia3tRia870w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="826" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFT83jWfOP69P9NicOUAbh2h7nAjmCMAYoNfLoJBiaMaeCDcMia3tRia870w/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20241212233806255</figcaption></figure><p data-tool="mdnice编辑器">我们还可以使用<code>ImageFeaturePlot（）</code>在单细胞水平上可视化关键基因的表达水平。基于这个函数，我们可以设置一个参数调整基因表达的最大值以提高可视化的对比度，例如每个基因的截止值大约为其计数分布的第90个百分位数（可以用max.cutoff='q90'指定）。</p><pre data-tool="mdnice编辑器"><span></span><code>ImageFeaturePlot(xenium.obj, features = c(<span>"Cux2"</span>, <span>"Rorb"</span>, <span>"Bcl11b"</span>, <span>"Foxp2"</span>), max.cutoff = c(<span>25</span>,<br>    <span>35</span>, <span>12</span>, <span>10</span>), size = <span>0.75</span>, cols = c(<span>"white"</span>, <span>"red"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100046494" data-ratio="0.9101851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFxt22SU2Ee43ibR88BfOnwQvLH9b2WDPM1X15AGxw0s0ADFfoiaPnicqVA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFxt22SU2Ee43ibR88BfOnwQvLH9b2WDPM1X15AGxw0s0ADFfoiaPnicqVA/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20241212233835957</figcaption></figure><p data-tool="mdnice编辑器">我们可以使用<code>Crop</code>函数放大选定区域。一旦放大，我们可以看到细胞分割边界以及单个分子。</p><pre data-tool="mdnice编辑器"><span></span><code>cropped.coords &lt;- Crop(xenium.obj[[<span>"fov"</span>]], x = c(<span>1200</span>, <span>2900</span>), y = c(<span>3750</span>, <span>4550</span>), coords = <span>"plot"</span>)<br>xenium.obj[[<span>"zoom"</span>]] &lt;- cropped.coords<br><span># visualize cropped area with cell segmentations &amp; selected molecules</span><br>DefaultBoundary(xenium.obj[[<span>"zoom"</span>]]) &lt;- <span>"segmentation"</span><br>ImageDimPlot(xenium.obj, fov = <span>"zoom"</span>, axes = <span>TRUE</span>, border.color = <span>"white"</span>, border.size = <span>0.1</span>, cols = <span>"polychrome"</span>,<br>    coord.fixed = <span>FALSE</span>, molecules = c(<span>"Gad1"</span>, <span>"Sst"</span>, <span>"Npy2r"</span>, <span>"Pvalb"</span>, <span>"Nrn1"</span>), nmols = <span>10000</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100046495" data-ratio="0.7287037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFWotriaIs0ia3EsSIJ3wazMVovHn9PJnPqUibQBYJUoyNedjxPueStFXfg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFWotriaIs0ia3EsSIJ3wazMVovHn9PJnPqUibQBYJUoyNedjxPueStFXfg/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20241212233955799</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>二. 标准化分析流程</span><span></span></h3><p data-tool="mdnice编辑器">接下来，我们使用<code>SCTransform</code>进行标准化，然后是降维和聚类分析：</p><pre data-tool="mdnice编辑器"><span></span><code>xenium.obj &lt;- SCTransform(xenium.obj, assay = <span>"Xenium"</span>) %&gt;% <br>  RunPCA(npcs = <span>30</span>, features = rownames(xenium.obj)) %&gt;% <br>  RunUMAP(dims = <span>1</span>:<span>30</span>) %&gt;% <br>  FindNeighbors(reduction = <span>"pca"</span>, dims = <span>1</span>:<span>30</span>) %&gt;% <br>  FindClusters(resolution = <span>0.3</span>)<br></code></pre><p data-tool="mdnice编辑器">然后，我们可以通过在UMAP空间中使用<code>DimPlot</code>或在图像上使用<code>ImageDimPlot</code>可视化聚类结果：</p><pre data-tool="mdnice编辑器"><span></span><code>DimPlot(xenium.obj)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100046493" data-ratio="0.6907407407407408" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFcFXsYRIPAxnVh3Trc9Fia64C9QXAjhCd3koEuAuqdwRfwXv3vP9ZziaQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFcFXsYRIPAxnVh3Trc9Fia64C9QXAjhCd3koEuAuqdwRfwXv3vP9ZziaQ/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20241212234157999</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#FeaturePlot检查marker在umap上的分布情况</span><br><span>#FeaturePlot(xenium.obj, features = c("Cux2", "Bcl11b", "Foxp2", "Gad1", "Sst", "Gfap"))</span><br>ImageDimPlot(xenium.obj, cols = <span>"polychrome"</span>, size = <span>0.75</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100046500" data-ratio="1.149312377210216" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFTbmjZ9YS9jPZKhOnHhy7vmhaQIeZbtBwNCNa0ewibE8qmlibZDia1Remw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1018" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFTbmjZ9YS9jPZKhOnHhy7vmhaQIeZbtBwNCNa0ewibE8qmlibZDia1Remw/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20241212234301617</figcaption></figure><p data-tool="mdnice编辑器">利用每个细胞的位置信息，计算空间生态位。我们使用来自艾伦大脑研究所的<strong>皮质</strong>参考来注释细胞，所以我们首先从Xenium数据中取子集，得到皮质细胞。Allen Brain参考可以安装在这里（https://www.dropbox.com/s/cuowvm4vrf65pvq/allen_cortex.rds?dl=1）。</p><p data-tool="mdnice编辑器">我们使用Slc17a7表达来帮助确定皮质区域。</p><pre data-tool="mdnice编辑器"><span></span><code>p1 &lt;- ImageFeaturePlot(xenium.obj, features = <span>"Slc17a7"</span>, axes = <span>TRUE</span>, max.cutoff = <span>"q90"</span>)<br>p1<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100046498" data-ratio="1.200845665961945" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFyV1up1XFmRUIsEBrNqacWUDqgxJ4KIC9V0WySm0gZkmeRS7Jrib39Kw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="946" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFyV1up1XFmRUIsEBrNqacWUDqgxJ4KIC9V0WySm0gZkmeRS7Jrib39Kw/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20241212235840963</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>crop &lt;- Crop(xenium.obj[[<span>"fov"</span>]], x = c(<span>600</span>, <span>2100</span>), y = c(<span>900</span>, <span>4700</span>))<br>xenium.obj[[<span>"crop"</span>]] &lt;- crop<br>p2 &lt;- ImageFeaturePlot(xenium.obj, fov = <span>"crop"</span>, features = <span>"Slc17a7"</span>, size = <span>1</span>, axes = <span>TRUE</span>, max.cutoff = <span>"q90"</span>)<br>p2<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100046499" data-ratio="1.6725663716814159" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFdO3Wf813c3Vq3W1gYP4JVmAS0hBxZTBVLElLmibs30JRuAKL0MHPjIw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="678" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib4SCxQjtQyvk0hMibhicespFdO3Wf813c3Vq3W1gYP4JVmAS0hBxZTBVLElLmibs30JRuAKL0MHPjIw/640?wx_fmt=png&amp;from=appmsg"><figcaption>image-20241212234607132</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>三. RCTD解卷积</span><span></span></h3><p data-tool="mdnice编辑器">Seurat v5现已纳入RCTD算法分析流程（Robust Cell Type Decomposition），用户可以使用scRNA-seq参考数据集，对空间数据集的spot或者单个细胞进行反卷积分析。</p><p data-tool="mdnice编辑器">RCTD安装：</p><pre data-tool="mdnice编辑器"><span></span><code>devtools::install_github(<span>"dmcable/spacexr"</span>, build_vignettes = <span>FALSE</span>)<br></code></pre><p data-tool="mdnice编辑器">基于Xenium数据，构建RCTD的query数据：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(spacexr)<br><br>query.counts &lt;- GetAssayData(xenium.obj, assay = <span>"Xenium"</span>, slot = <span>"counts"</span>)[, Cells(xenium.obj[[<span>"crop"</span>]])]<br>coords &lt;- GetTissueCoordinates(xenium.obj[[<span>"crop"</span>]], which = <span>"centroids"</span>)<br>rownames(coords) &lt;- coords$cell<br>coords$cell &lt;- <span>NULL</span><br>query &lt;- SpatialRNA(coords, query.counts, colSums(query.counts))<br></code></pre><p data-tool="mdnice编辑器">然后是单细胞参考数据集的处理，构建RCTD的Reference数据：</p><pre data-tool="mdnice编辑器"><span></span><code><span># allen.corted.ref can be downloaded here:</span><br><span># https://www.dropbox.com/s/cuowvm4vrf65pvq/allen_cortex.rds?dl=1</span><br>allen.cortex.ref &lt;- readRDS(<span>"/brahms/shared/vignette-data/allen_cortex.rds"</span>)<br>allen.cortex.ref &lt;- UpdateSeuratObject(allen.cortex.ref)<br><br>Idents(allen.cortex.ref) &lt;- <span>"subclass"</span><br><span># remove CR cells because there aren't enough of them for annotation</span><br>allen.cortex.ref &lt;- subset(allen.cortex.ref, subset = subclass != <span>"CR"</span>)<br>counts &lt;- GetAssayData(allen.cortex.ref, assay = <span>"RNA"</span>, slot = <span>"counts"</span>)<br>cluster &lt;- as.factor(allen.cortex.ref$subclass)<br>names(cluster) &lt;- colnames(allen.cortex.ref)<br>nUMI &lt;- allen.cortex.ref$nCount_RNA<br>names(nUMI) &lt;- colnames(allen.cortex.ref)<br>nUMI &lt;- colSums(counts)<br>levels(cluster) &lt;- gsub(<span>"/"</span>, <span>"-"</span>, levels(cluster))<br>reference &lt;- Reference(counts, cluster, nUMI)<br></code></pre><p data-tool="mdnice编辑器">运行RCTD：</p><pre data-tool="mdnice编辑器"><span></span><code><span># run RCTD with many cores</span><br>RCTD &lt;- create.RCTD(query, reference, max_cores = <span>8</span>)<br>RCTD &lt;- run.RCTD(RCTD, doublet_mode = <span>"doublet"</span>)<br></code></pre><p data-tool="mdnice编辑器">处理RCTD的结果：</p><pre data-tool="mdnice编辑器"><span></span><code>annotations.df &lt;- RCTD@results$results_df<br>annotations &lt;- annotations.df$first_type<br>names(annotations) &lt;- rownames(annotations.df)<br>xenium.obj$predicted.celltype &lt;- annotations<br>keep.cells &lt;- Cells(xenium.obj)[!is.na(xenium.obj$predicted.celltype)]<br>xenium.obj &lt;- subset(xenium.obj, cells = keep.cells)<br></code></pre><p data-tool="mdnice编辑器">关于RCTD我已介绍多次了，HD空转分析也是采用了RCTD流程。详见：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247519938&amp;idx=1&amp;sn=d1814cc9fbcec0121242627bff3d59bf&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞和空转数据多种方法之RCTD</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247488514&amp;idx=1&amp;sn=66ea88094d10475bf6895f6057d63d3a&amp;scene=21#wechat_redirect" data-linktype="2">跟着Seurat官网学Visium HD空转分析（二）空间组织域识别和反卷积</a></section></li></ul><p data-tool="mdnice编辑器">本质上就是使用单细胞数据以及单细胞注释好的标签来注释空转数据。</p><p data-tool="mdnice编辑器">更多内容详见官方教程：https://satijalab.org/seurat/articles/seurat5_spatial_vignette_2</p></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/JVZbsrtF-kF5Jz8Zw7dstA",target="_blank" rel="noopener noreferrer">原文链接</a>
