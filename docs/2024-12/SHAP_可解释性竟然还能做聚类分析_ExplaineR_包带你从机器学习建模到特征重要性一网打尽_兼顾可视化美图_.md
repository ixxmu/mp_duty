---
title: "SHAP 可解释性竟然还能做聚类分析？ExplaineR 包带你从机器学习建模到特征重要性一网打尽，兼顾可视化美图！"
date: 2024-12-12T23:26:40Z
draft: ["false"]
tags: [
  "fetched",
  "生信碱移"
]
categories: ["Acdemic"]
---
SHAP 可解释性竟然还能做聚类分析？ExplaineR 包带你从机器学习建模到特征重要性一网打尽，兼顾可视化美图！ by 生信碱移
------
<div><section data-tool="markdown编辑器" data-website="https://markdown.com.cn/editor"><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><img data-ratio="1.0324675324675325" data-type="gif" data-w="154" data-imgfileid="100011370" data-src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section></section></section></section></section><section><section powered-by="xiumi.us"><section><p>老铁快点击蓝字 <strong>关注俺</strong></p></section></section></section><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><img data-ratio="1.0324675324675325" data-type="gif" data-w="154" data-imgfileid="100011369" data-src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" src="https://mmbiz.qpic.cn/mmbiz_gif/lN9Tp5oiaqHFn9Rg6MwMU3ukMR9ROPh7bf7QWHEMwhUBUwSUKFsV8oK9noHic3jLaeJVQewHJcLq1cTXVAat35Tw/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"></section></section></section></section></section></section></section></section></section><section data-mpa-powered-by="yiban.io" data-style='white-space: normal; max-width: 100%; letter-spacing: 0.544px; text-size-adjust: auto; background-color: rgb(255, 255, 255); font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif; box-sizing: border-box !important; overflow-wrap: break-word !important;'><section><section><section><section data-id="85660" data-custom="rgb(117, 117, 118)" data-color="rgb(117, 117, 118)"><section data-style="margin-top: 2em; padding-top: 0.5em; padding-bottom: 0.5em; max-width: 100%; border-style: solid none; text-decoration: inherit; border-top-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-top-width: 1px; border-bottom-width: 1px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p><span>生信碱移</span></p><section><strong>ExplaineR包</strong></section></section></section></section></section></section></section><blockquote data-type="2" data-url="" data-author-name="" data-content-utf8-length="68" data-source-title="" data-style='color: rgba(0, 0, 0, 0.498); white-space: normal; max-width: 100%; letter-spacing: 0.544px; font-family: -apple-system-font, system-ui, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", Arial, sans-serif; background-color: rgb(255, 255, 255); box-sizing: border-box !important; overflow-wrap: break-word !important;'><section><span>模型构建到解释的方方面面，你甚至可以用SHAP做聚类（患者亚型分析）。</span></section></blockquote><p data-tool="markdown.com.cn编辑器">近年来，机器学习在处理临床数据集中的应用变得越来越流行。<strong>然而，随着新复杂算法的引入，理解这些算法如何产生输出成为了一个挑战。</strong>例如，基于树的集成模型（如随机森林）和梯度提升机具有强大的预测能力，但可解释性有限。</p><section><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzkyNTIzMzYyMA==&amp;mid=2247490912&amp;idx=2&amp;sn=597ca82896279ec0b5cf69adfc8bf0c2&amp;scene=21#wechat_redirect" textvalue="你已选中了添加链接的内容" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="1"><span><img data-galleryid="" data-imgfileid="100011372" data-ratio="0.6074074074074074" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaZXPEoeibYhjTX1jCd3iciaVwW5MjhLVACp3yibl3p0W7pY43MQYIQ0TNSg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaZXPEoeibYhjTX1jCd3iciaVwW5MjhLVACp3yibl3p0W7pY43MQYIQ0TNSg/640?wx_fmt=png&amp;from=appmsg"></span></a></section><p data-class="mbImgTitle">▲ 随机森林的示意图，本质上是集成和自助，多个随机变量的决策树给出最后综合的预测结果。随机森林通过Gini重要性来衡量一个特征在决策树中有多频繁地被用于分裂数据，越频繁的特征则是越重要的。<strong>关于决策树与随机森林的原理及代码讲解可以点击上方图片跳转。</strong></p><p data-tool="markdown.com.cn编辑器"><strong>现有的方法在从这些模型中提取特征重要性时存在局限性，导致特征重要性评估的不一致性。</strong>例如，Gini重要性度量（通过特征分割数据的频率来确定特征的重要性）倾向于高估连续变量或高基数类别变量的重要性，而低估相关特征的重要性。<strong>S</strong><strong>HAP可解释性分析基于合作博弈论，已成为提高模型可解释性的一个重要工具。它量化了每个特征对模型预测的贡献，有助于解释复杂模型的决策。</strong></p><section><img data-galleryid="" data-imgfileid="100011375" data-ratio="0.6351851851851852" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iacrN2OEPlSqpTfmxMsXVuWgRGevmbicDFkOkGvTX8LnIianaVxgqlOm5A/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iacrN2OEPlSqpTfmxMsXVuWgRGevmbicDFkOkGvTX8LnIianaVxgqlOm5A/640?wx_fmt=png&amp;from=appmsg"></section><section>▲ Matthews相关系数（Matthews correlation coefficient, MCC） 是一种<strong>用于二元分类问题的性能度量</strong>，尤其在类别不平衡的情况下非常有效。它结合了四个主要的分类结果：真正例（True Positives, TP）、假正例（False Positives, FP）、真负例（True Negatives, TN）和假负例（False Negatives, FN）。</section><p data-tool="markdown.com.cn编辑器"><strong>在可视化层面</strong>，尽管模型性能度量（如二元分类中的Matthews相关系数）对评估模型至关重要，但这些度量通常在SHAP总结图中被忽视。此外，像决策曲线分析这样的可视化工具也对理解模型性能至关重要，但有时会被忽略。为了应对这些挑战，来自哥本哈根医学院的研究者引入了<span><strong>ExplaineR</strong></span>包，<strong>旨在提供一个全面的框架来解释机器学习模型，特别是针对二元分类和回归模型。</strong><strong>该包旨在标准化模型性能和解释报告，便于在医学和临床科学等领域的广泛应用。</strong></p><p><img data-backh="328" data-backw="392" data-imgfileid="100011390" data-ratio="0.837037037037037" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iawB58ibwmJhsBnFZEsNZKKIaZsdhCBWnQDZjxtIA88cJvs5iaiaciaUwMww/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iawB58ibwmJhsBnFZEsNZKKIaZsdhCBWnQDZjxtIA88cJvs5iaiaciaUwMww/640?wx_fmt=png&amp;from=appmsg"></p><section>▲ ExplaineR工作流程。作者展示了使用ExplaineR包进行机器学习分析的工作流程，基于威斯康星乳腺癌数据集进行的随机森林（Random Forest）二元分类模型分析。左侧面板展示了训练集和测试集的混淆矩阵，以及模型净收益与替代方案的比较图。右侧面板则展示了通过SHAP聚类得到的三个样本群体的SHAP总结图及其对应的混淆矩阵。</section><p data-tool="markdown.com.cn编辑器"><strong>本文简要介绍ExplaineR的使用</strong>，从二分类建模、评估、SHAP可解释性甚至到<strong>可解释性聚类</strong>，可以说这个R包能做的东西还是非常全面的。感兴趣多分类或者回归的老铁，可以参考下方链接：</p><ul data-tool="markdown.com.cn编辑器"><li><section>https://persimune.github.io/explainer/index.html</section></li><li><section>https://github.com/PERSIMUNE/explainer/</section></li></ul><h3 data-tool="markdown.com.cn编辑器"><span></span><span>R包安装</span><span></span></h3><p data-tool="markdown.com.cn编辑器">可以使用以下代码从<code>CRAN</code>安装该包：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code>install.packages(<span>"explainer"</span>)<br></code></pre><section>也可以安装<code>Github</code>中的更新版本：</section><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># install.packages("devtools")</span><br>devtools::install_github(<span>"PERSIMUNE/explainer"</span>)<br></code></pre><h3 data-tool="markdown.com.cn编辑器"><span></span><span>使用示例（共9点）</span><span></span></h3><p data-tool="markdown.com.cn编辑器"><strong>① 加载数据集并训练机器学习模型</strong>。以下代码加载了一个乳腺癌数据集并创建了一个二元分类任务,然后使用mlr3包训练了一个"随机森林"模型。</p><pre data-tool="markdown.com.cn编辑器"><span></span><code>Sys.setenv(LANG = <span>"en"</span>) <span># change R language to English!</span><br>RNGkind(<span>"L'Ecuyer-CMRG"</span>) <span># change to L'Ecuyer-CMRG in case it uses default "Mersenne-Twister"</span><br><br><span>library</span>(<span>"explainer"</span>)<br><span># 创建随机数种子，使结果可重复</span><br>seed &lt;- <span>246</span><br>set.seed(seed)<br><br><span># 从mlbench包中加载数据集</span><br>data(<span>"BreastCancer"</span>, package = <span>"mlbench"</span>)<br><br><span># 确定预测目标列名</span><br>target_col &lt;- <span>"Class"</span><br><br><span># 将"malignant"设置为阳性样本</span><br>positive_class &lt;- <span>"malignant"</span><br>    <br><span># 删除无用数据</span><br>mydata &lt;- BreastCancer[, -<span>1</span>] <span># 1 is ID</span><br><br><span># 移除na</span><br>mydata &lt;- na.omit(mydata)<br><br><span># 创建性别分组</span><br>sex &lt;- sample(c(<span>"Male"</span>, <span>"Female"</span>), size = nrow(mydata), replace = <span>TRUE</span>)<br><br>mydata$age &lt;- as.numeric(sample(seq(<span>18</span>,<span>60</span>), size = nrow(mydata), replace = <span>TRUE</span>))<br><br><span># 添加一列性别用于公平性分析，确保模型不对特定群体（如种族、性别、年龄、收入等）产生区别的影响</span><br>mydata$sex &lt;- factor(sex, levels = c(<span>"Male"</span>, <span>"Female"</span>), labels = c(<span>1</span>, <span>0</span>))<br><br><br><span># 创建一个分类任务</span><br>maintask &lt;- mlr3::TaskClassif$new(id = <span>"my_classification_task"</span>,<br>                                  backend = mydata,<br>                                  target = target_col,<br>                                  positive = positive_class)<br><br><span># 分割生成训练与测试</span><br>set.seed(seed)<br>splits &lt;- mlr3::partition(maintask)<br><br><span>library</span>(<span>"mlr3learners"</span>)<br></code></pre><p>接下来，进行模型训练与测试：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code>mylrn &lt;- mlr3::lrn(<span>"classif.ranger"</span>, predict_type = <span>"prob"</span>)<br><br><span># 训练模型</span><br>mylrn$train(maintask, splits$train)<br><br><span># 测试上进行预测</span><br>mylrn$predict(maintask, splits$test)<br></code></pre><section><strong>② 使用SHAP分析特征变量对预测的影响</strong>：</section><pre data-tool="markdown.com.cn编辑器"><span></span><code><span>library</span>(<span>"magrittr"</span>)<br><span>library</span>(<span>"plotly"</span>)<br><br><span># enhanced SHAP plot</span><br>SHAP_output &lt;- eSHAP_plot(task = maintask,<br>           trained_model = mylrn,<br>           splits = splits,<br>           sample.size = <span>30</span>,<br>           seed = seed,<br>           subset = <span>.8</span>)<br>           <br><span># 可视化</span><br>myplot &lt;- SHAP_output[[<span>1</span>]]<br>myplot<br></code></pre><section><img data-galleryid="" data-imgfileid="100011377" data-ratio="0.6303921568627451" data-s="300,640" data-type="png" data-w="1020" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaibJHEdEdibVQYpnlz2TjU5ia6DU9CuJhuekaSev5ghY3q01zdrUZfHiaBw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaibJHEdEdibVQYpnlz2TjU5ia6DU9CuJhuekaSev5ghY3q01zdrUZfHiaBw/640?wx_fmt=png&amp;from=appmsg"></section><section><strong>可视化与预测概率相关的SHAP值</strong>：</section><pre data-tool="markdown.com.cn编辑器"><span></span><code>SHAP_output[[<span>5</span>]]<br></code></pre><section><img data-galleryid="" data-imgfileid="100011393" data-ratio="0.6482758620689655" data-s="300,640" data-type="png" data-w="1015" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iad66RZh4D4b26eeVZDufWXsRibC8pfGv96vNUibQiasEciapG2PEFfEl9icA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iad66RZh4D4b26eeVZDufWXsRibC8pfGv96vNUibQiasEciapG2PEFfEl9icA/640?wx_fmt=png&amp;from=appmsg"></section><p><strong>③ 通过混淆矩阵可视化模型性能</strong>。下列代码段使用eCM_plot函数可视化混淆矩阵,以评估训练和测试集的模型性能：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># enhanced confusion matrix</span><br>confusionmatrix_plot &lt;- eCM_plot(task = maintask,<br>         trained_model = mylrn,<br>         splits = splits)<br><span>#可视化</span><br>print(confusionmatrix_plot)<br></code></pre><section><img data-galleryid="" data-imgfileid="100011379" data-ratio="1.3055555555555556" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6ia2myOnSe9RaedUNMticW7HibwJff8xe5aZlh6IoCW44dwnd7x3RM3nw3w/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6ia2myOnSe9RaedUNMticW7HibwJff8xe5aZlh6IoCW44dwnd7x3RM3nw3w/640?wx_fmt=png&amp;from=appmsg"></section><p><strong>④ 决策曲线分析</strong>。采用eDecisionCurve函数对模型中的测试集进行"决策曲线分析"：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># enhanced decision curve plot</span><br>eDecisionCurve(task = maintask,<br>         trained_model = mylrn,<br>         splits = splits,<br>         seed = seed)<br></code></pre><section><img data-galleryid="" data-imgfileid="100011380" data-ratio="0.619811320754717" data-s="300,640" data-type="png" data-w="1060" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6ia2y1dxB56WOdfzAO6YC1n9JmTHd8ib1DXc55Tl6NLbgTc5jzX8pjdcfA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6ia2y1dxB56WOdfzAO6YC1n9JmTHd8ib1DXc55Tl6NLbgTc5jzX8pjdcfA/640?wx_fmt=png&amp;from=appmsg"></section><section><strong>⑤ 模型评估(多指标和ROC曲线绘制)</strong><strong>，该包提供的模型评估和可视化指标包括：</strong></section><ul data-tool="markdown.com.cn编辑器"><li><p><span><strong>ROC曲线下面积（AUC）</strong>: AUC量化了二元分类模型的性能,方法是评估 ROC 曲线下的面积，该曲线绘制了不同阈值下的灵敏度与1-特异度。0.5的值表示随机表现，而1表示完美分类；</span></p></li><li><p><span><strong>平衡准确度（BACC）</strong>：BACC通过平均敏感度和特异性来解决类别不平衡问题。范围从0到1，0分表示偶然表现，1分表示完美分类；</span></p></li><li><p><span><strong>马修斯相关系数（MCC）：</strong>MCC评估二分类模型质量,考虑真阳性、真阴性、假阳性和假阴性。范围从-1到1，-1表示完全不一致，0表示随机性能，1表示完美分类；</span></p></li><li><p><span><strong>布里尔得分（BBRIER）</strong>: 布里尔得分通过测量预测概率和实际二元结果之间的平均平方差来衡量概率预测的准确性。取值范围从0到1，越大越好；</span></p></li><li><p><span><strong>正确率（PPV）</strong>：PPV或准确率，衡量模型所有正预测中真正属于正类的比例；</span></p></li><li><p><span><strong>负预测值（NPV）</strong>: NPV量化了模型做出的全部负预测中真正为负的预测的比例；</span></p></li><li><p><span><strong>特异性（Specificity）</strong>:特异性计算在二分类问题中，所有实际负例中真正的负预测的比例；</span></p></li><li><p><span><strong>敏感度（Sensitivity）</strong>: 也称为召回率或真正率，衡量二元分类问题中所有实际阳性案例中真正阳性预测的比例；</span></p></li><li><section><span><strong>准确率-召回率曲线下面积（PRAUC）</strong>：PRAUC根据精确度和召回率评估二元分类模型的性能，量化了精确率-召回率曲线下的面积。PRAUC值为1表示分类性能完美。<strong>除了以上得分的计算，还可以可视化训练集和测试集的ROC和PR曲线：</strong></span></section></li></ul><pre data-tool="markdown.com.cn编辑器"><span></span><code>eROC_plot(task = maintask,<br>         trained_model = mylrn,<br>         splits = splits)<br><span>## [[1]]</span><br><span># 输出图片在下面</span><br><span>## </span><br><span>## [[2]]</span><br><span>##             pred_results$score(measures = mlr3::msrs(meas))</span><br><span>## auc                                                    1.00</span><br><span>## bacc                                                   0.99</span><br><span>## mcc                                                    0.98</span><br><span>## bbrier                                                 0.01</span><br><span>## ppv                                                    0.98</span><br><span>## npv                                                    1.00</span><br><span>## specificity                                            0.99</span><br><span>## sensitivity                                            0.99</span><br><span>## prauc                                                  1.00</span><br><span>## </span><br><span>## [[3]]</span><br><span>##             pred_results_test$score(measures = mlr3::msrs(meas))</span><br><span>## auc                                                         0.99</span><br><span>## bacc                                                        0.97</span><br><span>## mcc                                                         0.92</span><br><span>## bbrier                                                      0.04</span><br><span>## ppv                                                         0.93</span><br><span>## npv                                                         0.99</span><br><span>## specificity                                                 0.96</span><br><span>## sensitivity                                                 0.97</span><br><span>## prauc                                                       0.97</span><br></code></pre><section><img data-backh="315" data-backw="467" data-galleryid="" data-imgfileid="100011381" data-ratio="0.6753381893860562" data-s="300,640" data-type="png" data-w="961" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6ia2KZCkSJ1RIR7nFQR7SZic8vBnz1pVhpziaTfLnf95mzWq4UOicLAyW7Pg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6ia2KZCkSJ1RIR7nFQR7SZic8vBnz1pVhpziaTfLnf95mzWq4UOicLAyW7Pg/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="markdown.com.cn编辑器"><strong>不仅如此，可以指定带有注释的阈值ROC曲线</strong>（即不同概率阈值下的模型精准性与召回率）：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code>ePerformance(task = maintask,<br>         trained_model = mylrn,<br>         splits = splits)<br></code></pre><section><img data-backh="262" data-backw="432" data-galleryid="" data-imgfileid="100011382" data-ratio="0.6065727699530516" data-s="300,640" data-type="png" data-w="1065" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iamF8NSlNTXNf1YnYWpODAo5ZaicdL3jjccxLTHwZWnDic0iaX1n0zqicZtg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iamF8NSlNTXNf1YnYWpODAo5ZaicdL3jjccxLTHwZWnDic0iaX1n0zqicZtg/640?wx_fmt=png&amp;from=appmsg"></section><section>⑥ <strong>进一步加载SHAP结果以供后续分析</strong>。首先，可以从eSHAP_plot函数获得输出来对SHAP值应用聚类：</section><pre data-tool="markdown.com.cn编辑器"><span></span><code>shap_Mean_wide &lt;- SHAP_output[[<span>2</span>]]<br><br>shap_Mean_long &lt;- SHAP_output[[<span>3</span>]]<br><br>shap &lt;- SHAP_output[[<span>4</span>]]<br></code></pre><p data-tool="markdown.com.cn编辑器"><strong>其次，可以分析SHAP值与特征变量之间的关联</strong>：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code>ShapFeaturePlot(shap_Mean_long)<br></code></pre><section><img data-backh="229" data-backw="379" data-galleryid="" data-imgfileid="100011383" data-ratio="0.6032818532818532" data-s="300,640" data-type="png" data-w="1036" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaGgQMtgiczqloD5hvhOFpotkfbmAh6licWctibuNRlAXEBLAtMjibTffpUw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaGgQMtgiczqloD5hvhOFpotkfbmAh6licWctibuNRlAXEBLAtMjibTffpUw/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="markdown.com.cn编辑器"><strong>再者，可以绘制偏依赖图 (PDPs)，用于可视化单个特征对模型预测的边际效应。</strong>具体而言，PDP是一种可视化工具，旨在展示一个或多个特征的变化如何影响预测模型的输出。PDP显示了某个特定特征的变化对模型预测结果的影响，假设其他特征保持不变：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code>ShapPartialPlot(shap_Mean_long = shap_Mean_long)<br></code></pre><section><img data-galleryid="" data-imgfileid="100011384" data-ratio="0.5992292870905588" data-s="300,640" data-type="png" data-w="1038" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iamUCPmCYfokhXuV5wNxE9ETqoejBJFL2DOA7C8nUzIlkaNlwiabEDsyA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iamUCPmCYfokhXuV5wNxE9ETqoejBJFL2DOA7C8nUzIlkaNlwiabEDsyA/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="markdown.com.cn编辑器"><strong>⑦ 由SHAP聚类确定患者的亚型。</strong>SHAP聚类是一种方法，用于更好地理解为何模型对某些患者的表现优于其他患者。<strong>例如，可以识别出具有特定特征模式的患者亚型，从而解释为何模型在这些患者上的表现优于或劣于整个数据集的平均表现。</strong>在SHAP图中，如果将所有样本合并，会得到整体的SHAP总结图。这里的边缘反映了特征在每个单独样本中的相互作用。</p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># num_of_clusters参数指定聚类数量</span><br>SHAP_plot_clusters &lt;- SHAPclust(task = maintask,<br>         trained_model = mylrn,<br>         splits = splits,<br>         shap_Mean_wide = shap_Mean_wide,<br>         shap_Mean_long = shap_Mean_long,<br>         num_of_clusters = <span>3</span>,<br>         seed = seed,<br>         subset = <span>.8</span>)<br>         <br><span>## Key: &lt;sample_num, feature, Phi&gt;</span><br><span>##       sample_num         feature           Phi cluster    mean_phi     f_val</span><br><span>##            &lt;int&gt;          &lt;char&gt;         &lt;num&gt;   &lt;int&gt;       &lt;num&gt;     &lt;num&gt;</span><br><span>##    1:          1     Bare.nuclei -0.0858948677       3 0.093444244 0.0000000</span><br><span>##    2:          1     Bl.cromatin -0.0699857672       3 0.044548987 0.0000000</span><br><span>##    3:          1      Cell.shape -0.0459229894       3 0.076720237 0.0000000</span><br><span>##    4:          1       Cell.size -0.0555791270       3 0.091198097 0.0000000</span><br><span>##    5:          1    Cl.thickness -0.0169917196       3 0.069835393 0.5000000</span><br><span>##   ---                                                                       </span><br><span>## 1976:        180   Marg.adhesion  0.0475544444       2 0.026453762 1.0000000</span><br><span>## 1977:        180         Mitoses  0.0024593386       2 0.002165296 0.1250000</span><br><span>## 1978:        180 Normal.nucleoli  0.0348163757       2 0.021391343 0.7777778</span><br><span>## 1979:        180             age -0.0157181481       2 0.003230698 0.0000000</span><br><span>## 1980:        180             sex -0.0008616667       2 0.001183048 0.0000000</span><br><span>##       unscaled_f_val correct_prediction   pred_prob pred_class</span><br><span>##                &lt;num&gt;             &lt;fctr&gt;       &lt;num&gt;     &lt;fctr&gt;</span><br><span>##    1:              1            Correct 0.002554762     benign</span><br><span>##    2:              1            Correct 0.002554762     benign</span><br><span>##    3:              1            Correct 0.002554762     benign</span><br><span>##    4:              1            Correct 0.002554762     benign</span><br><span>##    5:              5            Correct 0.002554762     benign</span><br><span>##   ---                                                         </span><br><span>## 1976:             10            Correct 0.926616667  malignant</span><br><span>## 1977:              2            Correct 0.926616667  malignant</span><br><span>## 1978:              8            Correct 0.926616667  malignant</span><br><span>## 1979:             18            Correct 0.926616667  malignant</span><br><span>## 1980:              1            Correct 0.926616667  malignant</span><br></code></pre><p data-tool="markdown.com.cn编辑器">如上，cluster列即为聚类结果。<strong>接下来可以将聚类与SHAP一起进行可视化：</strong></p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># display the SHAP cluster plots</span><br>SHAP_plot_clusters[[<span>1</span>]]<br></code></pre><p><img data-galleryid="" data-imgfileid="100011385" data-ratio="0.6159769008662175" data-s="300,640" data-type="png" data-w="1039" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6ia2PROxO9cubyEYZvd0Rxcb0xpXBjaJEnJC32YHZv1bP4zcpVbiagPh6w/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6ia2PROxO9cubyEYZvd0Rxcb0xpXBjaJEnJC32YHZv1bP4zcpVbiagPh6w/640?wx_fmt=png&amp;from=appmsg"></p><p data-class="mbImgTitle">▲ 可以看到，三种聚类的解释性是不一样的。</p><p data-tool="markdown.com.cn编辑器"><strong>展示不同聚类亚型的混淆矩阵</strong>：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># 显示与 SHAP 亚型（由 SHAP 聚类确定的患者子集）对应的混淆矩阵</span><br>SHAP_plot_clusters[[<span>2</span>]]<br></code></pre><p><img data-galleryid="" data-imgfileid="100011386" data-ratio="0.3647738209817132" data-s="300,640" data-type="png" data-w="1039" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaiabDW0DYJWuIQMz8uEfzzT3zuqRpkUIntdQMKgd2R1cMBJnBCS9mNyA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaiabDW0DYJWuIQMz8uEfzzT3zuqRpkUIntdQMKgd2R1cMBJnBCS9mNyA/640?wx_fmt=png&amp;from=appmsg"></p><section>▲ 如上，模型在不同的患者亚型的表现是不一样的，说明他们在特征上存在一定差别。</section><p data-tool="markdown.com.cn编辑器">⑧ 模型公平性(敏感性分析)。对于不同子组，如性别，我们有时想研究模型的表现是否公平（在不同性别的人群中表现是一致的）。</p><pre data-tool="markdown.com.cn编辑器"><span></span><code>Fairness_results &lt;- eFairness(task = maintask,<br>         trained_model = mylrn,<br>         splits = splits,<br>         target_variable = <span>"sex"</span>,<br>         var_levels = c(<span>"Male"</span>, <span>"Female"</span>))<br>         <br><span># 训练集（左）和测试集（右）不同子分组的 ROC 曲线</span><br>Fairness_results[[<span>1</span>]]<br></code></pre><section><img data-galleryid="" data-imgfileid="100011387" data-ratio="0.6199616122840691" data-s="300,640" data-type="png" data-w="1042" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaBaAq8A8Ppwb8Amdu8AlSnU0pcsrGNUWRyzHiasaphBfLnZHJrst4fRw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/LvUIqvYKCeWHb9icic9pfQ2nmQUrYUEV6iaBaAq8A8Ppwb8Amdu8AlSnU0pcsrGNUWRyzHiasaphBfLnZHJrst4fRw/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="markdown.com.cn编辑器"><strong>⑨ 最后，可以看看模型的参数</strong>：</p><pre data-tool="markdown.com.cn编辑器"><span></span><code><span># get model parameters</span><br>model_params &lt;- mylrn$param_set<br><br>print(data.table::as.data.table(model_params))<br><span>##                               id    class lower upper</span><br><span>##                           &lt;char&gt;   &lt;char&gt; &lt;num&gt; &lt;num&gt;</span><br><span>##  1:                        alpha ParamDbl  -Inf   Inf</span><br><span>##  2:       always.split.variables ParamUty    NA    NA</span><br><span>##  3:                class.weights ParamUty    NA    NA</span><br><span>##  4:                      holdout ParamLgl    NA    NA</span><br><span>##  5:                   importance ParamFct    NA    NA</span><br><span>##  6:                   keep.inbag ParamLgl    NA    NA</span><br><span>##  7:                    max.depth ParamInt     0   Inf</span><br><span>##  8:                   min.bucket ParamInt     1   Inf</span><br><span>##  9:                min.node.size ParamInt     1   Inf</span><br><span>## 10:                      minprop ParamDbl  -Inf   Inf</span><br><span>## 11:                         mtry ParamInt     1   Inf</span><br><span>## 12:                   mtry.ratio ParamDbl     0     1</span><br><span>## 13:            num.random.splits ParamInt     1   Inf</span><br><span>## 14:                   node.stats ParamLgl    NA    NA</span><br><span>## 15:                  num.threads ParamInt     1   Inf</span><br><span>## 16:                    num.trees ParamInt     1   Inf</span><br><span>## 17:                    oob.error ParamLgl    NA    NA</span><br><span>## 18:        regularization.factor ParamUty    NA    NA</span><br><span>## 19:      regularization.usedepth ParamLgl    NA    NA</span><br><span>## 20:                      replace ParamLgl    NA    NA</span><br><span>## 21:    respect.unordered.factors ParamFct    NA    NA</span><br><span>## 22:              sample.fraction ParamDbl     0     1</span><br><span>## 23:                  save.memory ParamLgl    NA    NA</span><br><span>## 24: scale.permutation.importance ParamLgl    NA    NA</span><br><span>## 25:                    se.method ParamFct    NA    NA</span><br><span>## 26:                         seed ParamInt  -Inf   Inf</span><br><span>## 27:         split.select.weights ParamUty    NA    NA</span><br><span>## 28:                    splitrule ParamFct    NA    NA</span><br><span>## 29:                      verbose ParamLgl    NA    NA</span><br><span>## 30:                 write.forest ParamLgl    NA    NA</span><br><span>##                               id    class lower upper</span><br><span>##                                           levels nlevels is_bounded</span><br><span>##                                           &lt;list&gt;   &lt;num&gt;     &lt;lgcl&gt;</span><br><span>##  1:                                       [NULL]     Inf      FALSE</span><br><span>##  2:                                       [NULL]     Inf      FALSE</span><br><span>##  3:                                       [NULL]     Inf      FALSE</span><br><span>##  4:                                   TRUE,FALSE       2       TRUE</span><br><span>##  5: none,impurity,impurity_corrected,permutation       4       TRUE</span><br><span>##  6:                                   TRUE,FALSE       2       TRUE</span><br><span>##  7:                                       [NULL]     Inf      FALSE</span><br><span>##  8:                                       [NULL]     Inf      FALSE</span><br><span>##  9:                                       [NULL]     Inf      FALSE</span><br><span>## 10:                                       [NULL]     Inf      FALSE</span><br><span>## 11:                                       [NULL]     Inf      FALSE</span><br><span>## 12:                                       [NULL]     Inf       TRUE</span><br><span>## 13:                                       [NULL]     Inf      FALSE</span><br><span>## 14:                                   TRUE,FALSE       2       TRUE</span><br><span>## 15:                                       [NULL]     Inf      FALSE</span><br><span>## 16:                                       [NULL]     Inf      FALSE</span><br><span>## 17:                                   TRUE,FALSE       2       TRUE</span><br><span>## 18:                                       [NULL]     Inf      FALSE</span><br><span>## 19:                                   TRUE,FALSE       2       TRUE</span><br><span>## 20:                                   TRUE,FALSE       2       TRUE</span><br><span>## 21:                       ignore,order,partition       3       TRUE</span><br><span>## 22:                                       [NULL]     Inf       TRUE</span><br><span>## 23:                                   TRUE,FALSE       2       TRUE</span><br><span>## 24:                                   TRUE,FALSE       2       TRUE</span><br><span>## 25:                                 jack,infjack       2       TRUE</span><br><span>## 26:                                       [NULL]     Inf      FALSE</span><br><span>## 27:                                       [NULL]     Inf      FALSE</span><br><span>## 28:                    gini,extratrees,hellinger       3       TRUE</span><br><span>## 29:                                   TRUE,FALSE       2       TRUE</span><br><span>## 30:                                   TRUE,FALSE       2       TRUE</span><br><span>##                                           levels nlevels is_bounded</span><br><span>##     special_vals        default storage_type                   tags</span><br><span>##           &lt;list&gt;         &lt;list&gt;       &lt;char&gt;                 &lt;list&gt;</span><br><span>##  1:    &lt;list[0]&gt;            0.5      numeric                  train</span><br><span>##  2:    &lt;list[0]&gt; &lt;NoDefault[0]&gt;         list                  train</span><br><span>##  3:    &lt;list[0]&gt;         [NULL]         list                  train</span><br><span>##  4:    &lt;list[0]&gt;          FALSE      logical                  train</span><br><span>##  5:    &lt;list[0]&gt; &lt;NoDefault[0]&gt;    character                  train</span><br><span>##  6:    &lt;list[0]&gt;          FALSE      logical                  train</span><br><span>##  7:    &lt;list[1]&gt;         [NULL]      integer                  train</span><br><span>##  8:    &lt;list[0]&gt;              1      integer                  train</span><br><span>##  9:    &lt;list[1]&gt;         [NULL]      integer                  train</span><br><span>## 10:    &lt;list[0]&gt;            0.1      numeric                  train</span><br><span>## 11:    &lt;list[1]&gt; &lt;NoDefault[0]&gt;      integer                  train</span><br><span>## 12:    &lt;list[0]&gt; &lt;NoDefault[0]&gt;      numeric                  train</span><br><span>## 13:    &lt;list[0]&gt;              1      integer                  train</span><br><span>## 14:    &lt;list[0]&gt;          FALSE      logical                  train</span><br><span>## 15:    &lt;list[0]&gt;              1      integer  train,predict,threads</span><br><span>## 16:    &lt;list[0]&gt;            500      integer train,predict,hotstart</span><br><span>## 17:    &lt;list[0]&gt;           TRUE      logical                  train</span><br><span>## 18:    &lt;list[0]&gt;              1         list                  train</span><br><span>## 19:    &lt;list[0]&gt;          FALSE      logical                  train</span><br><span>## 20:    &lt;list[0]&gt;           TRUE      logical                  train</span><br><span>## 21:    &lt;list[0]&gt;         ignore    character                  train</span><br><span>## 22:    &lt;list[0]&gt; &lt;NoDefault[0]&gt;      numeric                  train</span><br><span>## 23:    &lt;list[0]&gt;          FALSE      logical                  train</span><br><span>## 24:    &lt;list[0]&gt;          FALSE      logical                  train</span><br><span>## 25:    &lt;list[0]&gt;        infjack    character                predict</span><br><span>## 26:    &lt;list[1]&gt;         [NULL]      integer          train,predict</span><br><span>## 27:    &lt;list[0]&gt;         [NULL]         list                  train</span><br><span>## 28:    &lt;list[0]&gt;           gini    character                  train</span><br><span>## 29:    &lt;list[0]&gt;           TRUE      logical          train,predict</span><br><span>## 30:    &lt;list[0]&gt;           TRUE      logical                  train</span><br><span>##     special_vals        default storage_type                   tags</span><br></code></pre><p><strong><span><strong><span><span><strong><span>简单分享到这里 </span></strong><strong><span><img data-ratio="1" data-w="128" data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Yellowdog.png" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/Yellowdog.png"></span></strong></span></span></strong></span></strong></p><p><strong><span>欢迎各位佬哥关注<br></span></strong></p><p><strong><span>匿了</span></strong></p><section><mp-common-profile data-id="MzkyNTIzMzYyMA==" data-pluginname="mpprofile" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/LvUIqvYKCeXYZNMxRMnjiaicO2a27jDZ2FgQga8TdeQcsGRJRIn2IInkKtfcbbMXOBSViaPXpTOBulUlNzd11pzow/0?wx_fmt=png" data-nickname="生信碱移" data-alias="liudoufu307" data-signature="春来秋至，分享我的所见与所识" data-from="2" data-weuitheme="light"></mp-common-profile></section><section><br></section><section><strong><span>END~</span></strong><br></section><p><span><strong>仅供粉丝老铁们参考</strong></span></p><p><strong>如有侵权或错误，请联系删除改正～</strong></p><section> </section><section data-class="_mbEditor" data-id="32689"><section><section><section><p><span><strong mpa-from-tpl="t">推荐好文，点击查看:</strong></span></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkyNTIzMzYyMA==&amp;mid=2247490399&amp;idx=1&amp;sn=bab116f9b25cfef81c690cfa566ec034&amp;chksm=c1c8e3e4f6bf6af2ac22ee98441129f72698139a2fc5cba2607a7cad46449da498e2a37e732f&amp;scene=21#wechat_redirect" textvalue="【教程】一文读懂孟德尔随机化！" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">【教程】一文读懂孟德尔随机化！</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkyNTIzMzYyMA==&amp;mid=2247494562&amp;idx=1&amp;sn=20ab1c2c80cb7b5b2a8b49a0bb0a4b40&amp;chksm=c1cb1319f6bc9a0fc71379139522d0ccc70589da77ee0ab8a389ff87ac2aa255a2b10185806a&amp;scene=21#wechat_redirect" textvalue="【工具‍】单细胞密度算法，绝哥！" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>【工具】NBT: 单细胞可解释张量分解算法sclTD！</span></a></p><p><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzkyNTIzMzYyMA==&amp;mid=2247494967&amp;idx=1&amp;sn=ed3b3348555e6c60b96e4b0378d46657&amp;scene=21#wechat_redirect" textvalue="【文献】这篇顶刊纯生信领先常规‍生信分析一个版本！" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">【文献】Nat. Biomed. Eng | 大语言模型+单细胞测序！普通研究者应该好好学习借鉴一下</a></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkyNTIzMzYyMA==&amp;mid=2247494231&amp;idx=2&amp;sn=b3fb91ed7fa5d5775e16422cd502b0e8&amp;chksm=c1cb12ecf6bc9bfab457e75d1deb37045c9a86e9609e87f3707c38d9dd3083eefcf47689699b&amp;scene=21#wechat_redirect" textvalue="【期刊】无版面费低分 SCI 期刊，近期发表多篇纯网药‍研究！" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1"><span>【期刊】无版面费低分 SCI 期刊，近期发表多篇纯网药研究！</span></a></p></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/VCYUBWIkaqx-RDiTu5nXWQ",target="_blank" rel="noopener noreferrer">原文链接</a>
