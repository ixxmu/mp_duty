---
title: "ggplot 个性化绘制旭日图"
date: 2024-12-18T02:58:39Z
draft: ["false"]
tags: [
  "fetched",
  "生信杂货铺"
]
categories: ["Acdemic"]
---
ggplot 个性化绘制旭日图 by 生信杂货铺
------
<div><section nodeleaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="生信杂货铺" data-alias="comelove2020" data-from="0" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKgcIVlZ69OBM3mfiarb4tHc8aApGDf11AV6iaYYj6CRgf4VLzogibhDtdHo9JUfUZSt4errsCMNmtbg/0?wx_fmt=png" data-signature="生物信息知识内容分享，学习笔记，资源分享，编程技巧" data-id="MzkxMjE4NDc2Mw==" data-is_biz_ban="0" data-service_type="1"></mp-common-profile></section><section><span leaf=""><br></span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">数据准备</span></span><span data-cacheurl="" data-remoteid=""></span></h3><p data-tool="mdnice编辑器"><span leaf="">导入包</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| message: false</span></span><br><br><span><span leaf="">library</span></span><span leaf="">(scales)</span><br><span><span leaf="">library</span></span><span leaf="">(gground)</span><br><span><span leaf="">library</span></span><span leaf="">(tidyverse)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">读取分类数据</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">product &lt;- read_csv(</span><span><span leaf="">'data/product.csv'</span></span><span leaf="">, show_col_types = </span><span><span leaf="">FALSE</span></span><span leaf="">)</span><br><br><span leaf="">head(product)</span><br><span><span leaf=""># # A tibble: 6 × 3</span></span><br><span><span leaf=""># product_category product_subcategory product_name</span></span><br><span><span leaf=""># &lt;chr&gt;            &lt;chr&gt;               &lt;chr&gt;       </span></span><br><span><span leaf="">#     1 Clothing         Sportswear          Running Gear</span></span><br><span><span leaf=""># 2 Food             Meat                Lamb        </span></span><br><span><span leaf=""># 3 Clothing         Women's Wear        Blouses     </span></span><br><span><span leaf=""># 4 Food             Dairy               NA          </span></span><br><span><span leaf=""># 5 Electronics      Accessories         NA          </span></span><br><span><span leaf=""># 6 Clothing         Sportswear          Swimwear</span></span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">数据按照顺序分类，即第一列为大类，第三列为最小的类别。其中，第三列包含一些</span><code><span leaf="">NA</span></code><span leaf=""> 值，主要是为了构造出分类层数不一的效果</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">categories &lt;- colnames(product)</span><br><span leaf="">ncate &lt;- length(categories)</span><br><br><span leaf="">category_data &lt;- product %&gt;%</span><br><span leaf="">    group_by(!!!syms(categories)) %&gt;%</span><br><span leaf="">    reframe(value = n()) %&gt;%</span><br><span leaf="">    mutate(ymax = cumsum(value), </span><br><span leaf="">           ymin = lag(ymax, default = </span><span><span leaf="">0</span></span><span leaf="">))</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">设置颜色，用</span><code><span leaf="">pal</span></code><span leaf=""> 定义第一分类的颜色</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">pal &lt;- structure(</span><br><span leaf="">    c(</span><span><span leaf="">'#4285f4'</span></span><span leaf="">, </span><span><span leaf="">'#34a853'</span></span><span leaf="">, </span><span><span leaf="">'#fbbc05'</span></span><span leaf="">, </span><span><span leaf="">'#ea4335'</span></span><span leaf="">),</span><br><span leaf="">    names = unique(category_data[[</span><span><span leaf="">1</span></span><span leaf="">]])</span><br><span leaf="">    )</span><br><br><span leaf="">nlevel &lt;- structure(</span><span><span leaf="">1</span></span><span leaf="">:ncate, names = categories)</span><br><br><span leaf="">ranges &lt;- group_by(category_data, !!sym(categories[</span><span><span leaf="">1</span></span><span leaf="">])) %&gt;%</span><br><span leaf="">    reframe(range = sum(value)) %&gt;%</span><br><span leaf="">    tibble::column_to_rownames(categories[</span><span><span leaf="">1</span></span><span leaf="">])</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">定义主题</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">theme_no_axis &lt;- theme(</span><br><span leaf="">    panel.background = element_blank(),</span><br><span leaf="">    panel.grid = element_blank(),</span><br><span leaf="">    axis.title = element_blank(),</span><br><span leaf="">    axis.text = element_blank(),</span><br><span leaf="">    axis.ticks = element_blank()</span><br><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">计算并构造绘图数据，用</span><code><span leaf="">width</span></code><span leaf=""> 控制每个类别层级的宽度</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">width &lt;- c(</span><span><span leaf="">3</span></span><span leaf="">, </span><span><span leaf="">5</span></span><span leaf="">, </span><span><span leaf="">7</span></span><span leaf="">)</span><br><span leaf="">span &lt;- data.frame(</span><br><span leaf="">    xmin = lag(width, default = </span><span><span leaf="">0</span></span><span leaf="">),</span><br><span leaf="">    xmax = width,</span><br><span leaf="">    row.names = categories</span><br><span leaf="">)</span><br><br><span leaf="">data &lt;- do.call(rbind, lapply(categories, </span><span><span leaf="">function</span></span><span leaf=""> (col) {</span><br><span leaf="">    category_data %&gt;%</span><br><span leaf="">        group_by(!!sym(col)) %&gt;%</span><br><span leaf="">        reframe(ymax = max(ymax), </span><br><span leaf="">                ymin = min(ymin),</span><br><span leaf="">                xmin = span[col, </span><span><span leaf="">'xmin'</span></span><span leaf="">],</span><br><span leaf="">                xmax = span[col, </span><span><span leaf="">'xmax'</span></span><span leaf="">],</span><br><span leaf="">                value = sum(value),</span><br><span leaf="">                root = first(!!sym(categories[</span><span><span leaf="">1</span></span><span leaf="">])),</span><br><span leaf="">                level = nlevel[col]) %&gt;%</span><br><span leaf="">        rowwise() %&gt;%</span><br><span leaf="">        mutate(</span><br><span leaf="">            </span><span><span leaf=""># 分层固定颜色</span></span><br><span leaf="">            fill = colorRampPalette(c(pal[root], </span><span><span leaf="">'white'</span></span><span leaf="">))(ncate+</span><span><span leaf="">1</span></span><span leaf="">)[level],</span><br><span leaf="">            </span><span><span leaf=""># 渐变色</span></span><br><span leaf="">            gradient = col_numeric(</span><br><span leaf="">                palette = c(</span><span><span leaf="">'white'</span></span><span leaf="">, pal[root]), </span><br><span leaf="">                domain = c(</span><span><span leaf="">0</span></span><span leaf="">, log2(ranges[root, </span><span><span leaf="">'range'</span></span><span leaf="">])))(log2(value))) %&gt;%</span><br><span leaf="">        ungroup() %&gt;%</span><br><span leaf="">        rename(</span><span><span leaf="">'cate'</span></span><span leaf=""> = col) %&gt;%</span><br><span leaf="">        dplyr::filter(!is.na(cate))</span><br><span leaf="">}))</span><br></code></pre><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">绘制旭日图</span></span><span data-cacheurl="" data-remoteid=""></span></h3><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">1. 常规模式</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: normal</span></span><br><br><span leaf="">data %&gt;%</span><br><span leaf="">    ggplot(aes(xmin = xmin, xmax = xmax, </span><br><span leaf="">               ymin = ymin, ymax = ymax,</span><br><span leaf="">               fill = cate)) +</span><br><span leaf="">    geom_rect(</span><br><span leaf="">        colour = </span><span><span leaf="">'white'</span></span><span leaf="">,show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_text(aes(x = (xmin + xmax) / </span><span><span leaf="">2</span></span><span leaf="">, y = (ymin + ymax) / </span><span><span leaf="">2</span></span><span leaf="">, </span><br><span leaf="">                  label = cate), size = </span><span><span leaf="">2</span></span><span leaf="">) +</span><br><span leaf="">    scale_fill_manual(values = structure(data$fill, names = data$cate)) +</span><br><span leaf="">    coord_polar(theta = </span><span><span leaf="">'y'</span></span><span leaf="">) +</span><br><span leaf="">    theme_no_axis</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100017706" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMForCjaeoiaxtY8ibgUQMm4t1vx0DWmicv6RwXBXAyykJXKgOnKfBAc9Nw/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMForCjaeoiaxtY8ibgUQMm4t1vx0DWmicv6RwXBXAyykJXKgOnKfBAc9Nw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">设置文本的角度</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: normal-text</span></span><br><br><span leaf="">angle &lt;- </span><span><span leaf="">90</span></span><span leaf=""> - </span><span><span leaf="">360</span></span><span leaf=""> * (data$ymin + data$ymax) / </span><span><span leaf="">2</span></span><span leaf=""> / max(data$ymax)</span><br><br><span leaf="">data %&gt;%</span><br><span leaf="">    ggplot(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,</span><br><span leaf="">            fill = cate)) +</span><br><span leaf="">    geom_rect(aes(group = cate),</span><br><span leaf="">        colour = </span><span><span leaf="">'white'</span></span><span leaf="">, show.legend = </span><span><span leaf="">FALSE</span></span><br><span leaf="">    ) +</span><br><span leaf="">    geom_text(aes(x = (xmin + xmax) / </span><span><span leaf="">2</span></span><span leaf="">, y = (ymin + ymax) / </span><span><span leaf="">2</span></span><span leaf="">, </span><br><span leaf="">                  label = cate), </span><br><span leaf="">              angle = ifelse(angle &lt; -</span><span><span leaf="">90</span></span><span leaf="">, angle + </span><span><span leaf="">180</span></span><span leaf="">, angle), </span><br><span leaf="">              hjust = </span><span><span leaf="">0.5</span></span><span leaf="">, size = </span><span><span leaf="">2</span></span><span leaf="">) +</span><br><span leaf="">    scale_fill_manual(values = structure(data$fill, names = data$cate)) +</span><br><span leaf="">    coord_polar(theta = </span><span><span leaf="">'y'</span></span><span leaf="">) +</span><br><span leaf="">    theme_no_axis</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100017707" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMlzZibmnChKFFO6KwScEAeklAQrufLeZfU6ACNjMOWYMsgicQ1sVGWnaA/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMlzZibmnChKFFO6KwScEAeklAQrufLeZfU6ACNjMOWYMsgicQ1sVGWnaA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">设置渐变色</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: normal-gradient</span></span><br><br><span leaf="">angle &lt;- </span><span><span leaf="">90</span></span><span leaf=""> - </span><span><span leaf="">360</span></span><span leaf=""> * (data$ymin + data$ymax) / </span><span><span leaf="">2</span></span><span leaf=""> / max(data$ymax)</span><br><br><span leaf="">data %&gt;%</span><br><span leaf="">    ggplot(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,</span><br><span leaf="">            fill = cate)) +</span><br><span leaf="">    geom_rect(aes(group = cate),</span><br><span leaf="">        colour = </span><span><span leaf="">'white'</span></span><span leaf="">, show.legend = </span><span><span leaf="">FALSE</span></span><br><span leaf="">    ) +</span><br><span leaf="">    geom_text(aes(x = (xmin + xmax) / </span><span><span leaf="">2</span></span><span leaf="">, y = (ymin + ymax) / </span><span><span leaf="">2</span></span><span leaf="">, </span><br><span leaf="">                  label = cate), </span><br><span leaf="">              angle = ifelse(angle &lt; -</span><span><span leaf="">90</span></span><span leaf="">, angle + </span><span><span leaf="">180</span></span><span leaf="">, angle), </span><br><span leaf="">              hjust = </span><span><span leaf="">0.5</span></span><span leaf="">, size = </span><span><span leaf="">2</span></span><span leaf="">) +</span><br><span leaf="">    scale_fill_manual(values = structure(data$gradient, names = data$cate)) +</span><br><span leaf="">    coord_polar(theta = </span><span><span leaf="">'y'</span></span><span leaf="">) +</span><br><span leaf="">    theme_no_axis</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100017705" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMZvHwGyMZWhyHqds7urmR3rEbs3BVlLsLOXUsiauDL0icqxz4jneGu6tQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMZvHwGyMZWhyHqds7urmR3rEbs3BVlLsLOXUsiauDL0icqxz4jneGu6tQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">2. 圆角样式</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">可以使用</span><code><span leaf="">gground</span></code><span leaf=""> 包中的</span><code><span leaf="">geom_round_rect</span></code><span leaf=""> 替换</span><code><span leaf="">geom_rect</span></code><span leaf="">，绘制圆角样式</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: round_all</span></span><br><br><span leaf="">data %&gt;%</span><br><span leaf="">    ggplot(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,</span><br><span leaf="">            fill = cate)) +</span><br><span leaf="">    geom_round_rect(aes(group = cate),</span><br><span leaf="">        colour = </span><span><span leaf="">'white'</span></span><span leaf="">, radius = unit(</span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">'pt'</span></span><span leaf="">),</span><br><span leaf="">        show.legend = </span><span><span leaf="">FALSE</span></span><br><span leaf="">    ) +</span><br><span leaf="">    geom_text(aes(x = (xmin + xmax) / </span><span><span leaf="">2</span></span><span leaf="">, y = (ymin + ymax) / </span><span><span leaf="">2</span></span><span leaf="">, </span><br><span leaf="">                  label = cate), </span><br><span leaf="">              angle = ifelse(angle &lt; -</span><span><span leaf="">90</span></span><span leaf="">, angle + </span><span><span leaf="">180</span></span><span leaf="">, angle), </span><br><span leaf="">              hjust = </span><span><span leaf="">0.5</span></span><span leaf="">, size = </span><span><span leaf="">2</span></span><span leaf="">) +</span><br><span leaf="">    scale_fill_manual(values = structure(data$fill, names = data$cate)) +</span><br><span leaf="">    coord_polar(theta = </span><span><span leaf="">'y'</span></span><span leaf="">) +</span><br><span leaf="">    theme_no_axis</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100017708" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMib7NOeDupia2EGiax8zE4VL47p5lJ51iaJia1d1DdoEpgTejXX8alsOwBiaQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMib7NOeDupia2EGiax8zE4VL47p5lJ51iaJia1d1DdoEpgTejXX8alsOwBiaQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">看起来不错，但是有一个缺点。所有矩形的圆角都一样，如何对越靠近圆心的圈设置更大的圆角？</span></p><p data-tool="mdnice编辑器"><span leaf="">我们可以分开绘制，例如</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: round_seperate</span></span><br><br><span leaf="">angle &lt;- dplyr::filter(data, level == </span><span><span leaf="">3</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    mutate(angle = </span><span><span leaf="">90</span></span><span leaf=""> - </span><span><span leaf="">360</span></span><span leaf=""> * (ymin + ymax) / </span><span><span leaf="">2</span></span><span leaf=""> / max(ymax)) %&gt;%</span><br><span leaf="">    pull(angle)</span><br><span leaf="">    </span><br><br><span leaf="">data %&gt;%</span><br><span leaf="">    ggplot(aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,</span><br><span leaf="">            fill = cate)) +</span><br><span leaf="">    geom_round_rect(data = dplyr::filter(data, level == </span><span><span leaf="">1</span></span><span leaf="">), </span><br><span leaf="">                    colour = </span><span><span leaf="">'white'</span></span><span leaf="">, radius = unit(</span><span><span leaf="">6</span></span><span leaf="">, </span><span><span leaf="">'pt'</span></span><span leaf="">),</span><br><span leaf="">                    show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_round_rect(data = dplyr::filter(data, level == </span><span><span leaf="">2</span></span><span leaf="">), </span><br><span leaf="">                    colour = </span><span><span leaf="">'white'</span></span><span leaf="">, radius = unit(</span><span><span leaf="">4</span></span><span leaf="">, </span><span><span leaf="">'pt'</span></span><span leaf="">),</span><br><span leaf="">                    show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_round_rect(data = dplyr::filter(data, level == </span><span><span leaf="">3</span></span><span leaf="">), </span><br><span leaf="">                    colour = </span><span><span leaf="">'white'</span></span><span leaf="">, radius = unit(</span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">'pt'</span></span><span leaf="">),</span><br><span leaf="">                    show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_text(aes(x = xmax, y = (ymin + ymax) / </span><span><span leaf="">2</span></span><span leaf="">, </span><br><span leaf="">                  label = cate), </span><br><span leaf="">              data = dplyr::filter(data, level == </span><span><span leaf="">3</span></span><span leaf="">),</span><br><span leaf="">              angle = ifelse(angle &lt; -</span><span><span leaf="">90</span></span><span leaf="">, angle + </span><span><span leaf="">180</span></span><span leaf="">, angle),</span><br><span leaf="">              hjust = ifelse(angle &lt; -</span><span><span leaf="">90</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">), </span><br><span leaf="">              size = </span><span><span leaf="">2</span></span><span leaf="">,</span><br><span leaf="">              inherit.aes = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    scale_fill_manual(values = structure(data$fill, names = data$cate)) +</span><br><span leaf="">    coord_polar(theta = </span><span><span leaf="">'y'</span></span><span leaf="">) +</span><br><span leaf="">    theme_no_axis</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100017704" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMpYf6EX3iaPNtvkjVnYXC8BibGic7jejIict6gRGCeks8OIUNtbHzWG9VFg/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMpYf6EX3iaPNtvkjVnYXC8BibGic7jejIict6gRGCeks8OIUNtbHzWG9VFg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">3. 突出类别</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">例如，我想凸显</span><code><span leaf="">Electronics</span></code><span leaf=""> 这一类，先获取该分类的数据</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">item &lt;- </span><span><span leaf="">'Electronics'</span></span><br><span leaf="">span &lt;- c(</span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">)</span><br><br><span leaf="">item.info &lt;- dplyr::filter(data, cate == item)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">数据处理，右侧数据为子类，需要上移和右移，而上方的数据只要上移两个间隔</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">move_x &lt;- dplyr::filter(data, xmin &gt;= item.info$xmin </span><br><span leaf="">                        &amp; ymin &gt;= item.info$ymin</span><br><span leaf="">                        &amp; ymax &lt;= item.info$ymax)</span><br><span leaf="">move_y &lt;- dplyr::filter(data, ymin &gt;= item.info$ymax)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">绘制图形</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: round-pop</span></span><br><br><span leaf="">move.data &lt;- data %&gt;%</span><br><span leaf="">    </span><span><span leaf=""># move right</span></span><br><span leaf="">    mutate(across(c(xmin, xmax),</span><br><span leaf="">                  ~ if_else(cate %</span><span><span leaf="">in</span></span><span leaf="">% move_x$cate, .x + span[</span><span><span leaf="">1</span></span><span leaf="">], .x))) %&gt;%</span><br><span leaf="">    </span><span><span leaf=""># move up</span></span><br><span leaf="">    mutate(across(c(ymin, ymax),</span><br><span leaf="">                  ~ if_else(cate %</span><span><span leaf="">in</span></span><span leaf="">% move_x$cate, .x + span[</span><span><span leaf="">2</span></span><span leaf="">], .x))) %&gt;%</span><br><span leaf="">    </span><span><span leaf=""># move twice</span></span><br><span leaf="">    mutate(across(c(ymin, ymax),</span><br><span leaf="">                  ~ if_else(cate %</span><span><span leaf="">in</span></span><span leaf="">% move_y$cate, .x + </span><span><span leaf="">2</span></span><span leaf=""> * span[</span><span><span leaf="">2</span></span><span leaf="">], .x)))</span><br><br><span leaf="">angle &lt;- dplyr::filter(move.data, level == </span><span><span leaf="">1</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    mutate(angle = </span><span><span leaf="">90</span></span><span leaf=""> - </span><span><span leaf="">360</span></span><span leaf=""> * (ymin + ymax) / </span><span><span leaf="">2</span></span><span leaf=""> / max(ymax)) %&gt;%</span><br><span leaf="">    pull(angle)</span><br><br><span leaf="">move.data %&gt;%</span><br><span leaf="">    ggplot(aes(xmin = xmin, xmax = xmax, </span><br><span leaf="">               ymin = ymin, ymax = ymax,</span><br><span leaf="">               fill = cate)) +</span><br><span leaf="">    geom_round_rect(aes(group = cate),</span><br><span leaf="">        colour = </span><span><span leaf="">'white'</span></span><span leaf="">, radius = unit(</span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">'pt'</span></span><span leaf="">),</span><br><span leaf="">        show.legend = </span><span><span leaf="">FALSE</span></span><br><span leaf="">    ) +</span><br><span leaf="">    geom_text(aes(x = c(xmin + xmax) / </span><span><span leaf="">2</span></span><span leaf="">, y = (ymin + ymax) / </span><span><span leaf="">2</span></span><span leaf="">, </span><br><span leaf="">                  label = cate), </span><br><span leaf="">              data = dplyr::filter(move.data, level == </span><span><span leaf="">1</span></span><span leaf="">),</span><br><span leaf="">              angle = ifelse(angle &lt; -</span><span><span leaf="">90</span></span><span leaf="">, angle + </span><span><span leaf="">180</span></span><span leaf="">, angle),</span><br><span leaf="">              hjust = </span><span><span leaf="">0.5</span></span><span leaf="">,</span><br><span leaf="">              size = </span><span><span leaf="">2</span></span><span leaf="">,</span><br><span leaf="">              inherit.aes = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    scale_fill_manual(values = structure(data$fill, names = data$cate)) +</span><br><span leaf="">    coord_polar(theta = </span><span><span leaf="">'y'</span></span><span leaf="">) +</span><br><span leaf="">    theme_no_axis</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100017712" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMDhYS46kcLDxITTEHNK0eVBR2TVqA3o5sCHtaic7uUiblLpMdUGeapXYg/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMDhYS46kcLDxITTEHNK0eVBR2TVqA3o5sCHtaic7uUiblLpMdUGeapXYg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">结尾</span></span><span></span></h2><hr><p data-tool="mdnice编辑器"><span leaf="">任何代码的问题都可以在知识星球中提问，自愿加入。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100017713" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMqSFDqZttDjgPV05d9skJBlK33qeM3icHsP1RQnUMic5blibTxkCk3veCA/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWKfv3Bef1Bf4sCaEDdz7DpMqSFDqZttDjgPV05d9skJBlK33qeM3icHsP1RQnUMic5blibTxkCk3veCA/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/KJ7jDqOfN_4Ew-mAScM5zw",target="_blank" rel="noopener noreferrer">原文链接</a>
