---
title: "百万细胞的Seurat对象依据第一层次降维聚类分群拆分成为子集"
date: 2024-12-29T02:20:17Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
百万细胞的Seurat对象依据第一层次降维聚类分群拆分成为子集 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>前面在<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527245&amp;idx=1&amp;sn=e520bd70a2a07d6cdb566930b8196013&amp;scene=21#wechat_redirect" data-linktype="2">百万细胞舍我其谁（一晚上解决战斗）</a> ，我们得到了张泽民老师的2024的文章：《Spatiotemporal single-cell analysis decodes cellular dynamics underlying different responses to immunotherapy in colorectal cancer》的百万单细胞数据集的第一层次降维聚类分群，并且保存完了r对象文件：</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>7.3G 12月 26 06:11 sce.all_int.rds<br></code></pre><p data-tool="mdnice编辑器">但其实完全没有必要，因为作者已经是给出来了每个单细胞的身份，<span><strong>我们为什么做降维聚类分群并且umap可视化，就是为了辅助我们给细胞一个身份。既然结果都给出来了，那么过程就不重要了。</strong></span>接下来就应该是每个单细胞亚群进行细致的探索。仍然是写一个r脚本，内容如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br>sce.all.int = readRDS(<span>'2-harmony/sce.all_int.rds'</span>)<br>sp=<span>'human'</span><br>tmp=sce.all.int@meta.data<br>colnames(sce.all.int@meta.data) <br>table(sce.all.int$RNA_snn_res.0.8) <br>Sys.time() <br>id = unique(sce.all.int$MajorCellType)<br>lapply(id, <span>function</span>(x){<br>  sce=sce.all.int[,sce.all.int$MajorCellType %<span>in</span>% x]<br>  sce.all=CreateSeuratObject(<br>    counts = sce@assays$RNA$counts,<br>    meta.data = sce@meta.data<br>  )<br>  save(sce.all,file = paste0(x,<span>'.sce.all.Rdata'</span>))<br>  Sys.time()<br>})<br></code></pre><p data-tool="mdnice编辑器">假如这个脚本文件名字是（tmp.R ）， 接下来就可以在shell里面提交它到后台运行：</p><pre data-tool="mdnice编辑器"><span></span><code>nohup Rscript tmp.R &amp; <br></code></pre><p data-tool="mdnice编辑器">这个Seurat对象本来就是接近100万个细胞，但是我进行了简单的质量控制，过滤后剩下90万左右，前面的降维聚类分群过程就省略了，参考在<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527245&amp;idx=1&amp;sn=e520bd70a2a07d6cdb566930b8196013&amp;scene=21#wechat_redirect" data-linktype="2">百万细胞舍我其谁（一晚上解决战斗）</a> ，现在我们直接看作者的结果 ：</p><pre data-tool="mdnice编辑器"><span></span><code>[1]  36027 975275<br>[1]  36027 895488<br><br>      B     Epi     ILC     Mye Stromal       T <br> 161935   96179   48537   68250   40433  480154 <br></code></pre><p data-tool="mdnice编辑器">可以看到，一多半是t细胞然后四分之一左右是b细胞，其它的都占比很少很少。</p><pre data-tool="mdnice编辑器"><span></span><code> 484M 12月 26 11:58 B.sce.all.Rdata<br> 296M 12月 26 11:47 Epi.sce.all.Rdata<br> 133M 12月 26 12:01 ILC.sce.all.Rdata<br> 236M 12月 26 12:00 Mye.sce.all.Rdata<br> 157M 12月 26 11:48 Stromal.sce.all.Rdata<br> 1.3G 12月 26 11:55 T.sce.all.Rdata<br></code></pre><p data-tool="mdnice编辑器">可以看到，因为t细胞数量最多，所以导出它这个子集耗时最长：</p><pre data-tool="mdnice编辑器"><span></span><code>[1] <span>"2024-12-26 11:48:34 CST"</span><br>[1] <span>"2024-12-26 11:55:43 CST"</span><br>[1] <span>"2024-12-26 11:58:40 CST"</span><br>[1] <span>"2024-12-26 12:00:11 CST"</span><br>[1] <span>"2024-12-26 12:01:11 CST"</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>接下来 同样的流程降维聚类分群</span><span></span></h3><p data-tool="mdnice编辑器">在<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527245&amp;idx=1&amp;sn=e520bd70a2a07d6cdb566930b8196013&amp;scene=21#wechat_redirect" data-linktype="2">百万细胞舍我其谁（一晚上解决战斗）</a> ，我们举例了，所有的r代码写完了，就提交到后台后等半天就ok了，全程都是代码自动化处理而已，不需要自己干啥子就可以拿到海量的结果！一切的难点，就在于不同的单细胞公共数据集的读取，只需要成为了r编程语言里面的Seurat对象，就可以全流程自动化处理~</p><p data-tool="mdnice编辑器">那么，我们这个时候把前面的百万单细胞转录组数据集拆分成为了 第一层次是6个大的亚群：six major cell types: T cells, B cells, innate lymphoid cells (ILCs), myeloid cells, stromal cells, and epithelial：</p><p data-tool="mdnice编辑器">每个具体的亚群，都可以是当做是一个独立的单细胞转录组项目，很简单的load进去就是一个r编程语言里面的Seurat对象，就可以全流程自动化处理~</p><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'../Stromal.sce.all.Rdata'</span>)<br><br>sce.all.int<span>$celltype</span>=sce.all.int<span>$SubCellType</span><br>table(sce.all.int<span>$celltype</span>)   <br>Sys.time()<br><br><span>if</span>(<span>"SubCellType"</span> %<span>in</span>% colnames(sce.all.int@meta.data ) ){<br>  <br>  sel.clust = <span>"SubCellType"</span><br>  sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>  table(sce.all.int@active.ident) <br>  <br>  dir.create(<span>'check-by-SubCellType'</span>)<br>  setwd(<span>'check-by-SubCellType'</span>)<br>  <span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>  setwd(<span>'../'</span>) <br>  getwd()<br>  phe=sce.all.int@meta.data<br>  save(phe,file = <span>'phe.Rdata'</span>)<br>  pdf(<span>'SubCellType-vs-orig.ident.pdf'</span>,width = 10)<br>  gplots::balloonplot(table(sce.all.int<span>$SubCellType</span>,sce.all.int<span>$orig</span>.ident))<br>  dev.off()<br>}<br><br>Sys.time()<br><br></code></pre><p data-tool="mdnice编辑器">上面的r代码是需要自己保证准确无误的，然后写入到文件：<code>step1-load-by-Seurat-v5.R</code>，接下来就可以nohup的在后台运行它啦~</p><p data-tool="mdnice编辑器">在我们的服务器的Linux的诊断运行：<code>nohup Rscript step1-load-by-Seurat-v5.R &amp;</code></p><p data-tool="mdnice编辑器">可以看到，stromal确实是非常复杂，但是张泽民课题组处理的非常好！平滑肌细胞（Smooth Muscle Cells, SMCs）和周细胞（Pericytes），这个混合的单细胞亚群可以被称为“混合间充质细胞群”（Mixed Mesenchymal Cell Cluster）或“血管相关间充质细胞群”（Vascular-Associated Mesenchymal Cell Cluster），具体命名取决于细胞的来源和所处的组织微环境。</p><p><img data-galleryid="" data-imgfileid="100043606" data-ratio="0.8310185185185185" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTraV3ibbRJpcgotVrzEI3hUaibGiaOxCibFm6zz70mibreqkzocucltnQEa7IRKuGGRRz44NpKfA5aUicQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1728" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTraV3ibbRJpcgotVrzEI3hUaibGiaOxCibFm6zz70mibreqkzocucltnQEa7IRKuGGRRz44NpKfA5aUicQ/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">这些知识点可以看：</p><ul data-tool="mdnice编辑器"><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533901&amp;idx=1&amp;sn=f75b502338c5deca78742215e4919140&amp;chksm=9b4b05f6ac3c8ce0bd823066c1e4acc4f79bc9439bb35377ecda8408f713ce5bace1eac824f9&amp;scene=21#wechat_redirect" data-linktype="2">bulk层面的癌症和癌旁的表达量差异主要是因为？</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533814&amp;idx=1&amp;sn=b80a8259229099658b7c19f77b929779&amp;chksm=9b4b044dac3c8d5bd35c957d9044afa6631857e1ed141f77af7a5bdc76ee0f1557762641ea16&amp;scene=21#wechat_redirect" data-linktype="2">癌症和癌旁的差异基因能在单细胞层面区分上皮细胞的恶性与否吗</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533802&amp;idx=1&amp;sn=2a013d09df7d62a25b2189272e4b4ef0&amp;chksm=9b4b0451ac3c8d473401141c6c98eef5783dbfb3ab5f811d9e4825855ee1369134becc22a485&amp;scene=21#wechat_redirect" data-linktype="2">算不上什么大错误的成纤维细胞亚群的细分操作</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533801&amp;idx=1&amp;sn=d7608e9688c1166a1dfb3194c4837596&amp;chksm=9b4b0452ac3c8d44737b518b80596ac9320157f41e327af5d22bfa936c8bba1b1248187b7dc3&amp;scene=21#wechat_redirect" data-linktype="2">单细胞亚群取子集后的细分亚群再命名的两个难题</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533792&amp;idx=1&amp;sn=6d775ed2fdfef1f0e522a003e3b82366&amp;chksm=9b4b045bac3c8d4d2d915dadf7db844d23de001234764a33b945ee86723db8e4d0f21178d9ad&amp;scene=21#wechat_redirect" data-linktype="2">是否需要抹除细胞周期对单细胞降维聚类分群的影响呢</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533695&amp;idx=1&amp;sn=0d9757a46ae14c0b0486430da35715c3&amp;chksm=9b4b04c4ac3c8dd258dddf5f6b87e13f313e88ec2af90b7824f16d31c34fb62d04a7f1764c53&amp;scene=21#wechat_redirect" data-linktype="2">每个单细胞亚群取子集后继续降维聚类分群标准操作（以b细胞为例）</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533646&amp;idx=1&amp;sn=856149a09714e5b38d4aa3b4a566a07f&amp;chksm=9b4b04f5ac3c8de3b9b3e736376ae9ffd81dc40bf790b64490b993bed62f7f3688cac52e199a&amp;scene=21#wechat_redirect" data-linktype="2">不是造假胜似造假的单细胞降维聚类分群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533597&amp;idx=1&amp;sn=81cd698d29598126a270422bfca43735&amp;chksm=9b4b04a6ac3c8db0927bc5b1336d2ee0bf9fa105ff5161eeaf20ce487d0c549fc7fb4eb0590c&amp;scene=21#wechat_redirect" data-linktype="2">到底是量化样品还是单细胞之间的相关性呢</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533595&amp;idx=1&amp;sn=87d9f3e71c78a803c356c30a6a4b6a89&amp;chksm=9b4b04a0ac3c8db6ce9fd508de88f0a238f22388bb049e39ee698bde21eaf0e565df79bb9ba8&amp;scene=21#wechat_redirect" data-linktype="2">有监督的挑选了特征之后的无监督的分析还可靠吗</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533529&amp;idx=1&amp;sn=6c050003bd24d8aa372bc42e515dbfe9&amp;chksm=9b4b0362ac3c8a74e241ce3880b5158393ae2afd816bbf59d4e38c7720809f1e7b9b8e3cce44&amp;scene=21#wechat_redirect" data-linktype="2">走inferCNV流程的时候只需要针对上皮细胞即可</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533528&amp;idx=1&amp;sn=c731c51a3478151b7eaa040b4ad19e44&amp;chksm=9b4b0363ac3c8a751f4636764e1a1c23fea8ff87a88692fb057605ff8f6beee7f7bb1cd49de3&amp;scene=21#wechat_redirect" data-linktype="2">上皮细胞里面混入了淋巴系和髓系免疫细胞呢</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533143&amp;idx=1&amp;sn=22df46273ed9fbc5dd70bcd4f7554eb8&amp;chksm=9b4b02ecac3c8bfa86c14cf30c011f74d6a4b75a1b63fcc406c1d96b63ff07150723fc070782&amp;scene=21#wechat_redirect" data-linktype="2">单细胞亚群绝对数量和相对比例的探索</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533121&amp;idx=1&amp;sn=e898d5d3df5da109ce55a7c5c7f7c02a&amp;chksm=9b4b02faac3c8becec76d63636dfa65a25e55831a8bdd201aee58a836898cd818f3c7044e275&amp;scene=21#wechat_redirect" data-linktype="2">为什么胃癌并不使用拷贝数来判断恶性的肿瘤上皮细胞呢</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533087&amp;idx=1&amp;sn=0397ea00da43ef1de3dc5119480b4692&amp;chksm=9b4b02a4ac3c8bb2087905de870e9282287b2740c818cffcae65ab1b937e2501945554a3ebb9&amp;scene=21#wechat_redirect" data-linktype="2">没有绝对正确的单细胞转录组质量控制指标</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533061&amp;idx=1&amp;sn=de67737df31c0302667d9c7a75214415&amp;chksm=9b4b02beac3c8ba808c045ae05000e1f5d0bd64968130f2087a5a4e093007e3941ccf6537120&amp;scene=21#wechat_redirect" data-linktype="2">学习单细胞亚群命名的层次结构</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533053&amp;idx=1&amp;sn=bd155638b280e875dcae14622198b65b&amp;chksm=9b4b0146ac3c8850fac064f7f71e7a3c26471405b60e70279add963b51df8ac40c2b4f689f60&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录组降维聚类分群过滤基因和过滤细胞的区别</a></section></li></ul></section><h3 data-tool="mdnice编辑器"><span>你距离cns文章就差一个服务器账号啦</span></h3><p data-tool="mdnice编辑器">还等什么呢， 赶快扫码吧！<img data-imgfileid="100043609" data-ratio="0.6342592592592593" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibhCMTjabt60WBibeNjHLE8nleT7KtEWqkPNF4f8ib3UBPeNXsLHc8A2WtbVABlg6pgz3FzMKtvW0dA/640?wx_fmt=other&amp;wxfrom=5&amp;tp=webp&amp;wx_lazy=1&amp;wx_co=1" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibhCMTjabt60WBibeNjHLE8nleT7KtEWqkPNF4f8ib3UBPeNXsLHc8A2WtbVABlg6pgz3FzMKtvW0dA/640?wx_fmt=other&amp;wxfrom=5&amp;tp=webp&amp;wx_lazy=1&amp;wx_co=1"></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/qEVpKGMHHNBKDOy5CDOJRg",target="_blank" rel="noopener noreferrer">原文链接</a>
