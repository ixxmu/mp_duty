---
title: "这个方法可以算的上单细胞高低分分水岭之一了！meta-program详解实战篇（上）"
date: 2024-12-23T13:01:53Z
draft: ["false"]
tags: [
  "fetched",
  "生信作曲家"
]
categories: ["Acdemic"]
---
这个方法可以算的上单细胞高低分分水岭之一了！meta-program详解实战篇（上） by 生信作曲家
------
<div><section><h3><span>前言</span></h3><blockquote><p><span><span>生信作曲家一直致力于构建国内<span><strong>和谐、开放、可持续</strong></span><strong>的生物信息交流平台</strong>。生信作曲家的目标是<strong>为每个科研人扫清科研路上的一切障碍，让生物信息学人人可做</strong>。目前，生信作曲家已推出<span><strong>"</strong><strong>跟着一区文章学通机器学习”、</strong><strong>"</strong><strong>跟着一区文章学通单细胞</strong><strong>"、"空间转录组从入门到精通”、孟德尔随机化实战”</strong><strong>、scFEA</strong><strong><strong>、</strong>NATMI、CIBERSORTx、hdWGCNA、cytotalk、metaVIPER算法</strong></span>等多种强力教程，同时也兼具数据整理、可视化等核心入门技术教学，开办<span><strong>空间转录组计划smrsp/sp、孟德尔随机化系列计划IM/MR）、临床数据库系列、肿瘤发文计划RS/max，非肿瘤发文计划note/ultra/pro</strong></span><strong>、暑期集训营和冬季集训营</strong>等多次。辅导同学实现纯生信SCI发表硕果累累，帮助同学实现医学事业路上的理想与追求。</span></span></p></blockquote><p>我们知道肿瘤细胞往往呈现出高度的异质性，同一癌症类型在不同遗传、表观遗传和微环境因素的影响下，不同患者（不同样本）所形成的细胞状态和治疗反应的差异。那么，既然是同一癌症类型，有没有什么方法能够发现不同患者之间肿瘤细胞的共性呢？</p><p>可以用“<strong>元</strong><strong>程序（Meta-program，MP）</strong>”的方法来分析肿瘤内异质性。</p><p>针对不同患者（不同样本）的问题。我们可以先单独分析出<strong>每个样本的细胞基因表达程序（program）</strong>，这一步往往采取的是样本矩阵NMF的方法。</p><p>接着再寻找样本间<strong>共识的program，从而获得meta-program</strong>。由此，我们就可以获得<strong>跨样本的肿瘤异质性分子亚型</strong>，从而获得良好地解决了异质性的问题。<br>这个算发的巧妙之处在于，先在样本内进行分析，再在样本间进行meta。<span><em><strong>从而有效避免了有些program仅仅存在于少数几个病人的情况，也避免了program过多的情况。<br></strong></em></span></p><p><span></span>你可以通过上一节基础知识来进行学习：</p><blockquote data-type="1" data-url="http://mp.weixin.qq.com/s?__biz=MzI5ODI0NzM2OQ==&amp;mid=2247490647&amp;idx=1&amp;sn=f0e8cd501d72af97d0f998b30e6b3ced&amp;chksm=eca9e9f1dbde60e7c1039d19d2b292e9a50d8302db3b2c86fa49d5dbcf3f5278faad40974632#rd" data-author-name="Bioinfo composer" data-content-utf8-length="3" data-source-title="这个方法可以算的上单细胞高低分分水岭之一了！解析元程序（meta-program）基础篇"><section><p>基础篇</p></section><section data-json="%7B%22type%22%3A%22inner%22%2C%22source%22%3A%22biz%22%2C%22digest%22%3A%22%3Cp%3E%E5%9F%BA%E7%A1%80%E7%AF%87%3C%2Fp%3E%22%2C%22digestLen%22%3A3%2C%22text%22%3A%22%22%2C%22article%22%3A%7B%22title%22%3A%22%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E5%8F%AF%E4%BB%A5%E7%AE%97%E7%9A%84%E4%B8%8A%E5%8D%95%E7%BB%86%E8%83%9E%E9%AB%98%E4%BD%8E%E5%88%86%E5%88%86%E6%B0%B4%E5%B2%AD%E4%B9%8B%E4%B8%80%E4%BA%86%EF%BC%81%E8%A7%A3%E6%9E%90%E5%85%83%E7%A8%8B%E5%BA%8F%EF%BC%88meta-program%EF%BC%89%E5%9F%BA%E7%A1%80%E7%AF%87%22%2C%22url%22%3A%22http%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI5ODI0NzM2OQ%3D%3D%26mid%3D2247490647%26idx%3D1%26sn%3Df0e8cd501d72af97d0f998b30e6b3ced%26chksm%3Deca9e9f1dbde60e7c1039d19d2b292e9a50d8302db3b2c86fa49d5dbcf3f5278faad40974632%23rd%22%2C%22nickname%22%3A%22%E7%94%9F%E4%BF%A1%E4%BD%9C%E6%9B%B2%E5%AE%B6%22%2C%22authorName%22%3A%22Bioinfo%20composer%22%7D%2C%22hasReportOverSize%22%3Afalse%2C%22editorReportData%22%3A%5B%7B%22id%22%3A%22122333%22%2C%22key%22%3A%2278%22%2C%22len%22%3A1%7D%5D%7D"><span>Bioinfo composer，公众号：生信作曲家<a href="http://mp.weixin.qq.com/s?__biz=MzI5ODI0NzM2OQ==&amp;mid=2247490647&amp;idx=1&amp;sn=f0e8cd501d72af97d0f998b30e6b3ced&amp;chksm=eca9e9f1dbde60e7c1039d19d2b292e9a50d8302db3b2c86fa49d5dbcf3f5278faad40974632#rd">这个方法可以算的上单细胞高低分分水岭之一了！解析元程序（meta-program）基础篇</a></span></section></blockquote><p>从第二个方面讲，meta-program的学习需求非常大：</p><p><img data-galleryid="" data-imgfileid="100007001" data-ratio="0.5416666666666666" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNqG5g5ZQjKt4NOb4JBTFKr4B6X7ic2AldhTeQ9L294bxtQq5MLkhSXQQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNqG5g5ZQjKt4NOb4JBTFKr4B6X7ic2AldhTeQ9L294bxtQq5MLkhSXQQ/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p>从第三个方面讲，利用geneNMF包做meta-program分析近些天也有了相关推送的讲解，有兴趣的同学可以免费学习。</p><p><br></p><p><img data-galleryid="" data-imgfileid="100007002" data-ratio="0.42407407407407405" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNtMF9mLZ4FXFaGn066b2Fh2P4iblcGSTOszFulR3jgv6SonxI9P1mG4A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNtMF9mLZ4FXFaGn066b2Fh2P4iblcGSTOszFulR3jgv6SonxI9P1mG4A/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p>从我们对于文章理解来看，meta-program的精髓不在于NMF（只是发现program的方法之一），<span><strong>而在于发现不同患者中的稳定模块（meta)，这是非常关键的。</strong></span>作为先行者的生信作曲家旨在帮助大家做一些<span><strong>非官方示例数据的自己数据测试及一些同学的报错指南。</strong></span><span>目的是帮助大家更加真正从实战上学透geneNMF。<br></span></p><p><br></p><br><h3><span>代码实操</span></h3><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"></h3><ul></ul></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code><span>## install.packages("GeneNMF") ## 需要4.3.0以上R版本哦！</span><br><span>library</span>(GeneNMF)<br><br>rm(list=ls())<br><br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(patchwork)<br><span>library</span>(Matrix)<br><span>library</span>(RcppML)<br><span>library</span>(viridis)<br><span>library</span>(msigdbr)<br><span>library</span>(fgsea)<br><span>library</span>(readr)<br><br><br><span>###数据准备###</span><br><br><span>###数据准备###</span><br>scRNA &lt;- readRDS(<span>"scRNA.RDS"</span>) <span>#单细胞数据</span><br><span># 提取肿瘤上皮</span><br>scRNA_epi=subset(scRNA,celltype==<span>'Epithelial'</span>)<br>scRNA_epi=subset(scRNA_epi,tissue_type !=<span>'Normal'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100007007" data-ratio="0.5814814814814815" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XN9Qe1FCduZicmoW8d7BhyxLdumzldFqV7wV4CV9y7Mm0oclh4BojlsXg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XN9Qe1FCduZicmoW8d7BhyxLdumzldFqV7wV4CV9y7Mm0oclh4BojlsXg/640?wx_fmt=png&amp;from=appmsg"><br></figure><p><img data-galleryid="" data-imgfileid="100007024" data-ratio="0.43154246100519933" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNPVWqSSo12w4oNKxFoP3opTXCebicOSOx9aC0Cb7hDI0vlWRX9jHaicVA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="577" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNPVWqSSo12w4oNKxFoP3opTXCebicOSOx9aC0Cb7hDI0vlWRX9jHaicVA/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p data-tool="mdnice编辑器">针对seurat包 v5：有些同学的geneNMF会不兼容v5 seurat。这里使用JoinLayers函数合并分层，一行代码解决对象读取的问题（https://github.com/satijalab/seurat/discussions/8074）</p><pre data-tool="mdnice编辑器"><span></span><code>packageVersion(<span>"Seurat"</span>) <span>#查看seurat包的版本</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100007003" data-ratio="0.15775034293552812" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNnWZtEMOlcYwakiccUzwfx8yHdT0W3pnQaB9qSwHqciaVazKzFKDsrCYQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="729" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNnWZtEMOlcYwakiccUzwfx8yHdT0W3pnQaB9qSwHqciaVazKzFKDsrCYQ/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>## 如果是V4则下面三行代码不运行！！!!</span><br>Layers(scRNA_epi, assay = <span>"RNA"</span>) <span>#合并前各个样本是分开的</span><br>scRNA_epi &lt;-  JoinLayers(scRNA_epi) <br>Layers(scRNA_epi, assay = <span>"RNA"</span>) <span>#合并后便解决了后面assay、slot的读取问题</span><br></code></pre><p data-tool="mdnice编辑器">正式运行</p><pre data-tool="mdnice编辑器"><span></span><code><span>###分开样本</span><br>seu.list &lt;- SplitObject(scRNA_epi, split.by = <span>"orig.ident"</span>) <span>#先按照样本分开，我们有6个肿瘤组织</span><br>do.call(rbind,lapply(seu.list, dim)) <span>#查看每个样本的基因数和细胞数</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100007004" data-ratio="0.03878902554399243" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNxc2zU33Ghic5jjicZXgzvKvwuEAeZHopEcnyXNP5HgYNibwVcFvrtAd3Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1057" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNxc2zU33Ghic5jjicZXgzvKvwuEAeZHopEcnyXNP5HgYNibwVcFvrtAd3Q/640?wx_fmt=png&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100007005" data-ratio="0.2998976458546571" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNJGv15CILBpWib8ZGGjQGyEYchMN5p0UNDrzOb4lkWP3Lpmnran3ktiag/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="977" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNJGv15CILBpWib8ZGGjQGyEYchMN5p0UNDrzOb4lkWP3Lpmnran3ktiag/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 接下来对每个样本分别找program</span><br><br><br><span>#multimf()函数自动对样本列表和多个k值执行NMF</span><br><span>## 无参数版本（根据自己需要选用）</span><br>geneNMF.programs &lt;- multiNMF(seu.list, k=<span>4</span>:<span>9</span>)<br><br><span>## 少量参数（本次我选用这个）</span><br>geneNMF.programs &lt;- multiNMF(seu.list, assay=<span>"RNA"</span>, k=<span>4</span>:<span>9</span>, min.exp = <span>0.05</span>,seed=<span>123</span>)<br><br><br><span>##有多个参数版本（根据自己需要选用以获得最佳的分群）</span><br><br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100007006" data-ratio="0.4444444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNWVV0qXAWyU4IIjjMzLg2e6AN28K1883OG6AEgD4Xz4oJlda60QQMwA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaCUWcNK9BCPI7oAKgibuz1XNWVV0qXAWyU4IIjjMzLg2e6AN28K1883OG6AEgD4Xz4oJlda60QQMwA/640?wx_fmt=png&amp;from=appmsg">购买后可添加管理员获取示例数据和完整代码<br></figure><p><img data-galleryid="" data-imgfileid="100001321" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/mo60jlFOtaBGpGicRlf1uIRz5z4icMGickywJW7jQIkU4lafb2SfXxTwtD6ia0Twl7EePYmgFGpYULxQ1Ym9GVbKibw/640?wx_fmt=jpeg" data-type="jpeg" data-w="512" src="https://mmbiz.qpic.cn/mmbiz_jpg/mo60jlFOtaBGpGicRlf1uIRz5z4icMGickywJW7jQIkU4lafb2SfXxTwtD6ia0Twl7EePYmgFGpYULxQ1Ym9GVbKibw/640?wx_fmt=jpeg"></p><p><mp-pay-preview-filter data-offset="36"></mp-pay-preview-filter></p></section></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/8mw0C5SZJOVDIr95yh8gDg",target="_blank" rel="noopener noreferrer">原文链接</a>
