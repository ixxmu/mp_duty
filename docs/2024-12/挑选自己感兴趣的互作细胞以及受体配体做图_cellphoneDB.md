---
title: "挑选自己感兴趣的互作细胞以及受体配体做图：cellphoneDB"
date: 2024-12-07T16:31:05Z
draft: ["false"]
tags: [
  "fetched",
  "东林的扯淡小屋"
]
categories: ["Acdemic"]
---
挑选自己感兴趣的互作细胞以及受体配体做图：cellphoneDB by 东林的扯淡小屋
------
<div><section><section><ul><li><li><li><li><li></ul><pre data-lang="php"><code><span>Sys.setenv(LANGUAGE = <span>"en"</span>) <span>#显示英文报错信息</span></span></code><code><span>gc()</span></code><code><span>memory.limit(<span>9999999999</span>)</span></code><code><span>set.seed(<span>123</span>)</span></code><code><span>rm(<span>list</span> = ls())  </span></code><code><span>options(stringsAsFactors = F)</span></code><code><span>library(Seurat)</span></code><code><span>library(tidyverse)</span></code><code><span>library(patchwork)</span></code><code><span>library(SCENIC)</span></code><code><span>library(plyr)</span></code><code><span>library(permute)</span></code><code><span>library(data.table)</span></code><code><span>library(SCopeLoomR)</span></code><code><span>setwd(<span>"D:/analysis/bone_marrow_niche"</span>)</span></code><code><span><br></span></code><code><span>load(<span>"NicheData10x.rda"</span>)</span></code><code><span>YDL&lt;-NicheData10x</span></code><code><span><br></span></code><code><span>YDL[[<span>"celltype"</span>]]&lt;-YDL@active.ident</span></code><code><span>YDL[[<span>"orig.ident"</span>]]&lt;-YDL@meta.data$metadata....experiment..</span></code><code><span><br></span></code><code><span><br></span></code><code><span>pdf(file=<span>"TSNE_BM.pdf"</span>,width=<span>6.5</span>,height=<span>6</span>)</span></code><code><span>TSNEPlot(object = YDL, pt.size = <span>2</span>, label = <span>TRUE</span>)    <span>#TSNE可视化</span></span></code><code><span><br></span></code><code><span><span>#另一个可视化的方法</span></span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label = <span>TRUE</span>,pt.size = <span>1.5</span>)</span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label = <span>TRUE</span>,pt.size = <span>1.5</span>,split.by = <span>"metadata....experiment.."</span>)</span></code><code><span>dev.off()</span></code><code><span>write.table(YDL$seurat_clusters,file=<span>"tsneCluster_BM.txt"</span>,quote=F,sep=<span>"\t"</span>,col.names=F)</span></code><code><span><br></span></code><code><span><span>#这里采用基于图论的聚类方法</span></span></code><code><span>YDL &lt;- RunUMAP(object = YDL, dims = <span>1</span>:<span>20</span>)    </span></code><code><span>pdf(file=<span>"umap__BM.pdf"</span>,width=<span>6.5</span>,height=<span>6</span>)</span></code><code><span>UMAPPlot(object = YDL, pt.size = <span>1.5</span>, label = <span>TRUE</span>)    <span>#umap可视化</span></span></code><code><span><span>#另一个可视化的方法</span></span></code><code><span>DimPlot(object=YDL,label = <span>TRUE</span>,reduction=<span>"umap"</span>)</span></code><code><span><span>##用DimPlot()函数绘制散点图,reduction = "tsne",指定绘制类型；如果不指定,默认先从搜索 umap,然后 tsne, 再然后 pca；也可以直接使用这3个函数PCAPlot()、TSNEPlot()、UMAPPlot()； cols,pt.size分别调整分组颜色和点的大小；</span></span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span><span>##细胞周期归类</span></span></code><code><span><br></span></code><code><span>YDL&lt;- CellCycleScoring(object = YDL, g2m.features = cc.genes$g2m.genes, s.features = cc.genes$s.genes)</span></code><code><span><br></span></code><code><span>head(x = YDL@meta.data)</span></code><code><span>pdf(file=<span>"CellCycle_BM.pdf"</span>,width=<span>6.5</span>,height=<span>6</span>)</span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label =<span>TRUE</span>,group.by=<span>"Phase"</span>,pt.size = <span>1.5</span>)</span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label = <span>TRUE</span>,group.by=<span>"Phase"</span>,pt.size = <span>1.5</span>,split.by = <span>"metadata....experiment.."</span>)</span></code><code><span>DimPlot(YDL,reduction = <span>"umap"</span>,label = <span>TRUE</span>,group.by=<span>"Phase"</span>,pt.size = <span>1.5</span>)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>nonpro2&lt;-readRDS(<span>"D:/analysis/forpublication/summary/nonpro1_own_nonpro2/nonpro1_nonpro2_SINGLET.RDS"</span>)</span></code><code><span><br></span></code><code><span>current.cluster.ids &lt;- c(<span>0</span>, <span>1</span>, <span>2</span>, <span>3</span>, <span>4</span>, <span>5</span>,<span>6</span>)</span></code><code><span><span>new</span>.cluster.ids &lt;- c(</span></code><code><span>  <span>"BasoE2"</span>,</span></code><code><span>  <span>"Ery/Mono"</span>,</span></code><code><span>  <span>"BasoE1"</span>,</span></code><code><span>  <span>"Ery/B"</span>,</span></code><code><span>  <span>"CD44hiOrthoE1"</span>,</span></code><code><span>  <span>"CD44hiOrthoE2"</span>,<span>"ProE"</span>)</span></code><code><span>names(<span>new</span>.cluster.ids) &lt;- levels(nonpro2)</span></code><code><span>nonpro2 &lt;- RenameIdents(nonpro2, <span>new</span>.cluster.ids)</span></code><code><span>DimPlot(nonpro2, reduction = <span>"tsne"</span>, label = <span>TRUE</span>, pt.size = <span>1.5</span>)</span></code><code><span>DimPlot(nonpro2, reduction = <span>"umap"</span>, label = <span>TRUE</span>, pt.size = <span>1.5</span>)</span></code><code><span><br></span></code><code><span>nonpro2$celltype&lt;-Idents(nonpro2)</span></code><code><span>nonpro2$celltype&lt;-factor(nonpro2$celltype,levels = c(<span>"ProE"</span>,<span>"BasoE1"</span>,<span>"BasoE2"</span>,<span>"CD44hiOrthoE1"</span>,<span>"CD44hiOrthoE2"</span>,<span>"Ery/B"</span>,<span>"Ery/Mono"</span>))</span></code><code><span>Idents(nonpro2)&lt;-nonpro2$celltype</span></code><code><span><br></span></code><code><span>cols = c(<span>"#FB61D7"</span>,<span>"#53B400"</span>,<span>"#F8766D"</span>,<span>"#00B6EB"</span>,<span>"#A58AFF"</span>,<span>"#C49A00"</span>,<span>"#00C094"</span>)</span></code><code><span>DimPlot(nonpro2, reduction = <span>"umap"</span>, label = <span>TRUE</span>, pt.size = <span>1.5</span>,cols = c(<span>"#FB61D7"</span>,<span>"#53B400"</span>,<span>"#F8766D"</span>,<span>"#00B6EB"</span>,<span>"#A58AFF"</span>,<span>"#00C094"</span>,<span>"#C49A00"</span>))</span></code><code><span>DimPlot(nonpro2, reduction = <span>"umap"</span>, label = F, pt.size = <span>1.5</span>,cols = c(<span>"#FB61D7"</span>,<span>"#53B400"</span>,<span>"#F8766D"</span>,<span>"#00B6EB"</span>,<span>"#A58AFF"</span>,<span>"#00C094"</span>,<span>"#C49A00"</span>))</span></code><code><span>DimPlot(nonpro2, reduction = <span>"umap"</span>, label = <span>TRUE</span>, pt.size = <span>1.5</span>,cols = c(<span>"#FB61D7"</span>,<span>"#53B400"</span>,<span>"#F8766D"</span>,<span>"#00B6EB"</span>,<span>"#A58AFF"</span>,<span>"#00C094"</span>,<span>"#C49A00"</span>),split.by = <span>"orig.ident"</span>)</span></code><code><span>DimPlot(nonpro2, reduction = <span>"umap"</span>, label = F, pt.size = <span>1.5</span>,cols = c(<span>"#FB61D7"</span>,<span>"#53B400"</span>,<span>"#F8766D"</span>,<span>"#00B6EB"</span>,<span>"#A58AFF"</span>,<span>"#00C094"</span>,<span>"#C49A00"</span>),split.by = <span>"orig.ident"</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span>FeaturePlot(object = nonpro2, reduction = <span>"umap"</span>,pt.size = <span>1.5</span>,features = c(<span>"Tlr4"</span>),cols = c(<span>"gray"</span>, <span>"red"</span>),order = T)<span>#actin</span></span></code><code><span><br></span></code><code><span>FeaturePlot(object = nonpro2, reduction = <span>"umap"</span>,pt.size = <span>1.5</span>,features = c(<span>"S100a8"</span>),cols = c(<span>"gray"</span>, <span>"red"</span>),order = F)<span>#actin</span></span></code><code><span><br></span></code><code><span>nonpro2 &lt;- FindClusters(object = nonpro2, resolution = <span>0.3</span>)                  <span>#对细胞分组,优化标准模块化</span></span></code><code><span><span>##使用Idents（）函数可查看不同细胞的分群；</span></span></code><code><span>head(Idents(nonpro2), <span>5</span>)</span></code><code><span>nonpro2 &lt;- subset(nonpro2 ,idents = c(<span>"10"</span>))</span></code><code><span>nonpro2$celltype&lt;-c(<span>"S100A8_nonpro"</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>YDL&lt;-merge(YDL,nonpro2)</span></code><code><span><br></span></code><code><span><span>#对数据进行标准化</span></span></code><code><span><span>##表达量数据标准化,LogNormalize的算法：A = log( 1 + ( UMIA ÷ UMITotal ) × 10000</span></span></code><code><span>YDL &lt;- NormalizeData(object = YDL, normalization.method = <span>"LogNormalize"</span>, scale.factor = <span>10000</span>)</span></code><code><span><span>#提取那些在细胞间变异系数较大的基因</span></span></code><code><span><span>##鉴定表达高变基因(2000个）,用于下游分析,如PCA；</span></span></code><code><span>YDL &lt;- FindVariableFeatures(object = YDL, selection.method = <span>"vst"</span>, nfeatures = <span>2000</span>)</span></code><code><span>YDL &lt;- ScaleData(object = YDL, features = rownames(YDL))</span></code><code><span><span>#线性降维（PCA）,默认用高变基因集,但也可通过features参数自己指定；</span></span></code><code><span>YDL=RunPCA(object= YDL,npcs = <span>20</span>,pc.genes=VariableFeatures(object = YDL))     <span>#PCA分析</span></span></code><code><span>ElbowPlot(YDL)<span>#选择top20个PC</span></span></code><code><span>pcSelect=<span>20</span></span></code><code><span>YDL &lt;- FindNeighbors(object = YDL, dims = <span>1</span>:pcSelect)                <span>#计算邻接距离</span></span></code><code><span><span>##接着优化模型,resolution参数决定下游聚类分析得到的分群数,对于3K左右的细胞,设为0.4-1.2 能得到较好的结果(官方说明)；如果数据量增大,该参数也应该适当增大。</span></span></code><code><span>YDL &lt;- FindClusters(object = YDL, resolution = <span>0.3</span>)                  <span>#对细胞分组,优化标准模块化</span></span></code><code><span><span>##使用Idents（）函数可查看不同细胞的分群；</span></span></code><code><span>head(Idents(YDL), <span>5</span>)</span></code><code><span><br></span></code><code><span><span>##Seurat提供了几种非线性降维的方法进行数据可视化（在低维空间把相似的细胞聚在一起）,比如UMAP和t-SNE,运行UMAP需要先安装'umap-learn'包，这里不做介绍，两种方法都可以使用，但不要混用，如果混用，后面的结算结果会将先前的聚类覆盖掉，只能保留一个。</span></span></code><code><span><br></span></code><code><span><span>##这里采用基于TSNE的聚类方法。</span></span></code><code><span>YDL &lt;- RunTSNE(object = YDL, dims = <span>1</span>:pcSelect,check_duplicates = <span>FALSE</span>)                      <span>#TSNE聚类</span></span></code><code><span>pdf(file=<span>"TSNE_nonpro2_merge.pdf"</span>,width=<span>6.5</span>,height=<span>6</span>)</span></code><code><span>TSNEPlot(object = YDL, pt.size = <span>2</span>, label = <span>TRUE</span>)    <span>#TSNE可视化</span></span></code><code><span><br></span></code><code><span><span>#另一个可视化的方法</span></span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label = <span>TRUE</span>,pt.size = <span>1.5</span>)</span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label = <span>TRUE</span>,pt.size = <span>1.5</span>,split.by = <span>"orig.ident"</span>)</span></code><code><span>dev.off()</span></code><code><span>write.table(YDL$seurat_clusters,file=<span>"tsneCluster_nonpro2_merge.txt"</span>,quote=F,sep=<span>"\t"</span>,col.names=F)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>##这里采用基于umap的聚类方法</span></span></code><code><span><span>#这里采用基于图论的聚类方法</span></span></code><code><span>YDL &lt;- RunUMAP(object = YDL, dims = <span>1</span>:pcSelect)                      <span>#umap聚类</span></span></code><code><span>pdf(file=<span>"umap__nonpro2_merge.pdf"</span>,width=<span>6.5</span>,height=<span>6</span>)</span></code><code><span>UMAPPlot(object = YDL, pt.size = <span>1.5</span>, label = <span>TRUE</span>)    <span>#umap可视化</span></span></code><code><span><span>#另一个可视化的方法</span></span></code><code><span>DimPlot(object=YDL,label = <span>TRUE</span>,reduction=<span>"umap"</span>)</span></code><code><span><span>##用DimPlot()函数绘制散点图,reduction = "tsne",指定绘制类型；如果不指定,默认先从搜索 umap,然后 tsne, 再然后 pca；也可以直接使用这3个函数PCAPlot()、TSNEPlot()、UMAPPlot()； cols,pt.size分别调整分组颜色和点的大小；</span></span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span><span>##细胞周期归类</span></span></code><code><span><br></span></code><code><span>YDL&lt;- CellCycleScoring(object = YDL, g2m.features = cc.genes$g2m.genes, s.features = cc.genes$s.genes)</span></code><code><span><br></span></code><code><span>head(x = YDL@meta.data)</span></code><code><span>pdf(file=<span>"CellCycle_nonpro2_merge.pdf"</span>,width=<span>6.5</span>,height=<span>6</span>)</span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label =<span>TRUE</span>,group.by=<span>"Phase"</span>,pt.size = <span>1.5</span>)</span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label = <span>TRUE</span>,group.by=<span>"Phase"</span>,pt.size = <span>1.5</span>,split.by = <span>"orig.ident"</span>)</span></code><code><span>DimPlot(YDL,reduction = <span>"umap"</span>,label = <span>TRUE</span>,group.by=<span>"Phase"</span>,pt.size = <span>1.5</span>)</span></code><code><span>dev.off()</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>library(rSuperCT)</span></code><code><span>library(ggplot2)</span></code><code><span>pred_obj &lt;- ImportData(YDL)</span></code><code><span>dir.create(<span>'./models'</span>, showWarnings = <span>FALSE</span>)</span></code><code><span>pred_obj &lt;- PredCellTypes(pred_obj, species = <span>'mouse'</span>, model = <span>'generic_38celltypes'</span>,results.dir = <span>'./models'</span>)</span></code><code><span>table(pred_obj@meta.data$pred_types)<span># 举例来展示不同细胞的比例</span></span></code><code><span>g &lt;- plotHist(pred_obj) + scale_fill_manual(values = rep(<span>'blue'</span>, <span>22</span>))</span></code><code><span>write.csv(g$data, <span>'pred_types.hist.csv'</span>,row.names = F)</span></code><code><span><span>#选择特定类型的细胞</span></span></code><code><span>Idents(YDL) &lt;- pred_obj@meta.data$pred_types</span></code><code><span><span>#YDL &lt;- subset(YDL, idents = 'Redblood')</span></span></code><code><span><span>#save(YDL, file = 'YDL.Redblood.Rdata')</span></span></code><code><span>Idents(YDL) &lt;- YDL@meta.data$seurat_clusters</span></code><code><span><span>#另一个可视化的方法</span></span></code><code><span>DimPlot(YDL,reduction = <span>"tsne"</span>,label = <span>TRUE</span>,pt.size = <span>1.5</span>)</span></code><code><span>saveRDS(YDL,<span>"BM_predicted.rds"</span>)</span></code><code><span><br></span></code><code><span><span>#重命名</span></span></code><code><span><span>#更改cluster的名字（确定细胞类型的前提下）</span></span></code><code><span>current.cluster.ids &lt;- c(<span>0</span>, <span>1</span>, <span>2</span>, <span>3</span>, <span>4</span>, <span>5</span>, <span>6</span>, <span>7</span>,<span>8</span>,<span>9</span>,<span>10</span>,<span>11</span>,<span>12</span>,<span>14</span>,<span>14</span>)</span></code><code><span><span>new</span>.cluster.ids &lt;- c(<span>"CD4 T cells"</span>, <span>"CD14+ Monocytes"</span>, <span>"B cells"</span>, <span>"CD8 T cells"</span>, <span>"FCGR3A+ Monocytes"</span>, <span>"NK cells"</span>, <span>"Dendritic cells"</span>, <span>"Megakaryocytes"</span>)</span></code><code><span>YDL@ident &lt;- plyr::mapvalues(x = YDL@ident, from = current.cluster.ids, to = <span>new</span>.cluster.ids)</span></code><code><span>TSNEPlot(object = YDL,pt.size = <span>0.5</span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>library(Seurat)</span></code><code><span>library(tidyverse)</span></code><code><span>library(Hmisc)</span></code><code><span><br></span></code><code><span>YDL_counts &lt;- <span>as</span>.matrix(YDL@assays$RNA@data)</span></code><code><span>YDL_counts &lt;- data.frame(gene=toupper(rownames(YDL_counts)), YDL_counts)</span></code><code><span>YDL_meta &lt;- data.frame(Cell=rownames(YDL@meta.data), cell_type=YDL@meta.data$celltype)</span></code><code><span><span>#write.table(YDL_counts, "test_counts.txt", row.names=F, sep='\t')</span></span></code><code><span>write.table(YDL_meta, <span>"test_meta.txt"</span>, row.names=F, sep=<span>'\t'</span>, quote=F)</span></code><code><span><br></span></code><code><span>a&lt;-colnames(YDL_counts)[<span>2</span>:<span>7827</span>]</span></code><code><span>b&lt;-YDL_meta$Cell</span></code><code><span>c&lt;-cbind(a,b)</span></code><code><span>YDL_meta$Cell&lt;-a</span></code><code><span>head(YDL_meta)</span></code><code><span>head(YDL_counts[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>])</span></code><code><span><span>#需要将test_meta.txt的.改为-。</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#nonpro1和nonpro2的差异表达基因的小提琴图展示，考虑表达值，重点是炎性细胞群。</span></span></code><code><span><span>#nonpro1的免疫热图也做</span></span></code><code><span><br></span></code><code><span>cd /data2/yudonglin/liuxuehui/s100a8相互作用</span></code><code><span><br></span></code><code><span>cd /data/yudonglin/lvxiang/liuxuehui</span></code><code><span><span>#conda create -n cpdb python=3.7</span></span></code><code><span>source activate cpdb</span></code><code><span>conda activate /home/yudonglin/miniconda3/envs/cpdb</span></code><code><span><span>#pip install cellphonedb</span></span></code><code><span>cellphonedb method statistical_analysis test_meta.txt test_counts.txt --threads <span>40</span> --counts-data=gene_name</span></code><code><span><br></span></code><code><span>cellphonedb plot dot_plot</span></code><code><span>cellphonedb plot heatmap_plot test_meta.txt</span></code><code><span><br></span></code><code><span><br></span></code><code><span>CCC &lt;- <span><span>function</span><span>(</span></span></span></code><code><span>  pfile, #pvalues.txt文件路径</span></code><code><span>  mfile, #means.txt文件路径</span></code><code><span>  neg_log10_th= -log10<span>(<span>0.05</span>)</span>, #前面画第一张图的时候用的什么值当作显著性阈值，这里保持一致</span></code><code><span>  means_exp_log2_th=<span>1</span>, #表达均值也限制一下</span></code><code><span>  notused.cell=NULL, #确定不包含的细胞，默认是空值</span></code><code><span>  used.cell=NULL, #必须含有的细胞，默认是空值</span></code><code><span>  neg_log10_th2=<span>3</span>, #限定显著性的最大值</span></code><code><span>  means_exp_log2_th2=c<span>(<span>-4</span>,<span>6</span>)</span>, #限定表达值的范围</span></code><code><span>  cell.pair=NULL, #这里是自定义的顺序，若是可选细胞对的子集，则只展示子集，若有交集则只展示交集；空值情况下，会根据可选细胞对自动排序</span></code><code><span>  gene.pair=NULL #作用同上</span></code><code><span><span>)</span>{</span></code><code><span>  <span>#####################################################################################################</span></span></code><code><span>  <span>#整个函数的逻辑是先根据一组阈值筛选合适的geneA_geneB_cellA_cellB关系，                              #</span></span></code><code><span>  <span>#随后根据候选的geneA_geneB、cellA_cellB提取原始矩阵，进行展示，                                     #</span></span></code><code><span>  <span>#举个例子，若geneA_geneB_cellA_cellB关系共有7个，占据了3个geneA_geneB pair，4个cellA_cellB pair。   #</span></span></code><code><span>  <span>#最终的图形会展示3乘4=12个点，这其中只有7个是满足p值、表达值要求的。                                #</span></span></code><code><span>  <span>#                                                                                                   #</span></span></code><code><span>  <span>#                                                                 作者：黄思源                      #</span></span></code><code><span>  <span>#                                                                 邮箱：huangsiyuan@pku.edu.cn      #</span></span></code><code><span>  <span>#####################################################################################################</span></span></code><code><span>  library(tidyverse)</span></code><code><span>  library(RColorBrewer)</span></code><code><span>  library(scales)</span></code><code><span>  library(reshape2)</span></code><code><span>  </span></code><code><span>  <span>#-----------------------------------------------------------</span></span></code><code><span>  pvalues=read.table(pfile,header = T,sep = <span>"\t"</span>,stringsAsFactors = F)</span></code><code><span>  pvalues=pvalues[,c(<span>2</span>,<span>12</span>:dim(pvalues)[<span>2</span>])]</span></code><code><span>  RMpairs=names(sort(table(pvalues$interacting_pair))[sort(table(pvalues$interacting_pair)) &gt; <span>1</span>])</span></code><code><span>  pvalues=pvalues[!(pvalues$interacting_pair %in% RMpairs),]</span></code><code><span>  pvalues.df1=melt(pvalues,id=<span>"interacting_pair"</span>)</span></code><code><span>  colnames(pvalues.df1)=c(<span>"geneA_geneB"</span>,<span>"cellA_cellB"</span>,<span>"pvalue"</span>)</span></code><code><span>  pvalues.df1$neg_log10=-log10(pvalues.df1$pvalue)</span></code><code><span>  pvalues.df1$geneA_geneB_cellA_cellB=paste(pvalues.df1$geneA_geneB,pvalues.df1$cellA_cellB,sep = <span>","</span>)</span></code><code><span>  </span></code><code><span>  means=read.table(mfile,header = T,sep = <span>"\t"</span>,stringsAsFactors = F)</span></code><code><span>  means=means[,c(<span>2</span>,<span>12</span>:dim(means)[<span>2</span>])]</span></code><code><span>  rmpairs=names(sort(table(means$interacting_pair))[sort(table(means$interacting_pair)) &gt; <span>1</span>])</span></code><code><span>  means=means[!(means$interacting_pair %in% rmpairs),]</span></code><code><span>  means.df1=melt(means,id=<span>"interacting_pair"</span>)</span></code><code><span>  colnames(means.df1)=c(<span>"geneA_geneB"</span>,<span>"cellA_cellB"</span>,<span>"means_exp"</span>)</span></code><code><span>  means.df1$geneA_geneB_cellA_cellB=paste(means.df1$geneA_geneB,means.df1$cellA_cellB,sep = <span>","</span>)</span></code><code><span>  means.df1=means.df1[,c(<span>"geneA_geneB_cellA_cellB"</span>,<span>"means_exp"</span>)]</span></code><code><span>  </span></code><code><span>  raw.df=merge(pvalues.df1,means.df1,by=<span>"geneA_geneB_cellA_cellB"</span>)</span></code><code><span>  raw.df$means_exp_log2=log2(raw.df$means_exp)</span></code><code><span>  </span></code><code><span>  <span>#-----------------------------------------------------------</span></span></code><code><span>  <span>#根据第一组阈值筛选</span></span></code><code><span>  <span>final</span>.df=raw.df%&gt;%filter(neg_log10 &gt; neg_log10_th &amp; means_exp_log2 &gt; means_exp_log2_th)</span></code><code><span>  </span></code><code><span>  <span>final</span>.df$geneA=str_replace(<span>final</span>.df$geneA_geneB,<span>"_.*$"</span>,<span>""</span>) <span>#此处的geneA geneB有不妥之处，</span></span></code><code><span>  <span>final</span>.df$geneB=str_replace(<span>final</span>.df$geneA_geneB,<span>"^.*_"</span>,<span>""</span>) <span>#没有考虑到complex的命名规则</span></span></code><code><span>  <span>final</span>.df$cellA=str_replace(<span>final</span>.df$cellA_cellB,<span>"\\..*$"</span>,<span>""</span>) <span>#后面尽量不用</span></span></code><code><span>  <span>final</span>.df$cellB=str_replace(<span>final</span>.df$cellA_cellB,<span>"^.*\\."</span>,<span>""</span>)</span></code><code><span>  </span></code><code><span>  <span>#-----------------------------------------------------------</span></span></code><code><span>  <span>#根据其它规则过滤</span></span></code><code><span>  <span>#有明确不呈现在图中的细胞，过滤如下</span></span></code><code><span>  <span>if</span> (!is.<span>null</span>(notused.cell)) {</span></code><code><span>    <span>final</span>.df=<span>final</span>.df[!(<span>final</span>.df$cellA %in% notused.cell),]</span></code><code><span>    <span>final</span>.df=<span>final</span>.df[!(<span>final</span>.df$cellB %in% notused.cell),]</span></code><code><span>  }</span></code><code><span>  <span>#两种细胞相同的话一般不展示</span></span></code><code><span>  <span>final</span>.df=<span>final</span>.df[!(<span>final</span>.df$cellA==<span>final</span>.df$cellB),]</span></code><code><span>  </span></code><code><span>  <span>#-----------------------------------------------------------</span></span></code><code><span>  <span>#提取原始矩阵</span></span></code><code><span>  <span>final</span>.df.gene=unique(<span>final</span>.df$geneA_geneB)</span></code><code><span>  <span>final</span>.df.cell=unique(<span>final</span>.df$cellA_cellB)</span></code><code><span>  <span>#pair中必须含有的细胞</span></span></code><code><span>  <span>if</span> (!is.<span>null</span>(used.cell)){</span></code><code><span>    tmp_cell=c()</span></code><code><span>    <span>for</span> (i in used.cell) {</span></code><code><span>      tmp_cell=union(tmp_cell,<span>final</span>.df.cell[str_detect(<span>final</span>.df.cell,i)])</span></code><code><span>    }</span></code><code><span>    <span>final</span>.df.cell=tmp_cell</span></code><code><span>  }</span></code><code><span>  raw.df=raw.df[raw.df$geneA_geneB %in% <span>final</span>.df.gene ,]</span></code><code><span>  raw.df=raw.df[raw.df$cellA_cellB %in% <span>final</span>.df.cell ,]</span></code><code><span>  </span></code><code><span>  <span>#-----------------------------------------------------------</span></span></code><code><span>  <span>#范围修正</span></span></code><code><span>  raw.df$neg_log10=ifelse(raw.df$neg_log10 &gt; neg_log10_th2,neg_log10_th2,raw.df$neg_log10)</span></code><code><span>  raw.df$means_exp_log2=ifelse(raw.df$means_exp_log2 &gt; means_exp_log2_th2[<span>2</span>],means_exp_log2_th2[<span>2</span>],</span></code><code><span>                               ifelse(raw.df$means_exp_log2 &lt; means_exp_log2_th2[<span>1</span>],means_exp_log2_th2[<span>1</span>],raw.df$means_exp_log2))</span></code><code><span>  </span></code><code><span>  <span>#-----------------------------------------------------------</span></span></code><code><span>  <span>#cellA-cellB的排列顺序</span></span></code><code><span>  raw.df$cellA_cellB=<span>as</span>.character(raw.df$cellA_cellB)</span></code><code><span>  <span>if</span> (!is.<span>null</span>(cell.pair)) {</span></code><code><span>    tmp_pair=intersect(cell.pair,unique(raw.df$cellA_cellB))</span></code><code><span>    raw.df=raw.df[raw.df$cellA_cellB %in% tmp_pair,]</span></code><code><span>    raw.df$cellA_cellB=factor(raw.df$cellA_cellB,levels = tmp_pair)</span></code><code><span>  } <span>else</span> {</span></code><code><span>    tmp_pair=sort(unique(raw.df$cellA_cellB))</span></code><code><span>    raw.df$cellA_cellB=factor(raw.df$cellA_cellB,levels = tmp_pair)</span></code><code><span>  }</span></code><code><span>  <span>#geneA-geneB的排列顺序</span></span></code><code><span>  raw.df$geneA_geneB=<span>as</span>.character(raw.df$geneA_geneB)</span></code><code><span>  <span>if</span> (!is.<span>null</span>(gene.pair)) {</span></code><code><span>    tmp_pair=intersect(gene.pair,unique(raw.df$geneA_geneB))</span></code><code><span>    raw.df=raw.df[raw.df$geneA_geneB %in% tmp_pair,]</span></code><code><span>    raw.df$geneA_geneB=factor(raw.df$geneA_geneB,levels = tmp_pair)</span></code><code><span>  } <span>else</span> {</span></code><code><span>    tmp_pair=sort(unique(raw.df$geneA_geneB))</span></code><code><span>    raw.df$geneA_geneB=factor(raw.df$geneA_geneB,levels = tmp_pair)</span></code><code><span>  }</span></code><code><span>  </span></code><code><span>  <span>#-----------------------------------------------------------</span></span></code><code><span>  p=raw.df%&gt;%ggplot(aes(geneA_geneB,cellA_cellB))+geom_point(aes(size=neg_log10,color=means_exp_log2))+</span></code><code><span>    scale_x_discrete(<span>""</span>)+scale_y_discrete(<span>""</span>)+</span></code><code><span>    scale_color_gradientn(colours = rev(c(<span>"#A50026"</span>, <span>"#D73027"</span>, <span>"#F46D43"</span>, <span>"#FDAE61"</span>,<span>"#FFFFB3"</span>,<span>"#ABD9E9"</span>, <span>"#4575B4"</span>,<span>"#313695"</span>)))+</span></code><code><span>    theme_bw()+</span></code><code><span>    theme(axis.text.x.bottom = element_text(hjust = <span>1</span>, vjust = <span>0.5</span>, size=<span>8</span>, angle = <span>90</span>))+</span></code><code><span>    coord_flip()</span></code><code><span>  <span>return</span>(p)</span></code><code><span>}</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span>library(tidyverse)</span></code><code><span>library(RColorBrewer)</span></code><code><span>library(scales)</span></code><code><span>setwd(<span>"C:/Users/yudonglin/Desktop/all/生信分析结果/受体-配体分析-20240303/out"</span>)</span></code><code><span>pvalues=read.table(<span>"pvalues.txt"</span>,header = T,sep = <span>"\t"</span>,stringsAsFactors = F,check.names = F)</span></code><code><span>pvalues=pvalues[,<span>12</span>:dim(pvalues)[<span>2</span>]]</span></code><code><span>statdf=<span>as</span>.data.frame(colSums(pvalues &lt; <span>0.05</span>))</span></code><code><span>colnames(statdf)=c(<span>"number"</span>)</span></code><code><span><br></span></code><code><span>statdf$indexb=str_replace(rownames(statdf),<span>"^.*\\."</span>,<span>""</span>)</span></code><code><span>statdf$indexa=str_replace(rownames(statdf),<span>"\\..*$"</span>,<span>""</span>)</span></code><code><span>statdf$total_number=<span>0</span></span></code><code><span><br></span></code><code><span><span>for</span> (i in <span>1</span>:dim(statdf)[<span>1</span>]) {</span></code><code><span>  tmp_indexb=statdf[i,<span>"indexb"</span>]</span></code><code><span>  tmp_indexa=statdf[i,<span>"indexa"</span>]</span></code><code><span>  <span>if</span> (tmp_indexa == tmp_indexb) {</span></code><code><span>    statdf[i,<span>"total_number"</span>] = statdf[i,<span>"number"</span>]</span></code><code><span>  } <span>else</span> {</span></code><code><span>    statdf[i,<span>"total_number"</span>] = statdf[statdf$indexb==tmp_indexb &amp; statdf$indexa==tmp_indexa,<span>"number"</span>]+</span></code><code><span>      statdf[statdf$indexa==tmp_indexb &amp; statdf$indexb==tmp_indexa,<span>"number"</span>]</span></code><code><span>  }</span></code><code><span>}</span></code><code><span><br></span></code><code><span>rankname=sort(unique(statdf$indexa)) </span></code><code><span>statdf$indexa=factor(statdf$indexa,levels = rankname)</span></code><code><span>statdf$indexb=factor(statdf$indexb,levels = rankname)</span></code><code><span><br></span></code><code><span>statdf%&gt;%ggplot(aes(x=indexa,y=indexb,fill=total_number))+geom_tile(color=<span>"white"</span>)+</span></code><code><span>  scale_fill_gradientn(colours = c(<span>"#4393C3"</span>,<span>"#ffdbba"</span>,<span>"#B2182B"</span>),limits=c(<span>0</span>,<span>20</span>))+</span></code><code><span>  scale_x_discrete(<span>"cluster 1"</span>)+</span></code><code><span>  scale_y_discrete(<span>"cluster 2"</span>)+</span></code><code><span>  theme_minimal()+</span></code><code><span>  theme(</span></code><code><span>    axis.text.x.bottom = element_text(hjust = <span>1</span>, vjust = <span>NULL</span>, angle = <span>45</span>),</span></code><code><span>    panel.grid = element_blank()</span></code><code><span>  )</span></code><code><span>ggsave(filename = <span>"interaction.num.2.pdf"</span>,device = <span>"pdf"</span>,width = <span>12</span>,height = <span>10</span>,units = c(<span>"cm"</span>))</span></code><code><span><br></span></code><code><span><br></span></code><code><span>library(tidyverse)</span></code><code><span>library(RColorBrewer)</span></code><code><span>library(scales)</span></code><code><span>library(igraph)</span></code><code><span><br></span></code><code><span>pvalues=read.table(<span>"pvalues.txt"</span>,header = T,sep = <span>"\t"</span>,stringsAsFactors = F,check.names = F)</span></code><code><span>pvalues=pvalues[,<span>12</span>:dim(pvalues)[<span>2</span>]]</span></code><code><span>statdf=<span>as</span>.data.frame(colSums(pvalues &lt; <span>0.05</span>))</span></code><code><span>colnames(statdf)=c(<span>"number"</span>)</span></code><code><span><br></span></code><code><span>statdf$indexb=str_replace(rownames(statdf),<span>"^.*\\."</span>,<span>""</span>)</span></code><code><span>statdf$indexa=str_replace(rownames(statdf),<span>"\\..*$"</span>,<span>""</span>)</span></code><code><span>rankname=sort(unique(statdf$indexa)) </span></code><code><span><br></span></code><code><span>A=c()</span></code><code><span>B=c()</span></code><code><span>C=c()</span></code><code><span>remaining=rankname</span></code><code><span><span>for</span> (i in rankname[<span>-6</span>]) {</span></code><code><span>  remaining=setdiff(remaining,i)</span></code><code><span>  <span>for</span> (j in remaining) {</span></code><code><span>    count=statdf[statdf$indexa == i &amp; statdf$indexb == j,<span>"number"</span>]+</span></code><code><span>      statdf[statdf$indexb == i &amp; statdf$indexa == j,<span>"number"</span>]</span></code><code><span>    A=append(A,i)</span></code><code><span>    B=append(B,j)</span></code><code><span>    C=append(C,count)</span></code><code><span>  }</span></code><code><span>}</span></code><code><span><br></span></code><code><span>statdf2=data.frame(indexa=A,indexb=B,number=C)</span></code><code><span>statdf2=statdf2 %&gt;% rbind(statdf[statdf$indexa==statdf$indexb,c(<span>"indexa"</span>,<span>"indexb"</span>,<span>"number"</span>)])</span></code><code><span>statdf2=statdf2[statdf2$number &gt; <span>0</span>,] <span>#过滤掉值为0的观测</span></span></code><code><span><br></span></code><code><span><span>#设置节点和连线的颜色</span></span></code><code><span>color1=c(<span>"#8DD3C7"</span>, <span>"#FDB462"</span>, <span>"#B3DE69"</span>, <span>"#FCCDE5"</span>, <span>"#D9D9D9"</span>, <span>"#BC80BD"</span>)</span></code><code><span>names(color1)=rankname</span></code><code><span>color2=colorRampPalette(brewer.pal(<span>9</span>, <span>"Reds"</span>)[<span>3</span>:<span>7</span>])(<span>20</span>) <span>#将颜色分成多少份，取决于互作关系数目的最大值</span></span></code><code><span>names(color2)=<span>1</span>:<span>20</span> <span>#每一份颜色用对应的数字命名</span></span></code><code><span><br></span></code><code><span><span>#做网络图</span></span></code><code><span><span>##下面的四行代码相对固定</span></span></code><code><span>net &lt;- graph_from_data_frame(statdf2[,c(<span>"indexa"</span>,<span>"indexb"</span>,<span>"number"</span>)])</span></code><code><span>edge.start &lt;- igraph::ends(net, es=igraph::E(net), names=<span>FALSE</span>)</span></code><code><span>group &lt;-  cluster_optimal(net)</span></code><code><span>coords &lt;- layout_in_circle(net, order = order(membership(group)))</span></code><code><span><br></span></code><code><span>E(net)$width &lt;- E(net)$number / <span>2</span> <span>#将数值映射到连线的宽度，有时还需要微调，这里除以2就是这个目的</span></span></code><code><span>E(net)$color &lt;- color2[<span>as</span>.character(ifelse(E(net)$number &gt; <span>20</span>,<span>20</span>,E(net)$number))] <span>#用前面设置好的颜色赋给连线，颜色深浅对应数值大小</span></span></code><code><span>E(net)$label = E(net)$number <span>#连线的标注</span></span></code><code><span>E(net)$label.color &lt;- <span>"black"</span> <span>#连线标注的颜色</span></span></code><code><span>V(net)$label.color &lt;- <span>"black"</span> <span>#节点标注的颜色</span></span></code><code><span>V(net)$color &lt;- color1[names(V(net))] <span>#节点的填充颜色，前面已经设置了；V(net)返回节点信息</span></span></code><code><span><br></span></code><code><span><span>#调整节点位置的线条角度</span></span></code><code><span><span>##如果没有这两行代码，节点位置的圆圈是向右的</span></span></code><code><span>loop.angle&lt;-ifelse(coords[igraph::V(net),<span>1</span>]&gt;<span>0</span>,-atan(coords[igraph::V(net),<span>2</span>]/coords[igraph::V(net),<span>1</span>]),pi-atan(coords[igraph::V(net),<span>2</span>]/coords[igraph::V(net),<span>1</span>]))</span></code><code><span>igraph::E(net)$loop.angle[which(edge.start[,<span>2</span>]==edge.start[,<span>1</span>])] &lt;- loop.angle[edge.start[which(edge.start[,<span>2</span>]==edge.start[,<span>1</span>]),<span>1</span>]]</span></code><code><span><br></span></code><code><span><span>#pdf("interaction.num.3.pdf",width = 6,height = 6)</span></span></code><code><span>plot(net,</span></code><code><span>     edge.arrow.size = <span>0</span>, <span>#连线不带箭头</span></span></code><code><span>     edge.curved = <span>0</span>, <span>#连线不弯曲</span></span></code><code><span>     vertex.frame.color = <span>"black"</span>, <span>#节点外框颜色</span></span></code><code><span>     layout = coords,</span></code><code><span>     vertex.label.cex = <span>1</span>, <span>#节点标注字体大小</span></span></code><code><span>     vertex.size = <span>30</span>) <span>#节点大小</span></span></code><code><span><span>#dev.off()</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span>source(<span>"CCC.bubble.R"</span>)</span></code><code><span>CCC(</span></code><code><span>  pfile=<span>"pvalues.txt"</span>,</span></code><code><span>  mfile=<span>"means.txt"</span>,</span></code><code><span>  <span>#neg_log10_th= -log10(0.05),</span></span></code><code><span>  <span>#means_exp_log2_th=1,</span></span></code><code><span>  <span>#neg_log10_th2=3,</span></span></code><code><span>  <span>#means_exp_log2_th2=c(-4,6),</span></span></code><code><span>  <span>#notused.cell=c("Bcell","Gcell"),</span></span></code><code><span>  <span>#used.cell=c("Mcell"),</span></span></code><code><span>  <span>#cell.pair=c("Mcell.Scell","Mcell.NKcell","Mcell.Tcell","Scell.Mcell","NKcell.Mcell","Tcell.Mcell"),#这里是自定义的顺序，若是可选细胞对的子集，则只展示子集，若有交集则只展示交集；空值情况下，会根据可选细胞对自动排序</span></span></code><code><span>  <span>#gene.pair=c("MIF_TNFRSF14","FN1_aVb1 complex","EGFR_MIF")#作用同上</span></span></code><code><span>)</span></code><code><span>ggsave(filename = <span>"全局的cellphoneDB结果.pdf"</span>,device = <span>"pdf"</span>,width =<span>30</span>,height = <span>12</span>,units = <span>"cm"</span>)</span></code><code><span>CCC(</span></code><code><span>  pfile=<span>"pvalues.txt"</span>,</span></code><code><span>  mfile=<span>"means.txt"</span>,</span></code><code><span>  <span>#neg_log10_th= -log10(0.05),</span></span></code><code><span>  <span>#means_exp_log2_th=1,</span></span></code><code><span>  <span>#neg_log10_th2=3,</span></span></code><code><span>  <span>#means_exp_log2_th2=c(-4,6),</span></span></code><code><span>  <span>#notused.cell=c("Endo1","Endo2","Endo3","Epi1","Epi2","HSC","Macro","Meso"),</span></span></code><code><span>  <span>#used.cell=c("Mcell"),</span></span></code><code><span>  cell.pair=c(<span>"Endo1.Mesen.Alb."</span>,<span>"Endo2.Mesen.Alb."</span>,<span>"Endo3.Mesen.Alb."</span>,<span>"Epi1.Mesen.Alb."</span>,<span>"Epi2.Mesen.Alb."</span>,<span>"HSC.Mesen.Alb."</span>,<span>"Macro.Mesen.Alb."</span>,<span>"Meso.Mesen.Alb."</span>,<span>"Mesen.Alb.Mesen.Alb."</span>),<span>#这里是自定义的顺序，若是可选细胞对的子集，则只展示子集，若有交集则只展示交集；空值情况下，会根据可选细胞对自动排序</span></span></code><code><span>  <span>#gene.pair=c("MIF_TNFRSF14","FN1_aVb1 complex","EGFR_MIF")#作用同上</span></span></code><code><span>)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>#参考资料：https://www.cnblogs.com/TOP-Bio/p/15057637.html</span></span></code><code><span><br></span></code></pre></section></section><p><img data-galleryid="" data-imgfileid="100025655" data-ratio="0.6226158038147139" data-s="300,640" data-type="jpeg" data-w="734" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpoSUGWzSf6kRzQx907iaoYL53y2xibHzA0wib6QKqUrwH2BGXI5p34qHL8U3Fyba6mYOG6iaicUQ9verQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpoSUGWzSf6kRzQx907iaoYL53y2xibHzA0wib6QKqUrwH2BGXI5p34qHL8U3Fyba6mYOG6iaicUQ9verQ/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span>cd</span> <span>/data/yudonglin/lvxiang/liuxuehui</span></span></code><code><span><span>#conda create -n cpdb python=3.7</span></span></code><code><span><span>source</span> <span>activate cpdb</span></span></code><code><span><span>conda</span> <span>activate /home/yudonglin/miniconda3/envs/cpdb</span></span></code><code><span><span>#pip install cellphonedb</span></span></code><code><span><span>cellphonedb</span> <span>method statistical_analysis test_meta.txt test_counts.txt --threads 40 --counts-data=gene_name</span></span></code><code><span><br></span></code><code><span><span>cellphonedb</span> <span>plot dot_plot</span></span></code><code><span><span>cellphonedb</span> <span>plot heatmap_plot test_meta.txt</span></span></code></pre></section><p>挑选自己感兴趣的互作细胞以及受体配体做图：<br></p><p><img data-galleryid="" data-imgfileid="100025653" data-ratio="0.4324074074074074" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpoSUGWzSf6kRzQx907iaoYLEmFOPuXzkryXAQHcMKRwr5uK70XpaZQH3ZjZzvjk4NdvkCK4DO8PkA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpoSUGWzSf6kRzQx907iaoYLEmFOPuXzkryXAQHcMKRwr5uK70XpaZQH3ZjZzvjk4NdvkCK4DO8PkA/640?wx_fmt=png&amp;from=appmsg"></p><p><img data-galleryid="" data-imgfileid="100025656" data-ratio="0.47685185185185186" data-s="300,640" data-type="jpeg" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpoSUGWzSf6kRzQx907iaoYLodYo0Yp1ibNkTpOteicRImo38lfFJgPYqenPqeoeKBcBTsmjvw3OEBVg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBpoSUGWzSf6kRzQx907iaoYLodYo0Yp1ibNkTpOteicRImo38lfFJgPYqenPqeoeKBcBTsmjvw3OEBVg/640?wx_fmt=png&amp;from=appmsg"></p><p></p><p></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/HXzhQAWqVtEb1hIF4J0MDA",target="_blank" rel="noopener noreferrer">原文链接</a>
