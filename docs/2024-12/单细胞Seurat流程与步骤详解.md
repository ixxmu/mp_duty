---
title: "单细胞Seurat流程与步骤详解"
date: 2024-12-28T03:30:03Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
单细胞Seurat流程与步骤详解 by 生信菜鸟团
------
<div><p><ne-clipboard source="https%3A%2F%2Fdr-bioinformatics.yuque.com%2Forg-wiki-dr-bioinformatics-gy5115%2Fgz4xgg%2Fpvyg5tv6cgy49a5a%2Fedit%23dddc8b73"></ne-clipboard></p><h1>开始之前我们先看一下标准流程</h1><p><img data-galleryid="" data-imgfileid="100046913" data-ratio="0.5299785867237687" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9Vctia6ibTAVzbFnwclvLkPDgqdrXjakBAbAlnxgG3bvficVSqUtYWD9QRJAicdZLic8dTv0Q8PibeSoA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="934" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Losib9Vctia6ibTAVzbFnwclvLkPDgqdrXjakBAbAlnxgG3bvficVSqUtYWD9QRJAicdZLic8dTv0Q8PibeSoA/640?wx_fmt=png&amp;from=appmsg"></p><pre data-language="plain"><p><code># 加载必要的库<br>library(Seurat)<br>library(harmony)<br><br># 数据预处理与分析<br>subset_data &lt;- subset_data %&gt;%<br>  Seurat::NormalizeData(verbose = FALSE) %&gt;%  # 归一化数据<br>  FindVariableFeatures(selection.method = "vst", nfeatures = 2000) %&gt;%  # 选择2000个变异基因<br>  ScaleData(verbose = FALSE) %&gt;%  # 数据缩放<br>  RunPCA(npcs = 50, verbose = FALSE)  # 主成分分析（PCA）<br><br># Harmony批次效应校正<br>subset_data &lt;- subset_data %&gt;% RunHarmony("stim", plot_convergence = TRUE)<br><br># 获取Harmony嵌入数据<br>harmony_embeddings &lt;- Embeddings(subset_data, 'harmony')<br><br># 降维和可视化<br>dims = 1:30<br>subset_data &lt;- subset_data %&gt;%<br>  RunUMAP(reduction = "harmony", dims = dims) %&gt;%  # 使用Harmony嵌入做UMAP<br>  RunTSNE(reduction = "harmony", dims = dims)  %&gt;% # 使用Harmony嵌入做t-SNE<br>  FindNeighbors(reduction = "harmony", dims = dims) %&gt;%<br>  Findclusters(reduction = "harmony", dims = dims)<br># 可视化结果<br>DimPlot(subset_data, reduction = "umap")  # UMAP可视化<br>DimPlot(subset_data, reduction = "tsne")  # t-SNE可视化<br><br># 如果你已经定义了细胞类型，可以用以下方式展示不同类型的细胞<br>DimPlot(subset_data, group.by = "cell_type")  # 基于已有的细胞类型标签绘制图<br></code></p></pre><hr><h1>详细解释</h1><h3>1. <strong>数据归一化 (</strong><code><strong>NormalizeData</strong></code><strong>)</strong></h3><pre data-language="plain"><p><code>subset_data = subset_data %&gt;%<br>  Seurat::NormalizeData(verbose = FALSE)</code></p></pre><ul><li><p><strong>目的</strong>：数据归一化的目的是将每个细胞的基因表达值调整到同一尺度，消除测序深度（library size）对表达数据的影响。通常，基因表达数据会进行对数变换，以便更好地比较各个基因的表达水平。</p></li><li><p><strong>使用的输入数据</strong>：它使用的是 <code>subset_data</code> 对象中的原始基因表达矩阵（通常是原始的 RNA counts）。</p></li><li><p><strong>结果</strong>：<code>NormalizeData</code> 函数会创建一个新的归一化数据集，结果存储在 <code>subset_data</code> 中。在 <code>verbose = FALSE</code> 时，函数不会输出过多的运行信息。</p><hr><p><br></p></li></ul><h3>2. <strong>选择可变基因 (</strong><code><strong>FindVariableFeatures</strong></code><strong>)</strong></h3><pre data-language="plain"><p><code>subset_data = subset_data %&gt;%<br>  FindVariableFeatures(selection.method = "vst", nfeatures = 2000)</code></p></pre><ul><li><p><strong>目的</strong>：选择在不同细胞之间变异性最大的基因，通常选择前 2000 个变异性最大的基因。这些基因常被用于后续分析，如降维和聚类。</p></li><li><p><strong>使用的输入数据</strong>：<strong><span>它使用归一化后的数据（即上一步 </span></strong><code><strong><span>NormalizeData</span></strong></code><strong><span> 处理过的数据），通过计算每个基因在所有细胞中的变异性来选择最具代表性的基因。</span></strong></p></li><li><p><strong>结果</strong>：<code>FindVariableFeatures</code> 通过计算基因的变异性，选出变异性最大的 2000 个基因，并将这些基因的信息存储在 <code>subset_data</code> 的 <code>@meta.data</code> 中。</p><hr><p><br></p></li></ul><h3>3. <strong>数据缩放 (</strong><code><strong>ScaleData</strong></code><strong>)</strong></h3><pre data-language="plain"><p><code>subset_data = subset_data %&gt;%<br>  ScaleData(verbose = FALSE)</code></p></pre><ul><li><p><strong>目的</strong>：将选择的变异基因数据进行标准化，使得每个基因的均值为 0，标准差为 1。这样可以确保每个基因在降维（如 PCA）时具有相同的贡献，不会因为基因的表达水平差异过大而影响结果。</p></li><li><p><strong>使用的输入数据</strong><strong><span>：它使用的是上一步选择的变异基因数据，通常是经过归一化的数据。</span></strong></p></li><li><p><strong>结果</strong>：<code>ScaleData</code> 处理后，每个基因的数据被缩放，结果存储在 <code>subset_data</code> 对象中。</p><hr><p><br></p></li></ul><h3>4. <strong>主成分分析 (PCA) (</strong><code><strong>RunPCA</strong></code><strong>)</strong></h3><pre data-language="plain"><p><code>subset_data = subset_data %&gt;%<br>  RunPCA(npcs = 50, verbose = FALSE)</code></p></pre><ul><li><p><strong>目的</strong>：主成分分析（PCA）是降维的一种方法，它通过计算数据中的主成分（PCs）来减少特征空间的维度。在这里，我们选择了前 50 个主成分（npcs = 50）。</p></li><li><p><strong>使用的输入数据</strong>：<strong><span>它使用的是缩放后的数据（即 </span></strong><code><strong><span>ScaleData</span></strong></code><strong><span> 处理过的数据）。PCA 会基于这些数据计算出每个细胞在每个主成分上的投影。</span></strong></p></li><li><p><strong>结果</strong>：PCA 结果被存储在 <code>subset_data</code> 对象中，作为一个新的维度数据，可以用于后续的降维和可视化步骤。</p><hr><p><br></p></li></ul><h3>5. <strong>绘制肘部图 (</strong><code><strong>ElbowPlot</strong></code><strong>)</strong></h3><pre data-language="plain"><p><code>ElbowPlot(subset_data, ndims = 50)</code></p></pre><ul><li><p><strong>目的</strong>：肘部图用来帮助选择适当的主成分数目，通常选择肘部（即误差变化急剧减缓的地方）之前的主成分数量作为分析的维度数。</p></li><li><p><strong>使用的输入数据</strong>：<strong><span>它使用的是前一步的 PCA 结果（即 </span></strong><code><strong><span>RunPCA</span></strong></code><strong><span> 生成的主成分数据）。</span></strong></p></li><li><p><strong>结果</strong>：肘部图会展示不同主成分数与方差解释度的关系，帮助你判断哪些主成分对数据变异贡献较大，通常选择那些方差解释度较高的主成分。</p><hr><p><br></p></li></ul><h3>6. <strong>绘制小提琴图 (</strong><code><strong>VlnPlot</strong></code><strong>)</strong></h3><pre data-language="plain"><p><code>VlnPlot(subset_data, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)</code></p></pre><ul><li><p><strong>目的</strong>：通过小提琴图（violin plot）展示不同细胞的基因数目（nFeature_RNA）、转录本数目（nCount_RNA）以及线粒体基因的百分比（percent.mt）。这些指标常用于质量控制，帮助识别低质量细胞或过度激活的细胞。</p></li><li><p><strong>使用的输入数据</strong>：<strong><span>它使用 </span></strong><code><strong><span>subset_data</span></strong></code><strong><span> 对象中的元数据（</span></strong><code><strong><span>@meta.data</span></strong></code><strong><span>）以及基因表达数据。</span></strong></p></li><li><p><strong>结果</strong>：图形会显示这些不同特征在细胞中的分布情况，帮助你了解数据的质量。</p><hr><p><br></p></li></ul><h3>7. <strong>数据整合（Harmony）</strong></h3><pre data-language="plain"><p><code><br>library('harmony')<br>subset_data &lt;- subset_data %&gt;%<br>  RunHarmony("stim", plot_convergence = TRUE)</code></p></pre><ul><li><p><strong>目的</strong>：使用 Harmony 方法整合批次效应（batch effects）或条件效应（如刺激 vs. 对照），使得整合后的数据不受这些效应的干扰。<code>stim</code> 是数据中的一个元数据列，用来标记不同的实验条件（如实验组 vs. 对照组）。</p></li><li><p><strong>使用的输入数据</strong><span>：</span><strong><span>它默认使用的是 </span></strong><code><strong><span>subset_data</span></strong></code><strong><span> 对象中的 PCA 结果（即 </span></strong><code><strong><span>RunPCA</span></strong></code><strong><span> 或其他降维方法的结果）</span></strong><span>。</span></p></li><li><p><strong>结果</strong>：<code>RunHarmony</code> 会基于所指定的元数据（在这里是 <code>stim</code>）来消除批次效应或实验条件效应，生成新的“和谐”嵌入（harmony embeddings），它们存储在 <code>subset_data</code> 对象中。</p><hr><p><br></p></li></ul><h3>8. <strong>降维与可视化（UMAP 和 t-SNE）</strong></h3><pre data-language="plain"><p><code><br>subset_data &lt;- subset_data %&gt;%<br>  RunUMAP(reduction = "harmony", dims = dims) %&gt;%<br>  RunTSNE(reduction = "harmony", dims = dims) %&gt;%<br>  FindNeighbors(reduction = "harmony", dims = dims)</code></p></pre><ul><li><p><strong>目的</strong>：使用 UMAP 和 t-SNE 进行非线性降维可视化。UMAP 和 t-SNE 都是常用于高维数据可视化的技术，通过将数据从高维空间降到 2D 或 3D 空间，便于观察细胞群体的分布。<code><strong><span>FindNeighbors</span></strong></code><strong><span> 则用于根据指定的维度（如前 30 个 Harmony 维度）计算细胞之间的相似性，生成邻居图。</span></strong></p></li><li><p><strong>使用的输入数据</strong>：<span>RunUMAP、 RunTSNE使用的是 Harmony 处理过的数据（即 </span><code><span>RunHarmony</span></code><span> 的结果），并基于指定的维度（</span><code><span>dims</span></code><span>）进行降维。</span></p></li><li><p><strong>结果</strong>：生成的 UMAP 和 t-SNE 图将存储在 <code>subset_data</code> 对象中，帮助你直观地查看细胞在低维空间的分布。</p></li></ul><h3>9. <strong>细胞聚类 (</strong><code><strong>FindClusters</strong></code><strong>)</strong></h3><pre data-language="plain"><p><code>subset_data = FindClusters(subset_data, resolution = 0.3)</code></p></pre><ul><li><p><strong>目的</strong>：进行细胞聚类。聚类方法（如 Louvain 或 Leiden）将细胞分组，目的是识别具有相似基因表达模式的细胞群体。</p></li><li><p><strong>使用的输入数据</strong>：<strong><span>它使用的是 </span></strong><code><strong><span>FindNeighbors</span></strong></code><strong><span> 生成的细胞邻接图以及降维后的数据。</span></strong></p></li><li><p><strong>结果</strong>：细胞被分配到不同的群体（clusters），并存储在 <code>subset_data@meta.data</code> 中的 <code>seurat_clusters</code> 列。</p></li></ul><hr><p><br></p><p><strong><span>注意：</span></strong></p><p><code>FindNeighbors</code> 和 <code>FindClusters</code> 主要是用来进行细胞聚类的，它们会基于数据的相似性计算细胞之间的邻近关系，并通过聚类算法（如 Louvain 或 Leiden 方法）将细胞分成不同的群体。这对于数据的探索和分析非常重要，尤其是当你没有预定义细胞类型时。</p><p>但是，如果你已经定义好了细胞类型，并且不打算根据数据的相似性进行自动聚类，那么确实不需要执行 <code>FindNeighbors</code> 和 <code>FindClusters</code>。在这种情况下，你可以跳过这两步，只使用你定义好的细胞类型标签来进行后续的分析和可视化。</p><ul><li><p><code><strong>FindNeighbors</strong></code>：计算细胞之间的相似性（通常使用主成分分析（PCA）结果）来为后续的聚类步骤提供邻近关系。如果你已经有了细胞类型标签，这一步不是必需的。</p></li><li><p><code><strong>FindClusters</strong></code>：基于 <code>FindNeighbors</code> 计算的邻近关系进行细胞聚类，将相似的细胞分为同一类。如果你已经定义了细胞类型，则不需要根据数据进行重新聚类。</p></li></ul><h4>但如果你想使用你已经定义好的细胞类型进行可视化（如 UMAP），可以直接使用这些标签进行颜色映射，无需运行聚类过程。只需在 UMAP 或其他可视化方法中使用细胞类型标签来显示不同的群体。</h4><h3><strong>举个例子：</strong></h3><p>假设你已经有了细胞类型信息，并且想直接画出基于这些细胞类型的 UMAP 图：</p><pre data-language="plain"><p><code># 假设细胞类型已存储在 subset_data@meta.data$cell_type 中<br>UMAP_plot &lt;- DimPlot(subset_data, group.by = "cell_type")</code></p></pre><p>这样，你就可以在 UMAP 图中看到基于已知细胞类型的分布，而无需运行 <code>FindNeighbors</code> 和 <code>FindClusters</code>。</p><p>总之，如果你已经有了细胞类型的信息，并且不需要基于数据进行新的聚类，<code>FindNeighbors</code> 和 <code>FindClusters</code> 这两步可以省略。</p><hr><h1><strong>总结</strong></h1><p>本文代码块完成了从数据归一化、选择变异基因、PCA降维到批次效应校正和细胞聚类、ump和tsne的完整流程。每一步都在前一步的结果基础上进行，确保数据经过预处理和整合，最终得到可用于细胞分群、降维可视化的高质量数据。</p><section><mp-common-profile data-pluginname="mpprofile" data-id="Mzg2NDcxMzYwNg==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345Sks7JhVxUX46ZKxPSob6ptqIZgnIEnHOn5VMwCX8sN6MQy1Pq4XXFEOJ6grAmsoQugyCDKOZictDBHA/0?wx_fmt=png" data-nickname="生信小博士" data-alias="bioinformatics_Dr" data-signature="【生物信息学】R语言开始，学习生信。Seurat，单细胞测序，空间转录组。 Python，scanpy，cell2location。资料分享" data-from="0" data-is_biz_ban="0" data-service_type="1"></mp-common-profile></section><p><br></p><section><section><br></section></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/uHiyCUIKjF9zby-ONc68DA",target="_blank" rel="noopener noreferrer">原文链接</a>
