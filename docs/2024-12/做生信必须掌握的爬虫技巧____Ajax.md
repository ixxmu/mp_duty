---
title: "做生信必须掌握的爬虫技巧 —— Ajax"
date: 2024-12-10T03:15:11Z
draft: ["false"]
tags: [
  "fetched",
  "生信杂货铺"
]
categories: ["Acdemic"]
---
做生信必须掌握的爬虫技巧 —— Ajax by 生信杂货铺
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section nodeleaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="生信杂货铺" data-alias="comelove2020" data-from="0" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKgcIVlZ69OBM3mfiarb4tHc8aApGDf11AV6iaYYj6CRgf4VLzogibhDtdHo9JUfUZSt4errsCMNmtbg/0?wx_fmt=png" data-signature="生物信息知识内容分享，学习笔记，资源分享，编程技巧" data-id="MzkxMjE4NDc2Mw==" data-is_biz_ban="0" data-service_type="1"></mp-common-profile></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><p data-tool="mdnice编辑器"><span leaf="">生物信息最重要的是数据，有些数据很好获取，数据库网站会提供文件下载，一些大型网站还会提供</span><code><span leaf="">API</span></code><span leaf=""> 方便大家用程序获取数据库的资源。</span></p><p data-tool="mdnice编辑器"><span leaf="">但也有一些数据库没有提供下载接口，或者部分表格数据不支持下载等，这时候就需要使用爬虫技术了。</span></p><p data-tool="mdnice编辑器"><span leaf="">简单的爬虫可以直接根据</span><code><span leaf="">URL</span></code><span leaf=""> 链接解析网页内容，例如，</span><code><span leaf="">KEGG Pathway</span></code><span leaf=""> 页面的通路分级信息，就可以通过这种方式。</span></p><p data-tool="mdnice编辑器"><span leaf="">也有更复杂的，需要动态获取数据，例如下滑到网站底部，自动加载数据，或者使用分页的方式展示。这时候，就需要解析网页处理方式，构造动态链接或请求来获取网页</span></p><p data-tool="mdnice编辑器"><span leaf="">今天，我们主要介绍一种简单的构造</span><code><span leaf="">Ajax</span></code><span leaf=""> 请求的方式来获取数据。</span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">解析网页</span></span><span data-cacheurl="" data-remoteid=""></span></h3><p data-tool="mdnice编辑器"><span leaf="">我们以下面的</span><span><span leaf="">gcPathogen</span></span><sup><span leaf="">[1]</span></sup><span leaf=""> 网站为例，介绍如何爬取</span><code><span leaf="">Ajax</span></code><span leaf=""> 动态加载的数据</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBGsGORz5KbjPcJOOVWa5V9VVU88vaXYswG9ib7VDMfldybUwwickjk0Cg/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.49907407407407406" data-type="jpeg" data-w="1080" data-imgfileid="100017263" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBGsGORz5KbjPcJOOVWa5V9VVU88vaXYswG9ib7VDMfldybUwwickjk0Cg/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">点击</span><code><span leaf="">Download</span></code><span leaf=""> 进入下载界面<img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBUFZpRe5MFZ2rnBtAdsec95Qv53BqE5bxiaelibdI7ib22sQ3iaVzrictiaoA/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.49907407407407406" data-type="jpeg" data-w="1080" data-imgfileid="100017259" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBUFZpRe5MFZ2rnBtAdsec95Qv53BqE5bxiaelibdI7ib22sQ3iaVzrictiaoA/640?wx_fmt=jpeg&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">在表格区域点击右键<img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBmqEiae7HW6Tny6m5ChEjHKREHrbDb5ibTKooWOrPSqInnqj5UwL1wG6w/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.49907407407407406" data-type="jpeg" data-w="1080" data-imgfileid="100017261" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBmqEiae7HW6Tny6m5ChEjHKREHrbDb5ibTKooWOrPSqInnqj5UwL1wG6w/640?wx_fmt=jpeg&amp;from=appmsg">选择</span><em><span leaf="">检查</span></em></p><p data-tool="mdnice编辑器"><span leaf="">在工具栏中选择</span><em><span leaf="">网络</span></em><span leaf=""> --&gt;</span><em><span leaf="">Fetch/XHR</span></em><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCB1p1W4NGzpS81NuYDrzMcETFNq54quv9sj2rglN7jqlNJNhTRRqMDcw/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.49907407407407406" data-type="jpeg" data-w="1080" data-imgfileid="100017260" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCB1p1W4NGzpS81NuYDrzMcETFNq54quv9sj2rglN7jqlNJNhTRRqMDcw/640?wx_fmt=jpeg&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">点击页面的页码，如</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBz9ozLn4spRz1vctZibK98u0c5YCcDeo4jYbVp45TtpsHCWsjs3V5Thw/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.49907407407407406" data-type="jpeg" data-w="1080" data-imgfileid="100017262" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBz9ozLn4spRz1vctZibK98u0c5YCcDeo4jYbVp45TtpsHCWsjs3V5Thw/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">然后在工具栏中点击跳出来的项目</span><em><span leaf="">downloadall</span></em><span leaf="">，可以看到浏览器向</span><code><span leaf="">https://nmdc.cn/gcpathogenapi/down/downloadall</span></code><span leaf=""> 发送了一个</span><code><span leaf="">POST</span></code><span leaf=""> 请求。</span></p><p data-tool="mdnice编辑器"><span leaf="">由于请求内容的类型是</span><code><span leaf="">application/json</span></code><span leaf="">，所以在</span><em><span leaf="">载荷</span></em><span leaf=""> 选项中可以看到向网站具体发送了哪些数据。</span></p><p data-tool="mdnice编辑器"><span leaf="">这种方式有别于</span><code><span leaf="">formData</span></code><span leaf=""> 形式，其请求类型为</span><code><span leaf="">application/x-www-form-urlencoded</span></code><span leaf=""> 或者</span><code><span leaf="">multipart/form-data</span></code><span leaf="">。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBV93QVe66njK7smxc8TFCIQk6ldVfvIKgbAuBMxRBq0via0CRQSskeIg/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.49907407407407406" data-type="jpeg" data-w="1080" data-imgfileid="100017267" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBV93QVe66njK7smxc8TFCIQk6ldVfvIKgbAuBMxRBq0via0CRQSskeIg/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">可以多点几页，看发送数据的变化，然后再去构造请求数据</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBibqiaIAa1IXO2hG5IicZjdBExaPTC4icfg3FVxk7D0nB2tJN6WAibsK6WZg/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.49907407407407406" data-type="jpeg" data-w="1080" data-imgfileid="100017266" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCBibqiaIAa1IXO2hG5IicZjdBExaPTC4icfg3FVxk7D0nB2tJN6WAibsK6WZg/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">点击</span><code><span leaf="">Virus</span></code></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCB0gcm944ERYh1Urx6l4sc9RowmN5a8UDTpiabKYqEXAYaeuUHMvRMGhg/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.49907407407407406" data-type="jpeg" data-w="1080" data-imgfileid="100017268" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCB0gcm944ERYh1Urx6l4sc9RowmN5a8UDTpiabKYqEXAYaeuUHMvRMGhg/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">通过对比可以发现，发送的数据只有</span><code><span leaf="">page</span></code><span leaf=""> 项和</span><code><span leaf="">type</span></code><span leaf=""> 项是变化的。而在标头选项中基本上所有东西都是不变的，包括请求网址。</span></p><p data-tool="mdnice编辑器"><span leaf="">通过上面的解析之后，我们大致理清楚了这个网站数据请求的方式，然后使用代码来自动化获取每一页的内容。</span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">抓取数据</span></span><span data-cacheurl="" data-remoteid=""></span></h3><p data-tool="mdnice编辑器"><span leaf="">导入需要的包</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf=""> json</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> time</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> requests</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> pandas </span><span><span leaf="">as</span></span><span leaf=""> pd</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">构建请求头，请求头字段可以根据自己的需求添加，下面使用了常用的几项</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">url = </span><span><span leaf="">'https://nmdc.cn/gcpathogenapi/down/downloadall'</span></span><span leaf=""><br></span><span leaf="">headers = {</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">'Content-Type'</span></span><span leaf="">: </span><span><span leaf="">'application/json'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">'Accept'</span></span><span leaf="">: </span><span><span leaf="">'application/json, text/plain, */*'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">'Origin'</span></span><span leaf="">: </span><span><span leaf="">'https://nmdc.cn'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">'Referer'</span></span><span leaf="">: </span><span><span leaf="">'https://nmdc.cn/gcpathogen/download'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">'connection'</span></span><span leaf="">: </span><span><span leaf="">'keep-alive'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">'User-Agent'</span></span><span leaf="">: </span><span><span leaf="">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># Cookie 换成你浏览器里面的，没有这一项不行，你可以看到</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 网页最底下的一行字已经提示了。有时候省略是可以的，需要看</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 具体的情况</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">'Cookie'</span></span><span leaf="">: </span><span><span leaf="">'_gscu_1249508818=33733045mkkzpc75; _gscbrs_1249508818=1; _gscs_1249508818=t33735372otmrlh75|pv:1'</span></span><span leaf=""> </span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">载荷数据对象，只有两项是变化的。构造起来也很简单</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">speices = {</span><span><span leaf="">'bacteria'</span></span><span leaf="">: </span><span><span leaf="">56</span></span><span leaf="">, </span><span><span leaf="">'fungi'</span></span><span leaf="">: </span><span><span leaf="">45</span></span><span leaf="">, </span><span><span leaf="">'virus'</span></span><span leaf="">: </span><span><span leaf="">26</span></span><span leaf="">, </span><span><span leaf="">'parasite'</span></span><span leaf="">: </span><span><span leaf="">18</span></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">payload = {</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"otherType"</span></span><span leaf="">: </span><span><span leaf="">"taxa"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"page"</span></span><span leaf="">: </span><span><span leaf="">1</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"high"</span></span><span leaf="">: </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"size"</span></span><span leaf="">: </span><span><span leaf="">10</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"type"</span></span><span leaf="">: </span><span><span leaf="">"virus"</span></span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">抓取所有表格数据，存储为</span><code><span leaf="">pandas</span></code><span leaf=""> 对象</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">data = []</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> sp, size </span><span><span leaf="">in</span></span><span leaf=""> speices.items():</span><span leaf=""><br></span><span leaf="">    pages = []</span><span leaf=""><br></span><span leaf="">    payload[</span><span><span leaf="">'type'</span></span><span leaf="">] = sp</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">for</span></span><span leaf=""> i </span><span><span leaf="">in</span></span><span leaf=""> range(</span><span><span leaf="">1</span></span><span leaf="">, size + </span><span><span leaf="">1</span></span><span leaf="">):</span><span leaf=""><br></span><span leaf="">        payload[</span><span><span leaf="">'page'</span></span><span leaf="">] = i</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf=""># preload 形式需要传入 json 对象而不是字典</span></span><span leaf=""><br></span><span leaf="">        req = requests.post(url, data=json.dumps(payload), headers=headers)</span><span leaf=""><br></span><span leaf="">        pages.append(pd.DataFrame(json.loads(req.text)[</span><span><span leaf="">'data'</span></span><span leaf="">][</span><span><span leaf="">'list'</span></span><span leaf="">]))</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf=""># 添加休眠，不要影响人家的网站，避免被封</span></span><span leaf=""><br></span><span leaf="">        time.sleep(</span><span><span leaf="">1</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    pages = pd.concat(pages, axis=</span><span><span leaf="">0</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    pages[</span><span><span leaf="">'type'</span></span><span leaf="">] = sp</span><span leaf=""><br></span><span leaf="">    data.append(pages)</span><span leaf=""><br></span><span leaf="">data = pd.concat(data, axis=</span><span><span leaf="">0</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">最后，保存为</span><code><span leaf="">Excel</span></code><span leaf=""> 文件</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">data.to_excel(</span><span><span leaf="">'Global_Catalogue_of_Pathogens.xlsx'</span></span><span leaf="">, index=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">结尾</span></span><span></span></h2><hr><p data-tool="mdnice编辑器"><span leaf="">任何代码的问题都可以在知识星球中提问。</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCB5IWiakicqoytEiaPjsCzValhQ6u6NjyBf9Dg84sia8bkAYNRTmeO78xFcA/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="1.5824074074074075" data-s="300,640" data-type="jpeg" data-w="1080" type="block" data-imgfileid="100017277" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJjIUCzdsAxlJ8KazDUCoCB5IWiakicqoytEiaPjsCzValhQ6u6NjyBf9Dg84sia8bkAYNRTmeO78xFcA/640?wx_fmt=jpeg&amp;from=appmsg"></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><section data-tool="mdnice编辑器"><span><span leaf="">参考资料</span></span></section><section data-tool="mdnice编辑器"><span><span><span leaf="">[1]</span></span><p><span leaf="">gcPathogen:</span><em><span leaf="">https://nmdc.cn/gcpathogen/</span></em></p></span></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/yoYPJ92m9NfQhh1LZrMCJg",target="_blank" rel="noopener noreferrer">原文链接</a>
