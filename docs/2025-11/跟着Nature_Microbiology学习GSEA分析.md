---
title: "跟着Nature Microbiology学习GSEA分析"
date: 2025-11-23T23:22:46Z
draft: ["false"]
tags: [
  "fetched",
  "R语言数据分析指南"
]
categories: ["Acdemic"]
---
跟着Nature Microbiology学习GSEA分析 by R语言数据分析指南
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><h3 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">欢迎关注R语言数据分析指南</span></span><span></span></h3><blockquote><span><span leaf="">❝</span></span><p><span leaf="">在上一节中，我们已经展示了多种常用的富集分析图形。本节将结合Nature Microbiology论文中的代码框架，系统介绍一类核心分析——GSEA（基因集富集分析）。论文采用了Hallmark与KEGG两套基因集体系，用以从“全局生物学程序”与“具体机制通路”两个层面解析表达变化。下面将基于原论文的分析逻辑，对关键代码进行示例展示。 需要说明的是，本节使用的数据与原研究并不完全一致，因此富集结果会有所差异，个观点仅供参考。更完整的背景和生物学解释请参阅原论文的详细描述。</span></p></blockquote><h3 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">论文信息</span></span><span></span></h3><p data-tool="mdnice编辑器"><strong><span leaf="">Enteric bacterial infection stimulates remodelling of bile metabolites to promote intestinal homeostasis</span></strong></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100054592" data-ratio="0.4148148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAYIlZl9bZJrmRVtJnfT6rVK8VDkV7pcSVwiceyWxiazklMBEbZ8sOPrlnsfkrIxEu9icwLRfNKMBaTtQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAYIlZl9bZJrmRVtJnfT6rVK8VDkV7pcSVwiceyWxiazklMBEbZ8sOPrlnsfkrIxEu9icwLRfNKMBaTtQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">论文代码</span></span><span></span></h3><p data-tool="mdnice编辑器"><strong><span leaf="">https://github.com/yh766/NMICROBIOL_Bile_2024</span></strong><span leaf=""><img data-imgfileid="100054595" data-ratio="0.512962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAYIlZl9bZJrmRVtJnfT6rVKwcEmtxD7NDL8Dc2u1ia8hESntGOwUENgu5LfibzhmMibpzCia2GAOSsiaLg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAYIlZl9bZJrmRVtJnfT6rVKwcEmtxD7NDL8Dc2u1ia8hESntGOwUENgu5LfibzhmMibpzCia2GAOSsiaLg/640?wx_fmt=png&amp;from=appmsg"></span></p><h3 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">差异分析</span></span><span></span></h3><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">library</span></span><span leaf="">(DESeq2)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(tidyverse)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(tximport)</span><span leaf=""><br></span><span><span leaf=""><a topic-id="miad4pmj-f35yh5" data-topic="1">#BiocManager</a>::install("apeglm")</span></span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(apeglm)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">meta &lt;- read_csv(</span><span><span leaf="">"samplesheet.csv"</span></span><span leaf="">) %&gt;% </span><span leaf=""><br></span><span leaf="">  column_to_rownames(var=</span><span><span leaf="">"sample"</span></span><span leaf="">) %&gt;% </span><span leaf=""><br></span><span leaf="">  mutate(group=as.factor(group))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">tx2gene &lt;- read_tsv(</span><span><span leaf="">"tx2gene.tsv"</span></span><span leaf="">) %&gt;% select(</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">2</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">files &lt;- list.files(path = </span><span><span leaf="">"."</span></span><span leaf="">,pattern = </span><span><span leaf="">"quant.sf$"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                    recursive = </span><span><span leaf="">TRUE</span></span><span leaf="">,full.names = </span><span><span leaf="">TRUE</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">names(files) &lt;- basename(dirname(files))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">files &lt;- files[ match(rownames(meta),names(files)) ]</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">stopifnot(all(names(files) == rownames(meta)))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">txi.salmon &lt;- tximport(files, type = </span><span><span leaf="">"salmon"</span></span><span leaf="">,tx2gene = tx2gene)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">dds &lt;- DESeqDataSetFromTximport(txi.salmon,meta,design=~group)</span><span leaf=""><br></span><span><span leaf=""># run DESeq</span></span><span leaf=""><br></span><span leaf="">dds &lt;- DESeq(dds)</span><span leaf=""><br></span><span leaf="">dds$group &lt;- relevel(dds$group, ref = </span><span><span leaf="">"SPF"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">dds &lt;- nbinomWaldTest(dds)</span><span leaf=""><br></span><span leaf="">resultsNames(dds)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">lm.srnk &lt;- lfcShrink(dds, coef=</span><span><span leaf="">"group_Lm_vs_SPF"</span></span><span leaf="">, type=</span><span><span leaf="">"apeglm"</span></span><span leaf="">) </span><span leaf=""><br></span><span leaf="">cr.pos.srnk &lt;- lfcShrink(dds, coef=</span><span><span leaf="">"group_pos_vs_SPF"</span></span><span leaf="">, type=</span><span><span leaf="">"apeglm"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h3 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">GSEA分析</span></span><span></span></h3><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">library</span></span><span leaf="">(clusterProfiler)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(org.Mm.eg.db)</span><span leaf=""><br></span><span><span leaf=""><a topic-id="miad4pmk-x41ejn" data-topic="1">#BiocManager</a>::install("msigdbr",force = TRUE)</span></span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(msigdbr)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(enrichplot)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(RColorBrewer)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(pals)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 将DESeqResults 转成 data.frame，并加 geneid</span></span><span leaf=""><br></span><span leaf="">table.lm &lt;- as.data.frame(lm.srnk) %&gt;%</span><span leaf=""><br></span><span leaf="">  tibble::rownames_to_column(</span><span><span leaf="">"geneid"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">table.cr.pos &lt;- as.data.frame(cr.pos.srnk) %&gt;%</span><span leaf=""><br></span><span leaf="">  tibble::rownames_to_column(</span><span><span leaf="">"geneid"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">data &lt;- list(table.lm, table.cr.pos)</span><span leaf=""><br></span><span leaf="">genelist &lt;- vector(</span><span><span leaf="">"list"</span></span><span leaf="">, length(data))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 和 RNAseq.R 中同一逻辑：ENSEMBL → ENTREZ，再按 log2FC 排序</span></span><span leaf=""><br></span><span leaf="">genelist &lt;- list()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> (i </span><span><span leaf="">in</span></span><span leaf=""> seq_along(data)) {</span><span leaf=""><br></span><span leaf="">  tab &lt;- data[[i]]</span><span leaf=""><br></span><span><span leaf=""># ID 转换</span></span><span leaf=""><br></span><span leaf="">  tab$entrez &lt;- mapIds(</span><span leaf=""><br></span><span leaf="">    org.Mm.eg.db,</span><span leaf=""><br></span><span leaf="">    keys = gsub(</span><span><span leaf="">"\\.[0-9]*"</span></span><span leaf="">, </span><span><span leaf="">""</span></span><span leaf="">, tab$geneid),</span><span leaf=""><br></span><span leaf="">    column = </span><span><span leaf="">"ENTREZID"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    keytype = </span><span><span leaf="">"ENSEMBL"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    multiVals = </span><span><span leaf="">"first"</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">  tab &lt;- tab[!is.na(tab$entrez), ]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 去掉重复 ENTREZ</span></span><span leaf=""><br></span><span leaf="">  tab &lt;- tab %&gt;% distinct(entrez, .keep_all = </span><span><span leaf="">TRUE</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 构建 geneList</span></span><span leaf=""><br></span><span leaf="">  gl &lt;- tab$log2FoldChange</span><span leaf=""><br></span><span leaf="">  names(gl) &lt;- tab$entrez</span><span leaf=""><br></span><span leaf="">  genelist[[i]] &lt;- sort(gl, decreasing = </span><span><span leaf="">TRUE</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">names(genelist) &lt;- c(</span><span><span leaf="">"Lm"</span></span><span leaf="">, </span><span><span leaf="">"Cr.pos"</span></span><span leaf="">)  </span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">set.seed(</span><span><span leaf="">1234</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">cc.kegg &lt;- compareCluster(</span><span leaf=""><br></span><span leaf="">  geneCluster   = genelist,</span><span leaf=""><br></span><span leaf="">  fun           = </span><span><span leaf="">"gseKEGG"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  organism      = </span><span><span leaf="">"mmu"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  pAdjustMethod = </span><span><span leaf="">"fdr"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  eps           = </span><span><span leaf="">0</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  pvalueCutoff  = </span><span><span leaf="">0.1</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  minGSSize     = </span><span><span leaf="">10</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  maxGSSize     = </span><span><span leaf="">500</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  seed          = </span><span><span leaf="">TRUE</span></span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">cc.kegg &lt;- setReadable(cc.kegg, OrgDb = org.Mm.eg.db, keyType = </span><span><span leaf="">"ENTREZID"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">cc.kegg.result &lt;- cc.kegg@compareClusterResult</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># KEGG dotplot</span></span><span leaf=""><br></span><span leaf="">pathways = unique(subset(cc.kegg.result, p.adjust &lt; </span><span><span leaf="">0.05</span></span><span leaf="">)$Description)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">dp &lt;- dotplot(cc.kegg, showCategory=pathways, size=</span><span><span leaf="">"setSize"</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  scale_color_gradientn(colours=rev(brewer.blues(</span><span><span leaf="">100</span></span><span leaf="">)), limits=c(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">0.2</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">ggplot(dp$data %&gt;%</span><span leaf=""><br></span><span leaf="">         group_by(Cluster) %&gt;%</span><span leaf=""><br></span><span leaf="">         slice_head(n = </span><span><span leaf="">20</span></span><span leaf="">),aes(x=Cluster, y=Description,size=setSize, color=p.adjust, fill=p.adjust, shape=.sign)) +</span><span leaf=""><br></span><span leaf="">  geom_point() + theme_bw() +</span><span leaf=""><br></span><span leaf="">  scale_color_gradientn(colours=rev(brewer.blues(</span><span><span leaf="">100</span></span><span leaf="">)), limits=c(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">0.2</span></span><span leaf="">)) +</span><span leaf=""><br></span><span leaf="">  scale_fill_gradientn(colours=rev(brewer.blues(</span><span><span leaf="">100</span></span><span leaf="">)), limits=c(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">0.2</span></span><span leaf="">)) +</span><span leaf=""><br></span><span leaf="">  theme(axis.title.x=element_blank(), axis.title.y=element_blank()) +</span><span leaf=""><br></span><span leaf="">  scale_shape_manual(values=c(</span><span><span leaf="">21</span></span><span leaf="">, </span><span><span leaf="">25</span></span><span leaf="">))</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100054594" data-ratio="1.1550695825049702" data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAYIlZl9bZJrmRVtJnfT6rVKS57rr8DuDe0ask4S6cql62CIUficuicc8bZL2SFfqweeP8m6HT2kLxZQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1006" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAYIlZl9bZJrmRVtJnfT6rVKS57rr8DuDe0ask4S6cql62CIUficuicc8bZL2SFfqweeP8m6HT2kLxZQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">set.seed(</span><span><span leaf="">1234</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">msig &lt;- msigdbr(species = </span><span><span leaf="">"Mus musculus"</span></span><span leaf="">, category = </span><span><span leaf="">"H"</span></span><span leaf="">) %&gt;%</span><span leaf=""><br></span><span leaf="">  dplyr::select(gs_name, entrez_gene) %&gt;%</span><span leaf=""><br></span><span leaf="">  mutate(gs_name = gsub(</span><span><span leaf="">"HALLMARK_"</span></span><span leaf="">, </span><span><span leaf="">""</span></span><span leaf="">, gs_name))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">cc.msig &lt;- compareCluster(</span><span leaf=""><br></span><span leaf="">  geneCluster   = genelist,</span><span leaf=""><br></span><span leaf="">  fun           = </span><span><span leaf="">"GSEA"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  pAdjustMethod = </span><span><span leaf="">"fdr"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  eps           = </span><span><span leaf="">0</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  pvalueCutoff  = </span><span><span leaf="">0.2</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  minGSSize     = </span><span><span leaf="">10</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  maxGSSize     = </span><span><span leaf="">500</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  seed          = </span><span><span leaf="">TRUE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  TERM2GENE     = msig</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">cc.msig &lt;- setReadable(cc.msig, OrgDb = org.Mm.eg.db, keyType = </span><span><span leaf="">"ENTREZID"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">cc.msig.result &lt;- cc.msig@compareClusterResult</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">pathways = unique(subset(cc.msig.result, p.adjust &lt; </span><span><span leaf="">0.05</span></span><span leaf="">)$Description)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">dp &lt;- dotplot(cc.msig, showCategory=pathways, size=</span><span><span leaf="">"setSize"</span></span><span leaf="">) + </span><span leaf=""><br></span><span leaf="">  scale_color_gradientn(colours=rev(brewer.blues(</span><span><span leaf="">100</span></span><span leaf="">)), limits=c(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">0.2</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">ggplot(dp$data,aes(x=Cluster, y=Description,</span><span leaf=""><br></span><span leaf="">           size=setSize, color=p.adjust,</span><span leaf=""><br></span><span leaf="">           fill=p.adjust, shape=.sign)) + </span><span leaf=""><br></span><span leaf="">  geom_point() + theme_bw() + </span><span leaf=""><br></span><span leaf="">  scale_color_gradientn(colours=rev(brewer.blues(</span><span><span leaf="">100</span></span><span leaf="">)), limits=c(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">0.2</span></span><span leaf="">)) + </span><span leaf=""><br></span><span leaf="">  scale_fill_gradientn(colours=rev(brewer.blues(</span><span><span leaf="">100</span></span><span leaf="">)), limits=c(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">0.2</span></span><span leaf="">)) + </span><span leaf=""><br></span><span leaf="">  theme(axis.title.x=element_blank(), axis.title.y=element_blank()) + </span><span leaf=""><br></span><span leaf="">  scale_shape_manual(values=c(</span><span><span leaf="">21</span></span><span leaf="">, </span><span><span leaf="">25</span></span><span leaf="">))</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAYIlZl9bZJrmRVtJnfT6rVKxdpM4Frdgp2ribw3UkwNsuR3hjtvE5znk2IIwZcqI3KibCC9Hk90RG2A/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.1550695825049702" data-type="png" data-w="1006" data-imgfileid="100054593" src="https://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAYIlZl9bZJrmRVtJnfT6rVKxdpM4Frdgp2ribw3UkwNsuR3hjtvE5znk2IIwZcqI3KibCC9Hk90RG2A/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">关注下方公众号下回更新不迷路</span></span><span></span></h3><section nodeleaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="R语言数据分析指南" data-alias="YanJANtwo" data-from="0" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/EibnicgwScTAZF0rpeZII9Ltl26VbVagriczTria1fib3XgjwwHEHFjPzkmGpqWDVVHBSzhENictUM2iavAKiaM5lc9USw/0?wx_fmt=png" data-signature="R语言重症爱好者，喜欢绘制各种精美的图表，喜欢的小伙伴可以关注我，跟我一起学习" data-id="Mzg3MzQzNTYzMw==" data-is_biz_ban="0" data-service_type="1" data-verify_status="0"></mp-common-profile></section></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/2bZ_XKWIT-eeMY5MdV3NBA",target="_blank" rel="noopener noreferrer">原文链接</a>
