---
title: "漂亮的单细胞多组火山图"
date: 2024-11-07T04:37:58Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
漂亮的单细胞多组火山图 by 生信星球
------
<div><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section><img data-imgfileid="100012759" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100012761" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第1018天</strong></span></span><img data-imgfileid="100012763" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span></span></section><section><blockquote><section><span>公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span><span>我的课程都是循环开课，</span><span>点进去咨询微信↓</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247496424&amp;idx=1&amp;sn=947ff3f1a8e6ee9d06e0543f43b001cd&amp;chksm=fdfbbaaaca8c33bcd9f5cc134899d4f2a331648b0641369417417b09cd3ed980f317cccc4996&amp;scene=21#wechat_redirect" textvalue="生信分析直播‍课程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a>(每月初开一期，春节休一个月)</section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494919&amp;idx=2&amp;sn=967d8dcf0f9a22047ae0bd442b9d4ee6&amp;chksm=fdfba545ca8c2c5396c3fb5caa93a5d30336626533fcac074abd7683e8d536cb2dcae31d6e7a&amp;scene=21#wechat_redirect" textvalue="生信新手保护‍学习‍小组" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信新手保护学习小组</a>（每月两期）</section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247495036&amp;idx=1&amp;sn=fe8bab2c3d21e7b0a919ad4f1641ca9c&amp;chksm=fdfba53eca8c2c286522b2accc0d4cb9dda7cd9a5b36695e66d393abb5bff396d6bcaa4c9cb8&amp;scene=21#wechat_redirect" textvalue="单细胞陪伴学习小组内测完成，长期招生中" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞陪伴学习小组</a>（每月两期)</section></blockquote></section></section><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><h3 data-tool="mdnice编辑器"><span></span></h3><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><p data-tool="mdnice编辑器">最近发现一篇超级棒且适合做教材的单细胞文章，16分呢。</p><p data-tool="mdnice编辑器">《Single-cell transcriptome analysis reveals the association between histone lactylation and cisplatin resistance in bladder cancer 》</p><p data-tool="mdnice编辑器">其中的fig1B很好的展示了每种细胞类型的marker基因，把我迷住了，把它复现出来，可以用在每个单细胞数据呢！拿去用。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100012794" data-ratio="0.34557235421166305" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHr7K1SeMgXRRjHgicsRVib9QibzkRcomia6WZ96MUkSVJsXdmGMYDHA6UeQRAZo8tMVzIRoGpMJRVAHqg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="926" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHr7K1SeMgXRRjHgicsRVib9QibzkRcomia6WZ96MUkSVJsXdmGMYDHA6UeQRAZo8tMVzIRoGpMJRVAHqg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">输入数据是已经做完细胞类型注释的seurat对象，除此之外啥也不要啦。纯代码的。</p><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br>library(Seurat)<br>library(dplyr)<br>library(patchwork)<br>library(ggplot2)<br>load( "sce.Rdata")<br>scRNA = sce<br>scRNA@meta.data$celltype = Idents(scRNA)<br>ctys = levels(scRNA)<br>ctys<br></code></pre><pre data-tool="mdnice编辑器"><code>## [1] "naive B"     "CD8 T"       "Naive CD4 T" "plasma B"    "CD14+ Mono" <br>## [6] "endothelial" "Fibroblasts" "NK"          "DC"<br></code></pre><pre data-tool="mdnice编辑器"><code>scRNA.markers &lt;- FindAllMarkers(scRNA, min.pct = 0.25, <br>                    logfc.threshold = 0.25)<br>head(scRNA.markers)<br></code></pre><pre data-tool="mdnice编辑器"><code>##                  p_val avg_log2FC pct.1 pct.2     p_val_adj cluster     gene<br>## CD79A     0.000000e+00   5.356611 0.915 0.060  0.000000e+00 naive B    CD79A<br>## BANK1     0.000000e+00   6.778892 0.853 0.026  0.000000e+00 naive B    BANK1<br>## MS4A1     0.000000e+00   5.677155 0.848 0.050  0.000000e+00 naive B    MS4A1<br>## HLA-DRA  1.482079e-306   2.775984 0.994 0.336 3.060197e-302 naive B  HLA-DRA<br>## HLA-DQB1 7.341732e-295   2.622558 0.926 0.207 1.515921e-290 naive B HLA-DQB1<br>## HLA-DQA1 5.404715e-292   2.727477 0.865 0.138 1.115966e-287 naive B HLA-DQA1<br></code></pre><pre data-tool="mdnice编辑器"><code>colnames(scRNA.markers)[6] = "celltype"<br>k = scRNA.markers$p_val_adj&lt;0.05;table(k)<br></code></pre><pre data-tool="mdnice编辑器"><code>## k<br>## FALSE  TRUE <br>##  3960  8946<br></code></pre><pre data-tool="mdnice编辑器"><code>scRNA.markers = scRNA.markers[k,]<br><br>#上下调<br>scRNA.markers$label &lt;- ifelse(scRNA.markers$avg_log2FC&lt;0,"sigDown","sigUp")<br>topgene &lt;- scRNA.markers %&gt;%<br>  group_by(celltype) %&gt;%<br>  top_n(n = 10, wt = avg_log2FC) %&gt;%<br>  bind_rows(group_by(scRNA.markers, celltype) %&gt;%<br>              top_n(n = 10, wt = -avg_log2FC))<br>head(topgene)<br></code></pre><pre data-tool="mdnice编辑器"><code>## # A tibble: 6 × 8<br>## # Groups:   celltype [1]<br>##       p_val avg_log2FC pct.1 pct.2 p_val_adj celltype gene      label<br>##       &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;    &lt;chr&gt;     &lt;chr&gt;<br>## 1 0               6.78 0.853 0.026 0         naive B  BANK1     sigUp<br>## 2 3.13e-250       6.98 0.498 0.011 6.47e-246 naive B  LINC00926 sigUp<br>## 3 2.59e-207       6.02 0.423 0.01  5.34e-203 naive B  CD24      sigUp<br>## 4 1.42e-204       6.90 0.411 0.008 2.92e-200 naive B  LINC02397 sigUp<br>## 5 1.15e-196       7.13 0.403 0.01  2.38e-192 naive B  IGHD      sigUp<br>## 6 5.77e-166       7.47 0.335 0.006 1.19e-161 naive B  PAX5      sigUp<br></code></pre><pre data-tool="mdnice编辑器"><code>#根据log2FC范围确定背景柱长度：<br>dfbar = scRNA.markers %&gt;%<br>  group_by(celltype) %&gt;%<br>    summarise(low = round(min(avg_log2FC)-0.5),<br>            up = round(max(avg_log2FC)+0.5))<br><br>#绘制背景柱和散点图：<br>p1 &lt;- ggplot()+<br>  geom_col(aes(x = celltype ,y = low),dfbar,<br>           fill = "#dcdcdc",alpha = 0.6)+<br>  geom_col(aes(x = celltype ,y = up),dfbar,<br>           fill = "#dcdcdc",alpha = 0.6)+<br>  geom_jitter(aes(x = celltype, y = avg_log2FC, color = label),scRNA.markers,<br>              width =0.4,size = 1)+<br>  scale_color_manual(values = c("#0077c0","#c72d2e"))+<br>  theme_classic()<br>p1<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012791" data-ratio="0.625" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHr7K1SeMgXRRjHgicsRVib9QibZ0SJtq6PjU0SkicYibHmSTPomHfJXSy5upZaaKibvypicTb9h1EvZDXMiag/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHr7K1SeMgXRRjHgicsRVib9QibZ0SJtq6PjU0SkicYibHmSTPomHfJXSy5upZaaKibvypicTb9h1EvZDXMiag/640?wx_fmt=other&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><code>#X轴的色块标签：<br>library(RColorBrewer)<br>mycol &lt;- colorRampPalette(rev(brewer.pal(n = 7, name ="Set1")))(length(ctys))<br>p2 &lt;- p1 + <br>  geom_tile(aes(x = ctys,y = 0),<br>            height = 0.5,fill = mycol, show.legend = F)+<br>  geom_text(aes(x= ctys, y = 0, label = ctys),<br>            size = 3,fontface = "bold")<br>p2<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012792" data-ratio="0.625" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHr7K1SeMgXRRjHgicsRVib9QibtWMFAFGWvL1vrxY1jJbE8yWCyrwgVU6b2lEOugJyXhwF2l4PQ6ibR5A/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHr7K1SeMgXRRjHgicsRVib9QibtWMFAFGWvL1vrxY1jJbE8yWCyrwgVU6b2lEOugJyXhwF2l4PQ6ibR5A/640?wx_fmt=other&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><code>library(ggrepel)<br>#给每种细胞类型的top基因加上标签,调整细节：<br>p3 &lt;- p2 + <br>  geom_text_repel(aes(x = celltype,y = avg_log2FC,label = gene),<br>                  topgene,size = 3 )+<br>  labs(x = "CellType",y = "Average log2FoldChange",<br>       title = "Differential expression genes")+<br>  theme(<br>    plot.title = element_text(size = 14,color = "black",face = "bold"),<br>    axis.title = element_text(size = 12,color = "black",face = "bold"),<br>    axis.line.y = element_line(color = "black",linewidth = 0.8),<br>    axis.line.x = element_blank(),<br>    axis.text.x = element_blank(),<br>    axis.ticks.x = element_blank(),<br>    panel.grid = element_blank(),<br>    legend.position  = c(0.98,0.96),<br>    legend.background = element_blank(),<br>    legend.title = element_blank(),<br>    legend.direction = "vertical",<br>    legend.justification = c(1,0),<br>    legend.text = element_text(size = 12)<br>  )+<br>  guides(color = guide_legend(override.aes = list(size = 4)))  <br>p3<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012793" data-ratio="0.625" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHr7K1SeMgXRRjHgicsRVib9Qib0SqUEpicZyQic5Eeq7YGdEytibBaNhNG7eGJicm4msKUibXkqgKVlbAicqGA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHr7K1SeMgXRRjHgicsRVib9Qib0SqUEpicZyQic5Eeq7YGdEytibBaNhNG7eGJicm4msKUibXkqgKVlbAicqGA/640?wx_fmt=other&amp;from=appmsg"></figure><figure data-tool="mdnice编辑器">和原图一般无二啦。</figure></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/7Z4YXatm9cyFFH_7Kh_hJw",target="_blank" rel="noopener noreferrer">原文链接</a>
