---
title: "原来设置多个颜色图例这么简单"
date: 2024-11-04T00:48:42Z
draft: ["false"]
tags: [
  "fetched",
  "生信杂货铺"
]
categories: ["Acdemic"]
---
原来设置多个颜色图例这么简单 by 生信杂货铺
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span><span></span></h1></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span><span>多颜色图例设置</span><span></span></h1><p data-tool="mdnice编辑器">在 <code>ggplot2</code> 中，默认情况下每个映射（如 <code>color</code>、<code>fill</code>）只允许一个图例。</p><p data-tool="mdnice编辑器">虽然你可以为不同的图层应用多个颜色映射，但每种映射类型最终只会生成一个图例。</p><p data-tool="mdnice编辑器">如果你希望有多个独立的颜色图例（例如，为不同图层分别设置独立的颜色图例），可以使用下面两个包来实现这一效果。</p><h2 data-tool="mdnice编辑器"><span></span><span>准备</span><span></span></h2><pre data-tool="mdnice编辑器"><span></span><code><span>#| message: false</span><br><br><span>library</span>(ggnewscale)<br><span>library</span>(tidyverse)<br><span>library</span>(ggh4x)<br><span>library</span>(ggcor)<br></code></pre><p data-tool="mdnice编辑器">参考之前教程中的数据处理部分，读取 TCGA-LIHC 的表达谱</p><pre data-tool="mdnice编辑器"><span></span><code>probemap &lt;- read_delim(<span>"data/gencode.v36.annotation.gtf.gene.probemap"</span>,<br>                       delim = <span>"\t"</span>, show_col_types = <span>FALSE</span>) %&gt;%<br>    tibble::column_to_rownames(<span>"id"</span>)<br>lihc &lt;- read_tsv(<span>"data/TCGA-LIHC.star_fpkm.tsv.gz"</span>,<br>                 show_col_types = <span>FALSE</span>) %&gt;%<br>    mutate(symbol = probemap[Ensembl_ID,]$gene) %&gt;%<br>    dplyr::select(-Ensembl_ID) %&gt;%<br>    group_by(symbol) %&gt;%<br>    summarise_all(mean) %&gt;%<br>    tibble::column_to_rownames(<span>"symbol"</span>)<br></code></pre><p data-tool="mdnice编辑器">拆分出原位癌和癌旁正常样本</p><pre data-tool="mdnice编辑器"><span></span><code><span># 01 -&gt; promary solid tumor</span><br>lihc.tumor &lt;- lihc[,substr(colnames(lihc), <span>14</span>, <span>15</span>) == <span>'01'</span>] %&gt;% t() %&gt;% as.data.frame()<br>rownames(lihc.tumor) &lt;- substr(rownames(lihc.tumor), <span>1</span>, <span>12</span>)<br><span># 11 -&gt; solid tissue normal</span><br>lihc.normal &lt;- lihc[,substr(colnames(lihc), <span>14</span>, <span>15</span>) == <span>'11'</span>,] %&gt;% t() %&gt;% as.data.frame()<br>rownames(lihc.normal) &lt;- substr(rownames(lihc.normal), <span>1</span>, <span>12</span>)<br></code></pre><p data-tool="mdnice编辑器">定义基因和颜色梯度</p><pre data-tool="mdnice编辑器"><span></span><code>use_gene &lt;- c(<span>"YAP1"</span>, <span>"CTGF"</span>, <span>"TEAD2"</span>, <span>"MST1"</span>)<br><br>palette1 &lt;- colorRampPalette(c(<span>"#87c55f"</span>, <span>"white"</span>, <span>"#fe88b1"</span>))(<span>50</span>)<br>palette2 &lt;- colorRampPalette(c(<span>"#008080"</span>, <span>"#f6edbd"</span>, <span>"#ca562c"</span>))(<span>50</span>)<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>ggh4x</span><span></span></h2><h3 data-tool="mdnice编辑器"><span></span><span>scale_fill_multi</span><span></span></h3><p data-tool="mdnice编辑器"><code>ggh4x</code> 包提供了 <code>scale_fill/colour_multi</code> 函数用于设置多个颜色图例。分为两步</p><p data-tool="mdnice编辑器">首先，需要在原本要设置颜色映射的地方，将参数 <code>fill</code>/<code>colour</code> 改成一个自定义的名称</p><p data-tool="mdnice编辑器">用 <code>scale_fill_multi</code> 代替原来的颜色设置函数，并在函数中用 <code>aesthetics</code> 指定前面定义的名称向量，<code>colours</code> 为需要为每个名称设置的颜色列表</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: scale_fill_multi</span><br><span>#| message: false</span><br><span>#| warning: false</span><br><br>ggcor::correlate(lihc.tumor[, use_gene]) %&gt;% <br>    ggcor::as_cor_tbl(<br>        extra.mat = list(Normal = cor(lihc.normal[, use_gene]))) %&gt;% <br>    mutate(Tumor = r) %&gt;%<br>    quickcor() +<br>    geom_square(data = get_data(type = <span>"lower"</span>), aes(fill1 = Tumor)) +<br>    geom_shade(data = get_data(type = <span>"lower"</span>), aes(fill1 = Tumor)) +<br>    geom_star(data = get_data(type = <span>"upper"</span>), <br>              aes(r0 = Normal, fill2 = Normal)) +<br>    geom_diag_label(size = <span>5</span>) +<br>    scale_fill_multi(<br>        aesthetics = c(<span>"fill1"</span>, <span>"fill2"</span>),<br>        colours = list(palette1, palette2),<br>        limits = c(-<span>1</span>, <span>1</span>)) +<br>    ggcor::remove_all_axis()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016222" data-ratio="0.6175925925925926" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWLCo5pQ6Gdfm2zEWgYnNf6iasQgzv1nKNYG48ZwGBqrXa2kQDzztNX0g7APZZ1WHqsjjapsZ9tDEvA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWLCo5pQ6Gdfm2zEWgYnNf6iasQgzv1nKNYG48ZwGBqrXa2kQDzztNX0g7APZZ1WHqsjjapsZ9tDEvA/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>scale_listed</span><span></span></h3><p data-tool="mdnice编辑器">另一个函数 <code>scale_listed</code> 使用方式类似，也是先自定义一个映射名称，然后为参数 <code>scalelist</code> 设置一个列表，列表中可以放置 <code>ggplot</code> 中的颜色设置函数，通过 <code>aesthetics</code> 参数来对应前面设置的映射</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: scale_listed</span><br><span>#| message: false</span><br><span>#| warning: false</span><br><br>ggcor::correlate(lihc.tumor[, use_gene], cor.test = <span>TRUE</span>) %&gt;% <br>    ggcor::as_cor_tbl(<br>        extra.mat = list(Normal = cor(liver[, use_gene]))) %&gt;% <br>    mutate(Tumor = r) %&gt;%<br>    quickcor() +<br>    geom_square(data = get_data(type = <span>"lower"</span>), aes(tumor = Tumor)) +<br>    geom_shade(data = get_data(type = <span>"lower"</span>), aes(tumor = Tumor)) +<br>    geom_star(data = get_data(type = <span>"upper"</span>), <br>              aes(r0 = Normal, normal = Normal)) +<br>    geom_diag_label(size = <span>5</span>) +<br>    scale_listed(<br>        scalelist = list(<br>            scale_fill_gradientn(name = <span>"TCGA-LIHC"</span>, colours = my_palette,<br>                                 aesthetics = <span>"tumor"</span>, limits = c(-<span>1</span>, <span>1</span>)),<br>            scale_fill_gradientn(name = <span>"GTEx-liver"</span>, colours = my_palette2,<br>                                 aesthetics = <span>"normal"</span>, limits = c(-<span>1</span>, <span>1</span>))),<br>        replaces = c(<span>"fill"</span>, <span>"fill"</span>)<br>      ) +<br>    ggcor::remove_all_axis()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016223" data-ratio="0.6175925925925926" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWLCo5pQ6Gdfm2zEWgYnNf6iaaHKHjhcMiaq6GgMsd6obf0W8icluibhDBcHCicLFsxRdHLhXY9ibldH0vjQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWLCo5pQ6Gdfm2zEWgYnNf6iaaHKHjhcMiaq6GgMsd6obf0W8icluibhDBcHCicLFsxRdHLhXY9ibldH0vjQ/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>ggnewscale</span><span></span></h2><p data-tool="mdnice编辑器"><code>ggnewscale</code> 包试图简化在 <code>ggplot2</code> 中使用多个同名映射的。虽然最初是为了与颜色和填充一起使用，但它也可以与形状、线型等任何 <code>aes</code> 一起使用，一般很少用到。</p><p data-tool="mdnice编辑器">设置颜色</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| new_scale_fill</span><br><span>#| message: false</span><br><span>#| warning: false</span><br><br>ggcor::correlate(lihc.tumor[, use_gene]) %&gt;% <br>    ggcor::as_cor_tbl(<br>        extra.mat = list(Normal = cor(liver[, use_gene]))) %&gt;% <br>    mutate(Tumor = r) %&gt;%<br>    quickcor() +<br>    geom_square(data = get_data(type = <span>"lower"</span>), aes(fill = Tumor)) +<br>    geom_shade(data = get_data(type = <span>"lower"</span>), aes(fill = Tumor)) +<br>    scale_fill_gradientn(name = <span>'TCGA-LIHC'</span>, colours = my_palette,<br>                         limits = c(-<span>1</span>, <span>1</span>)) +<br>    new_scale_fill() + <span># 等价于 new_scale('fill')</span><br>    geom_star(data = get_data(type = <span>"upper"</span>), <br>              aes(r0 = Normal, fill = Normal)) +<br>    scale_fill_gradientn(name = <span>'GTEx-liver'</span>, colours = my_palette2, <br>                         limits = c(-<span>1</span>, <span>1</span>)) +<br>    geom_diag_label(size = <span>5</span>) +<br>    ggcor::remove_all_axis()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016224" data-ratio="0.6175925925925926" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWLCo5pQ6Gdfm2zEWgYnNf6iaaHKHjhcMiaq6GgMsd6obf0W8icluibhDBcHCicLFsxRdHLhXY9ibldH0vjQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWLCo5pQ6Gdfm2zEWgYnNf6iaaHKHjhcMiaq6GgMsd6obf0W8icluibhDBcHCicLFsxRdHLhXY9ibldH0vjQ/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>结尾</span><span></span></h2><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">所有文件、代码以及原始文档都上传到了知识星球，任何代码的问题都可以提问，自愿加入。<img data-imgfileid="100016225" data-ratio="1.5824074074074075" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWLCo5pQ6Gdfm2zEWgYnNf6iasBD2KMXVKYxAXh9mcWCb2ePNyAZEkX15XuWcib08QBdCj5fKF8L40ibQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWLCo5pQ6Gdfm2zEWgYnNf6iasBD2KMXVKYxAXh9mcWCb2ePNyAZEkX15XuWcib08QBdCj5fKF8L40ibQ/640?wx_fmt=jpeg&amp;from=appmsg"></p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkxMjE4NDc2Mw==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKgcIVlZ69OBM3mfiarb4tHc8aApGDf11AV6iaYYj6CRgf4VLzogibhDtdHo9JUfUZSt4errsCMNmtbg/0?wx_fmt=png" data-nickname="生信杂货铺" data-alias="comelove2020" data-signature="生物信息知识内容分享，学习笔记，资源分享，编程技巧" data-from="0" data-is_biz_ban="0"></mp-common-profile></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/zGykW6Sgssg3eD6LLopX-Q",target="_blank" rel="noopener noreferrer">原文链接</a>
