---
title: "拟时序分析的State表达矩阵和差异基因"
date: 2024-11-02T01:11:54Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
拟时序分析的State表达矩阵和差异基因 by 生信星球
------
<div><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section><img data-imgfileid="100012759" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100012761" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第1017天</strong></span></span><img data-imgfileid="100012763" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span></span></section><section><blockquote><section><span>公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span><span>我的课程都是循环开课，</span><span>点进去咨询微信↓</span><br></section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247496424&amp;idx=1&amp;sn=947ff3f1a8e6ee9d06e0543f43b001cd&amp;chksm=fdfbbaaaca8c33bcd9f5cc134899d4f2a331648b0641369417417b09cd3ed980f317cccc4996&amp;scene=21#wechat_redirect" textvalue="生信分析直播‍课程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a>(每月初开一期，春节休一个月)</section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494919&amp;idx=2&amp;sn=967d8dcf0f9a22047ae0bd442b9d4ee6&amp;chksm=fdfba545ca8c2c5396c3fb5caa93a5d30336626533fcac074abd7683e8d536cb2dcae31d6e7a&amp;scene=21#wechat_redirect" textvalue="生信新手保护‍学习‍小组" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信新手保护学习小组</a>（每月两期）</section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247495036&amp;idx=1&amp;sn=fe8bab2c3d21e7b0a919ad4f1641ca9c&amp;chksm=fdfba53eca8c2c286522b2accc0d4cb9dda7cd9a5b36695e66d393abb5bff396d6bcaa4c9cb8&amp;scene=21#wechat_redirect" textvalue="单细胞陪伴学习小组内测完成，长期招生中" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞陪伴学习小组</a>（每月两期)</section></blockquote></section></section><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><h3 data-tool="mdnice编辑器"><span></span><span>需求</span><span></span></h3><p data-tool="mdnice编辑器"><span>我们的线上直播课每月会开一次直播答疑，既往报名的老学员都可以参与，不加钱不限时，主打一个关爱，如果你不知道的话现在知道了哦。</span></p><p data-tool="mdnice编辑器"><span>两个需求：</span></p><p data-tool="mdnice编辑器"><span>第一个是做拟时序的不同发育阶段(state)之间的差异分析，并且希望加上每个基因在当前state和其他state各自的基因表达量平均值。</span></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100012787" data-ratio="0.4312849162011173" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHpRAGmutrS8qn2mb7kbRnxZNqxCExD4PIvs0G9leav7ubxgcIcictvgSrFy51vfLzhfDDX4o7pymeg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="895" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHpRAGmutrS8qn2mb7kbRnxZNqxCExD4PIvs0G9leav7ubxgcIcictvgSrFy51vfLzhfDDX4o7pymeg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><span>第二个是想要一个平均表达量矩阵，每列是一个State，每行是一个基因。</span></p><p data-tool="mdnice编辑器"><img data-imgfileid="100012788" data-ratio="0.7458033573141487" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHpRAGmutrS8qn2mb7kbRnxZmuiamWkXLnl9VEovZr8lQGruDmghFtmBkRju6tvznp4449DHbrhNMZg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="834" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHpRAGmutrS8qn2mb7kbRnxZmuiamWkXLnl9VEovZr8lQGruDmghFtmBkRju6tvznp4449DHbrhNMZg/640?wx_fmt=png&amp;from=appmsg"><span> </span><span>说明一下：图是公司给的结果，里面的数值是未log的tpm，我们采用的是logNormlize之后的数据，更好。</span></p><p data-tool="mdnice编辑器"><span>学生说，跟公司要代码，人家不给。哈哈，那能给你才怪。所以来找我咯。</span></p><h3 data-tool="mdnice编辑器"><span></span><span>输入数据</span><span></span></h3><p data-tool="mdnice编辑器"><span>首先是前面的<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494818&amp;idx=1&amp;sn=cfc0b1ed6b00303760fe8762c5b96d44&amp;chksm=fdfba4e0ca8c2df67a13a9704ef0284f66e63a1e19e0e69f0b586d4a1e83692a478b6b68b4b7&amp;scene=21#wechat_redirect" textvalue="monocle单样本" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">monocle单样本</a>代码，p2+p1/p3之前的行原封不动的运行，得到sc_cds，和原来的输入数据scRNA(seurat对象)一起存为Rdata。</span></p><p data-tool="mdnice编辑器"><span>拟时序分析完成后，CellDataSet对象里面已经有了state信息。</span></p><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br>library(Seurat)<br></code></pre><pre data-tool="mdnice编辑器"><code>## Loading required package: SeuratObject<br></code></pre><pre data-tool="mdnice编辑器"><code>## Loading required package: sp<br></code></pre><pre data-tool="mdnice编辑器"><code>## <br>## Attaching package: 'SeuratObject'<br></code></pre><pre data-tool="mdnice编辑器"><code>## The following objects are masked from 'package:base':<br>## <br>##     intersect, t<br></code></pre><pre data-tool="mdnice编辑器"><code>library(dplyr)<br></code></pre><pre data-tool="mdnice编辑器"><code>## <br>## Attaching package: 'dplyr'<br></code></pre><pre data-tool="mdnice编辑器"><code>## The following objects are masked from 'package:stats':<br>## <br>##     filter, lag<br></code></pre><pre data-tool="mdnice编辑器"><code>## The following objects are masked from 'package:base':<br>## <br>##     intersect, setdiff, setequal, union<br></code></pre><pre data-tool="mdnice编辑器"><code>load("sc_exp.Rdata")<br>head(sc_cds@phenoData@data) #state信息<br></code></pre><pre data-tool="mdnice编辑器"><code>##                  orig.ident nCount_RNA nFeature_RNA percent.mt RNA_snn_res.0.5<br>## AAACCCAAGTAGGGTC          a      10768         3213   7.030089               7<br>## AAAGGTAGTCTTGAGT          a       5565         1936   5.804133               7<br>## AACAAAGTCTTCCGTG          a       8503         3063   7.397389               7<br>## AACCACATCCTTCACG          a      12678         3846   6.830730               7<br>## AACGGGATCATTTCCA          a       8032         2501   2.079183               1<br>## AACGTCATCTCGGCTT          a      10596         3221   5.841827               1<br>##                  seurat_clusters     celltype Size_Factor Pseudotime State<br>## AAACCCAAGTAGGGTC               7 FCGR3A+ Mono   1.5413473  0.6942694     1<br>## AAAGGTAGTCTTGAGT               7 FCGR3A+ Mono   0.7965823  0.6812000     1<br>## AACAAAGTCTTCCGTG               7 FCGR3A+ Mono   1.2171319  0.2854422     1<br>## AACCACATCCTTCACG               7 FCGR3A+ Mono   1.8147476  6.7191558     3<br>## AACGGGATCATTTCCA               1   CD14+ Mono   1.1497123 17.0878087     5<br>## AACGTCATCTCGGCTT               1   CD14+ Mono   1.5167270 17.6253461     4<br></code></pre><p data-tool="mdnice编辑器"><span>检查sc_cds和scRNA中的细胞顺序是否一致，确认是一致的才可以直接在scRNA里添加sc_cds里面的列。</span></p><pre data-tool="mdnice编辑器"><code>head(scRNA@meta.data)<br></code></pre><pre data-tool="mdnice编辑器"><code>##                  orig.ident nCount_RNA nFeature_RNA percent.mt RNA_snn_res.0.5<br>## AAACCCAAGTAGGGTC          a      10768         3213   7.030089               7<br>## AAAGGTAGTCTTGAGT          a       5565         1936   5.804133               7<br>## AACAAAGTCTTCCGTG          a       8503         3063   7.397389               7<br>## AACCACATCCTTCACG          a      12678         3846   6.830730               7<br>## AACGGGATCATTTCCA          a       8032         2501   2.079183               1<br>## AACGTCATCTCGGCTT          a      10596         3221   5.841827               1<br>##                  seurat_clusters     celltype<br>## AAACCCAAGTAGGGTC               7 FCGR3A+ Mono<br>## AAAGGTAGTCTTGAGT               7 FCGR3A+ Mono<br>## AACAAAGTCTTCCGTG               7 FCGR3A+ Mono<br>## AACCACATCCTTCACG               7 FCGR3A+ Mono<br>## AACGGGATCATTTCCA               1   CD14+ Mono<br>## AACGTCATCTCGGCTT               1   CD14+ Mono<br></code></pre><pre data-tool="mdnice编辑器"><code>identical(rownames(scRNA@meta.data),rownames(sc_cds@phenoData@data))<br></code></pre><pre data-tool="mdnice编辑器"><code>## [1] TRUE<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>需求1：State间差异分析</span><span></span></h3><pre data-tool="mdnice编辑器"><code>#确认一致，可以添加啦<br>scRNA$State = sc_cds@phenoData@data$State<br>Idents(scRNA) = scRNA$State #设为scRNA的Idents<br></code></pre><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>设置Idents为State</span><span><span> </span></span></h4><p data-tool="mdnice编辑器"><span>Idents是Seurat对象的重要内容之一，是细胞的分类。在常规的Seurat分析流程里，这个Idents是一直在变化的。</span></p><p data-tool="mdnice编辑器"><span>数据读取进来时，这个Idents是样本名称，如果是单样本数据那就只有一个分类，名字可以自己设置(CreateSeuratObject的project参数)</span></p><p data-tool="mdnice编辑器"><span>完成FindCluster步骤后，Idents会变成亚群编号（0，1，2，3…）</span></p><p data-tool="mdnice编辑器"><span>完成细胞类型注释后，Idents会被设置成细胞名称。</span></p><p data-tool="mdnice编辑器"><strong><span>它的Idents是什么，FindAllmarkers就会找什么分类之间的差别。</span></strong></p><p data-tool="mdnice编辑器"><span>我们现在要找State之间的差异基因，就设置为State啦。</span></p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>计算差异基因</span><span><span> </span></span></h4><p data-tool="mdnice编辑器"><span>用monocle自带的差异分析函数得出的结果信息不太齐全，还是seurat好啊。</span></p><pre data-tool="mdnice编辑器"><code>scRNA.markers &lt;- FindAllMarkers(scRNA, <br>                               only.pos = TRUE,<br>                               min.pct = 0.25)<br></code></pre><pre data-tool="mdnice编辑器"><code>## Calculating cluster 1<br></code></pre><pre data-tool="mdnice编辑器"><code>## Calculating cluster 2<br></code></pre><pre data-tool="mdnice编辑器"><code>## Calculating cluster 3<br></code></pre><pre data-tool="mdnice编辑器"><code>## Calculating cluster 4<br></code></pre><pre data-tool="mdnice编辑器"><code>## Calculating cluster 5<br></code></pre><pre data-tool="mdnice编辑器"><code>scRNA.markers %&gt;% group_by(cluster) %&gt;% top_n(n = 2, wt = avg_log2FC)<br></code></pre><pre data-tool="mdnice编辑器"><code>## # A tibble: 10 × 7<br>## # Groups:   cluster [5]<br>##       p_val avg_log2FC pct.1 pct.2 p_val_adj cluster gene     <br>##       &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;   &lt;chr&gt;    <br>##  1 2.02e-10       3.60 0.396 0.048  5.25e- 6 1       ARID5B   <br>##  2 9.16e- 9       3.95 0.302 0.027  2.38e- 4 1       P2RY10   <br>##  3 7.48e-16       8.33 0.333 0      1.94e-11 2       ASPM     <br>##  4 7.48e-16       8.33 0.333 0      1.94e-11 2       SYT9     <br>##  5 1.68e- 8       2.44 0.549 0.168  4.37e- 4 3       PRDM1    <br>##  6 2.91e- 5       2.79 0.353 0.101  7.57e- 1 3       C1QA     <br>##  7 3.14e- 6       2.43 0.32  0.067  8.16e- 2 4       LINC01094<br>##  8 1.36e- 3       2.52 0.26  0.093  1   e+ 0 4       CD9      <br>##  9 4.91e- 6       4.20 0.302 0.064  1.28e- 1 5       NAF1     <br>## 10 2.03e- 5       4.03 0.395 0.134  5.27e- 1 5       HSPA6<br></code></pre><p data-tool="mdnice编辑器"><span>因为将State设置为了Idents，这里的”cluster”列其实是State。把列名改掉，避免歧义。</span></p><pre data-tool="mdnice编辑器"><code>colnames(scRNA.markers)[6] = "State"<br></code></pre><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>计算平均表达量</span><span><span> </span></span></h4><p data-tool="mdnice编辑器"><span>即计算每个基因在当前state和其他state的平均表达量，学生说为了方便直接查看和比较表达量。</span></p><pre data-tool="mdnice编辑器"><code>exp = scRNA@assays$RNA$data<br>a = apply(scRNA.markers,1,function(x){<br>  c(mean(exp[x[7],scRNA$State==x[6]]),<br>    mean(exp[x[7],scRNA$State!=x[6]]))<br>})<br>a = as.data.frame(t(a))<br>colnames(a) = c("Target_State","Other_State")<br>head(a)<br></code></pre><pre data-tool="mdnice编辑器"><code>##          Target_State Other_State<br>## VMO1         2.468474   0.3722993<br>## TNFSF13B     1.709487   0.2883641<br>## CDKN1C       1.612884   0.2331031<br>## JPT1         2.585694   1.0113633<br>## CYTIP        2.436601   1.0251027<br>## PAPSS2       1.812296   0.5325872<br></code></pre><pre data-tool="mdnice编辑器"><code>scRNA.markers = cbind(scRNA.markers,a)<br>head(scRNA.markers)<br></code></pre><pre data-tool="mdnice编辑器"><code>##                 p_val avg_log2FC pct.1 pct.2    p_val_adj State     gene<br>## VMO1     1.285754e-27   3.447251 1.000 0.245 3.341417e-23     1     VMO1<br>## TNFSF13B 8.299190e-23   3.268468 0.925 0.245 2.156793e-18     1 TNFSF13B<br>## CDKN1C   1.761194e-21   3.300786 0.868 0.163 4.576990e-17     1   CDKN1C<br>## JPT1     2.570100e-21   2.154897 1.000 0.646 6.679175e-17     1     JPT1<br>## CYTIP    1.086084e-18   1.783399 1.000 0.626 2.822514e-14     1    CYTIP<br>## PAPSS2   1.802407e-18   2.258809 0.962 0.408 4.684095e-14     1   PAPSS2<br>##          Target_State Other_State<br>## VMO1         2.468474   0.3722993<br>## TNFSF13B     1.709487   0.2883641<br>## CDKN1C       1.612884   0.2331031<br>## JPT1         2.585694   1.0113633<br>## CYTIP        2.436601   1.0251027<br>## PAPSS2       1.812296   0.5325872<br></code></pre><p data-tool="mdnice编辑器"><span>搞定啦。</span></p><h3 data-tool="mdnice编辑器"><span></span><span>需求2：state平均表达量矩阵</span><span></span></h3><p data-tool="mdnice编辑器"><span>我本以为应该要很多行代码才能搞定。结果只要两行！chatgpt写了十几行还报错。还是自己写的好使嗯。</span></p><p data-tool="mdnice编辑器"><span>我写的哦</span><span>👇</span><span>。如有雷同是别人抄我的。</span></p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>计算！</span><span><span> </span></span></h4><pre data-tool="mdnice编辑器"><code>dat = split(colnames(exp),scRNA$State)<br>re = sapply(dat,function(x){rowMeans(exp[,x])})<br>head(re)<br></code></pre><pre data-tool="mdnice编辑器"><code>##                   1         2         3         4         5<br>## TSPAN6   0.00000000 0.0000000 0.0000000 0.0000000 0.0000000<br>## DPM1     0.20975283 0.5425002 0.2493284 0.3039274 0.2149655<br>## SCYL3    0.03053863 0.0000000 0.0831260 0.0000000 0.0000000<br>## C1orf112 0.01484739 0.0000000 0.0000000 0.0000000 0.0000000<br>## FGR      0.69361333 0.3610408 0.9225549 1.1443649 0.9587395<br>## CFH      0.00000000 0.0000000 0.0000000 0.0000000 0.0000000<br></code></pre><p data-tool="mdnice编辑器"><span>让chatgpt讲讲这两句代码的意思，超多料。让它写他不一定行，让它解释肯定是行的！</span></p><h5 data-tool="mdnice编辑器"><span></span><span>第一行代码：</span><code>dat = split(colnames(exp), scRNA$State)</code><span></span></h5><ul data-tool="mdnice编辑器"><li><section><code>colnames(exp)</code><span>：这部分获取表达矩阵</span><code>exp</code><span>的列名，通常列名代表不同的样本或细胞。</span></section></li><li><section><code>split(colnames(exp), scRNA$State)</code><span>：</span><code>split</code><span>函数用于根据</span><code>scRNA$State</code><span>中的每个细胞的状态将列名（样本/细胞）分组。</span><code>scRNA$State</code><span>是一个向量，其中包含了与</span><code>exp</code><span>矩阵中每一列相对应的状态信息（例如，不同的细胞类型或条件）。</span></section></li><li><section><code>dat</code><span>：这个变量将存储</span><code>split</code><span>函数的结果，即一个列表，其中每个元素包含了对应于相同状态的所有列名。</span></section></li></ul><h5 data-tool="mdnice编辑器"><span></span><span>第二行代码：</span><code>re = sapply(dat, function(x) {rowMeans(exp[,x])})</code><span></span></h5><ul data-tool="mdnice编辑器"><li><section><code>sapply(dat, function(x) {rowMeans(exp[,x])})</code><span>：</span><code>sapply</code><span>函数用于对</span><code>dat</code><span>列表中的每个元素（即每个状态组的列名）应用一个函数。这里应用的函数是</span><code>rowMeans</code><span>，它计算</span><code>exp</code><span>矩阵中每一行（基因）在指定列（细胞/样本）上的平均值。</span></section></li><li><section><code>function(x) {rowMeans(exp[,x])}</code><span>：这是一个匿名函数，它接受一个向量</span><code>x</code><span>（代表一组列名），并计算</span><code>exp</code><span>矩阵中这些列的平均表达量。</span></section></li><li><section><code>re</code><span>：这个变量将存储</span><code>sapply</code><span>函数的结果，即一个向量，其中包含了每个状态组的基因平均表达量。</span></section></li></ul><h5 data-tool="mdnice编辑器"><span></span>总结<span></span></h5><p data-tool="mdnice编辑器"><span>这两行代码的目的是将表达矩阵</span><code>exp</code><span>根据细胞状态分组，并计算每个组中所有基因的平均表达量。这样，你可以比较不同状态（如不同细胞类型或不同疾病状态）下基因表达的差异。这种方法在单细胞RNA测序数据分析中非常常见，用于识别状态特异性的基因表达模式。</span></p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>检查!</span><span><span> </span></span></h4><p data-tool="mdnice编辑器"><span>验证一个，看上面的代码是否正确啊。</span></p><pre data-tool="mdnice编辑器"><code>mean(exp["DPM1",scRNA$State==1])<br></code></pre><pre data-tool="mdnice编辑器"><code>## [1] 0.2097528<br></code></pre><pre data-tool="mdnice编辑器"><code>re["DPM1",1]<br></code></pre><pre data-tool="mdnice编辑器"><code>## [1] 0.2097528<br></code></pre><p data-tool="mdnice编辑器">搞定啦。</p></section><h4 data-tool="mdnice编辑器"><br></h4></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/mvK6_PI6zgm4RCkBSNXX9Q",target="_blank" rel="noopener noreferrer">原文链接</a>
