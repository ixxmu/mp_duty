---
title: "来给单细胞UMAP图加上个比例饼图！手把手教你"
date: 2024-11-18T10:07:06Z
draft: ["false"]
tags: [
  "fetched",
  "生信作曲家"
]
categories: ["Acdemic"]
---
来给单细胞UMAP图加上个比例饼图！手把手教你 by 生信作曲家
------
<div><section><h3><span>前言</span></h3><blockquote><p><span></span><span></span><span></span><span><span></span><span><span></span><span><span></span><span><span><span></span><span><span><span>生信作曲家一直致力于构建国内<span><strong>和谐、开放、可持续</strong></span><strong>的生物信息交流平台</strong>。生信作曲家的目标是<strong>为每个科研人扫清科研路上的一切障碍，让生物信息学人人可做</strong>。目前，生信作曲家已推出<span><strong>"</strong><strong>跟着一区文章学通机器学习”、</strong><strong>"</strong><strong>跟着一区文章学通单细胞</strong><strong>"、"空间转录组从入门到精通”、孟德尔随机化实战”</strong><strong>、scFEA</strong><strong><strong>、</strong>NATMI、CIBERSORTx、hdWGCNA、cytotalk、metaVIPER算法</strong></span>等多种强力教程，同时也兼具数据整理、可视化等核心入门技术教学，开办<span><strong>空间转录组计划smrsp/sp、孟德尔随机化系列计划IM/MR）、临床数据库系列、肿瘤发文计划RS/max，非肿瘤发文计划note/ultra/pro</strong></span><strong>、暑期集训营和冬季集训营</strong>等多次。辅导同学实现纯生信SCI发表硕果累累，帮助同学实现医学事业路上的理想与追求。</span></span></span><span></span></span></span><span></span></span><span></span></span><span></span></span><span></span><span></span><span></span><span></span></p></blockquote><p>今天我们来学习<span>给单细胞降维UMAP图加上每个cluster的组别分布，用来展示每个seurat_clusters细胞都属于哪个组。类似下图。<br></span></p><p><span>首先你需要自己完成一个右上角图，当然这是比较简单的。我们要做的是下面两个图的类型。</span></p><p><span><strong><span><br></span></strong></span></p><p><br></p><p><img data-galleryid="" data-imgfileid="100006909" data-ratio="0.6222222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmwUYC6f1HOK4j3az7wDcLaZxcMSrMAz2Q96Oq9qxtgTibzl39eHLuFfw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmwUYC6f1HOK4j3az7wDcLaZxcMSrMAz2Q96Oq9qxtgTibzl39eHLuFfw/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><br></p><br><h3><span>代码实操</span></h3><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span></h3><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'scRNA.Rdata'</span>)<br></code></pre><p data-tool="mdnice编辑器">整合后的单细胞数据在seurat_integrated中</p><p data-tool="mdnice编辑器">载入包</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(cowplot)<br><span>library</span>(ggpubr)<br><span>library</span>(dplyr)<br><span>library</span>(readr)<br><span>library</span>(tidyr)<br><span>library</span>(ggforce)<br><span>library</span>(pals)<br><span>library</span>(pheatmap)<br><span>library</span>(scales)<br><span>library</span>(ggthemes)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(scatterpie)<br></code></pre><p data-tool="mdnice编辑器">把umap坐标提取出来</p><pre data-tool="mdnice编辑器"><span></span><code>groupCols &lt;- c(<span>'HC'</span>=<span>"#00AFBB"</span>,  <span>'UC'</span>=<span>"#FC4E07"</span> )<br>cell_eb &lt;- data.frame(seurat_integrated@reductions[[<span>"umap"</span>]]@cell.embeddings[,<span>1</span>:<span>2</span>],cluster=as.character(seurat_integrated$seurat_clusters),group=as.character(seurat_integrated$disease), stringsAsFactors = <span>F</span>)<br>colnames(cell_eb) &lt;- c(<span>'x'</span>,<span>'y'</span>,<span>'cluster'</span>, <span>'group'</span>)<br>head(cell_eb)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006910" data-ratio="0.17685185185185184" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmugdzSI8PSLwcHaNsrGjiaAZMOUvI5IvvKiaDNDtRWLU3ib3HQiaHDibKE7Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmugdzSI8PSLwcHaNsrGjiaAZMOUvI5IvvKiaDNDtRWLU3ib3HQiaHDibKE7Q/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">将每个点按照分组进行填充</p><pre data-tool="mdnice编辑器"><span></span><code>p1 &lt;- ggplot(data=cell_eb, aes(x,y)) + geom_point(aes(colour = factor(group)), alpha=<span>0.5</span>, size=<span>0.25</span>,show.legend = <span>F</span>) +<br>  scale_color_manual(values = alpha(groupCols, alpha = <span>0.3</span>),breaks=<span>NULL</span>) + theme_pubr()+ NoAxes() <br>p1<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006913" data-ratio="0.45740740740740743" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmicOAruoAKEMyqewjyEgmr5PnrYZ0Ubd4S4ZaiaZhR6JMvuVAs4ibPyK3A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmicOAruoAKEMyqewjyEgmr5PnrYZ0Ubd4S4ZaiaZhR6JMvuVAs4ibPyK3A/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">计算每个cluster两个组别所占各自总组别的比例</p><pre data-tool="mdnice编辑器"><span></span><code>df &lt;- seurat_integrated@meta.data %&gt;% dplyr::count(seurat_clusters, disease) <br>df$n &lt;- df$n/as.numeric(table(seurat_integrated@meta.data$disease)[df$disease]) <br>print(df)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006912" data-ratio="0.8416666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmMicXz3nN1RicWWHiasG9xcJjrzP8SUIPGbuOBqINcmrgDV5jZlibxdlbibw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmMicXz3nN1RicWWHiasG9xcJjrzP8SUIPGbuOBqINcmrgDV5jZlibxdlbibw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">每个簇的饼图位置</p><pre data-tool="mdnice编辑器"><span></span><code>coords &lt;- cell_eb %&gt;% group_by(cluster) %&gt;% dplyr::summarise(x=median(x), y=median(y)) %&gt;% as.data.frame<br>coords &lt;- coords %&gt;% mutate(x,y)<br>print(coords)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006911" data-ratio="0.5148148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmxe1uZepyiajHszkLj6eibuFoT88G0MxPfjPQlGDSpqyOicrP5eIicdRohg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmxe1uZepyiajHszkLj6eibuFoT88G0MxPfjPQlGDSpqyOicrP5eIicdRohg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">添加半径</p><pre data-tool="mdnice编辑器"><span></span><code>piedf &lt;- reshape2::acast(df, seurat_clusters ~ disease, value.var = <span>"n"</span>)<br>piedf[is.na(piedf)] &lt;- <span>0</span><br>piedf &lt;- as.data.frame(piedf)<br>piedf$cluster &lt;- rownames(piedf)<br>piedf&lt;- merge(piedf, coords)<br>cellnumbers &lt;- dplyr::count(cell_eb, cluster)<br>piedf$cluster &lt;- as.numeric(piedf$cluster)<br>piedf&lt;- arrange(piedf,cluster)<br>sizee &lt;- cellnumbers[match(piedf$cluster, cellnumbers[,<span>1</span>]), <span>2</span>]<br>piedf$radius &lt;- scales::rescale(sizee, c(<span>0.4</span>,<span>0.9</span>))<br>piedf$cluster &lt;- as.character(piedf$cluster)<br>print(piedf)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006914" data-ratio="0.3138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmZ80s5ibNJzBNzTRYxZKlaibrJA0eQhf8yT6uibL8OrgtDAg2H1iaXjTWpg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmZ80s5ibNJzBNzTRYxZKlaibrJA0eQhf8yT6uibL8OrgtDAg2H1iaXjTWpg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">绘制饼图</p><pre data-tool="mdnice编辑器"><span></span><code>p2&lt;-  p1  + <br>  geom_scatterpie(aes_(x=~x,y=~y,r=~radius), data=piedf,<br>                  cols=c(<span>'HC'</span>,<span>'UC'</span>),show.legend = <span>TRUE</span>) +<br>  coord_equal() + scale_fill_manual(values = groupCols,name=<span>NULL</span>)<br>p2<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006919" data-ratio="0.7824074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmyr8lB0CB6hloQCgVlSemu6SUnKzce2xbAPmMPAVu88CLr31nBzMjqQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaC5613OOcbFtyaGA8X9wWUmyr8lB0CB6hloQCgVlSemu6SUnKzce2xbAPmMPAVu88CLr31nBzMjqQ/640?wx_fmt=png&amp;from=appmsg"></figure></section><h3 data-tool="mdnice编辑器"><br></h3></section><p><br></p><h3><span>后记</span></h3><p><br></p><p><span>添加管理员微信 Bio_com或扫描下方二维码<span><strong>交流更多。<br></strong></span></span></p><p><span><span><strong><br></strong></span></span></p><p><span><span>最后，我们推出一个免费赠书活动。这本教材<span>最大的特点是注重实践应用，提供大量案例并配套视频教程，教读者使用SPSS、GraphPad Prism等软件进行实战，确保学以致用。</span></span><span>只需要<span>点赞，在看本文</span>，即可参与抽奖！每800阅读量即可赠送一本，例如本推送阅读量为1700，即可有两名幸运同学即可获取本书，</span><strong><span>备注“赠书</span><span>”</span><span><br></span></strong></span></p><p><span><strong><span><br></span></strong></span></p><section><mp-common-cpsad data-pluginname="mpcps" data-templateid="card" data-traceid="bbf3375d-7b61-4bc0-a28e-6cbca44d9060" data-goodssouce="1" data-pid="101_14751634" data-appuin="3298247369" data-cpsversion="v112"></mp-common-cpsad></section><p><span><strong><span><br></span></strong></span></p><p><span><strong><span><br></span></strong></span></p><p><br></p><p><span>                       </span><img data-cropselx1="0" data-cropselx2="307" data-cropsely1="0" data-cropsely2="307" data-galleryid="" data-imgfileid="100006542" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaB9Vq4TQbMtR81HOfuhy7jkZsUypgwNYHTiaEFuvXNqI8z2nlDYc7tbrJ4o7W7dAgqRQPp2lDqfLbA/640?wx_fmt=png" data-type="png" data-w="512" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaB9Vq4TQbMtR81HOfuhy7jkZsUypgwNYHTiaEFuvXNqI8z2nlDYc7tbrJ4o7W7dAgqRQPp2lDqfLbA/640?wx_fmt=png"></p><p><br></p><span></span><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/EdGdDDLfkqlywZQ_QO11EQ",target="_blank" rel="noopener noreferrer">原文链接</a>
