---
title: "miloR单细胞差异丰度分析"
date: 2024-11-24T01:32:24Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
miloR单细胞差异丰度分析 by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">miloR发表在2021年<em>Nat Biotechnol</em>上，题为《Differential abundance testing on single-cell data using <em>k</em>-nearest neighbor graphs》。简单来说，miloR是一个用于单细胞数据分析的 R 包，专注于细胞间的差异群体丰度（Differential Abundance, DA）分析。它通过构建细胞邻域（Neighborhood）来检测实验条件或生物状态对特定细胞群体分布的影响。miloR提供了一种统计框架，可以从单细胞测序数据中提取新的生物学见解，特别适合研究复杂的生物学体系，如发育、疾病或治疗响应。</p><h3 data-tool="mdnice编辑器"><span></span><span>一. miloR算法的工作流程</span><span></span></h3><p data-tool="mdnice编辑器">尽管差异丰度（Differential abundance, DA）通常在离散细胞簇中进行量化，但 MiloR 使用 KNN 图中的部分重叠细胞邻域。从一个真实反映细胞群体生物学的图开始，Milo 分析包括以下三个步骤：</p><ul data-tool="mdnice编辑器"><li><section>采样代表性邻域；</section></li><li><section>测试所有邻域中条件的差异丰度；</section></li><li><section>使用加权假发现率（FDR）程序考虑多个假设检验，该程序考虑邻域的重叠。</section></li></ul><p data-tool="mdnice编辑器">MiloR算法的工作流程示意图：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100045242" data-ratio="0.487962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZoMD7ib4fL5uHkrUicwRpXps9kzpsXWYx6023KWSD1E07zaTCdZ4Sibr6IA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZoMD7ib4fL5uHkrUicwRpXps9kzpsXWYx6023KWSD1E07zaTCdZ4Sibr6IA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20241115210539230</figcaption></figure><p data-tool="mdnice编辑器">a. 通过一种图采样算法在索引细胞上定义邻域。根据实验设计对细胞进行定量生成计数表。每个邻域的细胞计数使用负二项广义线性模型（GLM）进行建模，并通过假设检验确定差异丰度的邻域。</p><p data-tool="mdnice编辑器">b. KNN 图的力导向布局，展示从两种实验条件中采样的细胞的模拟连续轨迹。</p><p data-tool="mdnice编辑器">c. 使用 Milo 进行假设检验能够准确且特异性地检测出差异丰度的邻域（假发现率 FDR 1%）。红点表示差异丰度的邻域。</p><p data-tool="mdnice编辑器">d. Milo 差异丰度检验结果的图形表示。节点代表邻域，颜色根据其对数倍数变化（log fold change）着色。非差异丰度的邻域（FDR 1%）以白色表示，节点大小与邻域中的细胞数量成比例。图中的边缘表示相邻邻域之间共享的细胞数量。节点布局由力导向嵌入中的邻域索引细胞的位置决定。Nhood 代表邻域。</p><h3 data-tool="mdnice编辑器"><span></span><span>二. miloR代码实现</span><span></span></h3><p data-tool="mdnice编辑器">miloR官方github在https://github.com/MarioniLab/miloR</p><p data-tool="mdnice编辑器">教程在：https://bioconductor.org/packages/release/bioc/vignettes/miloR/inst/doc/milo_demo.html</p><p data-tool="mdnice编辑器">R包安装：</p><pre data-tool="mdnice编辑器"><span></span><code><span>## Milo is available from Bioconductor (preferred stable installation)</span><br><span>if</span> (!requireNamespace(<span>"BiocManager"</span>, quietly = <span>TRUE</span>))<br>    install.packages(<span>"BiocManager"</span>)<br><br>BiocManager::install(<span>"miloR"</span>)<br><br><span>## Install development version</span><br>devtools::install_github(<span>"MarioniLab/miloR"</span>, ref=<span>"devel"</span>) <br></code></pre><ol data-tool="mdnice编辑器"><li><section>Basic Milo example on simulated dataset</section></li><li><section>Milo example on mouse gastrulation dataset: this includes a demo for downstream analysis functions.</section></li><li><section>Integrating miloR in scanpy/anndata workflow (see also <code>milopy</code> for a full workflow in python)</section></li><li><section>Specifying contrasts of interest for differential abundance testing with Milo</section></li><li><section>Using a mixed effect model for dependendent samples</section></li></ol><p data-tool="mdnice编辑器">github上有五个教程。这里我们先看一下第一个基础教程。</p><h4 data-tool="mdnice编辑器"><span></span><span>Step1. 加载示例数据</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#BiocManager::install("miloR")</span><br><span>#BiocManager::install("zellkonverter")</span><br><span>library</span>(miloR)<br><span>library</span>(SingleCellExperiment)<br><span>library</span>(scater)<br><span>library</span>(scran)<br><span>library</span>(dplyr)<br><span>library</span>(patchwork)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>data(<span>"sim_trajectory"</span>, package = <span>"miloR"</span>)<br><br><span>## Extract SingleCellExperiment object</span><br>traj_sce &lt;- sim_trajectory[[<span>'SCE'</span>]]<br><br><span>## Extract sample metadata to use for testing</span><br>traj_meta &lt;- sim_trajectory[[<span>"meta"</span>]]<br><br><span>## Add metadata to colData slot</span><br>colData(traj_sce) &lt;- DataFrame(traj_meta)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>Step2. 数据预处理</span><span></span></h4><p data-tool="mdnice编辑器">为了进行数据分析，我们需要构造一个单细胞的无向KNN图。下面是miloR提供的细胞标准分析代码：</p><pre data-tool="mdnice编辑器"><span></span><code>logcounts(traj_sce) &lt;- log(counts(traj_sce) + <span>1</span>)<br>traj_sce &lt;- runPCA(traj_sce, ncomponents=<span>30</span>)<br>traj_sce &lt;- runUMAP(traj_sce)<br><br>plotUMAP(traj_sce)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100045238" data-ratio="0.8135283363802559" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZoL7lTKkBpHoXAhlV4XNzueho8iaKPbnGM9akcr4ABYPhRXlxAPwo005g/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="547" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZoL7lTKkBpHoXAhlV4XNzueho8iaKPbnGM9akcr4ABYPhRXlxAPwo005g/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20241016151136405</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span><span>Step3. 构建MiloR对象</span><span></span></h4><p data-tool="mdnice编辑器">对于图邻域的差分丰度分析，我们首先构造一个Milo对象。这扩展了singlecelleexperiment类来存储KNN图上的邻域信息。下面提供了不同单细胞数据格式的构建代码：</p><p data-tool="mdnice编辑器"><strong>3.1 From SingleCellExperiment object</strong></p><pre data-tool="mdnice编辑器"><span></span><code>traj_milo &lt;- Milo(traj_sce)<br>reducedDim(traj_milo, <span>"UMAP"</span>) &lt;- reducedDim(traj_sce, <span>"UMAP"</span>)<br><br>traj_milo<br></code></pre><p data-tool="mdnice编辑器"><strong>3.2 From AnnData object (.h5ad)</strong></p><p data-tool="mdnice编辑器">我们可以使用zellkonverter包从保存为h5ad文件的AnnData对象中生成singlecellexexperiment对象。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(zellkonverter)<br><br><span># Obtaining an example H5AD file.</span><br>example_h5ad &lt;- system.file(<span>"extdata"</span>, <span>"krumsiek11.h5ad"</span>,<br>                            package = <span>"zellkonverter"</span>)<br><br>example_h5ad_sce &lt;- readH5AD(example_h5ad)<br>example_h5ad_milo &lt;- Milo(example_h5ad_sce)<br></code></pre><p data-tool="mdnice编辑器"><strong>3.3 From Seurat object</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(Seurat)<br>data(<span>"pbmc_small"</span>)<br>pbmc_small_sce &lt;- as.SingleCellExperiment(pbmc_small)<br>pbmc_small_milo &lt;- Milo(pbmc_small_sce)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>Step4. 构建KNN图</span><span></span></h4><p data-tool="mdnice编辑器">我们需要将KNN图添加到Milo对象中。它以图的格式存储在<code>graph</code>插槽中</p><pre data-tool="mdnice编辑器"><span></span><code>traj_milo &lt;- buildGraph(traj_milo, k = <span>10</span>, d = <span>30</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>Step5. 定义代表性邻域（neighbourhoods）</span><span></span></h4><p data-tool="mdnice编辑器">作者将一个细胞的邻域定义为与其在 KNN 图中通过边相连的细胞群，这个细胞被称为索引细胞（index cell）。为了提高效率，我们不会对每个细胞的邻域进行差异丰度（DA）检验，而是通过一种 KNN 采样算法（参见 Gut et al. 2015）从中选取一部分代表性细胞作为索引进行检验。</p><p data-tool="mdnice编辑器">在采样过程中，需要定义以下参数：</p><ul data-tool="mdnice编辑器"><li><section><strong><code>prop</code></strong>: 随机采样的细胞比例（通常 0.1 - 0.2 即可）。对于少于 30,000 个细胞的数据集，建议使用 <code>prop = 0.1</code>；对于更大的数据集，可以选择 <code>prop = 0.05</code>，这样计算速度更快。</section></li><li><section><strong><code>k</code></strong>: KNN 细化所使用的 k 值（建议与 KNN 图构建时使用的 k 值保持一致）。</section></li><li><section><strong><code>d</code></strong>: KNN 细化所使用的降维数（建议与 KNN 图构建时使用的降维数保持一致）。</section></li><li><section><strong><code>refined</code></strong>: 指定是否使用采样细化算法，或者仅随机选择细胞。默认推荐使用细化算法。只有在数据经过基于图的批次校正算法（如 BBKNN）处理后，可能会考虑改用随机采样，但这种方法会导致 DA 检验结果次优。</section></li><li><section><strong><code>refinement_scheme</code> 和 <code>reduced_dims</code></strong>: 指定使用 PCA 还是图（graph）作为细化方案，默认选择 PCA。</section></li></ul><p data-tool="mdnice编辑器">这些参数可以帮助优化采样过程，提高代表性细胞选择的准确性，同时平衡计算效率和生物学意义。</p><pre data-tool="mdnice编辑器"><span></span><code>traj_milo &lt;- makeNhoods(traj_milo, prop = <span>0.1</span>, k = <span>10</span>, d=<span>30</span>, refined = <span>TRUE</span>)<br></code></pre><p data-tool="mdnice编辑器">一旦我们定义了neighbourhood，最好看看neighbourhood有多大（即每个neighbourhood有多少个细胞）。这会影响数据分析测试的能力。我们可以使用plotNhoodSizeHist函数检查这一点。<strong>根据经验，我们希望拥有超过5 x N_samples的平均邻域大小。否则，您可能会考虑重新运行makeNhoods，增加k和/或prop。</strong></p><pre data-tool="mdnice编辑器"><span></span><code>plotNhoodSizeHist(traj_milo)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100045239" data-ratio="0.8135283363802559" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZoDQh5URTFpQNwf7l8kj7h4jp1lKXY4RCouOFeibdAfwvJyzTzGAepOgA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="547" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZoDQh5URTFpQNwf7l8kj7h4jp1lKXY4RCouOFeibdAfwvJyzTzGAepOgA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20241016151246258</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span><span>Step7. 计算领域中的细胞数量</span><span></span></h4><p data-tool="mdnice编辑器">现在我们要计算每个样本在每个邻域中有多少个细胞。我们需要使用细胞元数据并指定哪一列包含示例信息。</p><pre data-tool="mdnice编辑器"><span></span><code>traj_milo &lt;- countCells(traj_milo, meta.data = data.frame(colData(traj_milo)), samples=<span>"Sample"</span>)<br>head(nhoodCounts(traj_milo))<br><span>## 6 x 6 sparse Matrix of class "dgCMatrix"</span><br><span>##   B_R1 A_R1 A_R2 B_R2 B_R3 A_R3</span><br><span>## 1    6    7    5   12    8   11</span><br><span>## 2   13    2    1   19   21    1</span><br><span>## 3   10    1    1    4    2    2</span><br><span>## 4    8    .    .   14   28    1</span><br><span>## 5    4    6    6    6    7   13</span><br><span>## 6    4    4    4    8    9    6</span><br></code></pre><p data-tool="mdnice编辑器">这将给Milo对象添加一个n \ m矩阵，其中n是邻域的数量，m为实验样本个数。数值表示在一个邻域中计算的每个样本的细胞数。该计数矩阵将用于DA测试。</p><h4 data-tool="mdnice编辑器"><span></span><span>Step8.  差异丰度检验</span><span></span></h4><p data-tool="mdnice编辑器">现在我们都准备好测试不同neighbourhoods的丰度差异。我们在广义线性模型（GLM）框架中实现了这个假设检验，特别是在edgeR中使用负二项GLM实现。</p><p data-tool="mdnice编辑器">我们首先需要考虑我们的实验设计。设计矩阵应使样品与感兴趣的条件相匹配。在这种情况下，"Condition"是我们要测试的协变量。</p><pre data-tool="mdnice编辑器"><span></span><code>traj_design &lt;- data.frame(colData(traj_milo))[,c(<span>"Sample"</span>, <span>"Condition"</span>)]<br>traj_design &lt;- distinct(traj_design)<br>rownames(traj_design) &lt;- traj_design$Sample<br><span>## Reorder rownames to match columns of nhoodCounts(milo)</span><br>traj_design &lt;- traj_design[colnames(nhoodCounts(traj_milo)), , drop=<span>FALSE</span>]<br><br>traj_design<br><span>##      Sample Condition</span><br><span>## B_R1   B_R1         B</span><br><span>## A_R1   A_R1         A</span><br><span>## A_R2   A_R2         A</span><br><span>## B_R2   B_R2         B</span><br><span>## B_R3   B_R3         B</span><br><span>## A_R3   A_R3         A</span><br></code></pre><p data-tool="mdnice编辑器">Milo使用了cydar引入的空间FDR校正的适应性，它解释了邻里之间的重叠。具体来说，每个假设检验的p值由第k个最近邻距离的倒数加权。要使用这个统计数据，我们首先需要在Milo对象中存储最近邻居之间的距离。</p><pre data-tool="mdnice编辑器"><span></span><code>traj_milo &lt;- calcNhoodDistance(traj_milo, d=<span>30</span>)<br></code></pre><p data-tool="mdnice编辑器">现在我们可以做检验分析，明确定义我们的实验设计。</p><pre data-tool="mdnice编辑器"><span></span><code>rownames(traj_design) &lt;- traj_design$Sample<br>da_results &lt;- testNhoods(traj_milo, design = ~ Condition, design.df = traj_design)<br></code></pre><p data-tool="mdnice编辑器">这计算了每个邻域的Fold-change和修正的p值，这表明条件之间是否存在显著的丰度差异。</p><pre data-tool="mdnice编辑器"><span></span><code>da_results %&gt;%<br>  arrange(- SpatialFDR) %&gt;%<br>  head() <br><span>##           logFC   logCPM            F    PValue       FDR Nhood SpatialFDR</span><br><span>## 21 -0.007155451 15.06606 0.0001967759 0.9897851 0.9897851    21  0.9897851</span><br><span>## 30 -0.069989274 14.82502 0.0111343047 0.9161290 0.9456816    30  0.9455256</span><br><span>## 6  -0.184051563 15.33523 0.1301442022 0.7188772 0.7668024     6  0.7637508</span><br><span>## 23 -0.301800195 14.73485 0.1838471716 0.6688084 0.7379955    23  0.7341794</span><br><span>## 10 -0.281676336 15.36561 0.3816259156 0.5580706 0.6377950    10  0.6323192</span><br><span>## 28 -0.348771823 15.10259 0.4158152581 0.5201866 0.6165175    28  0.6106588</span><br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>Step9. 可视化</span><span></span></h4><p data-tool="mdnice编辑器">为了可视化差异丰度（DA）结果，我们构建了一个邻域的抽象图，并将其叠加到单细胞的嵌入图上：</p><pre data-tool="mdnice编辑器"><span></span><code>traj_milo &lt;- buildNhoodGraph(traj_milo)<br><br>plotUMAP(traj_milo) + plotNhoodGraphDA(traj_milo, da_results, alpha=<span>0.05</span>) +<br>  plot_layout(guides=<span>"collect"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100045240" data-ratio="0.5964467005076142" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZoNaye4GSe8hl4lDzd7c7cNPIUJORNRW8R7ATjvbtyD1OrKj5Z5JfcOw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="788" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZoNaye4GSe8hl4lDzd7c7cNPIUJORNRW8R7ATjvbtyD1OrKj5Z5JfcOw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20241115212516767</figcaption></figure><p data-tool="mdnice编辑器">官网的这个教程到这里就结束了。其实第二个教程里还有一些实用的分析及可视化代码，可以将这些结果映射到我们感兴趣的细胞类型上，详见<span>https://rawcdn.githack.com/MarioniLab/miloR/7c7f906b94a73e62e36e095ddb3e3567b414144e/vignettes/milo_gastrulation.html#5_Finding_markers_of_DA_populations</span>：</p><pre data-tool="mdnice编辑器"><span></span><code>traj_milo &lt;- buildNhoodGraph(traj_milo)<br><br><span>## Plot single-cell UMAP</span><br>umap_pl &lt;- plotReducedDim(traj_milo, dimred = <span>"umap"</span>, colour_by=<span>"stage"</span>, text_by = <span>"celltype"</span>, <br>                          text_size = <span>3</span>, point_size=<span>0.5</span>) +<br>  guides(fill=<span>"none"</span>)<br><br><span>## Plot neighbourhood graph</span><br>nh_graph_pl &lt;- plotNhoodGraphDA(traj_milo, da_results, layout=<span>"umap"</span>,alpha=<span>0.1</span>) <br>  <br>umap_pl + nh_graph_pl +<br>  plot_layout(guides=<span>"collect"</span>)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>da_results &lt;- annotateNhoods(traj_milo, da_results, coldata_col = <span>"celltype"</span>)<br>head(da_results)<br><span>##        logFC   logCPM         F      PValue        FDR Nhood SpatialFDR</span><br><span>## 1 -1.8019342 20.07089 1.5747061 0.209611035 0.29435477     1 0.29385683</span><br><span>## 2  4.7439141 19.12468 7.0132433 0.008128239 0.03458566     2 0.03452842</span><br><span>## 3  5.4795871 19.87780 8.6993418 0.003204932 0.02281712     3 0.02248097</span><br><span>## 4 -1.6502089 20.24398 1.2210504 0.269232708 0.36142976     4 0.36054817</span><br><span>## 5  3.2520711 20.61980 3.6364192 0.056612494 0.11608972     5 0.11588354</span><br><span>## 6  0.8336509 19.82476 0.2813193 0.595872418 0.68340624     6 0.68348253</span><br><span>##               celltype celltype_fraction</span><br><span>## 1         ExE endoderm         1.0000000</span><br><span>## 2 Rostral neurectoderm         0.5581395</span><br><span>## 3         ExE endoderm         1.0000000</span><br><span>## 4         ExE ectoderm         1.0000000</span><br><span>## 5         ExE ectoderm         1.0000000</span><br><span>## 6         ExE ectoderm         1.0000000</span><br><br>da_results$celltype &lt;- ifelse(da_results$celltype_fraction &lt; <span>0.7</span>, <span>"Mixed"</span>, da_results$celltype)<br>plotDAbeeswarm(da_results, group.by = <span>"celltype"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100045241" data-ratio="0.9985815602836879" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZo5xicM9Numm4hKYvr6pgSlWBPcLxcJG3ZItOjBr1YaDtFbxlEHjLiaZkA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="705" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosicyBSsfIkvqibd7e3AMVzqZo5xicM9Numm4hKYvr6pgSlWBPcLxcJG3ZItOjBr1YaDtFbxlEHjLiaZkA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20241115213209259</figcaption></figure></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/wI26oaQWMxfCIXnqsRMgLw",target="_blank" rel="noopener noreferrer">原文链接</a>
