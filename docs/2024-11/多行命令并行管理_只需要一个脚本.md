---
title: "多行命令并行管理，只需要一个脚本"
date: 2024-11-10T02:22:54Z
draft: ["false"]
tags: [
  "fetched",
  "小汪Waud"
]
categories: ["Acdemic"]
---
多行命令并行管理，只需要一个脚本 by 小汪Waud
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-mpa-powered-by="yiban.io"><blockquote data-type="2" data-url="" data-author-name="" data-content-utf8-length="45" data-source-title=""><section><section><span></span><span>如果实在无法理解，可以直接翻到最后的使用部分，</span><strong>想要使用冰箱难道一定需要知道冰箱的原理吗？</strong><br></section><section><strong></strong></section></section></blockquote><p data-tool="mdnice编辑器">在上游分析中，多个样本常常要同时分析，为了节省时间我们常常会通过写一个简单的脚本去运行。<br></p><p data-tool="mdnice编辑器">比如对于这样的一个accessionlist，样本数较少</p><pre data-tool="mdnice编辑器"><span></span><code>SRR15927225<br>SRR15927226<br>SRR15927227<br>SRR15927228<br>SRR15927229<br>SRR15927230<br></code></pre><p data-tool="mdnice编辑器">我们先写一个比对的脚本</p><pre data-tool="mdnice编辑器"><span></span><code>awk <span>'{print "hisat2 -p 6 -x ../1_genome/ASM130575v1_genomic -1 ~/donkey_oocyte/3_cleandata/"$1"_1*.gz -2 ~/donkey_oocyte/3_cleandata/"$1"_2*.gz -S ./"$1".sam &amp;"}'</span> accessionlist &gt; hisat2.sh<br>nohup bash hisat2.sh &gt;hisat2.log 2&gt;&amp;1 &amp;<br></code></pre><p data-tool="mdnice编辑器"><span><strong>重点在于print "xxxx &amp;"，引号内的最后为&amp;。</strong></span>我们查看一下hisat2.sh如下</p><pre data-tool="mdnice编辑器"><span></span><code>hisat2 -p 6 -x ../1_genome/ASM130575v1_genomic -1 ~/donkey_oocyte/3_cleandata/SRR15927225_1*.gz -2 ~/donkey_oocyte/3_cleandata/SRR15927225_2*.gz -S ./SRR15927225.sam &amp;<br>hisat2 -p 6 -x ../1_genome/ASM130575v1_genomic -1 ~/donkey_oocyte/3_cleandata/SRR15927226_1*.gz -2 ~/donkey_oocyte/3_cleandata/SRR15927226_2*.gz -S ./SRR15927226.sam &amp;<br>hisat2 -p 6 -x ../1_genome/ASM130575v1_genomic -1 ~/donkey_oocyte/3_cleandata/SRR15927227_1*.gz -2 ~/donkey_oocyte/3_cleandata/SRR15927227_2*.gz -S ./SRR15927227.sam &amp;<br>hisat2 -p 6 -x ../1_genome/ASM130575v1_genomic -1 ~/donkey_oocyte/3_cleandata/SRR15927228_1*.gz -2 ~/donkey_oocyte/3_cleandata/SRR15927228_2*.gz -S ./SRR15927228.sam &amp;<br>hisat2 -p 6 -x ../1_genome/ASM130575v1_genomic -1 ~/donkey_oocyte/3_cleandata/SRR15927229_1*.gz -2 ~/donkey_oocyte/3_cleandata/SRR15927229_2*.gz -S ./SRR15927229.sam &amp;<br>hisat2 -p 6 -x ../1_genome/ASM130575v1_genomic -1 ~/donkey_oocyte/3_cleandata/SRR15927230_1*.gz -2 ~/donkey_oocyte/3_cleandata/SRR15927230_2*.gz -S ./SRR15927230.sam &amp;<br></code></pre><p data-tool="mdnice编辑器">在每一行命令的最后都有一个"&amp;"，表示这六条命令同时读取运行，即在这种情况下该脚本最多会占用6*6=36个线程。</p><p data-tool="mdnice编辑器"><span><strong>我一直都按照上面的方法运行着，直到遇到了34个样本，双端测序共68个文件，我裂开了。</strong></span></p><p data-tool="mdnice编辑器"><span><strong><br></strong></span></p><p data-tool="mdnice编辑器">因为一旦样本过多，我就要考虑到服务器占用率的问题。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3370919881305638" data-src="https://mmbiz.qpic.cn/mmbiz_png/VF1s3XFxX5yCE7eibZCicfqwn1jeT8BNsPfSJ0icrD9j4gAjV3CKDpkzLwjdElDOob3y8HJnVr7IxEbCK5aYrIzlg/640?wx_fmt=png" data-type="png" data-w="1685" src="https://mmbiz.qpic.cn/mmbiz_png/VF1s3XFxX5yCE7eibZCicfqwn1jeT8BNsPfSJ0icrD9j4gAjV3CKDpkzLwjdElDOob3y8HJnVr7IxEbCK5aYrIzlg/640?wx_fmt=png"><figcaption>日常使用的96线程服务器</figcaption></figure><p data-tool="mdnice编辑器">对于我使用的96线程服务器，即使我可以独自使用（往往不可能），我仍需要进行计算：68个文件如果按照以上方法写脚本，那每一个命令所用的线程数至多为1（2×68&gt;96）。如果运行过程中服务器出现了故障或崩溃，所有文件将全部完蛋。这该如何是好？</p><h2 data-tool="mdnice编辑器"><span></span><span>神器submit.sh</span></h2><p data-tool="mdnice编辑器">因此，我向曾老师请教了这个问题，拿到了一个完美的解决办法。即神器submit.sh，代码如下</p><pre data-tool="mdnice编辑器"><span></span><code>cat <span>$1</span> | <span>while</span> <span>read</span> id<br><span>do</span><br>    <span>if</span> ((i%<span>$2</span>==<span>$3</span>))<br>    <span>then</span><br>        <span>$id</span>  <br>    <span>fi</span> <br>i=$((i+1))<br><span>done</span><br></code></pre><p data-tool="mdnice编辑器">最终在执行脚本时就执行以下命令</p><pre data-tool="mdnice编辑器"><span></span><code><span>for</span> i <span>in</span> {0..3};<span>do</span> (nohup bash submit.sh script2.sh 4 <span>$i</span> 2&gt;&amp;1);<span>done</span> <br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>代码解析</span></h2><p data-tool="mdnice编辑器">接下来给大家解析一下这两个命令。</p><p data-tool="mdnice编辑器">在Linux Shell脚本中，<span><strong>$1、$2、$3用来表示传</strong></span><span><strong>入到脚本中对应位置的参数。</strong></span></p><figure data-tool="mdnice编辑器"><img data-ratio="0.22922636103151864" data-src="https://mmbiz.qpic.cn/mmbiz_png/VF1s3XFxX5yCE7eibZCicfqwn1jeT8BNsPVDCgSTGWnme99ibicWYM5u8dmb0OSDymdibBicJfNvrEcxMHoqwXwkZ0pQ/640?wx_fmt=png" data-type="png" data-w="1047" src="https://mmbiz.qpic.cn/mmbiz_png/VF1s3XFxX5yCE7eibZCicfqwn1jeT8BNsPVDCgSTGWnme99ibicWYM5u8dmb0OSDymdibBicJfNvrEcxMHoqwXwkZ0pQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><span><strong>在上面的脚本中$1代表输入给（submit.sh）脚本的第一个参数，即第二个脚本（script2.sh），同理$2代表4，$3代表$i。</strong></span></p><p data-tool="mdnice编辑器"><span><strong><br></strong></span></p><p data-tool="mdnice编辑器">这里我们以包含34行命令的hisat2.sh（script2.sh）为例，hisat2.sh内容如下（命令的最后是没有"&amp;"的）</p><pre data-tool="mdnice编辑器"><span></span><code>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_001_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_001_1*_2.fq.gz -S ./TR_5445_001_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_001_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_001_2*_2.fq.gz -S ./TR_5445_001_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_001_3*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_001_3*_2.fq.gz -S ./TR_5445_001_3.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_002_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_002_1*_2.fq.gz -S ./TR_5445_002_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_002_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_002_2*_2.fq.gz -S ./TR_5445_002_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_002_3*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_002_3*_2.fq.gz -S ./TR_5445_002_3.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_003_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_003_1*_2.fq.gz -S ./TR_5445_003_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_003_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_003_2*_2.fq.gz -S ./TR_5445_003_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_003_3*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_003_3*_2.fq.gz -S ./TR_5445_003_3.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_004_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_004_1*_2.fq.gz -S ./TR_5445_004_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_004_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_004_2*_2.fq.gz -S ./TR_5445_004_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_004_3*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_004_3*_2.fq.gz -S ./TR_5445_004_3.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_005_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_005_1*_2.fq.gz -S ./TR_5445_005_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_005_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_005_2*_2.fq.gz -S ./TR_5445_005_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_005_3*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_005_3*_2.fq.gz -S ./TR_5445_005_3.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_006_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_006_1*_2.fq.gz -S ./TR_5445_006_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_006_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_006_2*_2.fq.gz -S ./TR_5445_006_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_006_3*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_006_3*_2.fq.gz -S ./TR_5445_006_3.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_007_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_007_1*_2.fq.gz -S ./TR_5445_007_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_007_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_007_2*_2.fq.gz -S ./TR_5445_007_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_007_3*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_007_3*_2.fq.gz -S ./TR_5445_007_3.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_008_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_008_1*_2.fq.gz -S ./TR_5445_008_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_008_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_008_2*_2.fq.gz -S ./TR_5445_008_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_009_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_009_1*_2.fq.gz -S ./TR_5445_009_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_009_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_009_2*_2.fq.gz -S ./TR_5445_009_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_010_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_010_1*_2.fq.gz -S ./TR_5445_010_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_010_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_010_2*_2.fq.gz -S ./TR_5445_010_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_011_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_011_1*_2.fq.gz -S ./TR_5445_011_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_011_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_011_2*_2.fq.gz -S ./TR_5445_011_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_012_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_012_1*_2.fq.gz -S ./TR_5445_012_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_012_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_012_2*_2.fq.gz -S ./TR_5445_012_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_013_1*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_013_1*_2.fq.gz -S ./TR_5445_013_1.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_013_2*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_013_2*_2.fq.gz -S ./TR_5445_013_2.sam<br>hisat2 -p 6 -x /home/data/server/reference/index/hisat/hg38/genome -1 /home/xiaowang/proj1115/3_trim/TR_5445_013_3*_1.fq.gz -2 /home/xiaowang/proj1115/3_trim/TR_5445_013_3*_2.fq.gz -S ./TR_5445_013_3.sam<br></code></pre><p data-tool="mdnice编辑器">为了便于大家理解，我们把for in循环的i称作"循环i"，submit.sh中的i称作"行数i"。</p><blockquote data-tool="mdnice编辑器"><p><span><strong>在Linux的shell脚本中，行号是从0开始计数的哦！</strong></span>但如果通过cat -n来查看，行号仍是从1开始显示。下文中提到的第X行命令都指的是shell脚本中的行号。</p></blockquote><figure data-tool="mdnice编辑器"><img data-ratio="0.2590286425902864" data-src="https://mmbiz.qpic.cn/mmbiz_png/VF1s3XFxX5yCE7eibZCicfqwn1jeT8BNsPvJicOkm9MU2Q6YESt056Gq5EyqKkGo8CC81zv6NKWZ2ib1axx1Z6UT1A/640?wx_fmt=png" data-type="png" data-w="1606" src="https://mmbiz.qpic.cn/mmbiz_png/VF1s3XFxX5yCE7eibZCicfqwn1jeT8BNsPvJicOkm9MU2Q6YESt056Gq5EyqKkGo8CC81zv6NKWZ2ib1axx1Z6UT1A/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">系统会在后台依次读取hisat2.sh的每一行，每读一行就会判断【行数i】除以4的余数，如果余数等于【循环i】，就会执行该行命令，<span><strong>命令执行完成</strong></span>，随即if语句结束，【行数i】=【行数i+1】，运行结束。</p><p data-tool="mdnice编辑器">当for in循环的【循环i】=0时，【行数i】先为0，0%4=0=【循环i】，第0行命令执行，【行数i】=0+1=1，1%4=1≠【循环i】，第1行命令被跳过，【行数i】=1+1=2，2%4=2≠【循环i】，第2行命令被跳过，【行数i】=2+1=3，3%4=3≠【循环i】，第3行命令被跳过，【行数i】=3+1=4，4%4=0=【循环i】，第4行命令执行...</p><p data-tool="mdnice编辑器"><span><strong>因此，【循环i】=0时，行数为4，8，12...4n的命令被执行；</strong></span></p><p data-tool="mdnice编辑器"><span><strong>【循环i】=1时，行数为1，5，9...4n+1的命令被执行；</strong></span></p><p data-tool="mdnice编辑器"><span><strong>【循环i】=2时，行数为2，6，10...4n+2的命令被执行；</strong></span></p><p data-tool="mdnice编辑器"><span><strong>【循环i】=3时，行数为3，7，11...4n+3的命令被执行。</strong></span></p><p data-tool="mdnice编辑器">通过这种方式，我们将所有的命令分成了四份。而for in循环语句中的几个循环是并行的，也就代表这4个循环同时进行，即4份命令同时进行，每一份的上一条命令运行结束后，下一条命令才会执行。</p><p data-tool="mdnice编辑器">我们可以简单的把linux系统理解为景区售票处，每一行命令代表一个人，景区因为人流量过大，安排了几个入口，所有人都需要按照一定的规则排队，只有当前面的人通过时，后面的人才能有序通过。</p><h2 data-tool="mdnice编辑器"><span></span><span>如何使用和修改</span></h2><p data-tool="mdnice编辑器">如果实在是理解不了上面的代码也没有关系，<span><strong>想要使用冰箱难道一定需要知道冰箱的原理吗？</strong></span></p><p data-tool="mdnice编辑器">在运行包含多行命令的脚本时，只需要修改下图中红框里的内容。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.22123015873015872" data-src="https://mmbiz.qpic.cn/mmbiz_png/VF1s3XFxX5yCE7eibZCicfqwn1jeT8BNsPCkibdQb0oM1nialBN07qAA3smn7Sb98ticN8xJ8lbaias9SuGmHPlKW9cw/640?wx_fmt=png" data-type="png" data-w="1008" src="https://mmbiz.qpic.cn/mmbiz_png/VF1s3XFxX5yCE7eibZCicfqwn1jeT8BNsPCkibdQb0oM1nialBN07qAA3smn7Sb98ticN8xJ8lbaias9SuGmHPlKW9cw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">同理，如果想要把命令分为10份并行只需要</p><pre data-tool="mdnice编辑器"><span></span><code><span>for</span> i <span>in</span> {0..9};<span>do</span> (nohup bash submit.sh script2.sh 10 <span>$i</span> 2&gt;&amp;1);<span>done</span> <span></span></code></pre></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/NzcH5_DWcXUN2k7NF5czhw",target="_blank" rel="noopener noreferrer">原文链接</a>
