---
title: "【斑马鱼肾脏】多个单细胞数据整合分析（一）"
date: 2024-11-06T06:34:34Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
【斑马鱼肾脏】多个单细胞数据整合分析（一） by 生信菜鸟团
------
<div><section><h2><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247528235&amp;idx=1&amp;sn=bdeb9816ef510d2a2dd4c3ff9a654855&amp;chksm=fa45aa16cd322300f2a26119a0f1ffed8f591836307bf666b1ae0dc8dac4268b7ec7c5763f8b&amp;scene=21#wechat_redirect" textvalue="【斑马鱼肾脏的单细胞数据集合】：脊椎动物的中性粒与巨噬细胞的分子特征" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">【斑马鱼肾脏的单细胞数据集合】：脊椎动物的中性粒与巨噬细胞的分子特征</a>，根据作者善心提供的代码，我们尝试复现一下文章~<br></h2><p><br></p><h2>加载包</h2><pre><span></span><code>library(Seurat)<br><span># BiocManager::install(version = "3.19")</span><br><span># BiocManager::install("org.Dr.eg.db")</span><br>library(<span>'org.Dr.eg.db'</span>)<br><span># BiocManager::install("TxDb.Drerio.UCSC.danRer11.refGene")</span><br>library(<span>'TxDb.Drerio.UCSC.danRer11.refGene'</span>)<br><span># BiocManager::install("BSgenome.Drerio.UCSC.danRer11")</span><br>library(<span>'BSgenome.Drerio.UCSC.danRer11'</span>)<br><span># devtools::install_github("kudusch/ktools@main")</span><br>library(ktools)<br>library(<span>'readr'</span>)<br>library(<span>'AnnotationHub'</span>)<br>library(<span>'genekitr'</span>) <span># for gene name parsing</span><br>library(<span>"hdf5r"</span>)<br>library(dplyr)<br>library(<span>'glmGamPoi'</span>)<br>library(<span>'harmony'</span>)<br>library(<span>'cowplot'</span>)<br>library(<span>'ggplot2'</span>)<br>library(pheatmap)<br></code></pre><h2>Ensemble转换</h2><pre><span></span><code>gse100910 <span>&lt;-</span> read.table(<span>"./rawdata/GSE100910_indrop_counts.txt.gz"</span>, header <span>=</span> <span>TRUE</span>, row.names <span>=</span> <span>1</span>)<br><br><span># 基因ID转换</span><br>ens_GSE100910 <span>&lt;-</span> transId(rownames(gse100910), transTo <span>=</span> <span>"ensembl"</span>, org <span>=</span> <span>'drerio'</span>, unique <span>=</span> <span>TRUE</span>)<br><br><span># 筛选转换成功的基因行</span><br>GSE100910 <span>&lt;-</span> gse100910[rownames(gse100910) <span>%in%</span> ens_GSE100910<span>$</span>input_id,]<br><br>names_GSE100910 <span>&lt;-</span> ens_GSE100910<span>$</span>ensembl[match(rownames(GSE100910),ens_GSE100910<span>$</span>input_id)]<br><br>GSE100910_new <span>&lt;-</span> data.frame(EnsId <span>=</span> names_GSE100910, GSE100910)<br><br><br><span># dir.create("./tidydata")</span><br>write.table(GSE100910_new, <span>"./tidydata/GSE100910-ENSG.txt"</span>,row.names <span>=</span> <span>TRUE</span>, sep<span>=</span><span>","</span>)<br></code></pre><h2>数据merge</h2><pre><span></span><code><span># GSE112438 ---------------------------------------------------------------</span><br><span># 列出所有文件</span><br>files1 <span>&lt;-</span> list.files(<span>"./rawdata/GSE112438/"</span>,pattern <span>=</span> <span>"TD"</span>)<br>files2 <span>&lt;-</span> list.files(<span>"./rawdata/GSE112438/"</span>,pattern <span>=</span> <span>"WKM.*unenriched\\.txt\\.gz$"</span>)<br>files <span>&lt;-</span> <span>c</span>(files1,files2)<br><br><span># 使用循环读取数据并设置列名</span><br>data_list <span>&lt;-</span> lapply(files, <span>function</span>(file) {<br>  file_path <span>&lt;-</span> paste0(<span>"./rawdata/GSE112438/"</span>, file)<br>  sample_id <span>&lt;-</span> strsplit(file, <span>"_"</span>)[[<span>1</span>]][<span>1</span>]<br>  data <span>&lt;-</span> data.frame(read.table(file_path, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>TRUE</span>))<br>  colnames(data) <span>&lt;-</span> paste0(sample_id, <span>"_"</span>, trimws(colnames(data)))<br>  <span>return</span>(data)<br>})<br><br><span># 使用multimerge函数合并数据</span><br>gse112438_unenriched <span>&lt;-</span> data.frame(multimerge(data_list))<br><br><span># 解析行名</span><br>ids_to_parse_gse112438_unenriched <span>&lt;-</span> unlist(strsplit(rownames(gse112438_unenriched), split<span>=</span><span>'_'</span>, fixed <span>=</span> <span>TRUE</span>))<br>ids_gse112438_unenriched <span>&lt;-</span> ids_to_parse_gse112438_unenriched[seq(<span>1</span>, <span>length</span>(ids_to_parse_gse112438_unenriched), <span>2</span>)]<br><br><span># 更新行名并处理缺失值</span><br>rownames(gse112438_unenriched) <span>&lt;-</span> ids_gse112438_unenriched<br>gse112438_unenriched[<span>is.na</span>(gse112438_unenriched)] <span>&lt;-</span> <span>0</span><br><br>write.table(gse112438_unenriched, <span>"./tidydata/GSE112438_unenriched-ENSG.txt"</span>, row.names <span>=</span> <span>TRUE</span>, sep<span>=</span><span>","</span>)<br><br><br><span>### hspcs</span><br>gsm3070124 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070124_WKM10_hspcs.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>colnames(gsm3070124) <span>&lt;-</span> paste0(<span>"gsm3070124_"</span>, trimws(colnames(gsm3070124)))<br><br>gsm3070136 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070136_WKM5_hspcs.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>colnames(gsm3070136) <span>&lt;-</span> paste0(<span>"gsm3070136_"</span>, trimws(colnames(gsm3070136)))<br><br><br>gse112438_hspc <span>&lt;-</span> data.frame(multimerge( <span>list</span> (gsm3070124, gsm3070136 )))<br>ids_to_parse_gse112438_hspc <span>&lt;-</span> unlist(strsplit(rownames(gse112438_hspc), split<span>=</span><span>'_'</span>,fixed <span>=</span> <span>T</span>))<br>ids_gse112438_hspc <span>&lt;-</span> ids_to_parse_gse112438_hspc[seq(<span>1</span>,<span>length</span>(ids_to_parse_gse112438_hspc),<span>2</span>)]<br>rownames(gse112438_hspc) <span>&lt;-</span> ids_gse112438_hspc<br>gse112438_hspc[<span>is.na</span>(gse112438_hspc)] <span>=</span> <span>0</span><br><br>write.table(gse112438_hspc, <span>"./tidydata/GSE112438_hspc-ENSG.txt"</span>, row.names <span>=</span> <span>TRUE</span>, sep<span>=</span><span>","</span>)<br><br><br><span>### lymphocytes</span><br>gsm3070125 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070125_WKM10_lymphocytes.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>colnames(gsm3070125) <span>&lt;-</span> paste0(<span>"gsm3070125_"</span>, trimws(colnames(gsm3070125)))<br><br>gsm3070137 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070137_WKM5_lymphocytes.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>colnames(gsm3070137) <span>&lt;-</span> paste0(<span>"gsm3070137_"</span>, trimws(colnames(gsm3070137)))<br><br>gsm3070139 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070139_WKM6_lymphocytes.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>colnames(gsm3070139) <span>&lt;-</span> paste0(<span>"gsm3070139_"</span>, trimws(colnames(gsm3070139)))<br><br>gse112438_lymphocytes <span>&lt;-</span> data.frame(multimerge( <span>list</span> (gsm3070125, gsm3070137, gsm3070139 )))<br>ids_to_parse_gse112438_lymphocytes <span>&lt;-</span> unlist(strsplit(rownames(gse112438_lymphocytes), split<span>=</span><span>'_'</span>,fixed <span>=</span> <span>T</span>))<br>ids_gse112438_lymphocytes <span>&lt;-</span> ids_to_parse_gse112438_lymphocytes[seq(<span>1</span>,<span>length</span>(ids_to_parse_gse112438_lymphocytes),<span>2</span>)]<br>rownames(gse112438_lymphocytes) <span>&lt;-</span> ids_gse112438_lymphocytes<br>gse112438_lymphocytes[<span>is.na</span>(gse112438_lymphocytes)] <span>=</span> <span>0</span><br><br>write.table(gse112438_lymphocytes, <span>"./tidydata/GSE112438_lymphocytes-ENSG.txt"</span>, row.names <span>=</span> <span>TRUE</span>, sep<span>=</span><span>","</span>)<br><br><br><br><span>### eosinophils</span><br>gsm3070143 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070143_WKM8_eosinophils_and_lymphocytes.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>gsm3070128 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070128_WKM2_classicalgate-eosinophils.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>gsm3070131 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070131_WKM3_classicalgate-eosinophils.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>gsm3070129 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070129_WKM2_eosinophils.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>gsm3070132 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070132_WKM3_eosinophils.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>gsm3070134 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070134_WKM4_eosinophils.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>gsm3070146 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070146_WKM9_eosinophils.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br><br>colnames(gsm3070143) <span>&lt;-</span> paste0(<span>"gsm3070143_"</span>, trimws(colnames(gsm3070143)))<br>colnames(gsm3070128) <span>&lt;-</span> paste0(<span>"gsm3070128_"</span>, trimws(colnames(gsm3070128)))<br>colnames(gsm3070131) <span>&lt;-</span> paste0(<span>"gsm3070131_"</span>, trimws(colnames(gsm3070131)))<br>colnames(gsm3070129) <span>&lt;-</span> paste0(<span>"gsm3070129_"</span>, trimws(colnames(gsm3070129)))<br>colnames(gsm3070132) <span>&lt;-</span> paste0(<span>"gsm3070132_"</span>, trimws(colnames(gsm3070132)))<br>colnames(gsm3070134) <span>&lt;-</span> paste0(<span>"gsm3070134_"</span>, trimws(colnames(gsm3070134)))<br>colnames(gsm3070146) <span>&lt;-</span> paste0(<span>"gsm3070146_"</span>, trimws(colnames(gsm3070146)))<br><br><br>gse112438_eosinophils <span>&lt;-</span> data.frame(multimerge( <span>list</span> ( gsm3070143, gsm3070128, gsm3070131, gsm3070129, gsm3070132, gsm3070134, gsm3070146 )))<br><br>ids_to_parse_gse112438_eosinophils <span>&lt;-</span> unlist(strsplit(rownames(gse112438_eosinophils), split<span>=</span><span>'_'</span>,fixed <span>=</span> <span>T</span>))<br>ids_gse112438_eosinophils <span>&lt;-</span> ids_to_parse_gse112438_eosinophils[seq(<span>1</span>,<span>length</span>(ids_to_parse_gse112438_eosinophils),<span>2</span>)]<br>rownames(gse112438_eosinophils) <span>&lt;-</span> ids_gse112438_eosinophils<br>gse112438_eosinophils[<span>is.na</span>(gse112438_eosinophils)] <span>=</span> <span>0</span><br><br>write.table(gse112438_eosinophils, <span>"./tidydata/GSE112438_eosinophils-ENSG.txt"</span>, row.names <span>=</span> <span>TRUE</span>, sep<span>=</span><span>","</span>)<br><br><span>### monocytes</span><br>gsm3070144 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070144_WKM8_monocytes.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>gsm3070147 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070147_WKM9_monocytes.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br>gsm3070141 <span>&lt;-</span> read.table(<span>'./rawdata/GSE112438/GSM3070141_WKM7_monocytes.txt.gz'</span>, sep <span>=</span> <span>"\t"</span>, row.names <span>=</span> <span>1</span>, header <span>=</span> <span>T</span>)<br><br>colnames(gsm3070144) <span>&lt;-</span> paste0(<span>"gsm3070144_"</span>, trimws(colnames(gsm3070144)))<br>colnames(gsm3070147) <span>&lt;-</span> paste0(<span>"gsm3070147_"</span>, trimws(colnames(gsm3070147)))<br>colnames(gsm3070141) <span>&lt;-</span> paste0(<span>"gsm3070141_"</span>, trimws(colnames(gsm3070141)))<br><br>gse112438_monocytes <span>&lt;-</span> data.frame(multimerge( <span>list</span> ( gsm3070144, gsm3070147, gsm3070141)))<br><br>ids_to_parse_gse112438_monocytes <span>&lt;-</span> unlist(strsplit(rownames(gse112438_monocytes), split<span>=</span><span>'_'</span>,fixed <span>=</span> <span>T</span>))<br>ids_gse112438_monocytes <span>&lt;-</span> ids_to_parse_gse112438_monocytes[seq(<span>1</span>,<span>length</span>(ids_to_parse_gse112438_monocytes),<span>2</span>)]<br>rownames(gse112438_monocytes) <span>&lt;-</span> ids_gse112438_monocytes<br>gse112438_monocytes[<span>is.na</span>(gse112438_monocytes)] <span>=</span> <span>0</span><br><br>write.table(gse112438_monocytes, <span>"./tidydata/gse112438_monocytes-ENSG.txt"</span>, row.names <span>=</span> <span>TRUE</span>, sep<span>=</span><span>","</span>)<br></code></pre><p>使用multimerge函数合并数据：</p><pre><span></span><code>multimerge <span>&lt;-</span> <span>function</span> (mylist) {<br>  <span>## mimics a recursive merge or full outer join</span><br> <br>  unames <span>&lt;-</span> unique(unlist(lapply(mylist, rownames)))<br> <br>  n <span>&lt;-</span> <span>length</span>(unames)<br> <br>  out <span>&lt;-</span> lapply(mylist, <span>function</span>(df) {<br> <br>    tmp <span>&lt;-</span> matrix(nr <span>=</span> n, nc <span>=</span> ncol(df), <span>dimnames</span> <span>=</span> <span>list</span>(unames,colnames(df)))<br>    tmp[rownames(df), ] <span>&lt;-</span> as.matrix(df)<br>    rm(df); gc()<br> <br>    <span>return</span>(tmp)<br>  })<br> <br>  stopifnot( <span>all</span>( sapply(out, <span>function</span>(x) identical(rownames(x), unames)) ) )<br> <br>  bigout <span>&lt;-</span> do.call(cbind, out)<br>  colnames(bigout) <span>&lt;-</span> paste(<span>rep</span>(<span>names</span>(mylist), sapply(mylist, ncol)), unlist(sapply(mylist, colnames)), sep <span>=</span> <span>"_"</span>)<br>  <span>return</span>(bigout)<br>}<br></code></pre><h2>创建Seurat对象</h2><pre><span></span><code>GSE112438_eosinophils[<span>is.na</span>(GSE112438_eosinophils)] <span>=</span> <span>0</span><br>GSE112438_hspc[<span>is.na</span>(GSE112438_hspc)] <span>=</span> <span>0</span><br>GSE112438_lymphocytes[<span>is.na</span>(GSE112438_lymphocytes)] <span>=</span> <span>0</span><br>GSE112438_unenriched[<span>is.na</span>(GSE112438_unenriched)] <span>=</span> <span>0</span><br></code></pre><pre><span></span><code>GSE112438_eosinophils <span>&lt;-</span> CreateSeuratObject(GSE112438_eosinophils, project <span>=</span> <span>"GSE112438_eosinophils"</span>, min.cells <span>=</span> <span>10</span>, min.features <span>=</span> <span>200</span>)<br>GSE112438_hspc <span>&lt;-</span> CreateSeuratObject(GSE112438_hspc, project <span>=</span> <span>"GSE112438_hspc"</span>, min.cells <span>=</span> <span>10</span>, min.features <span>=</span> <span>200</span>)<br>GSE112438_lymphocytes <span>&lt;-</span> CreateSeuratObject(GSE112438_lymphocytes, project <span>=</span> <span>"GSE112438_lymphocytes"</span>, min.cells <span>=</span> <span>10</span>, min.features <span>=</span> <span>200</span>)<br>GSE112438_unenriched <span>&lt;-</span> CreateSeuratObject(GSE112438_unenriched, project <span>=</span> <span>"GSE112438_unenriched"</span>, min.cells <span>=</span> <span>10</span>, min.features <span>=</span> <span>200</span>)<br></code></pre><h2>整合</h2><pre><span></span><code>sc_all_datasets <span>&lt;-</span> <span>c</span>(GSE112438_eosinophils, GSE112438_hspc, GSE112438_lymphocytes, GSE112438_unenriched)<br></code></pre><pre><span></span><code>integration_features <span>&lt;-</span> SelectIntegrationFeatures(object.list <span>=</span> sc_all_datasets, nfeatures <span>=</span> <span>2500</span>)<br>sc_all_datasets <span>&lt;-</span> PrepSCTIntegration(object.list <span>=</span> sc_all_datasets, anchor.features <span>=</span> integration_features)<br>sc_gsm_anchors <span>&lt;-</span> FindIntegrationAnchors(object.list <span>=</span> sc_all_datasets, normalization.method <span>=</span> <span>"SCT"</span>, anchor.features <span>=</span> integration_features, reduction <span>=</span> <span>"rpca"</span>)<br></code></pre><pre><span></span><code>sc_gsm_integrated <span>&lt;-</span> IntegrateData(anchorset <span>=</span> sc_gsm_anchors, normalization.method <span>=</span> <span>"SCT"</span>, new.assay.name <span>=</span> <span>"seurat.integration"</span>)<br>DefaultAssay(sc_gsm_integrated) <span>&lt;-</span> <span>"seurat.integration"</span><br></code></pre></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/N_whaEcAX8c3wJotCvIUDg",target="_blank" rel="noopener noreferrer">原文链接</a>
