---
title: "【Tidyverse优雅编程】SQL案例：R语言操作PostgreSQL数据库"
date: 2025-04-27T00:28:57Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
【Tidyverse优雅编程】SQL案例：R语言操作PostgreSQL数据库 by R语言与数学建模
------
<div><p data-first-child="" data-pid="Z8qhJRmF" data-pm-slice="0 0 []"><span leaf="">本篇是这篇知乎文章的 </span><code><span leaf="">R语言版</span></code><span leaf=""> 复现：</span></p><h1 data-pm-slice="0 0 []"><span leaf=""><span textstyle="">SQL案例分析：2025第一季度全国各省GDP数据</span></span></h1><p data-first-child="" data-pid="Z8qhJRmF" data-pm-slice="0 0 []"><span leaf="">https://zhuanlan.zhihu.com/p/1899379169223247415</span></p><p data-first-child="" data-pid="Z8qhJRmF" data-pm-slice="0 0 []"><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"p","attributes":{"data-pid":"femy64Dq","style":"margin: 1.4em 0px; color: rgb(25, 27, 31); font-family: -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"PingFang SC\", \"Microsoft YaHei\", \"Source Han Sans SC\", \"Noto Sans CJK SC\", \"WenQuanYi Micro Hei\", sans-serif; font-size: medium; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'>我之前的数据库文章，都是从现成的数据文件创建 DuckDB 数据表，本篇把其它数据库创建数据表的过程也做了：不需要搭建数据库环境，直接用 R 语言读取 </span><b><span leaf="">PostgreSQL </span></b><span leaf="">数据库的 SQL 代码文件（</span><code><span leaf="">.sql</span></code><span leaf=""> 文件，创建数据库数据表的代码文件），创建 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 数据库， 并完成数据操作。</span></p><hr><p data-pid="femy64Dq"><span leaf=""><br></span></p><h2><span leaf="">1 从 </span><code><span leaf="">.sql</span></code><span leaf=""> 文件创建数据表</span></h2><p data-pid="m1ZHWsJs"><span leaf="">原文作者提供的 </span><code><span leaf="">gdp_data.sql</span></code><span leaf=""> 文件 ，用文本文档打开如下：</span></p><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002995" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlPaXQMA05ibyw4qcPQskkthI1Pniapp4HBT790h8ayN5rE5da4S76TpFg/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="633" width="1170" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlPaXQMA05ibyw4qcPQskkthI1Pniapp4HBT790h8ayN5rE5da4S76TpFg/640?wx_fmt=other&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002989" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlGHkXamZ8br0nWVNF2n2KE6iblYDR2Yhm4dIK2EOZ1hkOWibYOHsCR6Hg/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="1119" width="1168" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlGHkXamZ8br0nWVNF2n2KE6iblYDR2Yhm4dIK2EOZ1hkOWibYOHsCR6Hg/640?wx_fmt=other&amp;from=appmsg"></section></figure><p data-pid="EEwjeJYo"><span leaf="">正常是在 </span><b><span leaf="">PostgreSQL </span></b><span leaf="">数据库执行这个 </span><code><span leaf="">.sql</span></code><span leaf=""> 文件，我现在是不用 </span><b><span leaf="">PostgreSQL </span></b><span leaf="">数据库，直接用 R 语言搞定一切，使用不需搭建环境的 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 数据库。</span></p><p data-pid="1doby097"><span leaf="">加载包：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">tidyverse</span></span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">)</span></span><span><span leaf="">#</span></span><span><span leaf="">将自动加载DBI包</span></span></code></pre><h3><span leaf="">(1) 连接 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 数据库</span></h3><pre><code><span><span leaf="">con</span></span><span><span leaf="">=</span></span><span><span leaf="">dbConnect</span></span><span><span leaf="">(</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">(),</span></span><span><span leaf="">"data/gdp_data.ddb"</span></span><span><span leaf="">)</span></span></code></pre><h3><span leaf="">(2) 读取 </span><code><span leaf="">.sql</span></code><span leaf=""> 文件，借助正则表达式进行必要的清洗</span></h3><ul><li><section><span leaf="">DuckDB 直接使用数据表名字，不需要加 </span><code><span leaf="">public.</span></code><span leaf="">前缀</span></section></li><li><section><span leaf="">DuckDB 不支持 </span><code><span leaf="">COMMENT ON</span></code><span leaf="">语法（注释语句），删除相关语句（或者变成#注释）</span></section></li></ul><pre><code><span><span leaf="">sq</span></span><span><span leaf="">=</span></span><span><span leaf="">read_file</span></span><span><span leaf="">(</span></span><span><span leaf="">"data/gdp_data.sql"</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">str_remove_all</span></span><span><span leaf="">(</span></span><span><span leaf="">"public\\.|\r\nCOMMENT.*?;"</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="pXYr4JLx"><span leaf="">接着，R 中执行</span><code><span leaf="">DBI</span></code><span leaf=""> 查询每次只能查询一条 </span><code><span leaf="">SQL</span></code><span leaf=""> 语句，所以，需要按 </span><code><span leaf="">;</span></code><span leaf=""> 切分，再过滤掉切出来的最后一个空 </span><code><span leaf="">""</span></code><span leaf="">语句：</span></p><pre><code><span><span leaf="">sqs</span></span><span><span leaf="">=</span></span><span><span leaf="">str_split_1</span></span><span><span leaf="">(</span></span><span><span leaf="">sq</span></span><span><span leaf="">,</span></span><span><span leaf="">";\r\n"</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">str_subset</span></span><span><span leaf="">(</span></span><span><span leaf="">".+"</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="TqGu5anY"><span leaf="">总共是 5 条查询语句，查看一下：</span></p><pre><code><span><span leaf="">sqs</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002990" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUliaZIpjo5Je7QkfyzZmezuWfonUfoUPeGot5lyyRtLRCKEia2qrIV7rZw/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="1109" width="1458" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUliaZIpjo5Je7QkfyzZmezuWfonUfoUPeGot5lyyRtLRCKEia2qrIV7rZw/640?wx_fmt=other&amp;from=appmsg"></section></figure><p data-pid="8oOqyfrH"><b><span leaf="">注：</span></b><code><span leaf="">\r\n</span></code><span leaf=""> 代表回车换行不影响使用，或者用 </span><code><span leaf="">cat()</span></code><span leaf=""> 查看它们是正常观感的。</span></p><h3><span leaf="">(3) 执行批量查询，创建数据表</span></h3><pre><code><span><span leaf="">walk</span></span><span><span leaf="">(</span></span><span><span leaf="">sqs</span></span><span><span leaf="">,</span></span><span><span leaf="">\</span></span><span><span leaf="">(</span></span><span><span leaf="">x</span></span><span><span leaf="">)</span></span><span><span leaf="">dbExecute</span></span><span><span leaf="">(</span></span><span><span leaf="">con</span></span><span><span leaf="">,</span></span><span><span leaf="">x</span></span><span><span leaf="">))</span></span></code></pre><p data-pid="s70pC4jt"><b><span leaf="">注：</span></b><span leaf="">复杂 SQL 代码不一定这么顺利，可能需要调试清洗代码和处理异常。</span></p><h3><span leaf="">(4) 获取数据</span></h3><pre><code><span><span leaf="">gdp</span></span><span><span leaf="">=</span></span><span><span leaf="">tbl</span></span><span><span leaf="">(</span></span><span><span leaf="">con</span></span><span><span leaf="">,</span></span><span><span leaf="">"gdp_data"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">gdp</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002988" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUl7NmNES7DkZsjaYDOM5uRmyCzWyficiaia7FrjUKkGnrq8uicKnNibLwzyEg/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="534" width="1110" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUl7NmNES7DkZsjaYDOM5uRmyCzWyficiaia7FrjUKkGnrq8uicKnNibLwzyEg/640?wx_fmt=other&amp;from=appmsg"></section></figure><h2><span leaf="">2 SQL 数据操作</span></h2><h3><span leaf="">2.1 2025Q1各地区GDP排名前10列表</span></h3><pre><code><span><span leaf="">top10</span></span><span><span leaf="">=</span></span><span><span leaf="">gdp</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">select</span></span><span><span leaf="">(</span></span><span><span leaf="">area_name</span></span><span><span leaf="">,</span></span><span><span leaf="">q1_2025</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">slice_max</span></span><span><span leaf="">(</span></span><span><span leaf="">q1_2025</span></span><span><span leaf="">,</span></span><span><span leaf="">n</span></span><span><span leaf="">=</span></span><span><span leaf="">10</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">collect</span></span><span><span leaf="">()</span></span><br><span><span leaf="">top10</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002987" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlyPwOsqnINvuVLV2WUkp4lz4N4JrHqIUA9iawrT4vY9zBDpOhwBTualA/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="409" width="328" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlyPwOsqnINvuVLV2WUkp4lz4N4JrHqIUA9iawrT4vY9zBDpOhwBTualA/640?wx_fmt=other&amp;from=appmsg"></section></figure><p data-pid="r-Qkx7SX"><span leaf="">再加一列“火苗”的话，需要接一个表格处理：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">gt</span></span><span><span leaf="">)</span></span><br><span><span leaf="">gt</span></span><span><span leaf="">(</span></span><span><span leaf="">top10</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">cols_add</span></span><span><span leaf="">(</span></span><span><span leaf="">Repeat</span></span><span><span leaf="">=</span></span><span><span leaf="">round</span></span><span><span leaf="">(</span></span><span><span leaf="">q1_2025</span></span><span><span leaf="">/</span></span><span><span leaf="">2000</span></span><span><span leaf="">))</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">text_transform</span></span><span><span leaf="">(</span></span><span><span leaf="">locations</span></span><span><span leaf="">=</span></span><span><span leaf="">cells_body</span></span><span><span leaf="">(</span></span><span><span leaf="">columns</span></span><span><span leaf="">=</span></span><span><span leaf="">Repeat</span></span><span><span leaf="">),</span></span><br><span><span leaf="">fn</span></span><span><span leaf="">=</span></span><span><span leaf="">\</span></span><span><span leaf="">(</span></span><span><span leaf="">x</span></span><span><span leaf="">)</span></span><span><span leaf="">str_dup</span></span><span><span leaf="">(</span></span><span><span leaf="">" "</span></span><span><span leaf="">,</span></span><span><span leaf="">x</span></span><span><span leaf="">))</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">tab_style</span></span><span><span leaf="">(</span></span><span><span leaf="">style</span></span><span><span leaf="">=</span></span><span><span leaf="">cell_text</span></span><span><span leaf="">(</span></span><span><span leaf="">align</span></span><span><span leaf="">=</span></span><span><span leaf="">"left"</span></span><span><span leaf="">),</span></span><br><span><span leaf="">locations</span></span><span><span leaf="">=</span></span><span><span leaf="">cells_body</span></span><span><span leaf="">(</span></span><span><span leaf="">columns</span></span><span><span leaf="">=</span></span><span><span leaf="">Repeat</span></span><span><span leaf="">))</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002992" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlyC7sDztDwHOlSNeS4tPjIuMm5H42Gpp5QGflQVNhTz1o73xqsqzT1Q/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="702" width="939" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlyC7sDztDwHOlSNeS4tPjIuMm5H42Gpp5QGflQVNhTz1o73xqsqzT1Q/640?wx_fmt=other&amp;from=appmsg"></section></figure><p data-pid="om_BLBIp"><span leaf="">附 emoji 图标获取网站: </span><code><span leaf="">https://emojipedia.org/</span></code></p><h3><span leaf="">2.2 比较2025Q1与2024Q4的GDP排名, 以发现变化</span></h3><pre><code><span><span leaf="">gdp</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">select</span></span><span><span leaf="">(</span></span><span><span leaf="">area_name</span></span><span><span leaf="">,</span></span><span><span leaf="">q1_2025</span></span><span><span leaf="">,</span></span><span><span leaf="">q4_2024</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">mutate</span></span><span><span leaf="">(</span></span><span><span leaf="">rank_2025</span></span><span><span leaf="">=</span></span><span><span leaf="">min_rank</span></span><span><span leaf="">(</span></span><span><span leaf="">-</span></span><span><span leaf="">q1_2025</span></span><span><span leaf="">),</span></span><span><span leaf="">rank_2024</span></span><span><span leaf="">=</span></span><span><span leaf="">min_rank</span></span><span><span leaf="">(</span></span><span><span leaf="">-</span></span><span><span leaf="">q4_2024</span></span><span><span leaf="">),</span></span><br><span><span leaf="">diff</span></span><span><span leaf="">=</span></span><span><span leaf="">rank_2024</span></span><span><span leaf="">-</span></span><span><span leaf="">rank_2025</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">arrange</span></span><span><span leaf="">(</span></span><span><span leaf="">rank_2025</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">collect</span></span><span><span leaf="">()</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002993" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUldn2rJNzLDEM5OBg94bvbszibMrEsTibFNVftibXGBoqJzjHb1icvkiaV65A/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="472" width="871" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUldn2rJNzLDEM5OBg94bvbszibMrEsTibFNVftibXGBoqJzjHb1icvkiaV65A/640?wx_fmt=other&amp;from=appmsg"></section></figure><h3><span leaf="">2.3 2025Q1与2024Q1同比增长</span></h3><pre><code><span><span leaf="">gdp</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">select</span></span><span><span leaf="">(</span></span><span><span leaf="">area_name</span></span><span><span leaf="">,</span></span><span><span leaf="">q1_2025</span></span><span><span leaf="">,</span></span><span><span leaf="">q1_2024</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">mutate</span></span><span><span leaf="">(</span></span><span><span leaf="">`</span></span><span><span leaf="">同比增长率</span></span><span><span leaf="">（%）`</span></span><span><span leaf="">=</span></span><span><span leaf="">(</span></span><span><span leaf="">q1_2025</span></span><span><span leaf="">-</span></span><span><span leaf="">q1_2024</span></span><span><span leaf="">)</span></span><span><span leaf="">/</span></span><span><span leaf="">q1_2024</span></span><span><span leaf="">*</span></span><span><span leaf="">100</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">arrange</span></span><span><span leaf="">(</span></span><span><span leaf="">-</span></span><span><span leaf="">`</span></span><span><span leaf="">同比增长率</span></span><span><span leaf="">（%）`</span></span><span><span leaf="">)</span></span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span><span leaf="">collect</span></span><span><span leaf="">()</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002991" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlxE6iasNNhUtESXQcH58SF2U25eWsDqiciaHGz2CjjbPV1fQIcxYDB8pTw/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="475" width="760" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDVURRgJ7S2t3MtsibDFOHUlxE6iasNNhUtESXQcH58SF2U25eWsDqiciaHGz2CjjbPV1fQIcxYDB8pTw/640?wx_fmt=other&amp;from=appmsg"></section></figure><p data-pid="i3JzRz3e"><span leaf="">最后，关闭连接</span></p><pre><code><span><span leaf="">dbDisconnect</span></span><span><span leaf="">(</span></span><span><span leaf="">con</span></span><span><span leaf="">)</span></span></code></pre><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/1MM688UkS5FcKXPQ5y1zgQ",target="_blank" rel="noopener noreferrer">原文链接</a>
