---
title: "单细胞层面的表达量差异分析到底如何做"
date: 2025-04-07T02:49:21Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞层面的表达量差异分析到底如何做 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>差异分析当之无愧的是最常见的数据分析手段了，无论是转录组测序还是表达量芯片或者是蛋白质代谢组技术，最后都会得到数值矩阵。一般来说行是基因或者蛋白质等特征，这个可以很多，成百上千甚至过万。而列通常是样品，样品就有有表型，如果是两分组就自然而然的做差异分析了。大家手上都是有成熟的流程和代码，其实也就是跑了一下代码，十几分钟的事情。如果是需要理解图表的生物学含义，就需要看我六年前的<strong>表达芯片的公共数据库挖掘系</strong>列推文即可；</p></blockquote><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486063&amp;idx=1&amp;sn=156bee5397e979722b36b78284188538&amp;scene=21#wechat_redirect" data-linktype="2">解读GEO数据存放规律及下载，一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486054&amp;idx=1&amp;sn=209975adee162228cfe6e6c5065c5c8c&amp;scene=21#wechat_redirect" data-linktype="2">解读SRA数据库规律一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486087&amp;idx=1&amp;sn=1e775a1c3e215384e381953a9fa74ec3&amp;scene=21#wechat_redirect" data-linktype="2">从GEO数据库下载得到表达矩阵 一文就够</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486090&amp;idx=1&amp;sn=62374fbdd4f20c3185beb6568bbeb3e9&amp;scene=21#wechat_redirect" data-linktype="2">GSEA分析一文就够（单机版+R语言版）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486112&amp;idx=1&amp;sn=67a2104c62222bcb139623699f874a6c&amp;scene=21#wechat_redirect" data-linktype="2">根据分组信息做差异分析- 这个一文不够的</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247486120&amp;idx=1&amp;sn=14d7892c1beec2fb9cdfc0ec0aba3e4e&amp;scene=21#wechat_redirect" data-linktype="2">差异分析得到的结果注释一文就够</a></section></li></ul><p data-tool="mdnice编辑器">现在单细胞技术的大行其道，让我们的表达量矩阵里面的列也变成了成百上千甚至过万了，首先它们属于不同的样品，如果是10x技术的单细胞转录组，每个样品可以有5到8千的单细胞列，其次呢我们通常是做多个单细胞样品，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508661&amp;idx=1&amp;sn=37715716398842f760b22589450069dd&amp;scene=21#wechat_redirect" data-linktype="2">2个分组的单细胞项目标准分析</a>，这样的话不同样品也可以有表型分组，比如处理组和对照组。</p><p data-tool="mdnice编辑器">拿到了一个单细胞表达量矩阵，默认需要进行：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2"> 单细胞聚类分群注释</a> ，如果你对单细胞数据分析还没有基础认知，可以看基础10讲：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486076&amp;idx=1&amp;sn=52bb851d7dc23461233a2cf458736151&amp;scene=21#wechat_redirect" data-linktype="2">01. 上游分析流程</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486082&amp;idx=1&amp;sn=03cadceffb2c14ba95d97fe5caf38d94&amp;scene=21#wechat_redirect" data-linktype="2">02.课题多少个样品，测序数据量如何</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486088&amp;idx=1&amp;sn=3a115338ee4937d20caab78627237553&amp;scene=21#wechat_redirect" data-linktype="2">03. 过滤不合格细胞和基因（数据质控很重要）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486096&amp;idx=1&amp;sn=1a99c4c5800b7e0287db3e8ef369fab8&amp;scene=21#wechat_redirect" data-linktype="2">04. 过滤线粒体核糖体基因</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486098&amp;idx=1&amp;sn=bf9a71df848d74fe665ce7d5e283d5ff&amp;scene=21#wechat_redirect" data-linktype="2">05. 去除细胞效应和基因效应</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486260&amp;idx=1&amp;sn=c6abf658de73594d1d77d8e1ffa7d153&amp;scene=21#wechat_redirect" data-linktype="2">06.单细胞转录组数据的降维聚类分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486271&amp;idx=1&amp;sn=638b434b6deee63206af1c0eeda175ab&amp;scene=21#wechat_redirect" data-linktype="2">07.单细胞转录组数据处理之细胞亚群注释</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486278&amp;idx=1&amp;sn=91250ef733833ff00371818b215dc124&amp;scene=21#wechat_redirect" data-linktype="2">08.把拿到的亚群进行更细致的分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486287&amp;idx=1&amp;sn=49627c638ff9c04418282c53518aa7c7&amp;scene=21#wechat_redirect" data-linktype="2">09.单细胞转录组数据处理之细胞亚群比例比较</a></section></li></ul><h3 data-tool="mdnice编辑器"><span></span>找各个单细胞亚群特异性高表达量基因（FindAllMarkers函数）<span></span></h3><p data-tool="mdnice编辑器">我们以大家熟知的pbmc3k数据集为例，大家先安装这个数据集对应的包，并且对它进行降维聚类分群，参考前面的例子：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247497956&amp;idx=1&amp;sn=5d4deb7cf7b7848b3e2273cbd663bb6a&amp;scene=21#wechat_redirect" data-linktype="2">人人都能学会的单细胞聚类分群注释</a> ，而且每个亚群找高表达量基因，都存储为Rdata文件。标准代码是：</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout=<span>10000</span>)<br><span>#InstallData("pbmc3k")  </span><br>data(<span>"pbmc3k"</span>)  <br>sce &lt;- pbmc3k.final  <br><span>library</span>(Seurat)<br>table(Idents(sce))<br>DimPlot(sce,label = <span>T</span>)<br>sce.markers &lt;- FindAllMarkers(object = sce, only.pos = <span>TRUE</span>, <br>                              min.pct = <span>0.25</span>, <br>                              thresh.use = <span>0.25</span>)<br><span>library</span>(dplyr) <br>top3 &lt;- sce.markers %&gt;% group_by(cluster) %&gt;% top_n(<span>3</span>, avg_log2FC)<br>DoHeatmap(sce ,top3$gene,size=<span>3</span>)<br></code></pre><p data-tool="mdnice编辑器">会得到热图，展现每个单细胞亚群特异性高表达量基因的前3个，它其实就是一种差异分析了，这个时候它对比的是每个单细胞亚群和所有的其它细胞。而且这个差异分析，并不需要考虑样品效应，虽然我们上面演示的是大家熟知的pbmc3k数据集，是单个样品的，但是哪怕是大家拿到的是多个单细胞样品，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508661&amp;idx=1&amp;sn=37715716398842f760b22589450069dd&amp;scene=21#wechat_redirect" data-linktype="2">2个分组的单细胞项目标准分析</a>，也很容易整合后，分群后仍然是可以跑FindAllMarkers函数。</p><h3 data-tool="mdnice编辑器"><span></span>两个亚群针对性差异分析（FindMarkers函数）<span></span></h3><p data-tool="mdnice编辑器">仍然是以大家熟知的pbmc3k数据集为例，我们把两个不同的单核细胞都去跟b细胞进行差异分析，使用FindMarkers函数，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>CD14_deg = FindMarkers(sce,ident.1 = <span>'CD14+ Mono'</span>,<br>                  ident.2 = <span>'B'</span>,<br>                  logfc.threshold = <span>0</span>,<br>                  min.pct = <span>0</span><br>                  )<br>head(CD14_deg[order(CD14_deg$p_val),])<br>FCGR3A_deg = FindMarkers(sce,ident.1 = <span>'FCGR3A+ Mono'</span>,<br>                       ident.2 = <span>'B'</span>,<br>                       logfc.threshold = <span>0</span>,<br>                       min.pct = <span>0</span>)<br>head(FCGR3A_deg[order(FCGR3A_deg$p_val),])<br></code></pre><p data-tool="mdnice编辑器">两次差异分析结果就可以去看看相关性，每次差异分析都可以绘制火山图，上下调基因独立富集分析，可以参考我在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504022&amp;idx=1&amp;sn=5a9248f0c0afea7b25fb65192ac76180&amp;scene=21#wechat_redirect" data-linktype="2">25张图带你玩转表达量差异分析思路</a>, 列出来过的生物信息学常见图表制作以及其生物学意义。</p><h3 data-tool="mdnice编辑器"><span></span>样品表型分组后的同一个亚群在不同分组的差异分析（FindAllMarkers函数）<span></span></h3><p data-tool="mdnice编辑器">前面我们已经是把单细胞进行降维聚类分群，不同的群有不同生物学意义，有一些在不同分组有比例的改变，有一些有状态的改变，这个时候如果我们要看同一个亚群在不同分组的差异分析，但是因为单细胞亚群来源于多个样品，其实里面会有样品效应，因为我们前面的多样品整合仅仅是在降维聚类分群层面。</p><p data-tool="mdnice编辑器">如下所示，我们的单细胞首先拆分成为responder和progressor两个对象，然后合并成为 compSce，它里面的comp是表型是两个分组，然后mice是表型是十几个小鼠。也就是说十几个小鼠各自的单细胞转录组样品是两分组，需要做差异分析，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>responder$comp = <span>'responder'</span><br>progressor$comp = <span>'progressor'</span><br>compSce = merge(responder,progressor)<br><br>gplots::balloonplot(table(compSce$comp,compSce$mice))<br>Idents(compSce)=<span>'mice'</span><br>compSce = subset(compSce,downsample=<span>100</span>)<br>gplots::balloonplot(table(compSce$comp,compSce$mice))<br>Idents(compSce)=<span>'comp'</span><br>table(Idents(compSce))<br>deg = FindMarkers(compSce ,ident.1 = <span>'responder'</span>,<br>                  ident.2 = <span>'progressor'</span>)<br>head(deg[order(deg$p_val),])<br></code></pre><p data-tool="mdnice编辑器">这样就有一个很严重的问题，虽然我们保证了每个样品的细胞数量是一致的， 但是两个分组里面仍然是各自有多个样品来源， 我们使用FindMarkers函数后会得到如下所示的结果：</p><p><img data-galleryid="" data-ratio="0.6525229357798165" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww04icTOVPkQZOfrSlsAicqO4Jic0FC5OXTLIMQd7ceRR67OPzVs4ViaWaicHJhc2L30j1put2HBnHjrEQ/640?wx_fmt=png" data-type="png" data-w="1744" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww04icTOVPkQZOfrSlsAicqO4Jic0FC5OXTLIMQd7ceRR67OPzVs4ViaWaicHJhc2L30j1put2HBnHjrEQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>FindMarkers函数结果</figcaption></figure><p data-tool="mdnice编辑器">也就是说，虽然我们是想找两个分组的差异，但是FindMarkers函数仍然是会优先得到样品特异性高表达量基因，因为在单个样品高表达量那么就很合理在样品所在的分组是高表达量的。</p><p data-tool="mdnice编辑器">但是呢，实际上我们并不是需要这样的基因列表，它其实是样品特异性的，严格意义上来说这个就是批次效应，个体差异而已。之前我们在《单细胞天地》公众号分享过一个文献 ，解读在：https://cloud.tencent.com/developer/article/1901064</p><ul data-tool="mdnice编辑器"><li><section>文章题目：Confronting false discoveries in single-cell differential expression</section></li><li><section>日期：2021-09-28</section></li><li><section>期刊：Nature Communications</section></li><li><section>链接：https://www.nature.com/articles/s41467-021-25960-2</section></li></ul><p data-tool="mdnice编辑器">里面提到的目前主流的单细胞差异分析方法都是Wilcoxon rank−sum test，但是它其实表现还不如pseudobulks 的方法：</p><p><img data-galleryid="" data-ratio="0.44742729306487694" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww04icTOVPkQZOfrSlsAicqO4Ivegiby6XvdP0zQxPribE9lYTIRhak8uAVuFxTBjrMrG2Bu2P0tgBy9w/640?wx_fmt=png" data-type="png" data-w="1788" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww04icTOVPkQZOfrSlsAicqO4Ivegiby6XvdP0zQxPribE9lYTIRhak8uAVuFxTBjrMrG2Bu2P0tgBy9w/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>主流的单细胞差异分析方法都是Wilcoxon rank−sum test</figcaption></figure><p data-tool="mdnice编辑器">为什么主流的单细胞差异分析方法都是Wilcoxon rank−sum test呢，因为大家都是使用（FindAllMarkers函数）或者（FindAllMarkers函数），你看看这两个函数的帮助文档：</p><pre data-tool="mdnice编辑器"><span></span><code>FindAllMarkers(<br>  object,<br>  assay = NULL,<br>  features = NULL,<br>  logfc.threshold = 0.25,<br>  test.use = <span>"wilcox"</span>,<br>  slot = <span>"data"</span>,<br>  min.pct = 0.1,<br>  min.diff.pct = -Inf,<br></code></pre><p data-tool="mdnice编辑器">其中  test.use 参数非常重要，如下所示：</p><p><img data-galleryid="" data-ratio="0.8964241676942046" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww04icTOVPkQZOfrSlsAicqO49zO8dlXJz0G75sIibYK87P7b7hXI4qsDqGuDHZR6hTTiaeC8pFmFMPyw/640?wx_fmt=png" data-type="png" data-w="1622" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4ww04icTOVPkQZOfrSlsAicqO49zO8dlXJz0G75sIibYK87P7b7hXI4qsDqGuDHZR6hTTiaeC8pFmFMPyw/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>test.use 参数</figcaption></figure><p data-tool="mdnice编辑器">默认的是就是 Wilcoxon Rank Sum test (default)</p><h3 data-tool="mdnice编辑器"><span></span>实现方法pseudobulks<span></span></h3><p data-tool="mdnice编辑器">前面的 compSce是一个seurat对象 ，它里面的comp是表型是两个分组，然后mice是表型是十几个小鼠。也就是说十几个小鼠各自的单细胞转录组样品是两分组，需要做差异分析。</p><pre data-tool="mdnice编辑器"><span></span><code>bs = split(colnames(compSce),compSce$mice)<br>names(bs)<br>ct = do.call(<br>  cbind,lapply(names(bs), <span>function</span>(x){ <br>    <span># x=names(bs)[[1]]</span><br>    kp =colnames(compSce) %<span>in</span>% bs[[x]]<br>    rowSums( as.matrix( compSce@assays$RNA@counts[, kp]  ))<br>  })<br>)<br><br>phe = unique(compSce@meta.data[,c(<span>'mice'</span>,<span>'comp'</span>)])<br>phe<br><br><span># 每次都要检测数据  </span><br>group_list = phe[match(names(bs),phe$mice),<span>'comp'</span>]<br>table(group_list)    <br>exprSet = ct<br>exprSet[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>] <br>dim(exprSet) <br>exprSet=exprSet[apply(exprSet,<span>1</span>, <span>function</span>(x) sum(x&gt;<span>1</span>) &gt; <span>1</span>),]<br>dim(exprSet)  <br>table(group_list)<br>save(exprSet,group_list,file = <span>'input_for_deg.Rdata'</span>)<br><br>load(file = <span>'input_for_deg.Rdata'</span>)<br><br></code></pre><p data-tool="mdnice编辑器">有了表达量矩阵以及分组信息，后面就是常规的转录组差异分析啦。这里我比较喜欢 DESeq2 包：</p><pre data-tool="mdnice编辑器"><span></span><code><br><span># 加载包</span><br><span>library</span>(DESeq2) <br><span># 第一步，构建DESeq2的DESeq对象</span><br>colData &lt;- data.frame(row.names=colnames(exprSet),group_list=group_list)<br>dds &lt;- DESeqDataSetFromMatrix(countData = exprSet,colData = colData,design = ~ group_list)<br><br><span># 第二步，进行差异表达分析</span><br>dds2 &lt;- DESeq(dds)<br><br><span># 提取差异分析结果，trt组对untrt组的差异分析结果</span><br>table(group_list)<br>tmp &lt;- results(dds2,contrast=c(<span>"group_list"</span>,<span>"case"</span>,<span>"Control"</span>))<br><span># tmp &lt;- results(dds2)</span><br>DEG_DESeq2 &lt;- as.data.frame(tmp[order(tmp$padj),])<br>head(DEG_DESeq2)<br><br><span># 去除差异分析结果中包含NA值的行</span><br>DEG_DESeq2 = na.omit(DEG_DESeq2)<br>DEG_DESeq2[<span>'Gapdh'</span>,] <br>head(DEG_DESeq2)<br>cg = log2(edgeR::cpm(ensembl_matrix)+<span>1</span>)[<span>'Gapdh'</span>,] <br>t.test(cg ~ group_list)<br>boxplot(cg ~ group_list)<br><br>save(DEG_DESeq2,file = <span>'DEG_DESeq2.Rdata'</span>)<br></code></pre></section><p data-tool="mdnice编辑器" mp-original-font-size="16" mp-original-line-height="26">我在《生信技能树》，《生信菜鸟团》，《单细胞天地》的大量推文教程里面共享的代码都是复制粘贴即可使用的， 有任何疑问欢迎留言讨论，也可以发邮件给我，详细描述你遇到的困难的前因后果给我，我的邮箱地址是 jmzeng1314@163.com</p><p data-tool="mdnice编辑器" mp-original-font-size="16" mp-original-line-height="26">如果你确实觉得我的教程对你的科研课题有帮助，让你茅塞顿开，或者说你的课题大量使用我的技能，烦请日后在发表自己的成果的时候，加上一个简短的致谢，如下所示：</p><pre data-tool="mdnice编辑器" mp-original-font-size="16" mp-original-line-height="25.600000381469727"><span mp-original-font-size="16" mp-original-line-height="25.600000381469727"></span><code mp-original-font-size="12" mp-original-line-height="19.200000762939453">We thank Dr.Jianming Zeng(University of Macau), and all the members of his bioinformatics team, biotrainee, <span mp-original-font-size="12" mp-original-line-height="26">for</span> generously sharing their experience and codes.<br mp-original-font-size="12" mp-original-line-height="19.200000762939453"></code></pre><p data-tool="mdnice编辑器" mp-original-font-size="16" mp-original-line-height="26">十年后我环游世界各地的高校以及科研院所（当然包括中国大陆）的时候，如果有这样的情谊，我会优先见你。</p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/AM5Yj-GXnlhQOHJkg-So3g",target="_blank" rel="noopener noreferrer">原文链接</a>
