---
title: "单细胞h5ad转成seurat对象后metadata信息丢失怎么办？(GSE156625)"
date: 2025-04-12T01:59:06Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞h5ad转成seurat对象后metadata信息丢失怎么办？(GSE156625) by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote><span></span><p><span leaf="">我们的生信马拉松授课群里有一个学员学习练手的单细胞数据为h5ad格式，<span textstyle="">他想转成seurat对象后发现metadata信息丢失了</span>，下面来看一看~</span></p></blockquote><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyGLUchgicAZqxXXMGj4GOFTZibZtibkRa8aYtp3aFU369hBL5S73xcEmrdtmpiaAfgGG16zZv0s9JzwQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3982589771490751" data-type="png" data-w="919" data-imgfileid="100056218" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyGLUchgicAZqxXXMGj4GOFTZibZtibkRa8aYtp3aFU369hBL5S73xcEmrdtmpiaAfgGG16zZv0s9JzwQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">数据情况</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">数据编号为：GSE156625，</span></p><p data-tool="mdnice编辑器"><span leaf="">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE156625，下载下面的几个文件：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">GSE156625_HCCbarcodes.tsv.gz 128.7 Mb (ftp)(http) TSV</span><span leaf=""><br></span><span leaf="">GSE156625_HCCgenes.tsv.gz 258.6 Kb (ftp)(http) TSV</span><span leaf=""><br></span><span leaf="">GSE156625_HCCmatrix.mtx.gz 561.9 Mb (ftp)(http) MTX</span><span leaf=""><br></span><span leaf="">GSE156625_HCCscanpyobj.h5ad.gz 800.2 Mb (ftp)(http) H5AD</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">然后整理成下面的格式：<span textstyle="">genes.tsv.gz 改名为 features.tsv.gz</span></span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">├── GSE156625_HCC</span><span leaf=""><br></span><span leaf="">│   ├── barcodes.tsv.gz</span><span leaf=""><br></span><span leaf="">│   ├── features.tsv.gz</span><span leaf=""><br></span><span leaf="">│   └── matrix.mtx.gz</span><span leaf=""><br></span><span leaf="">└── GSE156625_HCCscanpyobj.h5ad</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">上一次我写了一个h5ad转为seurat对象的稿子：</span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247538661&amp;idx=1&amp;sn=0498c055ece839ff0ceca55b47a942cb&amp;scene=21#wechat_redirect"><span leaf="">一步一个坑：单细胞数据的h5ad格式转换成R可读取对象</span></a></p><p data-tool="mdnice编辑器"><span leaf="">底下有个留言说可以使用</span><code><span leaf="">zellkonverter</span></code><span leaf="">，然后我去试了一下，<span textstyle="">发现这个软件在转换的时候也需要用到conda环境，并且默认安装，网速慢，然后还不能指定已有的conda环境，果断放弃了！</span></span></p><p data-tool="mdnice编辑器"><span leaf="">https://www.bioconductor.org/packages/release/bioc/vignettes/zellkonverter/inst/doc/zellkonverter.html</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">转换实战</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">我们还是使用 </span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247538661&amp;idx=1&amp;sn=0498c055ece839ff0ceca55b47a942cb&amp;scene=21#wechat_redirect"><span leaf="">一步一个坑：单细胞数据的h5ad格式转换成R可读取对象</span></a><span leaf=""> 这个帖子中的办法吧！</span></p><p data-tool="mdnice编辑器"><strong><span leaf="">终端/linux</span></strong><span leaf="">：首先是创建一个 conda的小环境 sc</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 创建小环境sc</span></span><span leaf=""><br></span><span leaf="">conda create -n sc -y python=3.10</span><span leaf=""><br></span><span leaf="">conda activate sc</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 安装软件</span></span><span leaf=""><br></span><span leaf="">conda install -y loompy</span><span leaf=""><br></span><span leaf="">conda install anndata -y</span><span leaf=""><br></span><span leaf="">conda install scipy -y</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">然后是在R语言中：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">rm(list=ls())</span><span leaf=""><br></span><span leaf="">library(sceasy)</span><span leaf=""><br></span><span leaf="">library(reticulate)</span><span leaf=""><br></span><span leaf="">library(Seurat)</span><span leaf=""><br></span><span leaf="">packageVersion(</span><span><span leaf="">"Seurat"</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># [1] ‘5.1.0’</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">library(BiocParallel)</span><span leaf=""><br></span><span leaf="">register(MulticoreParam(workers = </span><span><span leaf="">4</span></span><span leaf="">, progressbar = TRUE)) </span><span leaf=""><br></span><span><span leaf=""># 这个conda环境就是刚刚创建的，换成自己的目录即可</span></span><span leaf=""><br></span><span leaf="">use_condaenv(condaenv = </span><span><span leaf="">'/nas2/zhangj/biosoft/miniconda3/envs/sc'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># h5ad转为Seurat</span></span><span leaf=""><br></span><span leaf="">sceasy::convertFormat(obj = </span><span><span leaf="">"GSE156625/GSE156625_HCCscanpyobj.h5ad"</span></span><span leaf="">, </span><span><span leaf="">from</span></span><span leaf="">=</span><span><span leaf="">"anndata"</span></span><span leaf="">,to=</span><span><span leaf="">"seurat"</span></span><span leaf="">,outFile = </span><span><span leaf="">'GSE156625_HCCscanpyobj.rds'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 读取刚刚转换成功的rds对象</span></span><span leaf=""><br></span><span leaf="">sce.all &lt;- readRDS(</span><span><span leaf="">"GSE156625_HCCscanpyobj.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sce.all</span><span leaf=""><br></span><span leaf="">dim(sce.all)</span><span leaf=""><br></span><span leaf="">rownames(sce.all)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 查看特征</span></span><span leaf=""><br></span><span><span leaf="">as</span></span><span leaf="">.data.frame(sce.all@assays$RNA$counts[</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">2</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">head(sce.all@meta.data, </span><span><span leaf="">10</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">dim(sce.all@meta.data)</span><span leaf=""><br></span><span leaf="">phe &lt;- sce.all@meta.data</span><span leaf=""><br></span><span leaf="">save(phe, file = </span><span><span leaf="">"phe.RData"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">这里读进来，发现数据只有2000多个基因了，所以我们就把metadata信息保存出去，然后读取上面的三个 10x 标准文件吧。</span></p><p data-tool="mdnice编辑器"><span leaf="">下面还是R语言：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">## 读取表达矩阵</span></span><span leaf=""><br></span><span leaf="">counts &lt;- Read10X(</span><span><span leaf="">"GSE156625/GSE156625_HCC/"</span></span><span leaf="">, gene.column = 2)</span><span leaf=""><br></span><span leaf="">dim(counts)</span><span leaf=""><br></span><span leaf="">as.data.frame(counts[1:5,1:5])</span><span leaf=""><br></span><span><span leaf=""># 创建seurat对象</span></span><span leaf=""><br></span><span leaf="">sce &lt;- CreateSeuratObject(counts, meta.data = phe, min.cells = 3)</span><span leaf=""><br></span><span leaf="">sce</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># &gt; sce</span></span><span leaf=""><br></span><span><span leaf=""># An object of class Seurat </span></span><span leaf=""><br></span><span><span leaf=""># 26055 features across 42762240 samples within 1 assay </span></span><span leaf=""><br></span><span><span leaf=""># Active assay: RNA (26055 features, 0 variable features)</span></span><span leaf=""><br></span><span><span leaf=""># 1 layer present: counts</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 两者取交集</span></span><span leaf=""><br></span><span leaf="">head(sce@meta.data)</span><span leaf=""><br></span><span leaf="">a &lt;- intersect(colnames(counts),rownames(phe))</span><span leaf=""><br></span><span leaf="">length(a)</span><span leaf=""><br></span><span leaf="">head(a)</span><span leaf=""><br></span><span leaf="">sce_sub &lt;- subset(sce, cells = a)</span><span leaf=""><br></span><span leaf="">sce_sub</span><span leaf=""><br></span><span leaf="">table(sce_sub</span><span><span leaf="">$orig</span></span><span leaf="">.ident)</span><span leaf=""><br></span><span leaf="">table(sce_sub</span><span><span leaf="">$patient_id</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">table(sce_sub</span><span><span leaf="">$patientno</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">需要注意的是，上面读取的三个文件的表达矩阵有42762240，4千多万个细胞，而</span><code><span leaf="">GSE156625_HCCscanpyobj.h5ad</span></code><span leaf="">中是73589多个，需要取个交集~</span></p><p data-tool="mdnice编辑器"><span leaf="">后面就可以走标准流程分析了~</span></p><blockquote><span></span><p><span leaf="">后记：在我准备发这个稿子前学员说他已经解决了这个问题！好家伙，我都写完了那说什么也要给他看一眼再说！（学员还是优秀的！）</span></p></blockquote><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">如果你也有类似的生信分析疑难迟迟得不到解决，又不知道问谁，可以考虑看看下面的培训班呢？我们最新一期4月份招生如下：</span></span><span></span></h4><h4 data-tool="mdnice编辑器"><span></span><span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247539788&amp;idx=1&amp;sn=62a09c7af6373658bf81c149eb0b4026&amp;scene=21#wechat_redirect"><span leaf="">生信入门&amp;数据挖掘线上直播课4月班</span></a></span><span></span></h4><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">选择你的生信入门，为你的生信学习保驾护航：</span></span><span></span></h4><ul><li><section><p><span leaf="">我们有非常成熟的培训体系，我们的培训讲师深知每一位初学者的痛点。</span></p></section></li><li><section><p><span leaf="">多位老师以及助教群里24小时答疑。</span></p></section></li><li><section><p><span leaf="">还可以获取你的专属答疑，见我们的答疑专辑：</span><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=3690970204957147140&amp;scene=173&amp;subscene=&amp;sessionid=1742299252&amp;enterid=0&amp;from_msgid=2247539626&amp;from_itemidx=3&amp;count=3&amp;nolastread=1#wechat_redirect"><span leaf="">生信马拉松答疑</span></a><span leaf=""> &amp; </span><a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=3398473750701146113&amp;scene=173&amp;subscene=207&amp;sessionid=1742386988&amp;enterid=1742386993&amp;from_msgid=2247539218&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect"><span leaf="">马拉松授课互动答疑</span></a></p></section></li></ul><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">快来添加下面的小助手了解更多细节吧~</span></span><span></span></h4><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyGLUchgicAZqxXXMGj4GOFTM7K4N8SEWNLBzwIO9FkmV1dUTwbPh4J0Cp762hd6UiaWXWatPterMYA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5447284345047924" data-type="png" data-w="626" data-imgfileid="100056217" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyGLUchgicAZqxXXMGj4GOFTM7K4N8SEWNLBzwIO9FkmV1dUTwbPh4J0Cp762hd6UiaWXWatPterMYA/640?wx_fmt=png&amp;from=appmsg"></span></figure></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/4aUR1VE8g378_Gm2Wvz-jg",target="_blank" rel="noopener noreferrer">原文链接</a>
