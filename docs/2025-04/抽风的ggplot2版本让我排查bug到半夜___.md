---
title: "抽风的ggplot2版本让我排查bug到半夜！！！"
date: 2025-04-23T00:04:09Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
抽风的ggplot2版本让我排查bug到半夜！！！ by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><blockquote><p><span leaf="">现在已经是凌晨2:41了，本来昨天的公众号稿子要发一个单细胞亚群组间差异的火山图，但是<span textstyle="">绘图的时候迟迟有几个亚群的基因标签不能显示出来，反复的debug让我简直怀疑人生！</span>最后晚上上完课后接着看看代码到底哪里出了问题呀！</span></p></blockquote><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">示例数据</span></span></h2><p data-tool="mdnice编辑器"><span leaf="">示例数据为单细胞的两个组别 IPF vs normal 差异分组，对每个亚群做差异分析，得到的多组差异结果：</span></p><p data-tool="mdnice编辑器"><span leaf="">可以从这里下载：链接: <span textstyle="">https://pan.baidu.com/s/1bpb_8H2osGjNBoRQR4qFhg?pwd=gxw6</span></span></p><pre data-tool="mdnice编辑器"><code><span leaf="">load(</span><span><span leaf="">"diff_res.RData"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">head(diff_sc)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzwsCyODqTOxUmn2vfT1fKklFOB3nPa9xRB2WefrGuTsB6Fh3OVHM4nzkECz4xIyr3iaCQvzYJN12A/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.2759259259259259" data-type="png" data-w="1080" data-imgfileid="100057654" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzwsCyODqTOxUmn2vfT1fKklFOB3nPa9xRB2WefrGuTsB6Fh3OVHM4nzkECz4xIyr3iaCQvzYJN12A/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">绘图</span></span></h2><p data-tool="mdnice编辑器"><span leaf="">由于搬家，自己的服务器还没有整理好，这里用了技能树的共享服务器，换了一个分析环境太难受了，要啥啥都没有准备好：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 使用 公共路径中的R包</span></span><span leaf=""><br></span><span leaf="">.libPaths(c(</span><span><span leaf="">'~/R/x86_64-pc-linux-gnu-library/4.4'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">            </span><span><span leaf="">'/refdir/Rlib'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">            </span><span><span leaf="">'/usr/local/lib/R/library'</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 加载包</span></span><span leaf=""><br></span><span leaf="">library(ggplot2)</span><span leaf=""><br></span><span leaf="">packageVersion(</span><span><span leaf="">"ggplot2"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">library(Seurat)</span><span leaf=""><br></span><span leaf="">library(qs)</span><span leaf=""><br></span><span leaf="">library(tidyverse)</span><span leaf=""><br></span><span leaf="">library(ggrepel)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">然后是绘图，先对数据做一下处理：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">table(diff_sc</span><span><span leaf="">$Group</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">diff_sc &lt;- diff_sc[abs(diff_sc</span><span><span leaf="">$avg_log2FC</span></span><span leaf="">)&gt;0.58, ]</span><span leaf=""><br></span><span leaf="">diff_sc</span><span><span leaf="">$log10fdr</span></span><span leaf=""> &lt;- -log10(diff_sc</span><span><span leaf="">$p_val_adj</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 处理一下极大值</span></span><span leaf=""><br></span><span leaf="">diff_sc</span><span><span leaf="">$log10fdr</span></span><span leaf="">[diff_sc</span><span><span leaf="">$log10fdr</span></span><span leaf="">==</span><span><span leaf="">"Inf"</span></span><span leaf="">] &lt;- max(diff_sc</span><span><span leaf="">$log10fdr</span></span><span leaf="">[diff_sc</span><span><span leaf="">$log10fdr</span></span><span leaf="">!=Inf])</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 获取每种细胞亚群中Top10基因:</span></span><span leaf=""><br></span><span leaf="">top10 &lt;- diff_sc %&gt;% </span><span leaf=""><br></span><span leaf="">  group_by(Group) %&gt;%</span><span leaf=""><br></span><span leaf="">  dplyr::filter(avg_log2FC &gt; 1) %&gt;%</span><span leaf=""><br></span><span leaf="">  top_n(10, abs(avg_log2FC)) %&gt;%</span><span leaf=""><br></span><span leaf="">  ungroup()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 创建自定义色板：</span></span><span leaf=""><br></span><span leaf="">mycol &lt;- c(</span><span><span leaf="">'#b12d30'</span></span><span leaf="">, </span><span><span leaf="">'#43b5e6'</span></span><span leaf="">, </span><span><span leaf="">'#93ba1f'</span></span><span leaf="">, </span><span><span leaf="">'#58ac41'</span></span><span leaf="">, </span><span><span leaf="">'#f0bbcb'</span></span><span leaf="">,</span><span><span leaf="">'#f1aa41'</span></span><span leaf=""><br></span><span leaf="">           ,</span><span><span leaf="">"#6cc3b9"</span></span><span leaf="">,</span><span><span leaf="">"#fc3c46"</span></span><span leaf="">,</span><span><span leaf="">"#b76f9e"</span></span><span leaf="">,</span><span><span leaf="">"#3568a3"</span></span><span leaf="">,</span><span><span leaf="">"#f66464"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">开始绘图：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 基础火山图</span></span><span leaf=""><br></span><span leaf="">p &lt;- ggplot() +</span><span leaf=""><br></span><span leaf="">  geom_point(data = diff_sc, aes(x = avg_log2FC, y = log10fdr),size = 0.8, color = </span><span><span leaf="">'grey'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  coord_flip() + </span><span><span leaf=""># 坐标轴翻转</span></span><span leaf=""><br></span><span leaf="">  facet_grid(. ~ Group,scales = </span><span><span leaf="">"free"</span></span><span leaf="">) + </span><span><span leaf=""># 一行多列;</span></span><span leaf=""><br></span><span leaf="">  geom_point(data = top10, aes(x = avg_log2FC, y = log10fdr,color = Group)) + </span><span><span leaf=""># 添加top点颜色</span></span><span leaf=""><br></span><span leaf="">  geom_vline(xintercept = c(-0.58, 0.58), size = 0.5, color = </span><span><span leaf="">"grey50"</span></span><span leaf="">, lty = </span><span><span leaf="">'dashed'</span></span><span leaf="">)+ </span><span><span leaf="">#添加阈值线</span></span><span leaf=""><br></span><span leaf="">  scale_color_manual(values = mycol) </span><span><span leaf="">#+ #更改配色</span></span><span leaf=""><br></span><span leaf="">  theme_bw()+</span><span leaf=""><br></span><span leaf="">  theme( legend.position = </span><span><span leaf="">'none'</span></span><span leaf="">, </span><span><span leaf="">#去掉图例</span></span><span leaf=""><br></span><span leaf="">    panel.grid = element_blank(), </span><span><span leaf="">#去掉背景网格</span></span><span leaf=""><br></span><span leaf="">    axis.text = element_text(size = 10), </span><span><span leaf="">#坐标轴标签大小</span></span><span leaf=""><br></span><span leaf="">    axis.text.x = element_text(angle = 45, vjust = 0.8), </span><span><span leaf="">#x轴标签旋转</span></span><span leaf=""><br></span><span leaf="">    strip.text.x = element_text(size = 10, face = </span><span><span leaf="">'bold'</span></span><span leaf="">) </span><span><span leaf="">#加粗分面标题</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 添加基因symbol</span></span><span leaf=""><br></span><span leaf="">p + </span><span leaf=""><br></span><span leaf="">  geom_text_repel(</span><span leaf=""><br></span><span leaf="">    data = top10,</span><span leaf=""><br></span><span leaf="">    aes(x = avg_log2FC, y = log10fdr, label = gene, color = Group),</span><span leaf=""><br></span><span leaf="">    fontface = </span><span><span leaf="">'italic'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    seed = 233,</span><span leaf=""><br></span><span leaf="">    size = 3,</span><span leaf=""><br></span><span leaf="">    min.segment.length = 0,  </span><span><span leaf=""># 始终为标签添加指引线段</span></span><span leaf=""><br></span><span leaf="">    force = 12,  </span><span><span leaf=""># 重叠标签间的排斥力</span></span><span leaf=""><br></span><span leaf="">    force_pull = 2,  </span><span><span leaf=""># 标签和数据点间的吸引力</span></span><span leaf=""><br></span><span leaf="">    box.padding = 0.1,  </span><span><span leaf=""># 标签周边填充量</span></span><span leaf=""><br></span><span leaf="">    max.overlaps = Inf,  </span><span><span leaf=""># 始终显示所有标签</span></span><span leaf=""><br></span><span leaf="">    segment.linetype = 3,  </span><span><span leaf=""># 线段类型</span></span><span leaf=""><br></span><span leaf="">    segment.alpha = 0.5,  </span><span><span leaf=""># 线段不透明度</span></span><span leaf=""><br></span><span leaf="">    direction = </span><span><span leaf="">"y"</span></span><span leaf="">,  </span><span><span leaf=""># 按 y 轴调整标签位置方向</span></span><span leaf=""><br></span><span leaf="">    hjust = 0,  </span><span><span leaf=""># 0 右对齐，1 左对齐，0.5 居中</span></span><span leaf=""><br></span><span leaf="">    point.padding = 0.5,  </span><span><span leaf=""># 增加点和标签之间的间距</span></span><span leaf=""><br></span><span leaf="">    nudge_x = 0.05,  </span><span><span leaf=""># 在 x 轴方向上微调标签位置</span></span><span leaf=""><br></span><span leaf="">    nudge_y = 0.05  </span><span><span leaf=""># 在 y 轴方向上微调标签位置</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">结果如下：</span></p><p data-tool="mdnice编辑器"><span leaf="">你就会发现，<span textstyle="">好好的也没有重叠在一起，怎么就有的亚群可以显示基因symbol，有的就不显示呢！</span></span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzwsCyODqTOxUmn2vfT1fKkJPfbM0s36tntpnF4kia9toM57fSvBRntuX3xwTYAodH4wedMYlqzufw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4722222222222222" data-type="png" data-w="1080" data-imgfileid="100057656" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzwsCyODqTOxUmn2vfT1fKkJPfbM0s36tntpnF4kia9toM57fSvBRntuX3xwTYAodH4wedMYlqzufw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">就在我查代码查的快疯了的时候</span>，突然想起来之前有一次绘图，跟张俊交流过一些问题，上一次交流的时候是ggplot2的两个参数我查到明明有，但是用的时候一直提示我不对！然后他问我的ggplot2版本是哪个？<span textstyle="">他专门订阅了github上每一个ggplot2的更新消息，让我安装github上最新的版本！</span></span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">我灵光一闪，会不会是这次也是ggplot2的版本有问题呢？！</span></span></p><p data-tool="mdnice编辑器"><span leaf="">先看一下现在的ggplot2版本：<span textstyle="">3.5.1</span></span></p><pre data-tool="mdnice编辑器"><code><span leaf="">library(ggplot2)</span><span leaf=""><br></span><span leaf="">packageVersion(</span><span><span leaf="">"ggplot2"</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># ‘3.5.1’</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">然后火速的去github下载最新版本</span>，安装：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">.libPaths()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 安装</span></span><span leaf=""><br></span><span leaf="">devtools::install_local(</span><span><span leaf="">"ggplot2-main.zip"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">packageVersion(</span><span><span leaf="">"ggplot2"</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># [1] ‘3.5.2.9000’</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">github上走在最前沿：<span textstyle="">到了3.5.2.9000版了！</span></span></p><p data-tool="mdnice编辑器"><span leaf="">然后回去重新绘图，<span textstyle="">同样的代码，但是需要重启Rstudio，加载新的ggplot2</span>：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">.libPaths(</span><span><span leaf="">"/home/data/t020448/miniconda3/envs/R4.4/lib/R/library"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">.libPaths()</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">library(ggplot2)</span><span leaf=""><br></span><span leaf="">packageVersion(</span><span><span leaf="">"ggplot2"</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># [1] ‘3.5.2.9000’</span></span><span leaf=""><br></span><span leaf="">library(Seurat)</span><span leaf=""><br></span><span leaf="">library(qs)</span><span leaf=""><br></span><span leaf="">library(tidyverse)</span><span leaf=""><br></span><span leaf="">library(ggrepel)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">重新走上面的代码，结果如下：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzwsCyODqTOxUmn2vfT1fKkSKwPSD1grpEMLNaR1RpqtoC4ad4piaULkV9g3vsaHm32eicelvMxD7Ag/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.35" data-type="png" data-w="1080" data-imgfileid="100057655" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzwsCyODqTOxUmn2vfT1fKkSKwPSD1grpEMLNaR1RpqtoC4ad4piaULkV9g3vsaHm32eicelvMxD7Ag/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">洗洗睡了！明天又是一条好汉，还有那么多答疑等着我！</span></span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">文末友情宣传</span></span><span></span></h3><ul><li><section><strong><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247541231&amp;idx=1&amp;sn=6704a3ae8233d19ca94fd4929b5e1f63&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">生信入门&amp;数据挖掘线上直播课5月班</a></span></strong></section></li><li><section><strong><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247525079&amp;idx=1&amp;sn=0b997af16a58195b4192691373048fd5&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></span></strong></section></li><li><section><strong><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></span></strong></section></li></ul></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/vY5Ny5weUV2Kc1BZ2RlY3Q",target="_blank" rel="noopener noreferrer">原文链接</a>
