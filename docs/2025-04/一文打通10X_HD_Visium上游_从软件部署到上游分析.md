---
title: "一文打通10X HD Visium上游：从软件部署到上游分析"
date: 2025-04-19T06:29:29Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
一文打通10X HD Visium上游：从软件部署到上游分析 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">熟悉我的朋友应该知道，学习一个组学，我一般会从学起，从上游分析到下游，例如为了学习Bulk RNA-seq分析，我会从芯片数据学起，例如：</span></p><ul><li><section><p><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483902&amp;idx=1&amp;sn=ace46db3ad894b91b978ae07720f21c3&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">一文解决80%GEO芯片数据分析</a></span></p></section></li><li><section><p><span leaf="">同时这个过程学习了基因ID转换，</span><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483932&amp;idx=1&amp;sn=1e2fe2f459032ad440d28817c238e670&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">关于基因ID转换，一文就够了</a></span></p></section></li><li><section><p><span leaf="">差异表达分析以及富集分析等，</span><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzI5MTcwNjA4NQ==&amp;mid=2247514436&amp;idx=1&amp;sn=af8fe8b7e49ffa9d9564d7e8e4e87aaf&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">R语言进行TCGA配对样本差异基因分析</a></span></p></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">学习Bulk RNA-seq分析，我会先从FASTQ上游分析学起，顺带学习了Linux和Conda，例如：</span></p><ul><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483696&amp;idx=1&amp;sn=521df829a697d50477e7b4ac840a8129&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">Linux随笔（一）入门篇</a></span></section></li><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483723&amp;idx=1&amp;sn=4716bcef0d1ebc0c6b7f1eb289b4754d&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">Linux随笔（二）“软件管家“ conda</a></span></section></li><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483979&amp;idx=1&amp;sn=25e1b0d54df0cf33dd2c353eb98f2697&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">91例免疫治疗队列（含生存）转录组上游分析实战</a></span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">有了上面的知识和经验，</span><strong><span leaf="">很快</span></strong><span leaf="">入门了Chip-seq分析：</span></p><ul><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484254&amp;idx=2&amp;sn=9fdc090bacdb635fd7c015d21fca8312&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">ChIPseq实战分析(一)：从fastq到bed</a></span></section></li><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484254&amp;idx=1&amp;sn=666e4bf7d61e290f574416d6912d4515&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">ChIPseq实战分析(二)：HOMER和MEME的motif分析</a></span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">还是一样，有了上面分析多组学的知识和经验，</span><strong><span leaf="">很快</span></strong><span leaf="">入门了scRNA-seq分析，scRNA-seq我写的太多了，就不一一列举了：</span></p><ul><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247483752&amp;idx=1&amp;sn=5d7bb3369c68f5170995861962a6cbd3&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">一文打通单细胞上游：从软件部署到上游分析</a></span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">尽管有了大量实战经验，在单细胞上游分析方面我也踩了不少坑，例如：</span></p><ul><li><section><p><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247508521&amp;idx=2&amp;sn=2cf3158e74d37b3a741908d8bfc8f02f&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">10X单细胞转录组测序数据的 SRA转fastq踩坑那些事</a></span></p></section></li><li><section><p><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487107&amp;idx=1&amp;sn=821a677834c21e40d088fc27ab4c6aa3&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">10X单细胞上游 | 一个样本对应多个SRR ID怎么办？</a></span></p></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">Visium HD 是10X Genomics在2024年最新推出的空间转录组技术，得益于前期的学习和积累，这个技术一出来我就开始学习了，例如：</span></p><ul><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247488065&amp;idx=3&amp;sn=31777434d9c06170b98497a3e41feb03&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">全网首发 | Visium HD空转数据开箱测试</a></span></section></li><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247526084&amp;idx=1&amp;sn=ea56a5f56b11fbd93df13f41c611e319&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">跟着Seurat官网学Visium HD空转分析（一）标准分析流程</a></span></section></li><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247526900&amp;idx=1&amp;sn=1ce8e86a7b79faf21b745d4143d49a38&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">跟着Seurat官网学Visium HD空转分析（二）空间组织域识别和反卷积</a></span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">然而关于10X HD Visium上游分析流程的学习一直是我的一个小遗憾，搜了一下推文似乎也没有人写过。所以本帖专门对10X HD Visium上游分析的软件部署和流程做一个简要介绍。希望我的学习经验和本帖都能给大家一些参考。</span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">一. 10X HD Visium上游分析环境部署</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">这里主要涉及到的是spaceranger的安装，10官网有详细的步骤（https://www.10xgenomics.com/support/software/space-ranger/downloads）：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">wget -O spaceranger-3.1.3.tar.gz </span><span><span leaf="">"https://cf.10xgenomics.com/releases/spatial-exp/spaceranger-3.1.3.tar.gz?Expires=1743662161&amp;Key-Pair-Id=APKAI7S6A5RYOXBWRPDA&amp;Signature=KsQo6G-WuryCCjpcDDOsk5cWNYIl13C8pTd7u-alfERynAGTTqRWU-4~U7yCgCqDLqwsrZqKYIqtVsqqI1i88xaMhs1V4g6xsSJNDBV9eqCQC9CiaamwK0I5DhH-fbneO0r3mIgmxc9Y5wirRXTYqV-fKVhUoTmfkp90vx1eCjgixiVHQGRDwyDWbhHAzk888d3bDUYliGd-y4x1OCSZQN-cYzzGKrOzPoNWdQXlE~NUv8wIolL6Uj67mAcx0jo1a5BeLhDOhh0yBCQKtwlDU64kKjNCa7dTTk4svIjbyJHB7EM-r79oOdPfn25q~l4xXGu0arOILJgUmCjCkZ1fEQ__"</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">##解压</span></span><span leaf=""><br></span><span leaf="">tar -xzvf spaceranger-3.1.3.tar.gz</span><span leaf=""><br></span><span><span leaf="">export</span></span><span leaf=""> PATH=~/software_install/spaceranger-3.1.3:</span><span><span leaf="">$PATH</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">##绑定邮箱</span></span><span leaf=""><br></span><span leaf="">spaceranger sitecheck &gt; sitecheck.txt</span><span leaf=""><br></span><span leaf="">spaceranger upload xxx@xxx.xxx sitecheck.txt</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 我喜欢在10x环境下跑上游</span></span><span leaf=""><br></span><span><span leaf=""># ln -s ~/software_install/spaceranger-3.1.3/bin/spaceranger ~/miniconda3/envs/10x/bin/</span></span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">二. 10X HD Visium上游分析的标准流程</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">这部分也是参考10X官网即可（https://www.10xgenomics.com/support/software/space-ranger/latest），大概流程如下：</span></p><p data-tool="mdnice编辑器"><span leaf="">FASTQ文件的获取，这里跳过了，一般是自测为主的，论文公开的话，我估计要么是不公开的，要么都是缺胳膊少腿的。</span></p><p data-tool="mdnice编辑器"><span leaf="">spaceranger软件的核心函数就是</span><code><span leaf="">spaceranger count</span></code><span leaf="">了，代码其实很简单，但是理解每一个参数和每一个文件需要花费大量的时间：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf=""> spaceranger count --id=hd_count \</span><span leaf=""><br></span><span leaf=""> --transcriptome=/path/to/refdata-gex-GRCh38-</span><span><span leaf="">2020</span></span><span leaf="">-A \</span><span leaf=""><br></span><span leaf=""> --fastqs=/path/to/fastq \</span><span leaf=""><br></span><span leaf=""> --probe-set=/path/to/Visium_Human_Transcriptome_Probe_Set_v2.0_GRCh38-</span><span><span leaf="">2020</span></span><span leaf="">-A.csv \</span><span leaf=""><br></span><span leaf=""> --slide=H1-YD7CDZK \</span><span leaf=""><br></span><span leaf=""> --area=A1 \</span><span leaf=""><br></span><span leaf=""> --cytaimage=/path/to/CAVG10539_2023-</span><span><span leaf="">11</span></span><span leaf="">-16_</span><span><span leaf="">14</span></span><span leaf="">-</span><span><span leaf="">56</span></span><span leaf="">-24_APPS115_H1-YD7CDZK_A1_S11088.tif \</span><span leaf=""><br></span><span leaf=""> --image=/path/to/APPS115_11088_rescan_01.btf \</span><span leaf=""><br></span><span leaf=""> --create-bam=false</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">如果是两年前的话，需要我们自己查阅，虽然很花费时间和精力，但是能学到很多。</span></p><p data-tool="mdnice编辑器"><span leaf="">现在的话，有小C老师了，还有Deepseek老师，真的可以节省大量时间：</span></p><section data-tool="mdnice编辑器"><table><thead><tr><th><strong><span leaf="">参数</span></strong></th><th><strong><span leaf="">文件类型</span></strong></th><th><strong><span leaf="">来源说明</span></strong></th></tr></thead><tbody><tr><td><section><span leaf="">--transcriptome</span></section></td><td><section><span leaf="">参考转录组文件夹（10X格式）</span></section></td><td><section><span leaf="">从10X官网下载</span></section></td></tr><tr><td><section><span leaf="">--fastqs</span></section></td><td><section><span leaf="">测序数据 FASTQ 文件</span></section></td><td><section><span leaf="">Illumina测序仪输出</span></section></td></tr><tr><td><section><span leaf="">--probe-set</span></section></td><td><section><span leaf="">v2版本的探针CSV文件</span></section></td><td><section><span leaf="">从10X官网下载</span></section></td></tr><tr><td><section><span leaf="">--slide</span></section></td><td><section><span leaf="">Slide编号</span></section></td><td><section><span leaf="">样本记录表/玻片标签</span></section></td></tr><tr><td><section><span leaf="">--area</span></section></td><td><section><span leaf="">玻片区域（A1-D1）</span></section></td><td><section><span leaf="">实验设计决定</span></section></td></tr><tr><td><section><span leaf="">--cytaimage</span></section></td><td><section><span leaf="">低分辨率组织扫描图像（tif）</span></section></td><td><section><span leaf="">CytaScope仪器生成</span></section></td></tr><tr><td><section><span leaf="">--image</span></section></td><td><section><span leaf="">高分辨率图像（.btf 或 .tif）</span></section></td><td><section><span leaf="">Zeiss扫描或原始图像</span></section></td></tr><tr><td><section><span leaf="">--create-bam</span></section></td><td><section><span leaf="">是否生成 BAM 文件（false 推荐）</span></section></td><td><section><span leaf="">自定义</span></section></td></tr></tbody></table></section><p data-tool="mdnice编辑器"><strong><span leaf="">但是AI有一个问题，就是AI多强大取决于用户的知识面多强大，例如，如果我不知道10x visium图片对齐和细胞分割这个概念，AI一般不太会告诉我，甚至即便告诉了我，我也没有概念，不能理解，也无法记住。</span></strong></p><p data-tool="mdnice编辑器"><strong><span leaf="">拿10x visium图片对齐这个问题举例，这个问题很重要，但是在spaceranger count这个过程是可选的，做与不做取决于用户的目的和数据本身，如果仅仅基于AI跑通了整个spaceranger count流程，囫囵吞枣，虽然可以很快达到目标，但是会遗漏很多的细节。</span></strong></p><p data-tool="mdnice编辑器"><strong><span leaf="">回到本文的主题，下面讲讲10x visium图片对齐问题：</span></strong></p><p data-tool="mdnice编辑器"><span leaf="">在 Visium HD 的分析流程中，我们主要涉及两款核心软件：</span></p><ul><li><section><p><strong><span leaf="">Space Ranger</span></strong><span leaf="">：用于在 Linux 命令行中运行，将测序原始数据（FASTQ）转化为空间定位的基因表达矩阵，同时结合显微镜图像进行空间可视化；</span></p></section></li><li><section><p><strong><span leaf="">Loupe Browser</span></strong><span leaf="">：可视化工具，适用于 Windows 或 Mac 平台，用于打开 Space Ranger 生成的 .cloupe 文件，帮助进行组织区域选择、图像对齐，以及辅助下游生物学解读。</span></p></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">在 Space Ranger 分析中，我们会将转录本表达的空间位置与组织切片图像进行匹配。但这个自动匹配的过程并不总是完美，有时会出现如下情况：</span></p><ul><li><section><strong><span leaf="">部分组织区域未被自动选中</span></strong></section></li><li><section><strong><span leaf="">图像背景（HE）与转录本信号前景对不齐</span></strong></section></li><li><section><strong><span leaf="">组织芯片样本中多个区域希望独立分析</span></strong></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">这时，</span><strong><span leaf="">Loupe Browser 的图像对齐功能就显得尤为重要</span></strong><span leaf="">。</span></p><p data-tool="mdnice编辑器"><span leaf="">具体来说，在分析 Visium HD 数据时，我们会有两张图像：</span></p><ul><li><section><strong><span leaf="">CytAssist 图像</span></strong><span leaf="">：与空间转录本定位信息（barcodes）一一对应；</span></section></li><li><section><strong><span leaf="">高清 HE 图像</span></strong><span leaf="">：通常由显微镜单独扫描，图像质量高，但与转录本坐标存在旋转、翻转、缩放等偏差。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">我们可以在 Loupe Browser 中：</span></p><ul><li><section><strong><span leaf="">载入 Space Ranger 生成的 .cloupe 文件</span></strong></section></li><li><section><strong><span leaf="">叠加 CytAssist 图像与 HE 图像</span></strong></section></li><li><section><strong><span leaf="">手动进行组织区域选择和图像对齐</span></strong></section></li><li><section><strong><span leaf="">导出 .json 文件</span></strong></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">随后，在重新运行 spaceranger count 时传入该 .json 文件，即可让软件使用预设的组织区域及图像对齐参数，从而实现</span><strong><span leaf="">更精确的空间表达定位</span></strong><span leaf="">。</span></p><p data-tool="mdnice编辑器"><span leaf="">那么，什么时候应该使用 Loupe Browser 做组织区域选择和对齐呢？</span></p><ul><li><section><p><strong><span leaf="">默认推荐</span></strong><span leaf="">：</span><strong><span leaf="">直接运行 Space Ranger，无需手动干预</span></strong><span leaf="">（大多数切片已能良好对齐）</span></p></section></li><li><section><p><span leaf="">❗ </span><strong><span leaf="">必须使用 Loupe Browser 的情况</span></strong><span leaf="">：</span></p></section></li><ul><li><section><span leaf="">有组织区域未被自动识别；</span></section></li><li><section><span leaf="">图像前后景对齐明显偏移；</span></section></li><li><section><span leaf="">多组织芯片样本中，希望分别提取每个阵列区域进行分析；</span></section></li><li><section><span leaf="">需要用于发表、公开数据库提交，或精细差异表达分析。</span></section></li></ul></ul><p data-tool="mdnice编辑器"><span leaf="">（当然上面的内容我也是借助小C老师生成的。虽然内容本身我有查阅资料交叉验证，如果有说的不对的地方还请各位批评指正。）</span></p><p data-tool="mdnice编辑器"><span leaf="">得到下游表达矩阵之后，就可以做</span><strong><span leaf="">细胞分割</span></strong><span leaf="">或者</span><strong><span leaf="">标准流程</span></strong><span leaf="">了，例如：</span></p><ul><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247488065&amp;idx=3&amp;sn=31777434d9c06170b98497a3e41feb03&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">全网首发 | Visium HD空转数据开箱测试</a></span></section></li><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247526084&amp;idx=1&amp;sn=ea56a5f56b11fbd93df13f41c611e319&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">跟着Seurat官网学Visium HD空转分析（一）标准分析流程</a></span></section></li><li><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247526900&amp;idx=1&amp;sn=1ce8e86a7b79faf21b745d4143d49a38&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">跟着Seurat官网学Visium HD空转分析（二）空间组织域识别和反卷积</a></span></section></li></ul><section><span leaf=""><br></span></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/CLB2F0CmvbVp8VUP1OOKcQ",target="_blank" rel="noopener noreferrer">原文链接</a>
