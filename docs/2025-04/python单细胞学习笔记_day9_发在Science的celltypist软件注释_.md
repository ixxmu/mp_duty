---
title: "pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day9(å‘åœ¨Scienceçš„celltypistè½¯ä»¶æ³¨é‡Š)"
date: 2025-04-14T09:21:17Z
draft: ["false"]
tags: [
  "fetched",
  "ç”Ÿä¿¡æŠ€èƒ½æ ‘"
]
categories: ["Acdemic"]
---
pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day9(å‘åœ¨Scienceçš„celltypistè½¯ä»¶æ³¨é‡Š) by ç”Ÿä¿¡æŠ€èƒ½æ ‘
------
<div><section data-tool="mdniceç¼–è¾‘å™¨" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">å‰é¢çš„pythonå­¦ä¹ ç¬”è®°ï¼šï¼š</span></p><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536678&amp;idx=2&amp;sn=e17fcf623ccd788839f1ca6963c45f80&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day1</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536678&amp;idx=3&amp;sn=ea9bc59b48809350fd25e84039515950&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day2</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536822&amp;idx=2&amp;sn=3f99b79a7edca965b3ed5378281a1686&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day3</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536945&amp;idx=2&amp;sn=3d829370b31f66df60caebaa79af2bf3&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day4</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247537192&amp;idx=2&amp;sn=302ddaad4275f00bb539c8614d892130&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day4ï¼ˆç»­ï¼‰</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247537290&amp;idx=2&amp;sn=d90812996f6ca7eadaae7cf080b37cf0&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day5</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247537412&amp;idx=2&amp;sn=8c83666635bd5c656d6fc958f67bbd8a&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day6</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247539696&amp;idx=2&amp;sn=16cabd270e27dd7261d45e9dae62ef58&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day7</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247539852&amp;idx=1&amp;sn=e9a719dbc99677aab2a913d65a180bf6&amp;scene=21#wechat_redirect"><span leaf="">pythonå•ç»†èƒå­¦ä¹ ç¬”è®°-day8(singlerè‡ªåŠ¨æ³¨é‡Š)</span></a></section></li></ul><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">ä»Šå¤©ç»§ç»­å­¦ä¹ è§†é¢‘ï¼šå­¦ä¹ celltypistç»†èƒæ³¨é‡Šï¼Œå•æ ·æœ¬å’Œå¤šæ ·æœ¬~</span></p><h2 data-cacheurl="" data-remoteid="" data-tool="mdniceç¼–è¾‘å™¨"><span></span><span><span leaf="">0.ç¯å¢ƒå‡†å¤‡</span></span><span></span></h2><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">åœ¨ä¹‹å‰çš„condaç¯å¢ƒä¸­å®‰è£…æ–°çš„æœ¬æ¬¡ä¸Šè¯¾éœ€è¦çš„å‡ ä¸ªåŒ…ï¼šï¼ˆå»ºè®®å…ˆä¸è¦å…¨éƒ½å®‰è£…ä¸Šï¼Œå¾ˆå®¹æ˜“åé¢å‡ºç°åŒ…å¯¼å…¥å¤±è´¥ï¼Œå¯ä»¥è¿è¡Œåˆ°å“ªä¸ªä»£ç ç¼ºå°‘æ¨¡å—å†å¼€å§‹å®‰è£…~ï¼‰</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># bashç»ˆç«¯</span></span><span leaf=""><br></span><span leaf="">conda activate sc</span><span leaf=""><br></span><span><span leaf=""># å®‰è£… scikit-learnåº“</span></span><span leaf=""><br></span><span leaf="">pip install singler -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install singlecellexperiment -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install scranpy -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install celldex -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install celltypist -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install harmonypy -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install loompy -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple Â  Â </span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">æ–‡ä»¶è¯´æ˜ï¼š</span></p><ul><li><section><span leaf="">2.celltypist.ipynbï¼šå•æ ·æœ¬çš„å•ç»†èƒæ ‡å‡†åˆ†æä»¥åŠåé¢çš„celltypilstç»†èƒæ³¨é‡Š</span></section></li><li><section><span leaf="">4.celltypist_multisamples.ipynbï¼šå¤šæ ·æœ¬çš„å•ç»†èƒæ ‡å‡†åˆ†æä»¥åŠåé¢çš„celltypilstç»†èƒæ³¨é‡Š</span></section></li></ul><h2 data-cacheurl="" data-remoteid="" data-tool="mdniceç¼–è¾‘å™¨"><span></span><span><span leaf="">1.å•æ ·æœ¬çš„celltypistæ³¨é‡Š</span></span><span></span></h2><h3 data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">1.1 æ•°æ®è¯»å–</span></span><span></span></h3><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">ä½¿ç”¨</span><code><span leaf="">ç”¨read_10x_mtx</span></code><span leaf="">è¯»å–10x cellrangerçš„ä¸‰ä¸ªæ ‡å‡†æ–‡ä»¶ï¼Œ01_data çš„æ–‡ä»¶ï¼š'barcodes.tsv', 'genes.tsv', 'matrix.mtx'</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf="">Â singlecellexperimentÂ </span><span><span leaf="">as</span></span><span leaf="">Â sce</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf="">Â scanpyÂ </span><span><span leaf="">as</span></span><span leaf="">Â sc</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf="">Â os</span><span leaf=""><br></span><span leaf="">print(os.listdir(</span><span><span leaf="">"01_data"</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># è¯»å–æ•°æ®</span></span><span leaf=""><br></span><span leaf="">adata = sc.read_10x_mtx(</span><span><span leaf="">"01_data/"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">print(adata.shape)</span><span leaf=""><br></span><span leaf="">adata.X</span><span leaf=""><br></span></code></pre><h3 data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">1.2 æ•°æ®è´¨æ§</span></span><span></span></h3><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">éƒ½æ˜¯å¸¸è§„æµç¨‹ï¼Œå¿«é€Ÿçœ‹ä¸‹æ•°æ®åˆ†å¸ƒç‰¹ç‚¹å†³å®šæ•°æ®è¿‡æ»¤æ¡ä»¶ï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># è®¡ç®—çº¿ç²’ä½“åŸºå› è¡¨è¾¾æ¯”ä¾‹</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'mt'</span></span><span leaf="">]=adata.var_names.str.startswith(</span><span><span leaf="">'MT-'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.calculate_qc_metrics(adata,qc_vars=[</span><span><span leaf="">'mt'</span></span><span leaf="">],log1p=</span><span><span leaf="">False</span></span><span leaf="">,percent_top=</span><span><span leaf="">None</span></span><span leaf="">,inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># è¿‡æ»¤å‰æ•°æ®åˆ†å¸ƒæƒ…å†µ</span></span><span leaf=""><br></span><span leaf="">sc.pl.violin(adata,[</span><span><span leaf="">"n_genes_by_counts"</span></span><span leaf="">,Â </span><span><span leaf="">"total_counts"</span></span><span leaf="">,Â </span><span><span leaf="">"pct_counts_mt"</span></span><span leaf="">],jitter=</span><span><span leaf="">0.4</span></span><span leaf="">, multi_panel=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSDd045QpEJwK8BTF7rvPDXOSiclcHbQfiblZcA9pv88p1k4ZhodFSwYtg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.325" data-type="png" data-w="1080" data-imgfileid="100056415" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSDd045QpEJwK8BTF7rvPDXOSiclcHbQfiblZcA9pv88p1k4ZhodFSwYtg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è¿‡æ»¤ï¼šè¿™é‡Œè¿™ä¸ªæ•°æ®æˆ‘ä¸å¤ªæ¸…æ¥šæ¥è‡ªå“ªé‡Œä»¥åŠæ˜¯ä»€ä¹ˆç»„ç»‡ç±»å‹ï¼Œæ‰€ä»¥å¦‚æœæ˜¯è‡ªå·±çš„æ•°æ®éœ€è¦ç»“åˆé¡¹ç›®èƒŒæ™¯æ¥çœ‹ï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># ç¡®å®šè¿‡æ»¤æ¡ä»¶å¹¶è¿‡æ»¤</span></span><span leaf=""><br></span><span><span leaf=""># åˆå§‹è¿‡æ»¤</span></span><span leaf=""><br></span><span leaf="">sc.pp.filter_cells(adata,min_genes=</span><span><span leaf="">200</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.filter_genes(adata,min_cells=</span><span><span leaf="">3</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata=adata[adata.obs.n_genes_by_counts&gt;</span><span><span leaf="">200</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">adata=adata[adata.obs.n_genes_by_counts&lt;</span><span><span leaf="">2500</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">adata=adata[adata.obs.pct_counts_mt&lt;</span><span><span leaf="">5</span></span><span leaf="">].copy()</span><span leaf=""><br></span><span><span leaf=""># è¿‡æ»¤åæ•°æ®åˆ†å¸ƒæƒ…å†µ</span></span><span leaf=""><br></span><span leaf="">sc.pl.violin(adata,[</span><span><span leaf="">"n_genes_by_counts"</span></span><span leaf="">,Â </span><span><span leaf="">"total_counts"</span></span><span leaf="">,Â </span><span><span leaf="">"pct_counts_mt"</span></span><span leaf="">],jitter=</span><span><span leaf="">0.4</span></span><span leaf="">, multi_panel=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># è¿‡æ»¤åçš„ç»†èƒä¸åŸºå› æ•°</span></span><span leaf=""><br></span><span leaf="">print(adata.shape)</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è¿™å¥½åƒæ˜¯ä¸ªè¿‡æ»¤äº†çš„æ•°æ®ï¼Œå°æç´è¿‡æ»¤å‰åæ²¡å•¥å˜åŒ–ï¼š</span></p><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSdtH1Hmx3Hoibbf6hfoBP0XRNEw6dnBPuXFSibsS8DCTqp0xP7IXXMUCw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.325" data-type="png" data-w="1080" data-imgfileid="100056416" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSdtH1Hmx3Hoibbf6hfoBP0XRNEw6dnBPuXFSibsS8DCTqp0xP7IXXMUCw/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">1.3 æ•°æ®æ ‡å‡†åŒ–ã€é™ç»´èšç±»åˆ†ç¾¤</span></span><span></span></h3><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è¿˜æ˜¯scanpyçš„æ ‡å‡†ä»£ç ï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># æ•°æ®æ ‡å‡†åŒ–</span></span><span leaf=""><br></span><span leaf="">sc.pp.normalize_total(adata,target_sum=</span><span><span leaf="">1e4</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.log1p(adata)</span><span leaf=""><br></span><span leaf="">adata.raw=adata</span><span leaf=""><br></span><span><span leaf=""># é«˜å˜åŸºå› </span></span><span leaf=""><br></span><span leaf="">sc.pp.highly_variable_genes(adata,n_top_genes=</span><span><span leaf="">2000</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># å½’ä¸€åŒ–</span></span><span leaf=""><br></span><span leaf="">sc.pp.scale(adata)</span><span leaf=""><br></span><span leaf="">sc.pp.pca(adata)</span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(adata,n_pcs=</span><span><span leaf="">15</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.tl.leiden(adata,flavor=</span><span><span leaf="">"igraph"</span></span><span leaf="">,n_iterations=</span><span><span leaf="">2</span></span><span leaf="">,resolution=</span><span><span leaf="">0.5</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata)</span><span leaf=""><br></span><span><span leaf=""># å¯è§†åŒ–</span></span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata,color=</span><span><span leaf="">'leiden'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">åˆ°è¿™é‡Œå•ç»†èƒçš„æ ‡å‡†åˆ†æå°±åšå®Œäº†ï¼Œèšç±»ç»“æœå¦‚ä¸‹ï¼š</span></p><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxScsFyEBFx24luicBJ0Osg4OoWRVLiciaDDIVnNxgebCVBSlj1eaHMQEeHA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7138103161397671" data-type="png" data-w="601" data-imgfileid="100056414" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxScsFyEBFx24luicBJ0Osg4OoWRVLiciaDDIVnNxgebCVBSlj1eaHMQEeHA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">1.4 celltypistè‡ªåŠ¨æ³¨é‡Š</span></span><span></span></h3><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><span textstyle="">celltypistè½¯ä»¶äº2022å¹´5æœˆ13å·å‘è¡¨åœ¨é¡¶åˆŠ</span><span textstyle="">Science</span><span textstyle="">æ‚å¿—ä¸Š</span>ï¼Œæ–‡çŒ®æ ‡é¢˜ä¸ºã€ŠCross-tissue immune cell analysis reveals tissue-specific features in humansã€‹ã€‚</span></p><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">ä¸åˆ«çš„è‡ªåŠ¨æ³¨é‡Šç®—æ³•ä¸åŒï¼ŒCellTypistå¯ä»¥è‡ªå®šä¹‰é«˜ç²¾åº¦å’Œä½ç²¾åº¦ï¼Œå³ç›´æ¥æ³¨é‡Šå‡ºç»†èƒçš„äºšç¾¤ã€‚</span></p><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSVkJxCuMktBic32cUmynibk3KJv5P7o37NJM7kVA5OWenoTO1liaz06h6Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3712962962962963" data-type="png" data-w="1080" data-imgfileid="100056417" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSVkJxCuMktBic32cUmynibk3KJv5P7o37NJM7kVA5OWenoTO1liaz06h6Q/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è¿™ä¸ªè½¯ä»¶å·²ç»è®­ç»ƒå¥½çš„å‚è€ƒæ¨¡å‹ï¼šhttps://www.celltypist.org/models</span></p><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">é¦–å…ˆä¸‹è½½modelï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf="">Â celltypist</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf="">Â celltypistÂ </span><span><span leaf="">import</span></span><span leaf="">Â models</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨ä¸‹è½½æ‰€æœ‰çš„å‚è€ƒæ•°æ®</span></span><span leaf=""><br></span><span leaf="">model = models.Model.load(model=</span><span><span leaf="">'Immune_All_High.pkl'</span></span><span leaf="">)Â </span><span><span leaf="">#https://www.celltypist.org/models</span></span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">åŠ¨æ€æ—¥å¿—ï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ğŸ” No available models. Downloading...</span><span leaf=""><br></span><span leaf="">ğŸ“œ Retrieving model list from server https://celltypist.cog.sanger.ac.uk/models/models.json</span><span leaf=""><br></span><span leaf="">ğŸ“š Total modelsÂ </span><span><span leaf="">in</span></span><span leaf="">Â list: 54</span><span leaf=""><br></span><span leaf="">ğŸ“‚ Storing modelsÂ </span><span><span leaf="">in</span></span><span leaf="">Â /home/zhangj/.celltypist/data/models</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [1/54]: Immune_All_Low.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [2/54]: Immune_All_High.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [3/54]: Adult_COVID19_PBMC.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [4/54]: Adult_CynomolgusMacaque_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [5/54]: Adult_Human_MTG.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [6/54]: Adult_Human_PancreaticIslet.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [7/54]: Adult_Human_PrefrontalCortex.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [8/54]: Adult_Human_Skin.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [9/54]: Adult_Human_Vascular.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [10/54]: Adult_Mouse_Gut.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [11/54]: Adult_Mouse_OlfactoryBulb.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [12/54]: Adult_Pig_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [13/54]: Adult_RhesusMacaque_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [14/54]: Autopsy_COVID19_Lung.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [15/54]: COVID19_HumanChallenge_Blood.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [16/54]: COVID19_Immune_Landscape.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [17/54]: Cells_Adult_Breast.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [18/54]: Cells_Fetal_Lung.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [19/54]: Cells_Human_Tonsil.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [20/54]: Cells_Intestinal_Tract.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [21/54]: Cells_Lung_Airway.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [22/54]: Developing_Human_Brain.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [23/54]: Developing_Human_Gonads.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [24/54]: Developing_Human_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [25/54]: Developing_Human_Organs.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [26/54]: Developing_Human_Thymus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [27/54]: Developing_Mouse_Brain.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [28/54]: Developing_Mouse_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [29/54]: Fetal_Human_AdrenalGlands.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [30/54]: Fetal_Human_Pancreas.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [31/54]: Fetal_Human_Pituitary.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [32/54]: Fetal_Human_Retina.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [33/54]: Fetal_Human_Skin.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [34/54]: Healthy_Adult_Heart.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [35/54]: Healthy_COVID19_PBMC.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [36/54]: Healthy_Human_Liver.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [37/54]: Healthy_Mouse_Liver.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [38/54]: Human_AdultAged_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [39/54]: Human_Colorectal_Cancer.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [40/54]: Human_Developmental_Retina.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [41/54]: Human_Embryonic_YolkSac.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [42/54]: Human_Endometrium_Atlas.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [43/54]: Human_IPF_Lung.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [44/54]: Human_Longitudinal_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [45/54]: Human_Lung_Atlas.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [46/54]: Human_PF_Lung.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [47/54]: Human_Placenta_Decidua.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [48/54]: Lethal_COVID19_Lung.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [49/54]: Mouse_Dentate_Gyrus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [50/54]: Mouse_Isocortex_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [51/54]: Mouse_Postnatal_DentateGyrus.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [52/54]: Mouse_Whole_Brain.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [53/54]: Nuclei_Lung_Airway.pkl</span><span leaf=""><br></span><span leaf="">ğŸ’¾ Downloading model [54/54]: Pan_Fetal_Human.pkl</span><span leaf=""><br></span><span leaf="">CellTypist model with 32 cell types and 6639 features</span><span leaf=""><br></span><span leaf="">Â  Â  date: 2022-07-16 08:53:00.959521</span><span leaf=""><br></span><span leaf="">Â  Â  details: immune populations combined from 20 tissues of 18 studies</span><span leaf=""><br></span><span leaf="">Â  Â Â </span><span><span leaf="">source</span></span><span leaf="">: https://doi.org/10.1126/science.abl5197</span><span leaf=""><br></span><span leaf="">Â  Â  version: v2</span><span leaf=""><br></span><span leaf="">Â  Â  cell types: B cells, B-cell lineage, ..., pDC precursor</span><span leaf=""><br></span><span leaf="">Â  Â  features: A1BG, A2M, ..., ZYX</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è¿™æ˜¯é»˜è®¤çš„ä¸‹è½½ç›®å½•ï¼š</span></p><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS4Tkn2OE7P4ypamtsu3Ikk3CKdHVVp90AUWTWEs5n9pgtF2oibYm5A0w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.23097463284379172" data-type="png" data-w="749" data-imgfileid="100056413" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS4Tkn2OE7P4ypamtsu3Ikk3CKdHVVp90AUWTWEs5n9pgtF2oibYm5A0w/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">ä¸‹è½½çš„modelsï¼š</span></p><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS9sHQpm6QB5JWnlvY0icZmEZFRKPUOb4iaDibYBUiaMSsJynGKEhscjXBpA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.14074074074074075" data-type="png" data-w="1080" data-imgfileid="100056418" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS9sHQpm6QB5JWnlvY0icZmEZFRKPUOb4iaDibYBUiaMSsJynGKEhscjXBpA/640?wx_fmt=png&amp;from=appmsg"></span></figure><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">predictions = celltypist.annotate(adata, model = model, majority_voting =Â </span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">print(predictions.predicted_labels)</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">é¢„æµ‹ç»“æœï¼šè¿™é‡Œä½¿ç”¨ç¬¬ä¸‰åˆ—çš„ç»“æœä½œä¸ºç»†èƒç±»å‹æ³¨é‡Šç»“æœ</span><code><span leaf="">majority_voting</span></code></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â predicted_labels over_clustering majority_voting</span><span leaf=""><br></span><span leaf="">AAACATACAACCAC-1 Â  Â  Â  Â  Â T cells Â  Â  Â  Â  Â  Â  Â 40 Â  Â  Â  Â  T cells</span><span leaf=""><br></span><span leaf="">AAACATTGAGCTAC-1 Â  Â  Â  Â  Â B cells Â  Â  Â  Â  Â  Â  Â 14 Â  Â  Â  Â  B cells</span><span leaf=""><br></span><span leaf="">AAACATTGATCAGC-1 Â  Â  Â  Â  Â T cells Â  Â  Â  Â  Â  Â  Â 10 Â  Â  Â  Â  T cells</span><span leaf=""><br></span><span leaf="">AAACCGTGCTTCCG-1 Â  Â  Â  Â Monocytes Â  Â  Â  Â  Â  Â  Â  6 Â  Â  Â  Monocytes</span><span leaf=""><br></span><span leaf="">AAACCGTGTATGCG-1 Â  Â  Â  Â  Â  Â  Â ILC Â  Â  Â  Â  Â  Â  Â 22 Â  Â  Â  Â  Â  Â  ILC</span><span leaf=""><br></span><span leaf="">... Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ... Â  Â  Â  Â  Â  Â  ... Â  Â  Â  Â  Â  Â  ...</span><span leaf=""><br></span><span leaf="">TTTCGAACTCTCAT-1 Â  Â  Â  Â Monocytes Â  Â  Â  Â  Â  Â  Â  1 Â  Â  Â  Monocytes</span><span leaf=""><br></span><span leaf="">TTTCTACTGAGGCA-1 Â  Â  Plasma cells Â  Â  Â  Â  Â  Â  Â 14 Â  Â  Â  Â  B cells</span><span leaf=""><br></span><span leaf="">TTTCTACTTCCTCG-1 Â  Â  Â  Â  Â B cells Â  Â  Â  Â  Â  Â  Â  8 Â  Â  Â  Â  B cells</span><span leaf=""><br></span><span leaf="">TTTGCATGAGAGGC-1 Â  Â  Â  Â  Â B cells Â  Â  Â  Â  Â  Â  Â  8 Â  Â  Â  Â  B cells</span><span leaf=""><br></span><span leaf="">TTTGCATGCCTCAC-1 Â  Â  Â  Â  Â T cells Â  Â  Â  Â  Â  Â  Â 34 Â  Â  Â  Â  T cells</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">æ•´ç†ä¸€ä¸‹é¢„æµ‹ç»“æœï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata2 = predictions.to_adata()</span><span leaf=""><br></span><span leaf="">print(adata2.obs)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># ä¿®æ”¹ä¸€ä¸‹é¢„æµ‹çš„ç»†èƒåå­—ï¼Œä¸ªäººä¹ æƒ¯ï¼Œä¹Ÿå¯ä»¥ä¸æ”¹</span></span><span leaf=""><br></span><span><span leaf=""># å»æ‰åå­—å†²çš„cells</span></span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(</span><span><span leaf="">' cells'</span></span><span leaf="">,Â </span><span><span leaf="">''</span></span><span leaf="">, regex=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># æŠŠmonocytesæ”¹ä¸ºMono</span></span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(</span><span><span leaf="">' monocytes'</span></span><span leaf="">,Â </span><span><span leaf="">' Mono'</span></span><span leaf="">, regex=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">æ•´ç†ä¹‹åï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">AAACATACAACCAC-1 Â  Â  Â  Â  Â  Â T</span><span leaf=""><br></span><span leaf="">AAACATTGAGCTAC-1 Â  Â  Â  Â  Â  Â B</span><span leaf=""><br></span><span leaf="">AAACATTGATCAGC-1 Â  Â  Â  Â  Â  Â T</span><span leaf=""><br></span><span leaf="">AAACCGTGCTTCCG-1 Â  Â Monocytes</span><span leaf=""><br></span><span leaf="">AAACCGTGTATGCG-1 Â  Â  Â  Â  Â ILC</span><span leaf=""><br></span><span leaf="">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ... Â  Â </span><span leaf=""><br></span><span leaf="">TTTCGAACTCTCAT-1 Â  Â Monocytes</span><span leaf=""><br></span><span leaf="">TTTCTACTGAGGCA-1 Â  Â  Â  Â  Â  Â B</span><span leaf=""><br></span><span leaf="">TTTCTACTTCCTCG-1 Â  Â  Â  Â  Â  Â B</span><span leaf=""><br></span><span leaf="">TTTGCATGAGAGGC-1 Â  Â  Â  Â  Â  Â B</span><span leaf=""><br></span><span leaf="">TTTGCATGCCTCAC-1 Â  Â  Â  Â  Â  Â T</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">umapå¯è§†åŒ–çœ‹ä¸€ä¸‹ï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.tl.umap(adata2)</span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata2, color =Â </span><span><span leaf="">'majority_voting'</span></span><span leaf="">,legend_loc=</span><span><span leaf="">"on data"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSe3giasgAXz8pk8pe1gQJOwuTQmIKBbQicXskK4uKKFS5kHsAY6Hw9sKA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8018691588785046" data-type="png" data-w="535" data-imgfileid="100056420" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSe3giasgAXz8pk8pe1gQJOwuTQmIKBbQicXskK4uKKFS5kHsAY6Hw9sKA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdniceç¼–è¾‘å™¨"><span></span><span><span leaf="">2.å¤šæ ·æœ¬çš„celltypistæ³¨é‡Š</span></span><span></span></h2><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è¿™é‡Œä¸å•æ ·æœ¬çš„åŒºåˆ«åœ¨äºæ•°æ®çš„è¯»å–å’Œåˆå¹¶ï¼Œå…ˆæ¥è¯»å–ä¸€ä¸‹ï¼šè¯»å–çš„æ•°æ®ä¸º02_dataï¼Œè¿™é‡Œæˆ‘ä¹Ÿæ²¡æœ‰è·å–åˆ°æ•°æ®çš„èƒŒæ™¯ä¿¡æ¯ï¼ˆæ•°æ®æ˜¯ä»€ä¹ˆç»„ç»‡ï¼Œå¦‚ä½•å–æ ·ï¼Œä»¥ä¾¿äº†è§£é‡Œé¢å¯èƒ½åŒ…å«çš„ç»†èƒç±»å‹ï¼Œè¿™æ˜¯åšç»†èƒç±»å‹æ³¨é‡Šå¿…é¡»äº†è§£çš„å†…å®¹ï¼Œåé¢celltypistçš„æ¨¡å‹é€‰æ‹©ä¹Ÿä¼šæœ‰å‚è€ƒï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œå°±çœ‹çœ‹ä»£ç å°±å¥½äº†ã€‚</span></p><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">02_dataçš„ç›®å½•ä¸‹æœ‰ä¸‰ä¸ªæ ·æœ¬ï¼Œ'TD1', 'TD2', 'TD3'ï¼Œæ¯ä¸ªæ ·æœ¬ä¸‹é¢æ˜¯æ ‡å‡†çš„ä¸‰ä¸ªæ–‡ä»¶ï¼š'barcodes.tsv.gz', 'features.tsv.gz', 'matrix.mtx.gz'</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">import scanpy as sc</span><span leaf=""><br></span><span leaf="">import os</span><span leaf=""><br></span><span leaf="">import pandas as pd</span><span leaf=""><br></span><span leaf="">from scipy.io import mmread</span><span leaf=""><br></span><span leaf="">import anndata</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># åˆ—å‡ºç›®å½•ä¸‹çš„æ–‡ä»¶æœ‰å“ªäº›</span></span><span leaf=""><br></span><span leaf="">path1=</span><span><span leaf="">'02_data/'</span></span><span leaf=""><br></span><span leaf="">os.listdir(path1)</span><span leaf=""><br></span><span leaf="">os.listdir(</span><span><span leaf="">'02_data/TD1/'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">å…³äºpythonè¯»å–å•ç»†èƒï¼Œå„ç§æ ¼å¼ï¼Œå¯ä»¥çœ‹æˆ‘ä»¬å‰é¢çš„å¸–å­ï¼š</span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247538849&amp;idx=1&amp;sn=f4c67849e2474221833e50852d9dba17&amp;scene=21#wechat_redirect"><span leaf="">pythonç‰ˆè¯»å–ä¸åŒçš„å•ç»†èƒæ•°æ®æ ¼å¼ï¼ˆå•æ ·æœ¬ä¸å¤šæ ·æœ¬ï¼‰</span></a></p><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">å¤šæ ·æœ¬è¯»å–ï¼šç”¨forå¾ªç¯æ‰¹é‡è¯»å–æ•°æ®</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># ç”¨forå¾ªç¯æ‰¹é‡è¯»å–æ•°æ®</span></span><span leaf=""><br></span><span leaf="">adata = {}</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf="">Â iÂ </span><span><span leaf="">in</span></span><span leaf="">Â range(len(os.listdir(path1))):</span><span leaf=""><br></span><span leaf="">Â  Â  data = sc.read_10x_mtx(path1 +os.listdir(path1)[i], var_names=</span><span><span leaf="">"gene_symbols"</span></span><span leaf="">, cache=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">Â  Â  data.var_names_make_unique() Â </span><span leaf=""><br></span><span leaf="">Â  Â  adata[os.listdir(path1)[i]] = data</span><span leaf=""><br></span><span leaf="">Â  Â  print([</span><span><span leaf="">f'</span><span><span leaf="">{os.listdir(path1)[i]}</span></span><span leaf="">:done'</span></span><span leaf="">]+list([data.shape]))</span><span leaf=""><br></span><span leaf="">Â  Â Â </span><span leaf=""><br></span><span><span leaf=""># æŠŠå¤šä¸ªæ•°æ®æ‹¼æ¥åˆ°ä¸€èµ·ï¼Œæˆä¸ºä¸€ä¸ªå¤§çš„anndataå¯¹è±¡</span></span><span leaf=""><br></span><span leaf="">adata = sc.concat(adata,label=</span><span><span leaf="">'sample'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata.obs_names_make_unique()</span><span leaf=""><br></span><span leaf="">adata</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># æ¯ä¸ªæ ·æœ¬é‡Œçš„ç»†èƒæ•°é‡</span></span><span leaf=""><br></span><span leaf="">adata.obs.sample.value_counts()Â </span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">ç„¶åæ˜¯è´¨æ§ï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.pp.filter_cells(adata,min_genes=</span><span><span leaf="">300</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.filter_genes(adata,min_cells=</span><span><span leaf="">5</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf="">#è®¡ç®—çº¿ç²’ä½“åŸºå› æ¯”ä¾‹</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'mt'</span></span><span leaf="">]=adata.var_names.str.startswith(</span><span><span leaf="">'MT-'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># è®¡ç®—æ ¸ç³–ä½“åŸºå› æ¯”ä¾‹</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'ribo'</span></span><span leaf="">]=adata.var_names.str.match(</span><span><span leaf="">'^RP[SL]'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># è®¡ç®—çº¢è¡€ç»†èƒåŸºå› æ¯”ä¾‹</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'hb'</span></span><span leaf="">]=adata.var_names.str.match(</span><span><span leaf="">'^HB[^(P)]'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.calculate_qc_metrics(adata,qc_vars=[</span><span><span leaf="">'mt'</span></span><span leaf="">,</span><span><span leaf="">'ribo'</span></span><span leaf="">,</span><span><span leaf="">'hb'</span></span><span leaf="">],percent_top=</span><span><span leaf="">None</span></span><span leaf="">,log1p=</span><span><span leaf="">False</span></span><span leaf="">,inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># å¯è§†åŒ–ç»†èƒçš„ä¸Šè¿°æ¯”ä¾‹æƒ…å†µ</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sc.pl.violin(adata,[</span><span><span leaf="">'n_genes_by_counts'</span></span><span leaf="">,</span><span><span leaf="">'total_counts'</span></span><span leaf="">],groupby=</span><span><span leaf="">'batch'</span></span><span leaf="">,jitter=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è´¨æ§å‰çš„å°æç´å›¾ï¼š</span></p><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS57ibowrmhVL265QORhuHicRCtYn830AkBiacrnYGeEZtiaYmFr2sMetRlw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3101851851851852" data-type="png" data-w="1080" data-imgfileid="100056419" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS57ibowrmhVL265QORhuHicRCtYn830AkBiacrnYGeEZtiaYmFr2sMetRlw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è¿‡æ»¤ç»†èƒï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata = adata[adata.obs.n_genes_by_counts &lt; 6000, :]</span><span leaf=""><br></span><span leaf="">adata = adata[adata.obs.pct_counts_mt &lt; 18, :].copy()</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">åˆæ˜¯å¸¸è§„çš„é™ç»´èšç±»ï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.pp.normalize_total(adata,target_sum=</span><span><span leaf="">1e4</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.log1p(adata)</span><span leaf=""><br></span><span leaf="">adata.raw = adata.copy()</span><span leaf=""><br></span><span><span leaf="">#celltypiståŒ…éœ€è¦çš„æ•°æ®æ˜¯log normlizeä¹‹åçš„æ•°æ®ï¼Œä¼šä½¿ç”¨è¿™é‡Œçš„adata.rawã€‚</span></span><span leaf=""><br></span><span leaf="">sc.pp.highly_variable_genes(adata)</span><span leaf=""><br></span><span leaf="">sc.pp.scale(adata)</span><span leaf=""><br></span><span leaf="">sc.tl.pca(adata,use_highly_variable=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.external.pp.harmony_integrate(adata,</span><span><span leaf="">'batch'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf="">#èšç±»</span></span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(adata,use_rep=</span><span><span leaf="">'X_pca_harmony'</span></span><span leaf="">,n_pcs=</span><span><span leaf="">15</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata)</span><span leaf=""><br></span><span leaf="">sc.tl.leiden(adata, flavor=</span><span><span leaf="">"igraph"</span></span><span leaf="">, n_iterations=</span><span><span leaf="">2</span></span><span leaf="">,resolution=</span><span><span leaf="">0.5</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata,color=</span><span><span leaf="">'leiden'</span></span><span leaf="">,legend_loc=</span><span><span leaf="">'on data'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSAe1tFYbKZFGG7phdRUN6x1pl3iapLuK5PuibNFzfeeV2fHDy6mGWUE7g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.805607476635514" data-type="png" data-w="535" data-imgfileid="100056422" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSAe1tFYbKZFGG7phdRUN6x1pl3iapLuK5PuibNFzfeeV2fHDy6mGWUE7g/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">æ³¨é‡Šï¼š</span></p><pre data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf="">Â celltypist</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf="">Â celltypistÂ </span><span><span leaf="">import</span></span><span leaf="">Â models</span><span leaf=""><br></span><span leaf="">model = models.Model.load(model=</span><span><span leaf="">'Immune_All_High.pkl'</span></span><span leaf="">)Â </span><span><span leaf="">#https://www.celltypist.org/models</span></span><span leaf=""><br></span><span leaf="">model</span><span leaf=""><br></span><span leaf="">predictions = celltypist.annotate(adata, model = model, majority_voting =Â </span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">print(predictions.predicted_labels)</span><span leaf=""><br></span><span leaf="">adata2 = predictions.to_adata()</span><span leaf=""><br></span><span leaf="">print(adata2.obs)</span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(</span><span><span leaf="">' cells'</span></span><span leaf="">,Â </span><span><span leaf="">''</span></span><span leaf="">, regex=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(</span><span><span leaf="">' monocytes'</span></span><span leaf="">,Â </span><span><span leaf="">' Mono'</span></span><span leaf="">, regex=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting</span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata2)</span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata2, color =Â </span><span><span leaf="">'majority_voting'</span></span><span leaf="">,legend_loc=</span><span><span leaf="">"on data"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">æ³¨é‡Šç»“æœå¦‚ä¸‹ï¼š</span></p><figure data-tool="mdniceç¼–è¾‘å™¨"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSlgiaVBIgaEJUz4lB7MibMBrGQOKOqyQQyZqHgQDqLpMPPGKc3Y8RlCSA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.805607476635514" data-type="png" data-w="535" data-imgfileid="100056421" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSlgiaVBIgaEJUz4lB7MibMBrGQOKOqyQQyZqHgQDqLpMPPGKc3Y8RlCSA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdniceç¼–è¾‘å™¨"><span leaf="">è½¯ä»¶çš„åŸç†ï¼Œåé¢ä¼šåœ¨å•ç‹¬åˆ†äº«ä¸€æ¬¡ç»†èŠ‚~</span></p><h3 data-tool="mdniceç¼–è¾‘å™¨"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">æ–‡æœ«å‹æƒ…å®£ä¼ </span></span><span></span></h3><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247539788&amp;idx=1&amp;sn=62a09c7af6373658bf81c149eb0b4026&amp;scene=21#wechat_redirect"><span leaf="">ç”Ÿä¿¡å…¥é—¨&amp;æ•°æ®æŒ–æ˜çº¿ä¸Šç›´æ’­è¯¾4æœˆç­</span></a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect"><span leaf="">æ—¶éš”5å¹´ï¼Œæˆ‘ä»¬çš„ç”Ÿä¿¡æŠ€èƒ½æ ‘VIPå­¦å¾’ç»§ç»­æ‹›ç”Ÿå•¦</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect"><span leaf="">æ»¡è¶³ä½ ç”Ÿä¿¡åˆ†æè®¡ç®—éœ€æ±‚çš„ä½ä»·è§£å†³æ–¹æ¡ˆ</span></a></section></li></ul></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/c671N5MbH51cao3lhuswVQ",target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a>
