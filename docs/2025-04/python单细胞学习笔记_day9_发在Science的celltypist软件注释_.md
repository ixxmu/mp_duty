---
title: "python单细胞学习笔记-day9(发在Science的celltypist软件注释)"
date: 2025-04-14T09:21:17Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
python单细胞学习笔记-day9(发在Science的celltypist软件注释) by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">前面的python学习笔记：：</span></p><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536678&amp;idx=2&amp;sn=e17fcf623ccd788839f1ca6963c45f80&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day1</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536678&amp;idx=3&amp;sn=ea9bc59b48809350fd25e84039515950&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day2</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536822&amp;idx=2&amp;sn=3f99b79a7edca965b3ed5378281a1686&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day3</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536945&amp;idx=2&amp;sn=3d829370b31f66df60caebaa79af2bf3&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day4</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247537192&amp;idx=2&amp;sn=302ddaad4275f00bb539c8614d892130&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day4（续）</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247537290&amp;idx=2&amp;sn=d90812996f6ca7eadaae7cf080b37cf0&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day5</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247537412&amp;idx=2&amp;sn=8c83666635bd5c656d6fc958f67bbd8a&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day6</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247539696&amp;idx=2&amp;sn=16cabd270e27dd7261d45e9dae62ef58&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day7</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247539852&amp;idx=1&amp;sn=e9a719dbc99677aab2a913d65a180bf6&amp;scene=21#wechat_redirect"><span leaf="">python单细胞学习笔记-day8(singler自动注释)</span></a></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">今天继续学习视频：学习celltypist细胞注释，单样本和多样本~</span></p><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">0.环境准备</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">在之前的conda环境中安装新的本次上课需要的几个包：（建议先不要全都安装上，很容易后面出现包导入失败，可以运行到哪个代码缺少模块再开始安装~）</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># bash终端</span></span><span leaf=""><br></span><span leaf="">conda activate sc</span><span leaf=""><br></span><span><span leaf=""># 安装 scikit-learn库</span></span><span leaf=""><br></span><span leaf="">pip install singler -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install singlecellexperiment -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install scranpy -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install celldex -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install celltypist -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install harmonypy -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple</span><span leaf=""><br></span><span leaf="">pip install loompy -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple    </span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">文件说明：</span></p><ul><li><section><span leaf="">2.celltypist.ipynb：单样本的单细胞标准分析以及后面的celltypilst细胞注释</span></section></li><li><section><span leaf="">4.celltypist_multisamples.ipynb：多样本的单细胞标准分析以及后面的celltypilst细胞注释</span></section></li></ul><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">1.单样本的celltypist注释</span></span><span></span></h2><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">1.1 数据读取</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">用read_10x_mtx</span></code><span leaf="">读取10x cellranger的三个标准文件，01_data 的文件：'barcodes.tsv', 'genes.tsv', 'matrix.mtx'</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf=""> singlecellexperiment </span><span><span leaf="">as</span></span><span leaf=""> sce</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> scanpy </span><span><span leaf="">as</span></span><span leaf=""> sc</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> os</span><span leaf=""><br></span><span leaf="">print(os.listdir(</span><span><span leaf="">"01_data"</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 读取数据</span></span><span leaf=""><br></span><span leaf="">adata = sc.read_10x_mtx(</span><span><span leaf="">"01_data/"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">print(adata.shape)</span><span leaf=""><br></span><span leaf="">adata.X</span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">1.2 数据质控</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">都是常规流程，快速看下数据分布特点决定数据过滤条件：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 计算线粒体基因表达比例</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'mt'</span></span><span leaf="">]=adata.var_names.str.startswith(</span><span><span leaf="">'MT-'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.calculate_qc_metrics(adata,qc_vars=[</span><span><span leaf="">'mt'</span></span><span leaf="">],log1p=</span><span><span leaf="">False</span></span><span leaf="">,percent_top=</span><span><span leaf="">None</span></span><span leaf="">,inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 过滤前数据分布情况</span></span><span leaf=""><br></span><span leaf="">sc.pl.violin(adata,[</span><span><span leaf="">"n_genes_by_counts"</span></span><span leaf="">, </span><span><span leaf="">"total_counts"</span></span><span leaf="">, </span><span><span leaf="">"pct_counts_mt"</span></span><span leaf="">],jitter=</span><span><span leaf="">0.4</span></span><span leaf="">, multi_panel=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSDd045QpEJwK8BTF7rvPDXOSiclcHbQfiblZcA9pv88p1k4ZhodFSwYtg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.325" data-type="png" data-w="1080" data-imgfileid="100056415" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSDd045QpEJwK8BTF7rvPDXOSiclcHbQfiblZcA9pv88p1k4ZhodFSwYtg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">过滤：这里这个数据我不太清楚来自哪里以及是什么组织类型，所以如果是自己的数据需要结合项目背景来看：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 确定过滤条件并过滤</span></span><span leaf=""><br></span><span><span leaf=""># 初始过滤</span></span><span leaf=""><br></span><span leaf="">sc.pp.filter_cells(adata,min_genes=</span><span><span leaf="">200</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.filter_genes(adata,min_cells=</span><span><span leaf="">3</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata=adata[adata.obs.n_genes_by_counts&gt;</span><span><span leaf="">200</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">adata=adata[adata.obs.n_genes_by_counts&lt;</span><span><span leaf="">2500</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">adata=adata[adata.obs.pct_counts_mt&lt;</span><span><span leaf="">5</span></span><span leaf="">].copy()</span><span leaf=""><br></span><span><span leaf=""># 过滤后数据分布情况</span></span><span leaf=""><br></span><span leaf="">sc.pl.violin(adata,[</span><span><span leaf="">"n_genes_by_counts"</span></span><span leaf="">, </span><span><span leaf="">"total_counts"</span></span><span leaf="">, </span><span><span leaf="">"pct_counts_mt"</span></span><span leaf="">],jitter=</span><span><span leaf="">0.4</span></span><span leaf="">, multi_panel=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 过滤后的细胞与基因数</span></span><span leaf=""><br></span><span leaf="">print(adata.shape)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">这好像是个过滤了的数据，小提琴过滤前后没啥变化：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSdtH1Hmx3Hoibbf6hfoBP0XRNEw6dnBPuXFSibsS8DCTqp0xP7IXXMUCw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.325" data-type="png" data-w="1080" data-imgfileid="100056416" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSdtH1Hmx3Hoibbf6hfoBP0XRNEw6dnBPuXFSibsS8DCTqp0xP7IXXMUCw/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">1.3 数据标准化、降维聚类分群</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">还是scanpy的标准代码：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 数据标准化</span></span><span leaf=""><br></span><span leaf="">sc.pp.normalize_total(adata,target_sum=</span><span><span leaf="">1e4</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.log1p(adata)</span><span leaf=""><br></span><span leaf="">adata.raw=adata</span><span leaf=""><br></span><span><span leaf=""># 高变基因</span></span><span leaf=""><br></span><span leaf="">sc.pp.highly_variable_genes(adata,n_top_genes=</span><span><span leaf="">2000</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 归一化</span></span><span leaf=""><br></span><span leaf="">sc.pp.scale(adata)</span><span leaf=""><br></span><span leaf="">sc.pp.pca(adata)</span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(adata,n_pcs=</span><span><span leaf="">15</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.tl.leiden(adata,flavor=</span><span><span leaf="">"igraph"</span></span><span leaf="">,n_iterations=</span><span><span leaf="">2</span></span><span leaf="">,resolution=</span><span><span leaf="">0.5</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata)</span><span leaf=""><br></span><span><span leaf=""># 可视化</span></span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata,color=</span><span><span leaf="">'leiden'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">到这里单细胞的标准分析就做完了，聚类结果如下：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxScsFyEBFx24luicBJ0Osg4OoWRVLiciaDDIVnNxgebCVBSlj1eaHMQEeHA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7138103161397671" data-type="png" data-w="601" data-imgfileid="100056414" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxScsFyEBFx24luicBJ0Osg4OoWRVLiciaDDIVnNxgebCVBSlj1eaHMQEeHA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">1.4 celltypist自动注释</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">celltypist软件于2022年5月13号发表在顶刊</span><span textstyle="">Science</span><span textstyle="">杂志上</span>，文献标题为《Cross-tissue immune cell analysis reveals tissue-specific features in humans》。</span></p><p data-tool="mdnice编辑器"><span leaf="">与别的自动注释算法不同，CellTypist可以自定义高精度和低精度，即直接注释出细胞的亚群。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSVkJxCuMktBic32cUmynibk3KJv5P7o37NJM7kVA5OWenoTO1liaz06h6Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3712962962962963" data-type="png" data-w="1080" data-imgfileid="100056417" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSVkJxCuMktBic32cUmynibk3KJv5P7o37NJM7kVA5OWenoTO1liaz06h6Q/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">这个软件已经训练好的参考模型：https://www.celltypist.org/models</span></p><p data-tool="mdnice编辑器"><span leaf="">首先下载model：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf=""> celltypist</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> celltypist </span><span><span leaf="">import</span></span><span leaf=""> models</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 第一次使用时，会自动下载所有的参考数据</span></span><span leaf=""><br></span><span leaf="">model = models.Model.load(model=</span><span><span leaf="">'Immune_All_High.pkl'</span></span><span leaf="">) </span><span><span leaf="">#https://www.celltypist.org/models</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">动态日志：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">🔎 No available models. Downloading...</span><span leaf=""><br></span><span leaf="">📜 Retrieving model list from server https://celltypist.cog.sanger.ac.uk/models/models.json</span><span leaf=""><br></span><span leaf="">📚 Total models </span><span><span leaf="">in</span></span><span leaf=""> list: 54</span><span leaf=""><br></span><span leaf="">📂 Storing models </span><span><span leaf="">in</span></span><span leaf=""> /home/zhangj/.celltypist/data/models</span><span leaf=""><br></span><span leaf="">💾 Downloading model [1/54]: Immune_All_Low.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [2/54]: Immune_All_High.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [3/54]: Adult_COVID19_PBMC.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [4/54]: Adult_CynomolgusMacaque_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [5/54]: Adult_Human_MTG.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [6/54]: Adult_Human_PancreaticIslet.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [7/54]: Adult_Human_PrefrontalCortex.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [8/54]: Adult_Human_Skin.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [9/54]: Adult_Human_Vascular.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [10/54]: Adult_Mouse_Gut.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [11/54]: Adult_Mouse_OlfactoryBulb.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [12/54]: Adult_Pig_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [13/54]: Adult_RhesusMacaque_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [14/54]: Autopsy_COVID19_Lung.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [15/54]: COVID19_HumanChallenge_Blood.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [16/54]: COVID19_Immune_Landscape.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [17/54]: Cells_Adult_Breast.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [18/54]: Cells_Fetal_Lung.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [19/54]: Cells_Human_Tonsil.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [20/54]: Cells_Intestinal_Tract.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [21/54]: Cells_Lung_Airway.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [22/54]: Developing_Human_Brain.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [23/54]: Developing_Human_Gonads.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [24/54]: Developing_Human_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [25/54]: Developing_Human_Organs.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [26/54]: Developing_Human_Thymus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [27/54]: Developing_Mouse_Brain.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [28/54]: Developing_Mouse_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [29/54]: Fetal_Human_AdrenalGlands.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [30/54]: Fetal_Human_Pancreas.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [31/54]: Fetal_Human_Pituitary.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [32/54]: Fetal_Human_Retina.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [33/54]: Fetal_Human_Skin.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [34/54]: Healthy_Adult_Heart.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [35/54]: Healthy_COVID19_PBMC.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [36/54]: Healthy_Human_Liver.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [37/54]: Healthy_Mouse_Liver.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [38/54]: Human_AdultAged_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [39/54]: Human_Colorectal_Cancer.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [40/54]: Human_Developmental_Retina.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [41/54]: Human_Embryonic_YolkSac.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [42/54]: Human_Endometrium_Atlas.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [43/54]: Human_IPF_Lung.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [44/54]: Human_Longitudinal_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [45/54]: Human_Lung_Atlas.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [46/54]: Human_PF_Lung.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [47/54]: Human_Placenta_Decidua.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [48/54]: Lethal_COVID19_Lung.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [49/54]: Mouse_Dentate_Gyrus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [50/54]: Mouse_Isocortex_Hippocampus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [51/54]: Mouse_Postnatal_DentateGyrus.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [52/54]: Mouse_Whole_Brain.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [53/54]: Nuclei_Lung_Airway.pkl</span><span leaf=""><br></span><span leaf="">💾 Downloading model [54/54]: Pan_Fetal_Human.pkl</span><span leaf=""><br></span><span leaf="">CellTypist model with 32 cell types and 6639 features</span><span leaf=""><br></span><span leaf="">    date: 2022-07-16 08:53:00.959521</span><span leaf=""><br></span><span leaf="">    details: immune populations combined from 20 tissues of 18 studies</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">source</span></span><span leaf="">: https://doi.org/10.1126/science.abl5197</span><span leaf=""><br></span><span leaf="">    version: v2</span><span leaf=""><br></span><span leaf="">    cell types: B cells, B-cell lineage, ..., pDC precursor</span><span leaf=""><br></span><span leaf="">    features: A1BG, A2M, ..., ZYX</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">这是默认的下载目录：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS4Tkn2OE7P4ypamtsu3Ikk3CKdHVVp90AUWTWEs5n9pgtF2oibYm5A0w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.23097463284379172" data-type="png" data-w="749" data-imgfileid="100056413" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS4Tkn2OE7P4ypamtsu3Ikk3CKdHVVp90AUWTWEs5n9pgtF2oibYm5A0w/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">下载的models：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS9sHQpm6QB5JWnlvY0icZmEZFRKPUOb4iaDibYBUiaMSsJynGKEhscjXBpA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.14074074074074075" data-type="png" data-w="1080" data-imgfileid="100056418" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS9sHQpm6QB5JWnlvY0icZmEZFRKPUOb4iaDibYBUiaMSsJynGKEhscjXBpA/640?wx_fmt=png&amp;from=appmsg"></span></figure><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">predictions = celltypist.annotate(adata, model = model, majority_voting = </span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">print(predictions.predicted_labels)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">预测结果：这里使用第三列的结果作为细胞类型注释结果</span><code><span leaf="">majority_voting</span></code></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">                         predicted_labels over_clustering majority_voting</span><span leaf=""><br></span><span leaf="">AAACATACAACCAC-1          T cells              40         T cells</span><span leaf=""><br></span><span leaf="">AAACATTGAGCTAC-1          B cells              14         B cells</span><span leaf=""><br></span><span leaf="">AAACATTGATCAGC-1          T cells              10         T cells</span><span leaf=""><br></span><span leaf="">AAACCGTGCTTCCG-1        Monocytes               6       Monocytes</span><span leaf=""><br></span><span leaf="">AAACCGTGTATGCG-1              ILC              22             ILC</span><span leaf=""><br></span><span leaf="">...                           ...             ...             ...</span><span leaf=""><br></span><span leaf="">TTTCGAACTCTCAT-1        Monocytes               1       Monocytes</span><span leaf=""><br></span><span leaf="">TTTCTACTGAGGCA-1     Plasma cells              14         B cells</span><span leaf=""><br></span><span leaf="">TTTCTACTTCCTCG-1          B cells               8         B cells</span><span leaf=""><br></span><span leaf="">TTTGCATGAGAGGC-1          B cells               8         B cells</span><span leaf=""><br></span><span leaf="">TTTGCATGCCTCAC-1          T cells              34         T cells</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">整理一下预测结果：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata2 = predictions.to_adata()</span><span leaf=""><br></span><span leaf="">print(adata2.obs)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 修改一下预测的细胞名字，个人习惯，也可以不改</span></span><span leaf=""><br></span><span><span leaf=""># 去掉名字冲的cells</span></span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(</span><span><span leaf="">' cells'</span></span><span leaf="">, </span><span><span leaf="">''</span></span><span leaf="">, regex=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 把monocytes改为Mono</span></span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(</span><span><span leaf="">' monocytes'</span></span><span leaf="">, </span><span><span leaf="">' Mono'</span></span><span leaf="">, regex=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">整理之后：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">AAACATACAACCAC-1            T</span><span leaf=""><br></span><span leaf="">AAACATTGAGCTAC-1            B</span><span leaf=""><br></span><span leaf="">AAACATTGATCAGC-1            T</span><span leaf=""><br></span><span leaf="">AAACCGTGCTTCCG-1    Monocytes</span><span leaf=""><br></span><span leaf="">AAACCGTGTATGCG-1          ILC</span><span leaf=""><br></span><span leaf="">                      ...    </span><span leaf=""><br></span><span leaf="">TTTCGAACTCTCAT-1    Monocytes</span><span leaf=""><br></span><span leaf="">TTTCTACTGAGGCA-1            B</span><span leaf=""><br></span><span leaf="">TTTCTACTTCCTCG-1            B</span><span leaf=""><br></span><span leaf="">TTTGCATGAGAGGC-1            B</span><span leaf=""><br></span><span leaf="">TTTGCATGCCTCAC-1            T</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">umap可视化看一下：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.tl.umap(adata2)</span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata2, color = </span><span><span leaf="">'majority_voting'</span></span><span leaf="">,legend_loc=</span><span><span leaf="">"on data"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSe3giasgAXz8pk8pe1gQJOwuTQmIKBbQicXskK4uKKFS5kHsAY6Hw9sKA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8018691588785046" data-type="png" data-w="535" data-imgfileid="100056420" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSe3giasgAXz8pk8pe1gQJOwuTQmIKBbQicXskK4uKKFS5kHsAY6Hw9sKA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">2.多样本的celltypist注释</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">这里与单样本的区别在于数据的读取和合并，先来读取一下：读取的数据为02_data，这里我也没有获取到数据的背景信息（数据是什么组织，如何取样，以便了解里面可能包含的细胞类型，这是做细胞类型注释必须了解的内容，后面celltypist的模型选择也会有参考），所以这里就看看代码就好了。</span></p><p data-tool="mdnice编辑器"><span leaf="">02_data的目录下有三个样本，'TD1', 'TD2', 'TD3'，每个样本下面是标准的三个文件：'barcodes.tsv.gz', 'features.tsv.gz', 'matrix.mtx.gz'</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">import scanpy as sc</span><span leaf=""><br></span><span leaf="">import os</span><span leaf=""><br></span><span leaf="">import pandas as pd</span><span leaf=""><br></span><span leaf="">from scipy.io import mmread</span><span leaf=""><br></span><span leaf="">import anndata</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 列出目录下的文件有哪些</span></span><span leaf=""><br></span><span leaf="">path1=</span><span><span leaf="">'02_data/'</span></span><span leaf=""><br></span><span leaf="">os.listdir(path1)</span><span leaf=""><br></span><span leaf="">os.listdir(</span><span><span leaf="">'02_data/TD1/'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">关于python读取单细胞，各种格式，可以看我们前面的帖子：</span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247538849&amp;idx=1&amp;sn=f4c67849e2474221833e50852d9dba17&amp;scene=21#wechat_redirect"><span leaf="">python版读取不同的单细胞数据格式（单样本与多样本）</span></a></p><p data-tool="mdnice编辑器"><span leaf="">多样本读取：用for循环批量读取数据</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 用for循环批量读取数据</span></span><span leaf=""><br></span><span leaf="">adata = {}</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> i </span><span><span leaf="">in</span></span><span leaf=""> range(len(os.listdir(path1))):</span><span leaf=""><br></span><span leaf="">    data = sc.read_10x_mtx(path1 +os.listdir(path1)[i], var_names=</span><span><span leaf="">"gene_symbols"</span></span><span leaf="">, cache=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    data.var_names_make_unique()  </span><span leaf=""><br></span><span leaf="">    adata[os.listdir(path1)[i]] = data</span><span leaf=""><br></span><span leaf="">    print([</span><span><span leaf="">f'</span><span><span leaf="">{os.listdir(path1)[i]}</span></span><span leaf="">:done'</span></span><span leaf="">]+list([data.shape]))</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span><span leaf=""># 把多个数据拼接到一起，成为一个大的anndata对象</span></span><span leaf=""><br></span><span leaf="">adata = sc.concat(adata,label=</span><span><span leaf="">'sample'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata.obs_names_make_unique()</span><span leaf=""><br></span><span leaf="">adata</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 每个样本里的细胞数量</span></span><span leaf=""><br></span><span leaf="">adata.obs.sample.value_counts() </span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">然后是质控：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.pp.filter_cells(adata,min_genes=</span><span><span leaf="">300</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.filter_genes(adata,min_cells=</span><span><span leaf="">5</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf="">#计算线粒体基因比例</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'mt'</span></span><span leaf="">]=adata.var_names.str.startswith(</span><span><span leaf="">'MT-'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 计算核糖体基因比例</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'ribo'</span></span><span leaf="">]=adata.var_names.str.match(</span><span><span leaf="">'^RP[SL]'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 计算红血细胞基因比例</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'hb'</span></span><span leaf="">]=adata.var_names.str.match(</span><span><span leaf="">'^HB[^(P)]'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.calculate_qc_metrics(adata,qc_vars=[</span><span><span leaf="">'mt'</span></span><span leaf="">,</span><span><span leaf="">'ribo'</span></span><span leaf="">,</span><span><span leaf="">'hb'</span></span><span leaf="">],percent_top=</span><span><span leaf="">None</span></span><span leaf="">,log1p=</span><span><span leaf="">False</span></span><span leaf="">,inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 可视化细胞的上述比例情况</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sc.pl.violin(adata,[</span><span><span leaf="">'n_genes_by_counts'</span></span><span leaf="">,</span><span><span leaf="">'total_counts'</span></span><span leaf="">],groupby=</span><span><span leaf="">'batch'</span></span><span leaf="">,jitter=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">质控前的小提琴图：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS57ibowrmhVL265QORhuHicRCtYn830AkBiacrnYGeEZtiaYmFr2sMetRlw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3101851851851852" data-type="png" data-w="1080" data-imgfileid="100056419" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxS57ibowrmhVL265QORhuHicRCtYn830AkBiacrnYGeEZtiaYmFr2sMetRlw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">过滤细胞：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata = adata[adata.obs.n_genes_by_counts &lt; 6000, :]</span><span leaf=""><br></span><span leaf="">adata = adata[adata.obs.pct_counts_mt &lt; 18, :].copy()</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">又是常规的降维聚类：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.pp.normalize_total(adata,target_sum=</span><span><span leaf="">1e4</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.log1p(adata)</span><span leaf=""><br></span><span leaf="">adata.raw = adata.copy()</span><span leaf=""><br></span><span><span leaf="">#celltypist包需要的数据是log normlize之后的数据，会使用这里的adata.raw。</span></span><span leaf=""><br></span><span leaf="">sc.pp.highly_variable_genes(adata)</span><span leaf=""><br></span><span leaf="">sc.pp.scale(adata)</span><span leaf=""><br></span><span leaf="">sc.tl.pca(adata,use_highly_variable=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.external.pp.harmony_integrate(adata,</span><span><span leaf="">'batch'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf="">#聚类</span></span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(adata,use_rep=</span><span><span leaf="">'X_pca_harmony'</span></span><span leaf="">,n_pcs=</span><span><span leaf="">15</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata)</span><span leaf=""><br></span><span leaf="">sc.tl.leiden(adata, flavor=</span><span><span leaf="">"igraph"</span></span><span leaf="">, n_iterations=</span><span><span leaf="">2</span></span><span leaf="">,resolution=</span><span><span leaf="">0.5</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata,color=</span><span><span leaf="">'leiden'</span></span><span leaf="">,legend_loc=</span><span><span leaf="">'on data'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSAe1tFYbKZFGG7phdRUN6x1pl3iapLuK5PuibNFzfeeV2fHDy6mGWUE7g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.805607476635514" data-type="png" data-w="535" data-imgfileid="100056422" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSAe1tFYbKZFGG7phdRUN6x1pl3iapLuK5PuibNFzfeeV2fHDy6mGWUE7g/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">注释：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf=""> celltypist</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> celltypist </span><span><span leaf="">import</span></span><span leaf=""> models</span><span leaf=""><br></span><span leaf="">model = models.Model.load(model=</span><span><span leaf="">'Immune_All_High.pkl'</span></span><span leaf="">) </span><span><span leaf="">#https://www.celltypist.org/models</span></span><span leaf=""><br></span><span leaf="">model</span><span leaf=""><br></span><span leaf="">predictions = celltypist.annotate(adata, model = model, majority_voting = </span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">print(predictions.predicted_labels)</span><span leaf=""><br></span><span leaf="">adata2 = predictions.to_adata()</span><span leaf=""><br></span><span leaf="">print(adata2.obs)</span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(</span><span><span leaf="">' cells'</span></span><span leaf="">, </span><span><span leaf="">''</span></span><span leaf="">, regex=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(</span><span><span leaf="">' monocytes'</span></span><span leaf="">, </span><span><span leaf="">' Mono'</span></span><span leaf="">, regex=</span><span><span leaf="">False</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata2.obs.majority_voting</span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata2)</span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata2, color = </span><span><span leaf="">'majority_voting'</span></span><span leaf="">,legend_loc=</span><span><span leaf="">"on data"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">注释结果如下：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSlgiaVBIgaEJUz4lB7MibMBrGQOKOqyQQyZqHgQDqLpMPPGKc3Y8RlCSA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.805607476635514" data-type="png" data-w="535" data-imgfileid="100056421" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wym48p2tsu3rXDiccY3OanxSlgiaVBIgaEJUz4lB7MibMBrGQOKOqyQQyZqHgQDqLpMPPGKc3Y8RlCSA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">软件的原理，后面会在单独分享一次细节~</span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">文末友情宣传</span></span><span></span></h3><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247539788&amp;idx=1&amp;sn=62a09c7af6373658bf81c149eb0b4026&amp;scene=21#wechat_redirect"><span leaf="">生信入门&amp;数据挖掘线上直播课4月班</span></a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect"><span leaf="">时隔5年，我们的生信技能树VIP学徒继续招生啦</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect"><span leaf="">满足你生信分析计算需求的低价解决方案</span></a></section></li></ul></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/c671N5MbH51cao3lhuswVQ",target="_blank" rel="noopener noreferrer">原文链接</a>
