---
title: "“星云图”式单细胞UMAP密度图"
date: 2025-04-30T01:31:42Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
“星云图”式单细胞UMAP密度图 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">写在开头</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">最近<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI1Njk4ODE0MQ==&amp;action=getalbum&amp;album_id=3100581274722926594&amp;subscene=126&amp;scenenote=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI1Njk4ODE0MQ%3D%3D%26mid%3D2247529839%26idx%3D1%26sn%3De90474335f23288ab194b081e0679bca%26chksm%3Deb99c90c291b1121a818f0d226b516be6bd2dad7f53028e8488975e09011c9a0638f6b88503e%26scene%3D126%26sessionid%3D1745918282%26subscene%3D91%26clicktime%3D1745918284%26enterid%3D1745918284%26key%3Ddaf9bdc5abc4e8d04103f3f28bbc77987336981b3ab23412736a4378e1c1588ba1484404b4c28a3ea97a3b40bb2812121dfa1b5aa336e1abfad91edafe26278a34b8801d118807f67770e340a42a90a41674fffc6648212a580334374fd6ce9ad9ac32a14f4b9e07606ccab15b232b8333be74dac322b6fcb2c42221156ba5bf%26ascene%3D0%26uin%3DNDI3OTA4NDM0%26devicetype%3DWindows%2B11%2Bx64%26version%3D63090c33%26lang%3Dzh_CN%26countrycode%3DCN%26exportkey%3Dn_ChQIAhIQnIBJtRXT77UH3llebSnd2RLmAQIE97dBBAEAAAAAAPupFuJHhpIAAAAOpnltbLcz9gKNyK89dVj0NtUUFS5ypib8auYrO%252B2rN8hfOAdnBLoGXo4nl10JshIQdgpkk60nSkmdGMtRyrnkPyZQoOwIb6g6HfL2uyuPO7sps0%252FjI%252FiTPwNbBFEaadBRyjsGzkJEzuXPjhsLcViCr6Od9IrlTuKeLJ2GnpwrIXyrgrHbmVRlU9hTDf%252FiJ8jJRRXRleVuaryvP6IhqtYr5YZXnp0AZQJe5t%252FoAKRRojKfBcCgb5rBAsQwkjJ5YeaUQNU5RnQFh7RMlMsJDkkM%26acctmode%3D0%26pass_ticket%3DzueVQ%252Fz0iyERCdpXy9bleio6nnjPoMKdXyFX3q2i%252Fcg5RRX193W3TTrK89jw%252FQHR%26wx_header%3D1%26fasttmpl_type%3D0%26fasttmpl_fullversion%3D7709072-zh_CN-zip%26fasttmpl_flag%3D1&amp;nolastread=1&amp;sessionid=-2133365401#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">#单细胞实战100次</a>合集里面，开始在解析</span><strong><span leaf="">胃腺癌的空间转录组与单细胞RNA测序研究</span></strong><span leaf="">系列推文，和之前</span><strong><span leaf="">胃癌单细胞图谱</span></strong><span leaf="">是一个团队的成果</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMod5NOLwkMzcLr1hxnNmrpnqeSP2H5h3QnaJ7Udc6ZZiaB8Tu1FrQpwuQ/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.6592592592592592" data-type="jpeg" data-w="1080" data-imgfileid="100046225" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMod5NOLwkMzcLr1hxnNmrpnqeSP2H5h3QnaJ7Udc6ZZiaB8Tu1FrQpwuQ/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">在研读文献的过程中发现，文中好喜欢用密度星云图展示不同分组的细胞占比情况，有一说一就怪好看的，就像尝试复现一下。</span></strong></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMo2mN0srfjZdwAkPFZdWOXLt1tAA8In43z9xXiaNnvC43F4xQ4Giawhh2Q/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.42407407407407405" data-type="jpeg" data-w="1080" data-imgfileid="100046227" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMo2mN0srfjZdwAkPFZdWOXLt1tAA8In43z9xXiaNnvC43F4xQ4Giawhh2Q/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">主要参考借鉴的推文有：</span></strong></p><ul><li><section><span leaf="">老俊俊的生信笔记——<a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247512783&amp;idx=1&amp;sn=2535eaafd12934a3067e88f00f17d59a&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">单细胞二维密度图一文拿捏!</a></span></section></li><li><section><span leaf="">生信技能树——<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247538773&amp;idx=1&amp;sn=094b2cef83702267589de13dd50a0b58&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">画个同款新奇的“Galaxy”星系UMAP图（Nat Immunol：IF27.8）</a></span></section></li></ul><section><span leaf=""><span textstyle="">视频版资料：</span></span></section><section nodeleaf=""><mp-common-videosnap data-pluginname="mpvideosnap" data-url="https://findermp.video.qq.com/251/20304/stodownload?encfilekey=rjD5jyTuFrIpZ2ibE8T7Ym3K77SEULgkiaOCwoklVD9XAJ7z9p9reYqFGZ5eAv1AzaESaYhFBby24Vk2iaghdN8wA9Pak9e9ms1Jc5GNjic14pjj9mgiaZILOnw&amp;token=ic1n0xDG6awib02058bqvmBgwFEMQNpO1EzYqI5VwO6zBHdmMpEAZPuoxJmQ4PWY8SvQtbibV6KumHp6bt6e1hISrCQSLMot8cjwN0jzsdXqN4zvgTU5kJzqnZx46HgRGkSU00QCcqpMQbvBka1syqiaibAiaYvs7MFIktCicN8icTUt0EU&amp;idx=1&amp;hy=SZ&amp;m=&amp;scene=2&amp;uzid=1" data-headimgurl="http://wx.qlogo.cn/finderhead/Q3auHgzwzM7wQicDUgicCRbhXS2icXx0uibhKJpnR2W94icicBzLkEibWlXQQ/0" data-username="v2_060000231003b20faec8c6e4801ecbdccf02ed31b077db445559df851b113daaaeeba59656a6@finder" data-nickname="生信漫漫学" data-desc="“星云图”式单细胞UMAP密度" data-nonceid="6023899210608052907" data-width="1920" data-height="1080" data-type="video" data-id="export/UzFfAgtgekIEAQAAAAAAqNMtl1sxqQAAAAstQy6ubaLX4KHWvLEZgBPEpKdEUl8aWsSIzNPgMIuazVshS2hQO2PSdq1cEmqW"></mp-common-videosnap></section><section><span leaf=""><br></span></section><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">读取数据并随机下采样</span></span><span></span></h3><p data-tool="mdnice编辑器"><strong><span leaf="">数据链接是：</span></strong><span leaf="">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE183904</span></p><p data-tool="mdnice编辑器"><span leaf="">第一层次降维聚类可视化——<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247528101&amp;idx=1&amp;sn=51d148ddce142aef494be8f528595506&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">UMAP图新解：首次分群后按大类分组加圈</a></span></p><p data-tool="mdnice编辑器"><strong><span leaf="">复现图表及注释：Density plot of UMAP representation comparing normal and gastric tumor samples after random downsampling to approximately 30,000 cells each to allow statistical equivalence. Each dot represents a single cell. Dashed lines highlight higher proportions of epithelial cells in normal samples and myeloid cells in tumor samples.</span></strong></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMo2mN0srfjZdwAkPFZdWOXLt1tAA8In43z9xXiaNnvC43F4xQ4Giawhh2Q/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.42407407407407405" data-type="jpeg" data-w="1080" data-imgfileid="100046226" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMo2mN0srfjZdwAkPFZdWOXLt1tAA8In43z9xXiaNnvC43F4xQ4Giawhh2Q/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">所以需要提取注释后的数据，并基于Normal和tumor分组进行随机下采样</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#清空环境，加载需要的R包</span></span><span leaf=""><br></span><span leaf="">rm(list = ls())</span><span leaf=""><br></span><span leaf="">library(Seurat)</span><span leaf=""><br></span><span leaf="">library(tidyverse)</span><span leaf=""><br></span><span><span leaf="">source</span></span><span leaf="">(</span><span><span leaf="">'scRNA_scripts/lib.R'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#读取数据及注释结果</span></span><span leaf=""><br></span><span leaf="">load(file = </span><span><span leaf="">"phe.Rdata"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sce.all &lt;- readRDS(</span><span><span leaf="">"2-harmony/sce.all_int.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sce.all@meta.data &lt;- phe</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#整理activeident，并下采样</span></span><span leaf=""><br></span><span leaf="">sce.all.int &lt;- SetIdent(sce.all, value = </span><span><span leaf="">"group"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sce.all.int &lt;- subset(sce.all.int,downsample=30000)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sce.all.int &lt;- SetIdent(sce.all.int, value = </span><span><span leaf="">"cell_class"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMofqHgmdVfJ7HQlc5YkRn3y139vOWfDQufhPshYnfzOR7CJXsYnM5rGQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.36666666666666664" data-type="png" data-w="1080" data-imgfileid="100046224" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMofqHgmdVfJ7HQlc5YkRn3y139vOWfDQufhPshYnfzOR7CJXsYnM5rGQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">得到需要的数据后，就可以尝试复现密度星云图。</span></strong></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">亚群分类密度图</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">老俊俊的生信笔记——<a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247512783&amp;idx=1&amp;sn=2535eaafd12934a3067e88f00f17d59a&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">单细胞二维密度图一文拿捏!</a>中，使用ggSCvis亚群分类密度图，看起来得到的结果和文献结果很像</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMofiahC5B0UJrh5yTbZhhGrcGkYJWzkLvhapCwibXO2CU4pPnSOZ05Ygbw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7600596125186289" data-type="png" data-w="671" data-imgfileid="100046223" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMofiahC5B0UJrh5yTbZhhGrcGkYJWzkLvhapCwibXO2CU4pPnSOZ05Ygbw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">代入实际分析的数据进行可视化：</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">library(ggSCvis)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">p1 &lt;- ggscplot(object = sce.all.int) +</span><span leaf=""><br></span><span leaf="">  stat_density2d(geom = </span><span><span leaf="">"raster"</span></span><span leaf="">, aes(fill = ..density..),</span><span leaf=""><br></span><span leaf="">                 contour = F, show.legend = T) +</span><span leaf=""><br></span><span leaf="">  geom_scPoint(color = </span><span><span leaf="">"white"</span></span><span leaf="">, size = 0.00001) +</span><span leaf=""><br></span><span leaf="">  facet_wrap(~group, ncol = 2) +</span><span leaf=""><br></span><span leaf="">  theme_bw() +</span><span leaf=""><br></span><span leaf="">  theme(panel.grid = element_blank(),</span><span leaf=""><br></span><span leaf="">        axis.ticks = element_blank(),</span><span leaf=""><br></span><span leaf="">        strip.background = element_blank(),</span><span leaf=""><br></span><span leaf="">        strip.text = element_blank(),</span><span leaf=""><br></span><span leaf="">        axis.text = element_blank()) +</span><span leaf=""><br></span><span leaf="">  scale_fill_viridis_c(option = </span><span><span leaf="">"magma"</span></span><span leaf="">, direction = 1) +</span><span leaf=""><br></span><span leaf="">  coord_cartesian(expand = F);p1</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><strong><span leaf="">使用ggSCvis（通常用于单细胞数据的可视化）来创建一个二维散点图，其中包含了密度图和点的分布</span></strong></p><ul><li><section><span leaf="">初始化一个绘图对象 p1，使用 ggscplot 函数，其中 object 参数指定了要可视化的单细胞数据对象 sce.all.int。</span></section></li><li><section><span leaf="">添加一个二维密度图层 stat_density2d，使用 raster 几何对象来显示密度。</span></section></li><li><section><span leaf="">添加一个点图层 geom_scPoint，其中点的颜色为白色，大小为 0.2。</span></section></li><li><section><span leaf="">使用 facet_wrap 函数根据 group 变量分面显示，每行显示 2 个分面。</span></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMozick7dZfpLvaVkH7iaeks2ukQ2tKPSDooHFJHceFFtMgaSv0mjswvz9Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7666666666666667" data-type="png" data-w="1080" data-imgfileid="100046229" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMozick7dZfpLvaVkH7iaeks2ukQ2tKPSDooHFJHceFFtMgaSv0mjswvz9Q/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">结果和文章中出入还是较大，比如密度图颜色被覆盖较多，不按group分组进行展示，所以再试试别的方法</span></strong></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">ggpointdensity绘制细胞密度图</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">生信技能树——<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247538773&amp;idx=1&amp;sn=094b2cef83702267589de13dd50a0b58&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">画个同款新奇的“Galaxy”星系UMAP图（Nat Immunol：IF27.8）</a>中得到带注释信息圈的密度图</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMof0jbN7xj0eAsQfjaW0Y68AHeEERbujoQ6pMiawj3zU9DCHovVwic0UYA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.797940797940798" data-type="png" data-w="777" data-imgfileid="100046228" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMof0jbN7xj0eAsQfjaW0Y68AHeEERbujoQ6pMiawj3zU9DCHovVwic0UYA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">提取需要的UMAP坐标数据以及注释分组信息，绘制需要的密度图：</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#ggpointdensity</span></span><span leaf=""><br></span><span leaf="">install.packages(</span><span><span leaf="">"ggpointdensity"</span></span><span leaf="">)  </span><span><span leaf=""># 如未安装</span></span><span leaf=""><br></span><span leaf="">library(ggpointdensity)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 提取UMAP + 分组信息</span></span><span leaf=""><br></span><span><span leaf=""># 提取UMAP坐标</span></span><span leaf=""><br></span><span leaf="">umap_df &lt;- Embeddings(sce.all.int, reduction = </span><span><span leaf="">"umap"</span></span><span leaf="">) %&gt;%</span><span leaf=""><br></span><span leaf="">  as.data.frame()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 确保列名统一为 UMAP_1 和 UMAP_2</span></span><span leaf=""><br></span><span leaf="">colnames(umap_df) &lt;- c(</span><span><span leaf="">"UMAP_1"</span></span><span leaf="">, </span><span><span leaf="">"UMAP_2"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 添加meta信息（如group、cell_class）</span></span><span leaf=""><br></span><span leaf="">umap_df</span><span><span leaf="">$group</span></span><span leaf=""> &lt;- sce.all.int</span><span><span leaf="">$group</span></span><span leaf=""><br></span><span leaf="">umap_df</span><span><span leaf="">$cell_class</span></span><span leaf=""> &lt;- sce.all.int</span><span><span leaf="">$cell_class</span></span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMoOCia4QSBibTAx32MPryU6RpUxxwphXOOTgl96EFnmr0F7kjZ8oNicibb6w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9353932584269663" data-type="png" data-w="1068" data-imgfileid="100046230" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMoOCia4QSBibTAx32MPryU6RpUxxwphXOOTgl96EFnmr0F7kjZ8oNicibb6w/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">分开可视化之后拼图：</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 分成两个数据框</span></span><span leaf=""><br></span><span leaf="">df_normal &lt;- umap_df %&gt;% filter(group == </span><span><span leaf="">"Normal"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">df_tumor  &lt;- umap_df %&gt;% filter(group == </span><span><span leaf="">"Tumor"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 星云密度图函数</span></span><span leaf=""><br></span><span leaf="">plot_density_map &lt;- </span><span><span leaf="">function</span></span><span leaf="">(data, title) {</span><span leaf=""><br></span><span leaf="">  ggplot(data, aes(x = UMAP_1, y = UMAP_2)) +</span><span leaf=""><br></span><span leaf="">    geom_pointdensity(size = 0.5) +</span><span leaf=""><br></span><span leaf="">    scale_color_viridis_c(option = </span><span><span leaf="">"plasma"</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">    theme_void(base_size = 12) +</span><span leaf=""><br></span><span leaf="">    ggtitle(title) +</span><span leaf=""><br></span><span leaf="">    theme(</span><span leaf=""><br></span><span leaf="">      legend.position = </span><span><span leaf="">"none"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">      plot.title = element_text(hjust = 0.5, face = </span><span><span leaf="">"bold"</span></span><span leaf="">, size = 16)</span><span leaf=""><br></span><span leaf="">    )</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">p1 &lt;- plot_density_map(df_normal, </span><span><span leaf="">"Normal"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">p2 &lt;- plot_density_map(df_tumor, </span><span><span leaf="">"Tumor"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">p1 + p2</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMo676AvNCrzlFKQONBFwW5tlXDV9gJTfnhrRxbKdtsrxL4M2h0Gn8sZw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8416666666666667" data-type="png" data-w="1080" data-imgfileid="100046231" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMo676AvNCrzlFKQONBFwW5tlXDV9gJTfnhrRxbKdtsrxL4M2h0Gn8sZw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">可视化结果中，按照group分组分开展示，并且按照细胞亚群密度可视化，但是和星云图还是有点区别。</span></strong></p><p data-tool="mdnice编辑器"><strong><span leaf="">所以想着如果添加一个点图层 geom_scPoint会不会看起来好些，也就是结合两篇推文的内容进行可视化</span></strong></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">密度图加上点图层</span></span><span></span></h3><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">p &lt;- ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2)) +</span><span leaf=""><br></span><span leaf="">  stat_density_2d(</span><span leaf=""><br></span><span leaf="">    geom = </span><span><span leaf="">"raster"</span></span><span leaf="">, aes(fill = after_stat(density)),</span><span leaf=""><br></span><span leaf="">    contour = FALSE, n = 200</span><span leaf=""><br></span><span leaf="">  ) +</span><span leaf=""><br></span><span leaf="">  geom_point(color = </span><span><span leaf="">"white"</span></span><span leaf="">, size = 0.0001, alpha = 0.5) +</span><span leaf=""><br></span><span leaf="">  facet_wrap(~group, ncol = 2) +</span><span leaf=""><br></span><span leaf="">  scale_fill_viridis(option = </span><span><span leaf="">"magma"</span></span><span leaf="">, direction = 1) +</span><span leaf=""><br></span><span leaf="">  coord_cartesian(expand = FALSE) +</span><span leaf=""><br></span><span leaf="">  theme_void() +</span><span leaf=""><br></span><span leaf="">  theme(</span><span leaf=""><br></span><span leaf="">    strip.text = element_text(face = </span><span><span leaf="">"bold"</span></span><span leaf="">, size = 14),</span><span leaf=""><br></span><span leaf="">    legend.position = </span><span><span leaf="">"none"</span></span><span leaf=""><br></span><span leaf="">  );p</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100046232" data-ratio="0.8416666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMoYbSzxhIvoWLZC7pAP7DicobapJPTNgaxZpqjMY4aj5XibiamG4vGpKCrA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMoYbSzxhIvoWLZC7pAP7DicobapJPTNgaxZpqjMY4aj5XibiamG4vGpKCrA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">有点类似了，但是白色有点掩盖掉了密度图本身的颜色，所以可以调整为更加淡一些的颜色，然后加上细胞大类注释以及圈图即可</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#加载需要的R包</span></span><span leaf=""><br></span><span leaf="">library(ggplot2)</span><span leaf=""><br></span><span leaf="">library(ggrepel)</span><span leaf=""><br></span><span leaf="">library(ggforce)</span><span leaf=""><br></span><span leaf="">library(viridis)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 计算每组每类细胞的中心位置</span></span><span leaf=""><br></span><span leaf="">label_centroids &lt;- umap_df %&gt;%</span><span leaf=""><br></span><span leaf="">  group_by(group, cell_class) %&gt;%</span><span leaf=""><br></span><span leaf="">  summarize(</span><span leaf=""><br></span><span leaf="">    UMAP_1 = median(UMAP_1),</span><span leaf=""><br></span><span leaf="">    UMAP_2 = median(UMAP_2),</span><span leaf=""><br></span><span leaf="">    .groups = </span><span><span leaf="">'drop'</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#最终可视化结果</span></span><span leaf=""><br></span><span leaf="">p &lt;- ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2)) +</span><span leaf=""><br></span><span leaf="">  stat_density_2d(</span><span leaf=""><br></span><span leaf="">    geom = </span><span><span leaf="">"raster"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    aes(fill = after_stat(density)),</span><span leaf=""><br></span><span leaf="">    contour = FALSE, n = 200</span><span leaf=""><br></span><span leaf="">  ) +</span><span leaf=""><br></span><span leaf="">  geom_point(color = </span><span><span leaf="">"#FFFFFFAA"</span></span><span leaf="">, size = 0.005, alpha = 0.2) +</span><span leaf=""><br></span><span leaf="">  geom_text_repel(</span><span leaf=""><br></span><span leaf="">    data = label_centroids,</span><span leaf=""><br></span><span leaf="">    aes(label = cell_class),</span><span leaf=""><br></span><span leaf="">    color = </span><span><span leaf="">"white"</span></span><span leaf="">, size = 4, fontface = </span><span><span leaf="">"bold"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    box.padding = 0.5, max.overlaps = Inf</span><span leaf=""><br></span><span leaf="">  ) +</span><span leaf=""><br></span><span leaf="">  facet_wrap(~group, ncol = 2) +</span><span leaf=""><br></span><span leaf="">  scale_fill_viridis(option = </span><span><span leaf="">"magma"</span></span><span leaf="">, direction = 1) +</span><span leaf=""><br></span><span leaf="">  coord_cartesian(expand = FALSE) +</span><span leaf=""><br></span><span leaf="">  theme_void() +</span><span leaf=""><br></span><span leaf="">  theme(</span><span leaf=""><br></span><span leaf="">    strip.text = element_text(face = </span><span><span leaf="">"bold"</span></span><span leaf="">, size = 14),</span><span leaf=""><br></span><span leaf="">    legend.position = </span><span><span leaf="">"none"</span></span><span leaf=""><br></span><span leaf="">  ) + </span><span leaf=""><br></span><span leaf="">  stat_ellipse(aes(group = cell_class), color = </span><span><span leaf="">"white"</span></span><span leaf="">, linetype = </span><span><span leaf="">"dashed"</span></span><span leaf="">, alpha = 0.5);p</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100046238" data-ratio="0.8398148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMou8ZhlDiaQicrTz0IHskGDWruibibcBdv1WABBkciaevXctWtHwx5fHZBDdA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMou8ZhlDiaQicrTz0IHskGDWruibibcBdv1WABBkciaevXctWtHwx5fHZBDdA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">代码简单解析：</span></strong></p><ul><li><section><span leaf="">计算每个细胞类在每组中的中心位置用于标注——label_centroids</span></section></li><li><section><span leaf="">“星云图”外观由 stat_density_2d() 渲染出的密度热图模拟</span></section></li><li><section><code><span leaf="">geom_point(color = "#FFFFFFAA", size = 0.005, alpha = 0.2)</span></code><span leaf="">白色透明点，制造一种“边缘星点”效果，视觉上增强结构边界的细腻感。</span></section></li><li><section><code><span leaf="">geom_text_repel</span></code><span leaf=""> 避让机制有效防止标签遮挡密度区域</span></section></li><li><section><code><span leaf="">facet_wrap(~group, ncol = 2)</span></code><span leaf="">分成两列图（Normal / Tumor）</span></section></li><li><section><span leaf="">viridis::magma 是适合暗背景图的高对比色带，星云感较强,</span><code><span leaf="">theme_void()</span></code><span leaf=""> 去除坐标轴、背景网格等视觉杂项。</span></section></li><li><section><code><span leaf="">stat_ellipse(aes(group = cell_class), color = "white", linetype = "dashed", alpha = 0.5)</span></code><span leaf="">为每个 cell_class 添加轮廓线（高斯椭圆拟合）</span></section></li></ul><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">对比原图不足之处</span></span><span></span></h4><ul><li><section><p><strong><span leaf="">轮廓线没有很好的契合到UMAP的图形上，细胞亚群标注由于位置问题，导致有些亚群标题不够突出</span></strong></p></section></li><li><section><p><strong><span leaf="">文章应该对细胞亚群进行了筛选，但复现的时候，只基于分组进行了下采样，大家按照自己的实际需求去展示即可</span></strong></p></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100046237" data-ratio="1.1161971830985915" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMoThDbAC5maqibvRQsgVEy1Qfrzia7S9ql92jVQMyW8cicLZZyrGqd3MzxQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="852" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjQibYObicbm1YgCJgmmkZqVMoThDbAC5maqibvRQsgVEy1Qfrzia7S9ql92jVQMyW8cicLZZyrGqd3MzxQ/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">如果你也想做单细胞转录组数据分析，最好是有自己的计算机资源哦，比如我们的<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247530048&amp;idx=1&amp;sn=28aa7bbd5e00521f79e074496a5f5d66&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">满足你生信分析计算需求的低价解决方案</a>，而且还需要有基本的生物信息学基础，也可以看看我们的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247541231&amp;idx=1&amp;sn=6704a3ae8233d19ca94fd4929b5e1f63&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">生物信息学马拉松授课</a>，你的生物信息学入门课。</span></strong></p><p data-tool="mdnice编辑器"><strong><span leaf="">2025年也会继续学习分享单细胞内容，并且组建了交流群——<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536175&amp;idx=1&amp;sn=7391227554e6aed88bfc0dbcd8546e78&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">承包你2025全部的单细胞转录组降维聚类分群</a>，欢迎一起讨论交流学习！</span></strong></p></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/6g1o0K0riigWViPt3qKQPw",target="_blank" rel="noopener noreferrer">原文链接</a>
