---
title: "记录R语言使用 CytoTRACE v2的简要流程"
date: 2025-04-17T03:27:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信宝库"
]
categories: ["Acdemic"]
---
记录R语言使用 CytoTRACE v2的简要流程 by 生信宝库
------
<div><section><span md-inline="plain" data-pm-slice="0 0 []"><span leaf="">生信宝库在之前的推文：</span></span><span md-inline="link"><span md-inline="plain"><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzI4MjY5ODI1Nw==&amp;mid=2247490978&amp;idx=4&amp;sn=f3c23ffeebf2dc8083c1e72b1d4250fb&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">CytoTRACE v2: 用可解释性AI在绝对尺度上预测细胞的分化潜能</a></span></span></span><span md-inline="plain"><span leaf="">中，已经介绍了CytoTRACE v2版本的工作原理。其它公众号的推文也有很多分享了教程代码，但大多很复杂。今天小编则是通过一个更简洁的流程，为大家演示如何通过R语言快速使用CytoTRACE v2。</span></span><h2 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">第一步：配置python环境</span></span><span data-cacheurl="" data-remoteid=""></span></h2><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">1. 创建环境</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">mamba create -n cytotrace python=3.10 -y &amp;&amp; mamba activate cytotrace</span><span leaf=""><br></span><span><span leaf="">which</span></span><span leaf=""> python</span><span leaf=""><br></span><span><span leaf=""># /data/y01011/.conda/envs/cytotrace/bin/python`</span></span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">2. 镜像选择清华即可</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main</span><span leaf=""><br></span><span leaf="">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r</span><span leaf=""><br></span><span leaf="">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge</span><span leaf=""><br></span><span leaf="">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">3. 装包</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">mamba install -y notebook ipywidgets pandas numpy seaborn matplotlib ipykernel openpyxl</span><span leaf=""><br></span><span leaf="">mamba install -y pyarrow pytables python-igraph leidenalg</span><span leaf=""><br></span><span leaf="">mamba install -y scanpy jaxlib</span><span leaf=""><br></span><span leaf="">pip install scanoramaCT -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">4. 验证安装</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">which</span></span><span leaf=""> python</span><span leaf=""><br></span><span leaf="">python -c </span><span><span leaf="">"import scanpy; print('Scanpy version:', scanpy.__version__)"</span></span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">5. 修改bug</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#找到intervaltree/intervaltree.py这个脚本修改bug</span></span><span leaf=""><br></span><span><span leaf="">#25行的</span></span><span leaf=""><br></span><span leaf="">import collections</span><span leaf=""><br></span><span><span leaf="">#替换为</span></span><span leaf=""><br></span><span leaf="">import collections.abc as collections</span><span leaf=""><br></span><span><span leaf="">#我的intervaltree/intervaltree.py文件路径在</span></span><span leaf=""><br></span><span leaf="">/data/y01011/.conda/envs/cytotrace//lib/python3.10/site-packages/intervaltree/intervaltree.py</span><span leaf=""><br></span><span><span leaf=""># 建议使用一些可以可视化的软件，非常方便，如vscode等进行修改</span></span><span leaf=""><br></span></code></pre><h2 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">第二步：安装R包</span></span><span data-cacheurl="" data-remoteid=""></span></h2><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">先调用py环境</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">library(reticulate)</span><span leaf=""><br></span><span leaf="">reticulate::use_python(</span><span><span leaf="">"/data/y01011/.conda/envs/cytotrace/bin/python"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">reticulate::py_exe()</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 运行报错：Error: Unable to find conda binary. Is Anaconda installed?</span></span><span leaf=""><br></span><span><span leaf=""># 如果不报错就不用管，报错就按下面的代码</span></span><span leaf=""><br></span><span><span leaf=""># 报错解决：先which conda，然后运行下面的代码</span></span><span leaf=""><br></span><span leaf="">Sys.setenv(RETICULATE_CONDA = </span><span><span leaf="">"/home/sxy24618/miniconda3/bin/conda"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">reticulate::use_condaenv(</span><span><span leaf="">"cytotrace"</span></span><span leaf="">, required = TRUE)</span><span leaf=""><br></span><span leaf="">reticulate::py_config()</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">选择手动安装方式，一步到位</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 注：这里下载的是cytotrace2</span></span><span leaf=""><br></span><span><span leaf=""># 下载地址：https://api.github.com/repos/digitalcytometry/cytotrace2/tarball/HEAD</span></span><span leaf=""><br></span><span><span leaf=""># 下载后上传到本地/服务器中的某个文件夹</span></span><span leaf=""><br></span><span leaf="">remotes::install_local(</span><span><span leaf="">"~/package/digitalcytometry-cytotrace2-v1.1.0-9-gd1dc116.tar.gz"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       subdir = </span><span><span leaf="">"cytotrace2_r"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       upgrade = F,</span><span leaf=""><br></span><span leaf="">                       dependencies = T)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">library(CytoTRACE2)</span><span leaf=""><br></span><span leaf="">library(Seurat)</span><span leaf=""><br></span><span leaf="">library(tidyverse)</span><span leaf=""><br></span><span leaf="">library(SeuratWrappers)</span><span leaf=""><br></span><span leaf="">library(cowplot)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># cytotrace的下载链接 https://cytotrace.stanford.edu/CytoTRACE_0.3.3.tar.gz</span></span><span leaf=""><br></span></code></pre><h2 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">第三步：运行cytotrace2</span></span><span data-cacheurl="" data-remoteid=""></span></h2><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">cytotrace2_result_sce &lt;- cytotrace2(sce, </span><span leaf=""><br></span><span leaf="">                                    is_seurat = TRUE,</span><span leaf=""><br></span><span leaf="">                                    slot_type = </span><span><span leaf="">"counts"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                                    species = </span><span><span leaf="">'human'</span></span><span leaf="">,</span><span><span leaf="">#默认是小鼠</span></span><span leaf=""><br></span><span leaf="">                                    seed = 123)</span><span leaf=""><br></span><span leaf="">saveRDS(cytotrace2_result_sce, file = </span><span><span leaf="">"cytotrace2_result_sce.RDS"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h2 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">第四步：cytotrace2可视化</span></span><span data-cacheurl="" data-remoteid=""></span></h2><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">anno &lt;- data.frame(phenotype = sce@meta.data</span><span><span leaf="">$celltype</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">rownames(anno) &lt;- colnames(sce)</span><span leaf=""><br></span><span leaf="">plots &lt;- plotData(cytotrace2_result = cytotrace2_result_sce, annotation = anno, is_seurat = T)</span><span leaf=""><br></span><span leaf="">p1 &lt;- plots</span><span><span leaf="">$CytoTRACE2_UMAP</span></span><span leaf=""><br></span><span leaf="">p2 &lt;- plots</span><span><span leaf="">$CytoTRACE2_Potency_UMAP</span></span><span leaf=""><br></span><span leaf="">p3 &lt;- plots</span><span><span leaf="">$CytoTRACE2_Relative_UMAP</span></span><span leaf=""><br></span><span leaf="">p4 &lt;- plots</span><span><span leaf="">$Phenotype_UMAP</span></span><span leaf=""><br></span><span leaf="">p5 &lt;- plots</span><span><span leaf="">$CytoTRACE2_Boxplot_byPheno</span></span><span leaf=""><br></span><span leaf="">plot_grid(p1, p2, p3, p4, p5, nrow = 2)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7fGsaorbsLkQI9dRPZEg1Qojoia1tklH8ke4D2xczovybPVUJHq9y58V1D9L1JSPbBBDCl7eU7RyZA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6666666666666666" data-type="png" data-w="1080" data-imgfileid="100011441" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7fGsaorbsLkQI9dRPZEg1Qojoia1tklH8ke4D2xczovybPVUJHq9y58V1D9L1JSPbBBDCl7eU7RyZA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">参考链接</span></span><span data-cacheurl="" data-remoteid=""></span></h2><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">https://mp.weixin.qq.com/s/sZGUemjuS8-pTZcdFuPfUQ</span><span leaf=""><br></span><span leaf="">https://mp.weixin.qq.com/s/QLyCSvNvEL-yxKsg6bhaYw</span><span leaf=""><br></span><span leaf="">https://mp.weixin.qq.com/s/ythy2p6YPEw5S6ARXkfkFQ</span><span leaf=""><br></span></code></pre></section><section><span leaf=""><br></span></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GL6g5Y3aR7cwqaibulibXfhkQdkqSW0H9M5riaAVfSBb3ibibCZHnqViahn3dyukTiaJU0sKzC2xXD8U2Pa39ra5dz9xg/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="1" data-s="300,640" data-type="jpeg" data-w="430" data-croporisrc="https://mmbiz.qpic.cn/mmbiz_jpg/GL6g5Y3aR7cwqaibulibXfhkQdkqSW0H9M5riaAVfSBb3ibibCZHnqViahn3dyukTiaJU0sKzC2xXD8U2Pa39ra5dz9xg/0?wx_fmt=jpeg&amp;from=appmsg" data-cropselx2="203" data-cropsely2="203" data-imgfileid="100010845" src="https://mmbiz.qpic.cn/mmbiz_jpg/GL6g5Y3aR7cwqaibulibXfhkQdkqSW0H9M5riaAVfSBb3ibibCZHnqViahn3dyukTiaJU0sKzC2xXD8U2Pa39ra5dz9xg/640?wx_fmt=jpeg&amp;from=appmsg"></section><h3 data-tool="mdnice编辑器"><span><span leaf="">关注公众号，下回更新不迷路</span></span></h3><section><span leaf=""><br></span></section><section nodeleaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="生信宝库" data-alias="sxbk2020" data-from="2" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7f0yanILMQZCnw1duTMROQRvgDqVjlYcrljTRy1E4ZLppLG6zicdd3h0IwjLpxnum1V5KsowibJM1sw/0?wx_fmt=png" data-signature="本公众号只用于生信知识的收集与传播，以及生信人之间互相交流和学习，不会涉及任何商业利益。本公众号各小编平时忙于科研，更新文章较其它同类型公众号较慢，但保持宁缺毋滥的本心，只更新对大家有用的推文。" data-id="MzI4MjY5ODI1Nw==" data-is_biz_ban="0"></mp-common-profile></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/vwbGa9jaxe8tLiukYZ8sGw",target="_blank" rel="noopener noreferrer">原文链接</a>
