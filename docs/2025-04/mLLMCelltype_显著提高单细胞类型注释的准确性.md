---
title: "mLLMCelltype 显著提高单细胞类型注释的准确性"
date: 2025-04-19T09:56:58Z
draft: ["false"]
tags: [
  "fetched",
  "老俊俊的生信笔记"
]
categories: ["Acdemic"]
---
mLLMCelltype 显著提高单细胞类型注释的准确性 by 老俊俊的生信笔记
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><section nodeleaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="老俊俊的生信笔记" data-alias="JunJunLab" data-from="0" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usezgsqIGqjITSMggCTSoViaYeoKe2xoZr1IIvNJoztibQxibYHLDDoiabwAc6Ggws3Tvdo8EPss2nLgaVQ/0?wx_fmt=png" data-signature="老俊俊的生信技能和知识分享,我不是巨人,但你可以站在我的肩膀上更进一步!" data-id="MzkyMTI1MTYxNA==" data-is_biz_ban="0" data-service_type="1" data-verify_status="1"></mp-common-profile></section><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">引言</span></span><span></span></h2><blockquote><span></span><p><span leaf="">有位粉丝大佬联系我想要分享他自己的工作，目前在投稿，还没有见刊。工作目前分享在预印本上。文章题目是 </span><strong><span leaf="">《Large Language Model Consensus Substantially Improves the Cell Type Annotation Accuracy for scRNA-seq Data》</span></strong><span leaf="">，作者基于大语言模型开发了一个新的 scRNA-seq 的细胞注释工具，</span><strong><span leaf="">R</span></strong><span leaf=""> 和 </span><strong><span leaf="">python</span></strong><span leaf=""> 版本的都有 </span><strong><span leaf="">https://github.com/cafferychen777/mLLMCelltype</span></strong><span leaf="">。接下来我们分享一下这篇工作的内容。</span></p></blockquote><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtkNaiaUXgOJC2NN9BavtWEFVnPybD55MEWPOQuYOB8WKF2HwlictjY8eA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4196519959058342" data-type="png" data-w="977" data-imgfileid="100034660" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtkNaiaUXgOJC2NN9BavtWEFVnPybD55MEWPOQuYOB8WKF2HwlictjY8eA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">工具</span></span><span></span></h2><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAt1DyA90l79LGHhAicIVnaPiakACkPuicHp8rlic1HXEiatRBakiat21E58gXw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4962962962962963" data-type="png" data-w="1080" data-imgfileid="100034658" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAt1DyA90l79LGHhAicIVnaPiakACkPuicHp8rlic1HXEiatRBakiat21E58gXw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">中文文档：</span></strong></p><blockquote><span></span><p><strong><span leaf="">https://github.com/cafferychen777/mLLMCelltype/blob/main/README_CN.md</span></strong></p></blockquote><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtzmzpvRHfXlzkMmRickIAGGiagg7y15rG2pcv4o8icwpMrqLDlibxsw0EzQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5277777777777778" data-type="png" data-w="1080" data-imgfileid="100034657" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtzmzpvRHfXlzkMmRickIAGGiagg7y15rG2pcv4o8icwpMrqLDlibxsw0EzQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">安装:</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># Install from GitHub</span></span><span leaf=""><br></span><span leaf="">devtools::install_github(</span><span><span leaf="">"cafferychen777/mLLMCelltype"</span></span><span leaf="">, subdir = </span><span><span leaf="">"R"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Install from PyPI</span></span><span leaf=""><br></span><span leaf="">pip install mllmcelltype</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Or install from GitHub</span></span><span leaf=""><br></span><span leaf="">pip install git+https://github.com/cafferychen777/mLLMCelltype.git</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><strong><span leaf="">R 示例代码：</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># Load required packages</span></span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(mLLMCelltype)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(Seurat)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(dplyr)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(ggplot2)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(cowplot) </span><span><span leaf=""># Added for plot_grid</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Load your preprocessed Seurat object</span></span><span leaf=""><br></span><span leaf="">pbmc &lt;- readRDS(</span><span><span leaf="">"your_seurat_object.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># If starting with raw data, perform preprocessing steps</span></span><span leaf=""><br></span><span><span leaf=""># pbmc &lt;- NormalizeData(pbmc)</span></span><span leaf=""><br></span><span><span leaf=""># pbmc &lt;- FindVariableFeatures(pbmc, selection.method = "vst", nfeatures = 2000)</span></span><span leaf=""><br></span><span><span leaf=""># pbmc &lt;- ScaleData(pbmc)</span></span><span leaf=""><br></span><span><span leaf=""># pbmc &lt;- RunPCA(pbmc)</span></span><span leaf=""><br></span><span><span leaf=""># pbmc &lt;- FindNeighbors(pbmc, dims = 1:10)</span></span><span leaf=""><br></span><span><span leaf=""># pbmc &lt;- FindClusters(pbmc, resolution = 0.5)</span></span><span leaf=""><br></span><span><span leaf=""># pbmc &lt;- RunUMAP(pbmc, dims = 1:10)</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Find marker genes for each cluster</span></span><span leaf=""><br></span><span leaf="">pbmc_markers &lt;- FindAllMarkers(pbmc,</span><span leaf=""><br></span><span leaf="">                            only.pos = </span><span><span leaf="">TRUE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                            min.pct = </span><span><span leaf="">0.25</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                            logfc.threshold = </span><span><span leaf="">0.25</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Set up cache directory to speed up processing</span></span><span leaf=""><br></span><span leaf="">cache_dir &lt;- </span><span><span leaf="">"./mllmcelltype_cache"</span></span><span leaf=""><br></span><span leaf="">dir.create(cache_dir, showWarnings = </span><span><span leaf="">FALSE</span></span><span leaf="">, recursive = </span><span><span leaf="">TRUE</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Run LLMCelltype annotation with multiple LLM models</span></span><span leaf=""><br></span><span leaf="">consensus_results &lt;- interactive_consensus_annotation(</span><span leaf=""><br></span><span leaf="">  input = pbmc_markers,</span><span leaf=""><br></span><span leaf="">  tissue_name = </span><span><span leaf="">"human PBMC"</span></span><span leaf="">,  </span><span><span leaf=""># provide tissue context</span></span><span leaf=""><br></span><span leaf="">  models = c(</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"claude-3-7-sonnet-20250219"</span></span><span leaf="">,  </span><span><span leaf=""># Anthropic</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"gpt-4o"</span></span><span leaf="">,                   </span><span><span leaf=""># OpenAI</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"gemini-1.5-pro"</span></span><span leaf="">,           </span><span><span leaf=""># Google</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"qwen-max-2025-01-25"</span></span><span leaf="">       </span><span><span leaf=""># Alibaba</span></span><span leaf=""><br></span><span leaf="">  ),</span><span leaf=""><br></span><span leaf="">  api_keys = list(</span><span leaf=""><br></span><span leaf="">    anthropic = </span><span><span leaf="">"your-anthropic-key"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    openai = </span><span><span leaf="">"your-openai-key"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    gemini = </span><span><span leaf="">"your-google-key"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    qwen = </span><span><span leaf="">"your-qwen-key"</span></span><span leaf=""><br></span><span leaf="">  ),</span><span leaf=""><br></span><span leaf="">  top_gene_count = </span><span><span leaf="">10</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  controversy_threshold = </span><span><span leaf="">0.7</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  entropy_threshold = </span><span><span leaf="">1.0</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  cache_dir = cache_dir</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Print structure of results to understand the data</span></span><span leaf=""><br></span><span leaf="">print(</span><span><span leaf="">"Available fields in consensus_results:"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">print(names(consensus_results))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Add annotations to Seurat object</span></span><span leaf=""><br></span><span><span leaf=""># Get cell type annotations from consensus_results$final_annotations</span></span><span leaf=""><br></span><span leaf="">cluster_to_celltype_map &lt;- consensus_results$final_annotations</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Create new cell type identifier column</span></span><span leaf=""><br></span><span leaf="">cell_types &lt;- as.character(Idents(pbmc))</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> (cluster_id </span><span><span leaf="">in</span></span><span leaf=""> names(cluster_to_celltype_map)) {</span><span leaf=""><br></span><span leaf="">  cell_types[cell_types == cluster_id] &lt;- cluster_to_celltype_map[[cluster_id]]</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Add cell type annotations to Seurat object</span></span><span leaf=""><br></span><span leaf="">pbmc$cell_type &lt;- cell_types</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Add uncertainty metrics</span></span><span leaf=""><br></span><span><span leaf=""># Extract detailed consensus results containing metrics</span></span><span leaf=""><br></span><span leaf="">consensus_details &lt;- consensus_results$initial_results$consensus_results</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Create a data frame with metrics for each cluster</span></span><span leaf=""><br></span><span leaf="">uncertainty_metrics &lt;- data.frame(</span><span leaf=""><br></span><span leaf="">  cluster_id = names(consensus_details),</span><span leaf=""><br></span><span leaf="">  consensus_proportion = sapply(consensus_details, </span><span><span leaf="">function</span></span><span leaf="">(res) res$consensus_proportion),</span><span leaf=""><br></span><span leaf="">  entropy = sapply(consensus_details, </span><span><span leaf="">function</span></span><span leaf="">(res) res$entropy)</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Add uncertainty metrics for each cell</span></span><span leaf=""><br></span><span leaf="">pbmc$consensus_proportion &lt;- uncertainty_metrics$consensus_proportion[match(current_clusters, uncertainty_metrics$cluster_id)]</span><span leaf=""><br></span><span leaf="">pbmc$entropy &lt;- uncertainty_metrics$entropy[match(current_clusters, uncertainty_metrics$cluster_id)]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Save results for future use</span></span><span leaf=""><br></span><span leaf="">saveRDS(consensus_results, </span><span><span leaf="">"pbmc_mLLMCelltype_results.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">saveRDS(pbmc, </span><span><span leaf="">"pbmc_annotated.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Visualize results with SCpubr for publication-ready plots</span></span><span leaf=""><br></span><span><span leaf="">if</span></span><span leaf=""> (!requireNamespace(</span><span><span leaf="">"SCpubr"</span></span><span leaf="">, quietly = </span><span><span leaf="">TRUE</span></span><span leaf="">)) {</span><span leaf=""><br></span><span leaf="">  remotes::install_github(</span><span><span leaf="">"enblacar/SCpubr"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(SCpubr)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(viridis)  </span><span><span leaf=""># For color palettes</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Basic UMAP visualization with default settings</span></span><span leaf=""><br></span><span leaf="">pdf(</span><span><span leaf="">"pbmc_basic_annotations.pdf"</span></span><span leaf="">, width=</span><span><span leaf="">8</span></span><span leaf="">, height=</span><span><span leaf="">6</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">SCpubr::do_DimPlot(sample = pbmc,</span><span leaf=""><br></span><span leaf="">                  group.by = </span><span><span leaf="">"cell_type"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  label = </span><span><span leaf="">TRUE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  legend.position = </span><span><span leaf="">"right"</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  ggtitle(</span><span><span leaf="">"mLLMCelltype Consensus Annotations"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">dev.off()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># More customized visualization with enhanced styling</span></span><span leaf=""><br></span><span leaf="">pdf(</span><span><span leaf="">"pbmc_custom_annotations.pdf"</span></span><span leaf="">, width=</span><span><span leaf="">8</span></span><span leaf="">, height=</span><span><span leaf="">6</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">SCpubr::do_DimPlot(sample = pbmc,</span><span leaf=""><br></span><span leaf="">                  group.by = </span><span><span leaf="">"cell_type"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  label = </span><span><span leaf="">TRUE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  label.box = </span><span><span leaf="">TRUE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  legend.position = </span><span><span leaf="">"right"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  pt.size = </span><span><span leaf="">1.0</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  border.size = </span><span><span leaf="">1</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  font.size = </span><span><span leaf="">12</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  ggtitle(</span><span><span leaf="">"mLLMCelltype Consensus Annotations"</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  theme(plot.title = element_text(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">dev.off()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Visualize uncertainty metrics with enhanced SCpubr plots</span></span><span leaf=""><br></span><span><span leaf=""># Get cell types and create a named color palette</span></span><span leaf=""><br></span><span leaf="">cell_types &lt;- unique(pbmc$cell_type)</span><span leaf=""><br></span><span leaf="">color_palette &lt;- viridis::viridis(length(cell_types))</span><span leaf=""><br></span><span leaf="">names(color_palette) &lt;- cell_types</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Cell type annotations with SCpubr</span></span><span leaf=""><br></span><span leaf="">p1 &lt;- SCpubr::do_DimPlot(sample = pbmc,</span><span leaf=""><br></span><span leaf="">                  group.by = </span><span><span leaf="">"cell_type"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  label = </span><span><span leaf="">TRUE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  legend.position = </span><span><span leaf="">"bottom"</span></span><span leaf="">,  </span><span><span leaf=""># Place legend at the bottom</span></span><span leaf=""><br></span><span leaf="">                  pt.size = </span><span><span leaf="">1.0</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                  label.size = </span><span><span leaf="">4</span></span><span leaf="">,  </span><span><span leaf=""># Smaller label font size</span></span><span leaf=""><br></span><span leaf="">                  label.box = </span><span><span leaf="">TRUE</span></span><span leaf="">,  </span><span><span leaf=""># Add background box to labels for better readability</span></span><span leaf=""><br></span><span leaf="">                  repel = </span><span><span leaf="">TRUE</span></span><span leaf="">,  </span><span><span leaf=""># Make labels repel each other to avoid overlap</span></span><span leaf=""><br></span><span leaf="">                  colors.use = color_palette,</span><span leaf=""><br></span><span leaf="">                  plot.title = </span><span><span leaf="">"Cell Type"</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      theme(plot.title = element_text(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">, margin = margin(b = </span><span><span leaf="">15</span></span><span leaf="">, t = </span><span><span leaf="">10</span></span><span leaf="">)),</span><span leaf=""><br></span><span leaf="">            legend.text = element_text(size = </span><span><span leaf="">8</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">            legend.key.size = unit(</span><span><span leaf="">0.3</span></span><span leaf="">, </span><span><span leaf="">"cm"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">            plot.margin = unit(c(</span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">), </span><span><span leaf="">"cm"</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Consensus proportion feature plot with SCpubr</span></span><span leaf=""><br></span><span leaf="">p2 &lt;- SCpubr::do_FeaturePlot(sample = pbmc,</span><span leaf=""><br></span><span leaf="">                       features = </span><span><span leaf="">"consensus_proportion"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       order = </span><span><span leaf="">TRUE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       pt.size = </span><span><span leaf="">1.0</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       enforce_symmetry = </span><span><span leaf="">FALSE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       legend.title = </span><span><span leaf="">"Consensus"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       plot.title = </span><span><span leaf="">"Consensus Proportion"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       sequential.palette = </span><span><span leaf="">"YlGnBu"</span></span><span leaf="">,  </span><span><span leaf=""># Yellow-Green-Blue gradient, following Nature Methods standards</span></span><span leaf=""><br></span><span leaf="">                       sequential.direction = </span><span><span leaf="">1</span></span><span leaf="">,  </span><span><span leaf=""># Light to dark direction</span></span><span leaf=""><br></span><span leaf="">                       min.cutoff = min(pbmc$consensus_proportion),  </span><span><span leaf=""># Set minimum value</span></span><span leaf=""><br></span><span leaf="">                       max.cutoff = max(pbmc$consensus_proportion),  </span><span><span leaf=""># Set maximum value</span></span><span leaf=""><br></span><span leaf="">                       na.value = </span><span><span leaf="">"lightgrey"</span></span><span leaf="">) +  </span><span><span leaf=""># Color for missing values</span></span><span leaf=""><br></span><span leaf="">      theme(plot.title = element_text(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">, margin = margin(b = </span><span><span leaf="">15</span></span><span leaf="">, t = </span><span><span leaf="">10</span></span><span leaf="">)),</span><span leaf=""><br></span><span leaf="">            plot.margin = unit(c(</span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">), </span><span><span leaf="">"cm"</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Shannon entropy feature plot with SCpubr</span></span><span leaf=""><br></span><span leaf="">p3 &lt;- SCpubr::do_FeaturePlot(sample = pbmc,</span><span leaf=""><br></span><span leaf="">                       features = </span><span><span leaf="">"entropy"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       order = </span><span><span leaf="">TRUE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       pt.size = </span><span><span leaf="">1.0</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       enforce_symmetry = </span><span><span leaf="">FALSE</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       legend.title = </span><span><span leaf="">"Entropy"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       plot.title = </span><span><span leaf="">"Shannon Entropy"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                       sequential.palette = </span><span><span leaf="">"OrRd"</span></span><span leaf="">,  </span><span><span leaf=""># Orange-Red gradient, following Nature Methods standards</span></span><span leaf=""><br></span><span leaf="">                       sequential.direction = -</span><span><span leaf="">1</span></span><span leaf="">,  </span><span><span leaf=""># Dark to light direction (reversed)</span></span><span leaf=""><br></span><span leaf="">                       min.cutoff = min(pbmc$entropy),  </span><span><span leaf=""># Set minimum value</span></span><span leaf=""><br></span><span leaf="">                       max.cutoff = max(pbmc$entropy),  </span><span><span leaf=""># Set maximum value</span></span><span leaf=""><br></span><span leaf="">                       na.value = </span><span><span leaf="">"lightgrey"</span></span><span leaf="">) +  </span><span><span leaf=""># Color for missing values</span></span><span leaf=""><br></span><span leaf="">      theme(plot.title = element_text(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">, margin = margin(b = </span><span><span leaf="">15</span></span><span leaf="">, t = </span><span><span leaf="">10</span></span><span leaf="">)),</span><span leaf=""><br></span><span leaf="">            plot.margin = unit(c(</span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.8</span></span><span leaf="">), </span><span><span leaf="">"cm"</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Combine plots with equal widths</span></span><span leaf=""><br></span><span leaf="">pdf(</span><span><span leaf="">"pbmc_uncertainty_metrics.pdf"</span></span><span leaf="">, width=</span><span><span leaf="">18</span></span><span leaf="">, height=</span><span><span leaf="">7</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">combined_plot &lt;- cowplot::plot_grid(p1, p2, p3, ncol = </span><span><span leaf="">3</span></span><span leaf="">, rel_widths = c(</span><span><span leaf="">1.2</span></span><span leaf="">, </span><span><span leaf="">1.2</span></span><span leaf="">, </span><span><span leaf="">1.2</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">print(combined_plot)</span><span leaf=""><br></span><span leaf="">dev.off()</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAticG8OgACsFHgu8K34I4fVKqa1vJTb6WuSLDiajRY7NO2KEFH4x7RUHDg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3888888888888889" data-type="png" data-w="1080" data-imgfileid="100034659" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAticG8OgACsFHgu8K34I4fVKqa1vJTb6WuSLDiajRY7NO2KEFH4x7RUHDg/640?wx_fmt=png&amp;from=appmsg"></span></figure><blockquote><span></span><p><span leaf="">图表：左图显示了 UMAP 投影上的细胞类型注释。中图使用黄色-绿色-蓝色渐变显示了共识比例（更深的蓝色表示更强的一致性）。右图使用橙色-红色渐变显示了 Shannon Entropy（更深的红色表示更低的不确定性，更浅的橙色表示更高的不确定性）。</span></p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">摘要</span></span><span></span></h2><blockquote><span></span><p><span leaf="">不同的大语言模型（LLMs）有可能相互补充。我们介绍了一种迭代多模型共识框架，用于注释单细胞 RNA 测序数据。该框架在 50 个来自 26 种不同组织的多样化数据集中表现出色，涵盖超过 800 万个细胞，其平均准确率比最先进的方法高出近 15%（77.3% vs 61.3%）。通过利用跨模型的讨论，我们的框架量化了不确定性，识别了需要专家审查的模糊聚类，提供了透明的推理链，并最大限度地减少了大规模研究中细胞类型注释所需的努力和专业知识。此外，我们的框架使用户能够无缝地整合新的 LLMs。</span></p></blockquote><ul><li><section><strong><span leaf="">关键词: 细胞类型注释, 集体智能, 大型语言模型, 多共识, 单细胞 RNA 测序, 不确定性量化</span></strong></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">结果</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">细胞类型注释是单细胞 RNA 测序（scRNA-seq）数据分析中的关键步骤，对于将海量的细胞数据转化为生物学洞见至关重要。早期的注释方法依赖于人工专家手动将每个细胞簇中高表达的基因与文献中的经典细胞类型标记基因进行比对，这一流程不仅耗时，而且需要专业的生物知识。随着数据集规模扩大到数百万个来自不同组织的细胞，手动注释的方法已变得难以实现。</span></p><p data-tool="mdnice编辑器"><span leaf="">在过去十年中，研究人员提出了多种计算方法来解决这一问题，涵盖监督学习方法（如 </span><strong><span leaf="">SingleR</span></strong><span leaf="">），无监督学习方法（如 </span><strong><span leaf="">scCATCH</span></strong><span leaf="">）以及基于知识的方法（如 </span><strong><span leaf="">CellAssign</span></strong><span leaf="">）。关于这些方法的近期综述可见文献。</span></p><p data-tool="mdnice编辑器"><span leaf="">尽管有许多算法被提出，注释准确性仍然远未达到理想状态，尤其是在研究较少的组织类型中特别明显。因此，新的方法仍在不断开发中。最近的两个有前景的研究成果是 </span><strong><span leaf="">popV</span></strong><span leaf=""> 和 </span><strong><span leaf="">GPTCelltype</span></strong><span leaf="">，它们旨在提升注释准确性。popV 基于集成学习的思想，整合多个单一注释工具的优势；而 GPTCelltype 则利用大语言模型（LLM）的能力，通过解读标记基因表达模式，并结合 LLM 训练数据中蕴含的先验生物学知识，给出有生物学依据的细胞类型注释。</span></p><p data-tool="mdnice编辑器"><span leaf="">尽管如此，目前最先进的方法依然存在显著的局限性。例如，popV 虽然能整合多种机器学习算法，但其方法完全依赖数据驱动，无法利用关于细胞类型特异性基因表达的丰富生物学先验知识。而基于 LLM 的 GPTCelltype 方法，虽然可通过理解语言模型中学习到的知识进行注释，但它依赖于特定模型总结的生物知识，容易受个体模型偏差影响，而且缺乏对注释不确定性的有效量化。</span><strong><span leaf="">更根本性的挑战在于：如何整合来自标记基因的复杂且时常互相矛盾的证据、细胞类型本体论（ontology）之间的关系以及发育谱系相关知识，而这些在当前 LLM 框架下仍未解决。</span></strong></p><p data-tool="mdnice编辑器"><span leaf="">自 ChatGPT 问世以来，其他多个大语言模型相继被开发出来，例如 Claude、Gemini、Grok、Deepseek、Qwen 等。由于每个 LLM 都在其各自架构、训练算法和训练数据基础上总结了现有的人类知识，我们推测不同的 LLM 在细胞类型识别方面的性能会存在显著差异。确实，在我们基于 GPTCelltype 算法对不同 LLM 所进行的细胞类型识别性能比较中，观察到了各细胞类型之间准确率的显著差异（图 1a）。</span></p><p data-tool="mdnice编辑器"><span leaf="">因此，我们提出一个假设：</span><strong><span leaf="">通过利用多个 LLM 各自的优势，细胞类型注释准确率可以得到显著提升</span></strong><span leaf="">。为实现这一目标，</span><strong><span leaf="">我们开发了一个用于细胞类型识别的多 LLM 共识框架：mLLMCelltype。该框架可系统地整合多个 LLM，从而减少单一模型的偏差，并通过结构化的协作推理实现更优的不确定性量化</span></strong><span leaf="">。</span></p><p data-tool="mdnice编辑器"><strong><span leaf="">mLLMCelltype 框架整合多个 LLM 以实现 scRNA-seq 的细胞类型注释</span></strong><span leaf="">，其工作流程如图 1 所示。</span><strong><span leaf="">首先，通过差异表达分析识别出每个细胞簇的标记基因，该分析是通过将每个细胞簇与其他簇进行比较，从预处理和聚类后的 scRNA-seq 数据中生成的（见图 1b）</span></strong><span leaf="">。这些标记基因列表，结合组织上下文信息，构成了我们框架的主要输入（见图 1c）。</span><strong><span leaf="">随后，多个大语言模型（LLMs）（见图 1d）独立接收这些输入，并为每个细胞簇提出初步的细胞类型注释，同时基于标记基因证据提供生物学推理</span></strong><span leaf="">。</span><strong><span leaf="">对于那些未能立即达成高共识的细胞簇，框架将启动一个迭代审议流程</span></strong><span leaf="">（见图 1e）。在每一轮协商中，LLMs 会共享其结构化的论据，讨论特定标记基因的重要性（例如泛髓系标记 CD68 与组织特异性标记 MARCO 的对比）、潜在参与的信号通路，并评估组织上下文对细胞身份的影响。每个 LLM 会根据其他模型呈现的证据和推理结果，重新权衡并优化自己的分类结果。关键在于：在每轮审议之后，一个专门的共识检查模型（Consensus Checker LLM）会对参与模型之间的意见一致程度进行评估，与预设的共识阈值进行比较（图 1e 中以“CC”节点表示）。如果达成共识，则流程终止，输出最终注释结果及对应的置信评分；如果未达成共识，则进入下一轮讨论（最多允许若干轮），或将该细胞簇标记为模糊不清。</span></p><p data-tool="mdnice编辑器"><span leaf="">图 1d 和图 1e 以一个髓系细胞簇为例说明了这一流程：起初'巨噬细胞'（Macrophage）与'树突状细胞'（Dendritic Cell）之间的分歧，源于如 CD68 与 CD11c 等矛盾的标记基因（见图 1d 与图 1e 的第一轮）；审议过程中加入了肺组织这一上下文信息以及额外的标记基因（如 MARCO、CD206）后，最终在第三轮审议中达成了一致，识别为“肺泡巨噬细胞（Alveolar Macrophage）”（见图 1e 第三轮）。最终，框架将输出以下内容：</span><strong><span leaf="">最终的共识注释结果</span></strong><span leaf="">、</span><strong><span leaf="">不确定性指标（共识比例 - CP）</span></strong><span leaf=""> 以及</span><strong><span leaf="">详细的推理过程</span></strong><span leaf="">（见图 1e 最终输出）。通常在多轮审议之后，整体共识程度会逐步提升（见图 1f）。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtxdGmyFKK9ArZzLk9bvV3XkrhcCJiajGsx2hc2ibk0A0n6m3HYNTLJibSg/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.028052805280528" data-type="png" data-w="606" data-imgfileid="100034656" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtxdGmyFKK9ArZzLk9bvV3XkrhcCJiajGsx2hc2ibk0A0n6m3HYNTLJibSg/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">图 1：mLLMCelltype 框架的工作流程</span></strong><span leaf="">。</span><strong><span leaf="">a</span></strong><span leaf="">，互补优势：不同的 LLMs（GPT，Claude，Gemini）在不同细胞类型和组织中表现出不同的性能，突显了多模型方法的价值。此处展示的性能模式是基于本研究中评估的多样化基准数据集的结果综合所得。</span><strong><span leaf="">b</span></strong><span leaf="">，输入准备：对聚类数据进行差异表达（DE）分析以获得标记基因（可选：姐妹簇标记基因）。</span><strong><span leaf="">c</span></strong><span leaf="">，框架输入：标记基因（来自 b）和组织背景提供给 LLMs。</span><strong><span leaf="">d</span></strong><span leaf="">，初始聚类预测：LLMs 独立地根据输入为每个聚类提出初始注释。</span><strong><span leaf="">e</span></strong><span leaf="">，迭代共识：LLMs 在多轮讨论中，在共识检查器（CC）的指导下分享论据以达成一致。输出包括最终注释和共识比例（CP）。</span><strong><span leaf="">f</span></strong><span leaf="">，共识演变：讨论逐步提高共识在后续轮次中的质量。</span></p></section></section><p data-tool="mdnice编辑器"><span leaf="">从根本上讲，mLLMCelltype 通过其多 LLM 共识架构实现了性能提升，该架构利用集体智能来克服单一模型的局限性。具体而言，整合多样化且互补的 LLM 集成直接解决了个体模型偏差问题；不同 LLM 之间在训练数据和模型架构上的差异意味着一个模型中存在的系统性错误或偏差不太可能被所有模型共享，从而导致更平衡、更准确的共识（扩展数据图 2）。此外，这种内在的多样性也促进了知识整合，汇集了不同模型捕获的潜在互补的生物学知识广度和深度。至关重要的是，迭代协商过程体现了结构化推理，模型们能批判性地评估不同观点。这一机制积极抑制了不准确或缺乏支持的"幻觉"（扩展数据图 1），这是单一 LLM 的已知弱点，从而降低了注释错误率。通过协商的渐进式优化导致了模型间一致性的可测量提升（扩展数据图 3）。此外，共识方法本身增强了对噪声输入的鲁棒性（扩展数据图 4）。总而言之，通过多样性实现的偏差缓解、全面的知识整合、通过协商进行的主动错误修正以及对输入的内在鲁棒性，共同构成了 mLLMCelltype 框架实现的卓越准确性和可靠性的基础。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtYt9p0P9WI84B6GDtXYID8OIJbPSaPQNA6AZPg2Sw9n0NvEItWqwL7g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.32909379968203495" data-type="png" data-w="629" data-imgfileid="100034661" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtYt9p0P9WI84B6GDtXYID8OIJbPSaPQNA6AZPg2Sw9n0NvEItWqwL7g/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">扩展数据图 1：迭代讨论过程中模型共识比例与幻觉减少之间的关系</span></strong><span leaf="">。</span><strong><span leaf="">a</span></strong><span leaf="">, 在细胞类型注释的背景下，随着审议轮次的增加，虚构概率逐渐减少。在细胞类型注释中，虚构指的是 LLM 生成的细胞类型注释或生物解释不符合标记基因的证据、与文献中已建立的细胞类型层次结构不一致，或者包含细胞特征的生物上不合理的组合。例如，声称一个细胞既是 T 细胞又是 B 细胞，或者将神经元特异性标记基因分配给免疫细胞，都属于虚构。从初始预测到最终的结构化讨论轮次，这种事件的发生概率显著降低，这表明我们迭代共识构建方法的有效性。</span><strong><span leaf="">b</span></strong><span leaf="">, 负相关性共识比例和幻觉概率。模型之间共识比例较高的情况下，幻觉概率较低。这种关系表明，模型达成高共识的情况特别可靠，幻觉风险极小。相反，共识比例较低则可能表明存在潜在问题的预测，可能需要进一步的讨论或专家审查。</span></p></section></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtvGGAVNB9Dnbs3VJpIibptrKOWN5W9ef0LJM51j6mkK3M38nKhUEQ9FQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4512" data-type="png" data-w="625" data-imgfileid="100034664" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtvGGAVNB9Dnbs3VJpIibptrKOWN5W9ef0LJM51j6mkK3M38nKhUEQ9FQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">扩展数据图 2：多个语言模型对细胞类型注释准确度的影响</span></strong><span leaf="">。</span><strong><span leaf="">a</span></strong><span leaf="">, 多语言模型数量与整体注释准确度之间的关系。折线图展示了随着更多语言模型被纳入集成中，细胞类型注释准确度如何提高，从 1 到 6 个模型，整体趋势是持续上升的 LLMs。阴影区域表示基于 100 次独立复制的置信区间，显示随着更多模型参与共识注释，方差有所减少。这表明集成方法可以显著提高注释的可靠性。</span><strong><span leaf="">b</span></strong><span leaf="">, 不同样本难度水平下注释性能的分析。图表显示了随着 LLMs 数量增加，对于简单（蓝色）、中等（绿色）和困难（红色）样本的注释准确度如何变化。简单样本在使用 6 个 LLMs 时达到超过 90%的准确度，而中等和困难样本相对于使用单个 LLM 模型时，显示出更显著的相对改进（分别为 22.4%和 38.0%）。这一分析表明，集成方法特别适用于难以用单个模型注释的挑战性细胞类型。</span></p></section></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtsw2Zl37pJvGDlMZLhr3uL7sjbsydkKiaN2MJ9bmZbzicU0azjXk0qcQw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3402555910543131" data-type="png" data-w="626" data-imgfileid="100034662" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtsw2Zl37pJvGDlMZLhr3uL7sjbsydkKiaN2MJ9bmZbzicU0azjXk0qcQw/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">扩展数据图 3：在讨论轮次中 LLM 预测共识比例的逐步提高。</span></strong><span leaf=""> &gt; </span><strong><span leaf="">a</span></strong><span leaf="">, 显示初始一致性比例在第一轮预测中不同 LLMs 之间的热图。</span><strong><span leaf="">b</span></strong><span leaf="">, 显示在第二轮讨论后 LLMs 之间增加的一致性比例的热图。c, 显示在第三轮中实现的高一致性比例，表明成功的共识构建。</span></p></section></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtKSzVkkkFytt5Co7nO9mwuPPOWZEYL9Q5zurwjAtCxianvuggh1ibzPaQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6896551724137931" data-type="png" data-w="638" data-imgfileid="100034663" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtKSzVkkkFytt5Co7nO9mwuPPOWZEYL9Q5zurwjAtCxianvuggh1ibzPaQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">扩展数据图 4：多-LLM 共识框架中标记基因扰动稳健性的系统评估。</span></strong><strong><span leaf="">a</span></strong><span leaf="">, 在不同类型的 marker 基因扰动下，对注释稳健性进行定量评估，比较我们的框架和 GPTCelltype 方法。我们的框架在所有扰动类型中表现出更优的稳健性模式：对于管家基因注入，我们的框架在 10%噪声水平下仅显示出 4.5%的准确率下降，而 GPTCelltype 的下降为 8.5%，这表明我们的框架能够更好地识别非区分性基因。对于错误的细胞类型标记注入，我们的框架（在 10%噪声水平下 10%的准确率下降）显著优于 GPTCelltype（16.5%的准确率下降），表明我们的框架在直接干扰细胞类型鉴定方面具有更大的抗干扰能力。对于随机基因注入（7.5% vs. 13.5%的准确率下降）和 marker 基因丢失（8.5% vs. 14.5%的准确率下降），也观察到类似的表现优势，验证了我们的框架在优先识别生物学相关信号方面优于 GPTCelltype。</span><strong><span leaf="">b</span></strong><span leaf="">, 细胞类型依赖的稳健性分析揭示了我们的框架与 GPTCelltype 在细胞层次上的不同表现模式。对于主要的细胞类型，在 30%的噪声水平下，我们的框架保持了超过 90%的准确性，并且几乎没有衰减（每 10%噪声水平衰减 2.5%），而 GPTCelltype 则显示出更陡峭的退化（5.5%的衰减率）。对于细胞亚型，这种性能差距进一步扩大（6.5% vs. 11%的衰减率），并且在稀有群体中表现得最为明显，其中我们的框架在 9.5%的衰减率下显著优于 GPTCelltype 的 16%衰减率。这种分层响应模式表明，我们的框架增强了利用冗余标记基因进行准确分类的能力，特别是在标记基因信息更为有限的稀有细胞群体中。</span><strong><span leaf="">c</span></strong><span leaf="">, 在增加标记基因扰动情况下的 LLM 共识动力学的定量表征。随着噪声水平的增加，审议要求以非线性方式变化，从基线时的 1.5 轮审议到 50%噪声水平时的 4.8 轮审议，共识比例从 95%下降到 62%。背景点表示每个噪声水平下的 8 次独立共识尝试，显示出在较高噪声水平下审议模式的变异性增加（标准差从 0.1 增加到 0.35）。</span><strong><span leaf="">d</span></strong><span leaf="">, 使用区域图分析框架的自适应决策行为。决策类型的分布从基线时的几乎全部直接共识（95%，指数衰减率 −0.045）转变为在较高噪声水平（30%噪声水平时达到峰值）下更多依赖通过审议轮次达成的共识，并标记不确定性。在严重噪声条件下（&gt;30%噪声水平），框架表现出显著增加的不确定性标记（非线性增长，指数 1.8），反映了其内置的质量控制机制。</span></p></section></section><p data-tool="mdnice编辑器"><span leaf="">我们对 mLLMCelltype 进行了评估，涵盖了来自不同组织和来源的 50 个多样化数据集，包括 Tabula Sapiens（TS）、人类细胞景观（HCL）、小鼠细胞图谱（MCA）、基因型-组织表达（GTEx）跨组织数据、人类生物分子图谱计划（HuBMAP）scRNA-seq 数据、人类肺细胞图谱（HLCA），以及专门的数据集，包括 B 细胞淋巴瘤（BCL）和来自结肠和肺的癌症数据集。我们使用了一部分稳定且持续可访问的模型：GPT-4o（OpenAI）、Claude-3.5-Sonnet 和 Claude-3.5-Haiku（Anthropic）、Gemini-1.5-Pro 和 Gemini-2.0-Flash-Exp（Google）以及 Qwen2.5-Max（阿里巴巴）。</span></p><p data-tool="mdnice编辑器"><span leaf="">我们将重点比较与 GPTCelltype 的性能差异，因为 GPTCelltype 已经与传统计算方法进行了广泛的基准测试，并证明其注释准确率显著高于已建立的工具，包括 ScType、SingleR 和 CellMarker2.0。mLLMCelltype 与 GPTCelltype 之间的比较突显了利用多个 LLM 可以在多大程度上提升性能。在各种组织类型中，mLLMCelltype 平均提高了 15%的注释准确率（77.3%对比 61.3%）（图 2a），在 GPTCelltype 表现不佳的具有挑战性的数据集上取得了特别显著的进步。在特征明确的细胞类型上，它实现了&gt;95%的注释准确率，并在对 GPTCelltype 具有挑战性的数据集上展示了显著改进（20-30%）。</span></p><p data-tool="mdnice编辑器"><span leaf="">对于几种组织，我们的框架在注释准确率方面表现出了显著的改进：前列腺（GTEx）（86.0%对比 48.0%，提升了 38.0%）、食道（GTEx）（87.3%对比 52.5%，提升了 34.8%）和肺（GTEx）（84.8%对比 52.2%，提升了 32.6%）。这些组织由于其复杂的细胞组成、相关细胞类型之间的微妙表型差异，以及需要对标记基因表达模式进行细致解读的组织特异性细胞状态，因此呈现出特殊的挑战。值得注意的是，在需要审议的情况下，mLLMCelltype 追踪和记录完整推理过程的能力提供了对注释挑战的宝贵见解，使专家能够高效地审查有争议的案例。</span></p><p data-tool="mdnice编辑器"><span leaf="">接下来，我们将 mLLMCelltype 与 popV 进行比较，popV 是近期表现优异的基于机器学习的细胞类型注释工具，它也采用基于共识的方法。由于 popV 执行细胞级别的注释，细胞簇中的细胞可能具有不同的细胞身份。为了进行比较，我们使用多数规则为 popV 实现簇级别的注释。我们比较了原始 popV 研究中使用的基准数据集上的性能。在具有挑战性的人类胸腺发育数据集上，mLLMCelltype 与 popV 相比，注释准确率提高了 10.6%（图 2b）。在肺细胞图谱（LCA）上，mLLMCelltype 实现了 13.17%的注释准确率提升（图 2c），特别是在区分紧密相关的肺细胞亚群方面。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtmEyIUZdv9jjz6MQqGRcmu0nDvXQubSia40qSLxiaia7YEiaulDf12icQibzg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9919743178170144" data-type="png" data-w="623" data-imgfileid="100034665" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtmEyIUZdv9jjz6MQqGRcmu0nDvXQubSia40qSLxiaia7YEiaulDf12icQibzg/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">图 2：跨多种数据集的性能评估</span></strong><span leaf="">。</span><strong><span leaf="">a</span></strong><span leaf="">，与 GPTCelltype 的比较，显示完全匹配和部分匹配（参见“方法”部分中的定义），准确性以百分比形式呈现。</span><strong><span leaf="">b</span></strong><span leaf="">，发育中人类胸腺细胞图谱的性能比较。UMAP 可视化显示参考（第一），mLLMCelltype 预测（第二），GPTCelltype 预测（第三），以及群组级别 popV 预测（第四）的细胞类型注释，点按细胞类型着色。</span><strong><span leaf="">c</span></strong><span leaf="">，肺细胞图谱（LCA）的性能比较。UMAP 可视化显示参考（第一），mLLMCelltype 预测（第二），GPTCelltype 预测（第三），以及群组级别 popV 预测（第四）的细胞类型注释，按细胞类型着色。</span></p></section></section><p data-tool="mdnice编辑器"><span leaf="">尽管 popV 具有许多独特的优势，例如聚类独立性，但它面临两个主要限制：基于参考的特性和计算需求。popV 的性能严重依赖于高质量参考数据集的可用性进行预训练，而其基于矩阵的方法需要大量的计算资源，这些资源在典型工作站上并不容易获得。相比之下，mLLMCelltype 既不需要预训练也不需要参考数据集，能够在标准硬件上进行高效注释。</span></p><p data-tool="mdnice编辑器"><span leaf="">尽管 mLLMCelltype 不需要参考数据集，但它可能会遇到与训练数据包含相关的问题。这种情况发生在训练数据包含基准数据时，可能导致性能被高估。为解决这一顾虑，我们使用在 LLMs 训练截止日期之后发布的数据集进一步验证了我们的方法。我们在最近发布的人类神经类器官细胞图谱（HNOCA）上评估了 mLLMCelltype，该图谱整合了来自 26 种不同器官培养方案的 36 个单细胞转录组数据集，以及一个综合性的人类外周免疫细胞图谱，该图谱分析了跨越从出生到 90 岁以上的 13 个年龄组的免疫细胞。这两个数据集都发布于我们框架中使用的 LLMs 的训练日期之后，为真正新数据的泛化能力提供了严格测试。</span></p><p data-tool="mdnice编辑器"><span leaf="">在包含超过 170 万个细胞的 HNOCA 数据集上，尽管神经细胞类型和发育状态十分复杂，我们的框架仍然达到了高注释准确率（96.45%，相比 GPTCelltype 的 83.95%；见扩展数据图 5）。mLLMCelltype 在准确识别特定神经祖细胞类型和神经元亚型方面表现出特别的优势，这些细胞类型对单一 LLM 方法是具有挑战性的。同样，在包含 220 名健康捐献者和广泛多组学分析的生命周期免疫细胞图谱数据集上，mLLMCelltype 达到了 78.0%的注释准确率，相比 GPTCelltype 的 65.3%（扩展数据图 6）。这个数据集因其免疫细胞转录组的精细时间分辨率、多样化的细胞群体和复杂的发育转变而特别具有挑战性。我们在更大的数据集上成功验证了这一能力，包含超过 240 万个细胞的 HLCA（扩展数据图 7）。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtAjJRA2Po734Pvx9t5uVX1e7yd4PQIfxspxVFU0GYRKybpYEICHZrlw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3227848101265823" data-type="png" data-w="632" data-imgfileid="100034667" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtAjJRA2Po734Pvx9t5uVX1e7yd4PQIfxspxVFU0GYRKybpYEICHZrlw/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">扩展数据图 5：HNOCA 数据集注释结果比较。</span></strong><span leaf=""> &gt; </span><strong><span leaf="">a</span></strong><span leaf="">, UMAP 可视化展示了 HNOCA 参考注释的主要神经细胞类型群体和发育状态。参考注释是通过使用 snapseed 工具生成的，该工具结合了层次细胞类型定义、标记基因评分和参考映射到人类发育大脑图谱中的过程。数据进一步通过 scPoli 集成和从参考大脑图谱中使用 scVI 和 scANVI 进行标签转移，特别是对于非端脑神经元和前体细胞。</span><strong><span leaf="">b</span></strong><span leaf="">, UMAP 可视化展示了我们框架的注释，显示出在识别各种神经细胞类型和发育状态方面表现出强大的性能，当与大规模集成图谱中的参考注释进行评估时，具有很高的注释准确性。</span><strong><span leaf="">c</span></strong><span leaf="">, UMAP 可视化展示了 GPTCelltype 的注释，其准确性低于我们框架，特别是在区分相关神经前体状态和专门的神经亚型方面。</span></p></section></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtRt5qNhicfOYL01VSapEhssib7Dzv0q0U7fjKibTphEgicElibI42YibENZJw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.31046312178387653" data-type="png" data-w="583" data-imgfileid="100034669" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtRt5qNhicfOYL01VSapEhssib7Dzv0q0U7fjKibTphEgicElibI42YibENZJw/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">Extended Data 图表 6：寿命范围内人类外周免疫细胞图谱的注释性能。</span></strong><strong><span leaf="">a</span></strong><span leaf="">, UMAP 可视化图展示了参考注释中免疫细胞类型在整个生命周期中的分布。参考注释是通过对 220 名健康捐赠者的免疫细胞进行全面分析生成的，这些捐赠者覆盖了从出生到超过 90 岁的 13 个年龄组，结合了转录组数据和专家注释。</span><strong><span leaf="">b</span></strong><span leaf="">, UMAP 可视化图展示了我们框架的注释，在与参考注释评估时显示出高注释准确性（76.6%），成功捕捉了复杂的发育过渡和多样的免疫细胞群体。</span></p></section></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtib4ibaHUQAickxOUlNBRTmiaLcG2oGiaseCs52wQKaK9cqfKvC6SIZ7wsHw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4904153354632588" data-type="png" data-w="626" data-imgfileid="100034668" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtib4ibaHUQAickxOUlNBRTmiaLcG2oGiaseCs52wQKaK9cqfKvC6SIZ7wsHw/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">扩展数据图 7：HLCA 数据集注释结果比较。</span></strong><strong><span leaf="">a</span></strong><span leaf="">，HLCA 参考注释的 UMAP 可视化，展示了主要细胞类型群体及其分布。HLCA 参考注释是通过一个分层框架生成的，包含 5 个粒度级别，从广泛的标签（第 1 级：免疫细胞、上皮细胞等）到精细的细胞类型（第 5 级：例如，初始 CD4 T 细胞）。数据整合和聚类是使用 scANVI 执行的，随后在不同分辨率下进行 Leiden 聚类（第 1 级：0.01，第 2 级：0.2，k = 30，第 3-5 级：0.2，k = 15/10）。最终的注释由六位肺脏生物学专家根据聚类结果、标记基因证据和 HLCA 核心聚类结果手动整理。</span><strong><span leaf="">b</span></strong><span leaf="">，我们框架注释的 UMAP 可视化，与参考注释相比显示了高注释准确性。按照与参考相同的分层聚类方法，我们的框架逐级执行细胞类型注释。在每个级别，向 LLMs 提供全局标记基因（在一个簇中特异表达的基因，与所有其他簇相比）和姐妹标记基因（目标簇与同一父簇内的姐妹簇之间差异表达的基因），以及来自前一级别的父簇注释，以指导注释过程。</span></p></section></section><p data-tool="mdnice编辑器"><span leaf="">研究我们框架对噪声标记基因列表的鲁棒性很有意义。我们通过四种类型的扰动生成了噪声标记基因列表：管家基因注入、错误细胞类型的标记基因注入、随机基因注入和随机标记基因丢失。值得注意的是，mLLMCelltype 即使在显著噪声下也表现出一致的性能，主要细胞类型在各种扰动类型下，噪声水平高达 30%时仍能保持超过 90%的注释准确率（扩展数据图 4）。这种弹性突显了该框架在噪声中有效辨别生物信号的能力。输入标记基因的数量是我们框架的一个参数。我们发现在 20-30 个基因之间的范围在不同分类复杂性下的注释准确率和计算成本之间提供了实用的平衡（扩展数据图 9）。</span></p><p data-tool="mdnice编辑器"><span leaf="">补充其对输入噪声的鲁棒性，该框架的跨模型协商机制还积极减轻模型特定的幻觉（扩展数据图 1），这一特性对于准确注释单一模型可能猜测的稀有或模糊细胞类型尤为关键。结合从协商过程中得出的共识比例和香农熵度量，这提供了透明的不确定性量化，使研究人员能够识别需要专家审查的具有挑战性的细胞群体——这是许多自动化方法所缺乏的能力。</span></p><p data-tool="mdnice编辑器"><span leaf="">最后，我们的框架在不同 scRNA-seq 技术上展示了一致的性能，在 Drop-seq 数据和单核 RNA 测序（snRNA-seq）数据上都表现出稳健的性能（扩展数据图 8）。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtnJGBjZ5iaz0Rtlfcbicyjpqa55ACceiak7chGtxWFbg70D5Af3sM7gFxA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9625" data-type="png" data-w="640" data-imgfileid="100034670" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtnJGBjZ5iaz0Rtlfcbicyjpqa55ACceiak7chGtxWFbg70D5Af3sM7gFxA/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">扩展数据图 8：本框架在替代单细胞测序平台上的性能</span></strong><span leaf=""> &gt; </span><strong><span leaf="">a</span></strong><span leaf="">, Drop-seq 数据的参考注释的 UMAP 可视化，展示了该替代测序平台中的细胞群体分布。</span><strong><span leaf="">b</span></strong><span leaf="">, 我们框架对 Drop-seq 数据的注释 UMAP 可视化，显示了 95%的注释准确性与参考注释一致。</span><strong><span leaf="">c</span></strong><span leaf="">, snRNA-seq 数据的参考注释 UMAP 可视化，展示了 snRNA-seq 平台中的细胞类型分布。d, 我们框架对 snRNA-seq 数据的注释 UMAP 可视化，展示了在不同核转录组谱型中的稳健性能，验证了我们框架对不同 scRNA-seq 技术的适用性。</span></p></section></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtN4MLJLAoLvhA6VGTuCLhWL5xznj1aapb66TiaMvv9SHvUAIe1HSXYBQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4444444444444444" data-type="png" data-w="621" data-imgfileid="100034666" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtN4MLJLAoLvhA6VGTuCLhWL5xznj1aapb66TiaMvv9SHvUAIe1HSXYBQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><section data-tool="mdnice编辑器"><section><p><strong><span leaf="">扩展数据图 9：多细胞类型注释框架的标记基因选择优化。</span></strong><span leaf=""> &gt; </span><strong><span leaf="">a</span></strong><span leaf="">, 通过不同分类复杂性下的标记基因数量对注释准确性进行定量评估。展示了三个不同的复杂性级别：简单谱系分类（红色线条，例如 B/T 细胞区分），中间亚型（蓝色线条，例如 CD4+/CD8+ T 细胞亚型），和复杂状态（绿色线条，例如幼稚/记忆/效应状态）。性能曲线表明不同的最优范围：简单谱系分类（8-15 个标记基因），中间复杂性（15-25 个标记基因），和复杂发育状态（20-35 个标记基因）。每个数据点代表注释准确性，误差棒表示标准偏差。超过 30 个标记基因的阴影区域表明潜在的边际效益递减和增加的复杂性。</span><strong><span leaf="">b</span></strong><span leaf="">, 框架效率与 marker 基因数量的双重分析。主轴（红色）显示注释准确性，次轴（蓝色）跟踪每次注释的 API 成本。蓝色阴影区域（20-30 个 marker 基因）突出显示了平衡准确性和资源利用的最佳操作范围。</span></p></section></section><p data-tool="mdnice编辑器"><span leaf="">从实际应用角度看，mLLMCelltype 为大规模单细胞分析带来了显著优势。其模块化设计允许无缝集成新的 LLMs，确保未来的适应性。其核心优势在于透明、系统的共识过程：通过跟踪多模型协商，它提供了详细的推理链。这使专家能够基于共识指标高效地识别和审查有争议的案例，并获得完整背景，从而大大减少手动注释时间，同时提高复杂组织细胞类型注释的整体可靠性和质量。</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">结尾</span></span><span></span></h2><blockquote><span></span><p><strong><span leaf="">路漫漫其修远兮,吾将上下而求索。</span></strong></p></blockquote><hr><p data-tool="mdnice编辑器"><span leaf="">欢迎加入生信交流群。加我微信我也拉你进 </span><strong><span leaf="">微信群聊</span></strong><strong><span leaf="">老俊俊生信交流群</span></strong><strong><span leaf="">(微信交流群需收取 20 元入群费用,一旦交费,拒不退还!(防止骗子和便于管理))</span></strong><span leaf=""> 。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtfiazYwibuKVPGfiaRe6BIeiaNFP2fmJkaiaGAAFFldyiaVy2s2kaIznpJpnQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6083707025411061" data-type="png" data-w="669" data-imgfileid="100034673" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewIrib2kPNibxzc8cn6zLINAtfiazYwibuKVPGfiaRe6BIeiaNFP2fmJkaiaGAAFFldyiaVy2s2kaIznpJpnQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><hr><p data-tool="mdnice编辑器"><strong></strong></p><center data-tool="mdnice编辑器"><strong><span leaf=""> 往期回顾目录 </span></strong></center><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><blockquote><span></span><ul><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247518278&amp;idx=1&amp;sn=92866dea30a9290eff7532c1a9eb9ace&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">单细胞中测量翻译的测序技术</a></span></left></strong></section></li><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247518266&amp;idx=1&amp;sn=bb559c9b9974f27928deab2cc54041a5&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">ggplot 添加对数刻度</a></span></left></strong></section></li><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247518246&amp;idx=1&amp;sn=d20731adaa8ade9cd29d9e0929277845&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">实现 pLogo 算法：基于显著性可视化 motif</a></span></left></strong></section></li><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247518213&amp;idx=1&amp;sn=9238b8027c6d10f49aa22b78566ae663&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">RiboTransVis 参考文档</a></span></left></strong></section></li><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247518202&amp;idx=1&amp;sn=5feded405fcd6ace4562587119c829c0&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">zeallot-R 里进行变量赋值</a></span></left></strong></section></li><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247518114&amp;idx=1&amp;sn=d9fd469d6487ad2f1f0a0e98665b0b3b&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">GseaVis: 一种用于生物医学中基因集富集分析增强可视化的 R 包</a></span></left></strong></section></li><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247518044&amp;idx=1&amp;sn=1d9e937b7b59625858d941ae503eb6fa&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">Logolas：一个 7 年前绘制 motif 的 R 包</a></span></left></strong></section></li><li><section><strong><left><span leaf="">多尺度足迹揭示了顺式调控元件的组织方式</span></left></strong></section></li><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247517965&amp;idx=1&amp;sn=693c77d042de0a3a2376d6dc82ceed16&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">grateful：一键完成 R 包论文格式引用</a></span></left></strong></section></li><li><section><strong><left><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247517923&amp;idx=1&amp;sn=cbe8b3f4c003d791d8387a06410acad2&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">RNA-seq 下游分析一条龙服务 broadSeq</a></span></left></strong></section></li></ul></blockquote></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/o0puc9XQedxnrpfH92fx0A",target="_blank" rel="noopener noreferrer">原文链接</a>
