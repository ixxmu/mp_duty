---
title: "R语言画图 | CIBERSORT 结果简单可视化 二 | 相关性条形图"
date: 2025-04-01T00:42:17Z
draft: ["false"]
tags: [
  "fetched",
  "被炸熟的虾"
]
categories: ["Acdemic"]
---
R语言画图 | CIBERSORT 结果简单可视化 二 | 相关性条形图 by 被炸熟的虾
------
<div><ul></ul><section data-pm-slice="0 0 []"><section><p data-pm-slice='2 2 ["para",{"tagName":"section","attributes":{"data-pm-slice":"0 0 []","style":"-webkit-tap-highlight-color: transparent;margin: 0px;padding: 0px;outline: 0px;max-width: 100%;color: rgba(0, 0, 0, 0.9);font-family: \"PingFang SC\", system-ui, -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"Hiragino Sans GB\", \"Microsoft YaHei UI\", \"Microsoft YaHei\", Arial, sans-serif;font-size: 17px;font-style: normal;font-variant-ligatures: normal;font-variant-caps: normal;font-weight: 400;letter-spacing: 0.544px;orphans: 2;text-align: justify;text-indent: 2em;text-transform: none;widows: 2;word-spacing: 0px;-webkit-text-stroke-width: 0px;white-space: normal;background-color: rgb(255, 255, 255);text-decoration-thickness: initial;text-decoration-style: initial;text-decoration-color: initial;visibility: visible;box-sizing: border-box !important;overflow-wrap: break-word !important;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"list",{"type":"ul","style":"","class":"list-paddingleft-1"},"listitem",{"style":""},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><span leaf="">这一类型的展示方法在富集分析中用得更多：</span></p><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzkwNDQwMDI5NQ==&amp;mid=2247485520&amp;idx=1&amp;sn=c41cec901b0050f9a774e278a4c1662e&amp;scene=21#wechat_redirect"><span leaf=""><span textstyle="">富集分析可视化 | 第一节 条形图</span></span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzkwNDQwMDI5NQ==&amp;mid=2247485533&amp;idx=1&amp;sn=65a2a6331ea45306e9982a8f5c896d3e&amp;scene=21#wechat_redirect"><span leaf=""><span textstyle="">富集分析可视化 | 第三节 棒棒糖图</span></span></a></section></li></ul><p><span leaf="">适合展示一对多的相关性，这里选择展示</span><span leaf="">CD3D</span><span leaf="">与</span><span leaf="">22</span><span leaf="">种免疫细胞的相关性：</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglqmOTNbWGcXcU8XStibLnwUZsQnrU5N3Z3QvVjVO66ZDyWv8hAM3llNQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6666666666666666" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100007105" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglqmOTNbWGcXcU8XStibLnwUZsQnrU5N3Z3QvVjVO66ZDyWv8hAM3llNQ/640?wx_fmt=png&amp;from=appmsg"></section><pre><code><span leaf="">rm(list = ls())</span><span leaf=""><br></span><span leaf="">load(file = </span><span><span leaf="">"./res_cibersort.Rdata"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">res_cibersort &lt;- data.frame(res_cibersort[,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">22</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">head(res_cibersort)</span><span leaf=""><br></span><span leaf="">load(</span><span><span leaf="">"D:/data/TCGA/TCGAbiolinks-EXP/TCGA-COAD-GeneSymbol.Rdata"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">res_cibersort$CD3D &lt;- as.numeric(exp_TPM[</span><span><span leaf="">"CD3D"</span></span><span leaf="">,rownames(res_cibersort)])</span><span leaf=""><br></span><span leaf="">res_cibersort$CD3E &lt;- as.numeric(exp_TPM[</span><span><span leaf="">"CD3E"</span></span><span leaf="">,rownames(res_cibersort)])</span><span leaf=""><br></span><span leaf="">res_cibersort$GZMB &lt;- as.numeric(exp_TPM[</span><span><span leaf="">"GZMB"</span></span><span leaf="">,rownames(res_cibersort)])</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(psych)</span><span leaf=""><br></span><span leaf="">cor_matrix &lt;- corr.test(res_cibersort, method = </span><span><span leaf="">"spearman"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">Rvalue &lt;- cor_matrix$r </span><span><span leaf="">#提取相关性系数</span></span><span leaf=""><br></span><span leaf="">Pvalue &lt;- cor_matrix$p </span><span><span leaf="">#提取相关性系数的p值</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">Rvalue[</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">4</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">4</span></span><span leaf="">]</span><span leaf=""><br></span><span><span leaf="">#               B.cells.naive B.cells.memory Plasma.cells T.cells.CD8</span></span><span leaf=""><br></span><span><span leaf="">#B.cells.naive     1.00000000   -0.238315544  0.229495428 -0.01467395</span></span><span leaf=""><br></span><span><span leaf="">#B.cells.memory   -0.23831554    1.000000000  0.003596668 -0.09922438</span></span><span leaf=""><br></span><span><span leaf="">#Plasma.cells      0.22949543    0.003596668  1.000000000  0.02304189</span></span><span leaf=""><br></span><span><span leaf="">#T.cells.CD8      -0.01467395   -0.099224380  0.023041892  1.00000000</span></span><span leaf=""><br></span><span leaf="">Pvalue[</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">4</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">4</span></span><span leaf="">]</span><span leaf=""><br></span><span><span leaf="">#               B.cells.naive B.cells.memory Plasma.cells T.cells.CD8</span></span><span leaf=""><br></span><span><span leaf="">#B.cells.naive   0.000000e+00   4.735852e-05 0.0001341864           1</span></span><span leaf=""><br></span><span><span leaf="">#B.cells.memory  1.989854e-07   0.000000e+00 1.0000000000           1</span></span><span leaf=""><br></span><span><span leaf="">#Plasma.cells    5.661874e-07   9.383455e-01 0.0000000000           1</span></span><span leaf=""><br></span><span><span leaf="">#T.cells.CD8     7.523120e-01   3.242085e-02 0.6201762422           0</span></span></code></pre><pre><code><span leaf="">datCD3D &lt;- data.frame(Rvalue =  as.numeric(Rvalue[</span><span><span leaf="">"CD3D"</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">22</span></span><span leaf="">]),</span><span leaf=""><br></span><span leaf="">                      Pvalue =  as.numeric(Pvalue[</span><span><span leaf="">"CD3D"</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">22</span></span><span leaf="">]),</span><span leaf=""><br></span><span leaf="">                      Celltype = colnames(Pvalue)[</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">22</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">datCD3D &lt;- datCD3D[order(datCD3D$Rvalue),]</span><span leaf=""><br></span><span leaf="">datCD3D$Celltype &lt;- gsub(</span><span><span leaf="">".Tregs."</span></span><span leaf="">,</span><span><span leaf="">"(Tregs)"</span></span><span leaf="">,datCD3D$Celltype)</span><span leaf=""><br></span><span leaf="">datCD3D$Celltype &lt;- gsub(</span><span><span leaf="">"[.]"</span></span><span leaf="">,</span><span><span leaf="">" "</span></span><span leaf="">,datCD3D$Celltype)</span><span leaf=""><br></span><span leaf="">datCD3D$Celltype &lt;- factor(datCD3D$Celltype,levels = datCD3D$Celltype)</span><span leaf=""><br></span></code></pre><p><span leaf="">代码套用就可以了：</span></p><pre><code><span><span leaf="">library</span></span><span leaf="">(ggplot2)</span><span leaf=""><br></span><span leaf="">mytheme &lt;- theme(axis.text.x = element_text(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">,size = </span><span><span leaf="">20</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                 axis.ticks.y = element_blank(), </span><span><span leaf="">## 删去y轴刻度线</span></span><span leaf=""><br></span><span leaf="">                 axis.text.y = element_text(size = </span><span><span leaf="">20</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                 axis.title.x = element_text(size = </span><span><span leaf="">20</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                 axis.title.y = element_text(size = </span><span><span leaf="">20</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                 axis.line = element_line(size = </span><span><span leaf="">1</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                 plot.margin = unit(c(</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">), </span><span><span leaf="">"cm"</span></span><span leaf="">),</span><span><span leaf="">#画布边缘距离上(top)、右(right)、下(bottom)、左(left) </span></span><span leaf=""><br></span><span leaf="">                 plot.title = element_text(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">,size =  </span><span><span leaf="">22</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                 legend.title = element_text(size = </span><span><span leaf="">20</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                 legend.text = element_text(size = </span><span><span leaf="">20</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                 legend.position = </span><span><span leaf="">"right"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                 legend.background = element_rect(fill = </span><span><span leaf="">'transparent'</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                 axis.line.y = element_blank(),</span><span><span leaf="">##删除纵坐标轴</span></span><span leaf=""><br></span><span leaf="">                 panel.grid.major = element_blank(),</span><span><span leaf="">##删除网格线</span></span><span leaf=""><br></span><span leaf="">                 panel.grid.minor = element_blank(),</span><span leaf=""><br></span><span leaf="">                 panel.border = element_blank())</span><span leaf=""><br></span></code></pre><p><span leaf="" data-pm-slice="0 0 []">基础条形图</span></p><p><span leaf="">首先是基础条形图，将正/负相关分别填充不同的颜色：</span></p><pre><code><span leaf="">datCD3D$Group &lt;- ifelse(datCD3D$Rvalue &lt; </span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">"Negative"</span></span><span leaf="">,</span><span><span leaf="">"Positive"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">datCD3D$Group[datCD3D$Pvalue &gt; </span><span><span leaf="">0.05</span></span><span leaf="">] &lt;- </span><span><span leaf="">"Non-Sig"</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(ggplot2)</span><span leaf=""><br></span><span leaf="">p1 &lt;- ggplot(datCD3D, aes(x = Celltype, y = Rvalue, fill = Group)) + </span><span leaf=""><br></span><span leaf="">      geom_bar(stat = </span><span><span leaf="">"identity"</span></span><span leaf="">) + </span><span leaf=""><br></span><span leaf="">      coord_flip() +</span><span leaf=""><br></span><span leaf="">      scale_y_continuous(expand = c(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                         limits = c(-</span><span><span leaf="">0.45</span></span><span leaf="">,</span><span><span leaf="">0.45</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                         breaks = seq(-</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.1</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                         labels = seq(-</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.1</span></span><span leaf="">)) +</span><span leaf=""><br></span><span leaf="">     coord_flip() + </span><span leaf=""><br></span><span leaf="">     scale_fill_manual(values = c(</span><span><span leaf="">"Negative"</span></span><span leaf=""> = </span><span><span leaf="">"#4d97cd"</span></span><span leaf="">, </span><span><span leaf="">"Positive"</span></span><span leaf=""> = </span><span><span leaf="">"#c74546"</span></span><span leaf="">, </span><span><span leaf="">"Non-Sig"</span></span><span leaf=""> = </span><span><span leaf="">"#bdc3d2"</span></span><span leaf="">)) + </span><span leaf=""><br></span><span leaf="">     labs(x = </span><span><span leaf="">NULL</span></span><span leaf="">, y = </span><span><span leaf="">"Coefficient (R value)"</span></span><span leaf="">, title = </span><span><span leaf="">"CD3D"</span></span><span leaf="">, fill = </span><span><span leaf="">NULL</span></span><span leaf="">) +  </span><span leaf=""><br></span><span leaf="">     theme_bw() + mytheme</span><span leaf=""><br></span></code></pre><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglWdv2nyWNB0xItsHolzDV9HfyNO35bHNt0HUE5wYF4oyJ3bAdjNJOLQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5333333333333333" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100007087" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglWdv2nyWNB0xItsHolzDV9HfyNO35bHNt0HUE5wYF4oyJ3bAdjNJOLQ/640?wx_fmt=png&amp;from=appmsg"></section><p><span leaf="">将坐标轴显示的通路信息、图例添加到空白处，节省空间使之更紧凑：</span></p><pre><code><span><span leaf=""># 依次从下到上添加标签</span></span><span leaf=""><br></span><span leaf="">Upcelltype &lt;- length(which(datCD3D$Rvalue &gt; </span><span><span leaf="">0</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">Downcelltype &lt;- length(which(datCD3D$Rvalue &lt; </span><span><span leaf="">0</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">p2 &lt;- p1 + </span><span leaf=""><br></span><span leaf="">     geom_text(data = datCD3D[</span><span><span leaf="">1</span></span><span leaf="">:Downcelltype,],</span><span leaf=""><br></span><span leaf="">               aes(x = Celltype,y = </span><span><span leaf="">0.01</span></span><span leaf="">,label = Celltype),</span><span leaf=""><br></span><span leaf="">               hjust = </span><span><span leaf="">0</span></span><span leaf="">,color = </span><span><span leaf="">'black'</span></span><span leaf="">,size = </span><span><span leaf="">6</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     geom_text(data = datCD3D[(Upcelltype):nrow(datCD3D),],</span><span leaf=""><br></span><span leaf="">               aes(x = Celltype,y = -</span><span><span leaf="">0.01</span></span><span leaf="">,label = Celltype),</span><span leaf=""><br></span><span leaf="">               hjust = </span><span><span leaf="">1</span></span><span leaf="">,color = </span><span><span leaf="">'black'</span></span><span leaf="">,size = </span><span><span leaf="">6</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     </span><span><span leaf="">##删除Y轴</span></span><span leaf=""><br></span><span leaf="">     scale_x_discrete(labels = </span><span><span leaf="">NULL</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     </span><span><span leaf="">##手动标注Up/Down</span></span><span leaf=""><br></span><span leaf="">     geom_text(x = </span><span><span leaf="">22</span></span><span leaf="">*</span><span><span leaf="">0.25</span></span><span leaf="">, y = -</span><span><span leaf="">0.3</span></span><span leaf="">, label = </span><span><span leaf="">"Negative"</span></span><span leaf="">, size = </span><span><span leaf="">10</span></span><span leaf="">, color = </span><span><span leaf="">'#4d97cd'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     geom_text(x = </span><span><span leaf="">22</span></span><span leaf="">*</span><span><span leaf="">0.75</span></span><span leaf="">, y = </span><span><span leaf="">0.3</span></span><span leaf="">, label = </span><span><span leaf="">"Positive"</span></span><span leaf="">, size = </span><span><span leaf="">10</span></span><span leaf="">, color = </span><span><span leaf="">'#c74546'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     theme(legend.position = </span><span><span leaf="">"none"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><section nodeleaf=""><span></span></section><section nodeleaf=""><span></span></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglkU1AMqkOdO2PxBVNBvbE8b5THXX5fDyhj7mPeTHiaTGz4RKy4dAeblA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5333333333333333" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100007102" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglkU1AMqkOdO2PxBVNBvbE8b5THXX5fDyhj7mPeTHiaTGz4RKy4dAeblA/640?wx_fmt=png&amp;from=appmsg"></section><p><span leaf="">也可以进一步将显著性细分为</span><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"data-pm-slice":"0 0 []","style":"-webkit-tap-highlight-color: transparent;margin: 0px;padding: 0px;outline: 0px;max-width: 100%;color: rgba(0, 0, 0, 0.9);font-family: \"PingFang SC\", system-ui, -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"Hiragino Sans GB\", \"Microsoft YaHei UI\", \"Microsoft YaHei\", Arial, sans-serif;font-size: 17px;font-style: normal;font-variant-ligatures: normal;font-variant-caps: normal;font-weight: 400;letter-spacing: 0.544px;orphans: 2;text-align: justify;text-indent: 2em;text-transform: none;widows: 2;word-spacing: 0px;-webkit-text-stroke-width: 0px;white-space: normal;background-color: rgb(255, 255, 255);text-decoration-thickness: initial;text-decoration-style: initial;text-decoration-color: initial;visibility: visible;box-sizing: border-box !important;overflow-wrap: break-word !important;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{"style":"-webkit-tap-highlight-color: transparent; margin-bottom: 0px; outline: 0px; font-family: \"PingFang SC\", system-ui, -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"Hiragino Sans GB\", \"Microsoft YaHei UI\", \"Microsoft YaHei\", Arial, sans-serif; letter-spacing: 0.544px; background-color: rgb(255, 255, 255); text-indent: 2em; text-align: justify; margin-top: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><span textstyle="">p</span> &lt; 0.01</span><span leaf="">、</span><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"data-pm-slice":"0 0 []","style":"-webkit-tap-highlight-color: transparent;margin: 0px;padding: 0px;outline: 0px;max-width: 100%;color: rgba(0, 0, 0, 0.9);font-family: \"PingFang SC\", system-ui, -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"Hiragino Sans GB\", \"Microsoft YaHei UI\", \"Microsoft YaHei\", Arial, sans-serif;font-size: 17px;font-style: normal;font-variant-ligatures: normal;font-variant-caps: normal;font-weight: 400;letter-spacing: 0.544px;orphans: 2;text-align: justify;text-indent: 2em;text-transform: none;widows: 2;word-spacing: 0px;-webkit-text-stroke-width: 0px;white-space: normal;background-color: rgb(255, 255, 255);text-decoration-thickness: initial;text-decoration-style: initial;text-decoration-color: initial;visibility: visible;box-sizing: border-box !important;overflow-wrap: break-word !important;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{"style":"-webkit-tap-highlight-color: transparent; margin-bottom: 0px; outline: 0px; font-family: \"PingFang SC\", system-ui, -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"Hiragino Sans GB\", \"Microsoft YaHei UI\", \"Microsoft YaHei\", Arial, sans-serif; letter-spacing: 0.544px; background-color: rgb(255, 255, 255); text-indent: 2em; text-align: justify; margin-top: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><span textstyle="">p</span> &lt; 0.05</span><span leaf="">、</span><span leaf="">Non-Sig：</span></p><pre><code><span leaf="">datCD3D$Group2 &lt;- datCD3D$Group</span><span leaf=""><br></span><span leaf="">datCD3D$Group2[datCD3D$Group == </span><span><span leaf="">"Negative"</span></span><span leaf=""> &amp; datCD3D$Pvalue &lt; </span><span><span leaf="">0.01</span></span><span leaf="">] &lt;- </span><span><span leaf="">"Negative2"</span></span><span leaf=""><br></span><span leaf="">datCD3D$Group2[datCD3D$Group == </span><span><span leaf="">"Positive"</span></span><span leaf=""> &amp; datCD3D$Pvalue &lt; </span><span><span leaf="">0.01</span></span><span leaf="">] &lt;- </span><span><span leaf="">"Positive2"</span></span><span leaf=""><br></span><span leaf="">p3 &lt;- ggplot(datCD3D, aes(x = Celltype, y = Rvalue, fill = Group2)) + </span><span leaf=""><br></span><span leaf="">      geom_bar(stat = </span><span><span leaf="">"identity"</span></span><span leaf="">) + </span><span leaf=""><br></span><span leaf="">      coord_flip() +</span><span leaf=""><br></span><span leaf="">      scale_y_continuous(expand = c(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                         limits = c(-</span><span><span leaf="">0.45</span></span><span leaf="">,</span><span><span leaf="">0.45</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                         breaks = seq(-</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.1</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                         labels = seq(-</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.1</span></span><span leaf="">)) +</span><span leaf=""><br></span><span leaf="">     coord_flip() + </span><span leaf=""><br></span><span leaf="">     scale_fill_manual(values = c(</span><span><span leaf="">"Negative"</span></span><span leaf=""> = alpha(</span><span><span leaf="">"#4d97cd"</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">), </span><span><span leaf="">"Negative2"</span></span><span leaf=""> = </span><span><span leaf="">"#4d97cd"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                                  </span><span><span leaf="">"Positive"</span></span><span leaf=""> =alpha(</span><span><span leaf="">"#c74546"</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">), </span><span><span leaf="">"Positive2"</span></span><span leaf=""> = </span><span><span leaf="">"#c74546"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                                  </span><span><span leaf="">"Non-Sig"</span></span><span leaf=""> = </span><span><span leaf="">"#bdc3d2"</span></span><span leaf="">)) + </span><span leaf=""><br></span><span leaf="">     labs(x = </span><span><span leaf="">NULL</span></span><span leaf="">, y = </span><span><span leaf="">"Coefficient (R value)"</span></span><span leaf="">, title = </span><span><span leaf="">"CD3D"</span></span><span leaf="">, fill = </span><span><span leaf="">NULL</span></span><span leaf="">) +  </span><span leaf=""><br></span><span leaf="">     geom_text(data = datCD3D[</span><span><span leaf="">1</span></span><span leaf="">:Downcelltype,],</span><span leaf=""><br></span><span leaf="">               aes(x = Celltype,y = </span><span><span leaf="">0.01</span></span><span leaf="">,label = Celltype),</span><span leaf=""><br></span><span leaf="">               hjust = </span><span><span leaf="">0</span></span><span leaf="">,color = </span><span><span leaf="">'black'</span></span><span leaf="">,size = </span><span><span leaf="">6</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     geom_text(data = datCD3D[(Upcelltype-</span><span><span leaf="">1</span></span><span leaf="">):nrow(datCD3D),],</span><span leaf=""><br></span><span leaf="">               aes(x = Celltype,y = -</span><span><span leaf="">0.01</span></span><span leaf="">,label = Celltype),</span><span leaf=""><br></span><span leaf="">               hjust = </span><span><span leaf="">1</span></span><span leaf="">,color = </span><span><span leaf="">'black'</span></span><span leaf="">,size = </span><span><span leaf="">6</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     </span><span><span leaf="">##删除Y轴</span></span><span leaf=""><br></span><span leaf="">     scale_x_discrete(labels = </span><span><span leaf="">NULL</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     </span><span><span leaf="">##手动标注Up/Down</span></span><span leaf=""><br></span><span leaf="">     geom_text(x = </span><span><span leaf="">22</span></span><span leaf="">*</span><span><span leaf="">0.25</span></span><span leaf="">, y = -</span><span><span leaf="">0.3</span></span><span leaf="">, label = </span><span><span leaf="">"Negative"</span></span><span leaf="">, size = </span><span><span leaf="">10</span></span><span leaf="">, color = </span><span><span leaf="">'#4d97cd'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     geom_text(x = </span><span><span leaf="">22</span></span><span leaf="">*</span><span><span leaf="">0.75</span></span><span leaf="">, y = </span><span><span leaf="">0.3</span></span><span leaf="">, label = </span><span><span leaf="">"Positive"</span></span><span leaf="">, size = </span><span><span leaf="">10</span></span><span leaf="">, color = </span><span><span leaf="">'#c74546'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">     theme_bw() + mytheme + theme(legend.position = </span><span><span leaf="">"none"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglqSWC3uTkiclUuj8bfUmN9zthKVt0RXkBibiav9v3gQIBBR5qKjBiab4l4w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6666666666666666" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100007089" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglqSWC3uTkiclUuj8bfUmN9zthKVt0RXkBibiav9v3gQIBBR5qKjBiab4l4w/640?wx_fmt=png&amp;from=appmsg"></section><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"data-pm-slice":"0 0 []","style":"-webkit-tap-highlight-color: transparent;margin: 0px;padding: 0px;outline: 0px;max-width: 100%;color: rgba(0, 0, 0, 0.9);font-family: \"PingFang SC\", system-ui, -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"Hiragino Sans GB\", \"Microsoft YaHei UI\", \"Microsoft YaHei\", Arial, sans-serif;font-size: 17px;font-style: normal;font-variant-ligatures: normal;font-variant-caps: normal;font-weight: 400;letter-spacing: 0.544px;orphans: 2;text-align: justify;text-indent: 2em;text-transform: none;widows: 2;word-spacing: 0px;-webkit-text-stroke-width: 0px;white-space: normal;background-color: rgb(255, 255, 255);text-decoration-thickness: initial;text-decoration-style: initial;text-decoration-color: initial;visibility: visible;box-sizing: border-box !important;overflow-wrap: break-word !important;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"style":"text-indent: 2em;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{"style":"-webkit-tap-highlight-color: transparent; margin-bottom: 0px; outline: 0px; font-family: \"PingFang SC\", system-ui, -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"Hiragino Sans GB\", \"Microsoft YaHei UI\", \"Microsoft YaHei\", Arial, sans-serif; letter-spacing: 0.544px; background-color: rgb(255, 255, 255); text-indent: 0px; text-align: justify; margin-top: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'>显著性着色</span><p><span leaf="">有时候也会看到使用显著性</span><span leaf=""><span textstyle="">p</span></span><span leaf="">值赋色（给柱子加个黑色边框防止颜色过浅不清楚）：</span></p><pre><code><span leaf="">p4 &lt;- ggplot(datCD3D, aes(x = Celltype, y = Rvalue)) + </span><span leaf=""><br></span><span leaf="">      geom_bar(stat = </span><span><span leaf="">"identity"</span></span><span leaf="">,aes(fill = -log10(datCD3D$Pvalue)),color = </span><span><span leaf="">"black"</span></span><span leaf="">) + </span><span leaf=""><br></span><span leaf="">      coord_flip() +</span><span leaf=""><br></span><span leaf="">      scale_y_continuous(expand = c(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                         limits = c(-</span><span><span leaf="">0.45</span></span><span leaf="">,</span><span><span leaf="">0.45</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                         breaks = seq(-</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.1</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                         labels = seq(-</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.1</span></span><span leaf="">)) +</span><span leaf=""><br></span><span leaf="">      coord_flip() + </span><span leaf=""><br></span><span leaf="">      scale_fill_gradient(low = </span><span><span leaf="">"#498EA4"</span></span><span leaf="">, high = </span><span><span leaf="">"#E54924"</span></span><span leaf="">, </span><span leaf=""><br></span><span leaf="">                    name = bquote(</span><span><span leaf="">"-"</span></span><span leaf="">~Log[</span><span><span leaf="">10</span></span><span leaf="">]~</span><span><span leaf="">" Pvalue"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                    limits = c(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">24</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                    breaks = seq(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">20</span></span><span leaf="">,</span><span><span leaf="">5</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                    labels = seq(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">20</span></span><span leaf="">,</span><span><span leaf="">5</span></span><span leaf="">))  +  </span><span leaf=""><br></span><span leaf="">      labs(x = </span><span><span leaf="">NULL</span></span><span leaf="">, y = </span><span><span leaf="">"Coefficient (R value)"</span></span><span leaf="">, title = </span><span><span leaf="">"CD3D"</span></span><span leaf="">, fill = </span><span><span leaf="">NULL</span></span><span leaf="">) +  </span><span leaf=""><br></span><span leaf="">      geom_text(data = datCD3D[</span><span><span leaf="">1</span></span><span leaf="">:Downcelltype,],</span><span leaf=""><br></span><span leaf="">                aes(x = Celltype,y = </span><span><span leaf="">0.01</span></span><span leaf="">,label = Celltype),</span><span leaf=""><br></span><span leaf="">                hjust = </span><span><span leaf="">0</span></span><span leaf="">,color = </span><span><span leaf="">'black'</span></span><span leaf="">,size = </span><span><span leaf="">6</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      geom_text(data = datCD3D[(Upcelltype-</span><span><span leaf="">1</span></span><span leaf="">):nrow(datCD3D),],</span><span leaf=""><br></span><span leaf="">                aes(x = Celltype,y = -</span><span><span leaf="">0.01</span></span><span leaf="">,label = Celltype),</span><span leaf=""><br></span><span leaf="">                hjust = </span><span><span leaf="">1</span></span><span leaf="">,color = </span><span><span leaf="">'black'</span></span><span leaf="">,size = </span><span><span leaf="">6</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      </span><span><span leaf="">##手动标注Up/Down</span></span><span leaf=""><br></span><span leaf="">      geom_text(x = </span><span><span leaf="">22</span></span><span leaf="">*</span><span><span leaf="">0.25</span></span><span leaf="">, y = -</span><span><span leaf="">0.3</span></span><span leaf="">, label = </span><span><span leaf="">"Negative"</span></span><span leaf="">, size = </span><span><span leaf="">10</span></span><span leaf="">, color = </span><span><span leaf="">'#4d97cd'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      geom_text(x = </span><span><span leaf="">22</span></span><span leaf="">*</span><span><span leaf="">0.75</span></span><span leaf="">, y = </span><span><span leaf="">0.3</span></span><span leaf="">, label = </span><span><span leaf="">"Positive"</span></span><span leaf="">, size = </span><span><span leaf="">10</span></span><span leaf="">, color = </span><span><span leaf="">'#c74546'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      </span><span><span leaf="">##删除Y轴</span></span><span leaf=""><br></span><span leaf="">      scale_x_discrete(labels = </span><span><span leaf="">NULL</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      theme_bw() + mytheme</span><span leaf=""><br></span></code></pre><p><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglG0es0esjByaGeicARop7Busaon0evR5eKLYbibcD6wGVAslcTSfM2etA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5333333333333333" data-s="300,640" data-type="png" data-w="7200" type="block" data-imgfileid="100007090" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglG0es0esjByaGeicARop7Busaon0evR5eKLYbibcD6wGVAslcTSfM2etA/640?wx_fmt=png&amp;from=appmsg"></span></p><p><span leaf="">直接赋值很不好看，我们转换一下正负分别展开：</span></p><pre><code><span leaf="">datCD3D$log10Pvalue &lt;- -log10(datCD3D$Pvalue)</span><span leaf=""><br></span><span leaf="">datCD3D$log10Pvalue[datCD3D$Rvalue &lt; </span><span><span leaf="">0</span></span><span leaf="">] &lt;- -</span><span><span leaf="">1</span></span><span leaf="">*datCD3D$log10Pvalue[datCD3D$Rvalue &lt; </span><span><span leaf="">0</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">range(datCD3D$log10Pvalue)</span><span><span leaf="">#[1] -10.35827  22.83838</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">p5 &lt;- ggplot(datCD3D, aes(x = Celltype, y = Rvalue)) + </span><span leaf=""><br></span><span leaf="">      geom_bar(stat = </span><span><span leaf="">"identity"</span></span><span leaf="">,aes(fill = log10Pvalue),color = </span><span><span leaf="">"black"</span></span><span leaf="">) + </span><span leaf=""><br></span><span leaf="">      coord_flip() +</span><span leaf=""><br></span><span leaf="">      scale_y_continuous(expand = c(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                         limits = c(-</span><span><span leaf="">0.45</span></span><span leaf="">,</span><span><span leaf="">0.45</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                         breaks = seq(-</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.1</span></span><span leaf="">), </span><span leaf=""><br></span><span leaf="">                         labels = seq(-</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.4</span></span><span leaf="">,</span><span><span leaf="">0.1</span></span><span leaf="">)) +</span><span leaf=""><br></span><span leaf="">      coord_flip() + </span><span leaf=""><br></span><span leaf="">      scale_fill_gradient2(low = </span><span><span leaf="">"#0074b3"</span></span><span leaf="">, mid = </span><span><span leaf="">"white"</span></span><span leaf="">, high = </span><span><span leaf="">"#982b2b"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                     name = bquote(</span><span><span leaf="">"-"</span></span><span leaf="">~Log[</span><span><span leaf="">10</span></span><span leaf="">]~</span><span><span leaf="">" Pvalue"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                           midpoint = </span><span><span leaf="">0</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                     limits = c(-</span><span><span leaf="">11</span></span><span leaf="">,</span><span><span leaf="">23</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                     breaks = seq(-</span><span><span leaf="">10</span></span><span leaf="">,</span><span><span leaf="">20</span></span><span leaf="">,</span><span><span leaf="">5</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                     labels = c(</span><span><span leaf="">10</span></span><span leaf="">,</span><span><span leaf="">5</span></span><span leaf="">,</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">5</span></span><span leaf="">,</span><span><span leaf="">10</span></span><span leaf="">,</span><span><span leaf="">15</span></span><span leaf="">,</span><span><span leaf="">20</span></span><span leaf="">))  +  </span><span leaf=""><br></span><span leaf="">      labs(x = </span><span><span leaf="">NULL</span></span><span leaf="">, y = </span><span><span leaf="">"Coefficient (R value)"</span></span><span leaf="">, title = </span><span><span leaf="">"CD3D"</span></span><span leaf="">, fill = </span><span><span leaf="">NULL</span></span><span leaf="">) +  </span><span leaf=""><br></span><span leaf="">      geom_text(data = datCD3D[</span><span><span leaf="">1</span></span><span leaf="">:Downcelltype,],</span><span leaf=""><br></span><span leaf="">                aes(x = Celltype,y = </span><span><span leaf="">0.01</span></span><span leaf="">,label = Celltype),</span><span leaf=""><br></span><span leaf="">                hjust = </span><span><span leaf="">0</span></span><span leaf="">,color = </span><span><span leaf="">'black'</span></span><span leaf="">,size = </span><span><span leaf="">6</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      geom_text(data = datCD3D[(Upcelltype-</span><span><span leaf="">1</span></span><span leaf="">):nrow(datCD3D),],</span><span leaf=""><br></span><span leaf="">                aes(x = Celltype,y = -</span><span><span leaf="">0.01</span></span><span leaf="">,label = Celltype),</span><span leaf=""><br></span><span leaf="">                hjust = </span><span><span leaf="">1</span></span><span leaf="">,color = </span><span><span leaf="">'black'</span></span><span leaf="">,size = </span><span><span leaf="">6</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      </span><span><span leaf="">##手动标注Up/Down</span></span><span leaf=""><br></span><span leaf="">      geom_text(x = </span><span><span leaf="">22</span></span><span leaf="">*</span><span><span leaf="">0.25</span></span><span leaf="">, y = -</span><span><span leaf="">0.3</span></span><span leaf="">, label = </span><span><span leaf="">"Negative"</span></span><span leaf="">, size = </span><span><span leaf="">10</span></span><span leaf="">, color = </span><span><span leaf="">'#0074b3'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      geom_text(x = </span><span><span leaf="">22</span></span><span leaf="">*</span><span><span leaf="">0.75</span></span><span leaf="">, y = </span><span><span leaf="">0.3</span></span><span leaf="">, label = </span><span><span leaf="">"Positive"</span></span><span leaf="">, size = </span><span><span leaf="">10</span></span><span leaf="">, color = </span><span><span leaf="">'#982b2b'</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      </span><span><span leaf="">##删除Y轴</span></span><span leaf=""><br></span><span leaf="">      scale_x_discrete(labels = </span><span><span leaf="">NULL</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">      theme_bw() + mytheme +</span><span leaf=""><br></span><span leaf="">      guides(fill = guide_colorbar(title.position = </span><span><span leaf="">"top"</span></span><span leaf="">,title.hjust = </span><span><span leaf="">0.5</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                                   barwidth = </span><span><span leaf="">1.5</span></span><span leaf="">,barheight = </span><span><span leaf="">10</span></span><span leaf="">,ticks = </span><span><span leaf="">TRUE</span></span><span leaf="">))</span><span leaf=""><br></span></code></pre><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglECm7ut2yPP9ETaj2htXVg7zFcBuMDeNDcqsGU8ftuF34bCdiagibRklQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5333333333333333" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100007092" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LBia2lLr0bwRD8wrVEjQZglECm7ut2yPP9ETaj2htXVg7zFcBuMDeNDcqsGU8ftuF34bCdiagibRklQ/640?wx_fmt=png&amp;from=appmsg"></section><h3><span><span leaf="">棒棒糖图/火柴杆图</span></span></h3><p><span leaf="">这个图叫什么的都有<img data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/assets/newemoji/2_05.png" data-ratio="1" data-w="20" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/assets/newemoji/2_05.png">。这里使用</span><span leaf=""><span textstyle="">geom_segment</span></span><span leaf="">替换</span><span leaf=""><span textstyle="">geom_bar</span></span><span leaf="">就好了，使用点的大小展示显著性。</span></p><p><mp-pay-preview-filter data-offset="31"></mp-pay-preview-filter></p></section></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/KG3BEgCqTYr7_PnDiP48vw",target="_blank" rel="noopener noreferrer">原文链接</a>
