---
title: "单细胞专题 | infercnv拷贝数变异热图大改造——在底部展示指定变异基因"
date: 2025-04-07T03:16:42Z
draft: ["false"]
tags: [
  "fetched",
  "生信大爆炸"
]
categories: ["Acdemic"]
---
单细胞专题 | infercnv拷贝数变异热图大改造——在底部展示指定变异基因 by 生信大爆炸
------
<div><section data-mpa-powered-by="yiban.io"><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><p><strong>前言</strong></p></section></section></section><section powered-by="xiumi.us"><section><svg viewbox="0 0 1 1"></svg></section></section><section powered-by="xiumi.us"><section><p>我们之前将来自肿瘤组织的肝细胞定义为“恶性细胞”，但实际上肿瘤组织中也会存在少量“正常”细胞，我们怎样区分它们呢？今天为大家介绍一个<span>用于推断肿瘤细胞拷贝数变异的R包——inferCNV，以及结果图的美化，赶快学起来吧！</span></p></section></section><section powered-by="xiumi.us"><section><svg viewbox="0 0 1 1"></svg></section></section></section></section><section powered-by="xiumi.us"><p><br></p></section><section powered-by="xiumi.us"><section><section powered-by="xiumi.us"><section><p><span><em><strong>01 </strong></em></span><span><em><strong>改造后热图预览</strong></em></span><em></em></p><p><span>inferCNV直接输出的热图在文献中是很常见的，但看多了不免有些审美疲劳，今天带大家利用inferCNV的结果文件对热图做一个大改造，提高文章印象分，俘获审稿人的心。                                                                        我们目标图长这样，</span><span>接下来跟我一步步实</span><span>现吧：</span></p><p><br></p><p><img data-cropselx1="0" data-cropselx2="564" data-cropsely1="0" data-cropsely2="374" data-galleryid="" data-imgfileid="100000736" data-ratio="0.6666666666666666" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/mxVa7uzDPV9z5dsO7l6LO98sz0lzEEBRsicnzE2sicxLgeibVDR96HUfVQhZq64Gfziboo7uwgvyb8smjOhz6AIHWw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/mxVa7uzDPV9z5dsO7l6LO98sz0lzEEBRsicnzE2sicxLgeibVDR96HUfVQhZq64Gfziboo7uwgvyb8smjOhz6AIHWw/640?wx_fmt=png&amp;from=appmsg"></p></section></section></section></section></section></section></section></section><section powered-by="xiumi.us"><section><p><br></p><p><strong><em><span>02</span></em></strong>  <em><strong><span>inferCNV全流程</span></strong></em><br></p><p><br></p></section></section></section><p><span><em><strong>安装</strong></em></span><em><strong><span></span></strong></em></p><p><span>第一次安装inferCNV基本都要费一番功夫，会遇到各种报错，比较常见的一种是因为infercnv包的安装依赖于rjags包，而rjags包依赖于JAGS库文，网上有很多教程，但操作起来都比较麻烦，如果你用的是服务器上的R的话，可以在terminal中输入<strong>sudo apt install r-cran-rjags</strong>安装rjags：</span></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><span>#</span><span>##安装并加载infercnv</span></span></code><code><span><span>#</span><span>#在terminal中输入sudo apt install r-cran-rjags安装rjags</span></span></code><code><span>library(rjags)</span></code><code><span>devtools::install_github("broadinstitute/infercnv")</span></code><code><span>BiocManager::install("infercnv")</span></code><code><span>library(infercnv)</span></code></pre></section><p><br></p><p><span><em><strong>输入文件制作</strong></em></span></p><p>inferCNV需要三个输入文件：<span><strong>1.count表达矩阵，2.meta分组信息，3.基因染色体信息</strong></span></p><p><span><strong>seurat_merge_v5_anno.rds</strong></span>文件为<span><strong><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=Mzk0MzY1MDI4Mg==&amp;mid=2247484326&amp;idx=1&amp;sn=52960b7d40cde9bd4f06cb9bfeb82d82&amp;chksm=c331e723f4466e35de1f69eb945ead52b914babd51b72af2f01f66f35468a94cc1fb4388b173&amp;scene=21#wechat_redirect" textvalue="单细胞专题 | 对某一类细胞深入探索——细胞的提取与亚型细分" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞专题 | 对某一类细胞深入探索——细胞的提取与亚型细分</a></strong></span>这一讲中最后生成的seurat对象，大家可以换成自己注释好的单细胞数据。<span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span><span>#提取表达矩阵</span></span></code><code><span>setwd(<span>"."</span>)</span></code><code><span>seurat_merge_v5 &lt;- readRDS(<span>"./seurat_merge_v5_anno.rds"</span>)</span></code><code><span>Idents(seurat_merge_v5)&lt;-seurat_merge_v5$celltype</span></code><code><span>table(seurat_merge_v5$celltype)</span></code><code><span>for_infercnv &lt;-subset(seurat_merge_v5,idents = c(<span>"HPC"</span>,<span>"Endothelial"</span>,<span>"Malignant cell"</span>,<span>"Fibroblast"</span>)) <span>#填入想要推测的细胞群和正常对照细胞群</span></span></code><code><span>dat &lt;- for_infercnv[[<span>"RNA"</span>]]$counts</span></code><code><span>dat &lt;- as.data.frame(dat)</span></code><code><span><br></span></code><code><span><span>#制作基因所在染色体位置文件</span></span></code><code><span>library(AnnoProbe)    <span>#用于获取基因与其染色体位置的包</span></span></code><code><span>geneInfor=annoGene(rownames(dat),<span>"SYMBOL"</span>,<span>'human'</span>)    <span>#可能有部分基因丢失</span></span></code><code><span>colnames(geneInfor)</span></code><code><span>geneInfor=geneInfor[with(geneInfor, order(<span>chr</span>, start)),c(<span>1</span>,<span>4</span>:<span>6</span>)]      </span></code><code><span>geneInfor=geneInfor[!duplicated(geneInfor[,<span>1</span>]),]</span></code><code><span><span>length</span>(unique(geneInfor[,<span>1</span>]))</span></code><code><span>head(geneInfor)</span></code><code><span>dat=dat[match(geneInfor[,<span>1</span>], rownames(dat)),] <span>#将表达矩阵的基因排列顺序与geneInfor的基因排列顺序调整一致</span></span></code><code><span>rownames(geneInfor) &lt;- geneInfor$SYMBOL   </span></code><code><span>geneInfor &lt;- geneInfor[,-<span>1</span>]</span></code><code><span><br></span></code><code><span><span>#制作mate分组信息</span></span></code><code><span>meta &lt;- subset(for_infercnv@meta.data,<span>select</span> = c(<span>"celltype"</span>)) </span></code><code><span><br></span></code><code><span><span>#验证表达矩阵的列名是否与meta的行名一致</span></span></code><code><span>identical(colnames(dat),rownames(meta))  </span></code><code><span><span>#验证表达矩阵的行名是否与geneInfor的行名一致</span></span></code><code><span>identical(rownames(dat),rownames(geneInfor))</span></code></pre></section><p><span><br></span></p><p><span><em><strong>构建inferCNV对象</strong></em></span><em><strong><span></span></strong></em></p><section><ul><li><li><li><li><li></ul><pre data-lang="makefile"><code><span>infercnv_obj = CreateInfercnvObject(raw_counts_matrix=dat,</span></code><code><span>                                    annotations_file=meta,</span></code><code><span>                                    delim=<span>"\t"</span>,</span></code><code><span>                                    gene_order_file=geneInfor,</span></code><code><span>                                    ref_group_names=c(<span>"Endothelial"</span>,<span>"HPC"</span>,<span>"Fibroblast"</span>))   <span>#填入做为正常对照的细胞群</span></span></code></pre></section><p><br></p><p><span><em><strong>运行inferCNV</strong></em></span><em><strong><span></span></strong></em><span><br></span></p><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span>options(<span>"Seurat.object.assay.version"</span> = <span>"v3"</span>)</span></code><code><span>infercnv_obj = infercnv::run(infercnv_obj,</span></code><code><span>                             cutoff=0.1, <span># 如果是Smart-seq2数据就填1, 10X数据就填0.1</span></span></code><code><span>                             out_dir=<span>"infercnv/"</span>, <span>#输出文件路径，其中包含infercnv原始热图</span></span></code><code><span>                             cluster_by_groups=TRUE,  <span># 选择TRUE是按样本分组，FALSE会进行按k_obs_groups给出的分组数（默认为1）进行分组</span></span></code><code><span>                             <span>#k_obs_groups = 1,# cluster_by_groups参数指定为FALSE时使用</span></span></code><code><span>                             denoise= T,     <span>#是否去噪</span></span></code><code><span>                             num_threads = 12, <span>#线程数</span></span></code><code><span>                             write_expr_matrix = T, <span>#是否生成作图的结果矩阵</span></span></code><code><span>                             HMM=F)   <span># 是否基于HMM预测CNV,TRUE的话时间很久</span></span></code></pre></section><p><br></p><p><span><em><strong>原始热图</strong></em></span><em><strong><span></span></strong></em></p><p><img data-galleryid="" data-imgfileid="100000734" data-ratio="0.9472222222222222" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/mxVa7uzDPV9z5dsO7l6LO98sz0lzEEBRXibMNLL8Aa09nfklzfu0ZJRSG0TC80uoO7L6LgLf2KFQXlFMR3twc8A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/mxVa7uzDPV9z5dsO7l6LO98sz0lzEEBRXibMNLL8Aa09nfklzfu0ZJRSG0TC80uoO7L6LgLf2KFQXlFMR3twc8A/640?wx_fmt=png&amp;from=appmsg"></p><section><section powered-by="xiumi.us"><section><p><br></p><p><span><em><strong>03</strong></em></span><em><strong> </strong></em><span><em><strong>改造inferCNV热图</strong></em></span><br></p><p><span><em><strong><br></strong></em></span></p><p><br></p><p><span>用改造热图需要用到的是结果文件夹下面的</span><span><strong>run.final.infercnv_obj</strong></span><span>文件：</span></p><br></section></section><p><mp-pay-preview-filter data-offset="27"></mp-pay-preview-filter></p></section></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/MdeXjcbtH3ksTBixwFj1aQ",target="_blank" rel="noopener noreferrer">原文链接</a>
