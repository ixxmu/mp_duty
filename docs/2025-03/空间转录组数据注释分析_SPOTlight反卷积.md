---
title: "空间转录组数据注释分析：SPOTlight反卷积"
date: 2025-03-25T00:05:32Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
空间转录组数据注释分析：SPOTlight反卷积 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">空间分辨的基因表达谱对于理解组织结构和功能至关重要。然而，<span textstyle="">空间转录组学（Spatial Transcriptomics, ST）分析技术缺乏单细胞分辨率，并且需要结合</span></span><span leaf="" data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;id&quot;:&quot;nice&quot;,&quot;data-tool&quot;:&quot;mdnice编辑器&quot;,&quot;data-website&quot;:&quot;https://www.mdnice.com&quot;,&quot;style&quot;:&quot;margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 10px; padding-right: 10px; background-attachment: scroll; background-clip: border-box; background-color: rgba(0, 0, 0, 0); background-image: none; background-origin: padding-box; background-position-x: 0%; background-position-y: 0%; background-repeat: no-repeat; background-size: auto; width: auto; font-family: Optima, 'Microsoft YaHei', PingFangSC-regular, serif; font-size: 16px; color: rgb(0, 0, 0); line-height: 1.5em; word-spacing: 0em; letter-spacing: 0em; word-break: break-word; overflow-wrap: break-word; text-align: left;&quot;,&quot;data-pm-slice&quot;:&quot;0 0 []&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;},&quot;para&quot;,{&quot;tagName&quot;:&quot;p&quot;,&quot;attributes&quot;:{&quot;data-tool&quot;:&quot;mdnice编辑器&quot;,&quot;style&quot;:&quot;color: rgb(0, 0, 0); font-size: 16px; line-height: 1.8em; letter-spacing: 0em; text-align: justify; text-indent: 0em; margin-top: 0px; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; padding-top: 8px; padding-bottom: 8px; padding-left: 0px; padding-right: 0px;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span textstyle="">scRNA-seq 信息来解析空间索引数据集</span>。</span></p><p data-tool="mdnice编辑器"><span leaf="">利用这两种数据类型的优点，Holger Heyn 团队开发了 SPOTlight 这一计算工具，于<span textstyle="">2021年5月21号发表在NAR杂志</span>上，标题为《<span textstyle="">SPOTlight: seeded NMF regression to deconvolute spatial transcriptomics spots with single-cell transcriptomes</span>》。</span></p><p data-tool="mdnice编辑器"><span leaf="">它能够整合ST和scRNA-seq数据，以推断复杂组织中细胞类型和状态的位置。</span><strong><span leaf="">SPOTlight的核心是基于种子的非负矩阵分解（seeded Non-negative Matrix Factorization, NMF）回归，该方法通过使用细胞类型标记基因进行初始化，并利用非负最小二乘法（Non-negative Least Squares, NNLS）来进一步解析ST捕获位置（spot）的空间分布。</span></strong></p><blockquote><span></span><p><span leaf="">SPOTlight官网：https://github.com/MarcElosua/SPOTlight</span></p></blockquote><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4b9KDNxWX2mWwicZQBCKjhOqUsicVHibic9IM6xgK6QFibY2n0QibvfS7Riahsw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4823529411764706" data-type="png" data-w="1020" data-imgfileid="100056337" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4b9KDNxWX2mWwicZQBCKjhOqUsicVHibic9IM6xgK6QFibY2n0QibvfS7Riahsw/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">软件安装</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">我这里选择了github上面的最新版本：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 设置一下镜像</span></span><span leaf=""><br></span><span><span leaf="">## 使用西湖大学的 Bioconductor镜像</span></span><span leaf=""><br></span><span leaf="">options(BioC_mirror=</span><span><span leaf="">"https://mirrors.westlake.edu.cn/bioconductor"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">options(</span><span><span leaf="">"repos"</span></span><span leaf="">=c(CRAN=</span><span><span leaf="">"https://mirrors.westlake.edu.cn/CRAN/"</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#install.packages("devtools")</span></span><span leaf=""><br></span><span leaf="">library(devtools)</span><span leaf=""><br></span><span leaf="">install_github(</span><span><span leaf="">"https://github.com/MarcElosua/SPOTlight"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">本次分析参考教程：</span></p><blockquote><span></span><p><span leaf="">https://github.com/MarcElosua/SPOTlight/blob/main/vignettes/SPOTlight_kidney.Rmd</span></p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">输入数据</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">输入的数据有：</span></p><ul><li><section><strong><span leaf="">ST (sparse) matrix</span></strong><span leaf="">：空间表达矩阵，可以是raw count，标准化后的data，行为基因，列为spot</span></section></li><li><section><strong><span leaf="">Single cell (sparse) matrix</span></strong><span leaf="">：单细胞表达矩阵，可以是raw count，标准化后的data，行为基因，列为细胞</span></section></li><li><section><strong><span leaf="">Vector</span></strong><span leaf="">：单细胞的每个细胞注释标签向量，顺序对应单细胞矩阵的列</span></section></li><li><section><strong><span leaf="">其他格式</span></strong><span leaf="">：输入数据还可以为</span><code><span leaf="">SpatialExperiment</span></code><span leaf="">或</span><code><span leaf="">SingleCellExperiment</span></code><span leaf="">对象</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">本次使用数据，空转来自 10x 官网，为小鼠的肾脏：https://support.10xgenomics.com/spatial-gene-expression/datasets/1.1.0/V1_Mouse_Kidney</span></p><p data-tool="mdnice编辑器"><span leaf="">小鼠单细胞数据来自文章：https://www.nature.com/articles/s41586-020-2496-1，超过35w的细胞，我们这里只用其中的kidney。</span></p><p data-tool="mdnice编辑器"><span leaf="">这两个数据都可以从 </span><code><span leaf="">TENxVisiumData</span></code><span leaf=""> 包中得到：</span></p><p data-tool="mdnice编辑器"><span leaf="">为了减少由年龄和批次效应引入的潜在噪声，这里的单细胞数据会选择来自同一年龄阶段的细胞。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">rm(list=ls())</span><span leaf=""><br></span><span leaf="">library(ggplot2)</span><span leaf=""><br></span><span leaf="">library(SPOTlight)</span><span leaf=""><br></span><span leaf="">library(SingleCellExperiment)</span><span leaf=""><br></span><span leaf="">library(SpatialExperiment)</span><span leaf=""><br></span><span leaf="">library(scater)</span><span leaf=""><br></span><span leaf="">library(scran)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 数据准备</span></span><span leaf=""><br></span><span><span leaf=""># 空转数据</span></span><span leaf=""><br></span><span leaf="">library(TENxVisiumData)</span><span leaf=""><br></span><span leaf="">spe &lt;- MouseKidneyCoronal()</span><span leaf=""><br></span><span leaf="">spe</span><span leaf=""><br></span><span><span leaf=""># 将spe的行名转为基因名字</span></span><span leaf=""><br></span><span leaf="">head(rownames(spe))</span><span leaf=""><br></span><span leaf="">rownames(spe) &lt;- rowData(spe)</span><span><span leaf="">$symbol</span></span><span leaf=""><br></span><span><span leaf=""># 先保存一下，下次可以直接导入</span></span><span leaf=""><br></span><span leaf="">library(qs)</span><span leaf=""><br></span><span leaf="">qsave(spe, file=</span><span><span leaf="">"spe.qs"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 单细胞数据</span></span><span leaf=""><br></span><span leaf="">library(TabulaMurisSenisData)</span><span leaf=""><br></span><span leaf="">sce &lt;- TabulaMurisSenisDroplet(tissues = </span><span><span leaf="">"Kidney"</span></span><span leaf="">)</span><span><span leaf="">$Kidney</span></span><span leaf=""><br></span><span leaf="">sce</span><span leaf=""><br></span><span><span leaf=""># 先保存一下，下次可以直接导入</span></span><span leaf=""><br></span><span leaf="">qsave(sce, file=</span><span><span leaf="">"sce.qs"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">table(sce</span><span><span leaf="">$free_annotation</span></span><span leaf="">, sce</span><span><span leaf="">$age</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 选择同一个时间段的细胞：18m mice</span></span><span leaf=""><br></span><span leaf="">sce &lt;- sce[, sce</span><span><span leaf="">$age</span></span><span leaf=""> == </span><span><span leaf="">"18m"</span></span><span leaf="">]</span><span leaf=""><br></span><span><span leaf=""># Keep cells with clear cell type annotations</span></span><span leaf=""><br></span><span leaf="">sce &lt;- sce[, !sce</span><span><span leaf="">$free_annotation</span></span><span leaf=""> %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">"nan"</span></span><span leaf="">, </span><span><span leaf="">"CD45"</span></span><span leaf="">)]</span><span leaf=""><br></span><span leaf="">sce</span><span leaf=""><br></span></code></pre><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">数据预处理</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">如果数据集非常庞大，这里可以进行</span><code><span leaf="">downsampling</span></code><span leaf="">来进一步优化性能和计算资源，在文献中，软件测试了将每种细胞类型的细胞数量降采样到约100个，以及 将基因集限制为每种细胞类型的标记基因以及最多3000个高变基因，并不会影响模型的性能，详细描述见文献：</span></p><p data-tool="mdnice编辑器"><span leaf="">https://academic.oup.com/nar/article/49/9/e50/6129341</span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.特征基因选择</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">我们的目标是识别那些驱动生物学异质性的高变基因。通过将这些基因输入到模型中，我们可以提高生物学结构的分辨率，并减少技术噪声。这里选择了非线粒体与核糖体的3000个hvg：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># Feature selection</span></span><span leaf=""><br></span><span leaf="">sce &lt;- logNormCounts(sce)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># Variance modelling</span></span><span leaf=""><br></span><span><span leaf=""># 首先排除 ribosomal or mitochondrial 基因</span></span><span leaf=""><br></span><span leaf="">genes &lt;- !grepl(pattern = </span><span><span leaf="">"^Rp[l|s]|Mt"</span></span><span leaf="">, x = rownames(sce))</span><span leaf=""><br></span><span leaf="">table(genes)</span><span leaf=""><br></span><span leaf="">dec &lt;- modelGeneVar(sce, subset.row = genes)</span><span leaf=""><br></span><span leaf="">plot(dec</span><span><span leaf="">$mean</span></span><span leaf="">, dec</span><span><span leaf="">$total</span></span><span leaf="">, xlab = </span><span><span leaf="">"Mean log-expression"</span></span><span leaf="">, ylab = </span><span><span leaf="">"Variance"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">curve(metadata(dec)</span><span><span leaf="">$trend</span></span><span leaf="">(x), col = </span><span><span leaf="">"blue"</span></span><span leaf="">, add = TRUE)</span><span leaf=""><br></span><span><span leaf=""># Get the top 3000 genes.</span></span><span leaf=""><br></span><span leaf="">hvg &lt;- getTopHVGs(dec, n = 3000)</span><span leaf=""><br></span><span leaf="">hvg</span><span leaf=""><br></span><span leaf="">grep(</span><span><span leaf="">"CD3"</span></span><span leaf="">, hvg, ignore.case = T,value = T)</span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">2.获取每种细胞类型的标记基因</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">接下来，获取每种细胞类型的标记基因。你可以使用任何方法，只要它能够返回一个权重，以表明该基因对该细胞类型的重要性。例如，可以使用</span><code><span leaf="">avgLogFC</span></code><span leaf="">（平均对数倍数变化）、</span><code><span leaf="">AUC</span></code><span leaf="">（曲线下面积）、</span><code><span leaf="">pct.expressed</span></code><span leaf="">（表达百分比）、</span><code><span leaf="">p-value</span></code><span leaf="">等。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 2.细胞类型的特征基因</span></span><span leaf=""><br></span><span leaf="">colLabels(sce) &lt;- colData(sce)</span><span><span leaf="">$free_annotation</span></span><span leaf=""><br></span><span><span leaf=""># Compute marker genes</span></span><span leaf=""><br></span><span leaf="">mgs &lt;- scoreMarkers(sce, subset.row = genes)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">mgs_fil &lt;- lapply(names(mgs), </span><span><span leaf="">function</span></span><span leaf="">(i) {</span><span leaf=""><br></span><span leaf="">  x &lt;- mgs[[i]]</span><span leaf=""><br></span><span><span leaf=""># Filter and keep relevant marker genes, those with AUC &gt; 0.8</span></span><span leaf=""><br></span><span leaf="">  x &lt;- x[x</span><span><span leaf="">$mean</span></span><span leaf="">.AUC &gt; 0.8, ]</span><span leaf=""><br></span><span><span leaf=""># Sort the genes from highest to lowest weight</span></span><span leaf=""><br></span><span leaf="">  x &lt;- x[order(x</span><span><span leaf="">$mean</span></span><span leaf="">.AUC, decreasing = TRUE), ]</span><span leaf=""><br></span><span><span leaf=""># Add gene and cluster id to the dataframe</span></span><span leaf=""><br></span><span leaf="">  x</span><span><span leaf="">$gene</span></span><span leaf=""> &lt;- rownames(x)</span><span leaf=""><br></span><span leaf="">  x</span><span><span leaf="">$cluster</span></span><span leaf=""> &lt;- i</span><span leaf=""><br></span><span leaf="">  data.frame(x)</span><span leaf=""><br></span><span leaf="">})</span><span leaf=""><br></span><span leaf="">mgs_df &lt;- do.call(rbind, mgs_fil)</span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.Cell Downsampling</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">接下来，对每种细胞降采样到最多100个细胞。如果一种细胞类型的细胞数少于100个，则会使用所有细胞。</span></p><p data-tool="mdnice编辑器"><span leaf="">如果细胞身份在生物学上差异很大（例如B细胞、T细胞、巨噬细胞和上皮细胞），我们可以使用较少的细胞，因为它们的转录组特征会有很大差异。而在细胞身份转录组更相似的情况下，我们需要增加样本量（N），以便捕捉它们之间的生物学异质性。</span></p><blockquote><span></span><p><span leaf="">根据作者的经验，在这个步骤中，<span textstyle="">如果你有一个来自多次实验的联合数据集，最好从同一批次中选择每种细胞类型的细胞。</span>这将确保模型尽可能多地去除批次信号，从而真正学习到生物学信号。</span></p></blockquote><p data-tool="mdnice编辑器"><span leaf="">为了本教程的目的，并加快分析速度，这里将每种细胞降采样到20个细胞：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 3.Cell Downsampling</span></span><span leaf=""><br></span><span><span leaf=""># 生成一个每种细胞类型的list对象</span></span><span leaf=""><br></span><span leaf="">idx &lt;- split(seq(ncol(sce)), sce</span><span><span leaf="">$free_annotation</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 降采样到每种细胞20个细胞，真实数据中需要使用100个以上</span></span><span leaf=""><br></span><span leaf="">n_cells &lt;- 20</span><span leaf=""><br></span><span leaf="">cs_keep &lt;- lapply(idx, </span><span><span leaf="">function</span></span><span leaf="">(i) {</span><span leaf=""><br></span><span leaf="">  n &lt;- length(i)</span><span leaf=""><br></span><span leaf="">  </span><span><span leaf="">if</span></span><span leaf=""> (n &lt; n_cells)</span><span leaf=""><br></span><span leaf="">    n_cells &lt;- n</span><span leaf=""><br></span><span leaf="">  sample(i, n_cells)</span><span leaf=""><br></span><span leaf="">})</span><span leaf=""><br></span><span leaf="">sce &lt;- sce[, unlist(cs_keep)]</span><span leaf=""><br></span><span leaf="">sce</span><span leaf=""><br></span><span leaf="">table(sce</span><span><span leaf="">$free_annotation</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">反卷积Deconvolution</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">接下来运行 SPOTlight 对每个空间spot进行反卷积</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">## 反卷积</span></span><span leaf=""><br></span><span leaf="">res &lt;- SPOTlight(</span><span leaf=""><br></span><span leaf="">  x = sce,</span><span leaf=""><br></span><span leaf="">  y = spe,</span><span leaf=""><br></span><span leaf="">  groups = as.character(sce</span><span><span leaf="">$free_annotation</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">  mgs = mgs_df,</span><span leaf=""><br></span><span leaf="">  hvg = hvg,</span><span leaf=""><br></span><span leaf="">  weight_id = </span><span><span leaf="">"mean.AUC"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  group_id = </span><span><span leaf="">"cluster"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  gene_id = </span><span><span leaf="">"gene"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 提取反卷积矩阵：每一行为一个spot，每一列为一种细胞类型，值为细胞类型在spot中的相对百分比</span></span><span leaf=""><br></span><span><span leaf=""># 行和一定为1</span></span><span leaf=""><br></span><span leaf="">head(mat &lt;- res</span><span><span leaf="">$mat</span></span><span leaf="">)[, 1:3]</span><span leaf=""><br></span><span leaf="">dim(mat)</span><span leaf=""><br></span><span leaf="">gead(rowSums(mat))</span><span leaf=""><br></span><span><span leaf=""># 提取NMF模型</span></span><span leaf=""><br></span><span leaf="">mod &lt;- res</span><span><span leaf="">$NMF</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">得到的</span></span><code><span leaf=""><span textstyle="">mat</span></span></code><span leaf=""><span textstyle=""> 就是反卷积的结果了，每一行为一个spot，每一列为一种细胞类型，值为细胞类型在spot中的相对百分比，行和一定为1</span></span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">反卷积结果可视化：饼图</span></span><span></span></h2><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.Topic profiles</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">首先，评估每个 </span><code><span leaf="">Topic profiles</span></code><span leaf=""> 特征对每种细胞身份的特异性。理想情况下，每种细胞身份都会有一个独特的 </span><code><span leaf="">Topic profiles</span></code><span leaf=""> 与之关联，如下所示：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">## 可视化</span></span><span leaf=""><br></span><span leaf="">plotTopicProfiles(</span><span leaf=""><br></span><span leaf="">  x = mod,</span><span leaf=""><br></span><span leaf="">  y = sce</span><span><span leaf="">$free_annotation</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  facet = FALSE,</span><span leaf=""><br></span><span leaf="">  min_prop = 0.01,</span><span leaf=""><br></span><span leaf="">  ncol = 1) +</span><span leaf=""><br></span><span leaf="">  theme(aspect.ratio = 1)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">这里有两个细胞亚群有两个 </span><code><span leaf="">Topic profiles </span></code><span leaf="">：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bk3Q0Shr4HE4aNicsMe7QjIbvXO2pTJjOuUKvHDMGcvibDKtuBDIliazKQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8906832298136645" data-type="png" data-w="805" data-imgfileid="100056335" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bk3Q0Shr4HE4aNicsMe7QjIbvXO2pTJjOuUKvHDMGcvibDKtuBDIliazKQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">接下来，还需要确保来自同一细胞身份的所有细胞具有相似的 </span><code><span leaf="">Topic profiles</span></code><span leaf=""> ，因为这将意味着</span><code><span leaf="">SPOTlight</span></code><span leaf="">已经为同一细胞身份的所有细胞学习到了一个一致的特征 signature：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">plotTopicProfiles(</span><span leaf=""><br></span><span leaf="">  x = mod,</span><span leaf=""><br></span><span leaf="">  y = sce</span><span><span leaf="">$free_annotation</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  facet = TRUE,</span><span leaf=""><br></span><span leaf="">  min_prop = 0.01,</span><span leaf=""><br></span><span leaf="">  ncol = 6)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bWDexgvMObXDtYq2Aic5MoY37AByNG00dzS3Jt8kCPpwD2464raLowjg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5990740740740741" data-type="png" data-w="1080" data-imgfileid="100056338" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bWDexgvMObXDtYq2Aic5MoY37AByNG00dzS3Jt8kCPpwD2464raLowjg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">最后，我们可以查看模型为每个</span><code><span leaf="">Topic</span></code><span leaf="">学到的基因。较高的值表明该基因对该</span><code><span leaf="">Topic</span></code><span leaf="">更为重要。在下表中，我们可以看到</span><code><span leaf="">Topic1</span></code><span leaf="">的top基因特征为B细胞（例如</span><em><span leaf="">CD79A</span></em><span leaf="">、</span><em><span leaf="">CD79B</span></em><span leaf="">、</span><em><span leaf="">MS4A1</span></em><span leaf="">等）。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">library(NMF)</span><span leaf=""><br></span><span leaf="">sign &lt;- basis(mod)</span><span leaf=""><br></span><span leaf="">colnames(sign) &lt;- paste0(</span><span><span leaf="">"Topic"</span></span><span leaf="">, seq_len(ncol(sign)))</span><span leaf=""><br></span><span leaf="">head(sign)</span><span leaf=""><br></span><span><span leaf=""># This can be dynamically visualized with DT as shown below</span></span><span leaf=""><br></span><span leaf="">DT::datatable(sign, fillContainer = TRUE, filter = </span><span><span leaf="">"top"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4b6tSlPP7QrDqQxDWCnVEt5Flsq67PPfIONk3l47Vs1KsTS3ceCchoeg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.18611111111111112" data-type="png" data-w="1080" data-imgfileid="100056336" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4b6tSlPP7QrDqQxDWCnVEt5Flsq67PPfIONk3l47Vs1KsTS3ceCchoeg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">2.Spatial Correlation Matrix</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">对反卷积得到的矩阵 mat 绘制一个相关性图，这个图是基于细胞类型比例得到的：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">plotCorrelationMatrix(mat)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bVm0UcQuuLLeS0DSeq9z2wgc3udtWKsEfKLZAqMptrzI3iaxexVmibNHA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8409542743538767" data-type="png" data-w="1006" data-imgfileid="100056339" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bVm0UcQuuLLeS0DSeq9z2wgc3udtWKsEfKLZAqMptrzI3iaxexVmibNHA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.细胞类型共定位</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">既然我们已经知道了每个spot中存在的细胞类型，我们就可以绘制一个表示空间相互作用的图，其中细胞类型之间的连接线（边）会根据它们在同一spot中共同出现的频率而变得更粗（即连接更强）：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">plotInteractions(mat, </span><span><span leaf="">which</span></span><span leaf=""> = </span><span><span leaf="">"heatmap"</span></span><span leaf="">, metric = </span><span><span leaf="">"prop"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">plotInteractions(mat, </span><span><span leaf="">which</span></span><span leaf=""> = </span><span><span leaf="">"heatmap"</span></span><span leaf="">, metric = </span><span><span leaf="">"jaccard"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">plotInteractions(mat, </span><span><span leaf="">which</span></span><span leaf=""> = </span><span><span leaf="">"network"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bcLQuiazY9LW79vp5Ac4woVA720ia37ZiaBaZtKyfem66HWMOhDn2oQhdg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7951356407857811" data-type="png" data-w="1069" data-imgfileid="100056343" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bcLQuiazY9LW79vp5Ac4woVA720ia37ZiaBaZtKyfem66HWMOhDn2oQhdg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.空间切片上展示注释结果</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">使用饼图的形式展示每个spot中注释得到细胞类型：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">## 饼图</span></span><span leaf=""><br></span><span leaf="">ct &lt;- colnames(mat)</span><span leaf=""><br></span><span><span leaf=""># 占比小于0.1的不展示</span></span><span leaf=""><br></span><span leaf="">mat[mat &lt; 0.1] &lt;- 0</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 颜色设置</span></span><span leaf=""><br></span><span leaf="">paletteMartin &lt;- c(</span><span leaf=""><br></span><span><span leaf="">"#000000"</span></span><span leaf="">, </span><span><span leaf="">"#004949"</span></span><span leaf="">, </span><span><span leaf="">"#009292"</span></span><span leaf="">, </span><span><span leaf="">"#ff6db6"</span></span><span leaf="">, </span><span><span leaf="">"#ffb6db"</span></span><span leaf="">, </span><span leaf=""><br></span><span><span leaf="">"#490092"</span></span><span leaf="">, </span><span><span leaf="">"#006ddb"</span></span><span leaf="">, </span><span><span leaf="">"#b66dff"</span></span><span leaf="">, </span><span><span leaf="">"#6db6ff"</span></span><span leaf="">, </span><span><span leaf="">"#b6dbff"</span></span><span leaf="">, </span><span leaf=""><br></span><span><span leaf="">"#920000"</span></span><span leaf="">, </span><span><span leaf="">"#924900"</span></span><span leaf="">, </span><span><span leaf="">"#db6d00"</span></span><span leaf="">, </span><span><span leaf="">"#24ff24"</span></span><span leaf="">, </span><span><span leaf="">"#ffff6d"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">pal &lt;- colorRampPalette(paletteMartin)(length(ct))</span><span leaf=""><br></span><span leaf="">names(pal) &lt;- ct</span><span leaf=""><br></span><span leaf="">pal</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">plotSpatialScatterpie(</span><span leaf=""><br></span><span leaf="">  x = spe,</span><span leaf=""><br></span><span leaf="">  y = mat,</span><span leaf=""><br></span><span leaf="">  cell_types = colnames(mat),</span><span leaf=""><br></span><span leaf="">  img = FALSE,</span><span leaf=""><br></span><span leaf="">  scatterpie_alpha = 1,</span><span leaf=""><br></span><span leaf="">  pie_scale = 0.4) +</span><span leaf=""><br></span><span leaf="">  scale_fill_manual(</span><span leaf=""><br></span><span leaf="">    values = pal,</span><span leaf=""><br></span><span leaf="">    breaks = names(pal))</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bqugDIB359HrQMgbrXDZGFOh9onshIz4liauT2SBuAlSMBIyMibYhVjmw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6222222222222222" data-type="png" data-w="1080" data-imgfileid="100056344" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxeybic8iaBZKtZ7Ion73Oa4bqugDIB359HrQMgbrXDZGFOh9onshIz4liauT2SBuAlSMBIyMibYhVjmw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">上面这个切片大饼图就是很多文献中使用的注释结果展示啦！</span>在展示这个结果的时候作者将占比比较小的细胞类型进行了归0处理，后面绘图可以借鉴一下~</span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">文末友情宣传</span></span><span></span></h3><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247539788&amp;idx=1&amp;sn=62a09c7af6373658bf81c149eb0b4026&amp;scene=21#wechat_redirect"><span leaf="">生信入门&amp;数据挖掘线上直播课4月班</span></a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect"><span leaf="">时隔5年，我们的生信技能树VIP学徒继续招生啦</span></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect"><span leaf="">满足你生信分析计算需求的低价解决方案</span></a></section></li></ul></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/aJqWQPdfc_nyvBPh3HrtZg",target="_blank" rel="noopener noreferrer">原文链接</a>
