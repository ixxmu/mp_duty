---
title: "单细胞组间差异分析组内细胞数太少如何判断且跳过不报错"
date: 2025-03-02T15:28:25Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞组间差异分析组内细胞数太少如何判断且跳过不报错 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>收到一个粉丝的求助，<strong>他在做单细胞每个亚群的组间差异分析的时候报错</strong>，报错如下：</p></blockquote><figure data-tool="mdnice编辑器"><img alt="" data-imgfileid="100055351" data-ratio="0.6697247706422018" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz3ytR6h1uYK9j702DP0eicPDicLJytXzll7VTWy5SFM4ibk56zJTelv7dLK3psJwd6BPkUiaog7Ql5HA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="981" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wz3ytR6h1uYK9j702DP0eicPDicLJytXzll7VTWy5SFM4ibk56zJTelv7dLK3psJwd6BPkUiaog7Ql5HA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">很明显，这是因为<span>FindMarkers在做差异分析的时候，要求每个组别至少有3个细胞</span>，而他这里由于细胞亚群超级多，多到31个亚群，所有二分组后，有一些组内没有细胞了。来看看如何解决吧~</p><h2 data-tool="mdnice编辑器"><span></span><span>解决方案</span><span></span><span> </span></h2><p data-tool="mdnice编辑器">思路是这样的：</p><p data-tool="mdnice编辑器">可以循环每个亚群，设置ident1=case,ident2=control，由于差异分析需要满足每个分组至少有3个细胞，所以这里需要<span>加一个条件判断，如果两个分组中有任意一组细胞数小于等于3，跳过差异并打印提示信息</span>：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 加载包</span><br>library(org.Hs.eg.db)<br>library(clusterProfiler)<br>library(ggplot2)<br>library(Seurat)<br>library(tidyverse)<br><br><span># 读取数据并简单探索一下</span><br>sce &lt;- readRDS(<span>"7.cell_anno_scRNAseq_seurat_cluster_res.rds"</span>)<br>sce<br>table(Idents(sce))<br>head(sce@meta.data)<br>table(sce@meta.data<span>$orig</span>.ident)<br><br><span># 组间差异分析</span><br><span># 这里做的 每个亚群 在 case和contol组间的差异</span><br><span># 所以可以循环每个亚群，设置ident1=case,ident2=control</span><br><span># 由于差异分析需要满足每个分组至少有3个细胞，所以这里需要加一个条件判断</span><br><span># 如果两个分组中有任意一组细胞数小于等于2，跳过差异并打印提示信息</span><br><br>celltype &lt;- unique(sce<span>$cell</span>.<span>type</span>)<br>celltype<br><br><span># 保存差异结果</span><br>diff_res &lt;- list()<br><br><span># 制作组间差异分组信息</span><br>sce@meta.data<span>$group</span> &lt;- paste(sce<span>$cell</span>.<span>type</span>, sce<span>$orig</span>.ident, sep = <span>"_"</span>)<br>head(sce@meta.data<span>$group</span>)<br>Idents(sce) &lt;- <span>"group"</span><br>DefaultAssay(sce) &lt;- <span>"RNA"</span><br><br><span>for</span>(i <span>in</span> 1:length(celltype)){<br>  <span># i &lt;- 1</span><br>  <span># 确保两个分组中有对应的细胞</span><br>  ncell1 &lt;- rownames(sce@meta.data[sce<span>$group</span> == paste0(celltype[i], <span>"_sclc"</span>),])<br>  ncell2 &lt;- rownames(sce@meta.data[sce<span>$group</span> == paste0(celltype[i], <span>"_control"</span>),])<br>  <br>  name &lt;- paste0(celltype[i],<span>": sclc("</span> ,length(ncell2),<span>" cells)"</span>, <br>                 <span>" vs "</span>,<span>"control("</span>,length(ncell1),<span>" cells)"</span>)<br>  <br>  <span>print</span>(name)<br>  <br>  <span># Cell group must has more than 2 cells(at least 3 cells)</span><br>  <span># 如果两个分组中有任意一组细胞数小于等于2，跳过差异并打印提示信息</span><br>  <span>if</span>( length(ncell1)&gt;2 &amp;&amp; length(ncell2)&gt;2 ) {<br>    sce.markers &lt;- FindMarkers(sce, <br>                               logfc.threshold=0.25, <br>                               min.pct=0.1, <br>                               test.use = <span>"wilcox"</span>,<br>                               fc.name = <span>"avg_log2FC"</span>,<br>                               ident.1=paste0(celltype[i], <span>"_sclc"</span>), <br>                               ident.2=paste0(celltype[i], <span>"_control"</span>) <br>    )<br>    sce.markers<span>$gene</span> &lt;- rownames(sce.markers)<br>    sce.markers<span>$Group</span> &lt;- paste0(<span>"sclc_vs_control"</span>, <span>"."</span>, gsub(<span>" "</span>, <span>"_"</span>, celltype[i]) )<br>    sce.markers<span>$Regulated</span> &lt;- if_else(sce.markers<span>$avg_log2FC</span> &gt; 0, <span>"Up"</span>, <span>"Down"</span>)<br>  } <span>else</span>{<br>    <span>print</span>(paste0(<span>"Only One group or group cells num &lt; 3: "</span>,celltype[i]))<br>    cat(<span>"\n"</span>)<br>    next<br>  }<br>  <br>  <span># save out</span><br>  diff_res[[celltype[i]]] &lt;- sce.markers<br>}<br><br><span>## combine cluster diff result</span><br>diff_sc &lt;- do.call(rbind, diff_res)<br>head(diff_sc)<br></code></pre><p data-tool="mdnice编辑器">动态如下：</p><pre data-tool="mdnice编辑器"><span></span><code>[1] <span>"Cerebellar_granule_cell_1: sclc(10522 cells) vs control(10788 cells)"</span><br>[1] <span>"Astrocyte_3: sclc(1239 cells) vs control(737 cells)"</span><br>[1] <span>"Purkinje_cell: sclc(135 cells) vs control(105 cells)"</span><br>[1] <span>"Oligodendrocyte: sclc(2137 cells) vs control(1519 cells)"</span><br>[1] <span>"Astrocyte_1: sclc(1072 cells) vs control(660 cells)"</span><br>[1] <span>"Oligodendrocyte_precursor_cell: sclc(431 cells) vs control(538 cells)"</span><br>[1] <span>"Inhibitory_interneuron: sclc(929 cells) vs control(916 cells)"</span><br>[1] <span>"Spiral_ganglion_neuron_1: sclc(1904 cells) vs control(3323 cells)"</span><br>[1] <span>"Microglial_cell: sclc(152 cells) vs control(398 cells)"</span><br>[1] <span>"Cajal-Retzius_cell: sclc(135 cells) vs control(87 cells)"</span><br>[1] <span>"Endothelial_cell: sclc(196 cells) vs control(308 cells)"</span><br>[1] <span>"Astrocyte_2: sclc(247 cells) vs control(1280 cells)"</span><br>[1] <span>"Interneuron_1: sclc(425 cells) vs control(298 cells)"</span><br>[1] <span>"Mature_granule_cell_2: sclc(121 cells) vs control(108 cells)"</span><br>[1] <span>"Cerebellar_granule_cell_2: sclc(699 cells) vs control(484 cells)"</span><br>[1] <span>"Fibroblast: sclc(295 cells) vs control(272 cells)"</span><br>[1] <span>"Vein_endothelial_cell_2: sclc(1205 cells) vs control(489 cells)"</span><br>[1] <span>"Vein_endothelial_cell_1: sclc(591 cells) vs control(1120 cells)"</span><br>[1] <span>"Epithelial_cell: sclc(150 cells) vs control(216 cells)"</span><br>[1] <span>"Ependymal_cell: sclc(60 cells) vs control(66 cells)"</span><br>[1] <span>"Vein_endothelial_cell_3: sclc(288 cells) vs control(144 cells)"</span><br>[1] <span>"Pericyte: sclc(99 cells) vs control(89 cells)"</span><br>[1] <span>"Layer_2–4_neuron_2: sclc(1937 cells) vs control(355 cells)"</span><br>[1] <span>"Layer_2–4_neuron_1: sclc(2558 cells) vs control(568 cells)"</span><br>[1] <span>"Olfactory_bulb_interneuron: sclc(692 cells) vs control(567 cells)"</span><br>[1] <span>"Interneuron_2: sclc(322 cells) vs control(375 cells)"</span><br>[1] <span>"Spiral_ganglion_neuron_2: sclc(1052 cells) vs control(1210 cells)"</span><br>[1] <span>"Olfactory_receptor_cell: sclc(1496 cells) vs control(3542 cells)"</span><br>[1] <span>"Neuroblast_(sensu_Vertebrata): sclc(1388 cells) vs control(910 cells)"</span><br>[1] <span>"Type_1_spiral_ganglion_neuron: sclc(203 cells) vs control(182 cells)"</span><br>[1] <span>"Pyramidal_neuron: sclc(175 cells) vs control(100 cells)"</span><br>[1] <span>"Mature_granule_cell_1: sclc(93 cells) vs control(559 cells)"</span><br></code></pre><p data-tool="mdnice编辑器">他这里没有小于3个细胞的分组呀！额..........那可能是那个代码中的细胞类型有点问题，但是我这里算是解决了他的需求~</p><p data-tool="mdnice编辑器">如果你有任何生信学习上的问题，可以看看下面哟~</p><h3 data-tool="mdnice编辑器"><span></span><span><strong>文末友情宣传</strong></span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247538467&amp;idx=1&amp;sn=aa5500b24a92b86355c242d02e742f1b&amp;scene=21#wechat_redirect" data-linktype="2">生信入门&amp;数据挖掘线上直播课3月班</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></section></li></ul></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/zmNI6G0DyTfMLhu74MYKNw",target="_blank" rel="noopener noreferrer">原文链接</a>
