---
title: "10X HD数据分析进行COMMOT信号流分析"
date: 2025-03-06T05:46:43Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞空间交响乐"
]
categories: ["Acdemic"]
---
10X HD数据分析进行COMMOT信号流分析 by 单细胞空间交响乐
------
<div><h4 data-line="0"><span leaf="">作者， Evil Genius</span></h4><h4 data-line="0"><span leaf="">生活需要音乐</span></h4><section nodeleaf=""><iframe data-src="https://mp.weixin.qq.com/mp/readtemplate?t=pages/video_player_tmpl&amp;action=mpvideo&amp;auto=0&amp;vid=wxv_3886260156098592776" data-mpvid="wxv_3886260156098592776" data-vidtype="2" data-cover="http%3A%2F%2Fmmbiz.qpic.cn%2Fmmbiz_jpg%2FsrXAibe95MmlQBtuL0U8hMQDfamoGib0XhqRH5v42buRSXVt1duUuOY9icoyiaYeIdjeDxUiaSPqIvHjgoU5ZLNHibRg%2F0%3Fwx_fmt%3Djpeg"></iframe></section><h4 data-line="4"><span leaf="">读取数据，我们读取16um的数据</span></h4><pre><code><span><span leaf="">import</span></span><span leaf=""> commot </span><span><span leaf="">as</span></span><span leaf=""> ct</span><br><span><span leaf="">import</span></span><span leaf=""> scanpy </span><span><span leaf="">as</span></span><span leaf=""> sc</span><br><span><span leaf="">import</span></span><span leaf=""> pandas </span><span><span leaf="">as</span></span><span leaf=""> pd</span><br><span><span leaf="">import</span></span><span leaf=""> numpy </span><span><span leaf="">as</span></span><span leaf=""> np</span><br><br><span leaf="">adata = sc.read_visium(</span><span><span leaf="">'./'</span></span><span leaf="">,library_id = </span><span><span leaf="">'sample1'</span></span><span leaf="">)</span><br><span leaf="">adata</span><br><span leaf="">AnnData object </span><span><span leaf="">with</span></span><span leaf=""> n_obs × n_vars = </span><span><span leaf="">135799</span></span><span leaf=""> × </span><span><span leaf="">18085</span></span><br><span leaf="">    obs: </span><span><span leaf="">'in_tissue'</span></span><span leaf="">, </span><span><span leaf="">'array_row'</span></span><span leaf="">, </span><span><span leaf="">'array_col'</span></span><br><span leaf="">    </span><span><span leaf="">var</span></span><span leaf="">: </span><span><span leaf="">'gene_ids'</span></span><span leaf="">, </span><span><span leaf="">'feature_types'</span></span><span leaf="">, </span><span><span leaf="">'genome'</span></span><br><span leaf="">    uns: </span><span><span leaf="">'spatial'</span></span><br><span leaf="">    obsm: </span><span><span leaf="">'spatial'</span></span><br></code></pre><h4 data-line="19"><span leaf="">超过13万的spot，1万8的基因数量</span></h4><h4 data-line="20"><span leaf="">简单的数据分析</span></h4><pre><code><span leaf="">adata.var_names_make_unique()</span><br><span><span leaf="">###QC</span></span><br><span><span leaf=""># mitochondrial genes, "MT-" for human, "Mt-" for mouse</span></span><br><span leaf="">adata.</span><span><span leaf="">var</span></span><span leaf="">[</span><span><span leaf="">"mt"</span></span><span leaf="">] = adata.var_names.str.startswith(</span><span><span leaf="">"MT-"</span></span><span leaf="">)</span><br><span><span leaf=""># ribosomal genes</span></span><br><span leaf="">adata.</span><span><span leaf="">var</span></span><span leaf="">[</span><span><span leaf="">"ribo"</span></span><span leaf="">] = adata.var_names.str.startswith((</span><span><span leaf="">"RPS"</span></span><span leaf="">, </span><span><span leaf="">"RPL"</span></span><span leaf="">))</span><br><span><span leaf=""># hemoglobin genes</span></span><br><span leaf="">adata.</span><span><span leaf="">var</span></span><span leaf="">[</span><span><span leaf="">"hb"</span></span><span leaf="">] = adata.var_names.str.contains(</span><span><span leaf="">"^HB[^(P)]"</span></span><span leaf="">)</span><br><br><span leaf="">sc.pp.calculate_qc_metrics(adata, qc_vars=[</span><span><span leaf="">"mt"</span></span><span leaf="">, </span><span><span leaf="">"ribo"</span></span><span leaf="">, </span><span><span leaf="">"hb"</span></span><span leaf="">], inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><br><br><span leaf="">adata = adata[adata.obs.pct_counts_mt &lt; </span><span><span leaf="">5</span></span><span leaf="">,]</span><br><span><span leaf="">####每个spot的基因数不能低于500</span></span><br><span leaf="">adata = adata[adata.obs.total_counts &gt; </span><span><span leaf="">500</span></span><span leaf="">,]</span><br><br><span leaf="">sc.pp.filter_genes(adata, min_cells=</span><span><span leaf="">5</span></span><span leaf="">)</span><br><span leaf="">adata.layers[</span><span><span leaf="">"count"</span></span><span leaf="">] = adata.X.copy()</span><br><span leaf="">sc.pp.normalize_total(adata, inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><br><span leaf="">adata.layers[</span><span><span leaf="">"normalize"</span></span><span leaf="">] = adata.X.copy()</span><br><span leaf="">sc.pp.log1p(adata)</span><br><br><span leaf="">sc.pp.highly_variable_genes(adata, n_top_genes=</span><span><span leaf="">2000</span></span><span leaf="">)</span><br><span leaf="">adata = adata[:, adata.</span><span><span leaf="">var</span></span><span leaf="">.highly_variable]</span><br><span leaf="">sc.tl.pca(adata, svd_solver=</span><span><span leaf="">'arpack'</span></span><span leaf="">)</span><br><span leaf="">sc.pp.neighbors(adata, n_neighbors=</span><span><span leaf="">10</span></span><span leaf="">, n_pcs=</span><span><span leaf="">20</span></span><span leaf="">)</span><br><span leaf="">sc.tl.umap(adata)</span><br><span leaf="">sc.tl.leiden(adata, resolution=</span><span><span leaf="">0.4</span></span><span leaf="">)</span><br><span leaf="">sc.pl.umap(adata, color=</span><span><span leaf="">'leiden'</span></span><span leaf="">)</span><br><span leaf="">plt.savefig(</span><span><span leaf="">'sample.HD.umap.png'</span></span><span leaf="">,bbox_inches = </span><span><span leaf="">'tight'</span></span><span leaf="">)</span><br></code></pre><section nodeleaf=""><img data-imgfileid="100011366" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0Xhjes2z5A5A2jc1mAhQkGZ1icnchiaMwoZ8NuAHz6YPdoicIoWHMhFSRwUQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0Xhjes2z5A5A2jc1mAhQkGZ1icnchiaMwoZ8NuAHz6YPdoicIoWHMhFSRwUQ/640?wx_fmt=other&amp;from=appmsg"></section><pre><code><span leaf="">sc.pl.spatial(adata,color = </span><span><span leaf="">'leiden'</span></span><span leaf="">)</span><br><span leaf="">plt.savefig(</span><span><span leaf="">'sample.HD.spatial.png'</span></span><span leaf="">,bbox_inches = </span><span><span leaf="">'tight'</span></span><span leaf="">)</span><br></code></pre><section nodeleaf=""><img data-imgfileid="100011370" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XhGwmTgwTUw5m4LOMicPnSCdzibgRUFCqialAqJHkLScnfhVw3pRfEaiaVlg/640?wx_fmt=other&amp;from=appmsg" data-type="other" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XhGwmTgwTUw5m4LOMicPnSCdzibgRUFCqialAqJHkLScnfhVw3pRfEaiaVlg/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="59"><span leaf="">配受体，我们就跑前10个</span></h4><pre><code><span leaf="">df_cellchat = ct.pp.ligand_receptor_database(species=</span><span><span leaf="">'human'</span></span><span leaf="">, signaling_type=</span><span><span leaf="">'Secreted Signaling'</span></span><span leaf="">, database=</span><span><span leaf="">'CellChat'</span></span><span leaf="">)</span><br><span leaf="">df_cellchat_filtered = ct.pp.filter_lr_database(df_cellchat, adata, min_cell_pct=0.01)</span><br></code></pre><section nodeleaf=""><img data-imgfileid="100011367" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XhgficSpADhN7BnktkkuemeWZJ4mUXQOJSZTGn7wMG5vvOxPevEHG20LQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XhgficSpADhN7BnktkkuemeWZJ4mUXQOJSZTGn7wMG5vvOxPevEHG20LQ/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="66"><span leaf="">距离参数我们参考文献</span></h4><section nodeleaf=""><img data-imgfileid="100011368" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XhQZSRRuHjVqwGicINLxwkragm7siaGhRiam8oPTTPw3lt9ID46O05woNicg/640?wx_fmt=other&amp;from=appmsg" data-type="other" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XhQZSRRuHjVqwGicINLxwkragm7siaGhRiam8oPTTPw3lt9ID46O05woNicg/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="68"><span leaf="">这一步相当的慢</span></h4><pre><code><span leaf="">ct.tl.spatial_communication(adata,</span><br><span leaf="">    database_name=</span><span><span leaf="">'cellchat'</span></span><span leaf="">, df_ligrec=df_cellchat_filtered, dis_thr=</span><span><span leaf="">500</span></span><span leaf="">, heteromeric=</span><span><span leaf="">True</span></span><span leaf="">, pathway_sum=</span><span><span leaf="">True</span></span><span leaf="">)</span><br></code></pre><h4 data-line="73"><span leaf="">可视化</span></h4><pre><code><span leaf="">ct.tl.communication_direction(adata_dis500, database_name=</span><span><span leaf="">'cellchat'</span></span><span leaf="">, pathway_name=</span><span><span leaf="">'CCL'</span></span><span leaf="">, k=</span><span><span leaf="">5</span></span><span leaf="">)</span><br><span leaf="">ct.pl.plot_cell_communication(adata_dis500, database_name=</span><span><span leaf="">'cellchat'</span></span><span leaf="">, </span><br><span leaf="">    pathway_name=</span><span><span leaf="">'CCL'</span></span><span leaf="">, plot_method=</span><span><span leaf="">'grid'</span></span><span leaf="">, background_legend=</span><span><span leaf="">True</span></span><span leaf="">,</span><br><span leaf="">    scale=</span><span><span leaf="">0.00003</span></span><span leaf="">, ndsize=</span><span><span leaf="">8</span></span><span leaf="">, grid_density=</span><span><span leaf="">0.4</span></span><span leaf="">, summary=</span><span><span leaf="">'sender'</span></span><span leaf="">, </span><br><span leaf="">    background=</span><span><span leaf="">'image'</span></span><span leaf="">, clustering=</span><span><span leaf="">'leiden'</span></span><span leaf="">, cmap=</span><span><span leaf="">'Alphabet'</span></span><span leaf="">,</span><br><span leaf="">    normalize_v = </span><span><span leaf="">True</span></span><span leaf="">, normalize_v_quantile=</span><span><span leaf="">0.995</span></span><span leaf="">)</span><br><br><span leaf="">plt.savefig(</span><span><span leaf="">'sample1.CCL.commot.png'</span></span><span leaf="">,bbox_inches = </span><span><span leaf="">'tight'</span></span><span leaf="">)</span></code><code><br></code></pre><section nodeleaf=""><img data-imgfileid="100011369" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XheWSAeknKYcNgsqMnKRdX6ac0KSJ3BnqRJiakQJlaxr581JibwpAACADg/640?wx_fmt=other&amp;from=appmsg" data-type="other" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XheWSAeknKYcNgsqMnKRdX6ac0KSJ3BnqRJiakQJlaxr581JibwpAACADg/640?wx_fmt=other&amp;from=appmsg"></section><section><br></section><section nodeleaf=""><img data-imgfileid="100011371" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XhdQpz0QVnt4RNa34PCEZWNmiaicIKYLGibhVxE9wGhPeGI5GqKwI9LYA6A/640?wx_fmt=other&amp;from=appmsg" data-type="other" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95MmlQBtuL0U8hMQDfamoGib0XhdQpz0QVnt4RNa34PCEZWNmiaicIKYLGibhVxE9wGhPeGI5GqKwI9LYA6A/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="84"><span leaf="">生活很好，有你更好</span></h4><section nodeleaf=""><mp-common-product data-windowproduct="v2=HHPJgodVxZ3D8QOBpkZtOlpdDYDKuRUngAX1Hc2BAe6n7qIfB2aPei4Wb6gD_0BoUw" data-customstyle='{"display":"block","height":"169px"}' data-cardtype="1" data-title="宋博士护腰带腰部舒适防护腰带透气男女款软硬护腰" data-type="1"></mp-common-product></section><h4><span leaf=""><br></span></h4><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/qZzE7fgL64fHc_2Q-whABw",target="_blank" rel="noopener noreferrer">原文链接</a>
