---
title: "R 语言接入大模型：ellmer 包快速上手"
date: 2025-03-14T01:38:14Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
R 语言接入大模型：ellmer 包快速上手 by R语言与数学建模
------
<div><p data-first-child="" data-pid="eS9E-Bcp"><code><span leaf="">ellmer</span></code><span leaf=""> 包是 </span><code><span leaf="">Hadley</span></code><span leaf=""> 大神最新开发的，使得从 R 语言中使用大语言模型（LLM）变得简单。它支持多种 LLM 提供商（包括 </span><code><span leaf="">DeepSeek</span></code><span leaf="">），并实现了丰富的功能：结构化数据提取、异步流式输出、工具/函数调用等。</span></p><h2 data-into-catalog-status=""><span leaf="">1 准备工作</span></h2><p data-pid="PzX-kIeh"><span leaf="">从 </span><code><span leaf="">r-universe</span></code><span leaf=""> 安装 </span><code><span leaf="">ellmer</span></code><span leaf=""> 包开发版：</span></p><pre><code><span><span leaf="">install</span></span><span><span leaf="">.</span></span><span><span leaf="">package</span></span><span><span leaf="">s</span></span><span><span leaf="">(</span></span><span leaf="">"ellmer"</span><span><span leaf="">,</span></span><span leaf=""> repos </span><span><span leaf="">=</span></span><span leaf=""> "https</span><span><span leaf="">:</span></span><span><span leaf="">//</span></span><span leaf="">tidyverse.r</span><span><span leaf="">-</span></span><span leaf="">universe.dev"</span><span><span leaf="">)</span></span></code></pre><p data-pid="aeQSs-Ld"><b><span leaf="">注：</span></b><span leaf="">CRAN 上的 0.1.0 版本尚未专门支持 </span><code><span leaf="">DeepSeek</span></code><span leaf="">。</span></p><p data-pid="J1_qcjQX"><span leaf="">加载包：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">ellmer</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="PEJjaotQ"><span leaf="">使用不同大模型，需要先申请它们的 API，这里不赘述，只谈如何更好地管理和使用多个 API。</span></p><p data-pid="yP059kUO"><span leaf="">R 窗口执行：</span></p><pre><code><span><span leaf="">usethis</span></span><span><span leaf="">::</span></span><span><span leaf="">edit_r_environ</span></span><span><span leaf="">()</span></span></code></pre><p data-pid="FSVxu9qo"><span leaf="">打开 </span><code><span leaf="">.Renviron</span></code><span leaf=""> 文件，将多个大模型的 API 以名字赋值的形式放进去，保存：</span></p><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002836" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yfgl3kJCJSpiciaaQX7kANuExxsboib1tp0lcbVNjibFoptgia5ok6pqniaW6A/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="170" width="1250" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yfgl3kJCJSpiciaaQX7kANuExxsboib1tp0lcbVNjibFoptgia5ok6pqniaW6A/640?wx_fmt=other&amp;from=appmsg"></section></figure><p data-pid="ED_826de"><span leaf="">这样做的好处是，每次使用只需要从名字获取，而不必专门去找到复制粘贴一遍。</span></p><h2 data-into-catalog-status=""><span leaf="">2 ChatGPT</span></h2><p data-pid="VCdGeIpg"><span leaf="">首先，你得本来就能上外网使用 </span><code><span leaf="">ChatGPT</span></code><span leaf="">（不赘述），有 API 和额度。</span></p><pre><code><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">设置代理服务器</span></span><br><span><span leaf="">Sys</span></span><span><span leaf="">.</span></span><span><span leaf="">setenv</span></span><span><span leaf="">(</span></span><span><span leaf="">https_proxy</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"http://127.0.0.1:*****"</span></span><span><span leaf="">)</span></span><span leaf="">    </span><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">自己电脑的代理地址</span></span><br><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">恢复Sys</span></span><span><span leaf="">.</span></span><span><span leaf="">setenv</span></span><span><span leaf="">(</span></span><span><span leaf="">https_proxy</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">""</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="4HI5Txh6"><span leaf="">创建对话：</span></p><pre><code><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">有些参数不必设置</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">默认也可以</span></span><br><span><span leaf="">chat</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">chat_openai</span></span><span><span leaf="">(</span></span><br><span leaf="">  </span><span><span leaf="">system_prompt</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"您是一位偏好使用tidyverse的R语言编程专家。"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">model</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"gpt-4o-mini"</span></span><span><span leaf="">,</span></span><span leaf="">      </span><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">或者o1</span></span><span><span leaf="">-</span></span><span><span leaf="">mini</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">gpt</span></span><span><span leaf="">-</span></span><span><span leaf="">4</span></span><span><span leaf="">o等</span></span><span leaf="">  </span><br><span leaf="">  </span><span><span leaf="">api_key</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">Sys</span></span><span><span leaf="">.</span></span><span><span leaf="">getenv</span></span><span><span leaf="">(</span></span><span><span leaf="">"OPENAI_API_KEY"</span></span><span><span leaf="">),</span></span><br><span leaf="">  </span><span><span leaf="">api_args</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">list</span></span><span><span leaf="">(</span></span><span><span leaf="">temperature</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">0.3</span></span><span><span leaf="">))</span></span></code></pre><p data-pid="OhLkDs-N"><span leaf="">启用 </span><code><span leaf="">Shiny</span></code><span leaf=""> 对话窗口：</span></p><pre><code><span><span leaf="">live_browser</span></span><span><span leaf="">(</span></span><span><span leaf="">chat</span></span><span><span leaf="">)</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002839" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yfAs5uQXCaRAAYO52mGZgXfARl9e9zI58e7n6ibyLHvgvPMHyCw2nicF2A/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="1309" width="1194" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yfAs5uQXCaRAAYO52mGZgXfARl9e9zI58e7n6ibyLHvgvPMHyCw2nicF2A/640?wx_fmt=other&amp;from=appmsg"></section></figure><p data-pid="yXo8ieLG"><b><span leaf="">注：</span></b><span leaf="">还有</span><code><span leaf="">live_console(chat)</span></code><span leaf=""> 在控制台交互对话。</span></p><h2 data-into-catalog-status=""><span leaf="">3 DeepSeek</span></h2><p data-pid="PT_QmJF1"><span leaf="">可以说是，DeepSeek 的爆火，让</span><code><span leaf="">Hadley</span></code><span leaf=""> 连夜开发了专门函数。</span></p><p data-pid="r-oNLOlS"><span leaf="">用法基本一样。</span></p><pre><code><span><span leaf="">chat</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">chat_deepseek</span></span><span><span leaf="">(</span></span><br><span leaf="">  </span><span><span leaf="">system_prompt</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"您是一位偏好使用tidyverse的R语言编程专家。"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">model</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"deepseek-chat"</span></span><span><span leaf="">,</span></span><span leaf="">     </span><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">或者deepseek</span></span><span><span leaf="">-</span></span><span><span leaf="">reasoner</span></span><br><span leaf="">  </span><span><span leaf="">api_key</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">Sys</span></span><span><span leaf="">.</span></span><span><span leaf="">getenv</span></span><span><span leaf="">(</span></span><span><span leaf="">"DEEPSEEK_API_KEY"</span></span><span><span leaf="">),</span></span><br><span leaf="">  </span><span><span leaf="">api_args</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">list</span></span><span><span leaf="">(</span></span><span><span leaf="">temperature</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">0.3</span></span><span><span leaf="">))</span></span><br><span><span leaf="">live_browser</span></span><span><span leaf="">(</span></span><span><span leaf="">chat</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="wl5JnRcy"><span leaf="">问同样的问题：</span></p><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002837" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yf4hZ2I37GrUtoCx1Dib56HFxHhUk8icR225MN3tKVkAzCjPPwVp8ZmZkA/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="881" width="1179" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yf4hZ2I37GrUtoCx1Dib56HFxHhUk8icR225MN3tKVkAzCjPPwVp8ZmZkA/640?wx_fmt=other&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002838" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yf77nhCicHjwzBUsLyNAYJd5REiaD8cmsQT7ZDmZoP0jEFHyiajHhkXAQsg/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="1182" width="1169" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yf77nhCicHjwzBUsLyNAYJd5REiaD8cmsQT7ZDmZoP0jEFHyiajHhkXAQsg/640?wx_fmt=other&amp;from=appmsg"></section></figure><h2 data-into-catalog-status=""><span leaf="">4 Kimi</span></h2><p data-pid="jXiGZw2l"><span leaf="">Kimi 没有专门函数，只能使用通用函数 </span><code><span leaf="">chat_openai()</span></code></p><p data-pid="hSsNTlAp"><span leaf="">用法基本一样，这里演示一个结构化数据的例子：</span><b><span leaf="">情感分析</span></b><span leaf="">。</span></p><pre><code><span><span leaf="">chat</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">chat_openai</span></span><span><span leaf="">(</span></span><br><span leaf="">  </span><span><span leaf="">system_prompt</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"你是一位情感分析专家。"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">model</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"moonshot-v1-8k"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">base_url</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"https://api.moonshot.cn/v1"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">api_key</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">Sys</span></span><span><span leaf="">.</span></span><span><span leaf="">getenv</span></span><span><span leaf="">(</span></span><span><span leaf="">"MOONSHOT_API_KEY"</span></span><span><span leaf="">),</span></span><span leaf="">  </span><br><span leaf="">  </span><span><span leaf="">api_args</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">list</span></span><span><span leaf="">(</span></span><span><span leaf="">temperature</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">0.7</span></span><span><span leaf="">),</span></span><br><span leaf="">  </span><span><span leaf="">echo</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"text"</span></span><span><span leaf="">)</span></span><span leaf=""> </span></code></pre><p data-pid="pm7bPVED"><span leaf="">给定商品评论，让 Kimi 给出情感得分：</span></p><pre><code><span><span leaf="">text</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"产品还行，但客服太差了。我可能不会再从他们那里购买了。"</span></span><br><br><span><span leaf="">type_sentiment</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">type_object</span></span><span><span leaf="">(</span></span><br><span leaf="">  </span><span><span leaf="">"提取给定文本的情感分数。情感分数总和应为1。"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">positive_score</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">type_number</span></span><span><span leaf="">(</span></span><span><span leaf="">"正面情感分数，范围从0.0到1.0"</span></span><span><span leaf="">),</span></span><br><span leaf="">  </span><span><span leaf="">negative_score</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">type_number</span></span><span><span leaf="">(</span></span><span><span leaf="">"负面情感分数，范围从0.0到1.0"</span></span><span><span leaf="">),</span></span><br><span leaf="">  </span><span><span leaf="">neutral_score</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">type_number</span></span><span><span leaf="">(</span></span><span><span leaf="">"中性情感分数，范围从0.0到1.0。"</span></span><span><span leaf="">))</span></span><br><br><span><span leaf="">str</span></span><span><span leaf="">(</span></span><span><span leaf="">chat</span></span><span><span leaf="">$</span></span><span><span leaf="">extract_data</span></span><span><span leaf="">(</span></span><span><span leaf="">text</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">type</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">type_sentiment</span></span><span><span leaf="">))</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002835" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yfg5KS4zdz3UKr6kgWewbd6ryMtrTufuccfjLha14tcmO3rUSiaehWuVg/640?wx_fmt=other&amp;from=appmsg" data-type="other" height="125" width="446" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDTwjAPBPUhrHJ6HIvicz2yfg5KS4zdz3UKr6kgWewbd6ryMtrTufuccfjLha14tcmO3rUSiaehWuVg/640?wx_fmt=other&amp;from=appmsg"></section></figure><h2 data-into-catalog-status=""><span leaf="">5 本地大模型</span></h2><p data-pid="HiYKKlNm"><span leaf="">比如，我用 </span><code><span leaf="">Ollama</span></code><span leaf=""> 在自己电脑部署了一个 </span><code><span leaf="">deepseek-r1:7b</span></code><span leaf=""> （到处都是方法，不赘述）。</span></p><p data-pid="FCmNwmX9"><span leaf="">用法基本一样：</span></p><pre><code><span><span leaf="">chat</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">chat_ollama</span></span><span><span leaf="">(</span></span><span><span leaf="">model</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"deepseek-r1:7b"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">live_browser</span></span><span><span leaf="">(</span></span><span><span leaf="">chat</span></span><span><span leaf="">)</span></span></code></pre><h2 data-into-catalog-status=""><span leaf="">最后注</span></h2><p data-pid="UWOMJUhv"><span leaf="">本文使用的简单示例，均改写（翻译）自包文档。</span></p><p data-pid="RFYpP4KK"><span leaf="">附上 </span><code><span leaf="">ellmer</span></code><span leaf=""> 包（开发版）目前支持的大模型：</span></p><ul><li><b><span leaf="">Anthropic 的 Claude：</span></b><code><span leaf="">chat_claude()</span></code></li><li><b><span leaf="">AWS Bedrock：</span></b><code><span leaf="">chat_bedrock()</span></code></li><li><b><span leaf="">Azure OpenAI：</span></b><code><span leaf="">chat_azure()</span></code></li><li><b><span leaf="">Databricks：</span></b><code><span leaf="">chat_databricks()</span></code></li><li><b><span leaf="">DeepSeek：</span></b><code><span leaf="">chat_deepseek()</span></code></li><li><b><span leaf="">GitHub 模型市场：</span></b><code><span leaf="">chat_github()</span></code></li><li><b><span leaf="">Google Gemini：</span></b><code><span leaf="">chat_gemini()</span></code></li><li><b><span leaf="">Groq：</span></b><code><span leaf="">chat_groq()</span></code></li><li><b><span leaf="">Ollama：</span></b><code><span leaf="">chat_ollama()</span></code></li><li><b><span leaf="">OpenAI：</span></b><code><span leaf="">chat_openai()</span></code></li><li><b><span leaf="">OpenRouter：</span></b><code><span leaf="">chat_openrouter()</span></code></li><li><b><span><span leaf="">perplexity.ai</span></span><span leaf="">：</span></b><code><span leaf="">chat_perplexity()</span></code></li><li><b><span leaf="">Snowflake Cortex：</span></b><code><span leaf="">chat_snowflake()</span></code><section><span leaf=""> 和 </span><code><span leaf="">chat_cortex_analyst()</span></code></section></li><li><b><span leaf="">VLLM：</span></b><code><span leaf="">chat_vllm()</span></code></li></ul><p data-pid="WyXhmb_5"><code><span leaf="">Posit</span></code><span leaf=""> 公司也开发了对应的 </span><code><span leaf="">Python</span></code><span leaf=""> 库：</span><span leaf="">chatlas</span></p><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/2UKTueyFLn8flsSyWpFlHA",target="_blank" rel="noopener noreferrer">原文链接</a>
