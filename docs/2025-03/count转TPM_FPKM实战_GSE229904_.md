---
title: "count转TPM/FPKM实战（GSE229904）"
date: 2025-03-28T10:57:15Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
count转TPM/FPKM实战（GSE229904） by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><blockquote><span></span><p><span leaf="">我们<span textstyle="">生信马拉松授课的</span><span textstyle="">第四周为转录组测序分析实战</span><span textstyle="">，介绍了上游（linux）以及下游的各种分析（R语言），融合了课程设计的前面两周R语言的学习以及第三周的Liunx学习，可以对刚刚学完的内容进行实战分析，提升学员的代码编写基础</span>，最新的一期就在下周一开课啦，感兴趣的去瞄一瞄：</span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247540114&amp;idx=1&amp;sn=92528ab7ac6c145d94219c4373dba1b4&amp;scene=21#wechat_redirect"><span leaf="">《生信入门&amp;数据挖掘线上直播课4月班》</span></a><span leaf="">。</span></p></blockquote><p data-tool="mdnice编辑器"><span leaf="">接下来是对学员的答疑部分，学员提了一个问题，他想知道<span textstyle="">怎么将我们的count值进行标准化转为tpm和fpkm值</span>。我们技能树对这个转换已经介绍过非常多次啦：</span></p><ul><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247513933&amp;idx=2&amp;sn=874301305219e93c26d173560a31b076&amp;scene=21#wechat_redirect"><span leaf="">Counts FPKM RPKM TPM CPM 的转化</span></a></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">下面就是用GEO的转录组测序数据进行一下实战，正好<span textstyle="">GEO数据库对二代高通量测序数据统一进行了自己的处理，每一个数据都有count值，tpm值以及fpkm值</span>。</span></p><p data-tool="mdnice编辑器"><span leaf="">我们本次实战选的数据为：GSE229904，https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE229904</span></p><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">数据下载</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">这个数据做的是前列腺癌患者原发肿瘤的mRNA和miRNA表达谱，从这里点进去：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVaowFa3ymYUD7TkwjcXla8HIibFzx8sXLyoWsEuiaUHdo6OicbvV1ib7vCQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.1738437001594897" data-type="png" data-w="627" data-imgfileid="100056576" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVaowFa3ymYUD7TkwjcXla8HIibFzx8sXLyoWsEuiaUHdo6OicbvV1ib7vCQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">将这个页面的 https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE229904 下列数据下载下来：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAV2NmQNWNIvibc8gFN5dCHCg8kUlkrqxb5ANxqvJibPiaQXVtibW7ajL5jbw/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.014265335235378" data-type="png" data-w="701" data-imgfileid="100056575" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAV2NmQNWNIvibc8gFN5dCHCg8kUlkrqxb5ANxqvJibPiaQXVtibW7ajL5jbw/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">得到基因长度</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">这里数据库直接<span textstyle="">提供了配套定量的基因长度文件，不同的参考基因组版本计算出来的长度会有区别</span>，所以我们这里就用</span><code><span leaf="">Human.GRCh38.p13.annot.tsv.gz</span></code></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># NCBI的注释文件</span></span><span leaf=""><br></span><span leaf="">anno &lt;- fread(</span><span><span leaf="">"GSE229904/Human.GRCh38.p13.annot.tsv.gz"</span></span><span leaf="">,data.table = </span><span><span leaf="">F</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">colnames(anno)</span><span leaf=""><br></span><span leaf="">anno &lt;- anno[,c(</span><span><span leaf="">"GeneID"</span></span><span leaf="">,</span><span><span leaf="">"Symbol"</span></span><span leaf="">,</span><span><span leaf="">"EnsemblGeneID"</span></span><span leaf="">,</span><span><span leaf="">"Length"</span></span><span leaf="">,</span><span><span leaf="">"GeneType"</span></span><span leaf="">)]</span><span leaf=""><br></span><span leaf="">save(anno,file = </span><span><span leaf="">"GSE229904/GRCh38.p13.annot.Rdata"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">head(anno)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVzkKwIlFMMZzN2Uv0Y5jCUTzl2o5MyWuibgXqx9Agvmaqpdz6ZA2ONVg/640?wx_fmt=png&amp;from=appmsg" alt="image-20250328155407494" data-ratio="0.2278719397363465" data-type="png" data-w="531" data-imgfileid="100056577" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVzkKwIlFMMZzN2Uv0Y5jCUTzl2o5MyWuibgXqx9Agvmaqpdz6ZA2ONVg/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20250328155407494</span></figcaption></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">count转TPM</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">TPM的标准化方式如下：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAV9KDgcZ5JvlmlGYItQF83BH4iaD6ib9sODoLcJiaOSOA4Swq3LFprw3t8g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5435185185185185" data-type="png" data-w="1080" data-imgfileid="100056578" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAV9KDgcZ5JvlmlGYItQF83BH4iaD6ib9sODoLcJiaOSOA4Swq3LFprw3t8g/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">先读取count：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">############################### count2TPM</span></span><span leaf=""><br></span><span><span leaf=""># 1.读取count</span></span><span leaf=""><br></span><span leaf="">counts &lt;- fread(</span><span><span leaf="">"GSE229904/GSE229904_raw_counts_GRCh38.p13_NCBI.tsv.gz"</span></span><span leaf="">,data.table = F)</span><span leaf=""><br></span><span leaf="">counts[1:4,1:4]</span><span leaf=""><br></span><span leaf="">rownames(counts) &lt;- counts[,1]</span><span leaf=""><br></span><span leaf="">counts &lt;- counts[,-1]</span><span leaf=""><br></span><span leaf="">counts[1:4,1:4]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#            GSM7179964 GSM7179965 GSM7179966 GSM7179967</span></span><span leaf=""><br></span><span><span leaf=""># 100287102         14          8          4         10</span></span><span leaf=""><br></span><span><span leaf=""># 653635           986        597        746       1398</span></span><span leaf=""><br></span><span><span leaf=""># 102466751         38         24         22         57</span></span><span leaf=""><br></span><span><span leaf=""># 107985730          0          1          0          4</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 2.提取基因长度列</span></span><span leaf=""><br></span><span leaf="">load(</span><span><span leaf="">"GSE229904/GRCh38.p13.annot.Rdata"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">head(anno)</span><span leaf=""><br></span><span leaf="">rownames(anno) &lt;- anno</span><span><span leaf="">$GeneID</span></span><span leaf=""><br></span><span leaf="">effLen &lt;- anno[row.names(counts), </span><span><span leaf="">"Length"</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">range(effLen)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">接下来定义两个函数，这里有两个不同的写法：</span></p><p data-tool="mdnice编辑器"><span leaf="">来自：What the FPKM? A review of RNA-Seq expression units | The farrago (wordpress.com)</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 转化</span></span><span leaf=""><br></span><span leaf="">Counts2TPM &lt;- </span><span><span leaf="">function</span></span><span leaf="">(counts, effLen){</span><span leaf=""><br></span><span leaf="">  rate &lt;- </span><span><span leaf="">log</span></span><span leaf="">(counts) - </span><span><span leaf="">log</span></span><span leaf="">(effLen)</span><span leaf=""><br></span><span leaf="">  denom &lt;- </span><span><span leaf="">log</span></span><span leaf="">(sum(exp(rate)))</span><span leaf=""><br></span><span leaf="">  exp(rate - denom + </span><span><span leaf="">log</span></span><span leaf="">(1e6))</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">tpm_raw &lt;- apply(counts, 2, Counts2TPM, effLen = effLen)</span><span leaf=""><br></span><span leaf="">tpm_raw[1:5,1:5]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 与官方的tpm比较</span></span><span leaf=""><br></span><span><span leaf=""># 3.与原文件相比</span></span><span leaf=""><br></span><span leaf="">tpm &lt;- fread(</span><span><span leaf="">"GSE229904/GSE229904_norm_counts_TPM_GRCh38.p13_NCBI.tsv.gz"</span></span><span leaf="">,data.table = F)</span><span leaf=""><br></span><span leaf="">tpm[1:5,1:5]</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">结果一致：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVrS45khftYIaQjavicvPn5Y97ASODg0RUqwETa6oYVy8ZzV53icCy6y7Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4176470588235294" data-type="png" data-w="510" data-imgfileid="100056574" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVrS45khftYIaQjavicvPn5Y97ASODg0RUqwETa6oYVy8ZzV53icCy6y7Q/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">还有一个根据公式写的版本：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#TPM (Transcripts Per Kilobase Million)  每千个碱基的转录每百万映射读取的Transcripts </span></span><span leaf=""><br></span><span leaf="">counts2TPM2 &lt;- </span><span><span leaf="">function</span></span><span leaf="">(count=count, efflength=efflen){   </span><span leaf=""><br></span><span leaf="">  RPK &lt;- count/(efflength/1000)   </span><span><span leaf="">#每千碱基reads (reads per kilobase) 长度标准化   </span></span><span leaf=""><br></span><span leaf="">  PMSC_rpk &lt;- sum(RPK)/1e6        </span><span><span leaf="">#RPK的每百万缩放因子 (“per million” scaling factor ) 深度标准化   </span></span><span leaf=""><br></span><span leaf="">  RPK/PMSC_rpk                       </span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">tpm_raw2 &lt;- apply(counts, 2, counts2TPM2, efflength = effLen)</span><span leaf=""><br></span><span leaf="">tpm_raw2[1:5,1:5]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 3.与原文件相比</span></span><span leaf=""><br></span><span leaf="">tpm[1:5,1:5]</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">结果一致：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVRsaXhjzSySZoSicbRrfibQibZfPiauPeaxzlp0PNSnX5Gkj4WEKl8t5raA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4191033138401559" data-type="png" data-w="513" data-imgfileid="100056582" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVRsaXhjzSySZoSicbRrfibQibZfPiauPeaxzlp0PNSnX5Gkj4WEKl8t5raA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">count转FPKM</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">FPKM的公式如下：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVhp09wPPoicVxvaNKU2NwLyJcKfrxiafKOgewLAJa7yfNyZYMmYgpia14w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5435185185185185" data-type="png" data-w="1080" data-imgfileid="100056584" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVhp09wPPoicVxvaNKU2NwLyJcKfrxiafKOgewLAJa7yfNyZYMmYgpia14w/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">接下来定义两个函数，这里有两个不同的写法：</span></p><p data-tool="mdnice编辑器"><span leaf="">来自：What the FPKM? A review of RNA-Seq expression units | The farrago (wordpress.com)</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 转化</span></span><span leaf=""><br></span><span leaf="">countToFpkm &lt;- </span><span><span leaf="">function</span></span><span leaf="">(counts, effLen) { </span><span leaf=""><br></span><span leaf="">  N &lt;- sum(counts) </span><span leaf=""><br></span><span leaf="">  exp( log(counts) + log(</span><span><span leaf="">1e9</span></span><span leaf="">) - log(effLen) - log(N) ) </span><span leaf=""><br></span><span leaf="">} </span><span leaf=""><br></span><span leaf="">fpkm_raw &lt;- apply(counts, </span><span><span leaf="">2</span></span><span leaf="">, countToFpkm, effLen = effLen)</span><span leaf=""><br></span><span leaf="">fpkm_raw[</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">5</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">5</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 3.与原文件相比</span></span><span leaf=""><br></span><span leaf="">fpkm &lt;- fread(</span><span><span leaf="">"GSE229904/GSE229904_norm_counts_FPKM_GRCh38.p13_NCBI.tsv.gz"</span></span><span leaf="">,data.table = </span><span><span leaf="">F</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">rownames(fpkm) &lt;- fpkm[,</span><span><span leaf="">1</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">fpkm &lt;- fpkm[, -</span><span><span leaf="">1</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">fpkm[</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">5</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">5</span></span><span leaf="">]</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">结果一致：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVpDWgNJTYNXjlAs6DwUh3quOXgXAGLQzvicJY6sHnzBXqL0AerHbW02w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5326923076923077" data-type="png" data-w="520" data-imgfileid="100056581" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVpDWgNJTYNXjlAs6DwUh3quOXgXAGLQzvicJY6sHnzBXqL0AerHbW02w/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">还有一个根据公式写的版本：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">##### 函数</span></span><span leaf=""><br></span><span><span leaf=""># FPKM/RPKM (Fragments/Reads Per Kilobase Million )  每千个碱基的转录每百万映射读取的Fragments/reads </span></span><span leaf=""><br></span><span><span leaf=""># RPKM与FPKM分别针对单端与双端测序而言，计算公式是一样的 </span></span><span leaf=""><br></span><span leaf="">counts2FPKM &lt;- </span><span><span leaf="">function</span></span><span leaf="">(count=count, efflength=efflen){    </span><span leaf=""><br></span><span leaf="">  PMSC_counts &lt;- sum(count)/</span><span><span leaf="">1e6</span></span><span leaf="">   </span><span><span leaf="">#counts的每百万缩放因子 (“per million” scaling factor) 深度标准化   </span></span><span leaf=""><br></span><span leaf="">  FPM &lt;- count/PMSC_counts        </span><span><span leaf="">#每百万reads/Fragments (Reads/Fragments Per Million) 长度标准化   </span></span><span leaf=""><br></span><span leaf="">  FPM/(efflength/</span><span><span leaf="">1000</span></span><span leaf="">)                                       </span><span leaf=""><br></span><span leaf="">} </span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">fpkm_raw2 &lt;- apply(counts, </span><span><span leaf="">2</span></span><span leaf="">, counts2FPKM, efflength = effLen)</span><span leaf=""><br></span><span leaf="">fpkm_raw2[</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">5</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">5</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 3.与原文件相比</span></span><span leaf=""><br></span><span leaf="">fpkm[</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">5</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">5</span></span><span leaf="">]</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">结果一致：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAV6U2zMvhqojibEkQ9bEzpazBRgjxVw42OtPRlozS5lYGMDB34c9tbWag/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4444444444444444" data-type="png" data-w="531" data-imgfileid="100056580" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAV6U2zMvhqojibEkQ9bEzpazBRgjxVw42OtPRlozS5lYGMDB34c9tbWag/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">Note：根据gtf获取基因长度</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">这个例子当中，GEO数据库提供了现成的基因长度，如果是自己的项目呢，一般<span textstyle=""> featureCounts 软件的结果会提供一个基因长度，在结果的第六列</span>，就可以完成上面的操作了：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVIpjnrWUm68ibEZJXDJMDM6Qnib3iaItdqib1D6icVhxhK2sqMicQ8ppAcnEg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.24113475177304963" data-type="png" data-w="987" data-imgfileid="100056579" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wycWQmiaHnT78l4fhjYzatAVIpjnrWUm68ibEZJXDJMDM6Qnib3iaItdqib1D6icVhxhK2sqMicQ8ppAcnEg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">除此之外，我们<span textstyle="">还可以使用定量的时候配套的gtf文件获取基因长度，</span><span textstyle="">这里需要注意一定是同一个版本（不同的版本算出来的基因长度会有点不一样）</span></span></p><p data-tool="mdnice编辑器"><span leaf="">gtf文件下载：https://www.ensembl.org/index.html</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">rm(list=ls())</span><span leaf=""><br></span><span><span leaf="">#BiocManager::install("GenomicFeatures")</span></span><span leaf=""><br></span><span leaf="">library(GenomicFeatures)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># </span></span><span leaf=""><br></span><span><span leaf=""># gtf &lt;- "/nas1/zhangj/database/genome/Human/release-113/Homo_sapiens.GRCh38.113.gtf"</span></span><span leaf=""><br></span><span><span leaf="">#txdb &lt;- makeTxDbFromGFF(gtf,format="gtf")</span></span><span leaf=""><br></span><span><span leaf=""># 上面的图片定量使用的版本是GRCh38 release 104</span></span><span leaf=""><br></span><span leaf="">txdb &lt;- makeTxDbFromGFF(</span><span><span leaf="">"GSE229904/Homo_sapiens.GRCh38.104.chr.gtf.gz"</span></span><span leaf="">,format=</span><span><span leaf="">"gtf"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">txdb</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 获取每个基因id的外显子数据</span></span><span leaf=""><br></span><span leaf="">exons.list.per.gene &lt;- exonsBy(txdb, by=</span><span><span leaf="">"gene"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 对于每个基因，将所有外显子减少成一组非重叠外显子，计算它们的长度(宽度)并求和</span></span><span leaf=""><br></span><span leaf="">exonic.gene.sizes &lt;- sum(width(GenomicRanges::reduce(exons.list.per.gene)))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 得到geneid和长度数据</span></span><span leaf=""><br></span><span leaf="">gfe &lt;- data.frame(gene_id=names(exonic.gene.sizes), length=exonic.gene.sizes)</span><span leaf=""><br></span><span leaf="">head(gfe)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">长度如下，与上面的图片经过了验证，得到的长度与  featureCounts 软件的结果一致：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">                        gene_id length</span><span leaf=""><br></span><span leaf="">ENSG00000000003 ENSG00000000003   4536</span><span leaf=""><br></span><span leaf="">ENSG00000000005 ENSG00000000005   1476</span><span leaf=""><br></span><span leaf="">ENSG00000000419 ENSG00000000419   9276</span><span leaf=""><br></span><span leaf="">ENSG00000000457 ENSG00000000457   6883</span><span leaf=""><br></span><span leaf="">ENSG00000000460 ENSG00000000460   5970</span><span leaf=""><br></span><span leaf="">ENSG00000000938 ENSG00000000938   3382</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">你学会了吗？</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">如果你还有其他疑问，欢迎关注我们每月一期的培训班，为你提供最贴心的生信入门，最新一期如下：</span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247540114&amp;idx=1&amp;sn=92528ab7ac6c145d94219c4373dba1b4&amp;scene=21#wechat_redirect"><span leaf="">《生信入门&amp;数据挖掘线上直播课4月班》</span></a><span leaf="">。</span></p></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/FRvbgSAh-WiJixW4Jd2dxw",target="_blank" rel="noopener noreferrer">原文链接</a>
