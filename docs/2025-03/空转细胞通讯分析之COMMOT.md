---
title: "空转细胞通讯分析之COMMOT"
date: 2025-03-23T05:39:05Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
空转细胞通讯分析之COMMOT by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">空间转录组以及单细胞转录组</span><span leaf="" data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;data-tool&quot;:&quot;mdnice编辑器&quot;,&quot;data-website&quot;:&quot;https://www.mdnice.com&quot;,&quot;style&quot;:&quot;margin-top: 0px;margin-bottom: 0px;margin-left: 0px;margin-right: 0px;padding-top: 0px;padding-bottom: 0px;padding-left: 10px;padding-right: 10px;background-attachment: scroll;background-clip: border-box;background-color: rgba(0, 0, 0, 0);background-image: none;background-origin: padding-box;background-position-x: 0%;background-position-y: 0%;background-repeat-x: no-repeat;background-repeat-y: no-repeat;background-size: auto;width: auto;font-family: Optima, 'Microsoft YaHei', PingFangSC-regular, serif;font-size: 16px;color: rgb(0, 0, 0);line-height: 1.5em;word-spacing: 0em;letter-spacing: 0em;word-break: break-word;overflow-wrap: break-word;text-align: left;&quot;,&quot;data-pm-slice&quot;:&quot;0 0 []&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;},&quot;para&quot;,{&quot;tagName&quot;:&quot;p&quot;,&quot;attributes&quot;:{&quot;data-tool&quot;:&quot;mdnice编辑器&quot;,&quot;style&quot;:&quot;color: rgb(0, 0, 0);font-size: 14px;line-height: 1.8em;letter-spacing: 0em;text-align: left;text-indent: 0em;margin-top: 0px;margin-bottom: 0px;margin-left: 0px;margin-right: 0px;padding-top: 8px;padding-bottom: 8px;padding-left: 0px;padding-right: 0px;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]">技术，为解析细胞-细胞通讯（Cell–Cell Communication, CCC）提供了前所未有的机会。然而，如何在重建细胞通讯网络的过程中充分整合细胞间的空间位置信息和复杂的生化过程，仍然是一个重大挑战。</span></p><p data-tool="mdnice编辑器"><strong><span leaf="">COMMOT</span></strong><span leaf="">（</span><strong><span leaf="">COMMunication analysis by Optimal Transport</span></strong><span leaf="">）是一种创新的分析方法，旨在在空间转录组数据中推断细胞通讯关系。它基于</span><strong><span leaf="">集体最优传输理论（collective optimal transport）</span></strong><span leaf="">，能够同时考虑多个配体-受体对之间的相互竞争关系以及细胞之间的空间距离，实现更为精确和生物学上合理的通讯建模。该算法发表于2023年的Nature Methods，题为《Screening cell–cell communication in spatial transcriptomics via collective optimal transport》。</span></p><p data-tool="mdnice编辑器"><span leaf="">COMMOT 的主要功能包括：</span></p><ul><li><section><span leaf="">支持多种类型空间数据（如原始空间转录组或配对成像数据推断的空间单细胞转录组）；</span></section></li><li><section><span leaf="">模拟多个配体–受体对在空间中的传递与分布；</span></section></li><li><section><span leaf="">推断信号传导的</span><strong><span leaf="">空间方向性</span></strong><span leaf="">；</span></section></li><li><section><span leaf="">借助集成树模型识别下游受信号调控的关键基因；</span></section></li><li><section><span leaf="">提供全面的可视化工具，包括通讯热图、信号流向图和基因调控网络图等。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">下面我们学习一下官网的参考文档（https://github.com/zcang/COMMOT）：</span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">首先是环境的部署：</span></span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#构建分析环境commot</span></span><span leaf=""><br></span><span leaf="">mamba create -n commot python=3.8 -y</span><span leaf=""><br></span><span leaf="">conda activate commot</span><span leaf=""><br></span><span leaf="">pip install commot</span><span leaf=""><br></span><span><span leaf="">#mamba install -c conda-forge pygraphviz</span></span><span leaf=""><br></span><span><span leaf="">#pip install get-version==2.0.4</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">mamba install -y nb_conda_kernels ipykernel</span><span leaf=""><br></span><span leaf="">python -m ipykernel install --user --name commot --display-name commot</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">可选：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#安装官网教程，在下游分析DE genes时会用到tradeseq</span></span><span leaf=""><br></span><span leaf="">mamba install rpy2</span><span leaf=""><br></span><span leaf="">mamba install r-base==3.6.3</span><span leaf=""><br></span><span leaf="">pip install commot[tradeSeq]</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#安装完成后，进入R程序,在里面安装tradeSeq</span></span><span leaf=""><br></span><span><span leaf="">if</span></span><span leaf=""> (!</span><span><span leaf="">require</span></span><span leaf="">(</span><span><span leaf="">"BiocManager"</span></span><span leaf="">, quietly = </span><span><span leaf="">TRUE</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">   install.packages(</span><span><span leaf="">"BiocManager"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">BiocManager::install(</span><span><span leaf="">"tradeSeq"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><strong><span leaf="">参考文档总共分为两大部分：</span></strong></p><ul><li><section><span leaf="">Basic usage</span></section></li><li><section><span leaf="">以及Visium data example (mouse brain)</span></section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">一. Basic usage</span></span><span></span></h3><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf=""> commot </span><span><span leaf="">as</span></span><span leaf=""> ct</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> scanpy </span><span><span leaf="">as</span></span><span leaf=""> sc</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> pandas </span><span><span leaf="">as</span></span><span leaf=""> pd</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> numpy </span><span><span leaf="">as</span></span><span leaf=""> np</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> matplotlib.pyplot </span><span><span leaf="">as</span></span><span leaf=""> plt</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step1. 加载示例数据</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata = sc.datasets.visium_sge(sample_id=</span><span><span leaf="">'V1_Mouse_Brain_Sagittal_Posterior'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata.var_names_make_unique()</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step2. 数据预处理</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">该方法假定使用的数值为非负数，并反映信号分子的丰度。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.pp.normalize_total(adata, inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.log1p(adata)</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step3. </span><strong><span leaf="">指定配体-受体对</span></strong></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">这里，我们以仅包含三个 LR 对为例。</span></p><p data-tool="mdnice编辑器"><span leaf="">可以用同样的方式指定用户自定义的 LR 数据库，或者也可以通过函数 </span><code><span leaf="">commot.pp.ligand_receptor_database()</span></code><span leaf=""> 获取内置的 LR 数据库。</span></p><p data-tool="mdnice编辑器"><span leaf="">例如，</span><code><span leaf="">df_ligrec = ct.pp.ligand_receptor_database(database='CellChat', species='mouse')</span></code><span leaf="">。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">LR=np.array([[</span><span><span leaf="">'Tgfb1'</span></span><span leaf="">, </span><span><span leaf="">'Tgfbr1_Tgfbr2'</span></span><span leaf="">, </span><span><span leaf="">'Tgfb_pathway'</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    [</span><span><span leaf="">'Tgfb2'</span></span><span leaf="">, </span><span><span leaf="">'Tgfbr1_Tgfbr2'</span></span><span leaf="">, </span><span><span leaf="">'Tgfb_pathway'</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    [</span><span><span leaf="">'Tgfb3'</span></span><span leaf="">, </span><span><span leaf="">'Tgfbr1_Tgfbr2'</span></span><span leaf="">, </span><span><span leaf="">'Tgfb_pathway'</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    [</span><span><span leaf="">'Fgf1'</span></span><span leaf="">, </span><span><span leaf="">'Fgfr1'</span></span><span leaf="">, </span><span><span leaf="">'FGF_pathway'</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    [</span><span><span leaf="">'Fgf1'</span></span><span leaf="">, </span><span><span leaf="">'Fgfr2'</span></span><span leaf="">, </span><span><span leaf="">'FGF_pathway'</span></span><span leaf="">]],dtype=str)</span><span leaf=""><br></span><span leaf="">df_ligrec = pd.DataFrame(data=LR)</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step4. 构建 CCC 网络</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">使用最优传输方法为满足 500 微米空间距离约束的配体-受体对构建 CCC 网络（距离超过 500 米的细胞之间禁止耦合）。 例如，Tgfb1（配体）与 Tgfbr1_Tgfbr2（受体）的点对点矩阵存储在 adata.obsp['commot-user_database-Tgfb1-Tgfbr1_Tgfbr2'] 中。每个配体-受体对的总发送或接收信号分别存储在 adata.obsm['commot-user_database-sum-sender'] 和 adata.obsm['commot-user_database-sum-receiver'] 中。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct.tl.spatial_communication(adata,</span><span leaf=""><br></span><span leaf="">    database_name=</span><span><span leaf="">'user_database'</span></span><span leaf="">, df_ligrec=df_ligrec, dis_thr=</span><span><span leaf="">500</span></span><span leaf="">, heteromeric=</span><span><span leaf="">True</span></span><span leaf="">, pathway_sum=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step5. 可视化</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">pts = adata.obsm[</span><span><span leaf="">'spatial'</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">s = adata.obsm[</span><span><span leaf="">'commot-user_database-sum-sender'</span></span><span leaf="">][</span><span><span leaf="">'s-Fgf1-Fgfr1'</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">r = adata.obsm[</span><span><span leaf="">'commot-user_database-sum-receiver'</span></span><span leaf="">][</span><span><span leaf="">'r-Fgf1-Fgfr1'</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">fig, ax = plt.subplots(</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">2</span></span><span leaf="">, figsize=(</span><span><span leaf="">10</span></span><span leaf="">,</span><span><span leaf="">4</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">0</span></span><span leaf="">].scatter(pts[:,</span><span><span leaf="">0</span></span><span leaf="">], pts[:,</span><span><span leaf="">1</span></span><span leaf="">], c=s, s=</span><span><span leaf="">5</span></span><span leaf="">, cmap=</span><span><span leaf="">'Blues'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">0</span></span><span leaf="">].set_title(</span><span><span leaf="">'Sender'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">1</span></span><span leaf="">].scatter(pts[:,</span><span><span leaf="">0</span></span><span leaf="">], pts[:,</span><span><span leaf="">1</span></span><span leaf="">], c=r, s=</span><span><span leaf="">5</span></span><span leaf="">, cmap=</span><span><span leaf="">'Reds'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">1</span></span><span leaf="">].set_title(</span><span><span leaf="">'Receiver'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img alt="image-20250321214846249" data-imgfileid="100049352" data-ratio="0.44166666666666665" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUbIA2KPewDwEuRx5eXzDBJb0kbZ1YCyp36ZIFjM1ibSuEBl3ickh5PiaUQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUbIA2KPewDwEuRx5eXzDBJb0kbZ1YCyp36ZIFjM1ibSuEBl3ickh5PiaUQ/640?wx_fmt=other&amp;from=appmsg"></span><figcaption><span leaf="">image-20250321214846249</span></figcaption></figure><p data-tool="mdnice编辑器"><strong><span leaf="">可视化信号传导方向</span></strong><span leaf="">将信号传导方向插值为向量场。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct.tl.communication_direction(adata, database_name=</span><span><span leaf="">'user_database'</span></span><span leaf="">, lr_pair=(</span><span><span leaf="">'Fgf1'</span></span><span leaf="">,</span><span><span leaf="">'Fgfr1'</span></span><span leaf="">), k=</span><span><span leaf="">5</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ct.pl.plot_cell_communication(adata, database_name=</span><span><span leaf="">'user_database'</span></span><span leaf="">, lr_pair=(</span><span><span leaf="">'Fgf1'</span></span><span leaf="">,</span><span><span leaf="">'Fgfr1'</span></span><span leaf="">), plot_method=</span><span><span leaf="">'grid'</span></span><span leaf="">, background_legend=</span><span><span leaf="">True</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    scale=</span><span><span leaf="">0.00003</span></span><span leaf="">, ndsize=</span><span><span leaf="">8</span></span><span leaf="">, grid_density=</span><span><span leaf="">0.4</span></span><span leaf="">, summary=</span><span><span leaf="">'sender'</span></span><span leaf="">, background=</span><span><span leaf="">'image'</span></span><span leaf="">, clustering=</span><span><span leaf="">'leiden'</span></span><span leaf="">, cmap=</span><span><span leaf="">'Alphabet'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    normalize_v = </span><span><span leaf="">True</span></span><span leaf="">, normalize_v_quantile=</span><span><span leaf="">0.995</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img alt="image-20250321214906136" data-imgfileid="100049353" data-ratio="1.0029761904761905" data-type="other" data-w="672" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzU67rQ0f4w2g7VB4QVXrwRqTWkeVJjAZnGwc43FZ6tuQoLAVWibjPbwdQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzU67rQ0f4w2g7VB4QVXrwRqTWkeVJjAZnGwc43FZ6tuQoLAVWibjPbwdQ/640?wx_fmt=other&amp;from=appmsg"></span><figcaption><span leaf="">image-20250321214906136</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">或者，根据接收信号的水平绘制方向。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct.pl.plot_cell_communication(adata, database_name=</span><span><span leaf="">'user_database'</span></span><span leaf="">, lr_pair=(</span><span><span leaf="">'Fgf1'</span></span><span leaf="">,</span><span><span leaf="">'Fgfr1'</span></span><span leaf="">), plot_method=</span><span><span leaf="">'grid'</span></span><span leaf="">, background_legend=</span><span><span leaf="">True</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    scale=</span><span><span leaf="">0.00003</span></span><span leaf="">, ndsize=</span><span><span leaf="">8</span></span><span leaf="">, grid_density=</span><span><span leaf="">0.4</span></span><span leaf="">, summary=</span><span><span leaf="">'receiver'</span></span><span leaf="">, background=</span><span><span leaf="">'summary'</span></span><span leaf="">, clustering=</span><span><span leaf="">'leiden'</span></span><span leaf="">, cmap=</span><span><span leaf="">'Reds'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    normalize_v = </span><span><span leaf="">True</span></span><span leaf="">, normalize_v_quantile=</span><span><span leaf="">0.995</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img alt="image-20250321214921482" data-imgfileid="100049354" data-ratio="0.9423929098966026" data-type="other" data-w="677" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzU89cnickOYrzzy6wFQqMc6dgRLMQDEVryrYJ4dY30W9l53zbVS8rTeuQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzU89cnickOYrzzy6wFQqMc6dgRLMQDEVryrYJ4dY30W9l53zbVS8rTeuQ/640?wx_fmt=other&amp;from=appmsg"></span><figcaption><span leaf="">image-20250321214921482</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">COMMOT 分析的结果附加在 anndata 对象中：</span></p><ul><li><section><span leaf="">**adata.uns['commot-user_database-info']**：所使用的配体-受体数据库</span></section></li><li><section><span leaf="">**adata.obsm['commot-user_database-sum-sender']**：每个配体-受体对的发送信号量以及各信号通路的总和</span></section></li><li><section><span leaf="">**adata.obsm['commot-user_database-sum-receiver']**：每个配体-受体对的接收信号量以及各信号通路的总和</span></section></li><li><section><span leaf="">**adata.obsm['commot_sender_vf-user_database-Fgf1-Fgfr1']**：每个点上与发送信号相关的插值信号传导方向</span></section></li><li><section><span leaf="">**adata.obsm['commot_receiver_vf-user_database-Fgf1-Fgfr1']**：每个点上与接收信号相关的插值信号传导方向</span></section></li><li><section><span leaf="">**adata.obsp['commot-user_database-Fgf1-Fgfr1']**：一个稀疏矩阵，其中的元素表示通过 Fgf1-Fgfr1 从一个点到另一个点的 CCC 分数</span></section></li></ul><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""> AnnData object with n_obs × n_vars = 3355 × 32285</span></span><span leaf=""><br></span><span><span leaf="">    obs: 'in_tissue', 'array_row', 'array_col'</span></span><span leaf=""><br></span><span><span leaf="">    var: 'gene_ids', 'feature_types', 'genome'</span></span><span leaf=""><br></span><span><span leaf="">    uns: 'spatial', 'log1p', 'commot-user_database-info'</span></span><span leaf=""><br></span><span><span leaf="">    obsm: 'spatial', 'commot-user_database-sum-sender', 'commot-user_database-sum-receiver', 'commot_sender_vf-user_database-Fgf1-Fgfr1', 'commot_receiver_vf-user_database-Fgf1-Fgfr1'</span></span><span leaf=""><br></span><span><span leaf="">    obsp: 'commot-user_database-Fgf1-Fgfr2', 'commot-user_database-Fgf1-Fgfr1', 'commot-user_database-Tgfb2-Tgfbr1_Tgfbr2', 'commot-user_database-Tgfb3-Tgfbr1_Tgfbr2', 'commot-user_database-Tgfb1-Tgfbr1_Tgfbr2', 'commot-user_database-FGF_pathway', 'commot-user_database-Tgfb_pathway', 'commot-user_database-total-total'</span></span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">二. Visium data example (mouse brain)</span></span><span></span></h3><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf=""> os</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> gc</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> ot</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> pickle</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> anndata</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> scanpy </span><span><span leaf="">as</span></span><span leaf=""> sc</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> pandas </span><span><span leaf="">as</span></span><span leaf=""> pd</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> numpy </span><span><span leaf="">as</span></span><span leaf=""> np</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> scipy </span><span><span leaf="">import</span></span><span leaf=""> sparse</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> scipy.stats </span><span><span leaf="">import</span></span><span leaf=""> spearmanr, pearsonr</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> scipy.spatial </span><span><span leaf="">import</span></span><span leaf=""> distance_matrix</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> matplotlib.pyplot </span><span><span leaf="">as</span></span><span leaf=""> plt</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> commot </span><span><span leaf="">as</span></span><span leaf=""> ct</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">adata = sc.datasets.visium_sge(sample_id=</span><span><span leaf="">'V1_Mouse_Brain_Sagittal_Posterior'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step1. 数据预处理</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">这里需要合理反映分子丰度的非负数值。 我们这里只进行最基础的数据预处理，包括归一化总计数和 log1p 变换。 也可以进行更详细的预处理，例如回归细胞周期基因的影响。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.var_names_make_unique()</span><span leaf=""><br></span><span leaf="">adata.raw = adata</span><span leaf=""><br></span><span leaf="">sc.pp.normalize_total(adata, inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.log1p(adata)</span><span leaf=""><br></span><span leaf="">adata_dis500 = adata.copy()</span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step2. 基本聚类</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">使用常见的 scRNA-seq 数据聚类方法对数据进行基本聚类。 或者，可以使用专门用于空间转录组数据的工具，例如 SpaceFlow</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.pp.highly_variable_genes(adata, min_mean=</span><span><span leaf="">0.0125</span></span><span leaf="">, max_mean=</span><span><span leaf="">3</span></span><span leaf="">, min_disp=</span><span><span leaf="">0.5</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata = adata[:, adata.var.highly_variable]</span><span leaf=""><br></span><span leaf="">sc.tl.pca(adata, svd_solver=</span><span><span leaf="">'arpack'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(adata, n_neighbors=</span><span><span leaf="">10</span></span><span leaf="">, n_pcs=</span><span><span leaf="">40</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata)</span><span leaf=""><br></span><span leaf="">sc.tl.leiden(adata, resolution=</span><span><span leaf="">0.4</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pl.spatial(adata, color=</span><span><span leaf="">'leiden'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><span leaf=""><img alt="image-20250310221142588" data-imgfileid="100049355" data-ratio="0.852" data-type="png" data-w="1000" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzU7E8hPtIcuHq1le7UkammtC1JweLa33DMxn0CeWia0expNYEZZgI178A/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzU7E8hPtIcuHq1le7UkammtC1JweLa33DMxn0CeWia0expNYEZZgI178A/640?wx_fmt=png&amp;from=appmsg"></span><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step3. 空间通信推断</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">这里我们使用 CellChatDB 配体-受体数据库，仅使用分泌信号的 LR 对。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">df_cellchat = ct.pp.ligand_receptor_database(species=</span><span><span leaf="">'mouse'</span></span><span leaf="">, signaling_type=</span><span><span leaf="">'Secreted Signaling'</span></span><span leaf="">, database=</span><span><span leaf="">'CellChat'</span></span><span leaf="">)</span><span><span leaf="">#database=‘CellPhoneDB_v4.0’</span></span><span leaf=""><br></span><span><span leaf="">#df_cellchat = ct.pp.ligand_receptor_database(species='human', signaling_type='Secreted Signaling', database='CellChat')#database=‘CellPhoneDB_v4.0’</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">print(df_cellchat.shape)</span><span leaf=""><br></span><span><span leaf=""># (1209, 4)</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">接下来我们筛选 LR 对，仅保留在至少 5% 的点上同时表达配体和受体的对：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">df_cellchat_filtered = ct.pp.filter_lr_database(df_cellchat, adata_dis500, min_cell_pct=</span><span><span leaf="">0.05</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">print(df_cellchat_filtered.shape)</span><span leaf=""><br></span><span><span leaf=""># (250, 4)</span></span><span leaf=""><br></span><span leaf="">print(df_cellchat_filtered.head())</span><span leaf=""><br></span><span><span leaf="">#       0              1     2                   3</span></span><span leaf=""><br></span><span><span leaf="">#0  Tgfb1  Tgfbr1_Tgfbr2  TGFb  Secreted Signaling</span></span><span leaf=""><br></span><span><span leaf="">#1  Tgfb2  Tgfbr1_Tgfbr2  TGFb  Secreted Signaling</span></span><span leaf=""><br></span><span><span leaf="">#2  Tgfb3  Tgfbr1_Tgfbr2  TGFb  Secreted Signaling</span></span><span leaf=""><br></span><span><span leaf="">#3  Tgfb1  Acvr1b_Tgfbr2  TGFb  Secreted Signaling</span></span><span leaf=""><br></span><span><span leaf="">#4  Tgfb1  Acvr1c_Tgfbr2  TGFb  Secreted Signaling</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">现在对这 250 个配体-受体对进行空间通信推断，空间距离限制为 500。 CellChat 数据库考虑了多聚体单元。 信号传导结果存储在 </span><code><span leaf="">obsp</span></code><span leaf=""> 槽中的点对矩阵中。 例如，通过 LR 对从点 </span><em><span leaf="">i</span></em><span leaf=""> 到点 </span><em><span leaf="">j</span></em><span leaf=""> 的信号传导得分可从</span><code><span leaf="">adata_dis500.obsp['commot-cellchat-Wnt4-Fzd4_Lrp6'][i,j]</span></code><span leaf=""> 中获得。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct.tl.spatial_communication(adata_dis500,</span><span leaf=""><br></span><span leaf="">    database_name=</span><span><span leaf="">'cellchat'</span></span><span leaf="">, df_ligrec=df_cellchat_filtered, dis_thr=</span><span><span leaf="">500</span></span><span leaf="">, heteromeric=</span><span><span leaf="">True</span></span><span leaf="">, pathway_sum=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata_dis500.write(</span><span><span leaf="">"./adata.h5ad"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">确定信号传导方向</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">确定信号传导通路的空间方向，例如 PSAP 通路。 点上信号发送的插值方向和信号接收的插值方向分别存储在</span><code><span leaf="">adata_dis500.obsm['commot_sender_vf-cellchat-PSAP']</span></code><span leaf=""> 和 </span><code><span leaf="">adata_dis500.obsm['commot_receiver_vf-cellchat-PSAP']</span></code><span leaf=""> 中。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct.tl.communication_direction(adata_dis500, database_name=</span><span><span leaf="">'cellchat'</span></span><span leaf="">, pathway_name=</span><span><span leaf="">'PSAP'</span></span><span leaf="">, k=</span><span><span leaf="">5</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ct.pl.plot_cell_communication(adata_dis500, database_name=</span><span><span leaf="">'cellchat'</span></span><span leaf="">, pathway_name=</span><span><span leaf="">'PSAP'</span></span><span leaf="">, plot_method=</span><span><span leaf="">'grid'</span></span><span leaf="">, background_legend=</span><span><span leaf="">True</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    scale=</span><span><span leaf="">0.00003</span></span><span leaf="">, ndsize=</span><span><span leaf="">8</span></span><span leaf="">, grid_density=</span><span><span leaf="">0.4</span></span><span leaf="">, summary=</span><span><span leaf="">'sender'</span></span><span leaf="">, background=</span><span><span leaf="">'image'</span></span><span leaf="">, clustering=</span><span><span leaf="">'leiden'</span></span><span leaf="">, cmap=</span><span><span leaf="">'Alphabet'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    normalize_v = </span><span><span leaf="">True</span></span><span leaf="">, normalize_v_quantile=</span><span><span leaf="">0.995</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">plt.savefig(</span><span><span leaf="">'sample1.PSAP.commot.png'</span></span><span leaf="">,bbox_inches = </span><span><span leaf="">'tight'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><span leaf=""><img alt="image-20250310221310119" data-imgfileid="100049351" data-ratio="0.9922480620155039" data-type="png" data-w="774" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUQD9s1lQicGic27W656AEcjsC66Cib28O3qn4gKrCtAZSaMwibKSMGEexIA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUQD9s1lQicGic27W656AEcjsC66Cib28O3qn4gKrCtAZSaMwibKSMGEexIA/640?wx_fmt=png&amp;from=appmsg"></span><p data-tool="mdnice编辑器"><span leaf="">或者，基于 leiden 聚类可视化PSAP 信号传导通路传导情况，结果存储在</span><code><span leaf="">adata_dis500.uns['commot_cluster-leide¸ˇn-cellchat-PSAP']</span></code><span leaf=""> 中。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata_dis500.obs[</span><span><span leaf="">'leiden'</span></span><span leaf="">] = adata.obs[</span><span><span leaf="">'leiden'</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">ct.tl.cluster_communication(adata_dis500, database_name=</span><span><span leaf="">'cellchat'</span></span><span leaf="">, pathway_name=</span><span><span leaf="">'PSAP'</span></span><span leaf="">, clustering=</span><span><span leaf="">'leiden'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    n_permutations=</span><span><span leaf="">100</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">我们可以将显著的结果可视化为具有自动节点嵌入的网络。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct.pl.plot_cluster_communication_network(adata_dis500, uns_names=[</span><span><span leaf="">'commot_cluster-leiden-cellchat-PSAP'</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    nx_node_pos=</span><span><span leaf="">None</span></span><span leaf="">, nx_bg_pos=</span><span><span leaf="">False</span></span><span leaf="">, p_value_cutoff = </span><span><span leaf="">5e-2</span></span><span leaf="">, filename=</span><span><span leaf="">'PSAP_cluster.pdf'</span></span><span leaf="">, nx_node_cmap=</span><span><span leaf="">'Light24'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img alt="image-20250310222201331" data-imgfileid="100049313" data-ratio="0.3804347826086957" data-type="png" data-w="920" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUZyaSG4lxmFGHG86lQBicP8mrarpzXblpwYx5oiatjAWIMhsSR8d4fGmQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUZyaSG4lxmFGHG86lQBicP8mrarpzXblpwYx5oiatjAWIMhsSR8d4fGmQ/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20250310222201331</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">或者，使用空间节点嵌入。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct.tl.cluster_position(adata_dis500, clustering=</span><span><span leaf="">'leiden'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ct.pl.plot_cluster_communication_network(adata_dis500, uns_names=[</span><span><span leaf="">'commot_cluster-leiden-cellchat-PSAP'</span></span><span leaf="">], clustering=</span><span><span leaf="">'leiden'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    nx_node_pos=</span><span><span leaf="">'cluster'</span></span><span leaf="">, nx_pos_idx=np.array([</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">]), nx_bg_pos=</span><span><span leaf="">True</span></span><span leaf="">, nx_bg_ndsize=</span><span><span leaf="">0.25</span></span><span leaf="">, p_value_cutoff=</span><span><span leaf="">5e-2</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    filename=</span><span><span leaf="">'PSAP_cluster_spatial.pdf'</span></span><span leaf="">, nx_node_cmap=</span><span><span leaf="">'Light24'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><span leaf=""><img alt="image-20250310222236291" data-imgfileid="100049314" data-ratio="0.9254901960784314" data-type="png" data-w="1020" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUAZWdZg27ea6STicEPwsNLaFY06MXnMiciaBZlIwibibSPo9ic0y9go16iaDTw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUAZWdZg27ea6STicEPwsNLaFY06MXnMiciaBZlIwibibSPo9ic0y9go16iaDTw/640?wx_fmt=png&amp;from=appmsg"></span><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">Step4. 下游分析</span></span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">4.1 识别信号传导差异表达基因</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">接下来，我们进一步探究相对于推断的信号传导活性可能存在差异表达的基因。 tradeSeq 将被用于对差异表达基因进行建模。 此分析类似于寻找时间性差异表达基因，只不过将伪时间变量替换为接收信号的量。 需要在 </span><code><span leaf="">adata_dis500.layers['counts']</span></code><span leaf=""> 中提供计数数据。</span></p><p data-tool="mdnice编辑器"><span leaf="">参考文献： Van den Berge, Koen, et al. “Trajectory-based differential expression analysis for single-cell sequencing data.” Nature communications 11.1 (2020): 1-13.</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata_dis500 = sc.read_h5ad(</span><span><span leaf="">"./adata.h5ad"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata = sc.datasets.visium_sge(sample_id=</span><span><span leaf="">'V1_Mouse_Brain_Sagittal_Posterior'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata_dis500.layers[</span><span><span leaf="">'counts'</span></span><span leaf="">] = adata.X</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">寻找与 PSAP 信号传导相关的差异表达基因。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">df_deg, df_yhat = ct.tl.communication_deg_detection(adata_dis500,</span><span leaf=""><br></span><span leaf="">    database_name = </span><span><span leaf="">'cellchat'</span></span><span leaf="">, pathway_name=</span><span><span leaf="">'PSAP'</span></span><span leaf="">, summary = </span><span><span leaf="">'receiver'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf=""> pickle</span><span leaf=""><br></span><span leaf="">deg_result = {</span><span><span leaf="">"df_deg"</span></span><span leaf="">: df_deg, </span><span><span leaf="">"df_yhat"</span></span><span leaf="">: df_yhat}</span><span leaf=""><br></span><span><span leaf="">with</span></span><span leaf=""> open(</span><span><span leaf="">'./deg_PSAP.pkl'</span></span><span leaf="">, </span><span><span leaf="">'wb'</span></span><span leaf="">) </span><span><span leaf="">as</span></span><span leaf=""> handle:</span><span leaf=""><br></span><span leaf="">    pickle.dump(deg_result, handle, protocol=pickle.HIGHEST_PROTOCOL)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">对下游基因进行聚类，并可视化相对于通过 PSAP 通路接收信号水平升高的表达趋势（横轴）。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">with</span></span><span leaf=""> open(</span><span><span leaf="">"./deg_PSAP.pkl"</span></span><span leaf="">, </span><span><span leaf="">'rb'</span></span><span leaf="">) </span><span><span leaf="">as</span></span><span leaf=""> file:</span><span leaf=""><br></span><span leaf="">    deg_result = pickle.load(file)</span><span leaf=""><br></span><span leaf="">df_deg_clus, df_yhat_clus = ct.tl.communication_deg_clustering(df_deg, df_yhat, deg_clustering_res=</span><span><span leaf="">0.4</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">top_de_genes_PSAP = ct.pl.plot_communication_dependent_genes(df_deg_clus, df_yhat_clus, top_ngene_per_cluster=</span><span><span leaf="">5</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    filename=</span><span><span leaf="">'./heatmap_deg_PSAP.pdf'</span></span><span leaf="">, font_scale=</span><span><span leaf="">1.2</span></span><span leaf="">, return_genes=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><span leaf=""><img alt="image-20250310221845550" data-imgfileid="100049316" data-ratio="0.8388888888888889" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzU8glWgHnvKmfyOFVzvErCLGO14UwTQd9VOg3fe3sZBToIOk3z8EopwQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzU8glWgHnvKmfyOFVzvErCLGO14UwTQd9VOg3fe3sZBToIOk3z8EopwQ/640?wx_fmt=png&amp;from=appmsg"></span><p data-tool="mdnice编辑器"><span leaf="">绘制一些示例信号传导差异表达基因。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">X_sc = adata_dis500.obsm[</span><span><span leaf="">'spatial'</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">fig, ax = plt.subplots(</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">3</span></span><span leaf="">, figsize=(</span><span><span leaf="">15</span></span><span leaf="">,</span><span><span leaf="">4</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">colors = adata_dis500.obsm[</span><span><span leaf="">'commot-cellchat-sum-receiver'</span></span><span leaf="">][</span><span><span leaf="">'r-PSAP'</span></span><span leaf="">].values</span><span leaf=""><br></span><span leaf="">idx = np.argsort(colors)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">0</span></span><span leaf="">].scatter(X_sc[idx,</span><span><span leaf="">0</span></span><span leaf="">], X_sc[idx,</span><span><span leaf="">1</span></span><span leaf="">], c=colors[idx], cmap=</span><span><span leaf="">'coolwarm'</span></span><span leaf="">, s=</span><span><span leaf="">10</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">colors = adata_dis500[:,</span><span><span leaf="">'Ctxn1'</span></span><span leaf="">].X.toarray().flatten()</span><span leaf=""><br></span><span leaf="">idx = np.argsort(colors)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">1</span></span><span leaf="">].scatter(X_sc[idx,</span><span><span leaf="">0</span></span><span leaf="">], X_sc[idx,</span><span><span leaf="">1</span></span><span leaf="">], c=colors[idx], cmap=</span><span><span leaf="">'coolwarm'</span></span><span leaf="">, s=</span><span><span leaf="">10</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">colors = adata_dis500[:,</span><span><span leaf="">'Gpr37'</span></span><span leaf="">].X.toarray().flatten()</span><span leaf=""><br></span><span leaf="">idx = np.argsort(colors)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">2</span></span><span leaf="">].scatter(X_sc[idx,</span><span><span leaf="">0</span></span><span leaf="">], X_sc[idx,</span><span><span leaf="">1</span></span><span leaf="">], c=colors[idx], cmap=</span><span><span leaf="">'coolwarm'</span></span><span leaf="">, s=</span><span><span leaf="">10</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">0</span></span><span leaf="">].set_title(</span><span><span leaf="">'Amount of received signal'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">1</span></span><span leaf="">].set_title(</span><span><span leaf="">'An example negative DE gene (Ctxn1)'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ax[</span><span><span leaf="">2</span></span><span leaf="">].set_title(</span><span><span leaf="">'An example positive DE gene (Gpr37)'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img alt="image-20250310221925615" data-imgfileid="100049318" data-ratio="0.32685185185185184" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUrUfmy185zKtUvz6aZznL09cJ3z1qOeAIaGxicSLIHueNYHg0uVTBJibQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUrUfmy185zKtUvz6aZznL09cJ3z1qOeAIaGxicSLIHueNYHg0uVTBJibQ/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20250310221925615</span></figcaption></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">4.2 进一步量化信号传导对差异表达基因的影响</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">上述差异表达分析显示了信号传导与下游基因表达之间的相关性。 现在，我们进一步构建随机森林模型，以潜在的差异表达基因作为目标，将信号传导作为输入，通过特征重要性来量化信号传导的影响。</span></p><p data-tool="mdnice编辑器"><span leaf="">在每个模型中，从 </span><code><span leaf="">top_de_genes_PSAP</span></code><span leaf=""> 中选取一个基因作为预测目标。 通过 PSAP 通路接收信号的水平以及一组“背景基因”作为输入特征。 与预测目标相关性最高的基因被用作“背景基因”。 模型中接收信号的特征重要性反映了在考虑其他相关基因影响的情况下，该信号传导对目标基因的影响。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">df_impact_PSAP = ct.tl.communication_impact(adata_dis500, database_name=</span><span><span leaf="">'cellchat'</span></span><span leaf="">, pathway_name=</span><span><span leaf="">'PSAP'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    tree_combined=</span><span><span leaf="">True</span></span><span leaf="">, method=</span><span><span leaf="">'treebased_score'</span></span><span leaf="">, tree_ntrees=</span><span><span leaf="">100</span></span><span leaf="">, tree_repeat=</span><span><span leaf="">100</span></span><span leaf="">, tree_method=</span><span><span leaf="">'rf'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    ds_genes=top_de_genes_PSAP, bg_genes=</span><span><span leaf="">500</span></span><span leaf="">, normalize=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">将影响评分可视化为热图。 这里在 PSAP 中只有两个 LR 对，我们展示了前 30 个差异表达基因。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct.pl.plot_communication_impact(df_impact_PSAP, summary = </span><span><span leaf="">'receiver'</span></span><span leaf="">, top_ngene= </span><span><span leaf="">30</span></span><span leaf="">, top_ncomm = </span><span><span leaf="">5</span></span><span leaf="">, colormap=</span><span><span leaf="">'coolwarm'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    font_scale=</span><span><span leaf="">1.2</span></span><span leaf="">, linewidth=</span><span><span leaf="">0</span></span><span leaf="">, show_gene_names=</span><span><span leaf="">True</span></span><span leaf="">, show_comm_names=</span><span><span leaf="">True</span></span><span leaf="">, cluster_knn=</span><span><span leaf="">2</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    filename = </span><span><span leaf="">'heatmap_impact_PSAP.pdf'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img alt="image-20250310221938600" data-imgfileid="100049317" data-ratio="0.7972222222222223" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUoNjF3B2omiadRlqZzf0jsRf7CiamIYtCKiclspRb78nRmaPJZ3YUSNFZQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUoNjF3B2omiadRlqZzf0jsRf7CiamIYtCKiclspRb78nRmaPJZ3YUSNFZQ/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20250310221938600</span></figcaption></figure><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">df_impact_PSAP</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img alt="image-20250310222443988" data-imgfileid="100049323" data-ratio="0.225" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUgUE7wPaq8D3oLxicq5OJNxdK8MUkwib2d2RiaHQ5jpQLyOXsjJWdpic5vA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8FJpaiaSLGOQFUXiaEBNEhzUgUE7wPaq8D3oLxicq5OJNxdK8MUkwib2d2RiaHQ5jpQLyOXsjJWdpic5vA/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20250310222443988</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">总体而言，COMMOT 工具的使用较为简便。然而，如何将其有效应用于实际研究中，并围绕生物学问题展开深入解析，则需要借助更多相关文献的阅读与学习，例如</span></p><ul><li><section><span leaf="">PMID: </span><span leaf="">39558136</span></section></li><li><section><span leaf="">PMID: 38503922</span></section></li><li><section><span leaf="">PMID: 39471809</span></section></li></ul></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/k6qUsaDnFghO7AHEMBfNxw",target="_blank" rel="noopener noreferrer">原文链接</a>
