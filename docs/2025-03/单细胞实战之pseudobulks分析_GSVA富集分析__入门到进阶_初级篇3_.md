---
title: "单细胞实战之pseudobulks分析，GSVA富集分析——入门到进阶(初级篇3）"
date: 2025-03-23T16:45:01Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
单细胞实战之pseudobulks分析，GSVA富集分析——入门到进阶(初级篇3） by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>我们在上一讲<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527846&amp;idx=1&amp;sn=5f5addd46277460176b485be5ad2e71b&amp;scene=21#wechat_redirect" textvalue="单细胞实战之样本整理，细胞注释和部分图表绘制---从入门到进阶(初级篇1）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞实战之样本整理，细胞注释和部分图表绘制---从入门到进阶(初级篇1）</a>内容中得到处理好后的数据集，然后一起学习“矫正”数据的三个可选的操作：<span><strong>细胞周期回归矫正，去除双细胞和环境RNA污染，详见：<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527877&amp;idx=1&amp;sn=cd46dbd64bc78ea023468fdd2dd37d46&amp;scene=21#wechat_redirect" textvalue="是否细胞周期矫正，去除双细胞和环境RNA污染——单细胞入门到进阶(初级篇2）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">是否细胞周期矫正，去除双细胞和环境RNA污染——单细胞入门到进阶(初级篇2）</a>，接下来是单细胞实战之pseudobulks分析，GSVA富集分析——入门到进阶(初级篇3）</strong></span></p></blockquote></section><p data-tool="mdnice编辑器"><span>示例数据可以通过网盘下载：</span><span>初级篇1 链接: https://pan.baidu.com/s/1wHZBdYAr6f0H-yMxDZZBHw 提取码: t2vb --来自百度网盘超级会员v4的分享，该数据是延续了上一讲的内容~</span>此外，可以通过向公众号发送关键词‘单细胞’，直接获取Seurat V5版本的完整代码。</p><h4 data-tool="mdnice编辑器"><span></span>差异和富集分析<span></span></h4><p data-tool="mdnice编辑器">差异分析通过识别显著变化的基因，为我们提供了潜在的生物学信息，而通过将这些差异基因与生物学功能进行关联，富集分析进一步帮助我们理解基因在细胞过程中的作用。传统的富集分析方法通常依赖于基因集的统计学显著性，而基因集变异分析（GSVA）作为一种无监督的分析方法，可以基于样本的基因表达数据计算每个样本在某一基因集中的富集度，进而提供更加细致的功能注解。</p><p data-tool="mdnice编辑器">通过将差异分析与pseudobulks结合，我们能够有效地合并单细胞或小样本中的信息，获得更具代表性的群体特征，这对于高变异数据的分析尤其重要。<strong>GSVA在此过程中扮演着至关重要的角色，它可以准确地捕捉不同样本之间的功能差异，揭示潜在的功能性变化，帮助我们深入理解细胞功能的动态变化，推动生物学研究向更深层次发展。</strong></p><h5 data-tool="mdnice编辑器"><span></span>1.pseudobulks分析<span></span></h5><p data-tool="mdnice编辑器">在Seurat官方流程中的Differential expression testing部分中展示了AggregateExpression函数的pseudobulks这差异分析。<span><strong>开发者提到经典的FindMarkers的方法是将每一个细胞看做独立重复，并忽略了源自同一个样品细胞之间的内在相关性，那么这种分析方式已经被多篇文献正式存在假阳性</strong></span><img alt="" data-imgfileid="100044328" data-ratio="0.580091533180778" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNpHoSFHcS3Sfwc5thQLqr09K78nOL9u33TOAQa8IoB1nHuqkXvXScEA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="874" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNpHoSFHcS3Sfwc5thQLqr09K78nOL9u33TOAQa8IoB1nHuqkXvXScEA/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><strong>那么接下来我们也尝试使用大模型来回答两个问题：</strong></p><ol data-tool="mdnice编辑器"><li><section>pseudobulks分析是什么；</section></li><li><section>为什么需要进行 pseudobulks分析</section></li></ol><p data-tool="mdnice编辑器"><strong>大模型给出的回答如下：</strong></p><p data-tool="mdnice编辑器"><strong>什么是 Pseudobulk 分析？</strong></p><p data-tool="mdnice编辑器">在单细胞RNA测序（scRNA-seq）分析中，Pseudobulk分析 是一种将单个细胞的基因表达数据聚合成群体（或称为“伪样本”）的策略。<strong>这一方法将细胞分组（例如，同一细胞类型或同一实验组内的细胞）中的基因表达数据进行汇总，生成一个类似传统RNA测序（bulk RNA-seq）数据的“伪样本”。这些“伪样本”代表了群体内的基因表达模式，可以用于后续的差异表达分析和其他统计分析。</strong></p><p data-tool="mdnice编辑器">Pseudobulk分析的步骤：</p><ol data-tool="mdnice编辑器"><li><section>细胞分组：将单细胞数据按照预定义的标准进行分组，如细胞类型、实验条件、样本组等。</section></li><li><section>表达数据汇总：对于每一组细胞，将同组内所有细胞的基因表达数据加总或平均，形成一个群体层次的表达谱（伪样本）。</section></li><li><section>差异表达分析：对伪样本进行标准的差异表达分析，以识别群体间的基因表达差异。</section></li></ol><p data-tool="mdnice编辑器">为什么需要进行 Pseudobulk 分析？</p><ol data-tool="mdnice编辑器"><li><section>减少单细胞数据的噪声：单细胞RNA测序数据通常会受到技术噪声和批次效应的影响，这会使得基因表达量的测量具有较高的不确定性。通过将同一组细胞的表达数据聚合成伪样本，Pseudobulk分析可以有效降低这些噪声，提高分析的稳定性。</section></li><li><section>提高统计功效：单细胞数据通常由数千甚至数万个细胞组成，而每个细胞的基因表达水平可能有很大的变异，导致差异表达分析的统计功效较低。Pseudobulk分析通过聚合细胞数据，增强了信号与噪声的比率，从而增加了统计分析的功效。</section></li><li><section>克服单细胞RNA-seq的限制：由于单细胞RNA-seq的技术局限性，直接进行单细胞差异表达分析可能会受到较大的噪声干扰，导致结果不够可靠。Pseudobulk分析通过汇总信息，模拟了传统RNA-seq的数据特性，从而使得分析更加稳健。</section></li><li><section>适用于批量处理分析：在处理不同组或不同条件下的大量样本时，Pseudobulk分析可以减少计算资源的消耗，因为它不需要处理成千上万个单细胞数据，而是基于汇总后的数据进行分析。</section></li><li><section>便于后续分析：Pseudobulk数据可以直接与传统的bulk RNA-seq数据进行比较，或者用于与其他组学数据（如表观遗传学、蛋白质组学等）的联合分析。</section></li></ol><p data-tool="mdnice编辑器">总的来说，大模型确实提供了一定价值的回复。那么对于笔者来说，通常会使用这个工具查看不同生物学分组的差异分析结果。比如在今天的数据集中我们就尝试进行左右半结肠的Pseudobulk差异分析。</p><h5 data-tool="mdnice编辑器"><span></span>2.GSVA分析<span></span></h5><p data-tool="mdnice编辑器">至于GSVA分析，我认为不需要细讲了，简单来说就是一种用于评估基因集在不同样本中的活动或富集程度的方法。同时我们也可以多问一个问题，它跟GSEA分析方法有什么区别，让我们来问一下大模型。</p><p data-tool="mdnice编辑器"><strong>大模型给出的回答如下：</strong></p><p data-tool="mdnice编辑器"><strong>主要区别：</strong></p><p data-tool="mdnice编辑器">1.分析对象不同</p><p data-tool="mdnice编辑器">GSEA：评估整个基因集在不同分组的样本之间的富集情况。例如，通过比较肿瘤组与正常组中基因集的富集程度，判断该基因集是否在某一组中显著富集。</p><p data-tool="mdnice编辑器">GSVA：评估每个单个样本中的基因集活动水平。计算每个基因集在每个样本中的活动评分，而不依赖于样本的分组。因此，即使没有预先定义的样本组，GSVA 也可以评估基因集在每个样本中的活跃度。</p><p data-tool="mdnice编辑器">2.样本分组的需求</p><p data-tool="mdnice编辑器">GSEA：需要预定义的样本分组，如疾病组与健康组、不同的临床亚型等。GSEA 计算基因集在这些分组之间的差异，基于每个基因在所有样本中的排序进行分析。</p><p data-tool="mdnice编辑器">GSVA：不需要事先对样本进行分组，它为每个样本计算基因集的评分，从而评估该基因集在单一样本中的表现。适用于没有明确分组标签的数据，如单细胞 RNA-seq 数据。</p><p data-tool="mdnice编辑器">3.评分方式不同</p><p data-tool="mdnice编辑器">GSEA：使用排名统计方法。首先对基因进行排序，然后计算基因集在样本中的富集情况。GSEA 主要关注基因集在样本中的分布，尤其是基因表达水平的排序。</p><p data-tool="mdnice编辑器">GSVA：使用加权排名分数。GSVA 通过评估基因集中的基因在样本中的表达情况，计算一个“活动评分”，反映每个样本中该基因集的活跃程度。</p><p data-tool="mdnice编辑器">4.输出结果不同</p><p data-tool="mdnice编辑器">GSEA：输出基因集在两组样本（或不同分组的样本）之间的显著性差异，通常包括：p 值（p-value）；NES（Normalized Enrichment Score，归一化富集分数）；FDR（False Discovery Rate，假发现率）；GSVA：输出每个基因集在每个样本中的活动评分，这些评分可用于比较不同样本中基因集的表现。</p><p data-tool="mdnice编辑器">5.适用场景</p><p data-tool="mdnice编辑器">GSEA：主要用于已分组的样本（如肿瘤 vs. 正常样本）之间的基因集富集分析。适用于样本组间差异分析，通常应用于疾病研究、临床分型等场景。</p><p data-tool="mdnice编辑器">GSVA：适用于单细胞数据或没有明确分组的样本。GSVA 可在没有组别信息的情况下评估基因集在每个样本中的活动，适合大规模样本数据和细粒度差异分析。</p><p data-tool="mdnice编辑器">感觉对于简单问题，大模型还是能够回答的有模有样。</p><h4 data-tool="mdnice编辑器"><span></span>分析步骤—pseudobulks及后续分析<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>1. 导入<span></span></h5><p data-tool="mdnice编辑器">再次提醒，我们这里用的数据只进行了双胞体+环境RNA污染过滤，很简单的质量控制而已哦。</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(stringr)<br><span>library</span>(patchwork) <br><span>library</span>(ggsci)<br><span>library</span>(ggpubr)<br><span>library</span>(RColorBrewer) <br><span>library</span>(qs)<br>sce.all &lt;- qread(<span>"./4-Corrective-data/sce.all.qs"</span>)<br>colnames(sce.all@meta.data)<br>table(sce.all@meta.data$DF.classifications)<br><span># Singlet </span><br><span># 24080</span><br>range(sce.all@meta.data$contamination)<br><span># [1] 6.286221e-05 1.997864e-01</span><br>dir.create(<span>"5-pseudobulks"</span>)<br>setwd(<span>"5-pseudobulks"</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>1.1 pseudobulks+相关性分析<span></span></h5><p data-tool="mdnice编辑器">现在代码好简单，直接用AggregateExpression或者AverageExpression即可</p><p data-tool="mdnice编辑器">具体内部参数调整可以直接看函数的帮助文档</p><pre data-tool="mdnice编辑器"><span></span><code><span># v4 是 AverageExpression</span><br><span># 设置默认层为 counts（或 data，视需求而定）</span><br><span># 提取想要的数据进行分析</span><br><span># 相关性分析</span><br>av &lt;-AggregateExpression(sce.all,<br>                         group.by = c(<span>"orig.ident"</span>,<span>"celltype"</span>),<br>                         assays = <span>"RNA"</span>,<br>                         <span>#layer = "counts",</span><br>                         return.seurat = <span>FALSE</span>)  <span># 返回总的计数 </span><br>av=as.data.frame(av[[<span>1</span>]])<br>head(av)[<span>1</span>:<span>3</span>,<span>1</span>:<span>3</span>] <span># 可以看到是整数矩阵</span><br><span># GSM5688706-WGC_B cells GSM5688706-WGC_endothelial cells GSM5688706-WGC_epithelial/cancer cells</span><br><span># RP11-34P13.7                      0                                0                                      2</span><br><span># FO538757.2                       29                                4                                    223</span><br><span># AP006222.2                       30                                3                                     94</span><br><span>#write.csv(av,file = 'AverageExpression-0.8.csv')</span><br><br><span># 相关性分析</span><br><span># 找到sd最显著的排名前1000基因</span><br>cg=names(tail(sort(apply(log(av+<span>1</span>), <span>1</span>, sd)),<span>1000</span>)) <br><span># 提前这些基因矩阵并进行log处理后计算不同样本对应的细胞的相关性值</span><br>df =cor(as.matrix(log(av[cg,]+<span>1</span>)))<br>colnames(df)<br>ac=as.data.frame(str_split(colnames(df),<span>'_'</span>,simplify = <span>T</span>))<br>rownames(ac)=colnames(df)<br>ac$V1<br>ac$group = ifelse(grepl(<span>'GSM5688706-WGC|GSM5688707-JCA|GSM5688708-LS-CRC3'</span>,ac$V1),<span>"left"</span>,<span>"right"</span>)<br>table(ac$group)<br>head(ac)<br>pheatmap::pheatmap(df ,<br>                   show_colnames = <span>F</span>,show_rownames = <span>F</span>,<br>                   annotation_col = ac,<br>                   filename = <span>'cor_celltype-vs-orig.ident.pdf'</span> ) <br><span>#dev.off()</span><br>save(av,file = <span>'av_for_pseudobulks.Rdata'</span>)<br></code></pre><p data-tool="mdnice编辑器">检查一下相关性，基本上不同细胞亚群之间区分的挺好的，同时我们也可以看到免疫相关性细胞(B cells, mast cells, plasma, myeloid cells, proliferative cells, T/NK cells), 上皮/癌症细胞(epithelial/cancer cells),  其他细胞(endothelial cells, fibroblasts和VSMCs），分别存在整体的相关性。<span><strong>（就是说免疫和非免疫细胞，在下面的热图里面的层次聚类里面是泾渭分明的隔离了）</strong></span><img alt="" data-imgfileid="100044332" data-ratio="1.000925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNJ3lic0wVLWIJQNskhzUFhAMqv3yLxbr2TC9xJ9fdp8UIk3hwgPXGXmQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNJ3lic0wVLWIJQNskhzUFhAMqv3yLxbr2TC9xJ9fdp8UIk3hwgPXGXmQ/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span>1.2 pseudobulks+主成分分析<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 3.对于每个细胞亚群进行主成分分析##################</span><br>av &lt;-AggregateExpression(sce.all ,<br>                         group.by = c(<span>"orig.ident"</span>,<span>"celltype"</span>),<br>                         assays = <span>"RNA"</span>) <br>av=as.data.frame(av[[<span>1</span>]])<br>df=log(av +<span>1</span>) <br>head(ac)<br>celltp = unique(ac$V2);celltp<br><span>library</span>(patchwork) <br><span>library</span>(<span>"FactoMineR"</span>) <br><span>library</span>(<span>"factoextra"</span>)  <br><span>library</span>(ggstatsplot)<br><span>library</span>(pheatmap)<br>pca_list &lt;- lapply(celltp, <span>function</span>(x){<br>  <span># x=celltp[1]</span><br>  x<br>  <span>#～～～主成分分析图p2～～～</span><br>  exp &lt;- df[,rownames(ac[ac$V2==x,])]  <br>  cg=names(tail(sort(apply(exp, <span>1</span>, sd)),<span>1000</span>)) <br>  exp=exp[cg,]<br>  dat.pca &lt;- PCA(as.data.frame(t(exp)) , graph = <span>FALSE</span>)<br>  group_list=ac[ac$V2==x,<span>'group'</span>]<br>  this_title &lt;- paste0(x,<span>'_PCA'</span>)<br>  p2 &lt;- fviz_pca_ind(dat.pca,<br>                     geom.ind = <span>"point"</span>, <span># show points only (nbut not "text")</span><br>                     col.ind = group_list, <span># color by groups</span><br>                     palette = <span>"Dark2"</span>,<br>                     addEllipses = <span>TRUE</span>, <span># Concentration ellipses</span><br>                     legend.title = <span>"Groups"</span>)+<br>    ggtitle(this_title)+<br>    theme_ggstatsplot()+<br>    theme(plot.title = element_text(size=<span>12</span>,hjust = <span>0.5</span>))<br>  <br>  p2<br>})<br>wrap_plots(pca_list, byrow = <span>T</span>, nrow = <span>2</span> )<br>ggsave(<span>'all_pca.pdf'</span>,width = <span>12</span>,height = <span>6</span>)<br>ggsave(<span>'all_pca.png'</span>,dpi = <span>300</span>,width = <span>12</span>,height = <span>6</span>)<br></code></pre><p data-tool="mdnice编辑器">主成分检查<img alt="" data-imgfileid="100044330" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNQznXDpkQrVLUBz8T1kl0DB7lQxmtx14AfDOAI9T8fwg9Z5hDhvfGog/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNQznXDpkQrVLUBz8T1kl0DB7lQxmtx14AfDOAI9T8fwg9Z5hDhvfGog/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span>1.3 pseudobulks + 差异分析<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>av &lt;-AggregateExpression(sce.all,<br>                         group.by = c(<span>"orig.ident"</span>,<span>"location"</span>),<br>                         assays = <span>"RNA"</span>,<br>                         slot = <span>"counts"</span>,<br>                         return.seurat = <span>FALSE</span>)  <span># 返回总的计数 </span><br>av=as.data.frame(av[[<span>1</span>]])<br>head(av)[<span>1</span>:<span>3</span>,<span>1</span>:<span>3</span>] <span># 可以看到是整数矩阵</span><br><span>#              B cells_left B cells_right endothelial cells_left</span><br><span># RP11-34P13.7            1             1                      1</span><br><span># FO538757.2             47            63                     23</span><br><span># AP006222.2             75            93                     32</span><br><br><span>####### Deseq2</span><br><span>library</span>(tibble)<br><span>library</span>(DESeq2)<br><span># 1. Get counts matrix</span><br>counts_res &lt;- av<br>head(counts_res)<br><span>#               GSM5688706-WGC_left GSM5688707-JCA_left GSM5688708-LS-CRC3_left GSM5688709-RS-CRC1_right GSM5688710-R-CRC3_right</span><br><span># RP11-34P13.7                    6                   6                       9                        3                       3</span><br><span># FO538757.2                    440                 304                     176                      307                     116</span><br><span># AP006222.2                    241                 183                     400                      374                     201</span><br><span># RP4-669L17.10                   5                   0                       4                       15                       0</span><br><span># RP11-206L10.9                  97                  97                      58                       84                      79</span><br><span># LINC00115                     122                  64                     110                       84                      81</span><br><span>#               GSM5688711-R-CRC4_right</span><br><span># RP11-34P13.7                        2</span><br><span># FO538757.2                        280</span><br><span># AP006222.2                        131</span><br><span># RP4-669L17.10                       2</span><br><span># RP11-206L10.9                      57</span><br><span># LINC00115                          43</span><br><br><span># 2. generate sample level metadata</span><br>colData &lt;- data.frame(samples = colnames(counts_res))<br>colData &lt;- colData %&gt;%<br> mutate(condition = ifelse(grepl(<span>'left'</span>, samples), <span>'left'</span>, <span>'right'</span>)) %&gt;%<br> column_to_rownames(var = <span>'samples'</span>)<br><br><span># 3. perform DESeq2 --------</span><br><span># Create DESeq2 object  </span><br>dds &lt;- DESeqDataSetFromMatrix(countData = counts_res,<br>            colData = colData,<br>            design = ~ condition) <span># condition 表示差异分析将基于colData的condition 变量进行</span><br><br><span># filter</span><br>keep &lt;- rowSums(counts(dds)) &gt;=<span>10</span><br>dds &lt;- dds[keep,]<br><span># run DESeq2</span><br>dds &lt;- DESeq(dds)<br><span># Check the coefficients for the comparison</span><br>resultsNames(dds)<br><br><span># Generate results object</span><br>res &lt;- results(dds, name = <span>"condition_right_vs_left"</span>)<br>res<br><span># log2 fold change (MLE): condition right vs left </span><br><span># Wald test p-value: condition right vs left </span><br><span># DataFrame with 19708 rows and 6 columns</span><br><span>#                baseMean log2FoldChange     lfcSE       stat    pvalue      padj</span><br><span>#               &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt;  &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;</span><br><span># RP11-34P13.7    4.65497     -1.1013894  1.292952 -0.8518411  0.394302        NA</span><br><span># FO538757.2    266.24931     -0.2441889  0.504740 -0.4837917  0.628534  0.999255</span><br><span># AP006222.2    245.41566     -0.0125393  0.440271 -0.0284809  0.977279  0.999255</span><br><span># RP4-669L17.10   3.71211      0.7664332  2.178159  0.3518720  0.724934        NA</span><br><span># RP11-206L10.9  79.98878      0.0664181  0.517006  0.1284666  0.897780  0.999255</span><br><span># ...                 ...            ...       ...        ...       ...       ...</span><br><span># NLGN4Y          7.54510        6.49146   3.23272    2.00805 0.0446379  0.822548</span><br><span># TTTY14          6.19086        6.20600   3.36549    1.84401 0.0651814        NA</span><br><span># RP11-424G14.1   6.19086        6.20600   3.36549    1.84401 0.0651814        NA</span><br><span># KDM5D          82.60922       23.13708   3.90737    5.92140        NA        NA</span><br><span># AP001626.2      2.70850        5.01300   3.92520    1.27713 0.2015560        NA</span><br><br>resOrdered &lt;- res[order(res$padj),]<br>head(resOrdered)<br>DEG =as.data.frame(resOrdered)<br>DEG_deseq2 = na.omit(DEG)<br><br><span>#添加上下调信息</span><br>DEG_deseq2 &lt;- DEG_deseq2 %&gt;%<br>  mutate(Type = if_else(padj &gt; <span>0.05</span>, <span>"stable"</span>,<br>                        if_else(abs(log2FoldChange) &lt; <span>1</span>, <span>"stable"</span>,<br>                                if_else(log2FoldChange &gt;= <span>1</span>, <span>"up"</span>, <span>"down"</span>)))) %&gt;%<br>  arrange(desc(abs(log2FoldChange))) %&gt;% rownames_to_column(<span>"Symbol"</span>)<br><span># ggplot绘图</span><br>ggplot(DEG_deseq2, aes(log2FoldChange,-log10(padj))) +<br>  geom_point(size = <span>3.5</span>, alpha = <span>0.8</span>,<br>             aes(color = Type),show.legend = <span>T</span>)  +<br>  scale_color_manual(values = c(<span>"#00468B"</span>, <span>"gray"</span>, <span>"#E64B35"</span>)) +<br>  ylim(<span>0</span>, <span>15</span>) +<br>  xlim(-<span>10</span>, <span>10</span>) +<br>  labs(x = <span>"Log2(fold change)"</span>, y = <span>"-log10(padj)"</span>) +<br>  geom_hline(yintercept = -log10(<span>0.05</span>), linetype = <span>2</span>, color = <span>'black'</span>,lwd=<span>0.8</span>) + <br>  geom_vline(xintercept = c(-<span>1</span>, <span>1</span>), linetype = <span>2</span>, color = <span>'black'</span>,lwd=<span>0.8</span>)+theme_bw()+<br>  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())<br>ggsave(<span>"volcano.pdf"</span>,width = <span>9</span>,height = <span>7</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img alt="" data-imgfileid="100044329" data-ratio="0.7833333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNQp7vj5IxutNSJPicQQ1kicdPCB38OqwAJEIkWjjDwic8up4xWhuIumxsw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNQp7vj5IxutNSJPicQQ1kicdPCB38OqwAJEIkWjjDwic8up4xWhuIumxsw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>分析步骤——GSVA分析<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>1.导入<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>options(stringsAsFactors = <span>F</span>)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(stringr)<br><span>library</span>(ggsci) <br><span>library</span>(patchwork) <br><span>library</span>(ggpubr)<br><span>library</span>(RColorBrewer) <br><span>library</span>(msigdbr)<br><span>library</span>(qs)<br><span>library</span>(GSVA)<br>sce.all &lt;- qread(<span>"./4-Corrective-data/sce.all.qs"</span>)<br>colnames(sce.all@meta.data)<br>dir.create(<span>"6-GSVA"</span>)<br>setwd(<span>"6-GSVA"</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>2.数据预处理<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>sce &lt;- sce.all<br>genesets &lt;- msigdbr(species = <span>"Homo sapiens"</span>, category = <span>"C2"</span>) <br>genesets &lt;- subset(genesets, select = c(<span>"gs_name"</span>,<span>"gene_symbol"</span>)) %&gt;% as.data.frame()<br>genesets &lt;- split(genesets$gene_symbol, genesets$gs_name)<br><span>#  这里的分组会决定接下来的分析哦！</span><br>Idents(sce) &lt;- sce$celltype<br>expr &lt;- AverageExpression(sce, assays = <span>"RNA"</span>, slot = <span>"data"</span>)[[<span>1</span>]]<br>expr &lt;- expr[rowSums(expr)&gt;<span>0</span>,]  <span>#选取非零基因</span><br>expr &lt;- as.matrix(expr)<br>head(expr)<br></code></pre><p data-tool="mdnice编辑器">请注意这里AverageExpression用于计算每个基因在所有细胞中的平均表达值，</p><ol data-tool="mdnice编辑器"><li><section>assays = "RNA"：指定使用哪个assay。在Seurat对象中，一个对象可以包含多个assay（如 RNA、integrated、SCT 等）。这里指定的是 RNA assay，它通常包含基因表达数据。</section></li><li><section>slot = "data"：指定从assay中提取哪个槽（slot）。对于 RNA assay，"data" 槽通常包含标准化后的基因表达值</section></li></ol><h5 data-tool="mdnice编辑器"><span></span>3.GSVA分析<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># gsva默认开启全部线程计算</span><br>gsvaPar &lt;- gsvaParam(expr, genesets,maxDiff = <span>TRUE</span>)<br>gsvaPar <br>gsva.res &lt;- gsva(gsvaPar)<br>dim(gsva.res)<br>head(gsva.res)[<span>1</span>:<span>5</span>,<span>1</span>:<span>5</span>]<br>write.csv(gsva.res,<span>"gsva.res.csv"</span>)<br><br>gsva.df &lt;- data.frame(Genesets=rownames(gsva.res), gsva.res, check.names = <span>F</span>)<br>gsva_d = gsva.res[sample(nrow(gsva.res),<span>30</span>),]<br>pheatmap::pheatmap(gsva_d, show_colnames = <span>T</span>, <br>                   scale = <span>"row"</span>,angle_col = <span>"45"</span>,<br>                   color = colorRampPalette(c(<span>"navy"</span>, <span>"white"</span>, <span>"firebrick3"</span>))(<span>50</span>))<br><br><span>#数据来源是上面的</span><br><span># 气泡图</span><br><span>library</span>(reshape2)<br>gsva_long &lt;- melt(gsva_d, id.vars = <span>"Genesets"</span>)<br><br><span># 创建气泡图</span><br>ggplot(gsva_long, aes(x = Var2, y = Var1, size = value, color = value)) +<br>  geom_point(alpha = <span>0.7</span>) +  <span># 使用散点图层绘制气泡，alpha设置点的透明度</span><br>  scale_size_continuous(range = c(<span>1</span>, <span>6</span>)) +  <span># 设置气泡大小的范围</span><br>  theme_bw() + <br>  scale_color_gradient(low = <span>"#336699"</span>, high =  <span>"tomato"</span>) +<br>  labs(x = <span>"Gene Set"</span>, y = <span>"Sample"</span>, size = <span>"GSVA Score"</span>)+<br>  ggtitle(<span>"GSVA analysis"</span>) +<br>  theme(axis.text.x = element_text(angle = <span>45</span>,vjust = <span>0.5</span>,hjust = <span>0.5</span>),<br>        plot.title = element_text(hjust = <span>0.5</span>))<br>ggsave(<span>'gsva_dot_C2.pdf'</span>,width = <span>10</span>,height = <span>7</span>)<br></code></pre><p data-tool="mdnice编辑器">结果应该不需要重点去解释<img alt="" data-imgfileid="100044331" data-ratio="0.6972222222222222" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNCdwAzoQ6dJg2cvYTUEedS3k9tdBUED7Lo9iaiboxiaPD7MpoiawCw0meSw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjQSNb81YJ5yTpdtwlu7GOvNCdwAzoQ6dJg2cvYTUEedS3k9tdBUED7Lo9iaiboxiaPD7MpoiawCw0meSw/640?wx_fmt=png&amp;from=appmsg"></p><h4 data-tool="mdnice编辑器"><span></span>参考资料：<span></span></h4><ol data-tool="mdnice编辑器"><li><section>Seurat-AggregateExpression：https://satijalab.org/seurat/articles/de_vignette</section></li><li><section>GSVA github：https://github.com/rcastelo/GSVA</section></li><li><section>生信技能树：https://mp.weixin.qq.com/s/jR2OdJQPfBAfxSLSYPyqUw</section></li></ol><p data-tool="mdnice编辑器"><strong>致谢</strong>：感谢曾老师以及生信技能树团队全体成员。更多精彩内容可关注公众号：<strong>生信技能树，单细胞天地，生信菜鸟团</strong>等公众号。</p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。</p><span>- END -</span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/_JrWCJxFBIKypCunR9ey4g",target="_blank" rel="noopener noreferrer">原文链接</a>
