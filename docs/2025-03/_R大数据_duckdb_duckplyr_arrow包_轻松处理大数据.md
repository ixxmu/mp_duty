---
title: "【R大数据】duckdb/duckplyr、arrow包：轻松处理大数据"
date: 2025-03-16T08:33:21Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
【R大数据】duckdb/duckplyr、arrow包：轻松处理大数据 by R语言与数学建模
------
<div><p data-first-child="" data-pid="g7k2dWHT"><span leaf="">上一篇文章，讲了 </span><code><span leaf="">R</span></code><span leaf=""> 中整洁操作 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 数据库的基本方法（有更新，增加了数据库转存，补充在本篇最后）：</span></p><h1><span leaf=""><span textstyle="">【R数据库】duckdb/duckplyr包：整洁操作数据库</span></span></h1><p data-first-child="" data-pid="g7k2dWHT"><span leaf="">https://zhuanlan.zhihu.com/p/23128590178</span></p><p data-pid="oRatJV52"><span leaf="">操作硬盘级的大数据（本篇用 </span><b><span leaf="">37.4 G的纽约出租车数据</span></b><span leaf="">来演示），也是同样的方法，只需要将数据表写入数据库，改成从数据文件（</span><code><span leaf="">Parquet</span></code><span leaf=""> 或 </span><code><span leaf="">CSV</span></code><span leaf=""> 等）注册到数据库。</span></p><p data-pid="hofyyEZ_"><span leaf="">加载包：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">tidyverse</span></span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">tictoc</span></span><span><span leaf="">)</span></span><span leaf="">          </span><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">计时用</span></span></code></pre><hr><h2 data-into-catalog-status=""><span leaf="">5 R 处理大数据</span></h2><p data-pid="pb8DqIbz"><span leaf="">我的电脑配置：12代i9，32G内存。</span></p><h3 data-into-catalog-status=""><span leaf="">5.1 准备大数据</span></h3><p data-pid="Eik-fKCF"><span leaf="">2012-2021年纽约出租车数据（37.4 G），使用下面代码可以快速（几分钟）下载到本地：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">arrow</span></span><span><span leaf="">)</span></span><br><span><span leaf="">open_dataset</span></span><span><span leaf="">(</span></span><span><span leaf="">"s3://voltrondata-labs-datasets/nyc-taxi"</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">filter</span></span><span><span leaf="">(</span></span><span><span leaf="">year</span></span><span leaf=""> </span><span><span leaf="">%</span></span><span><span leaf="">in</span></span><span><span leaf="">%</span></span><span leaf=""> </span><span><span leaf="">2012</span></span><span><span leaf="">:</span></span><span><span leaf="">2021</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">write_dataset</span></span><span><span leaf="">(</span></span><span><span leaf="">"data/nyc-taxi"</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">partitioning</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">c</span></span><span><span leaf="">(</span></span><span><span leaf="">"year"</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">"month"</span></span><span><span leaf="">))</span></span></code></pre><p data-pid="YWgXkkMM"><span leaf="">看一下，是按 </span><code><span leaf="">Hive-</span></code><span leaf="">风格存放的 </span><code><span leaf="">Parquet</span></code><span leaf=""> 格式：</span></p><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002886" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJmVibMHR1mr0Degp4KXp0P3k5xw1ONRsH7vENowVCJuMCV9TQz0AqVNA/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="942" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJmVibMHR1mr0Degp4KXp0P3k5xw1ONRsH7vENowVCJuMCV9TQz0AqVNA/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><p><span leaf=""><br></span></p><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002885" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJ89UWWx4rq9Pe0Y2ojwZOWwHmLJib6gspMudvCgicsYcdr7ow2gQS1lvg/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="814" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJ89UWWx4rq9Pe0Y2ojwZOWwHmLJib6gspMudvCgicsYcdr7ow2gQS1lvg/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002903" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJo3hJNcjdUD3EGLd8FfPXIqelsmcnAMV62fSIbykFh1UclhPsgqyCLQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="1039" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJo3hJNcjdUD3EGLd8FfPXIqelsmcnAMV62fSIbykFh1UclhPsgqyCLQ/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002899" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJsXDic2Ma6uckVZtwiaEubyJbrIfjibmW2CuammPzA6MA5HjzMBlFLcicNQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="652" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJsXDic2Ma6uckVZtwiaEubyJbrIfjibmW2CuammPzA6MA5HjzMBlFLcicNQ/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><section nodeleaf=""><img data-imgfileid="100002905" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJhhHVicGsCWdM9rFwXj7MuqrduXibhuelsnnMOY7Pmic2ib35FY1PAdvjTg/640?wx_fmt=png&amp;from=appmsg" data-type="png" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJhhHVicGsCWdM9rFwXj7MuqrduXibhuelsnnMOY7Pmic2ib35FY1PAdvjTg/640?wx_fmt=png&amp;from=appmsg"></section><p data-pid="cPivxion"><span leaf=""><br></span></p><section nodeleaf=""><img data-imgfileid="100002904" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJg6gGGtic33iaUrgYNhCOGe2rzuonFXOiaNZIs4W3z9r5WjtNUoIh0mjNg/640?wx_fmt=png&amp;from=appmsg" data-type="png" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJg6gGGtic33iaUrgYNhCOGe2rzuonFXOiaNZIs4W3z9r5WjtNUoIh0mjNg/640?wx_fmt=png&amp;from=appmsg"></section><p data-pid="cPivxion"><span leaf=""><br></span></p><p data-pid="cPivxion"><span leaf="">先用 </span><code><span leaf="">arrow</span></code><span leaf=""> 包读取这个数据集看看：</span></p><pre><code><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">open_dataset</span></span><span><span leaf="">(</span></span><span><span leaf="">"data/nyc-taxi"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">nyc</span></span><br><span><span leaf="">nrow</span></span><span><span leaf="">(</span></span><span><span leaf="">nyc</span></span><span><span leaf="">)</span></span><span leaf=""> </span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002900" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJ9iaicWVnkpKxR3fpXlymRabuLScNEMbYNQSUiaL4GTibTIYkf02nEfMfsg/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="650" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJ9iaicWVnkpKxR3fpXlymRabuLScNEMbYNQSUiaL4GTibTIYkf02nEfMfsg/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002907" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJaic14bk59leCpNqarS2QobyDAmFLNjBDOWEfKjb1EdMkd33kQIfaZXA/640?wx_fmt=png&amp;from=appmsg" data-type="png" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJaic14bk59leCpNqarS2QobyDAmFLNjBDOWEfKjb1EdMkd33kQIfaZXA/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf=""><br></span></section><section nodeleaf=""><img data-imgfileid="100002887" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJ0TdDvn27x782ZHcrtVGIBF6fFNWmxcVcLicqibicicQ00FelIaWFDIfaJg/640?wx_fmt=png&amp;from=appmsg" data-type="png" width="227" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJ0TdDvn27x782ZHcrtVGIBF6fFNWmxcVcLicqibicicQ00FelIaWFDIfaJg/640?wx_fmt=png&amp;from=appmsg"></section></figure><p data-pid="TEX224S9"><span leaf="">你没看错，这个数据集总共有 </span><b><span leaf="">11.5 亿行，24 列！</span></b></p><p data-pid="JOOpZPvZ"><span leaf="">顺便说一下，</span><code><span leaf="">arrow</span></code><span leaf=""> 包的一大好用功能是</span><b><span leaf="">数据分区读写，</span></b><span leaf="">支持写出到 "parquet"，"feather", "arrow", "ipc", "csv", "tsv", "txt", "text" 文件。</span></p><p data-pid="5PglShs4"><span leaf="">比如，当前 </span><code><span leaf="">nyc</span></code><span leaf=""> 对象是从按 </span><code><span leaf="">年-月</span></code><span leaf=""> 分区读取进来的，可以选择列，再只按</span><code><span leaf="">年</span></code><span leaf="">分区写出到 </span><code><span leaf="">Parquet</span></code><span leaf=""> 文件集：</span></p><pre><code><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><span leaf=""> </span><br><span leaf="">  </span><span><span leaf="">select</span></span><span><span leaf="">(</span></span><span><span leaf="">vendor_name</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">passenger_count</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><span leaf=""> </span><br><span leaf="">  </span><span><span leaf="">write_dataset</span></span><span><span leaf="">(</span></span><span><span leaf="">"data/nyc-taxi2"</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">format</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"parquet"</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">partitioning</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"year"</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="FX_E9lu7"><b><span leaf="">注：</span></b><span leaf="">也可以不用 </span><code><span leaf="">partitioning</span></code><span leaf=""> 参数，直接对数据做 </span><code><span leaf="">group_by()</span></code><span leaf=""> 再写出；除了按分组变量分区写出，还可以按最大文件数（参数</span><code><span leaf="">max_partitions</span></code><span leaf="">）、每个文件最大行数（参数</span><code><span leaf="">max_rows_per_file</span></code><span leaf="">）分区写出到文件 。</span></p><blockquote><section><span leaf="">数据分区的建议：(1) 避免文件小于 20MB 或大于 2GB；(2) 避免超过 10,000 个文件；(3) 在 </span><code><span leaf="">filter()</span></code><span leaf=""> 中使用的变量上进行分区（后续数据操作速度更快）。</span></section></blockquote><p data-pid="K_rqNxPs"><span leaf="">下面用不同的 </span><code><span leaf="">R</span></code><span leaf=""> 工具包来操作它，如开篇所说，与上一篇操作小数据集的基本方法一样，各种 </span><code><span leaf="">dplyr</span></code><span leaf=""> 函数也都一样用法，所以，只展示一个管道操作即可：</span></p><p data-pid="I6T1UJ-l"><b><span leaf="">问题：</span></b><span leaf="">每年有多少比例的出租车载客量超过 1 人？</span></p><h3 data-into-catalog-status=""><span leaf="">5.2 使用 </span><code><span leaf="">dubkdb/duckplyr</span></code><span leaf=""> 包</span></h3><p data-pid="jDbM7Rdl"><b><span leaf="">方法1：</span></b><code><span leaf="">dbplyr</span></code><span leaf=""> 包：执行 </span><code><span leaf="">dplyr</span></code><span leaf=""> 数据操作</span></p><p data-pid="VnvOnO2t"><span leaf="">建立 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 连接，将 </span><code><span leaf="">Parquet</span></code><span leaf=""> 数据集注册虚拟表：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">)</span></span><span leaf="">              </span><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">自动加载DBI包</span></span><br><span><span leaf="">con</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">dbConnect</span></span><span><span leaf="">(</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">(),</span></span><span leaf=""> </span><span><span leaf="">dbdir</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"nyc.duckdb"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">tbl</span></span><span><span leaf="">(</span></span><span><span leaf="">con</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">"read_parquet('data/nyc-taxi/*/*/*.parquet', hive_partitioning = true)"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">nyc</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJDSxRGxVCiaicqG5nlJxQBMJSJasE8armwe3XfQjPt2g5mats9th8aMow/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="1296" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJDSxRGxVCiaicqG5nlJxQBMJSJasE8armwe3XfQjPt2g5mats9th8aMow/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><p data-pid="tP6Jz9ax"><b><span leaf="">注：</span></b><span leaf="">用 </span><code><span leaf="">nyc=tbl(con,"data/nyc-taxi/*/*/*.parquet")</span></code><span leaf=""> 也行, 但是使用 </span><code><span leaf="">read_parquet()</span></code><span leaf=""> 更安全。</span></p><p data-pid="Brzy21IF"><span leaf="">执行数据操作：</span></p><pre><code><span><span leaf="">tic</span></span><span><span leaf="">()</span></span><br><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><span leaf=""> </span><br><span leaf="">  </span><span><span leaf="">summarise</span></span><span><span leaf="">(</span></span><br><span leaf="">    </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">n</span></span><span><span leaf="">(),</span></span><br><span leaf="">    </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">sum</span></span><span><span leaf="">(</span></span><span><span leaf="">as</span></span><span><span leaf="">.</span></span><span><span leaf="">integer</span></span><span><span leaf="">(</span></span><span><span leaf="">passenger_count</span></span><span leaf=""> </span><span><span leaf="">&gt;</span></span><span leaf=""> </span><span><span leaf="">1</span></span><span><span leaf="">),</span></span><span leaf=""> </span><span><span leaf="">na</span></span><span><span leaf="">.</span></span><span><span leaf="">rm</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">TRUE</span></span><span><span leaf="">),</span></span><span leaf=""> </span><br><span leaf="">    </span><span><span leaf="">.</span></span><span><span leaf="">by</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">mutate</span></span><span><span leaf="">(</span></span><span><span leaf="">pct_shared</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">/</span></span><span leaf=""> </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">*</span></span><span leaf=""> </span><span><span leaf="">100</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">arrange</span></span><span><span leaf="">(</span></span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><span leaf=""> </span><br><span leaf="">  </span><span><span leaf="">collect</span></span><span><span leaf="">()</span></span><span leaf=""> </span><br><span><span leaf="">toc</span></span><span><span leaf="">()</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002901" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJKkvnNUwocr4ia5PBVXml4KgIJT6wkiaL64tRJqn2pdsVeuSfQT1PLNAQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="680" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJKkvnNUwocr4ia5PBVXml4KgIJT6wkiaL64tRJqn2pdsVeuSfQT1PLNAQ/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002906" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJPzkRZeJ31POicLUrQeL4t5LibazydeibchEg2pKgkKfwgq4lZowm3Nocg/640?wx_fmt=png&amp;from=appmsg" data-type="png" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJPzkRZeJ31POicLUrQeL4t5LibazydeibchEg2pKgkKfwgq4lZowm3Nocg/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf=""><br></span></section><section nodeleaf=""><img data-imgfileid="100002888" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJj5H7t6BVeoWIviccgdCVMl38F3K23oC91gtwNDqYTnM4rKYMJVe6hyA/640?wx_fmt=png&amp;from=appmsg" data-type="png" width="258" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJj5H7t6BVeoWIviccgdCVMl38F3K23oC91gtwNDqYTnM4rKYMJVe6hyA/640?wx_fmt=png&amp;from=appmsg"></section></figure><p data-pid="VlkA5DA5"><b><span leaf="">耗时 5 秒半！</span></b></p><p data-pid="nso0i3hI"><span leaf="">关闭连接：</span></p><pre><code><span><span leaf="">dbDisconnect</span></span><span><span leaf="">(</span></span><span><span leaf="">con</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="9gnUyHhA"><b><span leaf="">方法2：</span></b><span leaf="">DBI 包：duckdb + SQL 查询</span></p><p data-pid="dWgUM3qO"><span leaf="">建立 DuckDB 连接：</span></p><pre><code><span><span leaf="">con</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">dbConnect</span></span><span><span leaf="">(</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">(),</span></span><span leaf=""> </span><span><span leaf="">dbdir</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"nyc.duckdb"</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="26LXQyQi"><span leaf="">写 </span><code><span leaf="">SQL</span></code><span leaf=""> 查询代码，我也不会写这么复杂的，直接用方法 1 中的 </span><code><span leaf="">dplyr</span></code><span leaf=""> 代码接 </span><code><span leaf="">show_query()</span></code><span leaf=""> 生成（由</span><code><span leaf="">dbplyr</span></code><span leaf=""> 翻译）：</span></p><pre><code><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><span leaf=""> </span><br><span leaf="">  </span><span><span leaf="">summarise</span></span><span><span leaf="">(</span></span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">n</span></span><span><span leaf="">(),</span></span><br><span leaf="">            </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">sum</span></span><span><span leaf="">(</span></span><span><span leaf="">as</span></span><span><span leaf="">.</span></span><span><span leaf="">integer</span></span><span><span leaf="">(</span></span><span><span leaf="">passenger_count</span></span><span leaf=""> </span><span><span leaf="">&gt;</span></span><span leaf=""> </span><span><span leaf="">1</span></span><span><span leaf="">),</span></span><span leaf=""> </span><span><span leaf="">na</span></span><span><span leaf="">.</span></span><span><span leaf="">rm</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">TRUE</span></span><span><span leaf="">),</span></span><span leaf=""> </span><br><span leaf="">            </span><span><span leaf="">.</span></span><span><span leaf="">by</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">mutate</span></span><span><span leaf="">(</span></span><span><span leaf="">pct_shared</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">/</span></span><span leaf=""> </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">*</span></span><span leaf=""> </span><span><span leaf="">100</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">arrange</span></span><span><span leaf="">(</span></span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">show_query</span></span><span><span leaf="">()</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002902" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJDIrZm6bPicWByShTu5QfodMZzoibC3Wtu27xxYWUBJHICpDeB8GrST6g/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="1012" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJDIrZm6bPicWByShTu5QfodMZzoibC3Wtu27xxYWUBJHICpDeB8GrST6g/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><section nodeleaf=""><img data-imgfileid="100002908" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJeULuxVod6bJIhObYVKWaoPOdv1TwqnAEeeIhV6owQGBuwMbJaZUaaQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJeULuxVod6bJIhObYVKWaoPOdv1TwqnAEeeIhV6owQGBuwMbJaZUaaQ/640?wx_fmt=png&amp;from=appmsg"></section><p data-pid="4m0C4mEL"><span leaf="">定义查询，原样复制粘贴，套个 </span><code><span leaf="">r"(...)"</span></code></p><pre><code><span><span leaf="">q</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">r</span></span><span><span leaf="">"(</span><br></span><span><span leaf="">SELECT q01.*, (shared_trips / all_trips) * 100.0 AS pct_shared</span><br></span><span><span leaf="">FROM (</span><br></span><span><span leaf="">  SELECT</span><br></span><span><span leaf="">    "</span></span><span><span leaf="">year</span></span><span><span leaf="">",</span><br></span><span><span leaf="">    COUNT(*) AS all_trips,</span><br></span><span><span leaf="">    SUM(CAST(passenger_count &gt; 1.0 AS INTEGER)) AS shared_trips</span><br></span><span><span leaf="">  FROM (</span><br></span><span><span leaf="">FROM read_parquet('data/nyc-taxi/*/*/*.parquet', </span><br></span><span><span leaf="">          hive_partitioning = true)</span><br></span><span><span leaf="">  ) q01</span><br></span><span><span leaf="">  GROUP BY "</span></span><span><span leaf="">year</span></span><span><span leaf="">"</span><br></span><span><span leaf="">) q01</span><br></span><span><span leaf="">ORDER BY "</span></span><span><span leaf="">year</span></span><span><span leaf="">"</span><br></span><span><span leaf="">)"</span></span></code></pre><p data-pid="uGFctZZX"><span leaf="">执行查询：</span></p><pre><code><span><span leaf="">tic</span></span><span><span leaf="">()</span></span><br><span><span leaf="">dbGetQuery</span></span><span><span leaf="">(</span></span><span><span leaf="">con</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">q</span></span><span><span leaf="">)</span></span><br><span><span leaf="">toc</span></span><span><span leaf="">()</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002893" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJ63EfrgkpZYzNjuGYXX4kpicCALicRxD25ghokBuv1n8NcrnyOPJxrjYA/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="681" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJ63EfrgkpZYzNjuGYXX4kpicCALicRxD25ghokBuv1n8NcrnyOPJxrjYA/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002891" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJsIakjskx3GeJ1icU9ElzXwu1bKPD5AIaKOSE8UPZGrsKWnFOQfibrrBg/640?wx_fmt=png&amp;from=appmsg" data-type="png" width="260" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJsIakjskx3GeJ1icU9ElzXwu1bKPD5AIaKOSE8UPZGrsKWnFOQfibrrBg/640?wx_fmt=png&amp;from=appmsg"></section></figure><p data-pid="YhOwQhk5"><b><span leaf="">耗时 5 秒多点！</span></b></p><p data-pid="sacnbCza"><span leaf="">关闭连接：</span></p><pre><code><span><span leaf="">dbDisconnect</span></span><span><span leaf="">(</span></span><span><span leaf="">con</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="jb_qnwqJ"><b><span leaf="">方法3：</span></b><code><span leaf="">duckplyr</span></code><span leaf=""> 包：代替 </span><code><span leaf="">dplyr</span></code><span leaf=""> 包</span></p><p data-pid="0pFrxvwt"><span leaf="">从 </span><code><span leaf="">Parquet</span></code><span leaf=""> 文件读取数据：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">duckplyr</span></span><span><span leaf="">)</span></span><br><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">read_parquet_duckdb</span></span><span><span leaf="">(</span></span><span><span leaf="">"data/nyc-taxi/*/*/*.parquet"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">nyc</span></span><span leaf=""> </span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002894" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJZMFzujiaJYiagBNLhcssgzttiaNMfGk9CUIEHicicMgkicRLZRooVdAicE6KQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="1138" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJZMFzujiaJYiagBNLhcssgzttiaNMfGk9CUIEHicicMgkicRLZRooVdAicE6KQ/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><p data-pid="yktxJiYG"><span leaf="">正常做数据操作：</span></p><pre><code><span><span leaf="">tic</span></span><span><span leaf="">()</span></span><br><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">summarise</span></span><span><span leaf="">(</span></span><br><span leaf="">    </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">n</span></span><span><span leaf="">(),</span></span><br><span leaf="">    </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">sum</span></span><span><span leaf="">(</span></span><span><span leaf="">as</span></span><span><span leaf="">.</span></span><span><span leaf="">integer</span></span><span><span leaf="">(</span></span><span><span leaf="">passenger_count</span></span><span leaf=""> </span><span><span leaf="">&gt;</span></span><span leaf=""> </span><span><span leaf="">1</span></span><span><span leaf="">),</span></span><span leaf=""> </span><span><span leaf="">na</span></span><span><span leaf="">.</span></span><span><span leaf="">rm</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">TRUE</span></span><span><span leaf="">),</span></span><br><span leaf="">    </span><span><span leaf="">.</span></span><span><span leaf="">by</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">mutate</span></span><span><span leaf="">(</span></span><span><span leaf="">pct_shared</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">/</span></span><span leaf=""> </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">*</span></span><span leaf=""> </span><span><span leaf="">100</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">collect</span></span><span><span leaf="">()</span></span><br><span><span leaf="">toc</span></span><span><span leaf="">()</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002892" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJiaKtqZIicYqiaFMKfNTzN8PhcPb4XQJ4eib1KGWgu4jQjiccwe1kd8GCVibw/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="676" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJiaKtqZIicYqiaFMKfNTzN8PhcPb4XQJ4eib1KGWgu4jQjiccwe1kd8GCVibw/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002890" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJOOJy4FhyMeJameO53iaRGTOfx6y6VrNQnQdgv05kjewdW6akZdziagrw/640?wx_fmt=png&amp;from=appmsg" data-type="png" width="268" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJOOJy4FhyMeJameO53iaRGTOfx6y6VrNQnQdgv05kjewdW6akZdziagrw/640?wx_fmt=png&amp;from=appmsg"></section></figure><p data-pid="h1gIdbrn"><b><span leaf="">耗时 5 秒半！</span></b></p><h3 data-into-catalog-status=""><span leaf="">5.3 使用 </span><code><span leaf="">arrow</span></code><span leaf=""> 包</span></h3><p data-pid="B-UfAckn"><b><span leaf="">方法 4：</span></b><span leaf="">直接使用 </span><code><span leaf="">arrow</span></code><span leaf=""> 包</span></p><p data-pid="Ed-T379H"><span leaf="">支持直接对逻辑值求和，会自动排好序，所以可以少套一个 </span><code><span leaf="">as.integer()</span></code><span leaf="">和节省一句 </span><code><span leaf="">arrange()</span></code><span leaf="">：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">arrow</span></span><span><span leaf="">)</span></span><br><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">open_dataset</span></span><span><span leaf="">(</span></span><span><span leaf="">"data/nyc-taxi"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">tic</span></span><span><span leaf="">()</span></span><br><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">summarise</span></span><span><span leaf="">(</span></span><br><span leaf="">    </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">n</span></span><span><span leaf="">(),</span></span><br><span leaf="">    </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">sum</span></span><span><span leaf="">(</span></span><span><span leaf="">passenger_count</span></span><span leaf=""> </span><span><span leaf="">&gt;</span></span><span leaf=""> </span><span><span leaf="">1</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">na</span></span><span><span leaf="">.</span></span><span><span leaf="">rm</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">TRUE</span></span><span><span leaf="">),</span></span><br><span leaf="">    </span><span><span leaf="">.</span></span><span><span leaf="">by</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">mutate</span></span><span><span leaf="">(</span></span><span><span leaf="">pct_shared</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">/</span></span><span leaf=""> </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">*</span></span><span leaf=""> </span><span><span leaf="">100</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">collect</span></span><span><span leaf="">()</span></span><br><span><span leaf="">toc</span></span><span><span leaf="">()</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002897" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJAJYQoUsTWw0S6NzMlxPmDI1HKhOaLjYhx8XWQVzkCoFh1t0k5JHFZw/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="684" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJAJYQoUsTWw0S6NzMlxPmDI1HKhOaLjYhx8XWQVzkCoFh1t0k5JHFZw/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002895" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJlXa4HXJzR1CfkR7U1jfLibqsoUicBpwZzYdnU6AkL4libu0uP9eSpMbFg/640?wx_fmt=png&amp;from=appmsg" data-type="png" width="285" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJlXa4HXJzR1CfkR7U1jfLibqsoUicBpwZzYdnU6AkL4libu0uP9eSpMbFg/640?wx_fmt=png&amp;from=appmsg"></section></figure><p data-pid="wae5y3et"><b><span leaf="">耗时 11 秒左右！</span></b></p><p data-pid="Sy1GphR3"><b><span leaf="">方法 5：</span></b><span leaf="">另一种用法是，用 </span><code><span leaf="">to_duckdb()</span></code><span leaf=""> 将 </span><code><span leaf="">Arrow</span></code><span leaf=""> 对象转化为 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 惰性表，再在 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 中完成操作：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">)</span></span><br><span><span leaf="">tic</span></span><span><span leaf="">()</span></span><br><span><span leaf="">nyc</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">to_duckdb</span></span><span><span leaf="">()</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><span leaf="">           </span><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">关键步骤</span></span><br><span leaf="">  </span><span><span leaf="">summarise</span></span><span><span leaf="">(</span></span><br><span leaf="">    </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">n</span></span><span><span leaf="">(),</span></span><br><span leaf="">    </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">sum</span></span><span><span leaf="">(</span></span><span><span leaf="">as</span></span><span><span leaf="">.</span></span><span><span leaf="">integer</span></span><span><span leaf="">(</span></span><span><span leaf="">passenger_count</span></span><span leaf=""> </span><span><span leaf="">&gt;</span></span><span leaf=""> </span><span><span leaf="">1</span></span><span><span leaf="">),</span></span><span leaf=""> </span><span><span leaf="">na</span></span><span><span leaf="">.</span></span><span><span leaf="">rm</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">TRUE</span></span><span><span leaf="">),</span></span><br><span leaf="">    </span><span><span leaf="">.</span></span><span><span leaf="">by</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">mutate</span></span><span><span leaf="">(</span></span><span><span leaf="">pct_shared</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">shared_trips</span></span><span leaf=""> </span><span><span leaf="">/</span></span><span leaf=""> </span><span><span leaf="">all_trips</span></span><span leaf=""> </span><span><span leaf="">*</span></span><span leaf=""> </span><span><span leaf="">100</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">arrange</span></span><span><span leaf="">(</span></span><span><span leaf="">year</span></span><span><span leaf="">)</span></span><span leaf=""> </span><span><span leaf="">|</span></span><span><span leaf="">&gt;</span></span><br><span leaf="">  </span><span><span leaf="">collect</span></span><span><span leaf="">()</span></span><br><span><span leaf="">toc</span></span><span><span leaf="">()</span></span></code></pre><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002896" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJyicSk5VAgQ5mXYD5jgUKUr7veA1UdQCrAplx4J689ia5M7wkMn0ehYLQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" width="261" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJyicSk5VAgQ5mXYD5jgUKUr7veA1UdQCrAplx4J689ia5M7wkMn0ehYLQ/640?wx_fmt=png&amp;from=appmsg"></section></figure><p data-pid="TgTa4V6l"><span leaf="">结果数据框同上（略），</span><b><span leaf="">耗时不到 6 秒！</span></b></p><p data-pid="3GWABMHd"><span leaf="">另外，</span><code><span leaf="">to_arrow()</span></code><span leaf=""> 可用来从 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 连接创建 </span><code><span leaf="">Arrow</span></code><span leaf=""> 对象。</span></p><p data-pid="TTXI-amb"><b><span leaf="">说明：</span></b><span leaf="">本来还想写一下用 </span><code><span leaf="">polars</span></code><span leaf=""> 包 和 </span><code><span leaf="">tidypolars</span></code><span leaf=""> 包的实现，结果直接给 </span><code><span leaf="">RStudio</span></code><span leaf=""> 干崩溃了，看来是不适合硬盘级的大数据，就不写它俩了。</span></p><h2 data-into-catalog-status=""><span leaf="">6 如何选择 R 大数据工具？</span></h2><p data-pid="mrBi0VNu"><span leaf="">以下总结来自 </span><code><span leaf="">Qwen2.5-Max</span></code><span leaf="">：</span></p><p data-pid="hslzLs76"><b><span leaf="">如何选择？</span></b></p><figure data-size="normal"><section nodeleaf=""><img data-imgfileid="100002898" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJkCVMOqAto0wBBZ9NaS6OHqS5HPJM90WZXDul2IrKSfibrbMTvNXibbcA/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" width="1698" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWDR5XhZyNngJwYJJz9ZDGMJkCVMOqAto0wBBZ9NaS6OHqS5HPJM90WZXDul2IrKSfibrbMTvNXibbcA/640?wx_fmt=jpeg&amp;from=appmsg"></section></figure><p data-pid="bWWlOiKY"><b><span leaf="">总结建议</span></b></p><p data-pid="g_wWrIYT"><span leaf="">1. 选择 </span><code><span leaf="">duckdb / duckplyr</span></code><span leaf="">：</span></p><p data-pid="Npcb2q85"><span leaf="">- 如果你需要处理大规模数据，并且希望利用 </span><code><span leaf="">SQL</span></code><span leaf=""> 或 </span><code><span leaf="">dplyr</span></code><span leaf=""> 接口进行分析。</span></p><p data-pid="QIv0-Cwt"><span leaf="">- 示例场景：分析 TB 级别的日志数据，或直接查询 </span><code><span leaf="">Parquet</span></code><span leaf=""> 文件。</span></p><p data-pid="dGUQLkgx"><span leaf="">2. 选择 </span><code><span leaf="">polars / tidypolars</span></code><span leaf="">：</span></p><p data-pid="PQxnDhSN"><span leaf="">- 如果你需要高性能的数据处理，并且希望使用链式操作的现代化 API。</span></p><p data-pid="rScwXaEh"><span leaf="">- 示例场景：清洗和转换 GB 级别的数据集。</span></p><p data-pid="NRPQgfCi"><span leaf="">3. 选择 </span><code><span leaf="">arrow</span></code><span leaf="">：</span></p><p data-pid="Lz-na2Eo"><span leaf="">- 如果你需要跨语言数据交换，或者构建分布式数据管道。</span></p><p data-pid="CI5xUF4F"><span leaf="">- 示例场景：在 </span><code><span leaf="">R</span></code><span leaf=""> 和 </span><code><span leaf="">Python</span></code><span leaf=""> 之间共享数据，或处理大规模 </span><code><span leaf="">Parquet</span></code><span leaf=""> 文件。</span></p><p data-pid="gHvOAJR-"><span leaf="">4. 选择 </span><code><span leaf="">data.table</span></code><span leaf="">：</span></p><p data-pid="0mWOMKh_"><span leaf="">- 如果你需要极致的性能，并且主要处理小到中等规模的数据集。</span></p><p data-pid="-r53JvhR"><span leaf="">- 示例场景：快速筛选、聚合和更新数据，尤其是在内存内的任务中。</span></p><p data-pid="gWuH3iCh"><b><span leaf="">详细说明</span></b></p><p data-pid="-EeDNR72"><b><span leaf="">duckdb / duckplyr</span></b></p><p data-pid="Ir_asrA5"><span leaf="">- 优势：</span></p><p data-pid="l5t6TzUl"><span leaf="">- 直接查询磁盘上的大规模数据集，无需加载到内存中。</span></p><p data-pid="rKB1N0f_"><span leaf="">- 支持复杂的 </span><code><span leaf="">SQL</span></code><span leaf=""> 查询和窗口函数。</span></p><p data-pid="Smjatt2J"><span leaf="">- 与 </span><code><span leaf="">dplyr</span></code><span leaf=""> 无缝集成，适合熟悉 </span><code><span leaf="">tidyverse</span></code><span leaf=""> 的用户。</span></p><p data-pid="3EB07G9d"><span leaf="">- 局限性：</span></p><p data-pid="nVurmwrK"><span leaf="">- 对于小规模数据集，启动开销较大。</span></p><p data-pid="eyPq42cb"><span leaf="">- 不适合实时事务处理。</span></p><p data-pid="RIiSQcL1"><b><span leaf="">polars / tidypolars</span></b></p><p data-pid="8XoAT0Fg"><span leaf="">- 优势：</span></p><p data-pid="B8Nx9Mp_"><span leaf="">- 基于 </span><code><span leaf="">Rust</span></code><span leaf=""> 实现，具有高性能和低内存占用。</span></p><p data-pid="f_DQORa-"><span leaf="">- 提供现代化的链式操作 API，易于阅读和维护。</span></p><p data-pid="m9jdJaLd"><span leaf="">- 支持惰性求值和多线程并行化。</span></p><p data-pid="Y2JcB7OY"><span leaf="">- 局限性：</span></p><p data-pid="NHQaSmjX"><span leaf="">- 生态系统仍在发展中，某些高级功能可能不如其他工具成熟。</span></p><p data-pid="lkjHyUqQ"><span leaf="">- 对于超大规模数据集，性能可能受限于内存。</span></p><p data-pid="qT9WbPV8"><b><span leaf="">arrow</span></b></p><p data-pid="spJXdf9N"><span leaf="">- 优势：</span></p><p data-pid="YrUwMsLQ"><span leaf="">- 高效的跨语言数据交换，支持零拷贝操作。</span></p><p data-pid="TZkLjflm"><span leaf="">- 强大的文件格式支持（如 </span><code><span leaf="">Parquet</span></code><span leaf="">），适合分布式数据管道。</span></p><p data-pid="N8tVkrNr"><span leaf="">- 成熟的生态系统，广泛应用于大数据领域。</span></p><p data-pid="GLbhHMNe"><span leaf="">- 局限性：</span></p><p data-pid="ROeFwVCj"><span leaf="">- 需要理解 </span><code><span leaf="">arrow</span></code><span leaf=""> 的内存模型，学习曲线较高。</span></p><p data-pid="0YBEHNLo"><span leaf="">- 对于小规模数据集，优势不明显。</span></p><p data-pid="CI4laOed"><b><span leaf="">data.table</span></b></p><p data-pid="jVA-6F07"><span leaf="">- 优势：</span></p><p data-pid="Mxiq43dr"><span leaf="">- 在内存内数据处理方面具有极致性能。</span></p><p data-pid="rqZrOniY"><span leaf="">- 语法简洁，适合快速实现复杂逻辑。</span></p><p data-pid="xY2JPYYj"><span leaf="">- 社区成熟，文档丰富，学习资源广泛。</span></p><p data-pid="JjFUz3Mj"><span leaf="">- 局限性：</span></p><p data-pid="ez3A4bDa"><span leaf="">- 不支持惰性求值，所有操作都是即时执行的。</span></p><p data-pid="RZe8AOhd"><span leaf="">- 跨语言支持有限，仅适用于 R。</span></p><p data-pid="kA4dVgPz"><b><span leaf="">总结</span></b></p><p data-pid="tbuCWwhb"><span leaf="">- </span><b><span leaf="">duckdb duckplyr</span></b><span leaf=""> 更适合大规模数据分析任务，尤其是需要直接查询磁盘上的文件时。</span></p><p data-pid="mLO3udFo"><span leaf="">- </span><b><span leaf="">polars / tidypolars</span></b><span leaf=""> 更适合中等规模数据集的高性能处理，尤其是需要现代化链式操作时。</span></p><p data-pid="02YzW3Sg"><span leaf="">- </span><b><span leaf="">arrow </span></b><span leaf="">更适合跨语言数据交换和分布式数据管道，尤其是处理大规模 </span><code><span leaf="">Parquet</span></code><span leaf=""> 文件时。</span></p><p data-pid="RNelgALc"><span leaf="">- </span><b><span leaf="">data.table</span></b><span leaf=""> 更适合追求极致性能的小到中等规模数据集处理任务，尤其是对 </span><code><span leaf="">[ ]</span></code><span leaf=""> 操作符熟悉的用户。</span></p><p data-pid="juHTvhz-"><span leaf="">根据你的具体需求和团队的技术栈，选择最适合的工具组合！</span></p><h2 data-into-catalog-status=""><span leaf="">参考文献</span></h2><ol></ol><p data-pid="oRatJV52"><span leaf="">(Pretty) big data wrangling with DuckDB and Polars. https://floswald.github.io/duckdb-polars/</span></p><p data-pid="oRatJV52"><span leaf="">Big Data in R with Arrow, posit::conf(2024). https://github.com/posit-conf-2024/arrow</span></p><p data-pid="oRatJV52"><span leaf=""><br></span></p><hr><p data-pid="oRatJV52"><span leaf=""><span textstyle="">特别说明：</span></span><span><span leaf="">本篇相当于是“</span></span><b><span leaf="">基于R的数据库与大数据（下篇）</span></b><span><span leaf="">”的初稿，润色之后将写入《R语言编程：基于tidyverse（第2版）》，新版书计划 25 年下半年上市，有非常多的更新，敬请期待！</span></span></p><p data-pid="oRatJV52"><span leaf=""><br></span></p><hr><p data-pid="oRatJV52"><span leaf=""><span textstyle="">补充上一篇更新的内容</span></span></p><p data-pid="oRatJV52"><span leaf=""><span textstyle="">4 数据库转存</span></span></p><p data-pid="5FHnbPOK"><span leaf="">另一个有用的场景是数据库转存，比如，我有一个 </span><code><span leaf="">MySQL</span></code><span leaf=""> 数据源，想用 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 来操作， 同时不想搭建 </span><code><span leaf="">MySQL</span></code><span leaf=""> 软件环境。</span></p><blockquote><section><span leaf="">如果已有 </span><code><span leaf="">MySQL</span></code><span leaf=""> 环境，当然也可以将数据表导出到，比如 </span><code><span leaf="">Parquet</span></code><span leaf=""> 或 </span><code><span leaf="">CSV</span></code><span leaf=""> 文件，直接从文件注册到 DuckDB 使用（见下篇）。</span></section></blockquote><p data-pid="xyOhOi74"><span leaf="">这可以借助 </span><code><span leaf="">dm</span></code><span leaf=""> 包来实现。</span></p><p data-pid="1rmBRRUp"><b><span leaf="">注：</span></b><span leaf="">我之前搭建过 </span><code><span leaf="">MySQL</span></code><span leaf=""> 环境，现在用了 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 不再需要，也就不想再费事搭建了，所以，用远程 </span><code><span leaf="">MySQL</span></code><span leaf=""> 数据源来演示，与本地源也没啥本质区别。</span></p><p data-pid="LhYv4UK9"><span leaf="">下面以从远程连接 </span><code><span leaf="">MySQL</span></code><span leaf=""> 数据库 </span><code><span leaf="">CORA</span></code><span leaf="">，迁移到 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 为例。</span></p><p data-pid="05fGuGRd"><span leaf="">第一步，从远程 </span><code><span leaf="">MySQL</span></code><span leaf=""> 数据源建立连接：</span></p><pre><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">DBI</span></span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">dm</span></span><span><span leaf="">)</span></span><br><span><span leaf="">con_mysql</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">dbConnect</span></span><span><span leaf="">(</span></span><br><span leaf="">  </span><span><span leaf="">RMariaDB</span></span><span><span leaf="">::</span></span><span><span leaf="">MariaDB</span></span><span><span leaf="">(),</span></span><br><span leaf="">  </span><span><span leaf="">dbname</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"CORA"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">username</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"guest"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">password</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"ctu-relational"</span></span><span><span leaf="">,</span></span><br><span leaf="">  </span><span><span leaf="">host</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"relational.fel.cvut.cz"</span></span><span><span leaf="">)</span></span><span leaf="">     </span><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">需要连外网</span></span></code></pre><p data-pid="Nrr-UBL9"><span leaf="">第二步，将连接转化为 </span><code><span leaf="">dm</span></code><span leaf=""> 对象：</span></p><pre><code><span><span leaf="">CORA_dm</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">dm_from_con</span></span><span><span leaf="">(</span></span><span><span leaf="">con_mysql</span></span><span><span leaf="">)</span></span><span leaf=""> </span></code></pre><p data-pid="rKJF0Gw_"><span leaf="">第三步，建立 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 连接，再从 </span><code><span leaf="">dm</span></code><span leaf=""> 对象拷贝到该连接：</span></p><pre><code><span><span leaf="">con_duckdb</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">dbConnect</span></span><span><span leaf="">(</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">::</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">(),</span></span><span leaf=""> </span><span><span leaf="">dbdir</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"CORA.duckdb"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">CORA_db</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">copy_dm_to</span></span><span><span leaf="">(</span></span><span><span leaf="">con_duckdb</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">CORA_dm</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">set_key_constraints</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">FALSE</span></span><span><span leaf="">,</span></span><span leaf=""> </span><span><span leaf="">temporary</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">FALSE</span></span><span><span leaf="">)</span></span><span leaf="">      </span><span><span leaf="">#</span></span><span leaf=""> </span><span><span leaf="">设置永久性拷贝</span></span></code></pre><p data-pid="VTltDrl1"><span leaf="">第四步，关闭连接：</span></p><pre><code><span><span leaf="">dbDisconnect</span></span><span><span leaf="">(</span></span><span><span leaf="">con_mysql</span></span><span><span leaf="">)</span></span><br><span><span leaf="">dbDisconnect</span></span><span><span leaf="">(</span></span><span><span leaf="">con_duckdb</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="ihfa7YjP"><span leaf="">这就完成了数据库转存，而且该过程操作的是数据库文件，不拷贝巨大的数据表，所以不用担心速度。</span></p><p data-pid="nncFnmdl"><span leaf="">下次使用，直接从新的数据库文件的本地路径建立 </span><code><span leaf="">DuckDB</span></code><span leaf=""> 连接即可：</span></p><pre><code><span><span leaf="">con</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">dbConnect</span></span><span><span leaf="">(</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">::</span></span><span><span leaf="">duckdb</span></span><span><span leaf="">(),</span></span><span leaf=""> </span><span><span leaf="">dbdir</span></span><span leaf=""> </span><span><span leaf="">=</span></span><span leaf=""> </span><span><span leaf="">"CORA.duckdb"</span></span><span><span leaf="">)</span></span></code></pre><p data-pid="oRatJV52"><span leaf=""><br></span></p><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/FKvM0UzVq8MFSQoQP0_qyw",target="_blank" rel="noopener noreferrer">原文链接</a>
