---
title: "可发表级的常用 TCGA 单基因分析结果展示"
date: 2025-03-20T02:10:59Z
draft: ["false"]
tags: [
  "fetched",
  "生信杂货铺"
]
categories: ["Acdemic"]
---
可发表级的常用 TCGA 单基因分析结果展示 by 生信杂货铺
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">自动化分析单基因在 </span><code><span leaf="">TCGA</span></code><span leaf=""> 数据中</span></p><ul><li><section><span leaf="">在泛癌中的差异表达</span></section></li><li><section><span leaf="">在配对癌症与正常样本之间的差异表达</span></section></li><li><section><span leaf="">表达与生存时间的关系</span></section></li><li><section><span leaf="">表达与临床特征的关系</span></section></li><li><section><span leaf="">表达与免疫细胞浸润水平的相关性</span></section></li></ul><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">配置</span></span><span data-cacheurl="" data-remoteid=""></span></h3><p data-tool="mdnice编辑器"><span leaf="">导入包</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| message: false</span></span><br><br><span><span leaf="">library</span></span><span leaf="">(ggtext)</span><br><span><span leaf="">library</span></span><span leaf="">(ggprism)</span><br><span><span leaf="">library</span></span><span leaf="">(gground)</span><br><span><span leaf="">library</span></span><span leaf="">(ggforce)</span><br><span><span leaf="">library</span></span><span leaf="">(pheatmap)</span><br><span><span leaf="">library</span></span><span leaf="">(tidyverse)</span><br><span><span leaf="">library</span></span><span leaf="">(survminer)</span><br><span><span leaf="">library</span></span><span leaf="">(survival)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">定义配色</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">pal.two &lt;- c(</span><span><span leaf="">'#a3ad62'</span></span><span leaf="">, </span><span><span leaf="">'#df91a3'</span></span><span leaf="">)</span><br><span leaf="">pal.four &lt;- c(</span><span><span leaf="">'#fcddc9'</span></span><span leaf="">, </span><span><span leaf="">'#f8b976'</span></span><span leaf="">, </span><span><span leaf="">'#de786a'</span></span><span leaf="">, </span><span><span leaf="">'#826b88'</span></span><span leaf="">)</span><br><span leaf="">pal.grad &lt;- colorRampPalette(c(pal.two[</span><span><span leaf="">1</span></span><span leaf="">], </span><span><span leaf="">"white"</span></span><span leaf="">, pal.two[</span><span><span leaf="">2</span></span><span leaf="">]))(</span><span><span leaf="">50</span></span><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">结果保存路径</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">if</span></span><span leaf=""> (!dir.exists(</span><span><span leaf="">'./result'</span></span><span leaf="">)) {</span><br><span leaf="">    dir.create(</span><span><span leaf="">'./result'</span></span><span leaf="">)</span><br><span leaf="">}</span><br></code></pre><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">数据</span></span><span data-cacheurl="" data-remoteid=""></span></h3><p data-tool="mdnice编辑器"><span leaf="">输入兴趣基因和关注癌型，只有这里需要修改</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">use_gene &lt;- </span><span><span leaf="">'CDKN1A'</span></span><br><span leaf="">use_cancer &lt;- c(</span><span><span leaf="">'CRC'</span></span><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">获取基因 </span><code><span leaf="">ENTREZID</span></code></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">probemap &lt;- read_delim(</span><span><span leaf="">'data/probeMap_gencode.v23.annotation.gene.probemap'</span></span><span leaf="">, delim = </span><span><span leaf="">'\t'</span></span><span leaf="">, show_col_types = </span><span><span leaf="">FALSE</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    dplyr::filter(gene == use_gene) %&gt;%</span><br><span leaf="">    pull(id)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">获取临床数据</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| warning: false</span></span><br><br><span leaf="">clinical &lt;- readxl::read_excel(</span><span><span leaf="">'data/TCGA-CDR-SupplementalTableS1.xlsx'</span></span><span leaf="">, </span><br><span leaf="">                               sheet = </span><span><span leaf="">1</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    mutate(type = ifelse(type %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">'COAD'</span></span><span leaf="">, </span><span><span leaf="">'READ'</span></span><span leaf="">), </span><span><span leaf="">'CRC'</span></span><span leaf="">, type))</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">获取单基因泛癌表达值</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">gene_expr &lt;- data.table::fread(</span><span><span leaf="">'data/tcga_RSEM_gene_tpm.gz'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    dplyr::filter(sample == probemap) %&gt;%</span><br><span leaf="">    tibble::column_to_rownames(</span><span><span leaf="">'sample'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    t %&gt;% as.data.frame() %&gt;%</span><br><span leaf="">    tibble::rownames_to_column(</span><span><span leaf="">'sample'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    rename(gene = probemap) %&gt;%</span><br><span leaf="">    mutate(group = ifelse(substr(sample, </span><span><span leaf="">14</span></span><span leaf="">, </span><span><span leaf="">15</span></span><span leaf="">) &gt;= </span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">'Normal'</span></span><span leaf="">, </span><span><span leaf="">'Tumor'</span></span><span leaf="">),</span><br><span leaf="">           patient = substr(sample, </span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">12</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    left_join(clinical[,</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">2</span></span><span leaf="">], by = c(</span><span><span leaf="">"patient"</span></span><span leaf=""> = </span><span><span leaf="">"bcr_patient_barcode"</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    dplyr::filter(!is.na(type)) %&gt;%</span><br><span leaf="">    group_by(type, group, patient) %&gt;%</span><br><span leaf="">    reframe(gene = mean(gene))</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">癌症样本与癌旁正常分开</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">normal &lt;- dplyr::filter(gene_expr, group == </span><span><span leaf="">'Normal'</span></span><span leaf="">)</span><br><span leaf="">tumor &lt;- dplyr::filter(gene_expr, group == </span><span><span leaf="">'Tumor'</span></span><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">去除同时检测了癌症和正常样本个体的肿瘤样本</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">merged_expr &lt;- rbind(</span><br><span leaf="">    normal,</span><br><span leaf="">    dplyr::filter(tumor, !patient %</span><span><span leaf="">in</span></span><span leaf="">% normal$patient &amp; type %</span><span><span leaf="">in</span></span><span leaf="">% normal$type)</span><br><span leaf="">)</span><br></code></pre><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span><span leaf="">绘图</span></span><span data-cacheurl="" data-remoteid=""></span></h3><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">泛癌差异表达</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">背景填充</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">fill.data &lt;- tibble(</span><br><span leaf="">    name = unique(merged_expr$type),</span><br><span leaf="">    xmin = </span><span><span leaf="">1</span></span><span leaf="">:length(unique(merged_expr$type)) - </span><span><span leaf="">0.5</span></span><span leaf="">,</span><br><span leaf="">    xmax = xmin + </span><span><span leaf="">1</span></span><span leaf="">,</span><br><span leaf="">    ymin = min(merged_expr$gene) - </span><span><span leaf="">1</span></span><span leaf="">,</span><br><span leaf="">    ymax = max(merged_expr$gene) + </span><span><span leaf="">1</span></span><span leaf="">,</span><br><span leaf="">    fill = as.factor(ifelse(xmin %% </span><span><span leaf="">2</span></span><span leaf=""> &gt; </span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">))</span><br><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">绘制基因在泛癌中的差异表达</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># pdf('result/pancancer.pdf', height = 6, width = 15)</span></span><br><span leaf="">ggplot(merged_expr, aes(type, gene, color = group)) +</span><br><span leaf="">    geom_rect(</span><br><span leaf="">        aes(</span><br><span leaf="">            xmin = xmin,</span><br><span leaf="">            xmax = xmax,</span><br><span leaf="">            ymin = ymin,</span><br><span leaf="">            ymax = ymax,</span><br><span leaf="">            fill = fill,</span><br><span leaf="">        ),</span><br><span leaf="">        data = fill.data,</span><br><span leaf="">        linetype = </span><span><span leaf="">2</span></span><span leaf="">,</span><br><span leaf="">        alpha = </span><span><span leaf="">0.2</span></span><span leaf="">,</span><br><span leaf="">        colour = </span><span><span leaf="">'#caccd1'</span></span><span leaf="">,</span><br><span leaf="">        show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">,</span><br><span leaf="">        inherit.aes = </span><span><span leaf="">FALSE</span></span><br><span leaf="">    ) +</span><br><span leaf="">    geom_round_boxplot(outliers = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_point(</span><br><span leaf="">        position = position_jitterdodge(jitter.width = </span><span><span leaf="">0.15</span></span><span leaf="">,</span><br><span leaf="">                                        dodge.width = </span><span><span leaf="">0.7</span></span><span leaf="">),</span><br><span leaf="">        alpha = </span><span><span leaf="">0.4</span></span><span leaf="">, </span><br><span leaf="">        size = </span><span><span leaf="">2</span></span><span leaf="">, </span><br><span leaf="">        stroke = </span><span><span leaf="">0</span></span><span leaf="">,</span><br><span leaf="">        show.legend = </span><span><span leaf="">FALSE</span></span><br><span leaf="">    ) +</span><br><span leaf="">    stat_compare_means(</span><br><span leaf="">        aes(group = group), </span><br><span leaf="">        label = </span><span><span leaf="">'p.signif'</span></span><span leaf="">, </span><br><span leaf="">        label.y.npc = </span><span><span leaf="">0.95</span></span><span leaf="">,</span><br><span leaf="">        show.legend = </span><span><span leaf="">FALSE</span></span><br><span leaf="">    ) +</span><br><span leaf="">    scale_colour_manual(values = pal.two) +</span><br><span leaf="">    scale_fill_manual(values = c(</span><span><span leaf="">'#e8e9d7'</span></span><span leaf="">, </span><span><span leaf="">'#aac1bf'</span></span><span leaf="">)) +</span><br><span leaf="">    scale_x_discrete(expand = c(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">), guide = </span><span><span leaf="">'prism_bracket'</span></span><span leaf="">) +</span><br><span leaf="">    scale_y_continuous(expand = c(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">)) +</span><br><span leaf="">    labs(x = </span><span><span leaf="">NULL</span></span><span leaf="">, y = glue::glue(</span><span><span leaf="">'{use_gene} Expression Level (log2 TPM)'</span></span><span leaf="">)) +</span><br><span leaf="">    theme_prism() +</span><br><span leaf="">    theme(</span><br><span leaf="">        legend.position = </span><span><span leaf="">'top'</span></span><span leaf="">,</span><br><span leaf="">        axis.text.x = element_text(angle = </span><span><span leaf="">90</span></span><span leaf="">)</span><br><span leaf="">    )</span><br><span><span leaf=""># dev.off()</span></span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100018614" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWINmLUJ0fEicobFV87pwlKGaVJvSUTZrQCLRzsLV262QeibrNCuyYEnFJ95cWkZwx0syxSib416XdTOQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWINmLUJ0fEicobFV87pwlKGaVJvSUTZrQCLRzsLV262QeibrNCuyYEnFJ95cWkZwx0syxSib416XdTOQ/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">差异表达</span></span><span></span></h4><p data-tool="mdnice编辑器"><code><span leaf="">Y</span></code><span leaf=""> 轴标签</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">y_label &lt;- glue::glue(</span><span><span leaf="">'{use_gene} Expression Level (log2 TPM)'</span></span><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">标题样本信息</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">data &lt;- dplyr::filter(merged_expr, type == use_cancer)</span><br><span leaf="">pvalue &lt;- t.test(data[data$group == </span><span><span leaf="">'Normal'</span></span><span leaf="">, </span><span><span leaf="">'gene'</span></span><span leaf="">], </span><br><span leaf="">                 data[data$group == </span><span><span leaf="">'Tumor'</span></span><span leaf="">, </span><span><span leaf="">'gene'</span></span><span leaf="">])$p.value</span><br><span leaf="">sample_counts &lt;- table(data$group)</span><br><span leaf="">title &lt;- glue::glue(</span><span><span leaf="">"TCGA-{use_cancer}&lt;br&gt;(*N={sample_counts['Normal']}*, *T={sample_counts['Tumor']}*)"</span></span><span leaf="">)</span><br><span leaf="">subtitle &lt;- glue::glue(</span><span><span leaf="">'*p* = {format(pvalue, digits = 3)}'</span></span><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">基因在特定癌型中的差异表达情况</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: expression</span></span><br><br><span><span leaf=""># pdf(glue::glue('result/{use_cancer}_expression.pdf'), </span></span><br><span><span leaf="">#     width = 3, height = 4)</span></span><br><span leaf="">data %&gt;%</span><br><span leaf="">    ggplot(aes(group, gene, colour = group)) +</span><br><span leaf="">    geom_round_boxplot(radius = unit(</span><span><span leaf="">3</span></span><span leaf="">, </span><span><span leaf="">'pt'</span></span><span leaf="">), alpha = </span><span><span leaf="">0.8</span></span><span leaf="">, </span><br><span leaf="">                       outliers = </span><span><span leaf="">FALSE</span></span><span leaf="">, show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_point(stroke = </span><span><span leaf="">0</span></span><span leaf="">, alpha = </span><span><span leaf="">0.5</span></span><span leaf="">,</span><br><span leaf="">               size = </span><span><span leaf="">2</span></span><span leaf="">, show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">,</span><br><span leaf="">               position = position_dodge2(width = </span><span><span leaf="">0.2</span></span><span leaf="">)) +</span><br><span leaf="">    scale_color_manual(values = pal.two) +</span><br><span leaf="">    labs(</span><br><span leaf="">        x = </span><span><span leaf="">NULL</span></span><span leaf="">, </span><br><span leaf="">        y = y_label,</span><br><span leaf="">        title = title,</span><br><span leaf="">        subtitle = subtitle) +</span><br><span leaf="">    theme_prism() +</span><br><span leaf="">    theme(</span><br><span leaf="">        plot.title = element_markdown(size = </span><span><span leaf="">14</span></span><span leaf="">, hjust = </span><span><span leaf="">0.5</span></span><span leaf="">),</span><br><span leaf="">        plot.subtitle = element_markdown(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">, size = </span><span><span leaf="">12</span></span><span leaf="">),</span><br><span leaf="">        panel.border = element_rect(fill = </span><span><span leaf="">NA</span></span><span leaf="">, linewidth = </span><span><span leaf="">2</span></span><span leaf="">),</span><br><span leaf="">        axis.line = element_blank()</span><br><span leaf="">    )</span><br><span leaf="">    </span><br><span><span leaf=""># dev.off()</span></span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100018610" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGajVaccfdRO2RJiaDiaiceZtiafEjvDFiaeoOGgdhxtIQPdnlia9IOE6Y5ibj1g/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGajVaccfdRO2RJiaDiaiceZtiafEjvDFiaeoOGgdhxtIQPdnlia9IOE6Y5ibj1g/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">配对差异表达</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">标题信息</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">data &lt;- gene_expr %&gt;% dplyr::filter(</span><br><span leaf="">    patient %</span><span><span leaf="">in</span></span><span leaf="">% intersect(normal$patient, tumor$patient)</span><br><span leaf="">    &amp; type == use_cancer)</span><br><span leaf="">pvalue &lt;- t.test(data[data$group == </span><span><span leaf="">'Normal'</span></span><span leaf="">, </span><span><span leaf="">'gene'</span></span><span leaf="">], </span><br><span leaf="">                 data[data$group == </span><span><span leaf="">'Tumor'</span></span><span leaf="">, </span><span><span leaf="">'gene'</span></span><span leaf="">])$p.value</span><br><span leaf="">sample_counts &lt;- table(data$group)</span><br><span leaf="">title &lt;- glue::glue(</span><span><span leaf="">"TCGA-{use_cancer}&lt;br&gt;(*N={sample_counts['Normal']}*, *T={sample_counts['Tumor']}*)"</span></span><span leaf="">)</span><br><span leaf="">subtitle &lt;- glue::glue(</span><span><span leaf="">'*p* = {format(pvalue, digits = 3)}'</span></span><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">基因在配对样本中的表达</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 先绘制图形</span></span><br><span leaf="">p &lt;- data %&gt;%</span><br><span leaf="">    ggplot(aes(group, gene)) +</span><br><span leaf="">    geom_point(position = position_dodge2(width = </span><span><span leaf="">0.2</span></span><span leaf="">), size = </span><span><span leaf="">5</span></span><span leaf="">, shape = </span><span><span leaf="">21</span></span><span leaf="">)</span><br><br><span><span leaf=""># 然后从图形中获取点的位置</span></span><br><span leaf="">line.data &lt;- ggplot_build(p)$data[[</span><span><span leaf="">1</span></span><span leaf="">]] %&gt;%</span><br><span leaf="">    dplyr::select(c(</span><span><span leaf="">"x"</span></span><span leaf="">, </span><span><span leaf="">"y"</span></span><span leaf="">, </span><span><span leaf="">"group"</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    mutate(index = rep(</span><span><span leaf="">1</span></span><span leaf="">:sum(group == </span><span><span leaf="">1</span></span><span leaf="">), length(unique(group)))) %&gt;%</span><br><span leaf="">    group_by(index) %&gt;% </span><span><span leaf=""># 将数据点分组，然后根据每个分组的点创建数据</span></span><br><span leaf="">    group_modify(</span><span><span leaf="">function</span></span><span leaf=""> (data, group) {</span><br><span leaf="">        </span><span><span leaf=""># bezier 需要 3-4 个点，我们统一设置为 4 个点，±0.3 可以自己调整曲率</span></span><br><span leaf="">        data.frame(</span><br><span leaf="">            x = c(data$x[</span><span><span leaf="">1</span></span><span leaf="">], data$x[</span><span><span leaf="">1</span></span><span leaf="">] + </span><span><span leaf="">0.3</span></span><span leaf="">, data$x[</span><span><span leaf="">2</span></span><span leaf="">] - </span><span><span leaf="">0.3</span></span><span leaf="">, data$x[</span><span><span leaf="">2</span></span><span leaf="">]),</span><br><span leaf="">            y = c(data$y[</span><span><span leaf="">1</span></span><span leaf="">], data$y[</span><span><span leaf="">1</span></span><span leaf="">], data$y[</span><span><span leaf="">2</span></span><span leaf="">], data$y[</span><span><span leaf="">2</span></span><span leaf="">])</span><br><span leaf="">        )</span><br><span leaf="">    })</span><br></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: expression_paired</span></span><br><br><span><span leaf=""># pdf(glue::glue('result/{use_cancer}_expression_paired.pdf'),</span></span><br><span><span leaf="">#     width = 3, height = 4)</span></span><br><span leaf="">data %&gt;%</span><br><span leaf="">    ggplot(aes(group, gene, colour = group)) +</span><br><span leaf="">    geom_round_boxplot(radius = unit(</span><span><span leaf="">3</span></span><span leaf="">, </span><span><span leaf="">'pt'</span></span><span leaf="">), alpha = </span><span><span leaf="">0.8</span></span><span leaf="">, </span><br><span leaf="">                       outliers = </span><span><span leaf="">FALSE</span></span><span leaf="">, show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_bezier(aes(x, y, group = index), data = line.data, </span><br><span leaf="">                colour = </span><span><span leaf="">"#caccd1"</span></span><span leaf="">, </span><br><span leaf="">                alpha = </span><span><span leaf="">0.7</span></span><span leaf="">,</span><br><span leaf="">                inherit.aes = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_point(stroke = </span><span><span leaf="">0</span></span><span leaf="">, alpha = </span><span><span leaf="">0.5</span></span><span leaf="">,</span><br><span leaf="">               size = </span><span><span leaf="">2</span></span><span leaf="">, show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">,</span><br><span leaf="">               position = position_dodge2(width = </span><span><span leaf="">0.2</span></span><span leaf="">)) +</span><br><span leaf="">    scale_colour_manual(name = </span><span><span leaf="">NULL</span></span><span leaf="">, values = pal.two) +</span><br><span leaf="">    labs(x = </span><span><span leaf="">NULL</span></span><span leaf="">, y = y_label,</span><br><span leaf="">         title = title,</span><br><span leaf="">         subtitle = subtitle) +</span><br><span leaf="">    theme_prism() +</span><br><span leaf="">    theme(</span><br><span leaf="">        plot.title = element_markdown(size = </span><span><span leaf="">14</span></span><span leaf="">, hjust = </span><span><span leaf="">0.5</span></span><span leaf="">),</span><br><span leaf="">        plot.subtitle = element_markdown(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">, size = </span><span><span leaf="">12</span></span><span leaf="">),</span><br><span leaf="">        panel.border = element_rect(fill = </span><span><span leaf="">NA</span></span><span leaf="">, linewidth = </span><span><span leaf="">2</span></span><span leaf="">),</span><br><span leaf="">        axis.line = element_blank()</span><br><span leaf="">    )</span><br><span><span leaf=""># dev.off()</span></span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100018613" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGaWEKicT6nLuha7xMjI4hrzrZDhdiangpicfYeJO4xWb4v4Hgwr7IialTgdQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGaWEKicT6nLuha7xMjI4hrzrZDhdiangpicfYeJO4xWb4v4Hgwr7IialTgdQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">临床指标</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">获取分期信息，使用同样的方式可以获取其他临床指标。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">stage &lt;- clinical[,c(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">6</span></span><span leaf="">)] %&gt;%</span><br><span leaf="">    rename_with(~c(</span><span><span leaf="">'patient'</span></span><span leaf="">, </span><span><span leaf="">'stage'</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    mutate(stage = case_when(</span><br><span leaf="">        startsWith(stage, </span><span><span leaf="">'Stage IV'</span></span><span leaf="">) ~ </span><span><span leaf="">'Stage IV'</span></span><span leaf="">,</span><br><span leaf="">        startsWith(stage, </span><span><span leaf="">'Stage III'</span></span><span leaf="">) ~ </span><span><span leaf="">'Stage III'</span></span><span leaf="">,</span><br><span leaf="">        startsWith(stage, </span><span><span leaf="">'Stage II'</span></span><span leaf="">) ~ </span><span><span leaf="">'Stage II'</span></span><span leaf="">,</span><br><span leaf="">        startsWith(stage, </span><span><span leaf="">'Stage I'</span></span><span leaf="">) ~ </span><span><span leaf="">'Stage I'</span></span><span leaf="">,</span><br><span leaf="">        .default = </span><span><span leaf="">'Unknown'</span></span><br><span leaf="">    )) %&gt;%</span><br><span leaf="">    dplyr::filter(startsWith(stage, </span><span><span leaf="">'Stage'</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    inner_join(tumor, by = </span><span><span leaf="">'patient'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    dplyr::filter(type %</span><span><span leaf="">in</span></span><span leaf="">% use_cancer)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">基因在不同分期中的表达情况</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: stage</span></span><br><br><span leaf="">pdf(glue::glue(</span><span><span leaf="">'result/{use_cancer}_stage.pdf'</span></span><span leaf="">), width = </span><span><span leaf="">5</span></span><span leaf="">, height = </span><span><span leaf="">4</span></span><span leaf="">)</span><br><span leaf="">dplyr::filter(stage, type %</span><span><span leaf="">in</span></span><span leaf="">% use_cancer) %&gt;%</span><br><span leaf="">    ggplot(aes(stage, gene)) +</span><br><span leaf="">    geom_violin(aes(fill = stage), colour = </span><span><span leaf="">NA</span></span><span leaf="">, show.legend = </span><span><span leaf="">FALSE</span></span><span leaf="">) +</span><br><span leaf="">    geom_round_boxplot(</span><br><span leaf="">        radius = unit(</span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">'pt'</span></span><span leaf="">), </span><br><span leaf="">        width = </span><span><span leaf="">0.4</span></span><span leaf="">, </span><br><span leaf="">        colour = </span><span><span leaf="">'white'</span></span><span leaf="">,</span><br><span leaf="">        outliers = </span><span><span leaf="">FALSE</span></span><span leaf="">,</span><br><span leaf="">        errorbar.draw = </span><span><span leaf="">FALSE</span></span><br><span leaf="">    ) +</span><br><span leaf="">    geom_jitter(</span><br><span leaf="">        width = </span><span><span leaf="">0.1</span></span><span leaf="">, </span><br><span leaf="">        alpha = </span><span><span leaf="">0.5</span></span><span leaf="">, </span><br><span leaf="">        stroke = </span><span><span leaf="">0</span></span><span leaf="">,</span><br><span leaf="">        colour = </span><span><span leaf="">'#31395a'</span></span><br><span leaf="">    ) +</span><br><span leaf="">    stat_compare_means(</span><br><span leaf="">        comparisons = list(c(</span><span><span leaf="">'Stage I'</span></span><span leaf="">, </span><span><span leaf="">'Stage II'</span></span><span leaf="">), </span><br><span leaf="">                           c(</span><span><span leaf="">'Stage II'</span></span><span leaf="">, </span><span><span leaf="">'Stage III'</span></span><span leaf="">), </span><br><span leaf="">                           c(</span><span><span leaf="">'Stage III'</span></span><span leaf="">, </span><span><span leaf="">'Stage IV'</span></span><span leaf="">)),</span><br><span leaf="">        method = </span><span><span leaf="">'t.test'</span></span><span leaf="">, label = </span><span><span leaf="">'p.signif'</span></span><br><span leaf="">    ) +</span><br><span leaf="">    scale_fill_manual(name = </span><span><span leaf="">NULL</span></span><span leaf="">, values = pal.four) +</span><br><span leaf="">    labs(</span><br><span leaf="">        x = </span><span><span leaf="">NULL</span></span><span leaf="">, </span><br><span leaf="">        y = glue::glue(</span><span><span leaf="">'{use_gene} Expression Level (log2 TPM)'</span></span><span leaf="">),</span><br><span leaf="">        title = glue::glue(</span><span><span leaf="">'TCGA-{use_cancer}'</span></span><span leaf="">)</span><br><span leaf="">    ) +</span><br><span leaf="">    theme_prism() +</span><br><span leaf="">    theme(</span><br><span leaf="">        plot.title = element_markdown(size = </span><span><span leaf="">16</span></span><span leaf="">, hjust = </span><span><span leaf="">0.5</span></span><span leaf="">),</span><br><span leaf="">        panel.border = element_rect(fill = </span><span><span leaf="">NA</span></span><span leaf="">, linewidth = </span><span><span leaf="">2</span></span><span leaf="">),</span><br><span leaf="">        axis.line = element_blank()</span><br><span leaf="">    )</span><br><span leaf="">dev.off()</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100018612" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGaA2pmK23ZsnH620r1tkGomYhXEtKp1Ud4LSXHOK3Oic2RfWProYB41Dg/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGaA2pmK23ZsnH620r1tkGomYhXEtKp1Ud4LSXHOK3Oic2RfWProYB41Dg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">生存分析</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">定义生存分析函数，可指定不同的生存信息，如 </span><code><span leaf="">OS</span></code><span leaf="">、</span><code><span leaf="">DFS</span></code><span leaf=""> 等</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">plot_km &lt;- </span><span><span leaf="">function</span></span><span leaf="">(data, column, title, time_var = </span><span><span leaf="">"OS"</span></span><span leaf="">, </span><br><span leaf="">                    palette = c(</span><span><span leaf="">"#bc1e5d"</span></span><span leaf="">, </span><span><span leaf="">"#4daf4a"</span></span><span leaf="">),</span><br><span leaf="">                    legend_labels = </span><span><span leaf="">NULL</span></span><span leaf="">,</span><br><span leaf="">                    censor = </span><span><span leaf="">TRUE</span></span><span leaf="">, table = </span><span><span leaf="">FALSE</span></span><span leaf="">){</span><br><span leaf="">    </span><span><span leaf=""># data &lt;- na.omit(data)</span></span><br><span leaf="">    mutate(data, !!sym(column))</span><br><span leaf="">    f &lt;- as.formula(</span><br><span leaf="">        glue::glue(</span><span><span leaf="">'Surv({time_var}.time, {time_var}) ~ `{column}`'</span></span><span leaf="">))</span><br><span leaf="">    label.x &lt;- </span><span><span leaf="">"Overall survival(months)"</span></span><br><span leaf="">    </span><span><span leaf="">if</span></span><span leaf=""> (startsWith(time_var, </span><span><span leaf="">"DS"</span></span><span leaf="">)) {</span><br><span leaf="">        label.x = </span><span><span leaf="">"Disease-specific survival(months)"</span></span><br><span leaf="">    } </span><span><span leaf="">else</span></span><span leaf=""> </span><span><span leaf="">if</span></span><span leaf=""> (startsWith(time_var, </span><span><span leaf="">"DF"</span></span><span leaf="">)) {</span><br><span leaf="">        label.x = </span><span><span leaf="">"Disease-free survival(months)"</span></span><br><span leaf="">    } </span><span><span leaf="">else</span></span><span leaf=""> </span><span><span leaf="">if</span></span><span leaf=""> (startsWith(time_var, </span><span><span leaf="">"PF"</span></span><span leaf="">)) {</span><br><span leaf="">        label.x = </span><span><span leaf="">"Progression-free survival(months)"</span></span><br><span leaf="">    }</span><br><span leaf="">    fits &lt;- survfit(f, data = data)</span><br><span leaf="">    fits$call$formula &lt;- f</span><br><span leaf="">    </span><br><span leaf="">    pvalue &lt;- round(surv_pvalue(fits, data = data)$pval, </span><span><span leaf="">3</span></span><span leaf="">)</span><br><span leaf="">    x &lt;- summary(coxph(f, data = data))</span><br><span leaf="">    HR &lt;-signif(x$coef[,</span><span><span leaf="">2</span></span><span leaf="">], digits = </span><span><span leaf="">2</span></span><span leaf="">)</span><br><span leaf="">    HR.confint.lower &lt;- signif(x$conf.int[,</span><span><span leaf="">"lower .95"</span></span><span leaf="">], </span><span><span leaf="">3</span></span><span leaf="">)</span><br><span leaf="">    HR.confint.upper &lt;- signif(x$conf.int[,</span><span><span leaf="">"upper .95"</span></span><span leaf="">],</span><span><span leaf="">3</span></span><span leaf="">)</span><br><span leaf="">    CI_95 &lt;- paste0(HR.confint.lower,</span><span><span leaf="">"-"</span></span><span leaf="">,HR.confint.upper)</span><br><span leaf="">    label &lt;- glue::glue(</span><span><span leaf="">"Log-rank p = {pvalue}\nHR = {HR}({CI_95})"</span></span><span leaf="">)</span><br><span leaf="">    </span><br><span leaf="">    group_table &lt;- table(data[,column])</span><br><span leaf="">    </span><span><span leaf="">if</span></span><span leaf=""> (is.null(legend_labels)) {</span><br><span leaf="">        legend_labels &lt;- sapply(names(group_table), </span><span><span leaf="">function</span></span><span leaf="">(name) {</span><br><span leaf="">            glue::glue(</span><span><span leaf="">"{name} (N = {group_table[name]})"</span></span><span leaf="">)</span><br><span leaf="">        })</span><br><span leaf="">    }</span><br><span leaf="">    </span><br><span leaf="">    my_theme &lt;- theme(</span><br><span leaf="">        legend.title = element_text(</span><br><span leaf="">            face = </span><span><span leaf="">"bold"</span></span><span leaf="">, family = </span><span><span leaf="">"Times"</span></span><span leaf="">, colour = </span><span><span leaf="">"black"</span></span><span leaf="">, size = </span><span><span leaf="">12</span></span><span leaf="">),</span><br><span leaf="">        legend.text = element_text(</span><br><span leaf="">            face = </span><span><span leaf="">"bold"</span></span><span leaf="">,family = </span><span><span leaf="">"Times"</span></span><span leaf="">, colour = </span><span><span leaf="">"black"</span></span><span leaf="">, size =</span><span><span leaf="">12</span></span><span leaf="">),</span><br><span leaf="">        plot.title = element_text(hjust = </span><span><span leaf="">0.5</span></span><span leaf="">,size = </span><span><span leaf="">16</span></span><span leaf="">, face = </span><span><span leaf="">"bold"</span></span><span leaf="">),</span><br><span leaf="">        panel.border = element_rect(fill = </span><span><span leaf="">NA</span></span><span leaf="">, linewidth = </span><span><span leaf="">2</span></span><span leaf="">),</span><br><span leaf="">        axis.line = element_blank()</span><br><span leaf="">    )</span><br><span leaf="">    </span><br><span leaf="">    p &lt;- ggsurvplot(</span><br><span leaf="">        fits, data = data, legend.title = element_blank(),</span><br><span leaf="">        legend = c(</span><span><span leaf="">0.8</span></span><span leaf="">, </span><span><span leaf="">0.9</span></span><span leaf="">), title = title,</span><br><span leaf="">        pval = </span><span><span leaf="">F</span></span><span leaf="">, break.time.by = </span><span><span leaf="">20</span></span><span leaf="">, censor = censor,</span><br><span leaf="">        risk.table = table, </span><br><span leaf="">        risk.table.height = </span><span><span leaf="">0.30</span></span><span leaf="">,</span><br><span leaf="">        risk.table.col = </span><span><span leaf="">"strata"</span></span><span leaf="">,</span><br><span leaf="">        risk.table.y.text.col = </span><span><span leaf="">FALSE</span></span><span leaf="">, </span><br><span leaf="">        risk.table.y.text = </span><span><span leaf="">FALSE</span></span><span leaf="">,</span><br><span leaf="">        ggtheme = theme_prism() + my_theme,</span><br><span leaf="">        palette = palette,</span><br><span leaf="">        legend.labs = legend_labels</span><br><span leaf="">    )</span><br><span leaf="">    p$plot &lt;- p$plot + </span><br><span leaf="">        annotate(</span><span><span leaf="">"text"</span></span><span leaf="">, x = </span><span><span leaf="">0</span></span><span leaf="">, y = </span><span><span leaf="">0.2</span></span><span leaf="">, label = label, hjust = </span><span><span leaf="">0</span></span><span leaf="">, size = </span><span><span leaf="">4</span></span><span leaf="">) +</span><br><span leaf="">        labs(x = label.x, y = </span><span><span leaf="">"Survival Probability"</span></span><span leaf="">)</span><br><span leaf="">    </span><span><span leaf="">return</span></span><span leaf="">(p)</span><br><span leaf="">}</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">使用总体生存期</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">surv.data &lt;- dplyr::select(clinical, </span><span><span leaf="">1</span></span><span leaf="">, OS, OS.time) %&gt;%</span><br><span leaf="">    inner_join(tumor, by = c(</span><span><span leaf="">'bcr_patient_barcode'</span></span><span leaf=""> = </span><span><span leaf="">'patient'</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    mutate(OS.time = OS.time / </span><span><span leaf="">30</span></span><span leaf="">)</span><br><br><span leaf="">data &lt;- dplyr::filter(surv.data, type %</span><span><span leaf="">in</span></span><span leaf="">% use_cancer) %&gt;%</span><br><span leaf="">    mutate(label = ifelse(gene &gt; median(gene), </span><span><span leaf="">'High'</span></span><span leaf="">, </span><span><span leaf="">'Low'</span></span><span leaf="">))</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">基因表达与总体生存期的关系</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: survival</span></span><br><br><span><span leaf=""># pdf(glue::glue('result/{use_cancer}_survival.pdf'), </span></span><br><span><span leaf="">#     width = 5, height = 4)</span></span><br><span leaf="">p &lt;- plot_km(data, column = </span><span><span leaf="">'label'</span></span><span leaf="">, </span><br><span leaf="">             title = glue::glue(</span><span><span leaf="">'TCGA-{use_cancer}'</span></span><span leaf="">),</span><br><span leaf="">             palette = pal.two[</span><span><span leaf="">2</span></span><span leaf="">:</span><span><span leaf="">1</span></span><span leaf="">])</span><br><span leaf="">print(p, newpage = </span><span><span leaf="">FALSE</span></span><span leaf="">)</span><br><span><span leaf=""># dev.off()</span></span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100018611" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGar6janiaYslRic0EQQJ4uhUBTpHJoCRwSRRe4ibe3ibL5QgdlxQkXILWeMQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGar6janiaYslRic0EQQJ4uhUBTpHJoCRwSRRe4ibe3ibL5QgdlxQkXILWeMQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">免疫浸润</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">获取 </span><code><span leaf="">TCGA</span></code><span leaf=""> 泛癌免疫浸润水平 （</span><code><span leaf="">CIBERSORT</span></code><span leaf="">）</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">immune &lt;- read_tsv(</span><span><span leaf="">'data/TCGA.Kallisto.fullIDs.cibersort.relative.tsv'</span></span><span leaf="">,</span><br><span leaf="">         show_col_types = </span><span><span leaf="">FALSE</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    mutate(SampleID = str_replace_all(SampleID, </span><span><span leaf="">'\\.'</span></span><span leaf="">, </span><span><span leaf="">'-'</span></span><span leaf="">),</span><br><span leaf="">           SampleID = substr(SampleID, </span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">15</span></span><span leaf="">),</span><br><span leaf="">           CancerType = ifelse(CancerType %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">'COAD'</span></span><span leaf="">, </span><span><span leaf="">'READ'</span></span><span leaf="">), </span><br><span leaf="">                               </span><span><span leaf="">'CRC'</span></span><span leaf="">, CancerType)) %&gt;%</span><br><span leaf="">    dplyr::filter(substr(SampleID, </span><span><span leaf="">14</span></span><span leaf="">, </span><span><span leaf="">15</span></span><span leaf="">) &lt; </span><span><span leaf="">10</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    mutate(SampleID = substr(SampleID, </span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">12</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    group_by(CancerType, SampleID) %&gt;%</span><br><span leaf="">    summarise_all(mean) %&gt;%</span><br><span leaf="">    inner_join(gene_expr[,</span><span><span leaf="">3</span></span><span leaf="">:</span><span><span leaf="">4</span></span><span leaf="">], by = c(</span><span><span leaf="">'SampleID'</span></span><span leaf=""> = </span><span><span leaf="">'patient'</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    dplyr::select(-SampleID)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">计算相关系数和相关性检验的 P 值</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| warning: false</span></span><br><br><span leaf="">corr.mat &lt;- do.call(cbind, </span><br><span leaf="">                    lapply(split(immune, immune$CancerType), </span><span><span leaf="">function</span></span><span leaf="">(x) {</span><br><span leaf="">    ct &lt;- unique(pull(x, </span><span><span leaf="">'CancerType'</span></span><span leaf="">))</span><br><span leaf="">    cor(x[</span><span><span leaf="">'gene'</span></span><span leaf="">], x[</span><span><span leaf="">2</span></span><span leaf="">:</span><span><span leaf="">23</span></span><span leaf="">], use = </span><span><span leaf="">'pairwise.complete.obs'</span></span><span leaf="">,</span><br><span leaf="">        method = </span><span><span leaf="">'spearman'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">        t %&gt;% as.data.frame() %&gt;%</span><br><span leaf="">        rename_with(~ct)</span><br><span leaf="">    })) %&gt;%</span><br><span leaf="">    rownames_to_column(</span><span><span leaf="">'cell'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    mutate(cell = str_replace_all(cell, </span><span><span leaf="">'\\.'</span></span><span leaf="">, </span><span><span leaf="">' '</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    tibble::column_to_rownames(</span><span><span leaf="">'cell'</span></span><span leaf="">)</span><br><br><span><span leaf="">#| warning: false</span></span><br><br><span leaf="">p.mat &lt;- do.call(cbind, </span><br><span leaf="">                 lapply(split(immune, immune$CancerType), </span><span><span leaf="">function</span></span><span leaf="">(x) {</span><br><span leaf="">    ct &lt;- unique(pull(x, </span><span><span leaf="">'CancerType'</span></span><span leaf="">))</span><br><span leaf="">    sapply(colnames(x)[</span><span><span leaf="">2</span></span><span leaf="">:</span><span><span leaf="">23</span></span><span leaf="">], </span><br><span leaf="">           </span><span><span leaf="">function</span></span><span leaf="">(c) cor.test(pull(x, c), x$gene, </span><br><span leaf="">                                use = </span><span><span leaf="">'pairwise.complete.obs'</span></span><span leaf="">,</span><br><span leaf="">                                method = </span><span><span leaf="">'spearman'</span></span><span leaf="">)$p.value) %&gt;%</span><br><span leaf="">        as.data.frame() %&gt;%</span><br><span leaf="">        rename_with(~ct)</span><br><span leaf="">    })) %&gt;%</span><br><span leaf="">    rownames_to_column(</span><span><span leaf="">'cell'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    mutate(cell = str_replace_all(cell, </span><span><span leaf="">'\\.'</span></span><span leaf="">, </span><span><span leaf="">' '</span></span><span leaf="">)) %&gt;%</span><br><span leaf="">    tibble::column_to_rownames(</span><span><span leaf="">'cell'</span></span><span leaf="">)</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">相关性值的热图</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: cibersort</span></span><br><br><span><span leaf=""># pdf('result/immune_infiltrates_1.pdf', width = 10, height = 5)</span></span><br><span leaf="">p &lt;- pheatmap(corr.mat, color = pal.grad,</span><br><span leaf="">         cluster_rows = </span><span><span leaf="">FALSE</span></span><span leaf="">, cluster_cols = </span><span><span leaf="">FALSE</span></span><span leaf="">, na_col = </span><span><span leaf="">'white'</span></span><span leaf="">)</span><br><span leaf="">print(p)</span><br><span><span leaf=""># dev.off()</span></span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100018619" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGa9vmjr0vwvwbtAVuQIJHF7pZicwvSXTevia83M7KfeeJxyNppfwoq1c2Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWINmLUJ0fEicobFV87pwlKGa9vmjr0vwvwbtAVuQIJHF7pZicwvSXTevia83M7KfeeJxyNppfwoq1c2Q/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">合并相关系数和 P 值</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">immune_df &lt;- tibble::rownames_to_column(corr.mat, </span><span><span leaf="">'immune'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    pivot_longer(-immune, values_to = </span><span><span leaf="">'rho'</span></span><span leaf="">, names_to = </span><span><span leaf="">'cancer'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    inner_join(</span><br><span leaf="">        tibble::rownames_to_column(p.mat, </span><span><span leaf="">'immune'</span></span><span leaf="">) %&gt;%</span><br><span leaf="">            pivot_longer(-immune, values_to = </span><span><span leaf="">'p'</span></span><span leaf="">, names_to = </span><span><span leaf="">'cancer'</span></span><span leaf="">),</span><br><span leaf="">        by = c(</span><span><span leaf="">'immune'</span></span><span leaf="">, </span><span><span leaf="">'cancer'</span></span><span leaf="">)</span><br><span leaf="">    )</span><br></code></pre><p data-tool="mdnice编辑器"><span leaf="">添加显著性标记</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#| label: timer-corr</span></span><br><br><span><span leaf=""># pdf('result/immune_infiltrates_2.pdf', width = 10, height = 5)</span></span><br><span leaf="">immune_df %&gt;%</span><br><span leaf="">    ggplot(aes(cancer, immune)) +</span><br><span leaf="">    geom_point(aes(colour = rho, </span><br><span leaf="">                   shape = ifelse(p &lt;= </span><span><span leaf="">0.05</span></span><span leaf="">, </span><span><span leaf="">'p ≤ 0.05'</span></span><span leaf="">, </span><span><span leaf="">'p &gt; 0.05'</span></span><span leaf="">)),</span><br><span leaf="">               size = </span><span><span leaf="">6</span></span><span leaf="">,</span><br><span leaf="">               na.rm = </span><span><span leaf="">TRUE</span></span><span leaf="">) +</span><br><span leaf="">    scale_shape_manual(</span><br><span leaf="">        name = </span><span><span leaf="">NULL</span></span><span leaf="">, values = c(</span><span><span leaf="">'p ≤ 0.05'</span></span><span leaf=""> = </span><span><span leaf="">15</span></span><span leaf="">, </span><span><span leaf="">'p &gt; 0.05'</span></span><span leaf=""> = </span><span><span leaf="">7</span></span><span leaf="">),</span><br><span leaf="">        breaks = c(</span><span><span leaf="">'p ≤ 0.05'</span></span><span leaf="">, </span><span><span leaf="">'p &gt; 0.05'</span></span><span leaf="">)) +</span><br><span leaf="">    scale_color_gradientn(</span><br><span leaf="">        name = </span><span><span leaf="">'Partial_Cor'</span></span><span leaf="">,</span><br><span leaf="">        colours = pal.grad, </span><br><span leaf="">        limits = c(-max(abs(immune_df$rho), na.rm = </span><span><span leaf="">TRUE</span></span><span leaf="">), </span><br><span leaf="">                   max(abs(immune_df$rho), na.rm = </span><span><span leaf="">TRUE</span></span><span leaf="">)),</span><br><span leaf="">        breaks = round(c(</span><br><span leaf="">            -max(abs(immune_df$rho), na.rm = </span><span><span leaf="">TRUE</span></span><span leaf="">) + </span><span><span leaf="">0.1</span></span><span leaf="">,</span><br><span leaf="">            </span><span><span leaf="">0</span></span><span leaf="">,</span><br><span leaf="">            max(abs(immune_df$rho), na.rm = </span><span><span leaf="">TRUE</span></span><span leaf="">) - </span><span><span leaf="">0.1</span></span><span leaf="">), </span><span><span leaf="">1</span></span><span leaf="">)</span><br><span leaf="">        ) +</span><br><span leaf="">    scale_y_discrete(position = </span><span><span leaf="">'right'</span></span><span leaf="">) +</span><br><span leaf="">    labs(x = </span><span><span leaf="">NULL</span></span><span leaf="">, y = </span><span><span leaf="">NULL</span></span><span leaf="">) +</span><br><span leaf="">    theme(</span><br><span leaf="">        panel.background = element_blank(),</span><br><span leaf="">        panel.border = element_rect(colour = </span><span><span leaf="">'grey50'</span></span><span leaf="">, fill = </span><span><span leaf="">NA</span></span><span leaf="">,</span><br><span leaf="">                                    linewidth = </span><span><span leaf="">1</span></span><span leaf="">),</span><br><span leaf="">        axis.text.x = element_text(angle = </span><span><span leaf="">90</span></span><span leaf="">, hjust = </span><span><span leaf="">1</span></span><span leaf="">, vjust = </span><span><span leaf="">0.5</span></span><span leaf="">),</span><br><span leaf="">        axis.text = element_text(size = </span><span><span leaf="">10</span></span><span leaf="">),</span><br><span leaf="">        axis.ticks.length = unit(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">'cm'</span></span><span leaf="">)</span><br><span leaf="">    )</span><br><span><span leaf=""># dev.off()</span></span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100018618" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWINmLUJ0fEicobFV87pwlKGa9CW89DU5HGbGhnjlKhZG7gmPsJOB2ibAfY2icpEkvfMtaZoqPLM9qNQA/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWINmLUJ0fEicobFV87pwlKGa9CW89DU5HGbGhnjlKhZG7gmPsJOB2ibAfY2icpEkvfMtaZoqPLM9qNQA/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">结尾</span></span><span></span></h2><hr><p data-tool="mdnice编辑器"><span leaf="">任何代码的问题都可以在知识星球中提问，自愿加入。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100018617" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWINmLUJ0fEicobFV87pwlKGao3OqVMn7wAJkj8zsCY1VhFaINf6KrsYPUBibSLPddRM48YT6FictSWGw/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWINmLUJ0fEicobFV87pwlKGao3OqVMn7wAJkj8zsCY1VhFaINf6KrsYPUBibSLPddRM48YT6FictSWGw/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/7Rpm7PQp7PFdq6aUqyndXw",target="_blank" rel="noopener noreferrer">原文链接</a>
