---
title: "单细胞RNA-seq生信分析全流程——第三十三篇：表面蛋白（批次矫正）"
date: 2025-03-20T15:17:29Z
draft: ["false"]
tags: [
  "fetched",
  "小鱼生物信息"
]
categories: ["Acdemic"]
---
单细胞RNA-seq生信分析全流程——第三十三篇：表面蛋白（批次矫正） by 小鱼生物信息
------
<div><section data-pm-slice="0 0 []"><span><span leaf="">33.1 前言</span></span></section><p><span leaf="">从我们之前可视化的</span><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"p","attributes":{"style":"-webkit-tap-highlight-color: transparent; margin: 0px 0px 24px; padding: 0px; outline: 0px; max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; clear: both; min-height: 1em; color: rgba(0, 0, 0, 0.9); font-family: \"PingFang SC\", system-ui, -apple-system, BlinkMacSystemFont, \"Helvetica Neue\", \"Hiragino Sans GB\", \"Microsoft YaHei UI\", \"Microsoft YaHei\", Arial, sans-serif; font-size: 17px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: 0.544px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; visibility: visible;"},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'>Antibody-Derived Tags（ADT）数据可以看出，样本之间的批次效应非常明显。因此，需要进行批次校正以减轻这种影响。一般来说，还没有开发出专门针对ADT数据批次校正的方法，因此建议将为转录组学数据设计的方法应用于ADT数据。</span></p><section><span leaf="" data-pm-slice="0 0 []"><span textstyle="">33.2 环境配置</span></span></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="python"><code><span leaf=""><span>import</span> harmonypy <span>as</span> hm</span></code><code><span leaf=""><span>import</span> muon <span>as</span> mu</span></code><code><span leaf=""><span>import</span> numpy <span>as</span> np</span></code><code><span leaf=""><span>import</span> pooch</span></code><code><span leaf=""><span>import</span> scanpy <span>as</span> sc</span></code><code><span leaf=""><span>import</span> seaborn <span>as</span> sns</span></code><code><span leaf=""><span># setting visualization parameters</span></span></code><code><span leaf="">sc.settings.verbosity = <span>0</span></span></code><code><span leaf="">sc.settings.set_figure_params(</span></code><code><span leaf="">    dpi=<span>80</span>,</span></code><code><span leaf="">    facecolor=<span>"white"</span>,</span></code><code><span leaf="">    frameon=<span>False</span>,</span></code><code><span leaf="">)</span></code></pre></section><section><span leaf="" data-pm-slice='1 1 ["para",null]'><span textstyle="">33.3 加载数据</span></span></section><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="makefile"><code><span leaf="">cite_xdbt = pooch.retrieve(</span></code><code><span leaf="">    url=<span>"https://figshare.com/ndownloader/files/41452434"</span>,</span></code><code><span leaf="">    fname=<span>"cite_doublet_removal_xdbt.h5mu"</span>,</span></code><code><span leaf="">    path=<span>"."</span>,</span></code><code><span leaf="">    known_hash=None,</span></code><code><span leaf="">    progressbar=True,</span></code><code><span leaf="">)</span></code><code><span leaf="">mdata = mu.read(<span>"cite_doublet_removal_xdbt.h5mu"</span>)</span></code></pre></section><section><span leaf="">目前尚不清楚哪种批次效应校正最适合ADT数据。一般来说，建议使用 scVI或Harmony对数据进行批次校正，因为它们在scRNA-seq数据上具有稳健的性能。</span></section><section><span leaf="" data-pm-slice='1 1 ["para",null]'><span textstyle="">33.3 Harmony</span></span></section><section><ul><li></ul><pre data-lang="ini"><code><span leaf=""><span>ho</span> = hm.run_harmony(mdata[<span>"prot"</span>].X, mdata[<span>"prot"</span>].obs, [<span>"donor"</span>])</span></code></pre></section><section><ul><li><li></ul><pre data-lang="python"><code><span leaf="">pc_std = np.std(ho.Z_corr, axis=<span>1</span>).tolist()</span></code><code><span leaf="">sns.scatterplot(x=<span>range</span>(<span>0</span>, <span>len</span>(pc_std)), y=<span>sorted</span>(pc_std, reverse=<span>True</span>))</span></code></pre></section><section><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/e1cKg2SPUFheClT1I0Pjll7VLbOHowrNEEp4ywsjhsBCictVoCp6DHibwBvfEaTDPYmex2YYwibaIH6wCkmpWBYDw/640?wx_fmt=png&amp;from=appmsg" alt="../_images/8a796baa0113da869ba0159365509207e069e3c16f1f40fbba26a5b2ab935edf.png" data-ratio="0.9964539007092199" data-type="png" data-w="564" data-imgfileid="100000509" src="https://mmbiz.qpic.cn/mmbiz_png/e1cKg2SPUFheClT1I0Pjll7VLbOHowrNEEp4ywsjhsBCictVoCp6DHibwBvfEaTDPYmex2YYwibaIH6wCkmpWBYDw/640?wx_fmt=png&amp;from=appmsg"></span></section><section><ul><li><li></ul><pre data-lang="javascript"><code><span leaf="">mdata[<span>"prot"</span>].<span>obsm</span>[<span>"X_pcahm"</span>] = ho.<span>Z_corr</span>.<span>transpose</span>()</span></code><code><span leaf="">mdata[<span>"prot"</span>].<span>obsm</span></span></code></pre></section><section><ul><li></ul><pre data-lang="javascript"><code><span leaf=""><span>AxisArrays</span> <span>with</span> <span>keys</span>: X_pcahm</span></code></pre></section><section><ul><li><li><li></ul><pre data-lang="apache"><code><span leaf=""><span>sc</span>.pp.neighbors(mdata[<span>"prot"</span>], n_pcs=<span>30</span>, use_rep=<span>"X_pcahm"</span>)</span></code><code><span leaf=""><span>sc</span>.tl.umap(mdata[<span>"prot"</span>])</span></code><code><span leaf=""><span>sc</span>.pl.umap(mdata[<span>"prot"</span>], color=[<span>"donor"</span>, <span>"batch"</span>])</span></code></pre></section><section><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/e1cKg2SPUFheClT1I0Pjll7VLbOHowrNxf22icNNKlzDCiaXXg3tCFtpez85yjVjfiblNicSHPA4VJYvXmRKSnzticQ/640?wx_fmt=png&amp;from=appmsg" alt="../_images/a29b937703b9761dfbe83cda93420e5f35c115b3b154571114f86dfcac506cc7.png" data-ratio="0.4351851851851852" data-type="png" data-w="1080" data-imgfileid="100000510" src="https://mmbiz.qpic.cn/mmbiz_png/e1cKg2SPUFheClT1I0Pjll7VLbOHowrNxf22icNNKlzDCiaXXg3tCFtpez85yjVjfiblNicSHPA4VJYvXmRKSnzticQ/640?wx_fmt=png&amp;from=appmsg"></span></section><section><span leaf="">正如我们在这里看到的，不同捐赠者的细胞在嵌入过程中比以前更加混合。</span></section><section><ul><li><li></ul><pre data-lang="javascript"><code><span leaf="">sc.<span>pl</span>.<span>umap</span>(mdata[<span>"prot"</span>], color=[<span>"CD4-1"</span>, <span>"CD8"</span>, <span>"CD3"</span>])</span></code><code><span leaf="">sc.<span>pl</span>.<span>umap</span>(mdata[<span>"prot"</span>], color=[<span>"CD14-1"</span>, <span>"CD16"</span>])</span></code></pre></section><section><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/e1cKg2SPUFheClT1I0Pjll7VLbOHowrNuInOa0bxHYdyRI5ZNJVwECEbw2W96IYhbCSdoxwnj86uqtwe5wHEDw/640?wx_fmt=png&amp;from=appmsg" alt="../_images/1a31f24771435d329662885edff141523523eee2e627655d3c3bcd78e4da5e2d.png" data-ratio="0.2962962962962963" data-type="png" data-w="1080" data-imgfileid="100000511" src="https://mmbiz.qpic.cn/mmbiz_png/e1cKg2SPUFheClT1I0Pjll7VLbOHowrNuInOa0bxHYdyRI5ZNJVwECEbw2W96IYhbCSdoxwnj86uqtwe5wHEDw/640?wx_fmt=png&amp;from=appmsg"></span></section><section><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/e1cKg2SPUFheClT1I0Pjll7VLbOHowrNc1Nic7Vy3m3qibbf7QVuuGvpJuUanHIQ22dicaNK3QKjITjj7Zqzuna5w/640?wx_fmt=png&amp;from=appmsg" alt="../_images/b0dba46c159dc64d1b084896dee56e3a6f398abaad51a4dbc716986c6298ece4.png" data-ratio="0.4388888888888889" data-type="png" data-w="1080" data-imgfileid="100000512" src="https://mmbiz.qpic.cn/mmbiz_png/e1cKg2SPUFheClT1I0Pjll7VLbOHowrNc1Nic7Vy3m3qibbf7QVuuGvpJuUanHIQ22dicaNK3QKjITjj7Zqzuna5w/640?wx_fmt=png&amp;from=appmsg"></span></section><p><span leaf="">我们检查了一些标记基因的表达，以确认不同的细胞类型仍然彼此分离。我们可以看到，T细胞仍然形成一个单独的群体，进一步分裂成CD4和CD8 T细胞。</span></p><p><span leaf="">在以下步骤中，您现在可以继续对细胞进行聚类和注释，其过程与注释章节（</span><span leaf="">https://mp.weixin.qq.com/s/2c6PxgV-ZWQ6ZE8xaqYONw）中描述的过程类似。在这里，我们只使用了数据的ADT部分，因此丢失了研究中RNA部分包含的所有信息。在其他章节中，我们将探讨如何联合使用这两种模式。</span></p><section><ul><li></ul><pre data-lang=""><code><span leaf="">mdata</span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="cs"><code><span leaf="">MuData <span>object</span> <span>with</span> n_obs × n_vars = <span>119837</span> × <span>36741</span></span></code><code><span leaf="">  <span>var</span>:	<span>'gene_ids'</span>, <span>'feature_types'</span></span></code><code><span leaf="">  <span>2</span> modalities</span></code><code><span leaf="">    rna:	<span>119837</span> x <span>36601</span></span></code><code><span leaf="">      obs:	<span>'donor'</span>, <span>'batch'</span></span></code><code><span leaf="">      <span>var</span>:	<span>'gene_ids'</span>, <span>'feature_types'</span></span></code><code><span leaf="">    prot:	<span>119837</span> x <span>140</span></span></code><code><span leaf="">      obs:	<span>'donor'</span>, <span>'batch'</span>, <span>'n_genes_by_counts'</span>, <span>'log1p_n_genes_by_counts'</span>, <span>'total_counts'</span>, <span>'log1p_total_counts'</span>, <span>'n_counts'</span>, <span>'outliers'</span>, <span>'doublets_markers'</span></span></code><code><span leaf="">      <span>var</span>:	<span>'gene_ids'</span>, <span>'feature_types'</span>, <span>'n_cells_by_counts'</span>, <span>'mean_counts'</span>, <span>'log1p_mean_counts'</span>, <span>'pct_dropout_by_counts'</span>, <span>'total_counts'</span>, <span>'log1p_total_counts'</span></span></code><code><span leaf="">      uns:	<span>'doublets_markers_colors'</span>, <span>'neighbors'</span>, <span>'umap'</span>, <span>'donor_colors'</span>, <span>'batch_colors'</span></span></code><code><span leaf="">      obsm:	<span>'X_pcahm'</span>, <span>'X_umap'</span></span></code><code><span leaf="">      layers:	<span>'counts'</span></span></code><code><span leaf="">      obsp:	<span>'distances'</span>, <span>'connectivities'</span></span></code></pre></section><section><ul><li></ul><pre data-lang="javascript"><code><span leaf="">mdata.<span>write</span>(<span>"cite_batch_correction.h5mu"</span>)</span></code></pre></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/9LeoGNKysJ2lZckcinHj9w",target="_blank" rel="noopener noreferrer">原文链接</a>
