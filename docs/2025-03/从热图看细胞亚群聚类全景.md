---
title: "从热图看细胞亚群聚类全景"
date: 2025-03-05T03:06:41Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
从热图看细胞亚群聚类全景 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">写在开头</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">基于</span><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527174&amp;idx=1&amp;sn=11c6f1e72232a33e883d9bb3ec4a8621&amp;scene=21#wechat_redirect"><span leaf="">胃癌单细胞图谱：探索肿瘤微环境与亚型特异性表达模式-1</span></a><span leaf="">已经复现了Figure1B和C，那就也复现一下图D叭！</span></p><ul><li><section><span leaf="">Fiugre1B——</span><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247528101&amp;idx=1&amp;sn=51d148ddce142aef494be8f528595506&amp;scene=21#wechat_redirect"><span leaf="">UMAP图新解：首次分群后按大类分组加圈</span></a></section></li><li><section><span leaf="">Figure1C——</span><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247528319&amp;idx=1&amp;sn=908f4e12fcbda8795a357a55cea84a96&amp;scene=21#wechat_redirect"><span leaf="">多维度细胞比例图揭示细胞构成差异</span></a></section></li></ul><p data-tool="mdnice编辑器"><strong><span leaf="">Figure1D：为了支持有监督的细胞类型特异性标记分析，一个无监督的全局聚类相似性矩阵也将细胞状态划分为五个元聚类</span></strong></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044759" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcVia4qFIlZfmZN7H16e6Xfp51lLTvicxB4jUAXHtGvYoXHiapI2BmA1NWQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcVia4qFIlZfmZN7H16e6Xfp51lLTvicxB4jUAXHtGvYoXHiapI2BmA1NWQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">整体复现思路</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">从Seurat对象提取感兴趣的基因的表达数据，然后按细胞类型计算平均表达，接着计算各个细胞类型之间的相关性，最后用热图可视化相关性矩阵。</span></p><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">1. </span><strong><span leaf="">加载数据并提取标记基因</span></strong></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sce.all.int = readRDS(</span><span><span leaf="">'2-harmony/sce.all_int.rds'</span></span><span leaf="">)</span><br><span leaf="">markers &lt;- read_table(</span><span><span leaf="">"check-by-celltype/for_act.txt"</span></span><span leaf="">, col_names = F)</span><br></code></pre><ul><li><section><span leaf="">加载了降维聚类分群</span><code><span leaf="">sce.all.int</span></code><span leaf="">的Seurat对象</span></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044756" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcDmamJa97ibuLlazS0JbjiacNRELUJ2Y4cqbqudibrjiabedKeibTrMJMpvw/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcDmamJa97ibuLlazS0JbjiacNRELUJ2Y4cqbqudibrjiabedKeibTrMJMpvw/640?wx_fmt=png&amp;from=appmsg"></span></figure><ul><li><section><span leaf="">check-by-celltype中包含细胞类型和标记基因的文件</span><code><span leaf="">for_act.txt</span></code></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044758" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9Cc6bQPsxaKJqeSOBNwxvGY72H6t8Ph9sMiaT1rYRcO9HdtpviaMUN9SFqg/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9Cc6bQPsxaKJqeSOBNwxvGY72H6t8Ph9sMiaT1rYRcO9HdtpviaMUN9SFqg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">2. </span><strong><span leaf="">提取所有标记基因</span></strong></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">all_genes &lt;- c()</span><br><br><span><span leaf="">for</span></span><span leaf=""> (i </span><span><span leaf="">in</span></span><span leaf=""> 1:nrow(markers)) {</span><br><span leaf="">  gene_str &lt;- sub(</span><span><span leaf="">".*:"</span></span><span leaf="">, </span><span><span leaf="">""</span></span><span leaf="">, markers[i, 1])</span><br><span leaf="">  genes &lt;- unlist(strsplit(gene_str, </span><span><span leaf="">","</span></span><span leaf="">))</span><br><span leaf="">  all_genes &lt;- c(all_genes, genes)</span><br><span leaf="">}</span><br><br><span leaf="">all_genes &lt;- unique(all_genes)</span><br></code></pre><ul><li><section><span leaf="">从标记基因文件中提取每一行的基因名，并把它们存储到</span><code><span leaf="">all_genes</span></code><span leaf="">向量中。</span></section></li><li><section><span leaf="">使用正则表达式提取基因字符串，并通过</span><code><span leaf="">strsplit()</span></code><span leaf="">函数将基因名拆分（假设基因用逗号分隔）。</span></section></li><li><section><span leaf="">最后去掉了重复的基因名称（</span><code><span leaf="">unique()</span></code><span leaf="">）。</span></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044757" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CckP96HRpQn1xMcydKosK2Re17rLpDqWKQBzISuiaibqOcp8JgsoNMMdZQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CckP96HRpQn1xMcydKosK2Re17rLpDqWKQBzISuiaibqOcp8JgsoNMMdZQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">3. </span><strong><span leaf="">加载元数据并提取表达矩阵</span></strong></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">load(</span><span><span leaf="">"phe.Rdata"</span></span><span leaf="">)</span><br><span leaf="">sce.all.int@meta.data</span><span><span leaf="">$celltype</span></span><span leaf=""> &lt;- phe</span><span><span leaf="">$celltype</span></span><br><br><span><span leaf=""># 提取表达矩阵</span></span><br><span leaf="">expr_matrix &lt;- FetchData(sce.all.int, vars = all_genes)</span><br><br><span><span leaf=""># 提取元数据（如细胞类型）</span></span><br><span leaf="">meta_data &lt;- sce.all.int@meta.data</span><br><br><span><span leaf=""># 为方便，按细胞类型或群体分组（如果需要）</span></span><br><span leaf="">expr_matrix</span><span><span leaf="">$cell_type</span></span><span leaf=""> &lt;- meta_data</span><span><span leaf="">$celltype</span></span><br></code></pre><ul><li><section><p><span leaf="">加载了包含注释结果的</span><code><span leaf="">phe.Rdata</span></code><span leaf="">的元数据文件，将</span><code><span leaf="">phe</span></code><span leaf="">中的</span><code><span leaf="">celltype</span></code><span leaf="">列添加到</span><code><span leaf="">sce.all.int</span></code><span leaf="">的元数据中。</span></p></section></li><li><section><p><span leaf="">使用</span><code><span leaf="">FetchData()</span></code><span leaf="">函数从Seurat对象中提取之前提到的基因的表达数据，并将其存储在</span><code><span leaf="">expr_matrix</span></code><span leaf="">中。</span></p></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044760" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcQblqjaOPhDTvrKE1v1GDvssXcL1u3ibahnPMWdE7pOwnmOLmyBx6icWA/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcQblqjaOPhDTvrKE1v1GDvssXcL1u3ibahnPMWdE7pOwnmOLmyBx6icWA/640?wx_fmt=png&amp;from=appmsg"></span></figure><ul><li><section><span leaf="">将元数据中的</span><code><span leaf="">celltype</span></code><span leaf="">列添加到</span><code><span leaf="">expr_matrix</span></code><span leaf="">中，以便后续按细胞类型分组。</span></section></li></ul><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">4. </span><strong><span leaf="">按细胞类型计算平均表达</span></strong></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 按细胞类型计算平均表达量</span></span><br><span leaf="">average_expr &lt;- aggregate(. ~ cell_type, data = expr_matrix, mean)</span><br><br><span><span leaf=""># 去掉cell_type列，只保留数值矩阵</span></span><br><span leaf="">row.names(average_expr) &lt;- average_expr</span><span><span leaf="">$cell_type</span></span><br><span leaf="">average_expr &lt;- average_expr[ , -1]</span><br></code></pre><ul><li><section><span leaf="">使用</span><code><span leaf="">aggregate()</span></code><span leaf="">函数按</span><code><span leaf="">cell_type</span></code><span leaf="">列对表达数据进行聚合，计算每种细胞类型的平均基因表达水平。</span></section></li><li><section><code><span leaf="">row.names(average_expr) &lt;- average_expr$cell_type</span></code><span leaf="">：将细胞类型列设置为行名。</span></section></li><li><section><code><span leaf="">average_expr &lt;- average_expr[ , -1]</span></code><span leaf="">：去掉</span><code><span leaf="">cell_type</span></code><span leaf="">列，只保留表达矩阵。</span></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044764" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcsjjdcpxrC87FmwyURibicNGBu7IROj4UyIBllqm0QRe1tPXqvsOiaFVhg/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcsjjdcpxrC87FmwyURibicNGBu7IROj4UyIBllqm0QRe1tPXqvsOiaFVhg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">5. </span><strong><span leaf="">计算相关性矩阵</span></strong></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">mat &lt;- t(average_expr)  </span><span><span leaf=""># 转置矩阵，因为pheatmap要求行是基因，列是样本</span></span><br><span leaf="">cor_matrix &lt;- cor(mat, use = </span><span><span leaf="">"complete.obs"</span></span><span leaf="">)  </span><span><span leaf=""># 计算相关性矩阵</span></span><br></code></pre><ul><li><section><code><span leaf="">t(average_expr)</span></code><span leaf="">：转置数据矩阵，确保行是基因，列是细胞类型。</span></section></li><li><section><code><span leaf="">cor(mat, use = "complete.obs")</span></code><span leaf="">：计算相关性矩阵。</span><code><span leaf="">use = "complete.obs"</span></code><span leaf="">会忽略缺失值（NA）。</span></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044762" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcRYjtRu5Ir6nH4XO6Cq3n7hOw17ZLUjQbGyI3asr27QhdxIN0QFKmKQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcRYjtRu5Ir6nH4XO6Cq3n7hOw17ZLUjQbGyI3asr27QhdxIN0QFKmKQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">6. </span><strong><span leaf="">可视化相关性矩阵</span></strong></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">p &lt;- pheatmap(cor_matrix,</span><br><span leaf="">         color = colorRampPalette(c(</span><span><span leaf="">"white"</span></span><span leaf="">, </span><span><span leaf="">"#FEE5D9"</span></span><span leaf="">, </span><span><span leaf="">"red"</span></span><span leaf="">))(100),</span><br><span leaf="">         cluster_rows = F, </span><br><span leaf="">         cluster_cols = F, </span><br><span leaf="">         show_rownames = T, </span><br><span leaf="">         show_colnames = FALSE, </span><br><span leaf="">         main = </span><span><span leaf="">"Correlation Matrix Heatmap"</span></span><span leaf="">, </span><br><span leaf="">         fontsize_number = 10, </span><br><span leaf="">         fontsize_row = 8, </span><br><span leaf="">         fontsize_col = 8)</span><br></code></pre><ul><li><section><span leaf="">使用</span><code><span leaf="">pheatmap()</span></code><span leaf="">函数可视化相关性矩阵。</span></section></li><li><section><span leaf="">指定了一个颜色渐变，从白色到红色，反映从低到高的相关性。</span></section></li><li><section><code><span leaf="">cluster_rows = F</span></code><span leaf=""> 和 </span><code><span leaf="">cluster_cols = F</span></code><span leaf=""> 表示不对行和列进行聚类。</span></section></li><li><section><code><span leaf="">show_rownames = T</span></code><span leaf=""> 和 </span><code><span leaf="">show_colnames = FALSE</span></code><span leaf=""> 表示显示行名（基因名），不显示列名（细胞类型）。</span></section></li><li><section><code><span leaf="">fontsize_number</span></code><span leaf="">, </span><code><span leaf="">fontsize_row</span></code><span leaf="">, </span><code><span leaf="">fontsize_col</span></code><span leaf=""> 用来调整热图中的数字、行名、列名的字体大小。</span></section></li></ul><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044761" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcnlAK96ib3sRvdibBWnPiadIZHPSXF9TJp3OibBIXV4z3B1T4JTnX71rsOQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcnlAK96ib3sRvdibBWnPiadIZHPSXF9TJp3OibBIXV4z3B1T4JTnX71rsOQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">可改进点</span></span><span></span></h3><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044765" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcxKzjljyibibhAAfbKOPaSc70tbTYLYpBSUuweJtAzeBCv1rPlIicvkibfw/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9CcxKzjljyibibhAAfbKOPaSc70tbTYLYpBSUuweJtAzeBCv1rPlIicvkibfw/640?wx_fmt=png&amp;from=appmsg"></span></figure><ol><li><section><span leaf="">文献中细胞亚群的图例在左侧，排序方式好像也正好相反，可以进行调整</span></section></li><li><section><span leaf="">颜色可以按照自己的喜欢调整，选择合适的配色即可</span></section></li><li><section><span leaf="">文献中还分层进行标签的展示，可以手动添加</span></section></li></ol><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">结尾小结</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">复现文献好看的图就越来越能体会到小洁老师课上说的：</span><strong><span leaf="">画图代码+你的数据+解决问题的能力=你的图！</span></strong></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100044763" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9Ccic6bpX1ibClC5ZKApvf34icKSyiaI9X3AVaBQYHJGhZ5oNykiaSmlyBHp8g/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTRBZIuOnk2QRtTGtgeic9Ccic6bpX1ibClC5ZKApvf34icKSyiaI9X3AVaBQYHJGhZ5oNykiaSmlyBHp8g/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">一张图首先你要理解它是什么图，用到什么数据，代码还是其次，最主要的是要整理好数据，和具有解决问题的能力！所以新的一年一起学习起来吧，</span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247538685&amp;idx=1&amp;sn=00de34b1fe5811f22dd67cbc45ff1625&amp;scene=21#wechat_redirect"><span leaf="">生信入门&amp;数据挖掘线上直播课</span></a><span leaf="">每月滚动开课！等你来学！</span></strong></p></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/zHMt27-BSQ07PF83G_uBWw",target="_blank" rel="noopener noreferrer">原文链接</a>
