---
title: "Nature 复现 | 分面堆积柱形图+误差线+显著性"
date: 2025-03-26T14:39:17Z
draft: ["false"]
tags: [
  "fetched",
  "MsTt笔记"
]
categories: ["Acdemic"]
---
Nature 复现 | 分面堆积柱形图+误差线+显著性 by MsTt笔记
------
<div><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com" data-pm-slice="0 0 []"><section nodeleaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="MsTt笔记" data-from="1" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJLwvM2QW48QKCicY8yHrEfwZA1qzJqmnSDuICrXOZEk6YYntc7QSLbdwg12uibFOEziaEVEXhEJQ4vQ/0?wx_fmt=png" data-signature="💕Keep learning 代码分享😹只分享，不答疑，感谢理解" data-id="MzkxNDcwNzY2NQ==" data-is_biz_ban="0"></mp-common-profile></section><section data-mpa-powered-by="yiban.io" data-pm-slice="0 0 []"><span><span leaf=""><br></span></span></section><section data-mpa-powered-by="yiban.io" data-pm-slice="0 0 []"><span><span leaf="">请尊重原创劳动成果🙏</span></span></section><p><span><span leaf="">未经允许，不得转载，不可抄袭！</span></span></p><p data-tool="mdnice编辑器"><span leaf="">今天来复现<span textstyle=""> 2 个</span>高阶堆积柱形图。这种图可不是普通的柱形图，不仅带有分面分组，还加入了误差线和显著性星号标记，堪称数据可视化的“豪华套餐”。</span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现一</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">第一篇是 </span><strong><span leaf="">Nature Communications</span></strong><span leaf=""> 文章中 (Claiborne, D.T., Detwiler, Z., Docken, S.S. et al. High frequency CCR5 editing in human hematopoietic stem progenitor cells protects xenograft mice from HIV infection. Nat Commun 16, 446 (2025). https://doi.org/10.1038/s41467-025-55873-3) 的 Fig.4D</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">原图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBp7aPg5bgtdynQ3VUyicJiaRwibwk3dc7ib0Tfo2DD0zu9TicPf7Luiaa78cQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.45" data-type="png" data-w="1080" data-imgfileid="100000980" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBp7aPg5bgtdynQ3VUyicJiaRwibwk3dc7ib0Tfo2DD0zu9TicPf7Luiaa78cQ/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">这个堆积柱形图有效地展示了：</span></p><ul><li><section><span leaf="">各类细胞在总 hCD45+ 细胞中的比例，直观地展示各类细胞的相对变化。</span></section></li><li><section><span leaf="">不同颜色代表不同的细胞类型，便于快速识别和比较。</span></section></li><li><section><span leaf="">每个柱形图上都有误差线，表示数据的变异性，增加了科学性和可信度。</span></section></li><li><section><span leaf="">时间点分组（4周、8周等）展示了不同时间点上各类细胞比例的变化趋势。</span><span leaf="">布局合理，信息量大但不显得杂乱。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBSpoUPhtTyPiaPF0FIAOWTaEEM40aCBktIBpTCAte9s7onoSiaCQWenjA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.45740740740740743" data-type="png" data-w="1080" data-imgfileid="100000981" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBSpoUPhtTyPiaPF0FIAOWTaEEM40aCBktIBpTCAte9s7onoSiaCQWenjA/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">复现过程中学习到的技巧：</span></span></p><ul><li><section><span leaf="">如何给每个柱形添加误差线？分别计算每个柱子的均值及误差，并按照累加均值确定误差线的位置。</span></section></li><li><section><span leaf="">如何实现个性化的分面？使用</span><code><span leaf="">aes(x = interaction(treat, group)</span></code><span leaf="">创建一个交互项，将不同的处理条件（treat）和时间分组（group）结合起来，从而在图表中生成多个子图或面板。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">加载R包，准备数据</span></span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># 加载必要包</span></span></code><code><span leaf="">library(tidyverse)</span></code><code><span leaf="">library(readxl)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 读入数据</span></span></code><code><span leaf="">data &lt;- read_excel(<span>"data_1.xlsx"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 将数据转为适合绘图的长格式</span></span></code><code><span leaf="">data_long &lt;- data %&gt;%</span></code><code><span leaf="">  pivot_longer(cols = -c(group, treat, cell),</span></code><code><span leaf="">               names_to = <span>"variable"</span>, </span></code><code><span leaf="">               values_to = <span>"value"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 定义颜色</span></span></code><code><span leaf="">col &lt;- c(<span>"#fb00fd"</span>, <span>"#7003e1"</span>, <span>"#ffff67"</span>, <span>"#62c6f5"</span>, <span>"#fd6565"</span>, <span>"#fc7e09"</span>, <span>"#c44242"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 定义绘图顺序</span></span></code><code><span leaf="">data_long<span>$group</span> &lt;- <span>factor</span>(data_long<span>$group</span>, levels = c(<span>"4wks"</span>, <span>"8wks"</span>, <span>"12wks"</span>, <span>"16wks"</span>, <span>"20wks"</span>, <span>"24wks"</span>))</span></code><code><span leaf=""><br></span></code><code><span leaf="">data_long<span>$treat</span> &lt;- <span>factor</span>(data_long<span>$treat</span>, levels = c(<span>"unedited"</span>, <span>"GFP gRNA"</span>, <span>"TB48+TB50"</span>))</span></code><code><span leaf=""><br></span></code><code><span leaf="">cell_order &lt;- c(<span>"CD14+ Monocytes"</span>, <span>"CD11c+ Dendritic cells"</span>, <span>"CD123+ Dendritic cells"</span>,</span></code><code><span leaf="">                <span>"CD19+ B cells"</span>, <span>"CD235a+ erythroid"</span>, <span>"CD56+ NK cells"</span>, <span>"CD3+ T cells"</span>)</span></code><code><span leaf="">data_long<span>$cell</span> &lt;- <span>factor</span>(data_long<span>$cell</span>, levels = cell_order)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 计算均值及误差，并按照均值确定误差线位置</span></span></code><code><span leaf="">data_sum &lt;- data_long %&gt;% </span></code><code><span leaf="">  group_by(group, treat, cell) %&gt;% </span></code><code><span leaf="">  summarise(mean = mean(value, na.rm = T), sd = sd(value, na.rm = T)) %&gt;% </span></code><code><span leaf="">  mutate(position = cumsum(mean))</span></code><code><span leaf=""><br></span></code><code><span leaf="">data_sum<span>$cell</span> &lt;- <span>factor</span>(data_sum<span>$cell</span>, levels = rev(cell_order))</span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">读入数据，使用</span><code><span leaf="">pivot_longer()</span></code><span leaf="">将数据转换为适合绘图的长格式，自定义变量的颜色，使用</span><code><span leaf="">factor()</span></code><span leaf="">设置变量的展示顺序。</span></p><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">summarise()</span></code><span leaf="">函数计算均值和误差，使用</span><code><span leaf="">cumsum()</span></code><span leaf="">函数计算均值的累加，以确定每个条形图的误差线位置。</span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">此绘图数据，如需文末可以自助获取。</span></span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">绘图</span></span></h2><h4 data-tool="mdnice编辑器"><span></span><span leaf="">1. 基础图形</span><span></span></h4><section><ul><li><li><li><li></ul><pre data-lang="apache"><code><span leaf=""><span>p1</span> &lt;- ggplot(data_sum, aes(x = interaction(treat, group), y = mean, fill = cell)) +</span></code><code><span leaf="">  <span>geom_bar</span>(stat = <span>"identity"</span>, position = <span>"stack"</span>, width = <span>0</span>.<span>68</span>, color = <span>"black"</span>, size = <span>0</span>.<span>3</span>) +</span></code><code><span leaf="">  <span>geom_errorbar</span>(aes(ymin = position-sd, ymax = position+sd), </span></code><code><span leaf="">                <span>width</span> = <span>0</span>.<span>2</span>, linewidth = <span>0</span>.<span>3</span>)</span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">ggplot()</span></code><span leaf="">创建一个图形对象：</span></p><ul><li><section><code><span leaf="">aes(x = interaction(treat, group))</span></code><span leaf="">：将 treat 和 group 的交互作用作为 x 轴的变量，也就是每个组合都会有一个单独的图形。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_bar()</span></code><span leaf="">函数创建柱状图：</span></p><ul><li><section><code><span leaf="">stat = "identity"</span></code><span leaf="">: 表示 y 值直接来自数据，不需要计数。</span></section></li><li><section><code><span leaf="">position = "stack"</span></code><span leaf="">: 堆积柱状图，多个类别的值会堆叠在一起。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_errorbar()</span></code><span leaf="">函数添加误差线：</span></p><ul><li><section><code><span leaf="">ymin</span></code><span leaf="">和</span><code><span leaf="">ymax</span></code><span leaf="">: 定义误差条的上下限，这里用累加的均值±标准差来计算上下限。</span></section></li><li><section><code><span leaf="">width = 0.2</span></code><span leaf="">: 设置误差条的宽度。</span></section></li><li><section><code><span leaf="">linewidth = 0.3</span></code><span leaf="">: 设置误差条线的粗细。</span></section></li></ul><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBbXWESzoOTUcbvy08icyDmMJ6LVhhd2EgDUGghgftv62TsHpPxLuXNgA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4824074074074074" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100000987" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBbXWESzoOTUcbvy08icyDmMJ6LVhhd2EgDUGghgftv62TsHpPxLuXNgA/640?wx_fmt=png&amp;from=appmsg"></section><h4 data-tool="mdnice编辑器"><span></span><span leaf="">2. 个性化分面</span><span></span></h4><section><ul><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span leaf=""><span>p2</span> &lt;- p1 +</span></code><code><span leaf="">  <span>geom_vline</span>(xintercept = c(<span>3</span>.<span>5</span>, <span>6</span>.<span>5</span>, <span>9</span>.<span>5</span>, <span>12</span>.<span>5</span>, <span>15</span>.<span>5</span>), </span></code><code><span leaf="">             <span>linetype</span> = <span>"dashed"</span>, color = <span>"black"</span>,linewidth = <span>0</span>.<span>6</span>) +</span></code><code><span leaf="">  <span>geom_text</span>(data = data_label, aes(x = x, y = <span>123</span>, label = label), </span></code><code><span leaf="">            <span>size</span> = <span>5</span>, inherit.aes = FALSE) + </span></code><code><span leaf="">  <span>coord_cartesian</span>(ylim = c(<span>0</span>, <span>120</span>), clip = <span>"off"</span>)</span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_vline()</span></code><span leaf="">函数添加垂直线，用于分隔不同组别：</span></p><ul><li><section><code><span leaf="">xintercept</span></code><span leaf="">: 指定垂直线的位置。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_text()</span></code><span leaf="">函数添加分组的名称到图中：</span></p><ul><li><section><code><span leaf="">data_label</span></code><span leaf="">: 包含文本标签的数据框。</span></section></li><li><section><code><span leaf="">aes()</span></code><span leaf="">: 定义文本的位置和内容，其中 y 值固定为 123 以确保文本在合适的位置显示（需要根据实际情况调整）。</span></section></li><li><section><code><span leaf="">inherit.aes = FALSE</span></code><span leaf="">：忽略全局</span><span leaf="">aes()</span></section></li></ul><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBZ00Q5BQgSOxeFqhdt5xcmjbkV0eQiaQXqwrbqO79k41S3hw0DOZIrkQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.48148148148148145" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100000988" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBZ00Q5BQgSOxeFqhdt5xcmjbkV0eQiaQXqwrbqO79k41S3hw0DOZIrkQ/640?wx_fmt=png&amp;from=appmsg"></section><h4 data-tool="mdnice编辑器"><span></span><span leaf="">3. 美化主题</span><span></span></h4><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span leaf=""><span>p2</span> + coord_cartesian(ylim = c(<span>0</span>, <span>120</span>), clip = <span>"off"</span>) +</span></code><code><span leaf="">  <span>scale_fill_manual</span>(values = col)+</span></code><code><span leaf="">  <span>scale_x_discrete</span>(labels = function(x) gsub(<span>"\\..*"</span>, <span>""</span>, x)) + </span></code><code><span leaf="">  <span>scale_y_continuous</span>(breaks = seq(<span>0</span>, <span>100</span>, <span>20</span>), </span></code><code><span leaf="">                     <span>expand</span> = c(<span>0</span>, <span>0</span>))+</span></code><code><span leaf="">  <span>labs</span>(x = NULL, y = <span>"% of hCD45"</span>)+</span></code><code><span leaf="">  <span>theme_classic</span>() +</span></code><code><span leaf="">  <span>theme</span>(plot.margin = margin(t = <span>20</span>, l = <span>5</span>),</span></code><code><span leaf="">        <span>axis</span>.text.x = element_text(size = <span>14</span>, angle = <span>45</span>, vjust = <span>1</span>, hjust = <span>1</span>, color = <span>"black"</span>),</span></code><code><span leaf="">        <span>axis</span>.text.y = element_text(size = <span>14</span>, color = <span>"black"</span>),</span></code><code><span leaf="">        <span>axis</span>.title.y = element_text(size = <span>14</span>),</span></code><code><span leaf="">        <span>axis</span>.line = element_line(linewidth = <span>0</span>.<span>8</span>),</span></code><code><span leaf="">        <span>axis</span>.ticks = element_line(linewidth = <span>0</span>.<span>8</span>),</span></code><code><span leaf="">        <span>axis</span>.ticks.length = unit(<span>2</span>, <span>"mm"</span>),</span></code><code><span leaf="">        <span>legend</span>.title = element_blank(),</span></code><code><span leaf="">        <span>legend</span>.text = element_text(size = <span>12</span>),</span></code><code><span leaf="">        <span>legend</span>.key.height = unit(<span>1</span>, <span>"mm"</span>),</span></code><code><span leaf="">        <span>legend</span>.key.width = unit(<span>8</span>, <span>"mm"</span>),</span></code><code><span leaf="">        <span>legend</span>.key.spacing.y =unit(<span>4</span>, <span>"mm"</span>),</span></code><code><span leaf="">        <span>legend</span>.margin = margin(t = <span>35</span>, r = <span>5</span>))</span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">coord_cartesian(ylim = c(0, 120), clip = "off")</span></code><span leaf="">设置 y 轴范围从 0 到 120，并且允许图形溢出边界（</span><code><span leaf="">clip="off"</span></code><span leaf="">），保证添加的文本能完整显示。</span></p><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">scale_x_discrete(labels = function(x) gsub("\\..*", "", x))</span></code><span leaf="">对 x 轴标签进行处理，去掉点号及其后面的部分，只保留 treat 名称。</span></p><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBSpoUPhtTyPiaPF0FIAOWTaEEM40aCBktIBpTCAte9s7onoSiaCQWenjA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.45740740740740743" data-type="png" data-w="1080" data-imgfileid="100000986" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBSpoUPhtTyPiaPF0FIAOWTaEEM40aCBktIBpTCAte9s7onoSiaCQWenjA/640?wx_fmt=png&amp;from=appmsg"></span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现二</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">第二篇是 </span><strong><span leaf="">Nature Communications</span></strong><span leaf=""> 文章中 (Pena, I.A., Shi, J.S., Chang, S.M. et al. SLC25A38 is required for mitochondrial pyridoxal 5’-phosphate (PLP) accumulation. Nat Commun 16, 978 (2025). https://doi.org/10.1038/s41467-025-56130-3) 的 Fig.5D</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">原图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBVtpqZ610E4PWBQUNQXhtbGBknrWfzx8eSj9G1hnsmCdA0BqUuicDZkQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.973314606741573" data-type="png" data-w="712" data-imgfileid="100000989" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBVtpqZ610E4PWBQUNQXhtbGBknrWfzx8eSj9G1hnsmCdA0BqUuicDZkQ/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">这个堆积柱形图有效地展示了：</span></p><ul><li><section><span leaf="">各类代谢状态的比例，能够直观地看到各类代谢状态的相对变化。。</span></section></li><li><section><span leaf="">不同颜色代表不同的代谢状态，便于快速识别和比较。</span></section></li><li><section><span leaf="">每个柱形图上都有误差线，表示数据的变异性，增加了科学性和可信度。</span></section></li><li><section><span leaf="">实验条件分组（B6 low 和 B6 high）展示了不同条件下各类代谢状态的比例变化。</span></section></li><li><section><span leaf="">柱形图上方的统计显著性标记（如 **** 和 ns）展示了不同实验条件下各类代谢状态比例的显著性差异。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBnLTn9aia6MGOTPw6WulrqUd1U5vcSnEG8loCxEQZ4pLFEAAf1ZLYNOQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8501971090670171" data-type="png" data-w="761" data-imgfileid="100000990" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBnLTn9aia6MGOTPw6WulrqUd1U5vcSnEG8loCxEQZ4pLFEAAf1ZLYNOQ/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">复现过程中学习到的技巧：</span></span></p><ul><li><section><span leaf="">如何给每个柱形添加 T 字型的误差线？跟上个图一样，先分别计算每个柱子的均值及误差，并按照累加均值确定误差线的位置。再绘制一半的误差线，且宽度设为 0，然后再单独添加顶部的横线。</span></section></li><li><section><span leaf="">如何实现个性化的分面？这次使用</span><code><span leaf="">facet_wrap()</span></code><span leaf="">函数。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">加载R包，准备数据</span></span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># 加载必要包</span></span></code><code><span leaf="">library(tidyverse)</span></code><code><span leaf="">library(readxl)</span></code><code><span leaf="">library(reshape2)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 读入数据</span></span></code><code><span leaf="">data &lt;- read_excel(<span>"data_2.xlsx"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 将数据转为适合绘图的长格式</span></span></code><code><span leaf=""><span># 使用factor固定绘图顺序</span></span></code><code><span leaf="">data_long &lt;- melt(data, <span>id</span> = c(<span>"group"</span>, <span>"type"</span>, <span>"product"</span>)) %&gt;%</span></code><code><span leaf="">  mutate(group = <span>factor</span>(group, levels = c(<span>"B6 low"</span>, <span>"B6 high"</span>)),</span></code><code><span leaf="">         <span>type</span> = <span>factor</span>(<span>type</span>, levels = c(<span>"WT"</span>, <span>"+ ev"</span>, <span>"+A38-WT"</span>, <span>"+A38-R134C"</span>,</span></code><code><span leaf="">                                        <span>"SFXN1"</span>, <span>"SHMT1"</span>, <span>"SHMT2"</span>)),</span></code><code><span leaf="">         product = <span>factor</span>(product, levels = c(<span>"TTP (M+0)"</span>, <span>"D1-TTP (M+1)"</span>, <span>"D2-TTP (M+2)"</span>)))</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 定义颜色</span></span></code><code><span leaf=""><span>#col&lt;-c("#fcafa9","#009193","#000000") #文章中使用的颜色</span></span></code><code><span leaf="">col&lt;-c(<span>"#0d8442"</span>,<span>"#8dc63f"</span>,<span>"#00a76d"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 计算均值及误差，并按照均值确定误差线位置</span></span></code><code><span leaf="">data_sum &lt;- data_long %&gt;% </span></code><code><span leaf="">  group_by(group, <span>type</span>, product) %&gt;% </span></code><code><span leaf="">  summarise(mean = mean(value, na.rm = T), sd = sd(value, na.rm = T)) %&gt;% </span></code><code><span leaf="">  mutate(position = cumsum(mean))</span></code><code><span leaf=""><br></span></code><code><span leaf="">data_sum<span>$product</span> &lt;- <span>factor</span>(data_sum<span>$product</span>, levels = c(<span>"D2-TTP (M+2)"</span>, <span>"D1-TTP (M+1)"</span>, <span>"TTP (M+0)"</span>))</span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">读入数据，使用</span><code><span leaf="">melt()</span></code><span leaf="">将数据转换为适合绘图的长格式，使用</span><code><span leaf="">factor()</span></code><span leaf="">设置变量的展示顺序，自定义变量的颜色。</span></p><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">summarise()</span></code><span leaf="">函数计算均值和误差，使用</span><code><span leaf="">cumsum()</span></code><span leaf="">函数计算均值的累加，以确定每个条形图的误差线位置。</span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">此绘图数据，如需文末可以自助获取。</span></span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">绘图</span></span></h2><h4 data-tool="mdnice编辑器"><span></span><span leaf="">1.基础图形</span><span></span></h4><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span leaf=""><span>p1</span> &lt;- ggplot(data_sum, aes(x = type, y = mean, fill = product)) +</span></code><code><span leaf="">  <span>geom_bar</span>(stat = <span>"identity"</span>, position = <span>"stack"</span>, width = <span>0</span>.<span>68</span>, color = <span>"black"</span>, size = <span>0</span>.<span>3</span>) +</span></code><code><span leaf="">  <span>facet_wrap</span>(~ group, scales = <span>"free_x"</span>, strip.position = <span>"bottom"</span>) +</span></code><code><span leaf="">  <span>geom_errorbar</span>(aes(ymin = position, ymax = position+sd),</span></code><code><span leaf="">                <span>width</span> = <span>0</span>, color = <span>"black"</span>, linewidth = <span>0</span>.<span>8</span>) +</span></code><code><span leaf="">  <span>geom_segment</span>(data = data_sum[data_sum$sd &gt;<span>0</span>, ], </span></code><code><span leaf="">               <span>aes</span>(x = as.numeric(type)-<span>0</span>.<span>15</span>, xend = as.numeric(type)+<span>0</span>.<span>15</span>, </span></code><code><span leaf="">                   <span>y</span> = position+sd, yend = position+sd), </span></code><code><span leaf="">               <span>color</span> = <span>"black"</span>, linewidth = <span>0</span>.<span>8</span>)</span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_bar()</span></code><span leaf="">函数创建柱状图：</span></p><ul><li><section><code><span leaf="">stat = "identity"</span></code><span leaf="">: 表示 y 值直接来自数据，不需要计数。</span></section></li><li><section><code><span leaf="">position = "stack"</span></code><span leaf="">: 堆积柱状图，多个类别的值会堆叠在一起。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">facet_wrap()</span></code><span leaf="">函数按照 group 列进行分面，每个组都会有一个单独的小面板。</span></p><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_errorbar()</span></code><span leaf="">函数添加误差线：</span></p><ul><li><section><code><span leaf="">ymin</span></code><span leaf="">和</span><code><span leaf="">ymax</span></code><span leaf="">: 定义误差条的上下限，这里用累加的均值、累加的均值＋标准差来计算上下限（即只画上面的一半）。</span></section></li><li><section><code><span leaf="">width = 0</span></code><span leaf="">: 设置误差条的宽度为 0，即不显示上面的横线。</span></section></li><li><section><code><span leaf="">linewidth = 0.8</span></code><span leaf="">: 设置误差条线的粗细。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_segment()</span></code><span leaf="">函数绘制水平线段，用于表示误差条的上限。</span></p><ul><li><section><code><span leaf="">data_sum[data_sum$sd &gt; 0, ]</span></code><span leaf="">为条件过滤，来确保只有有标准差的数据才会被绘制。</span></section></li></ul><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBiaSfUfl7qDQ86ah5Tj7p6vrNTbDa4dpXEywYw8SROiavnL8QoUZjRzUg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9046296296296297" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100000996" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBiaSfUfl7qDQ86ah5Tj7p6vrNTbDa4dpXEywYw8SROiavnL8QoUZjRzUg/640?wx_fmt=png&amp;from=appmsg"></section><h4 data-tool="mdnice编辑器"><span></span><span leaf="">2.美化主题</span><span></span></h4><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="apache"><code><span leaf=""><span>p2</span> &lt;- p1 +</span></code><code><span leaf=""><span>scale_fill_manual</span>(values = col)+</span></code><code><span leaf="">  <span>scale_x_discrete</span>(expand = c(<span>0</span>.<span>15</span>, <span>0</span>)) +</span></code><code><span leaf="">  <span>scale_y_continuous</span>(breaks = seq(<span>0</span>, <span>100</span>, <span>25</span>), </span></code><code><span leaf="">                     <span>expand</span> = c(<span>0</span>, <span>0</span>)) +</span></code><code><span leaf="">  <span>theme_classic</span>() +</span></code><code><span leaf="">  <span>labs</span>(x = NULL, y = <span>"Fraction of total (%)"</span>) +</span></code><code><span leaf="">  <span>theme</span>(axis.ticks.length = unit(<span>2</span>, <span>"mm"</span>),</span></code><code><span leaf="">        <span>axis</span>.text.x = element_text(size = <span>18</span>, color = <span>"black"</span>, angle = <span>90</span>, hjust = <span>1</span>, vjust = <span>0</span>.<span>5</span>),</span></code><code><span leaf="">        <span>axis</span>.text.y = element_text(size = <span>18</span>, color = <span>"black"</span>),</span></code><code><span leaf="">        <span>axis</span>.title.y = element_text(size = <span>18</span>),</span></code><code><span leaf="">        <span>strip</span>.text.x = element_text(size = <span>20</span>),</span></code><code><span leaf="">        <span>panel</span>.spacing.x = unit(<span>0</span>, <span>"lines"</span>),</span></code><code><span leaf="">        <span>legend</span>.text = element_text(size = <span>16</span>),</span></code><code><span leaf="">        <span>legend</span>.title = element_blank(),</span></code><code><span leaf="">        <span>legend</span>.key.height = unit(<span>0</span>.<span>2</span>,<span>"cm"</span>),</span></code><code><span leaf="">        <span>legend</span>.key.width = unit(<span>0</span>.<span>9</span>,<span>"cm"</span>),</span></code><code><span leaf="">        <span>legend</span>.key.spacing.y =unit(<span>0</span>.<span>3</span>, <span>"cm"</span>),</span></code><code><span leaf="">        <span>legend</span>.justification = c(<span>0</span>, <span>0</span>),</span></code><code><span leaf="">        <span>legend</span>.position = c(-<span>0</span>.<span>3</span>, -<span>0</span>.<span>5</span>),</span></code><code><span leaf="">        <span>plot</span>.margin = margin(t = <span>35</span>, r = <span>5</span>, b = <span>5</span>, l = <span>60</span>),</span></code><code><span leaf="">        <span>strip</span>.placement = <span>"outside"</span>,</span></code><code><span leaf="">        <span>strip</span>.background = element_blank())</span></code></pre></section><p data-tool="mdnice编辑器"><code><span leaf="">scale_x_discrete(expand = c(0.15, 0))</span></code><span leaf="">: 对 x 轴进行扩展，使得柱子之间有一定间距。</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfB324KUx5L9S66CBDpMbTRWFrYibwHib7AUVbQ23Emf82OMchAdAia2ZVzg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8435185185185186" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100000995" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfB324KUx5L9S66CBDpMbTRWFrYibwHib7AUVbQ23Emf82OMchAdAia2ZVzg/640?wx_fmt=png&amp;from=appmsg"></section><h4 data-tool="mdnice编辑器"><span></span><span leaf="">3.注释显著性</span><span></span></h4><section><ul><li><li><li><li><li></ul><pre data-lang="apache"><code><span leaf=""><span>p2</span> +  geom_text(data = data_sum %&gt;% filter(group == <span>"B6 low"</span>) %&gt;% </span></code><code><span leaf="">            <span>summarize</span>(x = <span>2</span>, y = <span>110</span>, label = <span>"****"</span>, .groups = <span>"drop"</span>),</span></code><code><span leaf="">          <span>aes</span>(x = x, y = y, label = label), size = <span>5</span>, inherit.aes = FALSE) +  # 忽略全局 aes()</span></code><code><span leaf="">  <span>geom_text</span>(...) +</span></code><code><span leaf="">  <span>coord_cartesian</span>(ylim = c(<span>0</span>, <span>110</span>), clip = <span>"off"</span>)</span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">假设你已经完成了方差分析和多重比较，这里多次使用的</span><code><span leaf="">geom_text()</span></code><span leaf="">函数添加显著性标签到图中，为节省篇幅，仅展示其中一个：</span></p><ul><li><section><span leaf="">每个调用都使用了管道操作符</span><code><span leaf="">%&gt;%</span></code><span leaf="">, 对数据进行过滤和汇总，以获取特定组别下的位置（x 和 y）以及标签内容（label）。</span></section></li><li><section><code><span leaf="">inherit.aes = FALSE</span></code><span leaf="">：忽略全局 aes()</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">coord_cartesian(ylim = c(0, 110), clip = "off")</span></code><span leaf="">设置 y 轴范围从 0 到 120，并且允许图形溢出边界（</span><code><span leaf="">clip="off"</span></code><span leaf="">），保证添加的文本能完整显示。</span></p><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBnLTn9aia6MGOTPw6WulrqUd1U5vcSnEG8loCxEQZ4pLFEAAf1ZLYNOQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8501971090670171" data-type="png" data-w="761" data-imgfileid="100000992" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLDDtEqexSDjX40UWb9YGfBnLTn9aia6MGOTPw6WulrqUd1U5vcSnEG8loCxEQZ4pLFEAAf1ZLYNOQ/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">获取以 RProject 形式保存的绘图代码和测试数据，后台回复关键词: </span></span><strong><em><span leaf=""><span textstyle="">250326_stacked_bar</span></span></em></strong></p></section><section nodeleaf=""><mp-common-cpsad data-pluginname="mpcps" data-templateid="list" data-cpsversion="v120" data-goodssouce="1" data-traceid="b37e7607-4d7a-4ccd-889f-a7567046c227" data-pid="101_14835066"></mp-common-cpsad></section><section nodeleaf=""><mp-common-cpsad data-pluginname="mpcps" data-templateid="list" data-cpsversion="v120" data-goodssouce="1" data-traceid="b37e7607-4d7a-4ccd-889f-a7567046c227" data-pid="101_14324026"></mp-common-cpsad></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/sAUdbGpTR4TvReQu-a1DkA",target="_blank" rel="noopener noreferrer">原文链接</a>
