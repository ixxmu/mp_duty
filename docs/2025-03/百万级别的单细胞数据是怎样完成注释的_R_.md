---
title: "百万级别的单细胞数据是怎样完成注释的(R)"
date: 2025-03-14T01:07:19Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
百万级别的单细胞数据是怎样完成注释的(R) by 生信星球
------
<div><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com" data-pm-slice="3 5 []"><section><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-ratio="1" data-type="png" data-w="64" width="20px" data-imgfileid="100013059" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-ratio="1" data-type="png" data-w="64" width="20px" data-imgfileid="100013061" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"></span><span><span leaf=""> 今天是生信星球陪你的</span><span><strong><span leaf="">第1039天</span></strong></span></span><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-ratio="1" data-type="png" data-w="64" width="20px" data-imgfileid="100013060" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png">   </span></section><section><blockquote><section><span><span leaf="">公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span></span><span><span leaf="">我的课程都是循环开课，</span></span><span><span leaf="">点进去咨询微信，随时可以报名↓</span></span><span leaf=""><br></span></section><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247496614&amp;idx=1&amp;sn=4177354e87d394a022c3d410f482546a&amp;scene=21#wechat_redirect" textvalue="生信分‍析直播课程" data-itemshowtype="11" target="_blank" linktype="text" data-linktype="2">生信分析直播课程</a>(每月初开一期)</span></section><section><span leaf=""><a href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494919&amp;idx=2&amp;sn=967d8dcf0f9a22047ae0bd442b9d4ee6&amp;scene=21#wechat_redirect" textvalue="生信新手保护学‍习小组" data-itemshowtype="0" target="_blank" linktype="text" data-linktype="2">生信新手保护学习小组</a>（每月两期）</span></section><section><span leaf=""><a href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247495036&amp;idx=1&amp;sn=fe8bab2c3d21e7b0a919ad4f1641ca9c&amp;chksm=fdfba53eca8c2c286522b2accc0d4cb9dda7cd9a5b36695e66d393abb5bff396d6bcaa4c9cb8&amp;scene=21#wechat_redirect" textvalue="单细胞陪伴学习小组内测完成，长期招生中" data-itemshowtype="0" target="_blank" linktype="text" data-linktype="2">单细胞陪伴学习小组</a>（每月两期）</span></section></blockquote><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.背景知识</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">细胞数量太大时，单纯的一次降维聚类分群是无法搞定的，所以需要二次分群然后把注释的结果重新放回原来的对象中。</span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">2.加载数据</span></span><span></span></h3><p data-tool="mdnice编辑器"><code><span leaf="">sce.Rdata</span></code><span leaf="">是降维聚类分群+手动注释的结果,其中celltype列是细胞类型注释列。</span></p><p data-tool="mdnice编辑器"><span leaf="">seurat_Fibro.obs.csv是成纤维细胞二次分群+注释得到的meta表格。在本公众号聊天框(注意不是评论区)回复：<span textstyle="">anno1039</span>可以获取本文的示例数据。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">rm(list = ls())</span><span leaf=""><br></span><span leaf="">library(Seurat)</span><span leaf=""><br></span><span leaf="">library(dplyr)</span><span leaf=""><br></span><span leaf="">library(ggplot2)</span><span leaf=""><br></span><span leaf="">load(</span><span><span leaf="">"sce.Rdata"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">DimPlot(sce, reduction = </span><span><span leaf="">"umap"</span></span><span leaf="">,label=T)+NoLegend()+</span><span leaf=""><br></span><span leaf="">  scale_color_brewer(palette = </span><span><span leaf="">'Set1'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoE6AKc6lCXQwHbC7B8sW9SsVg6Wckic4mVuwiaDiaI00gVJnhJricxWib0oEhIE8Fcx7NxUDMl1IPkiapA/640?wx_fmt=other&amp;from=appmsg" alt="image.png" data-ratio="0.7138888888888889" data-type="other" data-w="1080" data-imgfileid="100013238" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoE6AKc6lCXQwHbC7B8sW9SsVg6Wckic4mVuwiaDiaI00gVJnhJricxWib0oEhIE8Fcx7NxUDMl1IPkiapA/640?wx_fmt=other&amp;from=appmsg"></span><figcaption><span leaf="">image.png</span></figcaption></figure><pre data-tool="mdnice编辑器"><code><span leaf="">subcell_annotator = read.csv(</span><span><span leaf="">'seurat_Fibro.obs.csv'</span></span><span leaf="">,row.names = 1)[</span><span><span leaf="">'celltype'</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">head(subcell_annotator)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf="">##                    celltype</span></span><span leaf=""><br></span><span><span leaf="">## AAAGGATGTAGAAACT-1       M0</span></span><span leaf=""><br></span><span><span leaf="">## AACAAAGGTAAGGTCG-1       M0</span></span><span leaf=""><br></span><span><span leaf="">## AACGGGACAACACAGG-1       M1</span></span><span leaf=""><br></span><span><span leaf="">## AACTTCTTCCTACAAG-1       M0</span></span><span leaf=""><br></span><span><span leaf="">## AAGATAGGTCGTTGGC-1       M1</span></span><span leaf=""><br></span><span><span leaf="">## AAGCCATTCTAGACCA-1       M1</span></span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">unique(subcell_annotator</span><span><span leaf="">$celltype</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf="">## [1] "M0" "M1"</span></span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.整合</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">将二次分群的结果整合到原来的seurat对象的meta.data中去</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">sce</span><span><span leaf="">$celltype</span></span><span leaf=""> = as.character(Idents(sce))</span><span leaf=""><br></span><span leaf="">sce</span><span><span leaf="">$celltype</span></span><span leaf=""> = ifelse(sce</span><span><span leaf="">$celltype</span></span><span leaf="">==</span><span><span leaf="">'Fibroblasts'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">       subcell_annotator</span><span><span leaf="">$celltype</span></span><span leaf="">[match(colnames(sce),rownames(subcell_annotator))],</span><span leaf=""><br></span><span leaf="">       sce</span><span><span leaf="">$celltype</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><blockquote><p><span leaf="">这句是R语言基础部分的两个精华知识ifelse和match的合体。</span></p><p><span leaf="">真羡慕你一步到位从我这里学到了这么厉害的技能👆！上别处找的实现这个目的的代码可能要写三五句呢，我的最简洁😄。</span></p></blockquote><h4 data-tool="mdnice编辑器"><span><span><span leaf=""> </span></span></span><span><span><span leaf=""> </span></span><span leaf="">☞补充学习match</span></span><span><span><span leaf=""> </span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">match函数时匹配，用于找出一个向量中的元素在另一个向量中的对应位置，非常实用的R语言神技能。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">x &lt;- c(</span><span><span leaf="">"f"</span></span><span leaf="">,</span><span><span leaf="">"b"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">y &lt;- c(</span><span><span leaf="">"b"</span></span><span leaf="">,</span><span><span leaf="">"c"</span></span><span leaf="">,</span><span><span leaf="">"f"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">match(x, y)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf="">## [1] 3 1</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">找出x的元素在y中的对应位置。3 1就表示 x里的两个元素f和b分别在y的第3和第1个位置</span></p><h4 data-tool="mdnice编辑器"><span><span><span leaf=""> </span></span></span><span><span><span leaf=""> </span></span><span leaf="">☞补充学习ifelse</span></span><span><span><span leaf=""> </span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">超级实用的函数,可以</span><strong><span leaf="">根据逻辑值是T还是F产生不同的值</span></strong></p><pre data-tool="mdnice编辑器"><code><span leaf="">age &lt;- 0:28</span><span leaf=""><br></span><span leaf="">age</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf="">##  [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</span></span><span leaf=""><br></span><span><span leaf="">## [26] 25 26 27 28</span></span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">ifelse(age&gt;18,</span><span><span leaf="">'+'</span></span><span leaf="">,</span><span><span leaf="">'-'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf="">##  [1] "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-" "-"</span></span><span leaf=""><br></span><span><span leaf="">## [20] "+" "+" "+" "+" "+" "+" "+" "+" "+" "+"</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">这就表示如果age&gt;18就产生+，否则就产生-。加号和减号只是例子，可以按需换成别的值。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">ifelse(age&gt;18,</span><span><span leaf="">"adult"</span></span><span leaf="">,</span><span><span leaf="">"child"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf="">##  [1] "child" "child" "child" "child" "child" "child" "child" "child" "child"</span></span><span leaf=""><br></span><span><span leaf="">## [10] "child" "child" "child" "child" "child" "child" "child" "child" "child"</span></span><span leaf=""><br></span><span><span leaf="">## [19] "child" "adult" "adult" "adult" "adult" "adult" "adult" "adult" "adult"</span></span><span leaf=""><br></span><span><span leaf="">## [28] "adult" "adult"</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">也支持多个条件，代码就要嵌套起来了。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">ifelse(age&gt;18,</span><span><span leaf="">"adult"</span></span><span leaf="">,ifelse(age&lt;=1,</span><span><span leaf="">"baby"</span></span><span leaf="">,</span><span><span leaf="">"child"</span></span><span leaf="">))</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf="">##  [1] "baby"  "baby"  "child" "child" "child" "child" "child" "child" "child"</span></span><span leaf=""><br></span><span><span leaf="">## [10] "child" "child" "child" "child" "child" "child" "child" "child" "child"</span></span><span leaf=""><br></span><span><span leaf="">## [19] "child" "adult" "adult" "adult" "adult" "adult" "adult" "adult" "adult"</span></span><span leaf=""><br></span><span><span leaf="">## [28] "adult" "adult"</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">这个是：大于18，就产生”adult”，否则再次用</span><code><span leaf="">ifesle</span></code><span leaf="">进行判断，如果小于1，就产生”baby”，否则就产生”child”。</span></p><h4 data-tool="mdnice编辑器"><span><span><span leaf=""> </span></span></span><span><span><span leaf=""> </span></span><span leaf="">双剑合璧</span></span><span><span><span leaf=""> </span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">因此，刚才的代码使用</span><code><span leaf="">ifelse</span></code><span leaf="">函数实现了分情况讨论：判断sce的每个细胞是否是my_sub(本例是Fibroblasts),如果是的话，就替换成subcell_annotator里面匹配的每个细胞对应的celltype，也就是M0和M1；否则就不替换，还是原来的celltype。</span></p><h4 data-tool="mdnice编辑器"><span><span><span leaf=""> </span></span></span><span><span><span leaf=""> </span></span><span leaf="">画个图看看咯</span></span><span><span><span leaf=""> </span></span></span></h4><pre data-tool="mdnice编辑器"><code><span leaf="">Idents(sce) = sce</span><span><span leaf="">$celltype</span></span><span leaf=""><br></span><span leaf="">DimPlot(sce,label = T)+NoLegend()+scale_color_brewer(palette = </span><span><span leaf="">'Set1'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoE6AKc6lCXQwHbC7B8sW9S4dUoRqpic7BQjQRZRIhJwo3k1uNRQxBwPiaiblGImJicOGOUPf8KR87zHQ/640?wx_fmt=other&amp;from=appmsg" alt="image.png" data-ratio="0.4166666666666667" data-type="other" data-w="1080" data-imgfileid="100013237" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHoE6AKc6lCXQwHbC7B8sW9S4dUoRqpic7BQjQRZRIhJwo3k1uNRQxBwPiaiblGImJicOGOUPf8KR87zHQ/640?wx_fmt=other&amp;from=appmsg"></span></figure></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/rU_uBGW-yyfFyLA_7XsPyQ",target="_blank" rel="noopener noreferrer">原文链接</a>
