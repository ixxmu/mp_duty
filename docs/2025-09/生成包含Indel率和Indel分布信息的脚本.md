---
title: "生成包含Indel率和Indel分布信息的脚本"
date: 2025-09-04T12:59:06Z
draft: ["false"]
tags: [
  "fetched",
  "东林的扯淡小屋"
]
categories: ["Acdemic"]
---
生成包含Indel率和Indel分布信息的脚本 by 东林的扯淡小屋
------
<div><section><span leaf=""><br></span></section><section><section><ul><li><li><li><li><li></ul><pre data-lang="swift"><code><span leaf=""><span>#</span><span>Example</span><span>: perl  </span><span>Indel_Calculate</span><span>.pl  </span><span>Sample</span><span>.</span><span>R1</span><span>.fastq.gz   spacer_sequence   reference_sequence</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>$filein</span><span>=</span><span>$ARGV</span><span>[</span><span>0</span><span>];  </span></span></code><code><span leaf=""><span>$fileout</span><span>=</span><span>"$filein.output.txt"</span><span>;</span></span></code><code><span leaf=""><span>$spacer</span><span>=</span><span>$ARGV</span><span>[</span><span>1</span><span>];  </span></span></code><code><span leaf=""><span>$reference</span><span>=</span><span>$ARGV</span><span>[</span><span>2</span><span>];</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>open</span><span>(</span><span>FF</span><span>,</span><span>"&gt;ref.fa"</span><span>); print </span><span>FF</span><span> </span><span><span>"&gt;ref</span></span><span><span>\n</span></span><span><span>$reference</span></span><span><span>\n</span></span><span><span>"</span></span><span>; close </span><span>FF</span><span>;</span></span></code><code><span leaf=""><span>#`bowtie2</span><span>-</span><span>build  ref.fa  ref.fa`;</span></span></code><code><span leaf=""><span>#`bowtie2  </span><span>--</span><span>very</span><span>-</span><span>sensitive  </span><span>-</span><span>x   ref.fa   </span><span>-</span><span>p  </span><span>3</span><span>  </span><span>-</span><span>U</span><span>  </span><span>$filein</span><span>   </span><span>--</span><span>no</span><span>-</span><span>unal   </span><span>-</span><span>S</span><span>  </span><span>$filein</span><span>.sam`;</span></span></code><code><span leaf=""><span>`bwa index ref.fa  ref.fa`;</span></span></code><code><span leaf=""><span>`bwa mem  </span><span>-</span><span>A2</span><span> </span><span>-</span><span>O3</span><span> </span><span>-</span><span>E1</span><span> </span><span>-</span><span>t </span><span>3</span><span> ref.fa  </span><span>$filein</span><span> </span><span>&gt;</span><span> </span><span>$filein</span><span>.sam  `;</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>$spacer</span><span>=~</span><span>tr</span><span>/atcg/</span><span>ATCG</span><span>/;  $len=length($spacer);  $bad_input=0;</span></span></code><code><span leaf=""><span>$reference=~tr/atcg</span><span>/ATCG/</span><span>;  </span><span>$r</span><span>=</span><span>$reference</span><span>;  </span><span>$r</span><span>=~</span><span>s</span><span>/$spacer/</span><span>\t</span><span>/;</span></span></code><code><span leaf=""><span>if($reference ne $r){@b=split/\t</span><span>/,$r; $start=length($b[0]); $end=$start+$len;}</span></span></code><code><span leaf=""><span>else{ $spacer=~tr/</span><span>ATCG</span><span>/TAGC/</span><span>;  </span><span>$spacer</span><span>=</span><span>reverse(</span><span>$spacer</span><span>); </span></span></code><code><span leaf=""><span>      </span><span>$r</span><span>=</span><span>$reference</span><span>;    </span><span>$r</span><span>=~</span><span>s</span><span>/$spacer/</span><span>\t</span><span>/;</span></span></code><code><span leaf=""><span>	  if($reference ne $r){@b=split/\t</span><span>/,$r; $start=length($b[0]);  $end=$start+$len;}</span></span></code><code><span leaf=""><span>	  else{$bad_input=1;}</span></span></code><code><span leaf=""><span>}</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>open(BB,"$filein.sam");   </span></span></code><code><span leaf=""><span>open(C1,"&gt;temp1");</span></span></code><code><span leaf=""><span>open(C2,"&gt;temp2");</span></span></code><code><span leaf=""><span>$Edit=0;  $Match=0;  $Deletion=0;  $Insertion=0;  $to=0;</span></span></code><code><span leaf=""><span>while($line=&lt;BB&gt;)</span></span></code><code><span leaf=""><span>{     chomp $line;</span></span></code><code><span leaf=""><span>      @bb=split/\s</span><span>+/</span><span>,</span><span>$line</span><span>;</span></span></code><code><span leaf=""><span>      </span><span>$ll</span><span>=</span><span>$bb</span><span>[</span><span>5</span><span>];   </span><span>$ll2</span><span>=</span><span>$bb</span><span>[</span><span>5</span><span>];    </span><span>$D</span><span>=</span><span>0</span><span>;   </span><span>$I</span><span>=</span><span>0</span><span>;  </span><span>$D2</span><span>=</span><span>0</span><span>;  </span><span>$I2</span><span>=</span><span>0</span><span>; </span><span>$overlap</span><span>=</span><span>0</span><span>;  </span></span></code><code><span leaf=""><span>      </span><span>$ll</span><span>=~</span><span>s</span><span>/M/</span><span>\t</span><span>/g;  $ll=~s/</span><span>D</span><span>/\t/</span><span>g; </span><span>$ll</span><span>=~</span><span>s</span><span>/I/</span><span>\t</span><span>/g;</span></span></code><code><span leaf=""><span>      $ll2=~s/</span><span>M</span><span>/M\t/</span><span>g;  </span><span>$ll2</span><span>=~</span><span>s</span><span>/D/</span><span>D</span><span>\t</span><span>/g; $ll2=~s/</span><span>I</span><span>/I\t/</span><span>g;</span></span></code><code><span leaf=""><span>      </span><span>@ar</span><span>=</span><span>split</span><span>/\s+/</span><span>,</span><span>$ll</span><span>;    </span><span>@ar2</span><span>=</span><span>split</span><span>/\s+/</span><span>,</span><span>$ll2</span><span>;</span></span></code><code><span leaf=""><span>      </span><span>$lenth</span><span>=</span><span>@ar</span><span>;  </span></span></code><code><span leaf=""><span>      </span><span>if</span><span>(</span><span>$bb</span><span>[</span><span>3</span><span>]</span><span>&gt;</span><span>1</span><span> </span><span>&amp;&amp;</span><span> </span><span>$bb</span><span>[</span><span>0</span><span>]</span><span>!=~/^</span><span>@</span><span>/){$to++;   </span></span></code><code><span leaf=""><span>      if($lenth&gt;1){</span></span></code><code><span leaf=""><span>          $seq0="_"x($bb[3]-1);  </span></span></code><code><span leaf=""><span>          $i=0;  $ss=0;  </span></span></code><code><span leaf=""><span>             $sum="$seq0";</span></span></code><code><span leaf=""><span>          while($i&lt;$lenth){   </span></span></code><code><span leaf=""><span>               if($ar2[$i]=~/</span><span>M</span><span>$</span><span>/){   $seq[$i]=substr($bb[9],$ss,$ar[$i]);    $ss=$ss+$ar[$i];  } </span></span></code><code><span leaf=""><span>               elsif($ar2[$i]=~/</span><span>D</span><span>$</span><span>/){   $seq[$i]="-"x$ar[$i];  if(($ss+$bb[3]-1)&gt;($end+10) || ($ss+$ar[$i]+$bb[3]-1)&lt;$start){}else{$overlap=1; $D2=1;   $D=$D+$ar[$i];}  }    </span></span></code><code><span leaf=""><span>               elsif($ar2[$i]=~/</span><span>I</span><span>$</span><span>/){   $seq[$i]=substr($bb[9],$ss,$ar[$i]);  $seq[$i]=~tr/</span><span>ATGC</span><span>/atgc/</span><span>;  </span></span></code><code><span leaf=""><span>           </span><span>if</span><span>((</span><span>$ss</span><span>+</span><span>$bb</span><span>[</span><span>3</span><span>]</span><span>-</span><span>1</span><span>)</span><span>&gt;</span><span>(</span><span>$end</span><span>+</span><span>10</span><span>) </span><span>||</span><span> (</span><span>$ss</span><span>+</span><span>$ar</span><span>[</span><span>$i</span><span>]</span><span>+</span><span>$bb</span><span>[</span><span>3</span><span>]</span><span>-</span><span>1</span><span>)</span><span>&lt;</span><span>$start</span><span>){}</span><span>else</span><span>{</span><span>$overlap</span><span>=</span><span>1</span><span>; </span><span>$I2</span><span>=</span><span>1</span><span>; </span><span>$I</span><span>=</span><span>$I</span><span>+</span><span>$ar</span><span>[</span><span>$i</span><span>]; }    </span><span>$ss</span><span>=</span><span>$ss</span><span>+</span><span>$ar</span><span>[</span><span>$i</span><span>]; }    </span></span></code><code><span leaf=""><span>             </span><span>$sum</span><span>=</span><span>"$sum$seq[$i]"</span><span>;</span></span></code><code><span leaf=""><span>           </span><span>$i</span><span>++</span><span>;  </span></span></code><code><span leaf=""><span>           }</span></span></code><code><span leaf=""><span>             </span><span>if</span><span>(</span><span>$overlap</span><span>&gt;</span><span>0</span><span>){  </span><span>$Edit</span><span>++</span><span>;  </span></span></code><code><span leaf=""><span>                        </span><span>if</span><span>(</span><span>$D2</span><span>&gt;</span><span>0</span><span>){</span><span>$Deletion</span><span>++</span><span>;}</span></span></code><code><span leaf=""><span>                        </span><span>if</span><span>(</span><span>$I2</span><span>&gt;</span><span>0</span><span>){</span><span>$Insertion</span><span>++</span><span>;}</span></span></code><code><span leaf=""><span>                 </span><span>$string</span><span>=</span><span><span>"$sum</span></span><span><span>\t</span></span><span><span>Del_len:$D</span></span><span><span>\t</span></span><span><span>Ins_len:$I"</span></span><span>;    #</span><span>$string</span><span>=</span><span>substr(</span><span>$string</span><span>,</span><span>$start</span><span>-</span><span>20</span><span>,</span><span>300</span><span>);</span></span></code><code><span leaf=""><span>                        print  </span><span>C1</span><span>  </span><span>$string</span><span>,</span><span><span>"</span></span><span><span>\n</span></span><span><span>"</span></span><span>;</span></span></code><code><span leaf=""><span>                 </span><span>if</span><span>(not exists </span><span>$v</span><span>{</span><span>$string</span><span>}){  </span><span>$v</span><span>{</span><span>$string</span><span>}</span><span>=</span><span>1</span><span>;  }</span><span>else</span><span>{  </span><span>$v</span><span>{</span><span>$string</span><span>}</span><span>++</span><span>;  }</span></span></code><code><span leaf=""><span>                      }</span></span></code><code><span leaf=""><span>      }</span><span>else</span><span>{     </span></span></code><code><span leaf=""><span>                                     </span><span>if</span><span>(</span><span>$ar2</span><span>[</span><span>0</span><span>]</span><span>=~/</span><span>M</span><span>$</span><span>/</span><span> </span><span>&amp;&amp;</span><span>   </span><span>$ar</span><span>[</span><span>0</span><span>]</span><span>&gt;</span><span>100</span><span>){</span></span></code><code><span leaf=""><span>                                        </span><span>$seq0</span><span>=</span><span>"_"</span><span>x(</span><span>$bb</span><span>[</span><span>3</span><span>]</span><span>-</span><span>1</span><span>);</span></span></code><code><span leaf=""><span>                                          </span><span>$seq1</span><span>=</span><span>substr(</span><span>$bb</span><span>[</span><span>9</span><span>],</span><span>0</span><span>,</span><span>$ar</span><span>[</span><span>0</span><span>]);      </span></span></code><code><span leaf=""><span>                                                    </span><span>$string</span><span>=</span><span><span>"$seq0$seq1</span></span><span><span>\t</span></span><span><span>Del_len:0</span></span><span><span>\t</span></span><span><span>Ins_len:0"</span></span><span>;    </span></span></code><code><span leaf=""><span>                           </span><span>if</span><span>(not exists </span><span>$v</span><span>{</span><span>$string</span><span>}){ </span><span>$v</span><span>{</span><span>$string</span><span>}</span><span>=</span><span>1</span><span>; }</span><span>else</span><span>{ </span><span>$v</span><span>{</span><span>$string</span><span>}</span><span>++</span><span>; }   </span></span></code><code><span leaf=""><span>                                        print  </span><span>C2</span><span>  </span><span>$string</span><span>,</span><span><span>"</span></span><span><span>\n</span></span><span><span>"</span></span><span>;    </span></span></code><code><span leaf=""><span>                                         </span><span>$Match</span><span>++</span><span>;   </span></span></code><code><span leaf=""><span>                                     }</span></span></code><code><span leaf=""><span>               }</span></span></code><code><span leaf=""><span>           }</span></span></code><code><span leaf=""><span>}</span></span></code><code><span leaf=""><span>$total</span><span>=</span><span>$Edit</span><span>+</span><span>$Match</span><span>;</span></span></code><code><span leaf=""><span>$RateE</span><span>=</span><span>int(</span><span>10000</span><span>*</span><span>$Edit</span><span>/($total+1))/</span><span>100</span><span>;</span></span></code><code><span leaf=""><span>$RateW</span><span>=</span><span>int(</span><span>100</span><span>*</span><span>(</span><span>100</span><span>-</span><span>$RateE</span><span>))</span><span>/100;</span></span></code><code><span leaf=""><span>close BB; close C1;  close C2;</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>open(AA,"temp1");   open(BB,"&gt;temp11");  while($line=&lt;AA&gt;){chomp $line;  @bb=split/\s</span><span>+/</span><span>,</span><span>$line</span><span>;     </span><span>$rate</span><span>=</span><span>int(</span><span>10000</span><span>*</span><span>$v</span><span>{</span><span>$line</span><span>}</span><span>/$total)/</span><span>100</span><span>;  </span><span>if</span><span>(not exists(</span><span>$vv</span><span>{</span><span>$line</span><span>})){print </span><span>BB</span><span> </span><span>$bb</span><span>[</span><span>0</span><span>],</span><span><span>"</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span><span>"Rate: $rate (%)</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span>"Count:$v{$line}"</span><span>,</span><span><span>"</span></span><span><span>\t</span></span><span><span>$bb[1]</span></span><span><span>\t</span></span><span><span>$bb[2]</span></span><span><span>\n</span></span><span><span>"</span></span><span>;  </span><span>$vv</span><span>{</span><span>$line</span><span>}</span><span>=</span><span>1</span><span>;  }  }  close </span><span>AA</span><span>; close </span><span>BB</span><span>;</span></span></code><code><span leaf=""><span>open</span><span>(</span><span>AA</span><span>,</span><span>"temp2"</span><span>);   </span><span>open</span><span>(</span><span>BB</span><span>,</span><span>"&gt;temp22"</span><span>);  </span><span>while</span><span>(</span><span>$line</span><span>=&lt;</span><span>AA</span><span>&gt;</span><span>){chomp </span><span>$line</span><span>;  </span><span>@bb</span><span>=</span><span>split</span><span>/\s+/</span><span>,</span><span>$line</span><span>;       </span><span>$rate</span><span>=</span><span>int(</span><span>10000</span><span>*</span><span>$v</span><span>{</span><span>$line</span><span>}</span><span>/$total)/</span><span>100</span><span>;   </span><span>if</span><span>(not exists(</span><span>$vv</span><span>{</span><span>$line</span><span>})){print </span><span>BB</span><span> </span><span>$bb</span><span>[</span><span>0</span><span>],</span><span><span>"</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span><span>"Rate: $rate (%)</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span>"Count:$v{$line}"</span><span>,</span><span><span>"</span></span><span><span>\t</span></span><span><span>$bb[1]</span></span><span><span>\t</span></span><span><span>$bb[2]</span></span><span><span>\n</span></span><span><span>"</span></span><span>;  </span><span>$vv</span><span>{</span><span>$line</span><span>}</span><span>=</span><span>1</span><span>;  }  }  close </span><span>AA</span><span>; close </span><span>BB</span><span>;</span></span></code><code><span leaf=""><span>`sort  </span><span>-</span><span>dk3,3nr  temp11  </span><span>&gt;</span><span>  temp11.sorted`;</span></span></code><code><span leaf=""><span>`sort  </span><span>-</span><span>dk3,3nr  temp22  </span><span>&gt;</span><span>  temp22.sorted`;</span></span></code><code><span leaf=""><span>open</span><span>(</span><span>AA</span><span>,</span><span>"temp22.sorted"</span><span>);  </span><span>$line</span><span>=&lt;</span><span>AA</span><span>&gt;</span><span>;   </span><span>@bb</span><span>=</span><span>split</span><span>/\s+/</span><span>,</span><span>$line</span><span>;  </span><span>$WT</span><span>=</span><span>$bb</span><span>[</span><span>0</span><span>];  close </span><span>AA</span><span>;</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>open</span><span>(</span><span>FF</span><span>,</span><span>"&gt;$fileout"</span><span>);</span></span></code><code><span leaf=""><span>     print </span><span>FF</span><span> </span><span><span>"Editing_rate: $RateE %</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span><span>"Editing_Reads: $Edit</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span>"Total_Reads: $total"</span><span>,</span><span><span>"</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span>"Deletion_Reads: $Deletion"</span><span>,</span><span><span>"</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span>"Insertion_Reads: $Insertion"</span><span>,</span><span><span>"</span></span><span><span>\n\n</span></span><span><span>&gt;reference</span></span><span><span>\n</span></span><span><span>$reference</span></span><span><span>\n</span></span><span><span>"</span></span><span>;</span></span></code><code><span leaf=""><span>    </span><span>if</span><span>(</span><span>$bad_input</span><span>==</span><span>0</span><span>){print </span><span>FF</span><span> </span><span>"\ "</span><span>x(</span><span>$start</span><span>-</span><span>8</span><span>),</span><span>"Target: "</span><span>,</span><span>"*"</span><span>x</span><span>$len</span><span>,</span><span><span>"</span></span><span><span>\n</span></span><span><span>"</span></span><span>;}</span></span></code><code><span leaf=""><span>    </span><span>else</span><span>{print </span><span>FF</span><span> </span><span>"Wrong input target sequences!"</span><span>;}</span></span></code><code><span leaf=""><span>    print </span><span>FF</span><span> </span><span><span>"$WT</span></span><span><span>\t</span></span><span><span>Rate: $RateW (%)</span></span><span><span>\t</span></span><span><span>"</span></span><span>,</span><span><span>"Count:$Match      Del_len:0       Ins_len:0</span></span><span><span>\n</span></span><span><span>"</span></span><span>;  </span></span></code><code><span leaf=""><span>close </span><span>FF</span><span>;</span></span></code><code><span leaf=""><span>`cat temp11.sorted </span><span>&gt;&gt;</span><span> </span><span>$fileout</span><span>`;</span></span></code><code><span leaf=""><span>`rm temp</span><span>*</span><span>`;</span></span></code><code><span leaf=""><span>`rm </span><span>$filein</span><span>.sam`;</span></span></code></pre></section></section><section><span leaf="">#https://github.com/yszhou2016/IscB/blob/main/Indel_Calculate.pl</span></section><section nodeleaf=""><img data-ratio="0.23148148148148148" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100028436" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoiaKLbobtxxpuVofXgcx6o0IGXvMc2fvsN7pxqWU9VAPLOiaOI6vZnjmyVibYVA3CkWmBMtlGnibpQdw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoiaKLbobtxxpuVofXgcx6o0IGXvMc2fvsN7pxqWU9VAPLOiaOI6vZnjmyVibYVA3CkWmBMtlGnibpQdw/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">perl Indel_Calculate.pl Sample.NGS.fastq.gz TGCTGTCTTGGGTGCATTGG  GGTCGGGCCTCCGAAACCATGAACTTTCTGCTGTCTTGGGTGCATTGGAGCCTTGCCTTGCTGCTCTACCTCCACCATGCCAAGGTAAGCGGTCGTGCCCTGCTGGCGCCGCGGGCCGCTGCGAGCGCCTCTCCCGGCTGGGGACG</span></section><h3><span leaf="">关键转换步骤说明</span></h3><ol><li><p><strong><span leaf="">参数处理与参考生成</span></strong><span leaf="">：</span></p></li></ol><ul><li><p><span leaf="">使用Bash处理输入参数并生成参考文件。</span></p></li><li><p><span leaf="">调用</span><code><span leaf="">bwa</span></code><span leaf="">进行索引和比对。</span></p></li></ul><li><p><strong><span leaf="">目标区域定位</span></strong><span leaf="">：</span></p></li><ul><li><p><span leaf="">使用</span><code><span leaf="">tr</span></code><span leaf="">和</span><code><span leaf="">rev</span></code><span leaf="">处理spacer序列的正反向互补。</span></p></li><li><p><span leaf="">使用</span><code><span leaf="">awk</span></code><span leaf="">查找序列位置，替代原Perl的正则匹配。</span></p></li></ul><li><p><strong><span leaf="">SAM文件解析</span></strong><span leaf="">：</span></p></li><ul><li><p><span leaf="">逐行读取SAM文件，跳过头部。</span></p></li><li><p><span leaf="">解析CIGAR字符串，跟踪当前参考位置。</span></p></li><li><p><span leaf="">判断每个操作是否影响目标区域，统计indel。</span></p></li></ul><ul><li><p><span leaf="">使用Perl嵌入脚本处理复杂的CIGAR解析和位置判断：</span></p></li></ul><li><p><strong><span leaf="">结果生成</span></strong><span leaf="">：</span></p></li><ul><li><p><span leaf="">计算编辑率并格式化输出。</span></p></li><li><p><span leaf="">按频率排序变异类型并写入结果文件。</span></p></li></ul><li><p><strong><span leaf="">清理</span></strong><span leaf="">：</span></p></li><ul><li><p><span leaf="">删除临时文件和索引。</span></p></li></ul><section><span leaf=""><br></span></section><section nodeleaf=""><img data-ratio="0.5861111111111111" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100028437" data-src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoiaKLbobtxxpuVofXgcx6o0skPfibbxfXLHFRtRFibgvqugsApiae28EL8vu0Mibb1PU1f8cMY9x9iajIw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/kZ1wdgAscBoiaKLbobtxxpuVofXgcx6o0skPfibbxfXLHFRtRFibgvqugsApiae28EL8vu0Mibb1PU1f8cMY9x9iajIw/640?wx_fmt=png&amp;from=appmsg"></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/GolbVUCZHUyraMCPavj2hg",target="_blank" rel="noopener noreferrer">原文链接</a>
