---
title: "单细胞RNA速率-R语言版"
date: 2025-09-15T10:58:57Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
单细胞RNA速率-R语言版 by 生信星球
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com" data-pm-slice="3 5 []"><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com" data-pm-slice="0 0 []"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-ratio="1" data-type="png" data-w="64" width="20px" data-imgfileid="100013059" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-ratio="1" data-type="png" data-w="64" width="20px" data-imgfileid="100013061" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"></span><span><span leaf=""> 今天是生信星球陪你的</span><span><strong><span leaf="">第1054天</span></strong></span></span><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-ratio="1" data-type="png" data-w="64" width="20px" data-imgfileid="100013060" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png">   </span></section><section><blockquote><section><span><span leaf="">公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span></span><span><span leaf="">我的课程都是循环开课，</span></span><span><span leaf="">点进去咨询微信，随时可以报名↓</span></span><span leaf=""><br></span></section><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247496614&amp;idx=1&amp;sn=4177354e87d394a022c3d410f482546a&amp;scene=21#wechat_redirect" textvalue="生信分‍析直播课程" data-itemshowtype="11" linktype="text" data-linktype="2">生信分析直播课程</a>(每月初开一期)</span></section><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247497024&amp;idx=2&amp;sn=8c8b240b5df1d3b2c2e29b17f407ee75&amp;scene=21#wechat_redirect" textvalue="生信新手保护学习小组长期报名中" data-itemshowtype="0" linktype="text" data-linktype="2">生信新手保护学习小组长期报名中</a>（每月一期）</span></section><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247497024&amp;idx=1&amp;sn=6bd813f1722c4d6e6ca6eb0b1ce60848&amp;scene=21#wechat_redirect" textvalue="单细胞陪伴学习小组" data-itemshowtype="0" linktype="text" data-linktype="2">单细胞陪伴学习小组</a>（每月一期）</span></section></blockquote></section></section><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">RNA速率（RNA velocity）分析是一种通过比较未剪接（unspliced）和已剪接（spliced）RNA的比例来推断细胞状态转换方向的方法。本教程会介绍如何使用velocyto.R进行RNA速率分析。</span></p><blockquote><p><span leaf="">其实做RNA速率最好是用python，R版本的实现还是简陋了点儿。且需要注意，velocyto.R只能在服务器和mac上运行，原则上不支持Windows，此处省略n个理由，如果实在不想或者没有服务器可用，可以搜索一下网上的教程，我看到了有办法实现，但还是要花点钱钱，自行搜索一下吧~</span></p></blockquote><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">1. 环境准备和数据加载</span></span><span></span></h3><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">1.1 加载必要的R包</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">首先清空工作环境，然后加载分析所需的R包。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">rm(list = ls())</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(velocyto.R)  </span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(Seurat)      </span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(SeuratWrappers)</span><span leaf=""><br></span><span leaf="">RhpcBLASctl::blas_set_num_threads(</span><span><span leaf="">1</span></span><span leaf="">)  </span><span><span leaf=""># 限制线程数，防止后面的步骤内存溢出</span></span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">1.2 读取loom文件</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">loom文件是velocyto输出的标准格式，包含了spliced（已剪接）和unspliced（未剪接）的RNA计数矩阵。这两种RNA的比例可以反映基因表达的动态变化。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">ldat &lt;- ReadVelocity(file = </span><span><span leaf="">"GSM5824332_236D_236D_V300044428.loom"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">str(ldat,max.level = </span><span><span leaf="">1</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">## List of 3</span><span leaf=""><br></span><span leaf="">##  $ spliced  :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots</span><span leaf=""><br></span><span leaf="">##  $ unspliced:Formal class 'dgCMatrix' [package "Matrix"] with 6 slots</span><span leaf=""><br></span><span leaf="">##  $ ambiguous:Formal class 'dgCMatrix' [package "Matrix"] with 6 slots</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">示例数据可以从GEO数据库查询编号：GSM5824332，拉到页面最下方，即可下载到。</span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">2. 数据质量控制</span></span><span></span></h3><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">2.1 细胞过滤</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">过滤掉低质量的细胞是单细胞分析的重要步骤。这里我们保留总表达量大于等于800的细胞。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 设置过滤阈值，官网给的是1000，但我这个数据设置1000就基本不剩啥了，所以改小了一点。</span></span><span leaf=""><br></span><span leaf="">k &lt;- colSums(ldat$spliced) &gt;= </span><span><span leaf="">700</span></span><span leaf="">;table(k)  </span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">## k</span><span leaf=""><br></span><span leaf="">## FALSE  TRUE </span><span leaf=""><br></span><span leaf="">##  7161   908</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 对ldat中的每个矩阵应用相同的过滤</span></span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> (i </span><span><span leaf="">in</span></span><span leaf=""> </span><span><span leaf="">1</span></span><span leaf="">:length(ldat)){</span><span leaf=""><br></span><span leaf="">  ldat[[i]] &lt;- ldat[[i]][,k]</span><span leaf=""><br></span><span leaf="">  rownames(ldat[[i]]) &lt;- make.unique(rownames(ldat[[i]]))</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">2.2 创建Seurat对象</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">将过滤后的数据转换为Seurat对象，便于后续的标准化分析流程。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 提取spliced和unspliced数据</span></span><span leaf=""><br></span><span leaf="">emat &lt;- ldat$spliced    </span><span><span leaf=""># 已剪接RNA矩阵</span></span><span leaf=""><br></span><span leaf="">nmat &lt;- ldat$unspliced  </span><span><span leaf=""># 未剪接RNA矩阵</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">scRNA &lt;- as.Seurat(x = ldat)</span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">3. 标准单细胞分析流程</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">执行Seurat的标准预处理流程，降维聚类分群。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">scRNA &lt;- NormalizeData(scRNA)</span><span leaf=""><br></span><span leaf="">scRNA &lt;- FindVariableFeatures(scRNA)</span><span leaf=""><br></span><span leaf="">scRNA &lt;- ScaleData(scRNA)</span><span leaf=""><br></span><span leaf="">scRNA &lt;- RunPCA(scRNA)</span><span leaf=""><br></span><span leaf="">scRNA &lt;- FindNeighbors(scRNA, dims = </span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">15</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">scRNA &lt;- RunUMAP(scRNA, dim = </span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">15</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">scRNA &lt;- FindClusters(scRNA,resolution = </span><span><span leaf="">0.5</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck</span><span leaf=""><br></span><span leaf="">## </span><span leaf=""><br></span><span leaf="">## Number of nodes: 908</span><span leaf=""><br></span><span leaf="">## Number of edges: 38414</span><span leaf=""><br></span><span leaf="">## </span><span leaf=""><br></span><span leaf="">## Running Louvain algorithm...</span><span leaf=""><br></span><span leaf="">## Maximum modularity in 10 random starts: 0.7012</span><span leaf=""><br></span><span leaf="">## Number of communities: 5</span><span leaf=""><br></span><span leaf="">## Elapsed time: 0 seconds</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">UMAPPlot(scRNA)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8XptWxI29lXoaHarPhzXHibY5ar9ZK8xgrVNia8rJiaAvkpOrQ3EVWW6Wg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-imgfileid="100013555" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8XptWxI29lXoaHarPhzXHibY5ar9ZK8xgrVNia8rJiaAvkpOrQ3EVWW6Wg/640?wx_fmt=png&amp;from=appmsg"></span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">4. 细胞类型注释</span></span><span></span></h3><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">4.1 使用SingleR进行自动注释</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">SingleR是一个基于参考数据集的自动细胞类型注释工具。这里我们使用BlueprintEncode参考数据集。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">library</span></span><span leaf="">(celldex)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(SingleR)</span><span leaf=""><br></span><span leaf="">ls(</span><span><span leaf="">"package:celldex"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">##  [1] "BlueprintEncodeData"              "DatabaseImmuneCellExpressionData"</span><span leaf=""><br></span><span leaf="">##  [3] "defineTextQuery"                  "fetchLatestVersion"              </span><span leaf=""><br></span><span leaf="">##  [5] "fetchMetadata"                    "fetchReference"                  </span><span leaf=""><br></span><span leaf="">##  [7] "HumanPrimaryCellAtlasData"        "ImmGenData"                      </span><span leaf=""><br></span><span leaf="">##  [9] "listReferences"                   "listVersions"                    </span><span leaf=""><br></span><span leaf="">## [11] "MonacoImmuneData"                 "MouseRNAseqData"                 </span><span leaf=""><br></span><span leaf="">## [13] "NovershternHematopoieticData"     "saveReference"                   </span><span leaf=""><br></span><span leaf="">## [15] "searchReferences"                 "surveyReferences"</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">f = </span><span><span leaf="">"ref_BlueprintEncode.RData"</span></span><span leaf=""><br></span><span><span leaf="">if</span></span><span leaf="">(!file.exists(f)){</span><span leaf=""><br></span><span leaf="">  ref &lt;- celldex::BlueprintEncodeData()</span><span leaf=""><br></span><span leaf="">  save(ref,file = f)</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf="">ref &lt;- get(load(f))</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(BiocParallel)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">test = scRNA@assays$spliced$data</span><span leaf=""><br></span><span leaf="">pred.scRNA &lt;- SingleR(</span><span leaf=""><br></span><span leaf="">  test = test,                    </span><span><span leaf=""># 测试数据</span></span><span leaf=""><br></span><span leaf="">  ref = ref,                      </span><span><span leaf=""># 参考数据集</span></span><span leaf=""><br></span><span leaf="">  labels = ref$label.main,        </span><span><span leaf=""># 使用主要细胞类型标签</span></span><span leaf=""><br></span><span leaf="">  clusters = scRNA@active.ident   </span><span><span leaf=""># 按聚类进行注释</span></span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 查看注释结果</span></span><span leaf=""><br></span><span leaf="">pred.scRNA$pruned.labels</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">## [1] "Neurons"          "Epithelial cells" "Erythrocytes"     "Mesangial cells"  "Monocytes"</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">4.2 可视化注释准确性</span></span><span><span></span></span></h4><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 绘制注释得分热图</span></span><span leaf=""><br></span><span leaf="">plotScoreHeatmap(</span><span leaf=""><br></span><span leaf="">  pred.scRNA, </span><span leaf=""><br></span><span leaf="">  clusters=pred.scRNA@rownames, </span><span leaf=""><br></span><span leaf="">  fontsize.row = </span><span><span leaf="">9</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  show_colnames = </span><span><span leaf="">T</span></span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8HXyJxcEOFRicoGzOOtyzREQ2Y2ey5ia2yicVwn7Uh22Due2RGrx4iauGzw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-imgfileid="100013552" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8HXyJxcEOFRicoGzOOtyzREQ2Y2ey5ia2yicVwn7Uh22Due2RGrx4iauGzw/640?wx_fmt=png&amp;from=appmsg"></span></p><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">4.3 更新细胞类型标签</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">将自动注释的结果应用到Seurat对象中。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 创建新的聚类标签</span></span><span leaf=""><br></span><span leaf="">new.cluster.ids &lt;- pred.scRNA$pruned.labels</span><span leaf=""><br></span><span leaf="">names(new.cluster.ids) &lt;- levels(scRNA)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 查看原始聚类</span></span><span leaf=""><br></span><span leaf="">levels(scRNA)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">## [1] "0" "1" "2" "3" "4"</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 重命名聚类</span></span><span leaf=""><br></span><span leaf="">scRNA &lt;- RenameIdents(scRNA,new.cluster.ids)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 查看更新后的聚类</span></span><span leaf=""><br></span><span leaf="">levels(scRNA)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">## [1] "Neurons"          "Epithelial cells" "Erythrocytes"     "Mesangial cells"  "Monocytes"</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 绘制UMAP图</span></span><span leaf=""><br></span><span leaf="">p3 &lt;- DimPlot(</span><span leaf=""><br></span><span leaf="">  scRNA, </span><span leaf=""><br></span><span leaf="">  reduction = </span><span><span leaf="">"umap"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  label = </span><span><span leaf="">T</span></span><span leaf="">,         </span><span><span leaf=""># 显示标签</span></span><span leaf=""><br></span><span leaf="">  pt.size = </span><span><span leaf="">0.5</span></span><span leaf="">      </span><span><span leaf=""># 点的大小</span></span><span leaf=""><br></span><span leaf="">) + NoLegend()</span><span leaf=""><br></span><span leaf="">p3</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8cFzz2saHeIu2Ny7gW5qXrkdLicx9rUlbJtGBulMkFGI0lsJSic0KI5TA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-imgfileid="100013553" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8cFzz2saHeIu2Ny7gW5qXrkdLicx9rUlbJtGBulMkFGI0lsJSic0KI5TA/640?wx_fmt=png&amp;from=appmsg"></span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">5. RNA速率分析</span></span><span></span></h3><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">5.1 准备速率分析所需数据</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">为RNA速率分析准备必要的数据，包括细胞分组信息、颜色设置和细胞间距离计算。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 设置细胞群颜色</span></span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(paletteer)</span><span leaf=""><br></span><span leaf="">n = nlevels(scRNA)  </span><span><span leaf=""># 获取细胞类型数量</span></span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(RColorBrewer)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 使用调色板为不同细胞类型分配颜色</span></span><span leaf=""><br></span><span leaf="">cell.colors &lt;- colorRampPalette(paletteer_d(</span><span><span leaf="">"RColorBrewer::Set1"</span></span><span leaf="">))(n)[Idents(scRNA)]</span><span leaf=""><br></span><span leaf="">names(cell.colors) = colnames(scRNA)</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">5.2 计算RNA速率</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">使用gene.relative.velocity.estimates函数计算每个基因的相对速率。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">scRNA = RunVelocity(object = scRNA, deltaT = </span><span><span leaf="">1</span></span><span leaf="">, kCells = </span><span><span leaf="">25</span></span><span leaf="">, fit.quantile = </span><span><span leaf="">0.02</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">6. 速率可视化</span></span><span></span></h3><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">6.1 全局速率场可视化</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">在UMAP图上展示整体的RNA速率场，箭头表示细胞状态转换的方向。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 获取UMAP坐标</span></span><span leaf=""><br></span><span leaf="">emb &lt;- scRNA@reductions$umap@cell.embeddings</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 绘制全局速率图</span></span><span leaf=""><br></span><span leaf="">show.velocity.on.embedding.cor(</span><span leaf=""><br></span><span leaf="">  emb,                          </span><span><span leaf=""># UMAP坐标</span></span><span leaf=""><br></span><span leaf="">  Tool(object = scRNA,slot = </span><span><span leaf="">"RunVelocity"</span></span><span leaf="">),                         </span><span><span leaf=""># 速率信息</span></span><span leaf=""><br></span><span leaf="">  cell.colors=cell.colors,      </span><span><span leaf=""># 细胞颜色</span></span><span leaf=""><br></span><span leaf="">  n=</span><span><span leaf="">100</span></span><span leaf="">,                        </span><span><span leaf=""># 显示的箭头数量</span></span><span leaf=""><br></span><span leaf="">  scale = </span><span><span leaf="">'sqrt'</span></span><span leaf="">,               </span><span><span leaf=""># 箭头缩放方式</span></span><span leaf=""><br></span><span leaf="">  cex =</span><span><span leaf="">1.2</span></span><span leaf="">,                     </span><span><span leaf=""># 点的大小</span></span><span leaf=""><br></span><span leaf="">  arrow.scale = </span><span><span leaf="">1</span></span><span leaf="">,              </span><span><span leaf=""># 箭头大小缩放因子</span></span><span leaf=""><br></span><span leaf="">  show.grid.flow = </span><span><span leaf="">TRUE</span></span><span leaf="">,        </span><span><span leaf=""># 是否显示网格流</span></span><span leaf=""><br></span><span leaf="">  min.grid.cell.mass = </span><span><span leaf="">0.5</span></span><span leaf="">,     </span><span><span leaf=""># 最小网格细胞质量</span></span><span leaf=""><br></span><span leaf="">  grid.n = </span><span><span leaf="">20</span></span><span leaf="">,                  </span><span><span leaf=""># 网格数量</span></span><span leaf=""><br></span><span leaf="">  arrow.lwd = </span><span><span leaf="">1</span></span><span leaf="">,                </span><span><span leaf=""># 箭头线宽</span></span><span leaf=""><br></span><span leaf="">  do.par = </span><span><span leaf="">T</span></span><span leaf="">,                   </span><span><span leaf=""># 是否设置图形参数</span></span><span leaf=""><br></span><span leaf="">  cell.border.alpha = </span><span><span leaf="">0.5</span></span><span leaf="">       </span><span><span leaf=""># 细胞边界透明度</span></span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8LTuqoe3HoAEXxkYFwdQ7NOwt6IFEP7ibKdG04SqJkBUzlicHkgC5fE5Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-imgfileid="100013556" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8LTuqoe3HoAEXxkYFwdQ7NOwt6IFEP7ibKdG04SqJkBUzlicHkgC5fE5Q/640?wx_fmt=png&amp;from=appmsg"></span></p><pre data-tool="mdnice编辑器"><code><span leaf="">## delta projections ... sqrt knn ... transition probs ... done</span><span leaf=""><br></span><span leaf="">## calculating arrows ... done</span><span leaf=""><br></span><span leaf="">## grid estimates ... grid.sd= 0.3741385  min.arrow.size= 0.007482771  max.grid.arrow.length= 0.1072256  done</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">箭头方向：指向细胞即将分化成的未来状态。</span></p><p data-tool="mdnice编辑器"><span leaf="">颜色：按照细胞类型分配颜色。</span></p><p data-tool="mdnice编辑器"><span leaf="">发育方向：沿箭头从起始细胞群流向目标细胞群即可判断分化路径。</span></p><h4 data-tool="mdnice编辑器"><span><span></span></span><span><span></span><span leaf="">6.2 特定基因速率可视化</span></span><span><span></span></span></h4><p data-tool="mdnice编辑器"><span leaf="">查看单个基因的表达动态，了解该基因在不同细胞状态间的表达变化趋势。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 选择要查看的基因</span></span><span leaf=""><br></span><span leaf="">gene &lt;- </span><span><span leaf="">"UBA52"</span></span><span leaf=""><br></span><span leaf="">cell.dist &lt;- as.dist(</span><span><span leaf="">1</span></span><span leaf=""> - armaCor(t(scRNA@reductions$pca@cell.embeddings)))</span><span leaf=""><br></span><span><span leaf=""># 绘制特定基因的速率图</span></span><span leaf=""><br></span><span leaf="">gene.relative.velocity.estimates(</span><span leaf=""><br></span><span leaf="">  emat,                         </span><span><span leaf=""># spliced矩阵</span></span><span leaf=""><br></span><span leaf="">  nmat,                         </span><span><span leaf=""># unspliced矩阵</span></span><span leaf=""><br></span><span leaf="">  deltaT=</span><span><span leaf="">1</span></span><span leaf="">,                     </span><span><span leaf=""># 时间步长</span></span><span leaf=""><br></span><span leaf="">  kCells = </span><span><span leaf="">20</span></span><span leaf="">,                  </span><span><span leaf=""># 最近邻细胞数</span></span><span leaf=""><br></span><span leaf="">  kGenes=</span><span><span leaf="">1</span></span><span leaf="">,                     </span><span><span leaf=""># 基因数</span></span><span leaf=""><br></span><span leaf="">  fit.quantile=</span><span><span leaf="">0.02</span></span><span leaf="">,            </span><span><span leaf=""># 拟合分位数</span></span><span leaf=""><br></span><span leaf="">  cell.emb=emb,                 </span><span><span leaf=""># 细胞嵌入坐标</span></span><span leaf=""><br></span><span leaf="">  cell.colors=cell.colors,      </span><span><span leaf=""># 细胞颜色</span></span><span leaf=""><br></span><span leaf="">  cell.dist=cell.dist,         </span><span><span leaf=""># 细胞距离</span></span><span leaf=""><br></span><span leaf="">  show.gene=gene,               </span><span><span leaf=""># 要显示的基因</span></span><span leaf=""><br></span><span leaf="">  old.fit= Tool(object = scRNA,slot = </span><span><span leaf="">"RunVelocity"</span></span><span leaf="">),              </span><span><span leaf=""># 之前的速率拟合结果</span></span><span leaf=""><br></span><span leaf="">  do.par=</span><span><span leaf="">T</span></span><span leaf="">                      </span><span><span leaf=""># 是否设置图形参数</span></span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><code><span leaf="">## calculating convolved matrices ... done</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8TVBTjeAB1D4uIlKGV70Gfs8U1bsOgiafQo92A5xc3OsAibqUV6n9141Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7138888888888889" data-type="png" data-w="1080" data-imgfileid="100013554" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHoMiaX1hDm8UXwtLny7KG5l8TVBTjeAB1D4uIlKGV70Gfs8U1bsOgiafQo92A5xc3OsAibqUV6n9141Q/640?wx_fmt=png&amp;from=appmsg"></span></p><pre data-tool="mdnice编辑器"><code><span leaf="">## [1] 1</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">图1：s（spliced）：已剪接的基因在细胞中的表达情况。颜色深浅表示表达量的高低，颜色越深，表示表达量越高。</span></p><p data-tool="mdnice编辑器"><span leaf="">图2：u（unspliced）：显示了未剪接的基因在细胞中的表达情况，颜色深浅表示表达量的高低。</span></p><p data-tool="mdnice编辑器"><span leaf="">图3：fit：已剪接和未剪接基因表达量之间的关系。颜色代表细胞类型。</span></p><p data-tool="mdnice编辑器"><span leaf="">红色的虚线代表模型拟合的最佳线性关系。</span></p><p data-tool="mdnice编辑器"><span leaf="">位于拟合线上方的点：u &gt; 模型预测的值，可能表明这些细胞中基因转录正在增加。</span></p><p data-tool="mdnice编辑器"><span leaf="">位于拟合线下方的点：u &lt; 模型预测的值，可能表明这些细胞中基因转录正在减少。</span></p><p data-tool="mdnice编辑器"><span leaf="">图4：resid：基因表达的残差，即实际观测值与模型预测值之间的差异。有助于识别细胞中基因表达的异常变化，颜色越深表示残差的绝对值越大。</span></p><p data-tool="mdnice编辑器"><span leaf="">残差为正说明u&lt;模型预测值，基因表达可能正在增加。</span></p><p data-tool="mdnice编辑器"><span leaf="">残差为负说明u&gt;模型预测值，基因表达可能正在减少。</span></p><p data-tool="mdnice编辑器"><span leaf="">如果再详细一点的话...</span></p><p><span leaf="">残差为正：这表明在模型预测的未剪接RNA量相对于实际观测到的量来说偏低。这可能是因为模型没有完全捕捉到基因表达的动态变化，或者实际上基因表达的速率确实增加了。在这种情况下，细胞可能正在增加特定基因的转录，导致更多的未剪接RNA积累，因为新的转录本正在被合成，但还没有足够的时间进行剪接。因此，正残差通常被解释为基因表达可能正在增加的信号。</span></p><p><span leaf="">残差为负：这表明在模型预测的未剪接RNA量相对于实际观测到的量来说偏高。这可能意味着基因表达的速率实际上正在减少，导致较少的未剪接RNA被合成，或者剪接过程比模型预测的要快，使得未剪接RNA迅速转化为已剪接RNA。在这种情况下，负残差通常被解释为基因表达可能正在减少的信号，或者剪接过程加速，使得未剪接RNA的量低于预期。</span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">7.遇到的报错及其解决办法</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">第一个是：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">Error in seq.default(rx[1], rx[2], length.out = grid.n) : 'from' must be a finite number</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">解决办法是修改源代码，加上NA处理机制，详见：https://www.jianshu.com/p/96a86748f593</span></p><p data-tool="mdnice编辑器"><span leaf="">修改之后的文件我也提供一份。请在"生信星球"聊天框回复velo1054，即可获得。</span></p><p data-tool="mdnice编辑器"><span leaf="">第二个：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">BLAS : Program is Terminated. Because you tried to allocate too many memory regions.</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">解决办法是开头那句代码：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">RhpcBLASctl::blas_set_num_threads(1)</span><span leaf=""><br></span></code></pre></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/_YlMzJ22Gq8pzm2rX9EpHw",target="_blank" rel="noopener noreferrer">原文链接</a>
