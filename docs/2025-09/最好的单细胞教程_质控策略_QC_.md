---
title: "最好的单细胞教程 质控策略（QC）"
date: 2025-09-15T10:46:04Z
draft: ["false"]
tags: [
  "fetched",
  "生信小博士"
]
categories: ["Acdemic"]
---
最好的单细胞教程 质控策略（QC） by 生信小博士
------
<div><section nodeleaf=""><img data-imgfileid="100006271" data-ratio="0.5911379657603223" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgR0pTczxI6mexm5dvPg9DqVibNBCXx6l8qtiazPicw2USB51dnuvNWuvC5w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="993" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgR0pTczxI6mexm5dvPg9DqVibNBCXx6l8qtiazPicw2USB51dnuvNWuvC5w/640?wx_fmt=png&amp;from=appmsg"></section><h1 data-pm-slice="0 0 []"><span leaf=""><span textstyle="">低质量细胞的过滤</span></span></h1><p data-pm-slice="0 0 []"><span leaf=""><span textstyle="">质量控制的第一步是从数据集中移除低质量细胞。当一个细胞检测到的基因数量少、计数深度低且线粒体计数占比高时，可能意味着细胞膜破损，这通常是细胞凋亡的征兆。由于这些细胞通常不是我们的主要分析目标，并且可能扭曲下游分析结果，我们会在质量控制过程中将其移除。为了识别这些细胞，我们需要定义细胞质量控制（QC）阈值。细胞QC通常基于以下</span><span textstyle="">三个QC协变量</span><span textstyle="">进行：</span></span></p><ul></ul><section><ul><li><li><li></ul><pre data-lang=""><code><span leaf="">每个barcode的计数数量（计数深度）</span></code><code><span leaf="">每个barcode的基因数量</span></code><code><span leaf="">每个barcode中线粒体基因的计数占比</span></code></pre></section><p><span leaf=""><span textstyle="">在细胞QC中，这些协变量通过阈值过滤进行处理，因为它们可能对应正在死亡的细胞。如前所述，这些指标可能反映了细胞膜破损的情况——细胞质mRNA已经泄漏，只有线粒体中的mRNA仍然存在。这类细胞通常会表现出低计数深度、少量检测到的基因以及高比例的线粒体读数。</span></span></p><p data-pm-slice="0 0 []"><span leaf="">然而，关键是要综合考虑这三个QC协变量，否则可能导致对细胞信号的误读。例如，具有相对较高线粒体计数比例的细胞可能只是参与了呼吸过程，而不应被过滤掉；而计数偏低或偏高的细胞可能对应静止期细胞群体或体积较大的细胞。因此，在对单个协变量制定阈值决策时，最好综合考虑多个协变量。一般来说，建议尽可能保守地排除细胞，采用宽松的策略，以避免过滤掉有活力的细胞群体或小的亚群。</span></p><p><span leaf="">对于少量或小型数据集的QC，通常通过手动检查不同QC协变量的分布并识别离群值来进行过滤。然而，随着数据集规模的增大，这项任务变得越来越耗时，此时考虑使用MAD（中位数绝对偏差）进行自动阈值过滤是值得的。MAD是一种鲁棒的变异统计量，通过观测值的QC指标计算得出。参考[Germain et al., 2020]的方法，我们将偏离5个MAD的细胞标记为离群值，这是一种相对宽松的过滤策略。需要强调的是，在完成细胞注释后重新评估过滤效果是合理的。</span></p><section><span data-pm-slice="0 0 []"><span leaf="">在QC过程中，第一步是计算QC协变量或指标。R语言的在seurat包中，我们参考python中的scanpy函数sc.pp.calculate_qc_metrics进行计算，该函数还可以计算特定基因群体的计数比例。因此，我们需要定义线粒体基因、核糖体基因和血红蛋白基因。需要注意的是，线粒体计数根据数据集所属物种的不同，前缀可能是"mt-"或"MT-"。此外，人类线粒体计数使用前缀"MT-"；对于小鼠数据集，前缀通常为小写"mt-"。</span></span></section><section><span data-pm-slice="0 0 []"><span leaf=""><span textstyle="">QC代码如下：</span></span></span></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span leaf=""><span># 加载必要的包</span></span></code><code><span leaf=""><span>library</span>(Seurat)</span></code><code><span leaf=""><span>library</span>(ggplot2)</span></code><code><span leaf=""><span>library</span>(patchwork)</span></code><code><span leaf=""><span>library</span>(magrittr)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 创建Seurat对象（假设已有表达矩阵）</span></span></code><code><span leaf=""><span># seurat_obj &lt;- CreateSeuratObject(counts = counts_matrix)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 定义基因类型标记 -----------------------------------------------------------</span></span></code><code><span leaf=""><span># 人类数据集使用"MT-"，小鼠使用"mt-"</span></span></code><code><span leaf="">seurat_obj[[<span>"percent.mt"</span>]] &lt;- <span>PercentageFeatureSet</span>(</span></code><code><span leaf="">  seurat_obj, </span></code><code><span leaf="">  pattern = <span>"^MT-"</span>  # 小鼠数据集改为 <span>"^mt-"</span></span></code><code><span leaf="">)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 核糖体基因（RPS/RPL前缀）</span></span></code><code><span leaf="">ribo.genes &lt;- <span>grep</span>(<span>"^RPS|^RPL"</span>, <span>rownames</span>(seurat_obj), value = <span>TRUE</span>)</span></code><code><span leaf="">seurat_obj[[<span>"percent.ribo"</span>]] &lt;- <span>PercentageFeatureSet</span>(</span></code><code><span leaf="">  seurat_obj, </span></code><code><span leaf="">  features = ribo.genes</span></code><code><span leaf="">)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 血红蛋白基因（HB开头但不含HBP）</span></span></code><code><span leaf="">hb.genes &lt;- <span>grep</span>(<span>"^HB[^(P)]"</span>, <span>rownames</span>(seurat_obj), value = <span>TRUE</span>)</span></code><code><span leaf="">seurat_obj[[<span>"percent.hb"</span>]] &lt;- <span>PercentageFeatureSet</span>(</span></code><code><span leaf="">  seurat_obj, </span></code><code><span leaf="">  features = hb.genes</span></code><code><span leaf="">)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 添加其他QC指标</span></span></code><code><span leaf="">seurat_obj[[<span>"log10_nCount_RNA"</span>]] &lt;- <span>log10</span>(seurat_obj<span>$nCount_RNA</span>)</span></code><code><span leaf="">seurat_obj[[<span>"log10_nFeature_RNA"</span>]] &lt;- <span>log10</span>(seurat_obj<span>$nFeature_RNA</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 可视化QC指标 ------------------------------------------------------------</span></span></code><code><span leaf=""><span># 总计数分布</span></span></code><code><span leaf="">p1 &lt;- <span>ggplot</span>(seurat_obj@meta.data, <span>aes</span>(nCount_RNA)) +</span></code><code><span leaf="">  <span>geom_histogram</span>(bins = <span>100</span>, fill = <span>"skyblue"</span>) +</span></code><code><span leaf="">  <span>labs</span>(title = <span>"Total Counts Distribution"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 线粒体基因百分比小提琴图</span></span></code><code><span leaf="">p2 &lt;- <span>VlnPlot</span>(seurat_obj, features = <span>"percent.mt"</span>) +</span></code><code><span leaf="">  <span>theme</span>(legend.position = <span>"none"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 相关关系散点图</span></span></code><code><span leaf="">p3 &lt;- <span>FeatureScatter</span>(seurat_obj, </span></code><code><span leaf="">                    feature1 = <span>"nCount_RNA"</span>, </span></code><code><span leaf="">                    feature2 = <span>"nFeature_RNA"</span>,</span></code><code><span leaf="">                    group.by = <span>"percent.mt"</span>) +</span></code><code><span leaf="">  <span>scale_color_viridis_c</span>(option = <span>"C"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 组合图形</span></span></code><code><span leaf="">(p1 | p2) / p3 + <span>plot_layout</span>(heights = <span>c</span>(<span>1</span>, <span>2</span>))</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># MAD离群值检测函数 --------------------------------------------------------</span></span></code><code><span leaf="">is_outlier &lt;- <span><span>function</span></span><span>(</span><span><span>metric, nmads = </span></span><span><span><span>5</span></span></span><span>) </span>{</span></code><code><span leaf="">  med &lt;- <span>median</span>(metric, na.rm = <span>TRUE</span>)</span></code><code><span leaf="">  mad_val &lt;- <span>mad</span>(metric, constant = <span>1</span>, na.rm = <span>TRUE</span>)</span></code><code><span leaf="">  lower_bound &lt;- med - nmads * mad_val</span></code><code><span leaf="">  upper_bound &lt;- med + nmads * mad_val</span></code><code><span leaf="">  <span>return</span>(metric &lt; lower_bound | metric &gt; upper_bound)</span></code><code><span leaf="">}</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 应用MAD过滤 -------------------------------------------------------------</span></span></code><code><span leaf=""><span># 使用log转换后的指标进行过滤</span></span></code><code><span leaf="">seurat_obj<span>$outlier </span>&lt;- <span>with</span>(seurat_obj@meta.data,</span></code><code><span leaf="">  <span>is_outlier</span>(log10_nCount_RNA, <span>5</span>) |</span></code><code><span leaf="">  <span>is_outlier</span>(log10_nFeature_RNA, <span>5</span>) |</span></code><code><span leaf="">  <span>is_outlier</span>(percent.mt, <span>3</span>)  # 线粒体使用更严格的<span>3</span>个MAD</span></code><code><span leaf="">)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 额外添加线粒体百分比绝对阈值（&gt;8%）</span></span></code><code><span leaf="">seurat_obj<span>$mt_outlier </span>&lt;- seurat_obj<span>$percent</span>.mt &gt; <span>8</span></span></code><code><span leaf=""><br></span></code></pre></section><section nodeleaf=""><img data-imgfileid="100006274" data-ratio="1.055350553505535" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRnibJ1fKLU4BBs0vDMbL9Y4pM7EXPE3M2ZNvz9nCmRhicCdgyQrmuZlaA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="542" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRnibJ1fKLU4BBs0vDMbL9Y4pM7EXPE3M2ZNvz9nCmRhicCdgyQrmuZlaA/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf=""><br></span></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># 查看离群细胞统计</span></span></code><code><span leaf="">table(seurat_obj<span>$outlier</span>)</span></code><code><span leaf="">table(seurat_obj<span>$mt_outlier</span>)</span></code><code><span leaf=""><span># 执行细胞过滤 ------------------------------------------------------------</span></span></code><code><span leaf=""><span>cat</span>(<span>"过滤前细胞数:"</span>, ncol(seurat_obj), <span>"\n"</span>)</span></code><code><span leaf="">seurat_obj &lt;- subset(seurat_obj, </span></code><code><span leaf="">                    subset = !outlier &amp; !mt_outlier)</span></code><code><span leaf=""><span>cat</span>(<span>"过滤后细胞数:"</span>, ncol(seurat_obj), <span>"\n"</span>)</span></code><code><span leaf=""><span># 过滤后可视化验证</span></span></code><code><span leaf="">FeatureScatter(seurat_obj, </span></code><code><span leaf="">              feature1 = <span>"nCount_RNA"</span>, </span></code><code><span leaf="">              feature2 = <span>"nFeature_RNA"</span>,</span></code><code><span leaf="">              group.by = <span>"percent.mt"</span>)</span></code></pre></section><section><span leaf="">过滤完低质量数据之后</span><span leaf=""><span textstyle="">：</span></span></section><section nodeleaf=""><img data-imgfileid="100006273" data-ratio="0.7814070351758794" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRoKNHzgYz37m2FHKFM6uSIu7iav8nOAW9sd9tA9zIFsYD6GqAQYXxG1Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="796" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRoKNHzgYz37m2FHKFM6uSIu7iav8nOAW9sd9tA9zIFsYD6GqAQYXxG1Q/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-imgfileid="100006275" data-ratio="0.49070631970260226" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRpp5Ucz6UKk1ibvLEKib6DDOcbpOicoF2AesUfwayw1IRzicRacvh6bSLhA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="538" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRpp5Ucz6UKk1ibvLEKib6DDOcbpOicoF2AesUfwayw1IRzicRacvh6bSLhA/640?wx_fmt=png&amp;from=appmsg"></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span leaf=""><br></span></code><code><span leaf="">head(scobj)</span></code><code><span leaf=""><span># 添加其他QC指标</span></span></code><code><span leaf="">scobj[[<span>"log10_nCount_RNA"</span>]] &lt;- log10(scobj<span>$nCount_RNA</span>)</span></code><code><span leaf="">scobj[[<span>"log10_nFeature_RNA"</span>]] &lt;- log10(scobj<span>$nFeature_RNA</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 假设要突出显示的barcodes向量</span></span></code><code><span leaf="">highlight_barcodes &lt;-  colnames(scobj)[!(colnames(scobj) %<span>in</span>% colnames(seurat_obj))]</span></code><code><span leaf=""><br></span></code><code><span leaf="">ggplot(scobj<span>@meta</span>.data, aes(x = new.celltype, y =log10_nCount_RNA)) +</span></code><code><span leaf="">  geom_boxplot() +  <span># 或 geom_violin()</span></span></code><code><span leaf="">  <span># 添加红色点标记特定barcodes</span></span></code><code><span leaf="">  geom_point(</span></code><code><span leaf="">    data = subset(scobj<span>@meta</span>.data, rownames(scobj<span>@meta</span>.data) %<span>in</span>% highlight_barcodes),</span></code><code><span leaf="">    color = <span>"red"</span>,</span></code><code><span leaf="">    size = <span>1.3</span>,</span></code><code><span leaf="">    position = position_jitter(width = <span>0.2</span>, height = <span>0</span>)</span></code><code><span leaf="">  ) +</span></code><code><span leaf="">  <span>Seurat</span><span>::RotatedAxis</span>() +</span></code><code><span leaf="">  labs(title = <span>"被质控掉的细胞"</span>)</span></code><code><span leaf=""><br></span></code><code><span leaf=""> </span></code><code><span leaf=""><br></span></code></pre></section><section><span leaf=""><br></span></section><section nodeleaf=""><img data-imgfileid="100006284" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRmtRandbhEXFqRTDO5SicU0IqzpttnswSK73ibL9JPTRJCVyMIumBbTQg/640?wx_fmt=png&amp;from=appmsg" data-type="png" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRmtRandbhEXFqRTDO5SicU0IqzpttnswSK73ibL9JPTRJCVyMIumBbTQg/640?wx_fmt=png&amp;from=appmsg"></section><section><ul><li><li><li><li></ul><pre data-lang=""><code><span leaf=""><br></span></code><code><span leaf="">    DimPlot(scobj,</span></code><code><span leaf="">        cells.highlight =colnames(scobj)[!(   colnames(scobj) %in% colnames(seurat_obj)  )] </span></code><code><span leaf="">        )</span></code></pre></section><section nodeleaf=""><img data-imgfileid="100006285" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRdNngFlqrvZJHuRUkNFlMbZiajUoibytgSUrib3qia1T121Xa4pCE5sWugA/640?wx_fmt=png&amp;from=appmsg" data-type="png" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/xVhD7345SkuvhvWiatVq5DcESyX0FvvgRdNngFlqrvZJHuRUkNFlMbZiajUoibytgSUrib3qia1T121Xa4pCE5sWugA/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf=""><br></span></section><h3 data-pm-slice="0 0 []"><span leaf=""><span textstyle="">为什么使用MAD进行QC？</span></span></h3><ol><li><span><p><strong><span leaf=""><span textstyle="">稳健性（Robustness）</span></span></strong><span leaf=""><span textstyle="">：MAD基于中位数计算，而中位数对异常值不敏感。因此，MAD本身对异常值也具有很强的抵抗力。相比之下，标准差受异常值影响较大。</span></span></p></span></li><li><span><p><strong><span leaf=""><span textstyle="">适用性</span></span></strong><span leaf=""><span textstyle="">：在单细胞数据分析中，QC指标（如线粒体基因百分比）的分布往往不是正态分布，可能包含极端值（如死细胞或破损细胞）。使用基于MAD的阈值可以更准确地识别这些异常值。</span></span></p></span></li><li><span><p><strong><span leaf=""><span textstyle="">与正态分布的联系</span></span></strong><span leaf=""><span textstyle="">：对于正态分布数据，MAD与标准差之间存在一个转换因子（约1.4826）。即，标准差 ≈ 1.4826 * MAD。因此，在正态分布假设下，使用MAD乘以一个因子（如1.4826）可以得到与标准差类似的估计。但即使数据不是正态分布，MAD仍然是一个有效的离散度度量。</span></span></p></span></li></ol><section><span leaf=""><br></span></section><section><ul><li></ul><pre data-lang="javascript"><code><span leaf=""><span>https</span>:<span>//www.sc-best-practices.org/preprocessing_visualization/quality_control.html</span></span></code></pre></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/9aNz7YUMhLNmyXdh5j2PGA",target="_blank" rel="noopener noreferrer">原文链接</a>
