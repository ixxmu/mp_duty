---
title: "免疫细胞之间相关性的网络图｜igraph｜FigureYa81immune_network"
date: 2025-10-14T12:28:57Z
draft: ["false"]
tags: [
  "fetched",
  "小丫画图"
]
categories: ["Acdemic"]
---
免疫细胞之间相关性的网络图｜igraph｜FigureYa81immune_network by 小丫画图
------
<div><section><section powered-by="xiumi.us"><section><section><section><section><section><p><span><span leaf="">小丫碎碎念：</span></span></p><p><span><span leaf="">当初群里小伙伴最幸福的时刻就是，想要画某个图，把原文pdf文件往群里一扔，就能炸出文章作者来～～～</span></span></p><p><span><span leaf=""><br></span></span></p><p><span leaf="">这篇文章作者很早就<span textstyle="">贡献</span><span textstyle="">了很多</span><span textstyle="">临床数据可视化</span>FigureYa，相继成为经典，路越走越宽。<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzUyODk4MTIyNA==&amp;mid=2247483818&amp;idx=1&amp;sn=f163b3d5a5e06b96dbd5b52ac40ed8d4&amp;scene=21#wechat_redirect" textvalue="【BR】肿瘤微环境大数据研究解读：TMEscore" data-itemshowtype="0" linktype="text" data-linktype="2">【BR】肿瘤微环境大数据研究解读：TMEscore</a></span></p><p><span leaf=""><br></span></p><p><span leaf="">如果没有对比，小伙伴可能不容易理解为什么用</span><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"style":"margin-bottom: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"powered-by":"xiumi.us"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'>“贡献”二字。当你想开启某一小领域，遍寻教程无门。联系某篇文章作者，无论怎样人家也不分享，个中滋味自行体会。</span></p><p><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"style":"margin-bottom: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"powered-by":"xiumi.us"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><br></span></p><p><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"style":"margin-bottom: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"powered-by":"xiumi.us"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><span textstyle="">第一期——</span><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=Mzg3NTA1MTM0NQ==&amp;mid=2247486685&amp;idx=1&amp;sn=b3ef52d73ace7c98b2e4c931ad8845fb&amp;scene=21#wechat_redirect" textvalue="圆圈图小结｜美图如云，理性选择" data-itemshowtype="0" linktype="text" data-linktype="2"><span textstyle="">圆圈图小结｜美图如云，理性选择</span></a></span></p><p><span leaf=""><span textstyle="">第二期——连线图</span><span textstyle="">。从igragh开始，语法跟R的base画图系统很像。</span></span></p><p><span><span leaf=""><br></span></span></p></section></section></section></section></section></section></section><hr><section><section powered-by="xiumi.us"><section><section><section><section><section><p><span><span leaf=""><br></span></span></p></section></section></section><p><strong><span><span leaf="">需求描述</span></span></strong></p><p data-pm-slice="0 0 []"><span leaf="">复现原文免疫细胞之间相关性的网络图</span></p><p><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7BwuzfKa0GJP4ibSfibtnD5vTSORuxW6blOoL4nwE8jFA6mTxIGkjZhr9ic6Lv6m0TBPdmicYuC2dWbyibfo9Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5197080291970803" data-type="png" data-w="685" data-imgfileid="100003107" src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7BwuzfKa0GJP4ibSfibtnD5vTSORuxW6blOoL4nwE8jFA6mTxIGkjZhr9ic6Lv6m0TBPdmicYuC2dWbyibfo9Q/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-pm-slice="0 0 []"><span leaf="">出自http://cancerimmunolres.aacrjournals.org/content/early/2019/03/06/2326-6066.CIR-18-0436</span></p><p data-pm-slice="0 0 []"><span leaf="">节点的颜色代表细胞所属的cluster，节点的大小代表生存分析的log_rank_p，用圆心点的颜色展示HR，连线颜色代表正/负相关，连线的粗细代表相关性Pvalue。</span></p><p><span leaf=""><br></span></p><h2><strong><span><span leaf="">应用场景</span></span></strong></h2><p data-pm-slice="0 0 []"><span><span leaf="">用网络图同时展示相关关系、pvalue、聚类/分类结果、跟预后的关系。</span></span></p><ul><li><p><span><span leaf="">例如例文中各细胞之间的相关关系、跟预后的关系</span></span></p></li><li><p><span><span leaf="">或表达谱数据中多个基因的相关性、聚类结果、pvalue、跟预后的关系，比<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=Mzg3NTA1MTM0NQ==&amp;mid=2247486455&amp;idx=2&amp;sn=d057f0e8496724466bbb1c176388d3c6&amp;scene=21#wechat_redirect" textvalue="FigureYa37correlation" data-itemshowtype="0" linktype="text" data-linktype="2">FigureYa37correlation</a>更丰富。</span></span></p></li></ul><p><span leaf=""><br></span></p></section></section></section></section><h2><strong><span><span leaf="">环境设置</span></span></strong></h2><section><ul><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span>source</span>(<span>"install_dependencies.R"</span>) <span>#自动识别缺哪些R包，自动安装</span></span></code><code><span leaf="">library(reshape2)     <span># 用于数据重塑 | For data reshaping</span></span></code><code><span leaf="">library(corrplot)     <span># 用于绘制相关性热图 | For correlation matrix visualization</span></span></code><code><span leaf="">library(plyr)         <span># 用于数据操作和聚合 | For data manipulation and aggregation</span></span></code><code><span leaf="">library(igraph)       <span># 用于绘制网络图 | For network graph visualization</span></span></code></pre></section><section><span leaf="">参数设置</span></section><section><ul><li><li><li><li><li><li></ul><pre data-lang="nginx"><code><span leaf=""><span># 定义网络图中连线的颜色 | Define colors for edges in network graph</span></span></code><code><span leaf=""><span>poscol</span> &lt;- <span>"#FB9A99"</span>  <span># 正相关用红色连线 | Red color for positive correlations</span></span></code><code><span leaf="">negcol &lt;- <span>"#C6DBEF"</span>  <span># 负相关用蓝色连线 | Blue color for negative correlations</span></span></code><code><span leaf=""><span># 定义聚类的颜色方案 | Define color palette for clusters</span></span></code><code><span leaf="">mycol &lt;- c(<span>"#FDBF6F"</span>, <span>"#1F78B4"</span>, <span>"#E31A1C"</span>, <span>"#8C510A"</span>)  </span></code><code><span leaf=""><span># 用于不同聚类的颜色，如果有更多类，需要添加更多颜色 | Colors for different clusters, add more if needed</span></span></code></pre></section><h2 data-heading="true"><strong><span><span leaf="">输入文件</span></span></strong></h2><p data-pm-slice="0 0 []"><span><span leaf="">至少要提供easy_input_immune.csv文件，例如免疫细胞矩阵，或基因表达矩阵（把这里的免疫细胞替换成基因即可）。如果没有生存分析结果，可以用其他pvalue代替。</span></span></p><p><span><span leaf="">easy_input_immune.csv，<span textstyle="">免疫细胞矩阵</span>文件，用于计算相关系数和P值、把细胞分成4个cluster、通过卡相关性的P值来建立细胞间的连接关系。每行一个sample，每列一种细胞。最后一列fibioblast用mcpcounter获得，可参考FigureYa56immune_inflitration；文中其他22种免疫细胞用CIBERSORT计算获得，还可以用FigureYa56immune_inflitration或FigureYa71ssGSEA来量化免疫细胞。</span></span></p><p><span leaf="">easy_input_HR.csv，<span textstyle="">生存分析结果</span>，需要HR（节点圆心点的颜色，后期添加）和p value（节点圆的大小）列。可通过FigureYa47HR2table计算获得。</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># 读取免疫细胞表达矩阵数据 | Read immune cell expression matrix data</span></span></code><code><span leaf="">input_data &lt;- read.csv(<span>"easy_input_immune.csv"</span>, row.names = 1, check.names = F)</span></code><code><span leaf="">dim(input_data)                  <span># 查看数据维度 | Check data dimensions</span></span></code><code><span leaf="">input_data[1:3,1:3]              <span># 显示数据前几行几列 | Preview data structure</span></span></code><code><span leaf=""><span># 读取生存分析结果数据 | Read survival analysis results</span></span></code><code><span leaf="">bb &lt;- read.csv(<span>"easy_input_HR.csv"</span>, header = T)</span></code><code><span leaf=""><span>head</span>(bb)                         <span># 查看数据前几行 | Preview data</span></span></code><code><span leaf="">bb<span>$Cell</span>.types &lt;- as.character(bb<span>$Cell</span>.types)  <span># 将细胞类型转为字符型 | Convert cell types to character</span></span></code><code><span leaf="">colnames(bb)[1] &lt;- c(<span>"ID"</span>)       <span># 重命名第一列为ID | Rename first column to "ID"</span></span></code><code><span leaf=""><span># 数据预处理：计算节点属性 | Data preprocessing: Calculate node attributes</span></span></code><code><span leaf="">bb<span>$weight</span> &lt;- abs(log10(bb<span>$log_rank_p</span>))        <span># 用log-rank p值的对数绝对值表示节点大小 | Node size by -log10(p-value)</span></span></code><code><span leaf="">bb<span>$weight_HR</span> &lt;- (as.numeric(bb<span>$HR</span>)-1)*100     <span># 将HR值转换为可用于着色的值 | Transform HR for coloring</span></span></code><code><span leaf="">bb<span>$colr</span> &lt;- ifelse(bb<span>$weight_HR</span>&lt;0, <span>"green"</span>, <span>"black"</span>)  <span># 根据HR值设置节点颜色：HR&lt;1为绿色，否则为黑色 | Set node color by HR</span></span></code><code><span leaf=""><span>head</span>(bb)                         <span># 查看处理后的数据集 | Preview processed data</span></span></code><code><span leaf=""><span># 保存处理后的生存分析结果到CSV文件 | Save processed survival analysis results to CSV</span></span></code><code><span leaf="">write.csv(bb, <span>"output_HR_corlor.csv"</span>, quote = F)  <span># 输出用于后续绘图的带颜色信息的文件 | Output file with color info for plotting</span></span></code></pre></section><p data-pm-slice="0 0 []"><span leaf="">相关性的计算</span></p><p data-pm-slice="0 0 []"><span><span leaf="">计算每两种细胞间的相关性</span></span></p><p data-pm-slice="0 0 []"><span><span leaf="">计算每两种细胞间的相关性corr，用corrplot可视化，看看聚成几类比较好。</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="nginx"><code><span leaf=""><span># options(scipen = 100,digits = 4)  # 取消科学计数法显示，保留4位小数 | Disable scientific notation, show 4 decimal places</span></span></code><code><span leaf=""><span># 计算免疫细胞表达量之间的Spearman相关性矩阵 | Calculate Spearman correlation matrix between immune cell expressions</span></span></code><code><span leaf=""><span>corr</span> &lt;- cor(input_data, method = <span>"spearman"</span>)</span></code><code><span leaf=""><span># 绘制相关性热图 | Plot correlation heatmap</span></span></code><code><span leaf="">corrplot(corr, title = <span>""</span>, </span></code><code><span leaf="">         method = <span>"pie"</span>,           <span># 可视化方法：饼图 (也可用"circle", "square"等) | Visualization method: pie chart</span></span></code><code><span leaf="">         outline = T,              <span># 显示单元格边框 | Show cell borders</span></span></code><code><span leaf="">         addgrid.col = <span>"darkgray"</span>, <span># 添加网格线颜色 | Add grid line color</span></span></code><code><span leaf="">         order = <span>"hclust"</span>,         <span># 按层次聚类排序 | Order by hierarchical clustering</span></span></code><code><span leaf="">         addrect = <span>4</span>,              <span># 添加4个聚类矩形框 | Add 4 clustering rectangles</span></span></code><code><span leaf="">         mar = c(<span>4</span>,<span>0</span>,<span>4</span>,<span>0</span>),         <span># 调整边距使标签完整显示 | Adjust margins for label visibility</span></span></code><code><span leaf="">         rect.col = <span>"black"</span>,       <span># 矩形框颜色 | Rectangle color</span></span></code><code><span leaf="">         rect.lwd = <span>5</span>,             <span># 矩形框线宽 | Rectangle line width</span></span></code><code><span leaf="">         cl.pos = <span>"b"</span>,             <span># 颜色图例位置：底部 | Color legend position: bottom</span></span></code><code><span leaf="">         tl.col = <span>"black"</span>,         <span># 文本标签颜色 | Text label color</span></span></code><code><span leaf="">         tl.cex = <span>1</span>.<span>08</span>,            <span># 文本标签大小 | Text label size</span></span></code><code><span leaf="">         cl.cex = <span>1</span>.<span>5</span>,             <span># 颜色图例大小 | Color legend size</span></span></code><code><span leaf="">         tl.srt = <span>60</span>)              <span># 文本标签旋转角度 | Text label rotation angle</span></span></code></pre></section><p data-pm-slice="0 0 []"><span><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7BwuzfKa0GJP4ibSfibtnD5vTSORuicFMnRov3MoBM8FsjzvOoqwv3S20DN77ojPLyVkerhQ3utfzHFaZovg/640?wx_fmt=png&amp;from=appmsg" data-ratio="1" data-type="png" data-w="1080" data-imgfileid="100003111" src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7BwuzfKa0GJP4ibSfibtnD5vTSORuicFMnRov3MoBM8FsjzvOoqwv3S20DN77ojPLyVkerhQ3utfzHFaZovg/640?wx_fmt=png&amp;from=appmsg"></span></span></p><p data-pm-slice="0 0 []"><span><span leaf="">计算相关性分析的P值</span></span></p><p data-pm-slice="0 0 []"><span><span leaf="">也可以用Hmsic包来求，但是发现它输出的P值有限制。</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># 自定义函数：计算相关系数的p值矩阵 | Custom function: Calculate p-value matrix for correlation coefficients</span></span></code><code><span leaf="">cor.mtest &lt;- <span>function</span>(corr, ...) {</span></code><code><span leaf="">  corr &lt;- as.matrix(corr)          <span># 将输入转换为矩阵格式 | Convert input to matrix format</span></span></code><code><span leaf="">  n &lt;- ncol(corr)                  <span># 获取矩阵列数（变量数量）| Get number of columns (variables)</span></span></code><code><span leaf="">  p.corr &lt;- matrix(NA, n, n)       <span># 初始化p值矩阵 | Initialize p-value matrix</span></span></code><code><span leaf="">  diag(p.corr) &lt;- 0                <span># 对角线元素（自身相关）p值设为0 | Set diagonal p-values to 0</span></span></code><code><span leaf=""><br></span></code><code><span leaf="">  <span># 计算所有变量对之间的相关系数p值 | Calculate p-values for all variable pairs</span></span></code><code><span leaf="">  <span>for</span> (i <span>in</span> 1:(n - 1)) {</span></code><code><span leaf="">    <span>for</span> (j <span>in</span> (i + 1):n) {</span></code><code><span leaf="">      tmp &lt;- cor.test(corr[, i],   <span># 执行Spearman相关性检验 | Perform Spearman correlation test</span></span></code><code><span leaf="">                      corr[, j], </span></code><code><span leaf="">                      method = <span>"spearman"</span>, ...)</span></code><code><span leaf="">      p.corr[i, j] &lt;- p.corr[j, i] &lt;- tmp<span>$p</span>.value  <span># 对称填充p值矩阵 | Fill p-value matrix symmetrically</span></span></code><code><span leaf="">    }</span></code><code><span leaf="">  }</span></code><code><span leaf=""><br></span></code><code><span leaf="">  colnames(p.corr) &lt;- rownames(p.corr) &lt;- colnames(corr)  <span># 设置矩阵行列名 | Set matrix row/column names</span></span></code><code><span leaf="">  p.corr  <span># 返回p值矩阵 | Return p-value matrix</span></span></code><code><span leaf="">}</span></code><code><span leaf=""><span># 计算免疫细胞表达量相关性的p值矩阵 | Calculate p-value matrix for immune cell correlations</span></span></code><code><span leaf="">p.corr &lt;- cor.mtest(input_data) </span></code><code><span leaf=""><span>head</span>(p.corr[, 1:5])  <span># 显示p值矩阵的前几行和前5列 | Show first few rows and 5 columns of p-value matrix</span></span></code></pre></section><p data-pm-slice="0 0 []"><span><span leaf="">计算节点间的连接关系</span></span></p><p data-pm-slice="0 0 []"><span><span leaf="">只保留那些相关性较强的连接</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># 合并相关系数矩阵和P值矩阵 | Merge correlation coefficients and p-values</span></span></code><code><span leaf="">rr &lt;- as.data.frame(corr)         <span># 将相关系数矩阵转换为数据框 | Convert correlation matrix to dataframe</span></span></code><code><span leaf="">rr<span>$ID</span> &lt;- rownames(rr)             <span># 添加行名作为ID列 | Add row names as ID column</span></span></code><code><span leaf="">cor &lt;- melt(rr, <span>"ID"</span>, value.name = <span>"cor"</span>)  <span># 重塑数据为长格式 | Reshape data to long format</span></span></code><code><span leaf="">pp &lt;- as.data.frame(p.corr)        <span># 将P值矩阵转换为数据框 | Convert p-value matrix to dataframe</span></span></code><code><span leaf="">pp<span>$ID</span> &lt;- rownames(pp)             <span># 添加行名作为ID列 | Add row names as ID column</span></span></code><code><span leaf="">pvalue &lt;- melt(pp, <span>"ID"</span>, value.name = <span>"pvalue"</span>)  <span># 重塑数据为长格式 | Reshape data to long format</span></span></code><code><span leaf="">colnames(pvalue) &lt;- c(<span>"from"</span>, <span>"to"</span>, <span>"pvalue"</span>)  <span># 重命名列 | Rename columns</span></span></code><code><span leaf="">corpvlue &lt;- cbind(pvalue, cor)    <span># 合并相关性和P值数据 | Combine correlation and p-value data</span></span></code><code><span leaf=""><span>head</span>(corpvlue)</span></code><code><span leaf="">corpvlue &lt;- corpvlue[, -c(4:5)]   <span># 删除重复的ID列 | Remove redundant ID columns</span></span></code><code><span leaf=""><span>head</span>(corpvlue)</span></code><code><span leaf="">dim(corpvlue)                     <span># 查看数据维度 | Check data dimensions</span></span></code><code><span leaf=""><span># 筛选显著相关的连接 | Filter significant correlations</span></span></code><code><span leaf="">corpvlue &lt;- corpvlue[corpvlue<span>$pvalue</span> &lt; 0.0001, ]  <span># 保留p值小于0.0001的连接 | Keep only highly significant connections</span></span></code><code><span leaf="">dim(corpvlue)</span></code><code><span leaf=""><span># 计算连接权重（基于P值） | Calculate edge weights (based on p-values)</span></span></code><code><span leaf="">corpvlue<span>$weight</span> &lt;- corpvlue<span>$pvalue</span></span></code><code><span leaf="">corpvlue<span>$weight</span> &lt;- -log10(corpvlue<span>$weight</span>)  <span># 转换为-log10(p)以增强显著性差异 | Transform to -log10(p) for better visualization</span></span></code><code><span leaf=""><span>head</span>(corpvlue)</span></code><code><span leaf=""><span># 数据清洗：移除自相关和重复连接 | Data cleaning: Remove self-correlations and duplicate edges</span></span></code><code><span leaf="">corpvlue &lt;- corpvlue[!corpvlue<span>$cor</span> == 1, ]  <span># 移除完全相关（自身）的连接 | Remove self-correlations (cor=1)</span></span></code><code><span leaf="">dim(corpvlue)</span></code><code><span leaf=""><span># 移除重复连接 | Remove duplicate edges</span></span></code><code><span leaf="">summary(duplicated(corpvlue<span>$weight</span>))</span></code><code><span leaf="">corpvlue &lt;- corpvlue[!duplicated(corpvlue<span>$weight</span>), ]  <span># 保留唯一连接 | Keep unique edges only</span></span></code><code><span leaf="">dim(corpvlue)</span></code><code><span leaf=""><span># 根据相关系数方向设置连接颜色 | Set edge colors based on correlation direction</span></span></code><code><span leaf="">corpvlue<span>$color</span> &lt;- ifelse(corpvlue<span>$cor</span> &lt; 0, negcol, poscol)  <span># 负相关为蓝色，正相关为红色 | Negative: blue, Positive: red</span></span></code><code><span leaf=""><span># 保存处理后的连接数据到CSV文件 | Save processed edge data to CSV</span></span></code><code><span leaf="">write.csv(corpvlue, <span>"output_links.csv"</span>)  <span># 输出用于网络图的连接数据 | Output edge data for network visualization</span></span></code></pre></section><p data-pm-slice="0 0 []"><span><span leaf="">利用矩阵文件进行细胞的聚类</span></span></p><p data-pm-slice="0 0 []"><span><span leaf="">细胞聚类的结果综合考虑了"hclust"的结果、"kmeans"聚类的结果、以及目前的研究现状。</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span leaf=""><span># 转置数据用于聚类分析 | Transpose data for clustering analysis</span></span></code><code><span leaf="">cellcluster &lt;- <span>as</span>.data.<span>frame</span>(<span>t</span>(input_data))  <span># 转置免疫细胞表达矩阵 | Transpose immune cell expression matrix</span></span></code><code><span leaf=""><span># cellcluster[1:5,1:5]  # 查看数据前几行几列 | Preview data structure</span></span></code><code><span leaf=""><span># 执行层次聚类分析 | Perform hierarchical clustering</span></span></code><code><span leaf="">hc &lt;- <span>hclust</span>(<span>dist</span>(cellcluster))  <span># 计算距离矩阵并进行层次聚类 | Calculate distance matrix and perform hierarchical clustering</span></span></code><code><span leaf="">hcd &lt;- <span>as</span>.<span>dendrogram</span>(hc)  <span># 将聚类结果转换为树状图对象 | Convert clustering result to dendrogram</span></span></code><code><span leaf="">(clus4 &lt;- <span>cutree</span>(hc, <span>4</span>))  <span># 将树状图切割为4个聚类 | Cut dendrogram into 4 clusters</span></span></code><code><span leaf=""><span># 获取每个聚类中的细胞名称 | Extract cell names in each cluster</span></span></code><code><span leaf="">A &lt;- <span>as</span>.<span>character</span>(<span>rownames</span>(<span>as</span>.data.<span>frame</span>(<span>subset</span>(clus4, clus4==<span>1</span>))))  <span># 聚类1的细胞 | Cells in cluster 1</span></span></code><code><span leaf="">B &lt;- <span>as</span>.<span>character</span>(<span>rownames</span>(<span>as</span>.data.<span>frame</span>(<span>subset</span>(clus4, clus4==<span>2</span>))))  <span># 聚类2的细胞 | Cells in cluster 2</span></span></code><code><span leaf="">C &lt;- <span>as</span>.<span>character</span>(<span>rownames</span>(<span>as</span>.data.<span>frame</span>(<span>subset</span>(clus4, clus4==<span>3</span>))))  <span># 聚类3的细胞 | Cells in cluster 3</span></span></code><code><span leaf="">D &lt;- <span>as</span>.<span>character</span>(<span>rownames</span>(<span>as</span>.data.<span>frame</span>(<span>subset</span>(clus4, clus4==<span>4</span>))))  <span># 聚类4的细胞 | Cells in cluster 4</span></span></code><code><span leaf="">cls &lt;- <span>list</span>(A, B, C, D)  <span># 将所有聚类结果存入列表 | Store all clusters in a list</span></span></code><code><span leaf=""><span># 创建节点数据框并指定聚类标签 | Create node dataframe and assign cluster labels</span></span></code><code><span leaf="">nodes &lt;- <span>as</span>.data.<span>frame</span>(<span>unlist</span>(cls))  <span># 将聚类结果展平为数据框 | Flatten cluster list into dataframe</span></span></code><code><span leaf="">nodes<span>$type </span>&lt;- <span>c</span>(<span>rep</span>(<span>"B"</span>, <span>9</span>), <span>rep</span>(<span>"A"</span>, <span>4</span>), <span>rep</span>(<span>"C"</span>, <span>5</span>), <span>rep</span>(<span>"D"</span>, <span>5</span>))  <span># 为每个细胞分配聚类类型 | Assign cluster types to cells</span></span></code><code><span leaf=""><span>names</span>(nodes) &lt;- <span>c</span>(<span>"media"</span>, <span>"type.label"</span>)  <span># 重命名列名 | Rename columns</span></span></code><code><span leaf=""><span># 基于领域知识手动调整部分细胞的聚类归属 | Manually adjust cluster assignments based on domain knowledge</span></span></code><code><span leaf="">nodes<span>$type</span>.label[nodes<span>$media </span>== <span>"T cells follicular helper"</span>] &lt;- <span>"B"</span>  <span># 调整T细胞滤泡辅助细胞的聚类 | Adjust T follicular helper cells</span></span></code><code><span leaf="">nodes<span>$type</span>.label[nodes<span>$media </span>== <span>"B cells naive"</span>] &lt;- <span>"A"</span>  <span># 调整幼稚B细胞的聚类 | Adjust naive B cells</span></span></code><code><span leaf="">nodes<span>$type</span>.label[nodes<span>$media </span>== <span>"T cells CD4 naive"</span>] &lt;- <span>"A"</span>  <span># 调整幼稚CD4+T细胞的聚类 | Adjust naive CD4+ T cells</span></span></code><code><span leaf="">nodes<span>$type</span>.label[nodes<span>$media </span>== <span>"Plasma cells"</span>] &lt;- <span>"A"</span>  <span># 调整浆细胞的聚类 | Adjust plasma cells</span></span></code><code><span leaf="">nodes<span>$type</span>.label[nodes<span>$media </span>== <span>"Dendritic cells resting"</span>] &lt;- <span>"C"</span>  <span># 调整静息树突状细胞的聚类 | Adjust resting dendritic cells</span></span></code><code><span leaf="">nodes<span>$type</span>.label[nodes<span>$media </span>== <span>"Eosinophils"</span>] &lt;- <span>"C"</span>  <span># 调整嗜酸性粒细胞的聚类 | Adjust eosinophils</span></span></code><code><span leaf="">nodes<span>$type</span>.label[nodes<span>$media </span>== <span>"Mast cells resting"</span>] &lt;- <span>"A"</span>  <span># 调整静息肥大细胞的聚类 | Adjust resting mast cells</span></span></code><code><span leaf=""><span># 数据类型转换和检查 | Data type conversion and validation</span></span></code><code><span leaf="">nodes &lt;- <span>as</span>.data.<span>frame</span>(nodes)  <span># 确保数据为数据框格式 | Ensure data is in dataframe format</span></span></code><code><span leaf="">nodes<span>$media </span>&lt;- <span>as</span>.<span>character</span>(nodes<span>$media</span>)  <span># 将细胞名称转换为字符型 | Convert cell names to character type</span></span></code><code><span leaf="">nodes  <span># 显示最终节点数据 | Display final node data</span></span></code></pre></section><p data-pm-slice="0 0 []"><span><span leaf="">构建网络的input文件</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># 合并生存分析数据和细胞分类数据 | Merge survival analysis data and cell classification data</span></span></code><code><span leaf="">summary(nodes<span>$media</span> %<span>in</span>% bb<span>$ID</span>)  <span># 检查细胞名称是否一致 | Check if cell names match between datasets</span></span></code><code><span leaf="">nodes &lt;- merge(nodes, bb, by.x = <span>"media"</span>, <span>"ID"</span>, all.x = T, all.y = T)  <span># 按细胞名合并数据 | Merge datasets by cell name</span></span></code><code><span leaf=""><span># 准备节点属性 | Prepare node attributes</span></span></code><code><span leaf="">nodes<span>$Fraction</span> &lt;- abs(nodes<span>$weight_HR</span>)  <span># 计算节点大小属性（HR值的绝对值）| Node size based on absolute HR value</span></span></code><code><span leaf="">nodes<span>$id</span> &lt;- <span>paste</span>(<span>"S"</span>, 01:23, sep = <span>""</span>)  <span># 为每个细胞分配唯一ID | Assign unique IDs to cells</span></span></code><code><span leaf="">nodes &lt;- nodes[order(nodes<span>$type</span>.label),]  <span># 按细胞类型排序 | Sort by cell type</span></span></code><code><span leaf="">nodes &lt;- nodes[,c(ncol(nodes),1:ncol(nodes)-1)]  <span># 调整列顺序，ID列为第一列 | Reorder columns, ID first</span></span></code><code><span leaf="">nodes &lt;- nodes[order(nodes<span>$type</span>.label),]  <span># 再次按细胞类型排序 | Sort again by cell type</span></span></code><code><span leaf="">nodes  <span># 显示节点数据 | Display node data</span></span></code><code><span leaf=""><span># 建立细胞名与ID的映射关系 | Create mapping between cell names and IDs</span></span></code><code><span leaf="">paste0(<span>"'"</span>,nodes<span>$media</span>,<span>"'"</span>,<span>"="</span>,<span>"'"</span>,nodes<span>$id</span>,<span>"'"</span>,collapse = <span>","</span>)</span></code><code><span leaf=""><span># 将连接数据中的细胞名替换为ID | Replace cell names with IDs in edge data</span></span></code><code><span leaf="">corpvlue<span>$from</span> &lt;- revalue(corpvlue<span>$from</span>, c(</span></code><code><span leaf="">  <span>'B cells memory'</span>=<span>'S1'</span>, <span>'B cells naive'</span>=<span>'S2'</span>, <span>'Dendritic cells activated'</span>=<span>'S3'</span>,</span></code><code><span leaf="">  <span>'Dendritic cells resting'</span>=<span>'S4'</span>, <span>'Eosinophils'</span>=<span>'S5'</span>, <span>'Fibroblasts'</span>=<span>'S6'</span>, </span></code><code><span leaf="">  <span>'Macrophages M0'</span>=<span>'S7'</span>, <span>'Macrophages M1'</span>=<span>'S8'</span>, <span>'Macrophages M2'</span>=<span>'S9'</span>, </span></code><code><span leaf="">  <span>'Mast cells activated'</span>=<span>'S10'</span>, <span>'Mast cells resting'</span>=<span>'S11'</span>, <span>'Monocytes'</span>=<span>'S12'</span>, </span></code><code><span leaf="">  <span>'Neutrophils'</span>=<span>'S13'</span>, <span>'NK cells activated'</span>=<span>'S14'</span>, <span>'NK cells resting'</span>=<span>'S15'</span>, </span></code><code><span leaf="">  <span>'Plasma cells'</span>=<span>'S16'</span>, <span>'T cells CD4 memory activated'</span>=<span>'S17'</span>, </span></code><code><span leaf="">  <span>'T cells CD4 memory resting'</span>=<span>'S18'</span>, <span>'T cells CD4 naive'</span>=<span>'S19'</span>, </span></code><code><span leaf="">  <span>'T cells CD8'</span>=<span>'S20'</span>, <span>'T cells follicular helper'</span>=<span>'S21'</span>, </span></code><code><span leaf="">  <span>'T cells gamma delta'</span>=<span>'S22'</span>, <span>'T cells regulatory Tregs'</span>=<span>'S23'</span></span></code><code><span leaf="">))</span></code><code><span leaf="">corpvlue<span>$to</span> &lt;- revalue(corpvlue<span>$to</span>, c(</span></code><code><span leaf="">  <span>'B cells memory'</span>=<span>'S1'</span>, <span>'B cells naive'</span>=<span>'S2'</span>, <span>'Dendritic cells activated'</span>=<span>'S3'</span>,</span></code><code><span leaf="">  <span>'Dendritic cells resting'</span>=<span>'S4'</span>, <span>'Eosinophils'</span>=<span>'S5'</span>, <span>'Fibroblasts'</span>=<span>'S6'</span>, </span></code><code><span leaf="">  <span>'Macrophages M0'</span>=<span>'S7'</span>, <span>'Macrophages M1'</span>=<span>'S8'</span>, <span>'Macrophages M2'</span>=<span>'S9'</span>, </span></code><code><span leaf="">  <span>'Mast cells activated'</span>=<span>'S10'</span>, <span>'Mast cells resting'</span>=<span>'S11'</span>, <span>'Monocytes'</span>=<span>'S12'</span>, </span></code><code><span leaf="">  <span>'Neutrophils'</span>=<span>'S13'</span>, <span>'NK cells activated'</span>=<span>'S14'</span>, <span>'NK cells resting'</span>=<span>'S15'</span>, </span></code><code><span leaf="">  <span>'Plasma cells'</span>=<span>'S16'</span>, <span>'T cells CD4 memory activated'</span>=<span>'S17'</span>, </span></code><code><span leaf="">  <span>'T cells CD4 memory resting'</span>=<span>'S18'</span>, <span>'T cells CD4 naive'</span>=<span>'S19'</span>, </span></code><code><span leaf="">  <span>'T cells CD8'</span>=<span>'S20'</span>, <span>'T cells follicular helper'</span>=<span>'S21'</span>, </span></code><code><span leaf="">  <span>'T cells gamma delta'</span>=<span>'S22'</span>, <span>'T cells regulatory Tregs'</span>=<span>'S23'</span></span></code><code><span leaf="">))</span></code><code><span leaf="">links &lt;- corpvlue  <span># 重命名连接数据 | Rename edge data</span></span></code><code><span leaf=""><span># 使用igraph包构建网络图 | Construct network graph using igraph package</span></span></code><code><span leaf="">net &lt;- graph_from_data_frame(d = links, vertices = nodes, directed = T)  </span></code><code><span leaf=""><span># 从数据框构建图对象：d为连接数据，vertices为节点数据，directed指定有向图 | Build graph: edges from 'links', nodes from 'nodes', directed graph</span></span></code></pre></section><h2 data-heading="true"><strong><span><span leaf="">开始画图</span></span></strong></h2><section><section powered-by="xiumi.us"><section><section data-pm-slice='4 6 ["para",{"tagName":"section","attributes":{"style":"margin-bottom: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"powered-by":"xiumi.us"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><p><span><span leaf=""><br></span></span></p><p><span leaf="">画法说明</span></p><ul><li><p><span><span leaf="">用代码画出例图中除圆心以外的部分。</span></span></p></li><li><p><span><span leaf="">再根据“output_HR_corlor.csv”的最后一列，用Illustrator在圆心上画点，点的颜色代表HR的正负。</span></span></p></li><li><p><span><span leaf="">最后输出的pdf文件是矢量图，可以用Illustrator等软件调整细胞名等文字的位置。</span></span></p></li></ul></section></section></section></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span leaf=""><span># 根据细胞聚类设置节点颜色 | Set node colors based on cell clusters</span></span></code><code><span leaf="">V(net)$color &lt;- revalue(nodes$type.label, c(<span>"A"</span>=mycol[<span>1</span>], <span>"B"</span>=mycol[<span>2</span>], <span>"C"</span>=mycol[<span>3</span>], <span>"D"</span>=mycol[<span>4</span>]))</span></code><code><span leaf=""><span># 将聚类标签映射为之前定义的颜色 | Map cluster labels to predefined colors</span></span></code><code><span leaf=""><span># 计算节点度并设置节点大小 | Calculate node degrees and set node sizes</span></span></code><code><span leaf="">V(net)$size &lt;- (<span>1</span> + V(net)$weight)*<span>3</span>  <span># 节点大小基于-log10(p值)，可根据数据调整 | Node size based on -log10(p-value), adjustable</span></span></code><code><span leaf="">V(net)$label &lt;- V(net)$media  <span># 设置节点标签为细胞名称 | Set node labels to cell names</span></span></code><code><span leaf=""><span># 设置边的属性 | Set edge properties</span></span></code><code><span leaf="">E(net)$arrow.mode &lt;- <span>0</span>        <span># 无边箭头 | No arrowheads</span></span></code><code><span leaf="">E(net)$edge.color &lt;- <span>"tomato"</span>  <span># 边的默认颜色 | Default edge color</span></span></code><code><span leaf="">E(net)$width &lt;- <span>1</span> + E(net)$weight/<span>6</span>  <span># 边的宽度基于权重，即-log10(p值) | Edge width based on -log10(p-value)</span></span></code><code><span leaf=""><span># 输出网络图到PDF文件 | Export network graph to PDF</span></span></code><code><span leaf="">pdf(<span>"Immune_network.pdf"</span>, width = <span>9.75</span>, height = <span>8.78</span>)</span></code><code><span leaf=""><span># 绘制网络图 | Plot network graph</span></span></code><code><span leaf="">plot(net,</span></code><code><span leaf="">     layout = layout_in_circle,  <span># 圆形布局 | Circular layout</span></span></code><code><span leaf="">     edge.curved = <span>0</span>.<span>2</span>,          <span># 边的弯曲度 | Edge curvature</span></span></code><code><span leaf="">     vertex.label.color = V(net)$color,  <span># 标签颜色与节点一致 | Label color matches node color</span></span></code><code><span leaf="">     vertex.label.dist = -<span>2</span>,     <span># 标签与节点的距离，负值表示外部 | Label distance from node</span></span></code><code><span leaf="">     edge.color = links$color)   <span># 边的颜色基于相关系数正负 | Edge color based on correlation direction</span></span></code><code><span leaf=""><span># 添加聚类图例 | Add legend for clusters</span></span></code><code><span leaf="">legend(<span>"topright"</span>,             <span># 图例位置：右上角 | Legend position: top-right</span></span></code><code><span leaf="">       c(<span>"Cell cluster-A"</span>, <span>"Cell cluster-B"</span>, <span>"Cell cluster-C"</span>, <span>"Cell cluster-D"</span>),</span></code><code><span leaf="">       pch = <span>21</span>,               <span># 图例符号：实心圆带边框 | Legend symbol: filled circle with border</span></span></code><code><span leaf="">       col = <span>"black"</span>,          <span># 边框颜色 | Border color</span></span></code><code><span leaf="">       pt.bg = mycol,          <span># 填充颜色 | Fill color</span></span></code><code><span leaf="">       pt.cex = <span>3</span>,             <span># 符号大小 | Symbol size</span></span></code><code><span leaf="">       cex = <span>1.3</span>,              <span># 文字大小 | Text size</span></span></code><code><span leaf="">       bty = <span>"n"</span>,              <span># 无边框 | No box</span></span></code><code><span leaf="">       ncol = <span>1</span>)               <span># 单列排列 | Single column</span></span></code><code><span leaf=""><span># 添加节点大小图例（基于P值） | Add legend for node size (based on p-values)</span></span></code><code><span leaf="">f &lt;- c(<span>0</span>.<span>05</span>, <span>0</span>.<span>001</span>, <span>0</span>.<span>00001</span>, <span>0</span>.<span>00000001</span>)  <span># 示例P值 | Example p-values</span></span></code><code><span leaf="">s &lt;- <span>abs</span>(log1<span>0</span>(f))  <span># 对应大小 | Corresponding sizes</span></span></code><code><span leaf="">legend(<span>"bottomright"</span>, </span></code><code><span leaf="">       inset = c(<span>0</span>, -<span>0</span>.<span>1</span>),     <span># 向下偏移 | Shift downward</span></span></code><code><span leaf="">       legend = f,             <span># 图例文字 | Legend text</span></span></code><code><span leaf="">       text.width = <span>0</span>.<span>2</span>,       <span># 文字宽度 | Text width</span></span></code><code><span leaf="">       title = <span>"logrank test, P value"</span>,  <span># 图例标题 | Legend title</span></span></code><code><span leaf="">       title.adj = -<span>0</span>.<span>5</span>,       <span># 标题位置调整 | Title position adjustment</span></span></code><code><span leaf="">       pch = <span>21</span>,               <span># 符号类型 | Symbol type</span></span></code><code><span leaf="">       pt.cex = s,             <span># 符号大小 | Symbol size</span></span></code><code><span leaf="">       bty = <span>'n'</span>,              <span># 无边框 | No box</span></span></code><code><span leaf="">       horiz = TRUE)           <span># 水平排列 | Horizontal arrangement</span></span></code><code><span leaf=""><span># 添加边的图例（正负相关） | Add legend for edge colors (positive/negative correlations)</span></span></code><code><span leaf="">legend(<span>"bottomright"</span>,</span></code><code><span leaf="">       c(<span>"Positive correlation with P &lt; 0.0001"</span>, </span></code><code><span leaf="">         <span>"Negative correlation with P &lt; 0.0001"</span>),</span></code><code><span leaf="">       col = c(poscol, negcol),  <span># 颜色对应正负相关 | Colors for positive/negative correlations</span></span></code><code><span leaf="">       bty = <span>"n"</span>,                <span># 无边框 | No box</span></span></code><code><span leaf="">       cex = <span>1</span>,                  <span># 文字大小 | Text size</span></span></code><code><span leaf="">       lty = <span>1</span>,                  <span># 线条类型 | Line type</span></span></code><code><span leaf="">       lwd = <span>5</span>)                  <span># 线条宽度 | Line width</span></span></code><code><span leaf="">dev.off()  <span># 关闭图形设备 | Close graphics device</span></span></code></pre></section><p><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7BwuzfKa0GJP4ibSfibtnD5vTSORunbGUtMo0ssmty7rDjvRu8mS29fSWrp3nSLfESibERiav7ybHl3Y0iaKIw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8484375" data-s="300,640" data-type="png" data-w="1280" type="block" data-imgfileid="100003110" src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7BwuzfKa0GJP4ibSfibtnD5vTSORunbGUtMo0ssmty7rDjvRu8mS29fSWrp3nSLfESibERiav7ybHl3Y0iaKIw/640?wx_fmt=png&amp;from=appmsg"></span></p><p><span leaf=""><br></span></p><p data-pm-slice="0 0 []"><span><span leaf="">文字的位置用Illustrator调整；再根据“output_HR_corlor.csv”的最后一列用Illustrator在圆心上画点，点的颜色代表HR的正负。</span></span></p><p><span leaf=""><br></span></p><section data-pm-slice="5 3 []"><section><span data-pm-slice="0 0 []"><h1 tabindex="-1" dir="auto" data-pm-slice="0 0 []"><span><strong><span><span leaf="">代码、输入、输出文件</span></span></strong></span></h1></span></section><p><span><span leaf="">https://github.com/ying-ge/FigureYa/tree/main/</span><span leaf="">FigureYa81immune_network</span></span></p><p><span leaf="" data-remoteid="" data-asynid="" src="" data-src="" align="" alt="" border="" data-ratio="" data-s="300,640" data-type="png" data-w="" aria-label="" aria-braillelabel="" aria-description="" height="" hspace="" ismap opacity="" sizes="" title="" type="block" usemap="" vspace="" width="" data-width="" data-height="" data-croporisrc="" data-cropx1="" data-cropx2="" data-cropy1="" data-cropy2="" data-cropselx1="" data-cropselx2="" data-cropsely1="" data-cropsely2="" data-backw="" data-backh="" data-copyright="" data-oversubscription-url="" data-before-oversubscription-url="" data-galleryid="" data-gallerysupplier="" data-cardimg="" data-fileid="" data-imgfileid="100003109" data-positionback="" data-imgqrcoded="" data-imgid="" data-upload="1" data-fromlib="" data-aiimageid="" data-cacheurl="" data-retry=""><br></span></p></section><h1 tabindex="-1" dir="auto" data-pm-slice="0 0 []"><span><strong><span><span leaf="">Citation</span></span></strong></span></h1><section><span><span leaf="">Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005</span></span></section><section><span><span leaf="">Zeng D, Li M, Zhou R, Zhang J, Sun H, Shi M, et al. Tumor microenvironment characterization in gastric cancer identifies prognostic and immunotherapeutically relevant gene signatures. Cancer Immunology Research 2019:canimm.0436.2018 doi 10.1158/2326-6066.CIR-18-0436.</span></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/W0rdtkDRLSm2vGohdEX_Gg",target="_blank" rel="noopener noreferrer">原文链接</a>
