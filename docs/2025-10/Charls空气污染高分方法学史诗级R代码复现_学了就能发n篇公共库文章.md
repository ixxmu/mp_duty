---
title: "Charls空气污染高分方法学史诗级R代码复现，学了就能发n篇公共库文章"
date: 2025-10-08T23:45:14Z
draft: ["false"]
tags: [
  "fetched",
  "实战医学统计"
]
categories: ["Acdemic"]
---
Charls空气污染高分方法学史诗级R代码复现，学了就能发n篇公共库文章 by 实战医学统计
------
<div><p data-mpa-powered-by="yiban.io"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/Zb9jB9p1cKG8hm4AQmFw4MEhbUWroVODb7BBtbH7G3Ihib23GYEDa2ibMQd3rpWv1ExCzibpVnPFLzibhicuCbIibIAg/640?wx_fmt=jpeg&amp;watermark=1#imgIndex=0" data-ratio="0.29444444444444445" data-s="300,640" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/Zb9jB9p1cKG8hm4AQmFw4MEhbUWroVODb7BBtbH7G3Ihib23GYEDa2ibMQd3rpWv1ExCzibpVnPFLzibhicuCbIibIAg/640?wx_fmt=jpeg&amp;watermark=1#imgIndex=0"></span></p><p><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_gif/Zb9jB9p1cKGAAa124Ik6SAg6kXjw7NOVereYZ0SoyJa0RoibDPOfiapQlgyrSsK4FKt6qic66cicwoJDyQbB4ZkWrg/640?wx_fmt=gif#imgIndex=1" data-ratio="0.2777777777777778" data-type="gif" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_gif/Zb9jB9p1cKGAAa124Ik6SAg6kXjw7NOVereYZ0SoyJa0RoibDPOfiapQlgyrSsK4FKt6qic66cicwoJDyQbB4ZkWrg/640?wx_fmt=gif#imgIndex=1"></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">环境领域交叉临床流行病学数据，往往联合就可以发高分SCI环境类杂志，IF分数经常&gt;10分。可以说拿着你手中的多中心横断面、纵向队列数据就可以脑洞大开，链接任意空气污染前端数据，分析后端结局的关联关系。 </span></p><p data-tool="mdnice编辑器"><span leaf="">PM2.5、PM1、O3等等环境数据，是一个宏观万物互联指标可以万能连接任意疾病和结局，样本量足够大的数据集就可以干！本文是国庆期间深度写作的文章，细节超多，内容极其详细，干货满满的，喜欢就多多转发点个赞哦。 </span></p><p data-tool="mdnice编辑器"><span leaf="">本文内容超长，想跟着我学硬核的技术可以关注即将闪亮登场的超高性价比B款课程哦。<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxNTUzNDMyNQ==&amp;mid=2650960664&amp;idx=1&amp;sn=0451853a669fbacdc679409e13b752c2&amp;scene=21#wechat_redirect" textvalue="" linktype="text" data-linktype="2">爆款！AI+RCT+真实世界+因果机器学习+交叉学科+纵向数据，150小时</a></span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJpqCOia9GwYXwWzZqKdRPQ4pbIIg4wwAyJAE8cjl19FAqiamLaSgfF1UA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5518518518518518" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477146" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJpqCOia9GwYXwWzZqKdRPQ4pbIIg4wwAyJAE8cjl19FAqiamLaSgfF1UA/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJGQ48yzN3pqtwznOfWPuTgAg8NBRN9n3vFH1pu2hJZQy0ERuzjSt98g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5361111111111111" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477147" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJGQ48yzN3pqtwznOfWPuTgAg8NBRN9n3vFH1pu2hJZQy0ERuzjSt98g/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">一、PM2.5系列环境数据</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">曾几何时，PM数据被环境专业的人士视若珍宝不肯轻易分享，毕竟这是他们吃饭的家伙。我也曾经在78年前问过很多从业者，都讳莫如深。如今随着时代发展，大家可以十分方便的拿到开源环境数据，这对本就是举步维艰的环境专业又加剧了恶性竞争。 开源数据中，CHAP: <span textstyle="">https://weijing-rs.github.io/product.html</span>，就是十分优秀的开源集。CHAP 数据集包含 7 种主要空气污染物（即 <span textstyle="">PM1、PM2.5、PM10、O3、NO2、SO2 和 CO</span>）， PM2.5 化学成分（即 SO42-、NO3-、NH4+、Cl-、BC 和 OM），以及环境多环芳烃（PAHs），包括 7 种致癌 PAHs（即 BaA、Chr、BbF、BkF、BaP、DahA、IcdP）。该 CHAP 数据集为公开且免费向所有用户开放！除了PM1、化学成分、PAHS等涉及作者要拿来当通讯作者筹码的高端数据集，其他作者都很大方的公开了。也足够大家发点小分杂志了。</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJwvZOoBPmibv3cXCTib73iaJJcruJrUrFPmADdqBww5KT6MtFuyPl1VMzw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5462962962962963" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477148" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJwvZOoBPmibv3cXCTib73iaJJcruJrUrFPmADdqBww5KT6MtFuyPl1VMzw/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJ1GJmxu1Zv4UQeQ4TVtHc8WGc7IF9jou8zaSQFOtQ0tVA00rjiaGnRAg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.525" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477150" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJ1GJmxu1Zv4UQeQ4TVtHc8WGc7IF9jou8zaSQFOtQ0tVA00rjiaGnRAg/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJiaoOz7FqONgG3pOZD8zxoJHljMx68gY3XvjYWJNN6NY6gCvMibqxUqHg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5703703703703704" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477149" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJiaoOz7FqONgG3pOZD8zxoJHljMx68gY3XvjYWJNN6NY6gCvMibqxUqHg/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJbUCCaPRMn3U1Q5wWicdINX8EOVbnh5icD7xgnX5kqKicPwU0CdqKIsnuQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5462962962962963" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477151" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJbUCCaPRMn3U1Q5wWicdINX8EOVbnh5icD7xgnX5kqKicPwU0CdqKIsnuQ/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJ4pQdznRwWBQGzmPHFGekQ7IU1Dpoic3bgk60VCgEU96jXH3iakVqr42Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5481481481481482" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477152" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJ4pQdznRwWBQGzmPHFGekQ7IU1Dpoic3bgk60VCgEU96jXH3iakVqr42Q/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJCgQExwibFNqutu2HSQ3laTLNb8xcJWyyX1NBzWk4qPMElZibNZUkqogg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5879629629629629" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477153" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJCgQExwibFNqutu2HSQ3laTLNb8xcJWyyX1NBzWk4qPMElZibNZUkqogg/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">二、范文</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">Pubmed搜索charls+PM2.5可以发现许多文章。我这里举几个例子，其中利用我们之前提供的数据集复现一下全文。</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJuUjTerjsMSyDiblztn8yuibbQ9zgb862icjBdCIqjdj8E98vW1eyZdAmw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.562962962962963" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477155" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJuUjTerjsMSyDiblztn8yuibbQ9zgb862icjBdCIqjdj8E98vW1eyZdAmw/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJKB2lhOu7UD3gemiclqkQOO3geGyQbKHKotVXmYayvN2zrNNUydPEYEw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5425925925925926" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477156" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJKB2lhOu7UD3gemiclqkQOO3geGyQbKHKotVXmYayvN2zrNNUydPEYEw/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJN9PhJK6xMhT1EFcxcib2jjCuxsTr3MdHmkS0mmPDwCguRWMg34ItK2w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.562962962962963" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477154" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJN9PhJK6xMhT1EFcxcib2jjCuxsTr3MdHmkS0mmPDwCguRWMg34ItK2w/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><p data-tool="mdnice编辑器"><span leaf=""> 三、R代码 </span></p><p data-tool="mdnice编辑器"><span leaf="">针对范文5，OR且仅用charls2015数据较为短平快。我复现全文如下。 去chap上下载数据，直接下载太大一百多G，只需下M、Y数据即可，不过只能手动一个个下。当然B款课程都有赠送数据集和代码，让你快速复现charls系列多篇文章。 </span></p><p data-tool="mdnice编辑器"><span leaf="">3.1 数据整理 </span></p><h3 data-tool="mdnice编辑器"><span></span></h3><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJy4wy63IYkRII8bSUQWLuJKupHVBZSrujGXSsv5ehTNVFENIy3QWoYA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5435185185185185" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477159" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJy4wy63IYkRII8bSUQWLuJKupHVBZSrujGXSsv5ehTNVFENIy3QWoYA/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJuqL7y6c8ic8RuF8Y89D29XVjXsbBBRicbyXdicKBKTiczBV4QBnVTP8j1Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5370370370370371" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477161" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJuqL7y6c8ic8RuF8Y89D29XVjXsbBBRicbyXdicKBKTiczBV4QBnVTP8j1Q/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJOJib2tsGMW8aa7DBDw21lqN2sh1EQX4yJ9ibRib0X9lj9oOqC0QeYtbYw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.525" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477160" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJOJib2tsGMW8aa7DBDw21lqN2sh1EQX4yJ9ibRib0X9lj9oOqC0QeYtbYw/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><p data-tool="mdnice编辑器"><span leaf="">3.2 SCI基线表与纳入排除 </span></p><p data-tool="mdnice编辑器"><span leaf="">我尝试复现了全文纳入排除，不过还是有2000人左右的出入。流程是没太大问题的，按照纳入排除考虑的也比较周祥。步骤难点在城市获取转为<span textstyle="">百度 → 先 BD-09 → GCJ-02 → WGS84坐标系</span>，与https://zenodo.org/communities/chap/records?q=&amp;l=list&amp;p=1&amp;s=10&amp;sort=newest 提供的chap数据集.ns进行完美匹配。</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJQxNjlNAM6ZgoG2eNTF9qtzVAnmANsFPqKaUvrxfzic7honbuRSNZVIQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5407407407407407" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477162" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJQxNjlNAM6ZgoG2eNTF9qtzVAnmANsFPqKaUvrxfzic7honbuRSNZVIQ/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJib4icFtXRdpGfW4kEiaSNhv8WmYlkfibJBEp5MJUvBG7uiawQWmTxmMnqYA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5879629629629629" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477163" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJib4icFtXRdpGfW4kEiaSNhv8WmYlkfibJBEp5MJUvBG7uiawQWmTxmMnqYA/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><p data-tool="mdnice编辑器"><span leaf="">3.3 数据整理R代码</span><span leaf=""> </span></p><p data-tool="mdnice编辑器"><span leaf="">难点在于拼音城市与国际接轨，离线maps::world.cities城市不全，自动版百度地图开放平台AK对中文识别号对拼音和英文识别弱。综上，我尝试了离线和AK在线溯源2种方法组合，以便后续国际公共数据库联合识别经纬度用。离线版完全代码见<span textstyle="">文末分享</span>。</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJqJWHafydT1h4Phw6tnvK5YBIDL2BPMFHfnoTuKdgHuv3wSwqMuPibuQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5601851851851852" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477164" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJqJWHafydT1h4Phw6tnvK5YBIDL2BPMFHfnoTuKdgHuv3wSwqMuPibuQ/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJJzeMlEUj6X9VH4p1nibSbia7hYvoLFicEBaoaAhGWW1t0Op9KvvrRaC5Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6814814814814815" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477165" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJJzeMlEUj6X9VH4p1nibSbia7hYvoLFicEBaoaAhGWW1t0Op9KvvrRaC5Q/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJE8hFM2jIbnCL4DEib4tvldeJEk23hFK6rT0xmYuQ0A8eFsTCr5dw7rg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5694444444444444" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477166" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJE8hFM2jIbnCL4DEib4tvldeJEk23hFK6rT0xmYuQ0A8eFsTCr5dw7rg/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJghBKkPpvTiaBH6M21zDVfKtkQPNpic9rTLM5CBAmkKvz2m4Ts5KBbFow/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5574074074074075" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477167" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJghBKkPpvTiaBH6M21zDVfKtkQPNpic9rTLM5CBAmkKvz2m4Ts5KBbFow/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJVicncCVOjhjd8EiazzFxibZKfXSX3WEUHjpGhjybkGaCJAiaGA0W8QmZUA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5564814814814815" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477168" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJVicncCVOjhjd8EiazzFxibZKfXSX3WEUHjpGhjybkGaCJAiaGA0W8QmZUA/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJljXgiaBjUBpIS6Y2BqTFmc7qessZrSPicUUq18v9OQvrUDNvibGC0eQYw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.55" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477169" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJljXgiaBjUBpIS6Y2BqTFmc7qessZrSPicUUq18v9OQvrUDNvibGC0eQYw/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJGpic0TMoSQzQaNqzxmGhFoZpJMVb82JcJVNmnGfRGPkiamLlyahOxx0Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5268518518518519" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477171" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJGpic0TMoSQzQaNqzxmGhFoZpJMVb82JcJVNmnGfRGPkiamLlyahOxx0Q/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJvaicDZDxeNgJRT6ybUmoM0t7DnQJ17Wl9eMEJ3IXb5Ip5U6sLkQePSQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5601851851851852" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477170" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJvaicDZDxeNgJRT6ybUmoM0t7DnQJ17Wl9eMEJ3IXb5Ip5U6sLkQePSQ/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf=""><br></span><span><span leaf=""># <a topic-id="mgi7mk0j-apqibj" data-topic="1">#charls</a> PM系列OR范文复现,实战医学统计</span></span><span leaf=""><br></span><span><span leaf="">#--- 智荟charls_20112020list全集.RData</span></span><span leaf=""><br></span><span leaf="">setwd(</span><span><span leaf="">"D:/聂个人文件/副业项目/广州智荟数据有限公司/A款2024课件/8.公共数据库/CHARLS"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">pacman::p_load(haven,dplyr,stringr,purrr,lcmm,LCTMtools)</span><span leaf=""><br></span><span leaf="">load(</span><span><span leaf="">"D:/聂个人文件/副业项目/广州智荟数据有限公司/A款2024课件/8.公共数据库/CHARLS/智荟charls_20112020list全集.RData"</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf="">#<a topic-id="mgi7mk0j-bnn8oy" data-topic="1">#修复中文</a>，修复不了</span></span><span leaf=""><br></span><span><span leaf="">#<a topic-id="mgi7mk0j-kolspz" data-topic="1">#charls</a>_v2020[["charls_2011"]][["psu"]]$city   &lt;- iconv(charls_v2020[["charls_2011"]][["psu"]]$city, from = "GBK", to = "UTF-8")</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#-----1. 源数据体检16406人-------</span></span><span leaf=""><br></span><span><span leaf="">#-----选取横断面2015,做体检有16406人</span></span><span leaf=""><br></span><span leaf="">bio2015 &lt;- charls_v2020[[</span><span><span leaf="">"charls_2015"</span></span><span leaf="">]][[</span><span><span leaf="">"biomarker"</span></span><span leaf="">]]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#--读取基线数据补齐</span></span><span leaf=""><br></span><span leaf="">data.popu &lt;- charls_v2020[[</span><span><span leaf="">"bdmph"</span></span><span leaf="">]][[</span><span><span leaf="">"bdmph_population"</span></span><span leaf="">]]</span><span leaf=""><br></span><span><span leaf=""># 🌟 删除 gender 为 NA 的行, 并 id  wave 联合重复选取唯一行</span></span><span leaf=""><br></span><span leaf="">data.popu &lt;- data.popu[!is.na(data.popu</span><span><span leaf="">$gender</span></span><span leaf="">) , ]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#<a topic-id="mgi7mk0j-vwgkyq" data-topic="1">#21092人</a> 2015基线</span></span><span leaf=""><br></span><span leaf="">data.2015 &lt;- data.popu[data.popu</span><span><span leaf="">$wave</span></span><span leaf=""> == 2015, ] </span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#-----2. 纳入排除-------</span></span><span leaf=""><br></span><span><span leaf="">#---2015且做biomarker体检 16392人</span></span><span leaf=""><br></span><span leaf="">temp.df &lt;- data.2015 %&gt;%</span><span leaf=""><br></span><span leaf="">  semi_join(bio2015, by = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0j-joypie" data-topic="1">#age</a>&gt;=45, </span></span><span leaf=""><br></span><span leaf="">temp.df2 &lt;- temp.df %&gt;%</span><span leaf=""><br></span><span leaf="">  filter(age &gt;= 45)  </span><span><span leaf=""><a topic-id="mgi7mk0j-hke2li" data-topic="1">#15456人</a></span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0j-j4a5z3" data-topic="1">#血液检测2011</a>+2015</span></span><span leaf=""><br></span><span><span leaf=""># 21097人2015年抽血，空腹血糖11363人</span></span><span leaf=""><br></span><span><span leaf="">#---方法1</span></span><span leaf=""><br></span><span leaf="">blood &lt;- charls_v2020[[</span><span><span leaf="">"charls_derived"</span></span><span leaf="">]][[</span><span><span leaf="">"blood"</span></span><span leaf="">]]</span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0j-ysd30w" data-topic="1">#11363人</a></span></span><span leaf=""><br></span><span leaf="">blood2015 &lt;- blood %&gt;%  filter(wave == 2015) %&gt;%</span><span leaf=""><br></span><span leaf="">  filter(bl_fasting == 1)  </span><span leaf=""><br></span><span leaf="">names(blood2015)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#---方法2，</span></span><span leaf=""><br></span><span leaf="">blood2 &lt;- charls_v2020[[</span><span><span leaf="">"charls_2015"</span></span><span leaf="">]][[</span><span><span leaf="">"blood"</span></span><span leaf="">]]</span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0j-cur823" data-topic="1">#11364人差不多</a></span></span><span leaf=""><br></span><span leaf="">blood20152 &lt;- blood2 %&gt;%  filter(bl_fasting == 1)  </span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#---<a topic-id="mgi7mk0j-7b43ix" data-topic="1">#仅保留空腹检查者</a> 10705人</span></span><span leaf=""><br></span><span leaf="">temp.df3 &lt;- temp.df2 %&gt;%</span><span leaf=""><br></span><span leaf="">  semi_join(blood2015, by = </span><span><span leaf="">"id"</span></span><span leaf="">) </span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#---<a topic-id="mgi7mk0j-fvqdc4" data-topic="1">#进行测量之前</a> 30 分钟内，受试者是否吸烟、运动、进食和饮酒，9198人</span></span><span leaf=""><br></span><span leaf="">pm_ids_clean &lt;- charls_v2020[[</span><span><span leaf="">"charls_derived"</span></span><span leaf="">]][[</span><span><span leaf="">"physical_measures"</span></span><span leaf="">]] %&gt;%</span><span leaf=""><br></span><span leaf="">  filter(wave == 2015, bpact30 == 0) %&gt;%</span><span leaf=""><br></span><span leaf="">  distinct(id)                        </span><span><span leaf=""># 只要 id</span></span><span leaf=""><br></span><span leaf="">temp.df4 &lt;- temp.df3 %&gt;%</span><span leaf=""><br></span><span leaf="">  semi_join(pm_ids_clean, by = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#---<a topic-id="mgi7mk0j-6wr53l" data-topic="1">#腰围不missing</a>，9147人</span></span><span leaf=""><br></span><span leaf="">pm_ids_clean &lt;- charls_v2020[[</span><span><span leaf="">"charls_derived"</span></span><span leaf="">]][[</span><span><span leaf="">"physical_measures"</span></span><span leaf="">]] %&gt;%</span><span leaf=""><br></span><span leaf="">  filter(wave == 2015, !is.na(mwaist)) %&gt;%</span><span leaf=""><br></span><span leaf="">  distinct(id)                        </span><span><span leaf=""># 只要 id</span></span><span leaf=""><br></span><span leaf="">temp.df5 &lt;- temp.df4 %&gt;%</span><span leaf=""><br></span><span leaf="">  semi_join(pm_ids_clean, by = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-9g6gga" data-topic="1">#SBP</a> DBP血压都不缺失，9112人</span></span><span leaf=""><br></span><span leaf="">pm_ids_clean &lt;- charls_v2020[[</span><span><span leaf="">"charls_derived"</span></span><span leaf="">]][[</span><span><span leaf="">"physical_measures"</span></span><span leaf="">]] %&gt;%</span><span leaf=""><br></span><span leaf="">  filter( wave == 2015,!is.na(systo),!is.na(diasto) ) %&gt;%</span><span leaf=""><br></span><span leaf="">  distinct(id)</span><span leaf=""><br></span><span><span leaf=""># 只要 id</span></span><span leaf=""><br></span><span leaf="">temp.df6 &lt;- temp.df5 %&gt;%</span><span leaf=""><br></span><span leaf="">  semi_join(pm_ids_clean, by = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#--甘油三酯（TG）、高密度脂蛋白（HDL）、空腹血糖（FBG）或 C 反应蛋白（CRP）数据不缺失</span></span><span leaf=""><br></span><span leaf="">blood2015_clean &lt;- blood2015 %&gt;%</span><span leaf=""><br></span><span leaf="">  filter( </span><span leaf=""><br></span><span leaf="">    !is.na(bl_tg),          </span><span><span leaf=""># TG 不缺失</span></span><span leaf=""><br></span><span leaf="">    !is.na(bl_hdl),         </span><span><span leaf=""># HDL 不缺失</span></span><span leaf=""><br></span><span leaf="">    !is.na(bl_glu),         </span><span><span leaf=""># 空腹血糖 不缺失</span></span><span leaf=""><br></span><span leaf="">    !is.na(bl_crp)          </span><span><span leaf=""># CRP 不缺失</span></span><span leaf=""><br></span><span leaf="">  ) %&gt;%</span><span leaf=""><br></span><span leaf="">  distinct(id)</span><span leaf=""><br></span><span><span leaf=""># 只要 id, 9104人</span></span><span leaf=""><br></span><span leaf="">temp.df7 &lt;- temp.df6 %&gt;%</span><span leaf=""><br></span><span leaf="">  semi_join(blood2015_clean, by = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#---❤️ .ns文件读取 CHAP_PM1_Y1K_2013_V3.nc 文件是 HDF5 格式的 NetCDF4 文件</span></span><span leaf=""><br></span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#------3. psu 经纬度----</span></span><span leaf=""><br></span><span><span leaf="">#----1️⃣ 离线版→ psu经纬度----</span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-15jb7k" data-topic="1">#离线城市经纬度匹配</a>（不需要上网）</span></span><span leaf=""><br></span><span><span leaf=""># 思路：用 maps::world.cities 提供的中国（含台湾）城市经纬度做“词典”， </span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-ynsevk" data-topic="1">#将</a> psu$city_eng 进行规范化处理后，与词典做模糊匹配，得到每个城市的行政中心经纬度。</span></span><span leaf=""><br></span><span leaf="">pacman::p_load(dplyr, stringr, fuzzyjoin, maps, tibble)</span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-waybcd" data-topic="1">#psu抽样省市</a></span></span><span leaf=""><br></span><span leaf="">psu &lt;- charls_v2020[[</span><span><span leaf="">"charls_2011"</span></span><span leaf="">]][[</span><span><span leaf="">"psu"</span></span><span leaf="">]]</span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-09ouz8" data-topic="1">#world</a>.cities 数据集来自 maps 包，包含全球城市名及经纬度（long/lat），</span></span><span leaf=""><br></span><span><span leaf=""># 只保留中国与台湾</span></span><span leaf=""><br></span><span leaf="">data(</span><span><span leaf="">"world.cities"</span></span><span leaf="">, package = </span><span><span leaf="">"maps"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">gaz &lt;- world.cities %&gt;%</span><span leaf=""><br></span><span leaf="">  filter(country.etc %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">"China"</span></span><span leaf="">, </span><span><span leaf="">"Taiwan"</span></span><span leaf="">)) %&gt;%   </span><span><span leaf=""># 视分析口径而定，也可只用 China</span></span><span leaf=""><br></span><span leaf="">  transmute(</span><span leaf=""><br></span><span leaf="">    city_gaz_raw  = name,                                                </span><span><span leaf=""># 原始城市名（英文）</span></span><span leaf=""><br></span><span leaf="">    city_gaz_norm = str_to_lower(str_replace_all(name, </span><span><span leaf="">"[^a-zA-Z0-9]"</span></span><span leaf="">, </span><span><span leaf="">""</span></span><span leaf="">)),  </span><span><span leaf=""># 规范化：小写并去掉非字母数字</span></span><span leaf=""><br></span><span leaf="">    longitude     = long,                                                </span><span><span leaf=""># 经度</span></span><span leaf=""><br></span><span leaf="">    latitude      = lat,                                                 </span><span><span leaf=""># 纬度</span></span><span leaf=""><br></span><span leaf="">    pop           = pop                                                  </span><span><span leaf=""># 城市人口（用于平手时优先人口更多者）</span></span><span leaf=""><br></span><span leaf="">  ) %&gt;%</span><span leaf=""><br></span><span leaf="">  distinct(city_gaz_norm, .keep_all = TRUE)                              </span><span><span leaf=""># 去重：同名城市取一条（通常保留人口更大/更常见者）</span></span><span leaf=""><br></span><span><span leaf=""># 对 psu$city_eng 做规范化</span></span><span leaf=""><br></span><span><span leaf=""># 目标：把各种英文写法（大小写、空格、连字符、备注后缀）统一到“可比”的形式，</span></span><span leaf=""><br></span><span><span leaf=""># 便于后续模糊匹配提高命中率。</span></span><span leaf=""><br></span><span leaf="">stopifnot(</span><span><span leaf="">"city_eng"</span></span><span leaf=""> %</span><span><span leaf="">in</span></span><span leaf="">% names(psu))  </span><span><span leaf=""># 保护性检查：必须有 city_eng 列</span></span><span leaf=""><br></span><span leaf="">psu_norm &lt;- psu %&gt;%</span><span leaf=""><br></span><span leaf="">  mutate(</span><span leaf=""><br></span><span leaf="">    city_eng_raw  = city_eng,                                                     </span><span><span leaf=""># 保留原始英文城市名</span></span><span leaf=""><br></span><span leaf="">    city_eng_norm = str_to_lower(str_replace_all(city_eng, </span><span><span leaf="">"[^a-zA-Z0-9]"</span></span><span leaf="">, </span><span><span leaf="">""</span></span><span leaf="">)), </span><span><span leaf=""># 规范化：小写+去掉非字母数字</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 去掉常见后缀或民族形容词（prefecture/region/league/autonomous 等），</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 例如“chuxiong yi autonomous prefecture”去掉后缀，便于匹配到“chuxiong”</span></span><span leaf=""><br></span><span leaf="">    city_eng_norm = str_replace_all(</span><span leaf=""><br></span><span leaf="">      city_eng_norm,</span><span leaf=""><br></span><span leaf="">      c(</span><span><span leaf="">"autonomousprefecture"</span></span><span leaf=""> = </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"mongolian"</span></span><span leaf="">            = </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"uygur"</span></span><span leaf="">                = </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"kazakh"</span></span><span leaf="">               = </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"prefecture"</span></span><span leaf="">           = </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"region"</span></span><span leaf="">               = </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"league"</span></span><span leaf="">               = </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"airport"</span></span><span leaf="">              = </span><span><span leaf="">""</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"city"</span></span><span leaf="">                 = </span><span><span leaf="">""</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    ) %&gt;%</span><span leaf=""><br></span><span leaf="">      str_squish()                                                                  </span><span><span leaf=""># 再次压缩多余空格（保险）</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span leaf="">……</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#------------4. 测试.ns读取-----</span></span><span leaf=""><br></span><span><span leaf="">#------3️⃣ .ns翻转栅格PM1 2013-------</span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-6auvre" data-topic="1">#r</a>_rot（翻转/旋转之后的 PM1 栅格，已经设置了 extent 和 CRS = WGS84）</span></span><span leaf=""><br></span><span><span leaf=""># 加载必要包,时间较久！</span></span><span leaf=""><br></span><span><span leaf=""># options(install.packages.compile.from.source = "never")  # 禁止从源码编译</span></span><span leaf=""><br></span><span><span leaf=""># install.packages("ncdf4")                                # 直接装ncdf4，还是后续错误</span></span><span leaf=""><br></span><span leaf="">pacman::p_load(ncdf4,raster,terra,rhdf5) </span><span leaf=""><br></span><span><span leaf=""># 1. 先定义文件路径 </span></span><span leaf=""><br></span><span leaf="">nc_file &lt;- </span><span><span leaf="">"D:/聂个人文件/副业项目/广州智荟数据有限公司/B款环境与真实世界纵向数据/环境交叉/CHAP/pm1/CHAP_PM1_Y1K_2013_V3.nc"</span></span><span leaf=""><br></span><span><span leaf="">#--rhdf5 把.nc 里的经纬度与变量读出来交给terra 设置 extent/CRS</span></span><span leaf=""><br></span><span><span leaf=""># 1) 看看文件里都有什么节点（找 lon/lat/变量 名称）</span></span><span leaf=""><br></span><span leaf="">h5ls(nc_file)</span><span leaf=""><br></span><span><span leaf=""># 2) 读经纬度与污染变量</span></span><span leaf=""><br></span><span leaf="">lon &lt;- h5read(nc_file, </span><span><span leaf="">"lon"</span></span><span leaf="">)        </span><span><span leaf=""># 或 "longitude"、"/lon"</span></span><span leaf=""><br></span><span leaf="">lat &lt;- h5read(nc_file, </span><span><span leaf="">"lat"</span></span><span leaf="">)        </span><span><span leaf=""># 或 "latitude"、"/lat"</span></span><span leaf=""><br></span><span leaf="">pm  &lt;- h5read(nc_file, </span><span><span leaf="">"PM1"</span></span><span leaf="">)        </span><span><span leaf=""># 比如 "PM1"；若是 3D (time×lat×lon)，再选时间层</span></span><span leaf=""><br></span><span><span leaf=""># 3) 构造 SpatRaster</span></span><span leaf=""><br></span><span><span leaf="">#   假设 pm 为 2D 矩阵，维度为 [lat, lon]（先确认 dim(pm) == c(length(lat), length(lon))）</span></span><span leaf=""><br></span><span leaf="">r &lt;- rast(pm)</span><span leaf=""><br></span><span><span leaf=""># 4) 设定空间范围和坐标系（WGS84）</span></span><span leaf=""><br></span><span leaf="">ext(r) &lt;- c(min(lon), max(lon), min(lat), max(lat))</span><span leaf=""><br></span><span leaf="">crs(r) &lt;- </span><span><span leaf="">"EPSG:4326"</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 若 lat 是从北到南（递减），需要翻转一下：</span></span><span leaf=""><br></span><span><span leaf="">if</span></span><span leaf=""> (length(lat) &gt; 1 &amp;&amp; lat[2] &lt; lat[1]) r &lt;- flip(r, direction = </span><span><span leaf="">"vertical"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 5) 可视化/裁剪/输出,反了</span></span><span leaf=""><br></span><span leaf="">plot(r)</span><span leaf=""><br></span><span><span leaf=""># 假设原数据覆盖 70E-140E, 15N-55N</span></span><span leaf=""><br></span><span leaf="">m &lt;- as.matrix(r, wide=TRUE)</span><span leaf=""><br></span><span leaf="">m_rot &lt;- t(apply(m, 2, rev))   </span><span><span leaf=""># 顺时针旋转 90°</span></span><span leaf=""><br></span><span leaf="">r_rot &lt;- rast(m_rot)</span><span leaf=""><br></span><span leaf="">ext(r_rot) &lt;- c(70, 140, 15, 55)  </span><span><span leaf=""># 手动补上经纬度范围</span></span><span leaf=""><br></span><span leaf="">crs(r_rot) &lt;- </span><span><span leaf="">"EPSG:4326"</span></span><span leaf=""><br></span><span leaf="">plot(r_rot)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#-----4️⃣ 链接 psu_geo_pm1 2013-------</span></span><span leaf=""><br></span><span leaf="">pacman::p_load(terra, sf, dplyr)</span><span leaf=""><br></span><span><span leaf=""># 1) 把 psu_geo 转换为 SpatVector 点图层</span></span><span leaf=""><br></span><span leaf="">pts &lt;- terra::vect(</span><span leaf=""><br></span><span leaf="">  psu_geo,</span><span leaf=""><br></span><span leaf="">  geom = c(</span><span><span leaf="">"wgs_lon"</span></span><span leaf="">, </span><span><span leaf="">"wgs_lat"</span></span><span leaf="">),   </span><span><span leaf=""># 列名要和 psu_geo 里的一致</span></span><span leaf=""><br></span><span leaf="">  crs = </span><span><span leaf="">"EPSG:4326"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  keepgeom = TRUE</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 2) 从栅格提取对应点的 PM1 值</span></span><span leaf=""><br></span><span leaf="">pm1_2013 &lt;- terra::extract(r_rot, pts, ID=FALSE)  </span><span leaf=""><br></span><span><span leaf=""># 返回一个数据框，按点顺序</span></span><span leaf=""><br></span><span><span leaf=""># 3) 合并回 psu_geo</span></span><span leaf=""><br></span><span leaf="">psu_geo_pm1 &lt;- psu_geo %&gt;%</span><span leaf=""><br></span><span leaf="">  bind_cols(pm1_2013 = pm1_2013[,1])  </span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#------------6.  最终纳排→ temp.df8-----</span></span><span leaf=""><br></span><span><span leaf=""># temp.df7 合并psu_geo_all</span></span><span leaf=""><br></span><span leaf="">pacman::p_load(dplyr, stringr)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 1) 构造 temp.df7 id匹配前7位数</span></span><span leaf=""><br></span><span leaf="">temp.df7_keyed &lt;- temp.df7 %&gt;%</span><span leaf=""><br></span><span leaf="">  mutate(</span><span leaf=""><br></span><span leaf="">    id_chr = as.character(id),</span><span leaf=""><br></span><span leaf="">    comm7  = str_sub(id_chr, 1, 7)   </span><span><span leaf=""># 取前7位</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span><span leaf=""># 2) 统一 psu_geo_all 的键类型</span></span><span leaf=""><br></span><span leaf="">psu_geo_all_keyed &lt;- psu_geo_all %&gt;%</span><span leaf=""><br></span><span leaf="">  mutate(communityid = as.character(communityid))</span><span leaf=""><br></span><span><span leaf=""># 3) 如 communityid 有重复，先去重（保留第一次；可改为其它规则）</span></span><span leaf=""><br></span><span leaf="">dup_check &lt;- psu_geo_all_keyed %&gt;%</span><span leaf=""><br></span><span leaf="">  count(communityid, name = </span><span><span leaf="">"n"</span></span><span leaf="">) %&gt;%</span><span leaf=""><br></span><span leaf="">  filter(n &gt; 1)</span><span leaf=""><br></span><span leaf="">psu_geo_all_dedup &lt;- psu_geo_all_keyed %&gt;%</span><span leaf=""><br></span><span leaf="">  distinct(communityid, .keep_all = TRUE)</span><span leaf=""><br></span><span><span leaf=""># 4) 左连接：把 psu_geo_all 的全部列并到 temp.df7</span></span><span leaf=""><br></span><span leaf="">temp.df8 &lt;- temp.df7_keyed %&gt;%</span><span leaf=""><br></span><span leaf="">  left_join(psu_geo_all_dedup, by = c(</span><span><span leaf="">"comm7"</span></span><span leaf=""> = </span><span><span leaf="">"communityid"</span></span><span leaf="">)) %&gt;%</span><span leaf=""><br></span><span leaf="">  dplyr::select(-id_chr, -comm7)   </span><span><span leaf=""># 清理临时列</span></span><span leaf=""><br></span><span><span leaf=""># # 可选：看看匹配率</span></span><span leaf=""><br></span><span><span leaf=""># match_rate &lt;- mean(!is.na(temp.df8$province_eng))  # 用其中一列做判断</span></span><span leaf=""><br></span><span><span leaf=""># message(sprintf("匹配率：%.1f%%", 100 * match_rate))</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#-----------7. 🍓 paper数据 -----</span></span><span leaf=""><br></span><span><span leaf="">##-----7.1 x covs-------</span></span><span leaf=""><br></span><span leaf="">names(temp.df8) </span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-8sb9z9" data-topic="1">#新增东中西地区region</a>，省份划分</span></span><span leaf=""><br></span><span leaf="">temp.df8 &lt;- temp.df8 %&gt;%</span><span leaf=""><br></span><span leaf="">  mutate(region = case_when(</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 东部</span></span><span leaf=""><br></span><span leaf="">    province_eng %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">"Beijing"</span></span><span leaf="">,</span><span><span leaf="">"Tianjin"</span></span><span leaf="">,</span><span><span leaf="">"Hebei"</span></span><span leaf="">,</span><span><span leaf="">"Shanghai"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                        </span><span><span leaf="">"Jiangsu"</span></span><span leaf="">,</span><span><span leaf="">"Zhejiang"</span></span><span leaf="">,</span><span><span leaf="">"Fujian"</span></span><span leaf="">,</span><span><span leaf="">"Shandong"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                        </span><span><span leaf="">"Guangdong"</span></span><span leaf="">,</span><span><span leaf="">"Hainan"</span></span><span leaf="">) ~ </span><span><span leaf="">"East"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 中部</span></span><span leaf=""><br></span><span leaf="">    province_eng %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">"Shanxi"</span></span><span leaf="">,</span><span><span leaf="">"Anhui"</span></span><span leaf="">,</span><span><span leaf="">"Jiangxi"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                        </span><span><span leaf="">"Henan"</span></span><span leaf="">,</span><span><span leaf="">"Hubei"</span></span><span leaf="">,</span><span><span leaf="">"Hunan"</span></span><span leaf="">) ~ </span><span><span leaf="">"Midland"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 西部</span></span><span leaf=""><br></span><span leaf="">    province_eng %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">"Inner Mongolia"</span></span><span leaf="">,</span><span><span leaf="">"Guangxi"</span></span><span leaf="">,</span><span><span leaf="">"Chongqing"</span></span><span leaf="">,</span><span><span leaf="">"Sichuan"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                        </span><span><span leaf="">"Guizhou"</span></span><span leaf="">,</span><span><span leaf="">"Yunnan"</span></span><span leaf="">,</span><span><span leaf="">"Tibet"</span></span><span leaf="">,</span><span><span leaf="">"Shaanxi"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                        </span><span><span leaf="">"Gansu"</span></span><span leaf="">,</span><span><span leaf="">"Qinghai"</span></span><span leaf="">,</span><span><span leaf="">"Ningxia"</span></span><span leaf="">,</span><span><span leaf="">"Xinjiang"</span></span><span leaf="">) ~ </span><span><span leaf="">"West"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 东北（根据你需要决定并到哪一类）</span></span><span leaf=""><br></span><span leaf="">    province_eng %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">"Liaoning"</span></span><span leaf="">,</span><span><span leaf="">"Jilin"</span></span><span leaf="">,</span><span><span leaf="">"Heilongjiang"</span></span><span leaf="">) ~ </span><span><span leaf="">"Midland"</span></span><span leaf="">, </span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""><a topic-id="mgi7mk0k-qosfjt" data-topic="1">#province</a>_eng %in% c("Liaoning","Jilin","Heilongjiang") ~ "Northeast"</span></span><span leaf=""><br></span><span leaf="">    TRUE ~ NA_character_</span><span leaf=""><br></span><span leaf="">  ))</span><span leaf=""><br></span><span leaf="">paper.1 &lt;-  temp.df8 %&gt;%</span><span leaf=""><br></span><span leaf="">  dplyr::select(</span><span leaf=""><br></span><span leaf="">    id,</span><span leaf=""><br></span><span leaf="">    age,</span><span leaf=""><br></span><span leaf="">    gender,</span><span leaf=""><br></span><span leaf="">    residence = residence_tag,</span><span leaf=""><br></span><span leaf="">    education = edu_1_tag,   </span><span><span leaf=""># 或改成 edu_2_tag</span></span><span leaf=""><br></span><span leaf="">    marital = marry_1_tag,   </span><span><span leaf=""># 或组合 marry_1/2/3</span></span><span leaf=""><br></span><span leaf="">    household_exp = income_household,</span><span leaf=""><br></span><span leaf="">    smoking = smoke_1_tag,   </span><span><span leaf=""># 或结合 smoke_2_tag</span></span><span leaf=""><br></span><span leaf="">    drinking = drink_1_tag,  </span><span><span leaf=""># 或结合 drink_2/3</span></span><span leaf=""><br></span><span leaf="">    physical_activity = physical_activity_tag,</span><span leaf=""><br></span><span leaf="">   </span><span><span leaf="">## cooking_fuel = Cooking_fuel_type, # 待确认 </span></span><span leaf=""><br></span><span leaf="">    region,</span><span leaf=""><br></span><span leaf="">    waist,</span><span leaf=""><br></span><span leaf="">    tg = bl_tg,</span><span leaf=""><br></span><span leaf="">    hdl = bl_hdl,</span><span leaf=""><br></span><span leaf="">    fbg = bl_glu,</span><span leaf=""><br></span><span leaf="">    sbp,</span><span leaf=""><br></span><span leaf="">    dbp,</span><span leaf=""><br></span><span leaf="">    crp = bl_crp, </span><span><span leaf=""><a topic-id="mgi7mk0k-ofdtnm" data-topic="1">#核心x变量</a></span></span><span leaf=""><br></span><span leaf="">    anti_htn = itvtn_hypertension_drug_tag,</span><span leaf=""><br></span><span leaf="">    anti_dm = itvtn_insulin_or_diabetes_drug_tag </span><span leaf=""><br></span><span leaf="">   </span><span><span leaf="">## mets  <a topic-id="mgi7mk0k-dwr824" data-topic="1">#你的Y变量</a> </span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-1cowj2" data-topic="1">#引入固态燃烧</a></span></span><span leaf=""><br></span><span leaf="">fuel &lt;- charls_v2020[[</span><span><span leaf="">"charls_derived"</span></span><span leaf="">]][[</span><span><span leaf="">"financial_housing"</span></span><span leaf="">]]</span><span leaf=""><br></span><span><span leaf=""># 1) 取 fuel 中 wave==2015，留下 id 和 cooking_fuel_type，并对 id 去重</span></span><span leaf=""><br></span><span leaf="">fuel_2015 &lt;- fuel %&gt;%</span><span leaf=""><br></span><span leaf="">  filter(wave == 2015) %&gt;%</span><span leaf=""><br></span><span leaf="">  select(id, cooking_fuel_type) %&gt;%</span><span leaf=""><br></span><span leaf="">  distinct(id, .keep_all = TRUE)</span><span leaf=""><br></span><span><span leaf=""># 2) 与 paper 按 id 左连接，只新增 cooking_fuel_type</span></span><span leaf=""><br></span><span leaf="">paper.2 &lt;- paper.1 %&gt;%</span><span leaf=""><br></span><span leaf="">  left_join(fuel_2015, by = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">##-----7.2 y→ mets------</span></span><span leaf=""><br></span><span leaf="">library(dplyr)</span><span leaf=""><br></span><span leaf="">library(stringr)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">df &lt;- temp.df8 %&gt;%</span><span leaf=""><br></span><span leaf="">  mutate(</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 0) 自动判断单位（粗略但实用）</span></span><span leaf=""><br></span><span leaf="">    tg_unit  = ifelse(median(bl_tg,  na.rm=TRUE)  &gt; 10, </span><span><span leaf="">"mgdl"</span></span><span leaf="">, </span><span><span leaf="">"mmol"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">    hdl_unit = ifelse(median(bl_hdl, na.rm=TRUE)  &gt; 10, </span><span><span leaf="">"mgdl"</span></span><span leaf="">, </span><span><span leaf="">"mmol"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">    glu_unit = ifelse(median(bl_glu, na.rm=TRUE)  &gt; 20, </span><span><span leaf="">"mgdl"</span></span><span leaf="">, </span><span><span leaf="">"mmol"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">    tg_thr   = ifelse(tg_unit  == </span><span><span leaf="">"mgdl"</span></span><span leaf="">, 150, 1.7),</span><span leaf=""><br></span><span leaf="">    hdl_m_thr= ifelse(hdl_unit == </span><span><span leaf="">"mgdl"</span></span><span leaf="">,  40, 1.04),</span><span leaf=""><br></span><span leaf="">    hdl_f_thr= ifelse(hdl_unit == </span><span><span leaf="">"mgdl"</span></span><span leaf="">,  50, 1.29),</span><span leaf=""><br></span><span leaf="">    glu_thr  = ifelse(glu_unit == </span><span><span leaf="">"mgdl"</span></span><span leaf="">, 100, 5.6),</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 1) 性别到 1/2</span></span><span leaf=""><br></span><span leaf="">    gender_num = case_when(</span><span leaf=""><br></span><span leaf="">      is.numeric(gender) ~ as.numeric(gender),</span><span leaf=""><br></span><span leaf="">      is.character(gender) &amp; str_to_lower(gender) %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">"male"</span></span><span leaf="">,</span><span><span leaf="">"m"</span></span><span leaf="">,</span><span><span leaf="">"男"</span></span><span leaf="">) ~ 1,</span><span leaf=""><br></span><span leaf="">      is.character(gender) &amp; str_to_lower(gender) %</span><span><span leaf="">in</span></span><span leaf="">% c(</span><span><span leaf="">"female"</span></span><span leaf="">,</span><span><span leaf="">"f"</span></span><span leaf="">,</span><span><span leaf="">"女"</span></span><span leaf="">) ~ 2,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_real_</span><span leaf=""><br></span><span leaf="">    ),</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 2) 五个成分</span></span><span leaf=""><br></span><span leaf="">    high_wc = case_when(</span><span leaf=""><br></span><span leaf="">      !is.na(gender_num) &amp; !is.na(waist) &amp;</span><span leaf=""><br></span><span leaf="">        ((gender_num==1 &amp; waist&gt;=85) | (gender_num==2 &amp; waist&gt;=80)) ~ 1L,</span><span leaf=""><br></span><span leaf="">      !is.na(gender_num) &amp; !is.na(waist) ~ 0L,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_integer_</span><span leaf=""><br></span><span leaf="">    ),</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 药物字段更稳健：允许 1/0 或 "Yes/No"</span></span><span leaf=""><br></span><span leaf="">    anti_htn_flag = case_when(</span><span leaf=""><br></span><span leaf="">      is.na(itvtn_hypertension_drug_tag) ~ NA,</span><span leaf=""><br></span><span leaf="">      itvtn_hypertension_drug_tag %</span><span><span leaf="">in</span></span><span leaf="">% c(1,</span><span><span leaf="">"1"</span></span><span leaf="">,</span><span><span leaf="">"Yes"</span></span><span leaf="">,</span><span><span leaf="">"yes"</span></span><span leaf="">,</span><span><span leaf="">"Y"</span></span><span leaf="">,</span><span><span leaf="">"y"</span></span><span leaf="">,</span><span><span leaf="">"是"</span></span><span leaf="">,</span><span><span leaf="">"有"</span></span><span leaf="">) ~ 1L,</span><span leaf=""><br></span><span leaf="">      itvtn_hypertension_drug_tag %</span><span><span leaf="">in</span></span><span leaf="">% c(0,</span><span><span leaf="">"0"</span></span><span leaf="">,</span><span><span leaf="">"No"</span></span><span leaf="">,</span><span><span leaf="">"no"</span></span><span leaf="">,</span><span><span leaf="">"N"</span></span><span leaf="">,</span><span><span leaf="">"n"</span></span><span leaf="">,</span><span><span leaf="">"否"</span></span><span leaf="">,</span><span><span leaf="">"无"</span></span><span leaf="">) ~ 0L,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_integer_</span><span leaf=""><br></span><span leaf="">    ),</span><span leaf=""><br></span><span leaf="">    anti_dm_flag = case_when(</span><span leaf=""><br></span><span leaf="">      is.na(itvtn_insulin_or_diabetes_drug_tag) ~ NA,</span><span leaf=""><br></span><span leaf="">      itvtn_insulin_or_diabetes_drug_tag %</span><span><span leaf="">in</span></span><span leaf="">% c(1,</span><span><span leaf="">"1"</span></span><span leaf="">,</span><span><span leaf="">"Yes"</span></span><span leaf="">,</span><span><span leaf="">"yes"</span></span><span leaf="">,</span><span><span leaf="">"Y"</span></span><span leaf="">,</span><span><span leaf="">"y"</span></span><span leaf="">,</span><span><span leaf="">"是"</span></span><span leaf="">,</span><span><span leaf="">"有"</span></span><span leaf="">) ~ 1L,</span><span leaf=""><br></span><span leaf="">      itvtn_insulin_or_diabetes_drug_tag %</span><span><span leaf="">in</span></span><span leaf="">% c(0,</span><span><span leaf="">"0"</span></span><span leaf="">,</span><span><span leaf="">"No"</span></span><span leaf="">,</span><span><span leaf="">"no"</span></span><span leaf="">,</span><span><span leaf="">"N"</span></span><span leaf="">,</span><span><span leaf="">"n"</span></span><span leaf="">,</span><span><span leaf="">"否"</span></span><span leaf="">,</span><span><span leaf="">"无"</span></span><span leaf="">) ~ 0L,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_integer_</span><span leaf=""><br></span><span leaf="">    ),</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">    high_bp = case_when(</span><span leaf=""><br></span><span leaf="">      (!is.na(sbp) &amp; sbp&gt;=130) | (!is.na(dbp) &amp; dbp&gt;=85) | anti_htn_flag==1L ~ 1L,</span><span leaf=""><br></span><span leaf="">      (!is.na(sbp) | !is.na(dbp) | !is.na(anti_htn_flag)) ~ 0L,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_integer_</span><span leaf=""><br></span><span leaf="">    ),</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">    low_hdl = case_when(</span><span leaf=""><br></span><span leaf="">      !is.na(gender_num) &amp; !is.na(bl_hdl) &amp;</span><span leaf=""><br></span><span leaf="">        ((gender_num==1 &amp; bl_hdl &lt; hdl_m_thr) | (gender_num==2 &amp; bl_hdl &lt; hdl_f_thr)) ~ 1L,</span><span leaf=""><br></span><span leaf="">      !is.na(gender_num) &amp; !is.na(bl_hdl) ~ 0L,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_integer_</span><span leaf=""><br></span><span leaf="">    ),</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">    high_tg = case_when(</span><span leaf=""><br></span><span leaf="">      !is.na(bl_tg) &amp; bl_tg &gt;= tg_thr ~ 1L,</span><span leaf=""><br></span><span leaf="">      !is.na(bl_tg) ~ 0L,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_integer_</span><span leaf=""><br></span><span leaf="">    ),</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">    high_glu = case_when(</span><span leaf=""><br></span><span leaf="">      (!is.na(bl_glu) &amp; bl_glu &gt;= glu_thr) | anti_dm_flag==1L ~ 1L,</span><span leaf=""><br></span><span leaf="">      (!is.na(bl_glu) | !is.na(anti_dm_flag)) ~ 0L,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_integer_</span><span leaf=""><br></span><span leaf="">    )</span><span leaf=""><br></span><span leaf="">  ) %&gt;%</span><span leaf=""><br></span><span leaf="">  mutate(</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 缺失不计分（若要“有缺失则NA”，用你注释里那段替换）</span></span><span leaf=""><br></span><span leaf="">    MetS_risk_num = rowSums(across(c(high_wc,high_bp,low_hdl,high_tg,high_glu)), na.rm = TRUE),</span><span leaf=""><br></span><span leaf="">    mets = case_when(</span><span leaf=""><br></span><span leaf="">      !is.na(MetS_risk_num) &amp; MetS_risk_num &gt;= 3 ~ 1L,</span><span leaf=""><br></span><span leaf="">      !is.na(MetS_risk_num) ~ 0L,</span><span leaf=""><br></span><span leaf="">      TRUE ~ NA_integer_</span><span leaf=""><br></span><span leaf="">    )</span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 各成分阳性率</span></span><span leaf=""><br></span><span leaf="">sapply(df[,c(</span><span><span leaf="">"high_wc"</span></span><span leaf="">,</span><span><span leaf="">"high_bp"</span></span><span leaf="">,</span><span><span leaf="">"low_hdl"</span></span><span leaf="">,</span><span><span leaf="">"high_tg"</span></span><span leaf="">,</span><span><span leaf="">"high_glu"</span></span><span leaf="">)], </span><span><span leaf="">function</span></span><span leaf="">(x) mean(x==1, na.rm=TRUE))</span><span leaf=""><br></span><span><span leaf=""># 总体 MetS 率</span></span><span leaf=""><br></span><span leaf="">mean(df</span><span><span leaf="">$mets</span></span><span leaf="">==1, na.rm=TRUE)</span><span leaf=""><br></span><span><span leaf=""># 组成数分布</span></span><span leaf=""><br></span><span leaf="">table(df</span><span><span leaf="">$MetS_risk_num</span></span><span leaf="">, useNA=</span><span><span leaf="">"ifany"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#----🌟 最终论文数据-----</span></span><span leaf=""><br></span><span leaf="">paper &lt;- paper.2 %&gt;%</span><span leaf=""><br></span><span leaf="">  left_join(df %&gt;% select(id, mets), by = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#----🌟 最终论文数据-----</span></span><span leaf=""><br></span><span leaf="">paper &lt;- paper.2 %&gt;%</span><span leaf=""><br></span><span leaf="">  left_join(df %&gt;% select(id, mets), by = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">3.4 统计R代码 </span></p><p data-tool="mdnice编辑器"><span leaf="">最终分析数据与过程如下。</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJvaicDZDxeNgJRT6ybUmoM0t7DnQJ17Wl9eMEJ3IXb5Ip5U6sLkQePSQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5601851851851852" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477172" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJvaicDZDxeNgJRT6ybUmoM0t7DnQJ17Wl9eMEJ3IXb5Ip5U6sLkQePSQ/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJBVNGiaIOoCNvrIXibJK2q4Fph3n7KcrvjWQwywCGnJNrn6KYNmR3YDIw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.549074074074074" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477175" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJBVNGiaIOoCNvrIXibJK2q4Fph3n7KcrvjWQwywCGnJNrn6KYNmR3YDIw/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJY3Diba69Z4kuaYVaz67kNR4ia41JEicAgZZ2vWpmNUKGubWKwdedjich7w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4666666666666667" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477174" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJY3Diba69Z4kuaYVaz67kNR4ia41JEicAgZZ2vWpmNUKGubWKwdedjich7w/640?wx_fmt=png&amp;from=appmsg"></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJjyUYxGk1icw2ynXk06WBLBY1Io7lCV36W3naFcURP4Ekc5behDLKkOQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.41203703703703703" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503477173" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJjyUYxGk1icw2ynXk06WBLBY1Io7lCV36W3naFcURP4Ekc5behDLKkOQ/640?wx_fmt=png&amp;from=appmsg"></section><p data-tool="mdnice编辑器"><span leaf="">OK，完美复刻且更优美，你可以用代码替换任意结局变量。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#-----------8. 🍓 智荟 table1 -----</span></span><span leaf=""><br></span><span leaf="">str(paper)</span><span leaf=""><br></span><span leaf="">convars &lt;- c(</span><span><span leaf="">"age"</span></span><span leaf="">, </span><span><span leaf="">"waist"</span></span><span leaf="">, </span><span><span leaf="">"sbp"</span></span><span leaf="">, </span><span><span leaf="">"dbp"</span></span><span leaf="">, </span><span><span leaf="">"tg"</span></span><span leaf="">, </span><span><span leaf="">"hdl"</span></span><span leaf="">, </span><span><span leaf="">"fbg"</span></span><span leaf="">, </span><span><span leaf="">"crp"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#--physical_activity &gt;40% 删除此变量</span></span><span leaf=""><br></span><span leaf="">catvars &lt;- c(</span><span><span leaf="">"gender"</span></span><span leaf="">, </span><span><span leaf="">"residence"</span></span><span leaf="">, </span><span><span leaf="">"education"</span></span><span leaf="">, </span><span><span leaf="">"marital"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">             </span><span><span leaf="">"smoking"</span></span><span leaf="">, </span><span><span leaf="">"drinking"</span></span><span leaf="">,  </span><span><span leaf="">##"physical_activity"移出</span></span><span leaf=""><br></span><span leaf="">             </span><span><span leaf="">"region"</span></span><span leaf="">, </span><span><span leaf="">"anti_htn"</span></span><span leaf="">, </span><span><span leaf="">"anti_dm"</span></span><span leaf="">, </span><span><span leaf="">"cooking_fuel_type"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">paper[convars] &lt;- lapply(paper[convars], as.numeric)</span><span leaf=""><br></span><span leaf="">paper[catvars] &lt;- lapply(paper[catvars], factor)</span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-h5ay58" data-topic="1">#分组yvar</a></span></span><span leaf=""><br></span><span leaf="">yvar = </span><span><span leaf="">"mets"</span></span><span leaf=""><br></span><span><span leaf="">#<a topic-id="mgi7mk0k-66qj1v" data-topic="1">#time</a>="ftime"</span></span><span leaf=""><br></span><span><span leaf="">#<a topic-id="mgi7mk0k-0wovg8" data-topic="1">#xvar</a>="sleeptime"</span></span><span leaf=""><br></span><span><span leaf=""># 确保 time 变量不包含在 convars 中!</span></span><span leaf=""><br></span><span><span leaf="">#<a topic-id="mgi7mk0k-wfmy4l" data-topic="1">#convars</a> &lt;- setdiff(convars, "time")</span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-1fy2ij" data-topic="1">#除了y</a> 和 time变量= vars,x在var里面！</span></span><span leaf=""><br></span><span><span leaf="">#<a topic-id="mgi7mk0k-an4wz0" data-topic="1">#vars</a> &lt;- c(catvars,convars)</span></span><span leaf=""><br></span><span><span leaf=""># covs是排除主要因素 xvar</span></span><span leaf=""><br></span><span><span leaf="">#<a topic-id="mgi7mk0k-x696lx" data-topic="1">#covs</a> &lt;- setdiff(vars, xvar)</span></span><span leaf=""><br></span><span><span leaf=""># 查看缺失比例 </span></span><span leaf=""><br></span><span leaf="">colMeans(is.na(paper[, c(convars, catvars, yvar)]))</span><span leaf=""><br></span><span leaf="">library(VIM)</span><span leaf=""><br></span><span leaf="">aggr(paper[, c(convars, catvars, yvar)], numbers = TRUE, prop = TRUE)</span><span leaf=""><br></span><span leaf="">…</span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-md7k8x" data-topic="1">#执行</a> 5 重插补 + 合并（连续取均值、因子取众数）</span></span><span leaf=""><br></span><span leaf="">MI_data &lt;- fix_na(factorCols = factorCols, data = missdata, n = 5)</span><span leaf=""><br></span><span leaf="">paper_MI &lt;- paper</span><span leaf=""><br></span><span leaf="">paper_MI[, vars_use] &lt;- MI_data[, vars_use]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 简单检查，缺失0</span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-zj0nom" data-topic="1">#sapply</a>(MI_data[, convars], function(x) mean(is.na(x)))  # 连续变量缺失应接近 0</span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-tzt54p" data-topic="1">#sapply</a>(MI_data[, factorCols], function(x) mean(is.na(x)))  # 因子缺失应接近 0</span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mgi7mk0k-fq8r5c" data-topic="1">#table</a>(paper_MI$mets, useNA = "ifany")</span></span><span leaf=""><br></span></code></pre><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">四、发散思维</span></span><span></span></h2><blockquote><span><span leaf="">“</span></span><p><span leaf="">1.<span textstyle="">任意队列或公共数据库</span>其实都可以结合chap进行PM系列探索，上游是万能的，下游结局任意y就可无限重复刷文章。</span></p></blockquote><blockquote><span><span leaf="">“</span></span><p><span leaf="">2.OR HR RR都可以，PM系列的选择也可以多样，可以传统aOR、aHR、也可广义倾向评分更前沿技术探索<span textstyle="">PM系列因果推断(B款特色，近期热门发文</span>)。</span></p></blockquote><p data-tool="mdnice编辑器"><span leaf="">3.复现charls，原文数据不一致，也是公共数据库矛盾之一。严谨溯源耐心缺一不可。 </span></p><p data-tool="mdnice编辑器"><span leaf="">4.案例过程成熟溯源，举一反三，实战公共数据库系列，且可复制推广超多idea复刻。B款课程提供公共数据库详细介绍与前沿方法，让你脑洞大开。</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">五、小结</span></span><span></span></h2><blockquote><span><span leaf="">“</span></span><p><span leaf="">Charls等等公共库+PM2.5，环境交叉发高分神器，跟着代码一路next狂奔吧。</span></p></blockquote><p data-tool="mdnice编辑器"><span data-mpa-action-id="mgi7oijg14b9" data-pm-slice="0 0 []"><span leaf=""><span textstyle="">福利</span>，本文文献与chap部分代码获取方法，发送公众号聊天：</span><span mpa-font-style="mgi7oiiyhjo"><span leaf="">1009</span></span></span></p></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJMh0rT0QhImQWXoQnvEI4RH0bbdpeawWDViadKQia9GUZMibSKS2SbaVGg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9981481481481481" data-s="300,640" data-type="png" data-w="540" type="block" data-imgfileid="503477145" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKHPCFouTTxfPxlhueCMcCDJMh0rT0QhImQWXoQnvEI4RH0bbdpeawWDViadKQia9GUZMibSKS2SbaVGg/640?wx_fmt=png&amp;from=appmsg"></section><p><span leaf=""><br></span></p><p><span leaf=""> </span></p><p><span leaf=""><span textstyle="">最后为10月底的B款打个call，超级精彩约起来吧！</span></span></p><p><span leaf=""><br></span></p><section><span leaf=""><br></span></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKGGZuqdTrgZNRx8rjQ4XshS5B4QfP3zvfsiaUMo17zq8SY1uJSgCNcrbbxcdJicNT1rVibamcjnuI46g/640?wx_fmt=png&amp;from=appmsg&amp;watermark=1#imgIndex=4" data-ratio="0.41759259259259257" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="503476987" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Zb9jB9p1cKGGZuqdTrgZNRx8rjQ4XshS5B4QfP3zvfsiaUMo17zq8SY1uJSgCNcrbbxcdJicNT1rVibamcjnuI46g/640?wx_fmt=png&amp;from=appmsg&amp;watermark=1#imgIndex=4"></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p><h2 data-tool="mdnice编辑器"><span><span leaf="">AB统计，C写作</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">A款统计九阳神功，<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxNTUzNDMyNQ==&amp;mid=2650957787&amp;idx=1&amp;sn=b8ac4502e4f58f9b3fc422424fb7b605&amp;scene=21#wechat_redirect" textvalue="《实战医学统计精品课程》A款-1折！精美课件一键R包深度统计预测模型公共数据库解析复现" data-itemshowtype="0" linktype="text" data-linktype="2"><span textstyle="">《实战医学统计精品课程》A款-1折！精美课件一键R包深度统计预测模型公共数据库解析复现</span></a><span textstyle="">。</span></span></p><p data-tool="mdnice编辑器"><span leaf=""> C款写作易筋经，<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxNTUzNDMyNQ==&amp;mid=2650958439&amp;idx=1&amp;sn=116de541b21f4d6652f746f2b3f89c34&amp;scene=21#wechat_redirect" textvalue="从0到顶刊sci精品写作课程-全网首发" data-itemshowtype="0" linktype="text" data-linktype="2"><span textstyle="">从0到顶刊sci精品写作课程-全网首发</span></a><span textstyle="">。 </span></span></p><p data-tool="mdnice编辑器"><span leaf="">B款统计独孤九剑，<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxNTUzNDMyNQ==&amp;mid=2650960664&amp;idx=1&amp;sn=0451853a669fbacdc679409e13b752c2&amp;scene=21#wechat_redirect" textvalue="" linktype="text" data-linktype="2"><span textstyle="">爆款！AI+RCT+真实世界+因果机器学习+交叉学科+纵向数据，150小时</span></a> </span></p><p><span leaf=""><br></span></p><p><span leaf=""><br></span></p><p><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/Zb9jB9p1cKG8hm4AQmFw4MEhbUWroVODSM6oRdH8y44mp2Tz05ZuoGlU9V6LJ4GCclbRw49C3e6Xu6lAXBTUuw/640?wx_fmt=jpeg&amp;watermark=1#imgIndex=22" data-ratio="0.29444444444444445" data-s="300,640" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/Zb9jB9p1cKG8hm4AQmFw4MEhbUWroVODSM6oRdH8y44mp2Tz05ZuoGlU9V6LJ4GCclbRw49C3e6Xu6lAXBTUuw/640?wx_fmt=jpeg&amp;watermark=1#imgIndex=22"></span></p><p><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_gif/Zb9jB9p1cKGAAa124Ik6SAg6kXjw7NOVXKrDp4PMw7UW54MUVRCnNFCE5M7ibSlwHjEicOt4jSoicySYeLt8rPcKg/640?wx_fmt=gif#imgIndex=23" data-ratio="0.2777777777777778" data-type="gif" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_gif/Zb9jB9p1cKGAAa124Ik6SAg6kXjw7NOVXKrDp4PMw7UW54MUVRCnNFCE5M7ibSlwHjEicOt4jSoicySYeLt8rPcKg/640?wx_fmt=gif#imgIndex=23"></span></p><p><span leaf=""><br></span></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/NcxQhDFVo6Ge1Mia2OwQGQ",target="_blank" rel="noopener noreferrer">原文链接</a>
