---
title: "【Tidyverse优雅编程】批量读取+合并+清洗：国家统计局数据"
date: 2025-08-05T08:15:55Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
【Tidyverse优雅编程】批量读取+合并+清洗：国家统计局数据 by R语言与数学建模
------
<div><p data-pm-slice="0 0 []"><span data-offset-key="79afs-0-0"><span data-text="true"><span leaf="">我经常需要去 </span></span></span><span data-offset-key="79afs-1-0"><span data-text="true"><span leaf="">国家统计局网站（</span><span leaf="">https://www.stats.gov.cn</span></span></span><span data-offset-key="79afs-4-0"><span data-text="true"><span leaf="">），下载一些数据整理成示例数据，每次都重新写代码，很是麻烦。这次干脆写个函数 </span></span></span><span data-offset-key="79afs-4-1"><span data-text="true"><span leaf="">read_nbs()</span></span></span><span data-offset-key="79afs-4-2"><span data-text="true"><span leaf="">，放到我的 </span></span></span><span data-offset-key="79afs-4-3"><span data-text="true"><span leaf="">mathmodels</span></span></span><span data-offset-key="79afs-4-4"><span data-text="true"><span leaf=""> 包里，加载包就能直接使用，也分享给大家。</span></span></span></p><h2 data-block="true" data-editor="4t197" data-offset-key="9ebg2-0-0"></h2><p><span data-offset-key="9ebg2-0-0"><span data-text="true"><span leaf="">1 批量读取数据</span></span></span></p><p><span data-offset-key="shv5-0-0"><span data-text="true"><span leaf="">这次我是想下载近 10 年分省 GDP、第一/二/三产业数据，作为计算</span></span></span><span data-offset-key="shv5-0-1"><span data-text="true"><span leaf="">区位商</span></span></span><span data-offset-key="shv5-0-2"><span data-text="true"><span leaf="">的演示数据。</span></span></span></p><p><span data-offset-key="4rm7v-0-0"><span data-text="true"><span leaf="">登录国家统计局网站</span></span></span><span data-offset-key="4rm7v-2-0"><span data-text="true"><span leaf="">，找到数据，下载到本地（懒得改名），放到</span></span></span><span data-offset-key="4rm7v-2-1"><span data-text="true"><span leaf="">NBS</span></span></span><span data-offset-key="4rm7v-2-2"><span data-text="true"><span leaf=""> 文件夹： </span></span></span></p><p><span data-offset-key="4rm7v-2-2"><span data-text="true"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGofWKVRaiajfSUmIm4Ra7E6AEDj8hdVgldibalDdEUj5Zar3uZDySFbXkQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.16258570029382957" data-type="png" data-w="1021" data-imgfileid="100003644" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGofWKVRaiajfSUmIm4Ra7E6AEDj8hdVgldibalDdEUj5Zar3uZDySFbXkQ/640?wx_fmt=png&amp;from=appmsg"></span></span></span></p><p><span data-offset-key="4rm7v-2-2"><span data-text="true"><span leaf="">随便打开一个，是这个样子的：</span></span></span></p><p><span data-offset-key="4rm7v-2-2"><span data-text="true"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGoncwtLR1eLRk55tXCq87PIEiaXUqiaHZfRPoBrU7efaBgoKcQskuloSBg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7333333333333333" data-type="png" data-w="1440" data-imgfileid="100003647" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGoncwtLR1eLRk55tXCq87PIEiaXUqiaHZfRPoBrU7efaBgoKcQskuloSBg/640?wx_fmt=png&amp;from=appmsg"></span></span></span></p><p><span data-offset-key="4rm7v-2-2"><span data-text="true"><span leaf="">可见，核心数据是从第 4 行开始，到倒数第 2 行。这是不整洁的宽表，各年份列的内容都是同一个指标的值，这个指标在第 2 行 </span></span></span><span data-offset-key="5rvpb-0-1"><span data-text="true"><span leaf="">A2</span></span></span><span data-offset-key="5rvpb-0-2"><span data-text="true"><span leaf=""> 单元格有显示：</span></span></span><span data-offset-key="5rvpb-0-3"><span data-text="true"><span leaf="">指标：地区生产总值(亿元)</span></span></span><span data-offset-key="5rvpb-0-4"><span data-text="true"><span leaf="">。</span></span></span></p><p><span data-offset-key="1bmi2-0-0"><span data-text="true"><span leaf="">所以，这也算是</span></span></span><span data-offset-key="1bmi2-0-1"><span data-text="true"><span leaf="">批量读取稍微复杂 Excel 表格数据</span></span></span><span data-offset-key="1bmi2-0-2"><span data-text="true"><span leaf="">。</span></span></span></p><p><span data-offset-key="1srqq-0-0"><span data-text="true"><span leaf="">我不想手动修改文件名之类的，全部靠自动读取+整合完成，另外，省份名字很啰嗦想变成简写。</span></span></span></p><p><span data-offset-key="3tfc4-0-0"><span data-text="true"><span leaf="">梳理一下要做的事情：</span></span></span></p><ul><li><p><span data-offset-key="5314o-0-0"><span data-text="true"><span leaf="">批量读取多个文件，先搞定读取一个文件</span></span></span></p></li></ul><ul><li><p><span data-offset-key="f2frn-0-0"><span data-text="true"><span leaf="">对一个文件，需要做两次读取：核心数据，指标名称</span></span></span></p></li></ul><ul><li><p><span data-offset-key="dbctk-0-0"><span data-text="true"><span leaf="">读取的核心数据是一个数据框，命名为指标名称</span></span></span></p></li></ul><ul><li><p><span data-offset-key="au0ap-0-0"><span data-text="true"><span leaf="">批量合并，名字将自动成为分组变量</span></span></span></p></li></ul><ul><li><p><span data-offset-key="anoer-0-0"><span data-text="true"><span leaf="">简化省份名字</span></span></span></p></li></ul><p><span data-offset-key="anoer-0-0"><span data-text="true"><span leaf=""><br></span></span></span></p><p><span data-offset-key="ecqu3-0-0"><span data-text="true"><span leaf="">下面直接上代码：</span></span></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">read_nbs = function(paths) {</span><span leaf=""><br></span><span leaf="">  vars = map_chr(paths, \(path) {</span><span leaf=""><br></span><span leaf="">    readxl::read_excel(path, range = "A1:A2") |&gt; </span><span leaf=""><br></span><span leaf="">      pull(1) |&gt; </span><span leaf=""><br></span><span leaf="">      str_remove("指标：")</span><span leaf=""><br></span><span leaf="">  })</span><span leaf=""><br></span><span leaf="">  map(paths, \(path) readxl::read_excel(path, skip = 3, n_max = 31)) |&gt; </span><span leaf=""><br></span><span leaf="">    set_names(vars) |&gt; </span><span leaf=""><br></span><span leaf="">    list_rbind(names_to = "指标") |&gt; </span><span leaf=""><br></span><span leaf="">    mutate(地区 = str_remove_all(地区, "市|省|自治区|.族|维吾尔"))</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span></code></pre></section><p><span data-offset-key="ecqu3-0-0"><span data-text="true"><span leaf=""><span textstyle="">代码解释：</span></span></span></span></p><p><span data-offset-key="1hrvt-0-0"><span data-text="true"><span leaf="">paths</span></span></span><span data-offset-key="1hrvt-0-1"><span data-text="true"><span leaf=""> 是能访问到 </span></span></span><span data-offset-key="1hrvt-0-2"><span data-text="true"><span leaf="">xls</span></span></span><span data-offset-key="1hrvt-0-3"><span data-text="true"><span leaf=""> 数据文件的若干路径。 </span></span></span></p><p><span data-offset-key="s3vv-0-0"><span data-text="true"><span leaf="">(1) 写了个小函数：从一个路径（</span></span></span><span data-offset-key="s3vv-0-1"><span data-text="true"><span leaf="">xls</span></span></span><span data-offset-key="s3vv-0-2"><span data-text="true"><span leaf=""> 文件）读取指标名称（一个文件，一个指标名称），取出来，删除多余的“指标：”。再把它批量地应用到每个路径上，得到全部指标名称构成的向量，赋值给 </span></span></span><span data-offset-key="s3vv-0-3"><span data-text="true"><span leaf="">vars</span></span></span><span data-offset-key="s3vv-0-4"><span data-text="true"></span></span></p><p><span data-offset-key="ajhm-0-0"><span data-text="true"><span leaf="">(2) 批量读取每个 </span></span></span><span data-offset-key="ajhm-0-1"><span data-text="true"><span leaf="">xls</span></span></span><span data-offset-key="ajhm-0-2"><span data-text="true"><span leaf=""> 文件的核心数据（设置跳过 3 行，共读取 31 行），批量命名为指标名称，按行合并这些数据框，指标名称存放到一列，起名“指标”</span></span></span></p><p><span data-offset-key="f85cb-0-0"><span data-text="true"><span leaf="">(3) 简化省份名，就是移除各种多余的字</span></span></span></p><p><span data-offset-key="cje6u-0-0"><span data-text="true"><span leaf="">测试一下该函数的效果：</span></span></span></p><ul><li><p><span data-offset-key="7mhem-0-0"><span data-text="true"><span leaf="">只需获取全部 </span></span></span><span data-offset-key="7mhem-0-1"><span data-text="true"><span leaf="">xls</span></span></span><span data-offset-key="7mhem-0-2"><span data-text="true"><span leaf=""> 文件路径，再交给 </span></span></span><span data-offset-key="7mhem-0-3"><span data-text="true"><span leaf="">read_nbs()</span></span></span><span data-offset-key="7mhem-0-4"><span data-text="true"><span leaf=""> 函数 </span></span></span></p></li></ul><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">library(tidyverse)  files = list.files("NBS", pattern = ".xls", full.names = TRUE)</span><span leaf=""><br></span><span leaf="">df = read_nbs(files)</span><span leaf=""><br></span><span leaf="">df</span><span leaf=""><br></span></code></pre></section><p><span data-offset-key="7mhem-0-4"><span data-text="true"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGos6GdSJ4iaKXia9IlsibTX8miaMgce7uSSQNEZXysRw1OqsWHlDVVWC15jA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.387905604719764" data-type="png" data-w="1356" data-imgfileid="100003646" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGos6GdSJ4iaKXia9IlsibTX8miaMgce7uSSQNEZXysRw1OqsWHlDVVWC15jA/640?wx_fmt=png&amp;from=appmsg"></span></span></span></p><section><span leaf="">可见，每个 xls 的核心数据，就是从第 2 列开始的，多了一个“指标”列，即指标名称，每 31 行对应一个指标名称。共 4 个 xls 文件，所以是 31×4 = 124 行。</span></section><p><span data-offset-key="1egks-0-0"><span data-text="true"><span leaf="">可以查看一下，咱们的 4 个指标名称：</span></span></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">df$指标 |&gt; unique()</span><span leaf=""><br></span></code></pre></section><p><span data-offset-key="1egks-0-0"><span data-text="true"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGoZUkxYrxsibTRLqKE7wcIGQc59cw1FzTxIBHAgfJI3mEG57cfTnwxCUQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.06660039761431412" data-type="png" data-w="1006" data-imgfileid="100003645" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGoZUkxYrxsibTRLqKE7wcIGQc59cw1FzTxIBHAgfJI3mEG57cfTnwxCUQ/640?wx_fmt=png&amp;from=appmsg"></span></span></span></p><section><span leaf="">以及简化后的省份名字：</span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">df$地区 |&gt; unique()</span><span leaf=""><br></span></code></pre></section><section><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGoXUZGtNOyrbXXq1V96m74a81OFwosNN169ErDxEGdiaE1MtEt3vXyrag/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.11864406779661017" data-type="png" data-w="1121" data-imgfileid="100003643" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGoXUZGtNOyrbXXq1V96m74a81OFwosNN169ErDxEGdiaE1MtEt3vXyrag/640?wx_fmt=png&amp;from=appmsg"></span></section><section><span leaf="">2 数据清洗</span></section><p><span data-offset-key="cgfji-0-0"><span data-text="true"><span leaf="">正常来说，</span></span></span><span data-offset-key="cgfji-0-1"><span data-text="true"><span leaf="">read_nbs()</span></span></span><span data-offset-key="cgfji-0-2"><span data-text="true"><span leaf=""> 应该只干批量读取 + 合并的活，简化省份名字应该放在数据清洗环节。但是呢，你让我每次现写这句代码：</span></span></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">mutate(地区 =str_remove_all(地区, "市|省|自治区|.族|维吾尔"))</span></code></pre></section><p><span data-offset-key="ekb5k-0-0"><span data-text="true"><span leaf="">我可记不住，干脆让 </span></span></span><span data-offset-key="ekb5k-0-1"><span data-text="true"><span leaf="">read_nbs()</span></span></span><span data-offset-key="ekb5k-0-2"><span data-text="true"><span leaf=""> 多做一件事，反正无论什么指标数据，也都能做这一步。 </span></span></span></p><p><span data-offset-key="8cd0m-0-0"><span data-text="true"><span leaf="">剩下的数据清洗，就是跟你下载的具体指标有关了，也都是常规的</span></span></span><span data-offset-key="8cd0m-0-1"><span data-text="true"><span leaf="">长宽转换、改列名/列序/行序</span></span></span><span data-offset-key="8cd0m-0-2"><span data-text="true"><span leaf="">，随手就能写出来：</span></span></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">df |&gt; </span><span leaf=""><br></span><span leaf="">  pivot_longer(ends_with("年"), names_to = "年份", values_to = "值",</span><span leaf=""><br></span><span leaf="">               names_transform = parse_number) |&gt; </span><span leaf=""><br></span><span leaf="">  pivot_wider(names_from = 指标, values_from = 值) |&gt; </span><span leaf=""><br></span><span leaf="">  rename_with(\(x) str_remove(x, "增加值\\(亿元\\)"), .cols = contains("产业")) |&gt; </span><span leaf=""><br></span><span leaf="">  rename(GDP = `地区生产总值(亿元)`) |&gt; </span><span leaf=""><br></span><span leaf="">  relocate(年份, .before = 1) |&gt; </span><span leaf=""><br></span><span leaf="">  arrange(年份, 地区)</span><span leaf=""><br></span></code></pre></section><section><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGojBaoF2RQNzpvmrPqjickSlBdeydmhISibNcpcs2KlxLX0xXU6jlIVXDw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6215189873417721" data-type="png" data-w="790" data-imgfileid="100003648" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWAdNQZ6VPeeYSvrXRicpKfGojBaoF2RQNzpvmrPqjickSlBdeydmhISibNcpcs2KlxLX0xXU6jlIVXDw/640?wx_fmt=png&amp;from=appmsg"></span></section><section><span leaf="">这样就得到了，列名简单的、行序好看的整洁数据，可以做各种后续处理和使用了。当然，也可以再接一句代码写出到 </span><span data-offset-key="9bsvs-0-1"><span data-text="true"><span leaf="">Excel</span></span></span><span data-offset-key="9bsvs-0-2"><span data-text="true"><span leaf="">：</span></span></span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">|&gt; writexl::write_xlsx("文件名.xlsx")</span><span leaf=""><br></span></code></pre></section><p><span data-offset-key="6deul-0-0"><span data-text="true"><span leaf="">代码解释：</span></span></span></p><p><span data-offset-key="doh2-0-0"><span data-text="true"><span leaf="">(1) </span></span></span><span data-offset-key="doh2-0-1"><span data-text="true"><span leaf="">长变宽：</span></span></span><span data-offset-key="doh2-0-2"><span data-text="true"><span leaf="">年份列名放一列“年份”，年份列的值放一列“值”，同时变换一下这些年份列名，去掉“年”字，变成数值</span></span></span></p><p><span data-offset-key="6up16-0-0"><span data-text="true"><span leaf="">(2) </span></span></span><span data-offset-key="6up16-0-1"><span data-text="true"><span leaf="">宽变长：</span></span></span><span data-offset-key="6up16-0-2"><span data-text="true"><span leaf="">“指标”列的那些指标名称，应该分别作为列名，值跟着指标名称去归位</span></span></span></p><p><span data-offset-key="8jmhh-0-0"><span data-text="true"><span leaf="">(3) </span></span></span><span data-offset-key="8jmhh-0-1"><span data-text="true"><span leaf="">重命名：</span></span></span><span data-offset-key="8jmhh-0-2"><span data-text="true"><span leaf="">三个产业的指标名称，把“增加值(亿元)”去掉，注意小括号需要转义，因为默认是当正则表达式使用；“地区生产总值(亿元)”重命名为 “GDP”</span></span></span></p><p><span data-offset-key="bubpa-0-0"><span data-text="true"><span leaf="">(4) </span></span></span><span data-offset-key="bubpa-0-1"><span data-text="true"><span leaf="">调整列序：</span></span></span><span data-offset-key="bubpa-0-2"><span data-text="true"><span leaf="">把“年份”放第 1 列</span></span></span></p><p><span data-offset-key="b5rl3-0-0"><span data-text="true"><span leaf="">(5) </span></span></span><span data-offset-key="b5rl3-0-1"><span data-text="true"><span leaf="">排序行：</span></span></span><span data-offset-key="b5rl3-0-2"><span data-text="true"><span leaf="">按第一关键字“年份”，第二关键字“地区”，排序</span></span></span></p><figure data-block="true" data-editor="4t197" data-offset-key="f9rnb-0-0"><hr></figure><p><span data-offset-key="c7phe-0-0"><span data-text="true"><span leaf="">欢迎订阅我的 </span></span></span><span data-offset-key="c7phe-0-1"><span data-text="true"><span leaf="">tidy-R语言</span></span></span><span data-offset-key="c7phe-0-2"><span data-text="true"><span leaf=""> 知识库，里面有我所有整理好的基于 </span></span></span><span data-offset-key="c7phe-0-3"><span data-text="true"><span leaf="">tidyverse</span></span></span><span data-offset-key="c7phe-0-4"><span data-text="true"><span leaf=""> 的全网最新的 </span></span></span><span data-offset-key="c7phe-0-5"><span data-text="true"><span leaf="">R</span></span></span><span data-offset-key="c7phe-0-6"><span data-text="true"><span leaf=""> 语言编程学习、案例资料，可以下载，可以 </span></span></span><span data-offset-key="c7phe-0-7"><span data-text="true"><span leaf="">DeepSeek</span></span></span><span data-offset-key="c7phe-0-8"><span data-text="true"><span leaf=""> 问答：</span></span></span></p><p><span data-offset-key="dmfn6-0-0"><span data-text="true"><span leaf="">ima知识库</span></span></span><span data-offset-key="dmfn6-1-0"><span data-text="true"><span leaf="">：<span textstyle="">tidy-R语言</span></span></span></span><span data-offset-key="dmfn6-2-0"><span data-text="true"><span leaf="">，已有 1025 人加入。</span></span></span></p><p><span data-offset-key="c1jqf-0-0"><span data-text="true"><span leaf="">知乎直答知识库：</span></span></span></p><p><span data-offset-key="bi45t-0-0"><span data-text="true"><span leaf="">https://zhida.zhihu.com/repositories/7516353785554708517</span></span></span></p><section data-block="true" data-editor="4t197" data-offset-key="42ba6-0-0"><span leaf=""><br></span></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/U9y71nZpe6bvJtAEHkkSIw",target="_blank" rel="noopener noreferrer">原文链接</a>
