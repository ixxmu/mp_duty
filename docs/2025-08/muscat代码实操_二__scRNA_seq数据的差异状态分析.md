---
title: "muscat代码实操（二）：scRNA-seq数据的差异状态分析"
date: 2025-08-05T11:06:14Z
draft: ["false"]
tags: [
  "fetched",
  "生信宝库"
]
categories: ["Acdemic"]
---
muscat代码实操（二）：scRNA-seq数据的差异状态分析 by 生信宝库
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>前言</span></h2><p data-tool="mdnice编辑器">我们在前两期的推文：<a href="https://mp.weixin.qq.com/s?__biz=MzI4MjY5ODI1Nw==&amp;mid=2247488684&amp;idx=1&amp;sn=0439df7703831fc6aa963e4fc5cf42c9&amp;chksm=eb94a3d2dce32ac4872a85b2c85e738a1f57553d90055650ea3bf7a86c56b4944cb994fc8568&amp;token=687558307&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">muscat：专注于多样本多分组的单细胞差异分析</a>；<a href="https://mp.weixin.qq.com/s?__biz=MzI4MjY5ODI1Nw==&amp;mid=2247488745&amp;idx=1&amp;sn=31e73b166c895a3c2ddc07f7d6654ec2&amp;chksm=eb94a397dce32a814878b8ad5305ba9298d4111e55bcd6f0b0b30af17a8487d2e4d9c74b88f7&amp;token=1820425065&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">muscat代码实操（一）：模拟复杂的 scRNA-seq 数据以及评估不同的差异表达分析方法的性能</a>中，分别介绍了muscat的功能框架以及如何使用muscat模拟复杂的scRNA-seq数据和评估不同的差异表达分析方法的性能。在本期的推文中，我们将深入探讨muscat包的核心功能——差异状态分析（DS分析）。DS分析的目标是揭示细胞在不同条件或时间点下的功能状态及其行为的变化。</p><p data-tool="mdnice编辑器">为了让大家更系统地理解，我们将按照以下五个步骤进行介绍：</p><ol data-tool="mdnice编辑器"><li><section>单细胞数据的质控</section></li><li><section>将数据调整为muscat包所需的格式</section></li><li><section>DS分析</section></li><li><section>结果的筛选和过滤</section></li><li><section>结果可视化</section></li></ol><p data-tool="mdnice编辑器">希望通过这样的步骤，大家能够更加清晰地掌握DS分析的全过程，并能够在实际研究中进行有效应用。接下来，让我们来一起学习一下这项分析吧。</p><p data-tool="mdnice编辑器"><br></p><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span><span>代码流程</span></h2><h4 data-tool="mdnice编辑器"><span></span>0. 加载R包和数据<span></span></h4><p data-tool="mdnice编辑器">数据来源：GSE96583；包含8名狼疮患者在IFN-β治疗前后获得的scRNA-seq PBCM数据，数据集包含大约35000个基因和29000个细胞。</p><pre data-tool="mdnice编辑器"><code>library(dplyr)<br>library(ggplot2)<br>library(limma)<br>library(muscat)<br>library(purrr)<br>library(ExperimentHub)<br>eh &lt;- ExperimentHub()<br>query(eh, <span>"Kang"</span>)<br>(sce &lt;- eh[[<span>"EH2259"</span>]])<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>1. 数据质控和格式准备<span></span></h4><p data-tool="mdnice编辑器">数据质控<br></p><pre data-tool="mdnice编辑器"><code><span># remove undetected genes</span><br>sce &lt;- sce[rowSums(counts(sce) &gt; 0) &gt; 0, ]<br>dim(sce)<br><span>## [1] 18890 29065</span><br><span># calculate per-cell quality control (QC) metrics</span><br>library(scater)<br>qc &lt;- perCellQCMetrics(sce)<br><span># remove cells with few or many detected genes</span><br>ol &lt;- isOutlier(metric = qc<span>$detected</span>, nmads = 2, <span>log</span> = TRUE)<br>sce &lt;- sce[, !ol]<br>dim(sce)<br><span>## [1] 18890 26820</span><br><span># remove lowly expressed genes</span><br>sce &lt;- sce[rowSums(counts(sce) &gt; 1) &gt;= 10, ]<br>dim(sce)<br><span>## [1]  7118 26820</span><br><span># compute sum-factors &amp; normalize</span><br>sce &lt;- computeLibraryFactors(sce)<br>sce &lt;- logNormCounts(sce)<br>library(sctransform)<br>assays(sce)<span>$vstresiduals</span> &lt;- vst(counts(sce), verbosity = FALSE)<span>$y</span><br></code></pre><p data-tool="mdnice编辑器">接下来，我们来看一下muscat要求输入的数据格式：</p><ul data-tool="mdnice编辑器"><li><section>sample_id: 唯一的样本标识符，例如PeterPan_ref1、Nautilus_trt3等。</section></li><li><section>cluster_id: 子群体（或称为簇）的分配，例如T cells、monocytes等。</section></li><li><section>group_id: 实验组/条件，例如control/treatment、healthy/diseased等。</section></li></ul><pre data-tool="mdnice编辑器"><code>sce<span>$id</span> &lt;- paste0(sce<span>$stim</span>, sce<span>$ind</span>)<br>(sce &lt;- prepSCE(sce, <br>    kid = <span>"cell"</span>, <span># subpopulation assignments</span><br>    gid = <span>"stim"</span>,  <span># group IDs (ctrl/stim)</span><br>    sid = <span>"id"</span>,   <span># sample IDs (ctrl/stim.1234)</span><br>    drop = TRUE))  <span># drop all other colData columns</span><br></code></pre><p data-tool="mdnice编辑器">存储簇和样本ID以及它们的数量</p><pre data-tool="mdnice编辑器"><code>nk &lt;- length(kids &lt;- levels(sce<span>$cluster_id</span>))<br>ns &lt;- length(sids &lt;- levels(sce<span>$sample_id</span>))<br>names(kids) &lt;- kids<br>names(sids) &lt;- sids<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>2. 数据概览<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>2.1 簇-样本大小<span></span></h5><p data-tool="mdnice编辑器">计算每个簇-样本组合中的细胞数量，并将结果转置。</p><pre data-tool="mdnice编辑器"><code><span># nb. of cells per cluster-sample</span><br>t(table(sce<span>$cluster_id</span>, sce<span>$sample_id</span>))<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>2.2 降维<span></span></h5><pre data-tool="mdnice编辑器"><code><span># compute UMAP using 1st 20 PCs</span><br>sce &lt;- runUMAP(sce, pca = 20)<br>接下来，定义了一个简单的包装函数.plot_dr()来美化降维图的输出。<br>.plot_dr &lt;- <span>function</span>(sce, dr, col)<br>  plotReducedDim(sce, dimred = dr, colour_by = col) +<br>    guides(fill = guide_legend(override.aes = list(alpha = 1, size = 3))) +<br>theme_minimal() + theme(aspect.ratio = 1)<br><span># downsample to max. 100 cells per cluster</span><br>cs_by_k &lt;- split(colnames(sce), sce<span>$cluster_id</span>)<br>cs100 &lt;- unlist(sapply(cs_by_k, <span>function</span>(u) <br>  sample(u, min(length(u), 100))))<br><span># plot t-SNE &amp; UMAP colored by cluster &amp; group ID</span><br><span>for</span> (dr <span>in</span> c(<span>"TSNE"</span>, <span>"UMAP"</span>))<br>  <span>for</span> (col <span>in</span> c(<span>"cluster_id"</span>, <span>"group_id"</span>))<br>.plot_dr(sce[, cs100], dr, col)<br></code></pre><p data-tool="mdnice编辑器">对每个簇进行下采样，最多选择100个细胞。然后，它使用前面定义的.plot_dr()函数绘制t-SNE和UMAP图，这些图由簇ID和组ID分别着色。</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3412112259970458" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTfMQyknOBJMy9RzoibMjgRzobIcO62pHlcL2ZiaN4giaw5eleT0aMx88pQ/640?wx_fmt=png" data-type="png" data-w="677" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTfMQyknOBJMy9RzoibMjgRzobIcO62pHlcL2ZiaN4giaw5eleT0aMx88pQ/640?wx_fmt=png"></figure><h4 data-tool="mdnice编辑器"><span></span>3. 差异状态分析<span></span></h4><p data-tool="mdnice编辑器">作者主要考虑两种方法进行差异状态（DS）分析：</p><ul data-tool="mdnice编辑器"><li><section>直接作用于细胞水平的混合模型进行DS分析；</section></li><li><section>基于聚合的方法对伪批量数据进行DS分析。</section></li></ul><h5 data-tool="mdnice编辑器"><span></span>3.1 聚合单细胞数据为伪批量数据<span></span></h5><p data-tool="mdnice编辑器">为了利用现有的稳健的批量RNA-seq DE框架，如edgeR、DESeq2和limma，作者首先聚合每个样本（在每个簇中）的测量值以获得伪批量数据。</p><pre data-tool="mdnice编辑器"><code>pb &lt;- aggregateData(sce,<br>    assay = <span>"counts"</span>, fun = <span>"sum"</span>,<br>by = c(<span>"cluster_id"</span>, <span>"sample_id"</span>))<br><span>#使用aggregateData函数将数据聚合为伪批量数据。</span><br><span># one sheet per subpopulation</span><br>assayNames(pb)<br><span># pseudobulks for 1st subpopulation</span><br>t(head(assay(pb))) <br></code></pre><h5 data-tool="mdnice编辑器"><span></span>3.2 伪批量级别的MDS图<span></span></h5><p data-tool="mdnice编辑器">在进行任何正式的测试之前，我们可以计算聚合信号的多维缩放（MDS）图来探索样本之间的整体相似性。</p><pre data-tool="mdnice编辑器"><code>(pb_mds &lt;- pbMDS(pb))<br><span>#使用pbMDS函数计算伪批量数据的MDS图。</span><br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6835820895522388" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTHdcC1YzzmUeXDL4Wo3KcdibtFvMZAibXj4ichvzicaOdBhuxLf2eJsib1qw/640?wx_fmt=png" data-type="png" data-w="670" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTHdcC1YzzmUeXDL4Wo3KcdibtFvMZAibXj4ichvzicaOdBhuxLf2eJsib1qw/640?wx_fmt=png">对上图进行美化</p><pre data-tool="mdnice编辑器"><code><span># use very distinctive shaping of groups &amp; change cluster colors</span><br>pb_mds &lt;- pb_mds + <br>  scale_shape_manual(values = c(17, 4)) +<br>  scale_color_manual(values = RColorBrewer::brewer.pal(8, <span>"Set2"</span>))<br><span># change point size &amp; alpha</span><br>pb_mds<span>$layers</span>[[1]]<span>$aes_params</span><span>$size</span> &lt;- 5<br>pb_mds<span>$layers</span>[[1]]<span>$aes_params</span><span>$alpha</span> &lt;- 0.6<br>pb_mds<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6835820895522388" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTVHI2tL2xYzCWwMCh1na1Oqp29vYeKf0ibOMaiaibXQLZahy2rvflPCSbQ/640?wx_fmt=png" data-type="png" data-w="670" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTVHI2tL2xYzCWwMCh1na1Oqp29vYeKf0ibOMaiaibXQLZahy2rvflPCSbQ/640?wx_fmt=png"></figure><h5 data-tool="mdnice编辑器"><span></span>3.3 样本级分析：伪批量方法<span></span></h5><pre data-tool="mdnice编辑器"><code><span># run DS analysis</span><br>res &lt;- pbDS(pb, verbose = FALSE)<br><span># access results table for 1st comparison</span><br>tbl &lt;- res<span>$table</span>[[1]]<br><span># one data.frame per cluster</span><br>names(tbl)<br><span># view results for 1st cluster</span><br>k1 &lt;- tbl[[1]]<br>head(format(k1[, -ncol(k1)], digits = 2))<br></code></pre><p data-tool="mdnice编辑器">考虑到实验设计的复杂性（例如，当存在两个以上的组时），可能需要明确指定感兴趣的比较。在这里作者提供了model.matrix函数为pbDS提供一个捕获实验设计的设计矩阵和limma包中的makeContrasts函数指定我们感兴趣的比较。</p><pre data-tool="mdnice编辑器"><code><span># construct design &amp; contrast matrix</span><br>ei &lt;- metadata(sce)<span>$experiment_info</span><br>mm &lt;- model.matrix(~ 0 + ei<span>$group_id</span>)<br>dimnames(mm) &lt;- list(ei<span>$sample_id</span>, levels(ei<span>$group_id</span>))<br>library(limma)<br>contrast &lt;- makeContrasts(<span>"stim-ctrl"</span>, levels = mm)<br><span># run DS analysis</span><br>pbDS(pb, design = mm, contrast = contrast)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>3.4 细胞级分析：混合模型<span></span></h5><p data-tool="mdnice编辑器">muscat提供了使用3种MM方法的实现。</p><pre data-tool="mdnice编辑器"><code><span># 1st approach</span><br>mm &lt;- mmDS(sce, method = <span>"dream"</span>,<br>  n_cells = 10, n_samples = 2,<br>  min_counts = 1, min_cells = 20)<br><span># 2nd &amp; 3rd approach</span><br>mm &lt;- mmDS(sce, method = <span>"vst"</span>, vst = <span>"sctransform"</span>)<br>mm &lt;- mmDS(sce, method = <span>"nbinom"</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>4. 结果<span></span></h4><p data-tool="mdnice编辑器">接下来，我们介绍一下如何查看差异测试结果，以及计算和使用基因的表达频率进行进一步的结果过滤。</p><h5 data-tool="mdnice编辑器"><span></span>4.1 结果过滤<span></span></h5><pre data-tool="mdnice编辑器"><code>tbl_fil &lt;- lapply(tbl, <span>function</span>(u) {<br>  u &lt;- dplyr::filter(u, p_adj.loc &lt; 0.05, abs(logFC) &gt; 1)<br>  dplyr::arrange(u, p_adj.loc)<br>})<br></code></pre><p data-tool="mdnice编辑器">首先过滤出FDR小于5%和logFC大于1的结果，并按调整后的p值排序。</p><h5 data-tool="mdnice编辑器"><span></span>4.2 计算每个簇的DS基因数量和百分比<span></span></h5><pre data-tool="mdnice编辑器"><code>n_de &lt;- vapply(tbl_fil, nrow, numeric(1))<br>p_de &lt;- format(n_de / nrow(sce) * 100, digits = 3)<br>data.frame(<span>"#DS"</span> = n_de, <span>"%DS"</span> = p_de, check.names = FALSE)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>4.3 查看每个簇的前两个结果<span></span></h5><pre data-tool="mdnice编辑器"><code>top2 &lt;- bind_rows(lapply(tbl_fil, top_n, 2, p_adj.loc))<br>format(top2[, -ncol(top2)], digits = 2)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>4.4 计算表达频率<span></span></h5><p data-tool="mdnice编辑器">#每个基因的表达频率，即每个样品和/或组中表达给定基因的细胞比例。frq &lt;- calcExprFreqs(sce, assay = "counts", th = 0)使用calcExprFreqs函数计算每个基因在每个样本和/或组中的表达频率。</p><pre data-tool="mdnice编辑器"><code><span># one sheet per cluster</span><br>assayNames(frq)<br><span>## [1] "B cells"           "CD14+ Monocytes"   "CD4 T cells"      </span><br><span>## [4] "CD8 T cells"       "Dendritic cells"   "FCGR3A+ Monocytes"</span><br><span>## [7] "Megakaryocytes"    "NK cells"</span><br><span># expression frequencies in each</span><br><span># sample &amp; group; 1st cluster</span><br>t(head(assay(frq), 5))<br><span>##               NOC2L        HES4      ISG15    TNFRSF18     TNFRSF4</span><br><span>## ctrl101  0.09734513 0.000000000 0.08849558 0.061946903 0.008849558</span><br><span>## ctrl1015 0.07773109 0.008403361 0.18067227 0.090336134 0.021008403</span><br><span>## ctrl1016 0.08333333 0.013888889 0.20833333 0.048611111 0.000000000</span><br><span>## ctrl1039 0.06666667 0.033333333 0.33333333 0.100000000 0.033333333</span><br><span>## ctrl107  0.09803922 0.000000000 0.07843137 0.058823529 0.019607843</span><br><span>## ctrl1244 0.12686567 0.037313433 0.10447761 0.126865672 0.029850746</span><br><span>## ctrl1256 0.08750000 0.004166667 0.18750000 0.091666667 0.025000000</span><br><span>## ctrl1488 0.06837607 0.004273504 0.11965812 0.076923077 0.012820513</span><br><span>## stim101  0.08333333 0.055555556 0.98611111 0.020833333 0.006944444</span><br><span>## stim1015 0.08963585 0.072829132 0.99719888 0.044817927 0.005602241</span><br><span>## stim1016 0.03875969 0.054263566 1.00000000 0.007751938 0.023255814</span><br><span>## stim1039 0.05128205 0.051282051 1.00000000 0.025641026 0.025641026</span><br><span>## stim107  0.05357143 0.035714286 1.00000000 0.017857143 0.000000000</span><br><span>## stim1244 0.11702128 0.095744681 0.98936170 0.053191489 0.021276596</span><br><span>## stim1256 0.06635071 0.037914692 0.99526066 0.037914692 0.004739336</span><br><span>## stim1488 0.05653710 0.014134276 0.99646643 0.031802120 0.003533569</span><br><span>## ctrl     0.08509142 0.009845288 0.15963432 0.084388186 0.018284107</span><br><span>## stim     0.07235339 0.050266565 0.99543031 0.033511043 0.008377761</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span>4.5 基于表达频率过滤结果<span></span></h5><pre data-tool="mdnice编辑器"><code>gids &lt;- levels(sce<span>$group_id</span>)<br>frq10 &lt;- vapply(as.list(assays(frq)), <br>  <span>function</span>(u) apply(u[, gids] &gt; 0.1, 1, any), <br>  logical(nrow(sce)))<br>t(head(frq10))<br><span>##                   NOC2L  HES4 ISG15 TNFRSF18 TNFRSF4  SDF4</span><br><span>## B cells           FALSE FALSE  TRUE    FALSE   FALSE FALSE</span><br><span>## CD14+ Monocytes   FALSE  TRUE  TRUE    FALSE   FALSE  TRUE</span><br><span>## CD4 T cells       FALSE FALSE  TRUE    FALSE   FALSE FALSE</span><br><span>## CD8 T cells       FALSE FALSE  TRUE    FALSE   FALSE FALSE</span><br><span>## Dendritic cells   FALSE  TRUE  TRUE    FALSE    TRUE  TRUE</span><br><span>## FCGR3A+ Monocytes FALSE  TRUE  TRUE    FALSE   FALSE FALSE</span><br><span>## Megakaryocytes    FALSE FALSE  TRUE    FALSE   FALSE FALSE</span><br><span>## NK cells          FALSE FALSE  TRUE     TRUE   FALSE  TRUE</span><br>tbl_fil2 &lt;- lapply(kids, <span>function</span>(k)<br>  dplyr::filter(tbl_fil[[k]], <br>    gene %<span>in</span>% names(<span>which</span>(frq10[, k]))))<br><span>#首先确定哪些基因在至少一个组中的平均表达频率超过10%。随后过滤出这些基因的DS结果。</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span>4.6 再次计算每个簇的DS基因数量和百分比<span></span></h5><pre data-tool="mdnice编辑器"><code>n_de &lt;- vapply(tbl_fil2, nrow, numeric(1))<br>p_de &lt;- format(n_de / nrow(sce) * 100, digits = 3)<br>data.frame(<span>"#DS"</span> = n_de, <span>"%DS"</span> = p_de, check.names = FALSE)<br><span>##                   #DS   %DS</span><br><span>## B cells           226 3.175</span><br><span>## CD14+ Monocytes   622 8.738</span><br><span>## CD4 T cells       154 2.164</span><br><span>## CD8 T cells        94 1.321</span><br><span>## Dendritic cells   117 1.644</span><br><span>## FCGR3A+ Monocytes 382 5.367</span><br><span>## Megakaryocytes     28 0.393</span><br><span>## NK cells          160 2.248</span><br>再次计算每个簇中DS基因的数量和百分比，但这次是基于表达频率过滤后的结果。<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>4.7 结果格式化<span></span></h5><p data-tool="mdnice编辑器">当进行多个对比或系数测试时，runDS返回的结果可能会变得非常复杂，不便于探索或导出。resDS函数可以用来格式化这些结果，并提供了两种不同的格式化模式：bind = "row" 或 bind = "col"。</p><pre data-tool="mdnice编辑器"><code>resDS(sce, res, <span>bind</span> = <span>"row"</span>, frq = frq)<br><span>#所有比较的结果都会垂直合并（类似于do.call("rbind", ...)）成一个整洁格式的表格，其中contrast/coef列指定了比较。这里还附加了预先计算的表达频率。</span><br>resDS(sce, res, <span>bind</span> = <span>"col"</span>, cpm = TRUE)<br><span>#结果会水平合并成一个单一的宽表，其中给定基因和簇的所有结果都保留在一行中。相应的对比或系数的标识符会追加到列名中。这种格式在想要查看特定基因在多种处理中的行为时很有用，但在包含许多比较时会变得混乱。</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span>4.8 直接计算表达频率<span></span></h5><p data-tool="mdnice编辑器">如果表达频率尚未使用calcExprFreqs预先计算，可以通过指定frq = TRUE直接将其添加到结果表中：</p><pre data-tool="mdnice编辑器"><code>resDS(sce, res, frq = TRUE)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>5. 可视化结果<span></span></h4><p data-tool="mdnice编辑器">差异性分析的目的是在不同条件下识别特定细胞群体的状态（或表达）的变化。在这种情境下，关键的问题是：哪些基因只在一个（或很少）细胞群体中显示差异表达？有多少差异表达的基因在细胞群体之间是共享的？也就是不同细胞群体之间的差异性发现的一致性是怎样的？</p><h5 data-tool="mdnice编辑器"><span></span>5.1 UpSet图<span></span></h5><p data-tool="mdnice编辑器">为了了解不同细胞群体之间关于差异表达基因的一致性，作者使用UpSet图（UpSet图是一种可视化集合交集的方法）可视化了在某些细胞群体中共享或独特的差异表达基因的数量。</p><pre data-tool="mdnice编辑器"><code>library(UpSetR)<br>de_gs_by_k &lt;- map(tbl_fil, <span>"gene"</span>)<br>upset(fromList(de_gs_by_k))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.48773448773448774" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTDKKeIeCGpabb9zl6KpNI57nLWibKA564ibaNAGibAYmvlcKwJoUUCSRvQ/640?wx_fmt=png" data-type="png" data-w="693" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTDKKeIeCGpabb9zl6KpNI57nLWibKA564ibaNAGibAYmvlcKwJoUUCSRvQ/640?wx_fmt=png"></figure><h5 data-tool="mdnice编辑器"><span></span>5.2 DR colored by expression<span></span></h5><p data-tool="mdnice编辑器">一组由基因表达着色的t-SNE图，这些基因是所有细胞群体中的前8个DS基因。</p><pre data-tool="mdnice编辑器"><code>top8 &lt;- bind_rows(tbl_fil) %&gt;% <br>  top_n(8, dplyr::desc(p_adj.loc)) %&gt;% <br>  pull(<span>"gene"</span>)<br><span>#这里使用dplyr包的函数来提取所有细胞群体中的前8个DS基因。</span><br>ps &lt;- lapply(top8, <span>function</span>(g)<br>  .plot_dr(sce[, cs100], <span>"TSNE"</span>, g) + <br>    ggtitle(g) + theme(legend.position = <span>"none"</span>))<br><span>#对于top8中的每个基因，都会生成一个由该基因的表达着色的t-SNE图。</span><br>plot_grid(plotlist = ps, ncol = 4, align = <span>"vh"</span>)<span>#排列并显示图形</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6104651162790697" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTQcK6PEq8bhcGPrfsmdKg0XbaW6ousqwYTGJTsDZsktrRCrTSMTZb3g/640?wx_fmt=png" data-type="png" data-w="688" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTQcK6PEq8bhcGPrfsmdKg0XbaW6ousqwYTGJTsDZsktrRCrTSMTZb3g/640?wx_fmt=png"></figure><h5 data-tool="mdnice编辑器"><span></span>5.3 细胞水平的小提琴图<span></span></h5><pre data-tool="mdnice编辑器"><code>plotExpression(sce[, sce<span>$cluster_id</span> == <span>"B cells"</span>],<br>  features = tbl_fil$`B cells`<span>$gene</span>[seq_len(6)],<br>  x = <span>"sample_id"</span>, colour_by = <span>"group_id"</span>, ncol = 3) +<br>  guides(fill = guide_legend(override.aes = list(size = 5, alpha = 1))) +<br>  theme(axis.text.x = element_text(angle = 45, hjust = 1))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4935064935064935" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTBDoMGmgFtQEXebbFpgicpGTk3ooeMuF9StRWhJhLOkuoibEdyD53k9qg/640?wx_fmt=png" data-type="png" data-w="693" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTBDoMGmgFtQEXebbFpgicpGTk3ooeMuF9StRWhJhLOkuoibEdyD53k9qg/640?wx_fmt=png"></figure><h5 data-tool="mdnice编辑器"><span></span>5.4 Pseudobulk 热图<span></span></h5><pre data-tool="mdnice编辑器"><code>pbHeatmap(sce, res, top_n = 5)<span>#展示每个细胞群体的前5个DS基因。</span><br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6142649199417758" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTNjicQQKbcRjZzLTywqOGIa7DRkDFqOicGaeRXetUSLrac7YfplQ07nFw/640?wx_fmt=png" data-type="png" data-w="687" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTNjicQQKbcRjZzLTywqOGIa7DRkDFqOicGaeRXetUSLrac7YfplQ07nFw/640?wx_fmt=png">为单个细胞群体生成热图:</p><pre data-tool="mdnice编辑器"><code><br>pbHeatmap(sce, res, k = <span>"B cells"</span>)<span>#这里展示了B细胞群体的前20个DS基因。</span><br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.6132756132756133" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTniaEnOHsmT776VybvCnXuiaAxiacA6KUJ1GuS36ibcic1diaW9XgvUKHThaA/640?wx_fmt=png" data-type="png" data-w="693" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTniaEnOHsmT776VybvCnXuiaAxiacA6KUJ1GuS36ibcic1diaW9XgvUKHThaA/640?wx_fmt=png">为所有细胞群体生成单个基因的热图:</p><pre data-tool="mdnice编辑器"><code>pbHeatmap(sce, res, g = <span>"ISG20"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6132756132756133" data-src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTyLVhjjbCF28384yx61aZBiass5uicTr1vWKZae5WBdG31u94O9rJWibdA/640?wx_fmt=png" data-type="png" data-w="693" src="https://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7ficRUeNfZfgPibauBnKfwTYTyLVhjjbCF28384yx61aZBiass5uicTr1vWKZae5WBdG31u94O9rJWibdA/640?wx_fmt=png"></figure><hr data-tool="mdnice编辑器"><h2 data-tool="mdnice编辑器"><span></span><span>小结</span></h2><p data-tool="mdnice编辑器">截止到目前，有关muscat的使用方法就都介绍完了。muscat在样本级别上对scRNA-seq进行差异分析，在一定程度上克服的scRNA-seq数据高噪声和稀疏性导致的差异基因表达分析的假阳性，有利于我们在研究中得到更为可靠的结论。在实际使用muscat的过程中，我们不难发现，该R包的设计非常全面和细致。它涵盖了从数据的质量控制到结果的可视化的整个流程，为科研工作者提供了极大的便利。感兴趣的小伙伴赶紧用起来吧。</p><p data-tool="mdnice编辑器">好啦，本期的分享到这里就结束了，我们下期再会~~</p><p data-tool="mdnice编辑器"><br></p><hr data-tool="mdnice编辑器"></section><p><span></span><img data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/GL6g5Y3aR7eUr3zZytdDPl7kPJBscWxTDlwbSxRjmMoYpSCSmlGicFibnLH3pvictSibFwekOaooibv9Ria0zSCrC2icg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="jpeg" data-w="344" src="https://mmbiz.qpic.cn/mmbiz_jpg/GL6g5Y3aR7eUr3zZytdDPl7kPJBscWxTDlwbSxRjmMoYpSCSmlGicFibnLH3pvictSibFwekOaooibv9Ria0zSCrC2icg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><h3 data-tool="mdnice编辑器"><span>关注下方公众号下回更新不迷路</span></h3><section><br></section><section><mp-common-profile data-pluginname="mpprofile" data-weui-theme="light" data-id="MzI4MjY5ODI1Nw==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/GL6g5Y3aR7f0yanILMQZCnw1duTMROQRvgDqVjlYcrljTRy1E4ZLppLG6zicdd3h0IwjLpxnum1V5KsowibJM1sw/0?wx_fmt=png" data-nickname="生信宝库" data-alias="sxbk2020" data-signature="本公众号只用于生信知识的收集与传播，以及生信人之间互相交流和学习，不会涉及任何商业利益。本公众号各小编平时忙于科研，更新文章较其它同类型公众号较慢，但保持宁缺毋滥的本心，只更新对大家有用的推文。" data-from="2" data-is_biz_ban="0" data-origin_num="213" data-isban="0" data-biz_account_status="0" data-index="0"></mp-common-profile><span></span></section><section><span></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/15xJU5sRvrhQJic6cVZhFA",target="_blank" rel="noopener noreferrer">原文链接</a>
