---
title: "单细胞数据处理（八_sup）组间差异分析补充：muscat包"
date: 2025-08-05T10:50:30Z
draft: ["false"]
tags: [
  "fetched",
  "闲时记点"
]
categories: ["Acdemic"]
---
单细胞数据处理（八_sup）组间差异分析补充：muscat包 by 闲时记点
------
<div><p><span>关于muscat这个包，具体使用方法都在下面这个网址（<span>https://www.bioconductor.org/packages/release/bioc/vignettes/muscat/inst/doc/analysis.html</span>）中提到了，但是教程中还是有很多解释不太清楚的地方，第一次学习会有疑惑。本文旨在减少学习成本，帮助快速掌握muscat使用。</span></p><p>最核心的代码就只有下面这几行</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="objectivec"><code><span>sce &lt;- prepSCE(sce, </span></code><code><span>    kid = <span>"cell"</span>, <span># subpopulation assignments，已经分好群的细胞分群名字，示例数据中有8个分群</span></span></code><code><span>    gid = <span>"stim"</span>,  <span># group IDs (ctrl/stim)实验组和对照组</span></span></code><code><span>    sid = <span>"id"</span>,   <span># sample IDs (ctrl/stim.1234)上文刚刚设定好的唯一标识符</span></span></code><code><span>    drop = <span>TRUE</span>) <span># drop all other colData columns其他列都不要了</span></span></code><code><span><br></span></code><code><span>pb &lt;- aggregateData(sce,</span></code><code><span>                    assay = <span>"counts"</span>, </span></code><code><span>                    fun = <span>"sum"</span>,</span></code><code><span>                    by = c(<span>"cluster_id"</span>, <span>"sample_id"</span>))</span></code><code><span>                    </span></code><code><span>res &lt;- pbDS(pb, verbose = <span>FALSE</span>)</span></code></pre></section><p><span>‍</span></p><p>关于这三行代码的详细解释如下：<br></p><p><span>使用muscat包官方教程给的数据，是8个狼疮病人治疗前和治疗后的测序数据</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="shell"><code><span><br></span></code><code><span>library(dplyr)</span></code><code><span>library(ggplot2)</span></code><code><span>library(limma)</span></code><code><span>library(muscat)</span></code><code><span>library(purrr)</span></code><code><span>library(ExperimentHub)</span></code><code><span>eh &lt;- ExperimentHub()</span></code><code><span>query(eh, "Kang")</span></code><code><span>sce &lt;- eh[["EH2259"]]</span></code><code><span><br></span></code><code><span><span>#</span>remove.packages(<span>"dbplyr"</span>)</span></code><code><span><span>#</span>devtools::install_version(<span>"dbplyr"</span>, version = <span>"2.3.4"</span>)</span></code><code><span><span>#</span>请注意，在使用eh &lt;- ExperimentHub()这个命令时可能会报错，</span></code><code><span><span>#</span>这时候你需要变动dbplyr的版本，如果使用上述命令无法下载，</span></code><code><span><span>#</span>请去bioconductor自行下载，过程中可能会需要科学上网！！</span></code></pre></section><p>获得数据后，关于数据的初步处理方法请完全参考上述网址中的步骤。</p><p><span><strong><span>下面是重要部分！！！！！</span></strong></span></p><p>***接下来数据准备：<span>prepSCE这个前置函数，一共是需要kid，gid，sid三个数据，</span></p><p><strong>sid</strong><span>："sample_id": unique sample identifiers：上面是样本名字，下面是每个样本的细胞数</span></p><p><strong><span>kid</span></strong><span>："cluster_id": subpopulation (cluster) assignments 上面是细胞名字，下面是每种细胞的数量</span></p><p><strong><span>gid</span></strong><span>："group_id": experimental group/condition 分组数据</span><span></span></p><p><span><img data-imgfileid="100000095" data-ratio="0.18425925925925926" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/MsYkIaibPhed1faXmEfYrOtHjPfzlYCfUt9Cqe3S3gwRyAt2BfStd0K1Sibmv9IVeSribOn1iaiaicGf7Wqeo7p44vRw/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/MsYkIaibPhed1faXmEfYrOtHjPfzlYCfUt9Cqe3S3gwRyAt2BfStd0K1Sibmv9IVeSribOn1iaiaicGf7Wqeo7p44vRw/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span>sce$id &lt;- paste<span>0</span>(sce$stim, sce$ind)</span></code><code><span>&gt; table(sce$stim)</span></code><code><span>ctrl  stim </span></code><code><span><span>13463</span> <span>13357</span> </span></code><code><span>&gt; table(sce$ind)</span></code><code><span><span>101</span>  <span>107</span> <span>1015</span> <span>1016</span> <span>1039</span> <span>1244</span> <span>1256</span> <span>1488</span> </span></code><code><span><span>2109</span> <span>1164</span> <span>5374</span> <span>3963</span> <span>1075</span> <span>3733</span> <span>4394</span> <span>5008</span></span></code><code><span><span>#这里的id一列是唯一标识符，</span></span></code><code><span><span>#stim里有ctrl和stim两种，代表对照组和stimulated两组</span></span></code><code><span><span>#ind应该是individual了，一共八个样本</span></span></code><code><span><span>#paste0一下，我们就获得了8个患者治疗前和治疗后一共16种id</span></span></code><code><span><br></span></code><code><span><span>#prepSCE是准备做DS分析的前置准备函数，具体参数解释如下</span></span></code><code><span>sce &lt;- prepSCE(sce, </span></code><code><span>    kid = <span>"cell"</span>, <span># subpopulation assignments，已经分好群的细胞分群名字，示例数据中有8个分群</span></span></code><code><span>    gid = <span>"stim"</span>,  <span># group IDs (ctrl/stim)实验组和对照组</span></span></code><code><span>    sid = <span>"id"</span>,   <span># sample IDs (ctrl/stim.1234)上文刚刚设定好的唯一标识符</span></span></code><code><span>    drop = TRUE) <span># drop all other colData columns其他列都不要了</span></span></code><code><span>    </span></code><code><span><span>#按照教程储存一些简单变量</span></span></code><code><span>nk &lt;- <span>length</span>(kids &lt;- levels(sce$cluster_id))</span></code><code><span>ns &lt;- <span>length</span>(sids &lt;- levels(sce$sample_id))</span></code><code><span>names(kids) &lt;- kids; names(sids) &lt;- sids    </span></code><code><span><br></span></code><code><span>t(table(sce$cluster_id, sce$sample_id))</span></code></pre></section><p><span>这时候应该出现了</span><span>sce</span><span>$cluster_id</span><span>, sce</span><span>$sample_id</span><span>两列，下面其实就是显示了每个样本里有多少细胞</span></p><p><span><img data-imgfileid="100000098" data-ratio="0.31851851851851853" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/MsYkIaibPhed1faXmEfYrOtHjPfzlYCfUhu8JPE1PaQbQnGHYicodBGalCz7YuEea9gDYibSn4dhE9wIv2DFJxicIw/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/MsYkIaibPhed1faXmEfYrOtHjPfzlYCfUhu8JPE1PaQbQnGHYicodBGalCz7YuEea9gDYibSn4dhE9wIv2DFJxicIw/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></span></p><p><span></span><span>降维及绘图</span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="swift"><code><span># compute <span>UMAP</span> using 1st <span>20</span> <span>PCs</span>原数据已经有</span></code><code><span>sce &lt;- runUMAP(sce, pca = <span>20</span>)</span></code><code><span><br></span></code><code><span>{</span></code><code><span>  <span>for</span> (dr <span>in</span> <span>c</span>(<span>"TSNE"</span>))</span></code><code><span>    <span>for</span> (col <span>in</span> <span>c</span>(<span>"group_id"</span>))</span></code><code><span>      p1 = plot_dr(sce[, cs100], dr, col)</span></code><code><span>  p1</span></code><code><span><br></span></code><code><span>  <span>for</span> (dr <span>in</span> <span>c</span>(<span>"TSNE"</span>))</span></code><code><span>    <span>for</span> (col <span>in</span> <span>c</span>(<span>"cluster_id"</span>))</span></code><code><span>      p2 = plot_dr(sce[, cs100], dr, col)</span></code><code><span>  p2</span></code><code><span>  p1 + p2</span></code><code><span>}#t-<span>SNE</span>图，umap图就换一下变量就行</span></code></pre></section><p><span></span></p><p><span><span>差异分析之前看一下样本的一致性</span></span></p><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span><br></span></code><code><span>pb &lt;- aggregateData(sce,</span></code><code><span>                    assay = <span>"counts"</span>, </span></code><code><span>                    <span><span>fun</span> = "sum",</span></span></code><code><span>                    <span>by</span> = c(<span>"cluster_id"</span>, <span>"sample_id"</span>))</span></code><code><span>#在进行正式测试之前，计算聚合信号的多维缩放（MDS），以探索整体样本相似性。</span></code><code><span>#理想情况下，来自同一集群或组的样本应该聚集在一起,不同集群的数据应该是分开的。</span></code><code><span>(pb_mds &lt;- pbMDS(pb))</span></code></pre></section><p><img data-imgfileid="100000099" data-ratio="0.5907514450867052" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/MsYkIaibPheebRh7oLF3ZaGiclx1gTH4YmibaOEQbCicqh4XIsZkpAiarHic13Pj4KFZdGUna6leqEialpsAxj4gSY0jA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-w="865" src="https://mmbiz.qpic.cn/sz_mmbiz_png/MsYkIaibPheebRh7oLF3ZaGiclx1gTH4YmibaOEQbCicqh4XIsZkpAiarHic13Pj4KFZdGUna6leqEialpsAxj4gSY0jA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"><span><span></span></span></p><p><span><span>开始差异分析</span></span></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="perl"><code><span><span># run DS analysis</span></span></code><code><span>res &lt;- pbDS(pb, verbose = FALSE)<span>#核心代码就这一句，methods参数可以选择差异分析的方式</span></span></code><code><span><span># access results table for 1st comparison</span></span></code><code><span>tbl &lt;- res$table[[<span>1</span>]]</span></code><code><span><span># one data.frame per cluster</span></span></code><code><span>names(tbl)</span></code><code><span><span># view results for 1st cluster</span></span></code><code><span>k1 &lt;- tbl[[<span>1</span>]]</span></code><code><span>head(<span>format</span>(k1[, -ncol(k1)], digits = <span>2</span>))</span></code><code><span>head(k1)</span></code><code><span><br></span></code><code><span><span>###结果过滤</span></span></code><code><span><span># filter FDR &lt; 5%, abs(logFC) &gt; 1 &amp; sort by adj. p-value 保留FDR &lt; 5% 和 abs （logFC） &gt; 1</span></span></code><code><span>tbl_fil &lt;- lapply(tbl, function(u) {</span></code><code><span>  u &lt;- dplyr::filter(u, p_adj.loc &lt; <span>0</span>.<span>05</span>, <span>abs</span>(logFC) &gt; <span>1</span>)</span></code><code><span>  dplyr::arrange(u, p_adj.loc)</span></code><code><span>})</span></code><code><span><br></span></code><code><span><span># nb. of DS genes &amp; % of total by cluster 按聚类计算差异结果的数量和频率</span></span></code><code><span>n_de &lt;- vapply(tbl_fil, nrow, numeric(<span>1</span>))</span></code><code><span>p_de &lt;- <span>format</span>(n_de / nrow(sce) * <span>100</span>, digits = <span>3</span>)</span></code><code><span>data.frame(<span>"#DS"</span> = n_de, <span>"%DS"</span> = p_de, check.names = FALSE)</span></code><code><span><br></span></code><code><span><span># view top 2 hits in each cluster  </span></span></code><code><span>top2 &lt;- bind_rows(lapply(tbl_fil, top_n, <span>2</span>, p_adj.loc))</span></code><code><span><span>format</span>(top2[, -ncol(top2)], digits = <span>2</span>)</span></code><code><span><br></span></code><code><span>fr<span>q &lt;- calcExprFreqs(sce, assay = "counts", th = 0)#还要考虑每个基因的表达频率，即在每个样本和/或组中表达给定基因的细胞比例</span></span></code><code><span># one sheet per cluster</span></code><code><span>assayNames(frq)</span></code><code><span>t(head(assay(frq), 5))</span></code><code><span><br></span></code><code><span>#使用获得的频率来仅保留至少一组中平均 10% 的细胞中表达的基因</span></code><code><span>gids &lt;- levels(sce$group_id)</span></code><code><span>frq10 &lt;- vapply(as.list(assays(frq)), </span></code><code><span><span>                function(u) apply(u[, gids] &gt;</span> <span>0</span>.<span>1</span>, <span>1</span>, any), </span></code><code><span>                logical(nrow(sce)))</span></code><code><span>t(head(frq1<span>0</span>))</span></code><code><span><br></span></code><code><span>tbl_fil2 &lt;- lapply(kids, function(k)</span></code><code><span>  dplyr::filter(tbl_fil[[k]], </span></code><code><span>                gene %in% names(which(frq1<span>0</span>[, k]))))</span></code><code><span><br></span></code><code><span><span># nb. of DS genes &amp; % of total by cluster</span></span></code><code><span>n_de &lt;- vapply(tbl_fil2, nrow, numeric(<span>1</span>))</span></code><code><span>p_de &lt;- <span>format</span>(n_de / nrow(sce) * <span>100</span>, digits = <span>3</span>)</span></code><code><span>data.frame(<span>"#DS"</span> = n_de, <span>"%DS"</span> = p_de, check.names = FALSE)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># tidy format; attach pre-computed expression frequencies</span></span></code><code><span>resDS(sce, res, <span>bind</span> = <span>"row"</span>, frq = frq)</span></code><code><span><br></span></code><code><span><span># big-table (wide) format; attach CPMs</span></span></code><code><span>resDS(sce, res, <span>bind</span> = <span>"col"</span>, cpm = TRUE)</span></code><code><span><br></span></code><code><span><br></span></code><code><span><span>####可视化结果，看看各个细胞亚群的差异基因情况</span></span></code><code><span>library(UpSetR)</span></code><code><span>de_gs_by_k &lt;- <span>map</span>(tbl_fil, <span>"gene"</span>)</span></code><code><span>upset(fromList(de_gs_by_k),</span></code><code><span>      nsets = <span>8</span>,</span></code><code><span>      nintersects=<span>100</span>)</span></code></pre></section><p><span><span></span></span></p><p><span><br></span></p><p><span><br></span></p><p><span><br></span></p><p><span><br></span></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/5ENQw_xpsfHEM2awUl7UGg",target="_blank" rel="noopener noreferrer">原文链接</a>
