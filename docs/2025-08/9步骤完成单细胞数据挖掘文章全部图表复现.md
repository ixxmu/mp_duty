---
title: "9步骤完成单细胞数据挖掘文章全部图表复现"
date: 2025-08-26T10:20:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
9步骤完成单细胞数据挖掘文章全部图表复现 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>两个月前我们更新了优秀的马拉松学员笔记：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247521923&amp;idx=1&amp;sn=8161dadb6ad8ff8d1616137e61b35f1c&amp;scene=21#wechat_redirect" data-linktype="2">单细胞+芯片+转录组测序的数据挖掘文章一比一复现</a>，<strong>内容非常详实，理论上该流程可以复用到然后一个癌症或者其它疾病，大纲也很清晰（单细胞数据分析本身往往是数据挖掘课题的一个环节而已）</strong>，接下来继续更新另外一个癌症的复现，大纲不一样哦，大家一定要抽空刷完这波：</p><p><img data-galleryid="" data-ratio="1.690721649484536" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wySkQPSD3icBAsric5lhfzKWUBbqc9cRwVtia5ruDGHcMymJ7p7ZZVwOdSYgJo3OYNmWpnTBCl2YRl9w/640?wx_fmt=png" data-type="png" data-w="582" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wySkQPSD3icBAsric5lhfzKWUBbqc9cRwVtia5ruDGHcMymJ7p7ZZVwOdSYgJo3OYNmWpnTBCl2YRl9w/640?wx_fmt=png"></p></blockquote></section><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器"><strong>文章图表复现： Integration of scRNA-Seq and Bulk RNA-Seq to Analyse the Heterogeneity of Ovarian Cancer Immune Cells and Establish a Molecular Risk Model</strong></p><p data-tool="mdnice编辑器"><strong>文章大概思路如下：</strong></p><ol data-tool="mdnice编辑器"><li><section>对ssRNA数据降维、分群、注释</section></li><li><section>用GSVA对鉴定到的T细胞，B细胞，髓系细胞继续细分，发现了两种关键的细胞类型</section></li><li><section>对TCGA数据进行免疫浸润分析，发现其中一种细胞的比例与生存密切相关</section></li><li><section>用WGCNA分析找到与该细胞相关的hub gene</section></li><li><section>下载imvigor 210队列数据，用SVM模型预测免疫表型</section></li><li><section>用NMF把TCGA样本分为两个亚组，该细胞在这两个亚组的比例有显著差异</section></li><li><section>批量单因素cox回归找出hub gene中与生存相关的gene</section></li><li><section>lasso回归进一步筛选gene</section></li><li><section>多因素cox回归，计算riskScore，riskScore与生存信息的相关性</section></li></ol><h3 data-tool="mdnice编辑器"><span>具体复现流程</span></h3><h3 data-tool="mdnice编辑器">1. 细胞分群注释<span></span></h3><p data-tool="mdnice编辑器">首先下载数据，文章中用了两个scRNA数据集，GSE154600和GES158937</p><p data-tool="mdnice编辑器">普通点击下载太慢了，点进NCBI的FTP站点， 在linux上用axel下载会快很多</p><figure data-tool="mdnice编辑器"><img data-ratio="0.27419354838709675" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZAQIESKcoCeuWjibfUhs68hHzoLgR1Ib1Vd6eK5OckhekM8c2pdf9ibCA/640?wx_fmt=png" data-type="png" data-w="868" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZAQIESKcoCeuWjibfUhs68hHzoLgR1Ib1Vd6eK5OckhekM8c2pdf9ibCA/640?wx_fmt=png"><figcaption>网页显示</figcaption></figure><p data-tool="mdnice编辑器">把数据整理成下图标准格式就可以读取了</p><figure data-tool="mdnice编辑器"><img data-ratio="0.42244897959183675" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZ0KZSz9YXJNjBpRAHI4TrX26gSdERjtXOWk7Sy4BaY6dGBnRWxOwnNg/640?wx_fmt=png" data-type="png" data-w="490" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZ0KZSz9YXJNjBpRAHI4TrX26gSdERjtXOWk7Sy4BaY6dGBnRWxOwnNg/640?wx_fmt=png"><figcaption>数据标准格式</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code>library(Seurat)<br>library(stringr)<br>library(clustree)<br>library(dplyr)<br>library(GSVA)<br>library(msigdbr)<br>library(GSEABase)<br>library(pheatmap)<br>library(harmony)<br>rm(list = ls())<br>gc()<br><br><span># 1. 循环读取每个样本的数据</span><br>filename &lt;- paste(<span>'processed_data/'</span>,list.files(<span>'processed_data/'</span>),sep = <span>''</span>)<br>sceList &lt;- lapply(filename, <span>function</span>(x){<br>  obj &lt;- CreateSeuratObject(counts = Read10X(x),<br>                            project = str_split(x,<span>'/'</span>)[[1]][2])<br>})<br>names(sceList) &lt;- list.files(<span>'processed_data/'</span>)<br>sce &lt;- merge(sceList[[1]],sceList[-1],add.cell.ids = names(sceList),project=<span>'OC'</span>)<br>dim(sce) <span># 38224个gene， 67323个cell</span><br></code></pre><p data-tool="mdnice编辑器">简单过滤后，看下PCA，有明显批次效应</p><pre data-tool="mdnice编辑器"><span></span><code><span># 2. 查看线粒体(MT开头)、核糖体(RPS/RPL开头)基因占比</span><br>grep(<span>'^MT'</span>,x=rownames(sce@assays<span>$RNA</span>@data),value = T)<br>grep(<span>'^RP[SL]'</span>,x=rownames(sce@assays<span>$RNA</span>@data),value = T)<br><br>sce &lt;- PercentageFeatureSet(sce,pattern = <span>'^MT'</span>,col.name = <span>'percent.MT'</span>)<br>sce &lt;- PercentageFeatureSet(sce,pattern = <span>'^RP[SL]'</span>,col.name = <span>'percent.RP'</span>)<br>VlnPlot(sce,features = <span>'percent.MT'</span>,pt.size = 0)<br>VlnPlot(sce,features = <span>'percent.RP'</span>,pt.size = 0)<br>VlnPlot(sce,features = <span>'nCount_RNA'</span>,pt.size = 0)<br>VlnPlot(sce,features = <span>'nFeature_RNA'</span>,pt.size = 0)<br><span># 3. 过滤细胞</span><br>sce &lt;- subset(sce,subset = nCount_RNA&gt;3000 &amp; nFeature_RNA&gt;300 &amp; percent.MT&lt;40)<br>dim(sce) <span># 38224个gene， 29389个cell</span><br><span># 4. 过滤gene</span><br>sce &lt;- sce[rowSums(sce@assays<span>$RNA</span>@counts&gt;0)&gt;3,]<br>dim(sce) <span># 28074个gene， 29389个cell</span><br><br><span># 5. 看下批次效应</span><br>sce &lt;- NormalizeData(sce) <span># 默认用logNormalize</span><br>sce &lt;- FindVariableFeatures(sce) <span># 默认选Top2000作为高变gene</span><br>sce &lt;- ScaleData(sce) <span># 默认用variableFeature进行scale</span><br>sce &lt;- RunPCA(sce) <span># 默认用variableFeature进行PCA降维，降维前一定要做scale</span><br>DimPlot(sce,reduction = <span>'pca'</span>,group.by = <span>'orig.ident'</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-ratio="0.693200663349917" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZC2Uribx4iaS8DYj7b20WecDFicFtPz4c0TXjkvbHxPicongCr5mRZ274XQ/640?wx_fmt=png" data-type="png" data-w="603" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZC2Uribx4iaS8DYj7b20WecDFicFtPz4c0TXjkvbHxPicongCr5mRZ274XQ/640?wx_fmt=png">原文中用SCTransform进行数据标准化，那再用SCTransform做一遍</p><p data-tool="mdnice编辑器">运行完了后，在assay下面，除了RNA外还多了一个SCT，然后默认的assay也变成了‘SCT’</p><p data-tool="mdnice编辑器">再看看PCA结果，批次效应貌似也好了些</p><pre data-tool="mdnice编辑器"><span></span><code><span># 6. SCTransform进行标准化</span><br>sce &lt;- SCTransform(sce) <span># 这一步包含了NormalizeData 、ScaleData、FindVariableFeatures三步</span><br>DefaultAssay(sce)<br>sce &lt;- RunPCA(sce)<br>DimPlot(sce,reduction = <span>'pca'</span>,group.by = <span>'orig.ident'</span>)<br>ElbowPlot(sce,ndims = 40)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5281899109792285" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZbq1uicuRkm5CRpcNFRPuCgb6S1WBU28g3WyQq6GuRicA1XgL0ehLIlYA/640?wx_fmt=png" data-type="png" data-w="674" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZbq1uicuRkm5CRpcNFRPuCgb6S1WBU28g3WyQq6GuRicA1XgL0ehLIlYA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><img data-ratio="0.7003311258278145" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZKFBz7HibqHZzyIjp3DpWOUQSv5u9YUSibdniaHo6KOFTl37U7jroUeEzw/640?wx_fmt=png" data-type="png" data-w="604" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZKFBz7HibqHZzyIjp3DpWOUQSv5u9YUSibdniaHo6KOFTl37U7jroUeEzw/640?wx_fmt=png">这里选择resolution为0.4，20个cluster，跟文章中差不多</p><p data-tool="mdnice编辑器">从样本进行区分的umap图上来看，貌似还是有批次效应，其实可以再SCTransform之前再增加一步去批次效应的步骤，这里就略过了</p><pre data-tool="mdnice编辑器"><span></span><code><span># 7. 在PCA基础上进行umap降维,然后分群</span><br>sce &lt;- RunUMAP(sce,reduction = <span>'pca'</span>,dims = 1:40)<br>sce &lt;- FindNeighbors(sce,dims = 1:40)<br><br>sce_res &lt;- sce<br><span>for</span> (i <span>in</span> c(0.01, 0.05, 0.1, 0.15, 0.2, 0.3,0.4, 0.5,0.8,1)){<br>  sce_res &lt;- FindClusters(sce_res,resolution = i)<br>}<br>clustree(sce_res,prefix = <span>'SCT_snn_res.'</span>)<br><br>sce &lt;- FindClusters(sce,resolution = 0.4)<br>DimPlot(sce,reduction = <span>'umap'</span>,group.by = <span>'seurat_clusters'</span>,label = T)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6920529801324503" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZB7qNfk0SiamltInNbmedk3WuiaPjfebSk4c1Wib0w1njWPBYZD9DmQGoQ/640?wx_fmt=png" data-type="png" data-w="604" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZB7qNfk0SiamltInNbmedk3WuiaPjfebSk4c1Wib0w1njWPBYZD9DmQGoQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.6983333333333334" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZx7a7Kmb93F2qwhWEEfqXyloVvz0Pt1mpFnfLsuibd2LjermKQglTNTQ/640?wx_fmt=png" data-type="png" data-w="600" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZx7a7Kmb93F2qwhWEEfqXyloVvz0Pt1mpFnfLsuibd2LjermKQglTNTQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">细胞注释完了后，把每个细胞的注释结果添加到metadata里</p><pre data-tool="mdnice编辑器"><span></span><code><span># 8. 手动进行细胞注释</span><br><br><span># 免疫细胞  5,6,8,9,15,20 </span><br>DotPlot(sce,features = c(<span>'PTPRC'</span>,<span>'CD45'</span>))<br><span># T细胞   0,[8],9,13</span><br>DotPlot(sce,features = c(<span>'CD3D'</span>,<span>'CD3E'</span>,<span>'CD8A'</span>)) <br><span># B细胞   14,16,18,[20]</span><br>DotPlot(sce,features = c(<span>'CD79A'</span>, <span>'CD37'</span>, <span>'CD19'</span>, <span>'CD79B'</span>, <span>'MS4A1'</span>,<span>'CD20'</span>))<br><span># 浆细胞 [14,16,18]</span><br>DotPlot(sce,features = c(<span>'IGHG1'</span>,<span>'MZB1'</span>,<span>'SDC1'</span>,<span>'CD79A'</span>))<br><span># NK细胞  5,[9,15]</span><br>DotPlot(sce,features = c(<span>'FGFBP2'</span>,<span>'FCG3RA'</span>,<span>'CX3CR1'</span>))<br><span># NK细胞  8,15</span><br>DotPlot(sce,features = c(<span>'CD160'</span>,<span>'NKG7'</span>,<span>'GNLY'</span>,<span>'CD247'</span>,<span>'CCL3'</span>,<span>'GZMB'</span>,<span>'CXCR1'</span>,<span>'TYOB'</span>,<span>'PRF1'</span>))<br><span># 内皮细胞 [11]</span><br>DotPlot(sce,features = c(<span>'PECAM1'</span>,<span>'VWF'</span>))<br><span># 成纤维细胞 [0,7],10,11</span><br>DotPlot(sce,features = c(<span>'FGF7'</span>,<span>'MME'</span>,<span>'DCN'</span>,<span>'LUM'</span>,<span>'GSN'</span>,<span>'PF4'</span>,<span>'PPBP'</span>))<br><span># 上皮细胞 1,2,[3],4,[12,13,17,19]</span><br>DotPlot(sce,features = c(<span>'EPCAM'</span>,<span>'KRT19'</span>,<span>'PROM1'</span>,<span>'ALDH1A1'</span>,<span>'CD24'</span>))<br><span># 单核细胞和巨噬细胞 5,6,9,15</span><br>DotPlot(sce,features = c(<span>'CD68'</span>,<span>'CD163'</span>,<span>'CD14'</span>,<span>'LYZ'</span>))<br><span># Ovarian somatic cell  [13]</span><br>DotPlot(sce,features = c(<span>'LGR5'</span>))<br><br>marker &lt;- data.frame(cluster = 0:20,cell = 0:20)<br>marker[marker<span>$cluster</span> %<span>in</span>% c(5,6,8,9,15,20),2] &lt;- <span>'Immune cells'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(0,8,9,13),2] &lt;- <span>'T cells'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(14,16,18,20),2] &lt;- <span>'B cells'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(14,16,18),2] &lt;- <span>'plasma cells'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(5,9,15),2] &lt;- <span>'NK cells'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(11),2] &lt;- <span>'Endothelial cells'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(5,6),2] &lt;- <span>'myeloid cells'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(1,2,3,4,12,13,17,19),2] &lt;- <span>'epithelial cell'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(0,7,10),2] &lt;- <span>'fibroblast'</span><br>marker[marker<span>$cluster</span> %<span>in</span>% c(13),2] &lt;- <span>'Ovarian somatic cell'</span><br><br>sce@meta.data<span>$cell_type</span> &lt;- sapply(sce@meta.data<span>$seurat_clusters</span>,<span>function</span>(x){marker[x,2]})<br>DimPlot(sce,reduction = <span>'umap'</span>,group.by = <span>'cell_type'</span>,label = T)<br><br><span># 9. marker gene 热图展示</span><br>heatmap_marker_gene &lt;- c(<span>'CD3D'</span>,<span>'CD3E'</span>,<span>'CD8A'</span>,<br>                         <span>'CD79A'</span>, <span>'CD19'</span>, <span>'CD79B'</span>, <span>'MS4A1'</span>,<span>'CD20'</span>,<br>                         <span>'MZB1'</span>,<span>'SDC1'</span>,<span>'CD79A'</span>,<br>                         <span>'CD68'</span>,<span>'CD163'</span>,<span>'CD14'</span>,<span>'LYZ'</span>)<br>heatmap_cells &lt;- rownames(sce@meta.data[sce@meta.data<span>$cell_type</span> %<span>in</span>% c(<span>"myeloid cells"</span>,<span>"B cells"</span>,<span>"T cells"</span>),])<br>sub_sce &lt;- subset(sce,cells = heatmap_cells)<br>DoHeatmap(sub_sce,features = heatmap_marker_gene,group.by = <span>'cell_type'</span>,size = 3)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6968698517298187" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmVzvUticqTqqrrEUrj2c66aKOy0u224AJQBzc5L4dkUBvZ7RV3a4w2Q/640?wx_fmt=png" data-type="png" data-w="607" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmVzvUticqTqqrrEUrj2c66aKOy0u224AJQBzc5L4dkUBvZ7RV3a4w2Q/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.6694630872483222" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZ11pRmdVoAicqFpkxPZmFowfkYicxQ6gZ2ZHmUgicpWX4tonPxgsjtGlmQ/640?wx_fmt=png" data-type="png" data-w="596" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZ11pRmdVoAicqFpkxPZmFowfkYicxQ6gZ2ZHmUgicpWX4tonPxgsjtGlmQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>2.用GSVA对鉴定到的T细胞，B细胞，髓系细胞继续细分，发现了两种关键的细胞类型<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 10. GSVA分析</span><br><br>Hallmark_gene_set &lt;- msigdbr(species = <span>'Homo sapiens'</span>,category = <span>'H'</span>)<br>Hallmark_list &lt;- split(Hallmark_gene_set<span>$gene_symbol</span>,Hallmark_gene_set<span>$gs_name</span>)<br><br>gsva_res &lt;- gsva(expr = sce@assays<span>$SCT</span>@scale.data,<br>                 gset.idx.list = Hallmark_list,<br>                 method = <span>'ssgsea'</span>,<br>                 kcdf=<span>'Poisson'</span>,<br>                 parallel.sz = parallel::detectCores())<br>pheatmap(gsva_res,fontsize_row = 4,<br>         height = 10,<br>         width=18,<br>         annotation_col = data.frame(row.names = colnames(sce),group=sce@meta.data<span>$orig</span>.ident),<br>         show_colnames = F,<br>         show_rownames = T)<br></code></pre><p data-tool="mdnice编辑器">文中作者鉴定出T细胞，B细胞和髓系细胞后，用GSVA再进行细分，采用的基因集就是msigdb的Hallmark gene set。</p><p data-tool="mdnice编辑器">这里读入的hallmark_gene_set是一个8209*15的data frame，找出它的gene symbol和gene set name这两列，用split函数把它转换成一个列表，这样hallmark_list是一个长度为length(unique(Hallmark_gene_set$gs_name))的list，其中hallmark_list的每一项都是某一gs_name对应的所有gene_symbol，只需要把表达矩阵和gene list传递给gsva函数即可进行gsva分析</p><figure data-tool="mdnice编辑器"><img data-ratio="0.556" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZfsg5h7THg8oo8pHQxgWziaMnm7WzohoUluibfjbdCeDuh7JxSLOMVMRA/640?wx_fmt=png" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZfsg5h7THg8oo8pHQxgWziaMnm7WzohoUluibfjbdCeDuh7JxSLOMVMRA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">但是<strong>简单看了下hallmark gene set的名字，根据这些gene set似乎没法对T细胞和B细胞再进行细分</strong>，不太清楚作者是怎么做的</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5907216494845361" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZcPxIY7N5WJwvj6nlIkALJTkoOcH3lOnrnW2hD8bOibLmPmtsAJR5amA/640?wx_fmt=png" data-type="png" data-w="970" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZcPxIY7N5WJwvj6nlIkALJTkoOcH3lOnrnW2hD8bOibLmPmtsAJR5amA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">于是发现了<strong>另一个基因集C8</strong></p><p data-tool="mdnice编辑器">一共700个基因集，看下和T细胞，B细胞相关的基因集</p><p data-tool="mdnice编辑器">并不是很多，和OV相关的也没有，感觉也不太合适，于是<strong>决定上cellmarker自己下载基因集</strong></p><pre data-tool="mdnice编辑器"><strong><span></span></strong><code>cell_type_gene_set &lt;- msigdbr(species = <span>'Homo sapiens'</span>,category = <span>'C8'</span>)<br>cell_type_list &lt;- split(cell_type_gene_set<span>$gene_symbol</span>,cell_type_gene_set<span>$gs_name</span>)<br>names(cell_type_list)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.4568452380952381" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZcrKP7ibct0QzWhTKJR9ialKHSN3s5kNlWIktrp5tzsLrcFrQDx5wAhMQ/640?wx_fmt=png" data-type="png" data-w="672" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZcrKP7ibct0QzWhTKJR9ialKHSN3s5kNlWIktrp5tzsLrcFrQDx5wAhMQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.09722222222222222" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmTibpC1aOCQI7TmFsfA3I8rzHibGfffZjl2d6YveiciaqUX7gm19yQM9XA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmTibpC1aOCQI7TmFsfA3I8rzHibGfffZjl2d6YveiciaqUX7gm19yQM9XA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>搜出来直接点击就可以下载了</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.4080536912751678" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZAxX8TdUibpWkpIGu5Gib6AtS1RNSGibfmb7qGGJYAlNNJhp3bgyeWdibKQ/640?wx_fmt=png" data-type="png" data-w="745" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZAxX8TdUibpWkpIGu5Gib6AtS1RNSGibfmb7qGGJYAlNNJhp3bgyeWdibKQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.5638888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZUhiaibxNIv86VbUd6stx8hPActuZ27eeic94Q6R3QHqpiakNXOWGgE5ibZw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZUhiaibxNIv86VbUd6stx8hPActuZ27eeic94Q6R3QHqpiakNXOWGgE5ibZw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>t_cell_marker &lt;- read.table(<span>'CellMarker_T_cell.csv'</span>,sep = <span>','</span>,header = 1)<br>b_cell_marker &lt;- read.table(<span>'CellMarker_B_cell.csv'</span>,sep = <span>','</span>,header = 1)<br>macrophage_marker &lt;- read.table(<span>'CellMarker_Macrophage.csv'</span>,sep = <span>','</span>,header = 1)<br></code></pre><p data-tool="mdnice编辑器">读进来是这样的一个表格，<strong>species中除了人还有小鼠的</strong>，就根据cell type和cell marker这两列去构建gene list，<strong>只要保证最后构建出来的gene list的每一项是一个包含gene symbol的vector</strong>，然后每一项的名字是对应的细胞类型就可以了，我写的比较复杂，大家可以自己发挥</p><p data-tool="mdnice编辑器"><strong>需要注意的有几点：</strong></p><ol data-tool="mdnice编辑器"><li><section>cellmarker这一列里，有多个gene的话，多个gene是一个字符串，需要自己拆开，添加到一个vector里</section></li><li><section>CD4+ T cell可能包含Activated CD4+ T cell和Effector CD4+ T cell，可以把它们对应的gene都合并成一个vector</section></li></ol><figure data-tool="mdnice编辑器"><img data-ratio="0.17407407407407408" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZLHAibRlaR6Ff1YXfhXATSOwWuWjssLHicHyv5seN6a2n2CW2VyvDJlMA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZLHAibRlaR6Ff1YXfhXATSOwWuWjssLHicHyv5seN6a2n2CW2VyvDJlMA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>t_cell_marker &lt;- t_cell_marker[t_cell_marker<span>$Species</span>==<span>'Human'</span>,]<br>b_cell_marker &lt;- b_cell_marker[b_cell_marker<span>$Species</span>==<span>'Human'</span>,]<br>macrophage_marker &lt;- macrophage_marker[macrophage_marker<span>$Species</span>==<span>'Human'</span>,]<br><br><span># T cell 挑了4种进行热图展示</span><br>cytotoxic &lt;- unique(t_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(t_cell_marker<span>$Cell</span>.Type)),<span>'cytotoxic'</span>)]<br>naive &lt;- unique(t_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(t_cell_marker<span>$Cell</span>.Type)),<span>'naive'</span>)]<br>regulatory &lt;- unique(t_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(t_cell_marker<span>$Cell</span>.Type)),<span>'regulatory'</span>)]<br>exhausted &lt;- unique(t_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(t_cell_marker<span>$Cell</span>.Type)),<span>'exhausted'</span>)]<br>t_cell_df &lt;- t_cell_marker[t_cell_marker<span>$Cell</span>.Type %<span>in</span>% c(cytotoxic,naive,regulatory,exhausted),]<br>t_cell_df[t_cell_df<span>$Cell</span>.Type %<span>in</span>% naive,<span>"Cell.Type"</span>] &lt;- <span>'naive'</span><br>t_cell_df[t_cell_df<span>$Cell</span>.Type %<span>in</span>% cytotoxic,<span>"Cell.Type"</span>] &lt;- <span>'cytotoxic'</span><br>t_cell_df[t_cell_df<span>$Cell</span>.Type %<span>in</span>% regulatory,<span>"Cell.Type"</span>] &lt;- <span>'regulatory'</span><br>t_cell_df[t_cell_df<span>$Cell</span>.Type %<span>in</span>% exhausted,<span>"Cell.Type"</span>] &lt;- <span>'exhausted'</span><br>t_cell_list &lt;- split(t_cell_df<span>$Cell</span>.Marker,t_cell_df<span>$Cell</span>.Type)<br><br><span># B cell 挑了5种进行热图展示</span><br>unique(b_cell_marker<span>$Cell</span>.Type)<br>b_plasma &lt;- unique(b_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(b_cell_marker<span>$Cell</span>.Type)),<span>'plasma'</span>)]<br>b_memory &lt;- unique(b_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(b_cell_marker<span>$Cell</span>.Type)),<span>'memory'</span>)]<br>b_naive &lt;- unique(b_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(b_cell_marker<span>$Cell</span>.Type)),<span>'naive'</span>)]<br>b_activated &lt;- unique(b_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(b_cell_marker<span>$Cell</span>.Type)),<span>'activated'</span>)]<br>b_transitional &lt;- unique(b_cell_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(b_cell_marker<span>$Cell</span>.Type)),<span>'transitional'</span>)]<br><br>b_cell_df &lt;- b_cell_marker[b_cell_marker<span>$Cell</span>.Type %<span>in</span>% c(b_plasma,b_memory,b_naive,b_activated,b_transitional),]<br>b_cell_df[b_cell_df<span>$Cell</span>.Type %<span>in</span>% b_plasma,<span>"Cell.Type"</span>] &lt;- <span>'plasma'</span><br>b_cell_df[b_cell_df<span>$Cell</span>.Type %<span>in</span>% b_memory,<span>"Cell.Type"</span>] &lt;- <span>'memory'</span><br>b_cell_df[b_cell_df<span>$Cell</span>.Type %<span>in</span>% b_naive,<span>"Cell.Type"</span>] &lt;- <span>'naive'</span><br>b_cell_df[b_cell_df<span>$Cell</span>.Type %<span>in</span>% b_activated,<span>"Cell.Type"</span>] &lt;- <span>'activated'</span><br>b_cell_df[b_cell_df<span>$Cell</span>.Type %<span>in</span>% b_transitional,<span>"Cell.Type"</span>] &lt;- <span>'transitional'</span><br>b_cell_list &lt;- split(b_cell_df<span>$Cell</span>.Marker,b_cell_df<span>$Cell</span>.Type)<br><br><span># Macrophage cell</span><br>unique(macrophage_marker<span>$Cell</span>.Type)<br>M1 &lt;- unique(macrophage_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(macrophage_marker<span>$Cell</span>.Type)),<span>'m1'</span>)]<br>M2 &lt;- unique(macrophage_marker<span>$Cell</span>.Type)[str_detect(str_to_lower(unique(macrophage_marker<span>$Cell</span>.Type)),<span>'m2'</span>)]<br>macrophage_df &lt;- macrophage_marker[macrophage_marker<span>$Cell</span>.Type %<span>in</span>% c(M1,M2),]<br>macrophage_list &lt;- split(macrophage_df<span>$Cell</span>.Marker,macrophage_df<span>$Cell</span>.Type)<br><br><span># 到这一步，gene list里的每一项，是一个字符串（gene symbol组成的）组成的vector，我写个函数，把每个字符串里的gene symbol拆出来，</span><br><span># 最后组合成一个由gene symbol组成的vector，然后去个重</span><br>myfun &lt;- <span>function</span>(x){<br>  res &lt;- c()<br>  <span>for</span> (i <span>in</span> x){<br>    temp &lt;- unlist(str_split(gsub(<span>' '</span>,<span>''</span>,i),<span>','</span>))<br>    res &lt;- c(res,temp)<br>  }<br>  unique(res)<br>}<br><br>t_cell_list &lt;- lapply(t_cell_list, <span>function</span>(x){myfun(x)})<br>b_cell_list &lt;- lapply(b_cell_list, <span>function</span>(x){myfun(x)})<br>macrophage_list &lt;- lapply(macrophage_list, <span>function</span>(x){myfun(x)})<br><br><span># 找到三种细胞分别对应的表达矩阵</span><br>t_cell &lt;- colnames(sce[,sce@meta.data<span>$cell_type</span>==<span>'T cells'</span>])<br>b_cell &lt;- colnames(sce[,sce@meta.data<span>$cell_type</span>==<span>'B cells'</span>])<br>macrophage_cell &lt;- colnames(sce[,sce@meta.data<span>$cell_type</span>==<span>'myeloid cells'</span>])<br><br>t_cell_exp &lt;- sce@assays<span>$SCT</span>@scale.data[,t_cell]<br>b_cell_exp &lt;- sce@assays<span>$SCT</span>@scale.data[,b_cell]<br>macrophage_cell_exp &lt;- sce@assays<span>$SCT</span>@scale.data[,macrophage_cell]<br><br>t_cell_gsva_res &lt;- gsva(expr = t_cell_exp,<br>                           gset.idx.list = t_cell_list,<br>                           method = <span>'ssgsea'</span>,<br>                           kcdf=<span>'Poisson'</span>,<br>                           parallel.sz = parallel::detectCores())<br>pheatmap(t_cell_gsva_res,fontsize_row = 8,<br>         height = 10,<br>         width=18,<br>         annotation_col = data.frame(row.names = colnames(sce),group=sce@meta.data<span>$orig</span>.ident),<br>         show_colnames = F,show_rownames = T,cluster_cols = F)<br><br>b_cell_gsva_res &lt;- gsva(expr = b_cell_exp,<br>                        gset.idx.list = b_cell_list,<br>                        method = <span>'ssgsea'</span>,<br>                        kcdf=<span>'Poisson'</span>,<br>                        parallel.sz = parallel::detectCores())<br><br>pheatmap(b_cell_gsva_res,fontsize_row = 8,<br>         height = 10,<br>         width=18,<br>         annotation_col = data.frame(row.names = colnames(sce),group=sce@meta.data<span>$orig</span>.ident),<br>         show_colnames = F,show_rownames = T,cluster_cols = F)<br><br>macrophage_cell_gsva_res &lt;- gsva(expr = macrophage_cell_exp,<br>                        gset.idx.list = macrophage_list,<br>                        method = <span>'ssgsea'</span>,<br>                        kcdf=<span>'Poisson'</span>,<br>                        parallel.sz = parallel::detectCores())<br><br>pheatmap(macrophage_cell_gsva_res,fontsize_row = 8,<br>         height = 10,<br>         width=18,<br>         annotation_col = data.frame(row.names = colnames(sce),group=sce@meta.data<span>$orig</span>.ident),<br>         show_colnames = F,show_rownames = T,cluster_cols = F)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6945337620578779" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZnyCianvjBbic8yxXibrOZvehDIZYITR87tj7S2CRq9yb5YwicvUZ886fhg/640?wx_fmt=png" data-type="png" data-w="622" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZnyCianvjBbic8yxXibrOZvehDIZYITR87tj7S2CRq9yb5YwicvUZ886fhg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.6995153473344103" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZibx4Wf24D9TeOiaXCPGCCeMN16VN78aq5YrlmEIUR370HSGNFmlVicThQ/640?wx_fmt=png" data-type="png" data-w="619" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZibx4Wf24D9TeOiaXCPGCCeMN16VN78aq5YrlmEIUR370HSGNFmlVicThQ/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.7012987012987013" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZuWYCumkVzQNhoxG4tGcXHxB5exBEcBmicaYFibKsOD14DnuXfMLJkBsA/640?wx_fmt=png" data-type="png" data-w="616" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZuWYCumkVzQNhoxG4tGcXHxB5exBEcBmicaYFibKsOD14DnuXfMLJkBsA/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>3. 对TCGA数据进行免疫浸润分析，发现其中一种细胞的比例与生存密切相关<span></span></h3><p data-tool="mdnice编辑器">首先<strong>下载TCGA数据</strong></p><p data-tool="mdnice编辑器"><strong>在Xena的datasets找到OV相关的数据集，点进去后下载了FPKM数据</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.5595432300163132" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZzXfThO8kXmz0P0WJh21QiaoYMZLcg4tibDbArWmJ1N2ickNUJoRbxqkJw/640?wx_fmt=png" data-type="png" data-w="613" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZzXfThO8kXmz0P0WJh21QiaoYMZLcg4tibDbArWmJ1N2ickNUJoRbxqkJw/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.6566265060240963" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZ3gn3QXmH3csFVGRmzxzAZJJGwE9YrsuAFsygQIqqBVfERpY1v6d7Kw/640?wx_fmt=png" data-type="png" data-w="996" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZ3gn3QXmH3csFVGRmzxzAZJJGwE9YrsuAFsygQIqqBVfERpY1v6d7Kw/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>把行名从emsembl改成symbol之后，就可以分析了</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>#加载需要的R包</span><br>library(TCGAbiolinks)<br>library(WGCNA)<br>library(stringr)<br>library(SummarizedExperiment)<br>library(clusterProfiler)<br>library(org.Hs.eg.db)<br>library(tibble)<br>library(CIBERSORT)<br>library(tidyr)<br>library(ggplot2)<br>library(RColorBrewer)<br>library(readxl)<br>library(survival)<br>library(survminer)<br>library(WGCNA)<br>library(data.table)<br>library(dplyr)<br>library(IMvigor210CoreBiologies)<br>library(e1071)<br>library(pROC)<br>library(NMF)<br>library(pheatmap)<br>library(clusterProfiler)<br>library(ggsignif)<br>library(limma)<br>library(org.Hs.eg.db)<br>library(glmnet)<br>library(tibble)<br>library(ggrisk)<br><br>rm(list = ls())<br>gc()exp &lt;- fread(<span>'TCGA-OV.htseq_fpkm.tsv'</span>,header = T)<br>exp &lt;- column_to_rownames(exp,var = <span>'Ensembl_ID'</span>)<br><br><span># 行名转换</span><br>exp &lt;- as.data.frame(exp)<br>exp<span>$ensembl_id</span> &lt;- str_split(rownames(exp),<span>'\\.'</span>,simplify = T)[,1]<br>id_df &lt;- bitr(exp<span>$ensembl_id</span>,fromType = <span>'ENSEMBL'</span>,toType = <span>'SYMBOL'</span>,OrgDb = org.Hs.eg.db)<br>id_df &lt;- id_df[!duplicated(id_df<span>$ENSEMBL</span>),]<br>index &lt;- match(exp<span>$ensembl_id</span>,id_df<span>$ENSEMBL</span>)<br><span># 对symbol id这一列去重去空，设为行名</span><br>exp<span>$symbol_id</span> &lt;- id_df[index,<span>'SYMBOL'</span>]<br>exp &lt;- exp[!is.na(exp<span>$symbol_id</span>),]<br>exp &lt;- exp[!duplicated(exp<span>$symbol_id</span>),]<br>rownames(exp) &lt;- exp<span>$symbol_id</span><br>exp &lt;- exp[,1:(ncol(exp)-2)]<br><br>save(exp,file = <span>'TCGA_OV.Rdata'</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>免疫浸润</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 免疫浸润</span><br>load(<span>'TCGA_OV.Rdata'</span>)<br>lm22f &lt;- system.file(<span>'extdata'</span>,<span>'LM22.txt'</span>,package = <span>'CIBERSORT'</span>)<br>TME.result &lt;- cibersort(lm22f,as.matrix(exp),perm = 100,QN=T)<br>TME.result &lt;- as.data.frame(TME.result)<br>save(result,file = <span>'TME_result.Rdata'</span>)<br><br>group &lt;- ifelse(as.numeric(substr(colnames(exp),14,15))&lt;10,<span>'tumor'</span>,<span>'normal'</span>)<br>patient_exp &lt;- exp[,<span>which</span>(group==<span>'tumor'</span>)]<br>result &lt;- TME.result[,-c(23:25)] %&gt;% as.data.frame() %&gt;% <br>  rownames_to_column(<span>'Sample'</span>) %&gt;% gather(key = cell_type,value = proportion,-Sample)<br><br>my_pallet &lt;- colorRampPalette(brewer.pal(8,<span>'Set1'</span>))<br>ggplot(result,aes(Sample,proportion,fill=cell_type))+geom_bar(<span>stat</span> = <span>'identity'</span>)+<br>  scale_fill_manual(values = my_pallet(22))+<br>  labs(x=<span>''</span>,y = <span>"Estiamted Proportion"</span>,fill=<span>'cell_type'</span>)+theme_bw()+<br>  theme(axis.text.x = element_blank(),<br>        axis.ticks.x = element_blank(),<br>        legend.position = <span>"bottom"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6916666666666667" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZjmYaKsph4UEF1DicqRbh99dSdLHYzKhKE4n5n5YVVaRbVfDT72KbPyA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZjmYaKsph4UEF1DicqRbh99dSdLHYzKhKE4n5n5YVVaRbVfDT72KbPyA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">cibersort计算了每种免疫细胞在每个样本中的丰度值，接下来要看看M1和M2这两种细胞对生存的影响</p><p data-tool="mdnice编辑器">首先下载临床信息数据，从里面找到OV相关的临床信息即可</p><figure data-tool="mdnice编辑器"><img data-ratio="0.8586525759577279" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZrTJvjoh2H0N6Vpp3yY7CJf2IbrV322Lvvpv2F5duuULibnibhCOg68GA/640?wx_fmt=png" data-type="png" data-w="757" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZrTJvjoh2H0N6Vpp3yY7CJf2IbrV322Lvvpv2F5duuULibnibhCOg68GA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>文中作者应该是分析了M1和M2两种细胞，然后发现只有M1与生存信息显著相关</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># KM-plot</span><br>load(<span>'TCGA_OV.Rdata'</span>)<br>load(<span>'TME_result.Rdata'</span>)<br><span># 准备生存数据，包含OS,OS.time,DFI,DFI.time这些信息</span><br><span># https://gdc.cancer.gov/about-data/publications/pancanatlas</span><br>sur_data &lt;- read_xlsx(<span>'TCGA-CDR-SupplementalTableS1.xlsx'</span>,sheet = 1)<br>sur_data &lt;- column_to_rownames(sur_data,var = <span>'...1'</span>)<br>sur_data &lt;- sur_data[sur_data<span>$type</span>==<span>'OV'</span>,c(<span>'bcr_patient_barcode'</span>,<span>'OS'</span>,<span>'OS.time'</span>,<span>'DFI'</span>,<span>'DFI.time'</span>)]<br>rownames(sur_data) &lt;- sur_data<span>$bcr_patient_barcode</span><br>save(sur_data,file = <span>'survival_data.Rdata'</span>)<br><span># 建立sample和patient对应关系，把cibersort结果中Macrophages M1在每个样本中的信息转移过来</span><br>sample_patient_df &lt;- data.frame(sample=colnames(exp),patient=substr(colnames(exp),1,12))<br>sample_patient_df<span>$TAM_M1</span> &lt;- TME.result$`Macrophages M1`<br>sample_patient_df<span>$TAM_M1_type</span> &lt;- ifelse(sample_patient_df<span>$TAM_M1</span>&gt;median(sample_patient_df<span>$TAM_M1</span>),<span>'high'</span>,<span>'low'</span>)<br>sample_patient_df &lt;- sample_patient_df[!duplicated(sample_patient_df<span>$patient</span>),]<br><span># 下载的生存数据的临床信息中patient id 与 exp中patient id 取交集</span><br>sur_data &lt;- sur_data[intersect(sample_patient_df<span>$patient</span>,sur_data<span>$bcr_patient_barcode</span>),]<br><span># 把sample_patient_df中Macrophages M1的信息对应到sur_data中每个patient id上</span><br>index &lt;- match(sur_data<span>$bcr_patient_barcode</span>,sample_patient_df<span>$patient</span>)<br>sur_data<span>$TAM_M1</span> &lt;- sample_patient_df[index,<span>'TAM_M1_type'</span>]<br><br>M1_OS &lt;- survfit(Surv(OS.time,OS)~TAM_M1,data = sur_data)<br>ggsurvplot(M1_OS,pval = T,risk.table = T,surv.median.line = <span>'hv'</span>,<br>           title=<span>'Overall survival'</span>,xlab=<span>'Days'</span>)<br>M1_DFI &lt;- survfit(Surv(DFI.time,DFI)~TAM_M1,data = sur_data)<br>ggsurvplot(M1_DFI,pval = T,risk.table = T,surv.median.line = <span>'hv'</span>,<br>           title=<span>'Disease Free Interval'</span>,xlab=<span>'Days'</span>)<br>save(sur_data,file = <span>'sur_data.Rdata'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.5606653620352251" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZBqHCibp7C6RiaSzw7XRibSJANSFqRhTcxOkhNVtFqYh8ANo2u9RBVNqxA/640?wx_fmt=png" data-type="png" data-w="1022" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZBqHCibp7C6RiaSzw7XRibSJANSFqRhTcxOkhNVtFqYh8ANo2u9RBVNqxA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><img data-ratio="0.5589390962671905" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZ6IK6DXX0EJwCnZenHPamtibpaxc4E05orZDah0g7XI5U2gIibY8LHoQA/640?wx_fmt=png" data-type="png" data-w="1018" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZ6IK6DXX0EJwCnZenHPamtibpaxc4E05orZDah0g7XI5U2gIibY8LHoQA/640?wx_fmt=png">生存信息中的行名是patient这一列，TCGA表达矩阵exp中列名是sample这一列，这两列不是一一对应的，一个patient可能对应多个sample。可以考虑直接去重或者手动删除一个病人的多个样本，这样一个病人只对应一个样本，同样也只有一个TAM_M1的丰度信息，就可以进行后续分析了</p><p data-tool="mdnice编辑器">这里我根据TAM_M1的中位数，把样本分为了M1高表达和低表达</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3089983022071307" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZCIw13uD8mT1plG2RnzRAtxMcV6uXC5GM4RlJBs5ETCdXMNkGxvpUaQ/640?wx_fmt=png" data-type="png" data-w="589" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZCIw13uD8mT1plG2RnzRAtxMcV6uXC5GM4RlJBs5ETCdXMNkGxvpUaQ/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>最后的sur_data长这样</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.42280701754385963" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZlFRKUYbCkibBKHUJ647lC9WPr3Zd8bXqykJDwuvOEiaJicdfJ3xZFIzxQ/640?wx_fmt=png" data-type="png" data-w="570" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZlFRKUYbCkibBKHUJ647lC9WPr3Zd8bXqykJDwuvOEiaJicdfJ3xZFIzxQ/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>4. 用WGCNA分析找到与该细胞相关的hub gene<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># WGCNA</span><br>load(<span>'TCGA_OV.Rdata'</span>)<br>load(<span>'TME_result.Rdata'</span>)<br>load(<span>'sur_data.Rdata'</span>)<br>exp &lt;- as.data.frame(exp)<br><br><span># 过滤异常值</span><br>exp &lt;- exp[rowMads(as.matrix(exp))&gt;0.01,]<br>dim(exp)<br><br><span># 查找并删除异常值</span><br>temp &lt;- exp<br>colnames(temp) &lt;- 1:ncol(exp)<br>plot(hclust(dist(t(temp)))) <span># 无异常样本</span><br><br><span># 构建基因共表达网络</span><br>exp &lt;- as.data.frame(t(exp))<br><br><span># 选择合适的power</span><br>sft &lt;- pickSoftThreshold(exp,networkType = <span>'signed'</span>)<br><br>a &lt;- ggplot(sft<span>$fitIndices</span>,aes(x=Power,y=-sign(slope)*SFT.R.sq))+<br>  geom_text(label=sft<span>$fitIndices</span><span>$Power</span>,color=<span>'red'</span>)+<br>  geom_hline(yintercept = 0.9,color=<span>'red'</span>)+<br>  xlab(<span>"Soft Threshold (power)"</span>)+ylab(<span>"Scale Free Topology Model Fit,signed R^2"</span>)+<br>  ggtitle(<span>"Scale independence"</span>)+theme(plot.title = element_text(hjust = 0.5))<br><br>b &lt;- ggplot(sft<span>$fitIndices</span>,aes(x=Power,y=mean.k.))+<br>  geom_text(label=sft<span>$fitIndices</span><span>$Power</span>,color=<span>'red'</span>)+<br>  xlab(<span>"Soft Threshold (power)"</span>)+ylab(<span>"Mean Connectivity"</span>)+<br>  ggtitle(<span>'Mean connectivity'</span>)+theme(plot.title = element_text(hjust = 0.5))<br><br>a+b<br>power &lt;- sft<span>$powerEstimate</span><br>power &lt;- 5<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6970198675496688" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZasXMmN2FxibfxFxGnuugIGSpjic9eMvWzchbazw1aw6njg54jssIxMJA/640?wx_fmt=png" data-type="png" data-w="604" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZasXMmN2FxibfxFxGnuugIGSpjic9eMvWzchbazw1aw6njg54jssIxMJA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 检验是否符合无尺度网络</span><br>k &lt;- softConnectivity(exp,power = power)<br>scaleFreePlot(k)<br><br><span># 构建邻接矩阵</span><br>adj &lt;- adjacency(exp,power = power,<span>type</span> = <span>'signed'</span>)<br><br><span># 计算TOM矩阵</span><br>TOM &lt;- TOMsimilarity(adj,TOMType = <span>'signed'</span>)<br>save(TOM,file = <span>'TOM.Rdata'</span>)<br>load(<span>'TOM.Rdata'</span>)<br><span># 计算gene间相异性</span><br>dissTOM &lt;- 1-TOM<br><br><span># 对gene进行聚类和可视化</span><br>geneTree &lt;- hclust(as.dist(dissTOM),method = <span>'average'</span>)<br>sizeGrWindow(12,9)<br>plot(geneTree,labels = F,hang=0.04,xlab=<span>''</span>,sub=<span>''</span>)<br><br><span># 将聚类树进行修剪，把gene归到不同模块里</span><br>dynamic_module &lt;- cutreeDynamic(dendro = geneTree,distM = dissTOM,minClusterSize = 50,pamRespectsDendro = F)<br>table(dynamic_module)<br>module_color &lt;- labels2colors(dynamic_module)<br>plotDendroAndColors(dendro = geneTree,colors = module_color,dendroLabels = F,hang=0.03,addGuide = T,<br>                    guideHang = 0.05,groupLabels=<span>'Dynamic color tree'</span>,<br>                    main=<span>'gene dendrogram and module colors'</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>随着power的增加，gene之间的连通性降低，取log后成线性关系，符合无尺度网络分布</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.5353535353535354" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZC9gndiaRU60q0lFRhjZga5OxItOaqzQkgSL9EN8K4r69AJfEE37nE1g/640?wx_fmt=png" data-type="png" data-w="594" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZC9gndiaRU60q0lFRhjZga5OxItOaqzQkgSL9EN8K4r69AJfEE37nE1g/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">这里分出来20多个模块，太多了，后面进行合并</p><figure data-tool="mdnice编辑器"><img data-ratio="0.6734006734006734" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZrjk0Xe0IvoeEgmWKDzro3mwa8LbA72Ie7842p1zLzTx8Tq3ibTduOMg/640?wx_fmt=png" data-type="png" data-w="594" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZrjk0Xe0IvoeEgmWKDzro3mwa8LbA72Ie7842p1zLzTx8Tq3ibTduOMg/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 随机选择400个基因画拓扑重叠热图</span><br>set.seed(10)<br>select = sample(5000, size = 400)<br>selectTOM = dissTOM[select, select]<br>selectTree = hclust(as.dist(selectTOM), method = <span>"average"</span>) <br>selectColors = module_color[select]<br><br>sizeGrWindow(9,9) <br>plotDiss = selectTOM^power<br>diag(plotDiss) = NA<br>TOMplot(plotDiss, <br>        selectTree, <br>        selectColors, <br>        main = <span>"Network heatmap plot, selected genes"</span>) <br></code></pre><p data-tool="mdnice编辑器"><strong>默认画出来的是第一张图，如果把plotDiss改成1-plotDiss，可以得到第二张图，颜色越深表示gene相关性越强</strong>。可以看到<strong>相关性较高的gene都是在同一个模块内的</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="1.0071942446043165" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZfeDfaWFFcRzTX0tf6x1Ngt5rIAj1NwXy9GL7r615gkdDaOx6pjyMCQ/640?wx_fmt=png" data-type="png" data-w="417" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZfeDfaWFFcRzTX0tf6x1Ngt5rIAj1NwXy9GL7r615gkdDaOx6pjyMCQ/640?wx_fmt=png"><figcaption>默认结果图</figcaption></figure><figure data-tool="mdnice编辑器"><img data-ratio="1.0192307692307692" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZFwshF0zxVpkDPRSbzHdt8LUwXq9dOicC7qLrbwnAJiagN2k8AZBXjXFw/640?wx_fmt=png" data-type="png" data-w="416" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZFwshF0zxVpkDPRSbzHdt8LUwXq9dOicC7qLrbwnAJiagN2k8AZBXjXFw/640?wx_fmt=png"><figcaption>改掉参数后</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 计算每个模块特征gene向量</span><br>MEList &lt;- moduleEigengenes(exp,dynamic_module)<br>MEs &lt;- MEList<span>$eigengenes</span><br><br><span># 计算特征基因的相异度，基于相异度对原有模块进行层次聚类</span><br>dissME &lt;- 1-cor(MEs)<br>MEtree &lt;- hclust(as.dist(dissME),method = <span>'average'</span>)<br><br><span># 对模块进行合并</span><br>cut_height &lt;- 0.6<br>sizeGrWindow(12,8)<br>plot(MEtree)<br>abline(h=cut_height,col=<span>'red'</span>)<br><br>merge_module &lt;- mergeCloseModules(exprData = exp,colors=module_color,cutHeight = cut_height)<br>merged_color &lt;- merge_module<span>$colors</span><br><span># merged_MEs每一行是一个病人ID，每一列是一个模块的特征gene向量</span><br>merged_MEs &lt;- merge_module<span>$newMEs</span><br><br>sizeGrWindow(12,8)<br>plotDendroAndColors(dendro = geneTree,colors = cbind(module_color,merged_color),dendroLabels = F,hang=0.03,addGuide = T,<br>                    guideHang = 0.05,groupLabels=<span>'Dynamic color tree'</span>,<br>                    main=<span>'gene dendrogram and module colors'</span>)<br>table(merged_color)<br></code></pre><p data-tool="mdnice编辑器">将height在0.6以下的模块进行合并</p><p data-tool="mdnice编辑器">合并模块后，模块数量减少到13个</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5521367521367522" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZFOYWz3OicTKIBy9sTZokXRCvzJL67iaWmzF4B3gGHNqDZdMb8BLdtFtA/640?wx_fmt=png" data-type="png" data-w="585" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZFOYWz3OicTKIBy9sTZokXRCvzJL67iaWmzF4B3gGHNqDZdMb8BLdtFtA/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.5508130081300813" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZQbqkMdevyy1iaUusqOFoD6EZ9AUGPMphIOgPCBxHUckWvicTZCoWlZZQ/640?wx_fmt=png" data-type="png" data-w="984" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZQbqkMdevyy1iaUusqOFoD6EZ9AUGPMphIOgPCBxHUckWvicTZCoWlZZQ/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 计算模块与TAM_M1，TAM_M2间的相关性</span><br>trait &lt;- data.frame(row.names = rownames(exp),ID = substr(rownames(exp),1,12),<br>                    M1 = TME.result$`Macrophages M1`,M2 = TME.result$`Macrophages M2`)<br>index &lt;- match(trait<span>$ID</span>,sur_data<span>$bcr_patient_barcode</span>)<br>trait<span>$os</span> &lt;- sur_data[index,<span>'OS'</span>]<br><br><br>module_trait_cor &lt;- cor(merged_MEs,trait[,2:3],use = <span>'p'</span>)<br>module_trait_pvalue &lt;- corPvalueStudent(module_trait_cor,ncol(exp))<br>trait_colors &lt;- numbers2colors(trait[,2:3],signed = T,centered = T)<br>a &lt;- paste(signif(module_trait_cor, 2), <span>"\n("</span>, signif(module_trait_pvalue, 1), <span>")"</span>, sep = <span>""</span>)<br>sizeGrWindow(8,6)<br>labeledHeatmap(module_trait_cor,xLabels = colnames(trait[,2:3]),yLabels = colnames(merged_MEs),colorLabels = FALSE, <br>               colors = blueWhiteRed(50),textMatrix = a,<br>               setStdMargins = FALSE,cex.text = 0.65,zlim = c(-1,1), <br>               main = paste(<span>"Module-trait relationships"</span>))<br></code></pre><p data-tool="mdnice编辑器"><strong>蓝色模块和M1的相关性最高</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.5232198142414861" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZC75PbPfHNrDjq9OtWhKu3uNCPpeKs6qnFCAUEDUEzu6Lr39SJDUOtA/640?wx_fmt=png" data-type="png" data-w="969" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZC75PbPfHNrDjq9OtWhKu3uNCPpeKs6qnFCAUEDUEzu6Lr39SJDUOtA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 找到M1相关的关键模块</span><br>module &lt;- <span>'MEblue'</span><br>module_membership &lt;- signedKME(exp,merged_MEs)<br><span># 计算表达矩阵exp和OS之间相关性</span><br>gene_os_sig &lt;- apply(exp,2,<span>function</span>(x){cor(x,trait<span>$os</span>)})<br><br>verboseScatterplot(abs(module_membership<span>$kMEblue</span>),<br>                   abs(gene_os_sig),<br>                   xlab = paste(<span>"Module Membership in"</span>, module, <span>"module"</span>),<br>                   ylab = <span>"Gene significance for OS"</span>,<br>                   main = paste(<span>"Module membership vs. gene significance\n"</span>),<br>                   cex.main = 1.2, cex.lab = 1.2, cex.axis = 1.2)<br><br><span># 找出MEblue模块内所有基因</span><br>module_membership &lt;- module_membership[!is.na(module_membership<span>$kMEblue</span>),]<br><span># 筛选出MM&gt;0.5 和 exp-OS相关性&gt;0.1 的作为hub gene</span><br>MM_gene &lt;- rownames(module_membership[abs(module_membership<span>$kMEblue</span>)&gt;0.5,])<br>OS_sig_gene &lt;- names(gene_os_sig[abs(gene_os_sig)&gt;0.1])<br>hub_gene &lt;- intersect(MM_gene,OS_sig_gene)<br><br>save(hub_gene,file = <span>'WGCNA_hub_gene.Rdata'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6866666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmknLsAtpYpyqgqeXA1tNSXia3eD3EiaV13af2BhVfAMKvOYpLDApCP6g/640?wx_fmt=png" data-type="png" data-w="600" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmknLsAtpYpyqgqeXA1tNSXia3eD3EiaV13af2BhVfAMKvOYpLDApCP6g/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>5. 下载imvigor 210队列数据，用SVM模型预测免疫表型<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># SVM预测免疫类型</span><br><span># DEseq安装 http://bioconductor.org/packages/3.8/bioc/html/DESeq.html</span><br><span># IMvigor210CoreBiologies安装：http://research-pub.gene.com/IMvigor210CoreBiologies/packageVersions/</span><br>data(cds)<br>expreSet &lt;- as.data.frame(counts(cds))<br>annoData &lt;- fData(cds)<br>phenoData &lt;- pData(cds)<br></code></pre><p data-tool="mdnice编辑器">这里需要安装两个包，e1071和IMvigor210CoreBiologies，后者比较难安，需要手动下载安装包到本地，然后再进行安装，然后就可以得到数据了</p><pre data-tool="mdnice编辑器"><span></span><code><span># 清洗数据</span><br>expreSet &lt;- expreSet[rowSums(expreSet&gt;0)&gt;3,]<br><br>phenoData$`Immune phenotype` &lt;- as.character(phenoData$`Immune phenotype`)<br>phenoData &lt;- phenoData[!is.na(phenoData$`Immune phenotype`),]<br>phenoData$`Immune phenotype` &lt;- as.factor(phenoData$`Immune phenotype`)<br><br>expreSet &lt;- expreSet[,rownames(phenoData)]<br><span># count转TPM</span><br>index &lt;- match(rownames(expreSet),annoData<span>$entrez_id</span>)<br>expreSet<span>$gene_length</span> &lt;- annoData[index,<span>'length'</span>]<br>kb &lt;- expreSet<span>$gene_length</span>/1000<br>rpk &lt;- expreSet[,-ncol(expreSet)] / kb<br>tpm &lt;- t(t(rpk) / colSums(rpk) * 1E6)<br>exp &lt;- tpm<br><br><span># 取log</span><br>exp &lt;- log2(exp+1)<br>exp &lt;- as.data.frame(exp)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.23037974683544304" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmViagvfBgncCLlCC6H9ROxqKJs9Npdkr3MorQUuhicLB9NUAqg2icQt3Q/640?wx_fmt=png" data-type="png" data-w="395" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmViagvfBgncCLlCC6H9ROxqKJs9Npdkr3MorQUuhicLB9NUAqg2icQt3Q/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器"><strong>用SVM建模的大体思路是这样的:</strong></p><ol data-tool="mdnice编辑器"><li><section><p>首先把数据分成训练集和测试集</p><p>训练集包含 表达矩阵 和 每个样本对应的标签（免疫类型），以此构建svm模型</p></section></li><li><section><p>把测试集的表达矩阵带入到svm模型中，得到预测的结果</p></section></li><li><section><p>用测试集的真实标签和预测的结果即可画roc曲线</p></section></li></ol><p data-tool="mdnice编辑器">注意这里我把测试集的标签由factor改为了numeric，这样可以得到每个标签预测的概率，画出来的roc曲线点很多，如果不改，画出来的roc曲线点会很少，可能只有3个点</p><pre data-tool="mdnice编辑器"><span></span><code><span># 划分训练集和测试集</span><br>test_size &lt;- 0.2<br>test_sample &lt;- sample(colnames(exp),size = as.integer(ncol(exp)*test_size))<br>train_sample &lt;- setdiff(colnames(exp),test_sample)<br><span># 训练集和测试集的表达矩阵</span><br>test_exp &lt;- as.data.frame(t(exp[,test_sample]))<br>train_exp &lt;- as.data.frame(t(exp[,train_sample]))<br><span># 训练集和测试集的标签  </span><br>test_label &lt;- phenoData[test_sample,<span>"Immune phenotype"</span>]<br>train_label &lt;- phenoData[train_sample,<span>"Immune phenotype"</span>]<br><span># 训练集标签转换为二分类</span><br>train_label_desert &lt;- as.factor(ifelse(train_label==<span>'desert'</span>,<span>'desert'</span>,<span>'not desert'</span>))<br>train_label_inflamed &lt;- as.factor(ifelse(train_label==<span>'inflamed'</span>,<span>'inflamed'</span>,<span>'not inflamed'</span>))<br>train_label_excluded &lt;- as.factor(ifelse(train_label==<span>'excluded'</span>,<span>'excluded'</span>,<span>'not excluded'</span>))<br><span># 测试集标签转换为二分类</span><br>test_label_desert &lt;- as.factor(ifelse(test_label==<span>'desert'</span>,<span>'desert'</span>,<span>'not desert'</span>))<br>test_label_inflamed &lt;- as.factor(ifelse(test_label==<span>'inflamed'</span>,<span>'inflamed'</span>,<span>'not inflamed'</span>))<br>test_label_excluded &lt;- as.factor(ifelse(test_label==<span>'excluded'</span>,<span>'excluded'</span>,<span>'not excluded'</span>))<br><span># 测试集标签转换为数字</span><br>test_label_desert &lt;- ifelse(test_label==<span>'desert'</span>,1,0)<br>test_label_inflamed &lt;- ifelse(test_label==<span>'inflamed'</span>,1,0)<br>test_label_excluded &lt;- ifelse(test_label==<span>'excluded'</span>,1,0)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span># 训练模型</span><br>desert_model &lt;- svm(x = train_exp, <br>                    y = train_label_desert,<br>                    <span>type</span> = <span>'C'</span>,kernel = <span>'radial'</span>,probability = T)<br>inflamed_model &lt;- svm(x = train_exp, <br>                    y = train_label_inflamed,<br>                    <span>type</span> = <span>'C'</span>,kernel = <span>'radial'</span>,probability = T)<br>excluded_model &lt;- svm(x = train_exp, <br>                    y = train_label_excluded,<br>                    <span>type</span> = <span>'C'</span>,kernel = <span>'radial'</span>,probability = T)<br><span># 进行预测</span><br>test_predict_desert &lt;- predict(desert_model,test_exp,prob = T)<br><span># 得出预测结果的概率</span><br>desert_prob &lt;- attr(test_predict_desert,<span>'probabilities'</span>)[,2]<br>test_predict_inflamed &lt;- predict(inflamed_model,test_exp)<br>inflamed_prob &lt;- attr(test_predict_desert,<span>'probabilities'</span>)[,2]<br>test_predict_excluded &lt;- predict(excluded_model,test_exp)<br>excluded_prob &lt;- attr(test_predict_desert,<span>'probabilities'</span>)[,2]<br><br>desert_roc_obj &lt;- roc(response = as.numeric(test_label_desert),<br>                      predictor = as.numeric(desert_prob),na.rm=T)<br>desert_auc &lt;- round(auc(test_label_desert,desert_prob),2)<br>inflamed_roc_obj &lt;- roc(response = as.numeric(test_label_inflamed),<br>                        predictor = as.numeric(inflamed_prob),na.rm=T)<br>inflamed_auc &lt;- round(auc(test_label_inflamed,inflamed_prob),2)<br>excluded_roc_obj &lt;- roc(response = as.numeric(test_label_excluded),<br>                        predictor = as.numeric(excluded_prob),na.rm=T)<br>excluded_auc &lt;- round(auc(test_label_excluded,excluded_prob),2)<br><br>desert &lt;- ggroc(desert_roc_obj)<br>inflamed &lt;- ggroc(inflamed_roc_obj)<br>excluded &lt;- ggroc(excluded_roc_obj)<br><br>roc_data &lt;- list(desert_roc_obj,inflamed_roc_obj,excluded_roc_obj)<br>names(roc_data) &lt;- c(<span>'desert'</span>,<span>'inflamed'</span>,<span>'excluded'</span>)<br><br><span>## sensitivity(敏感性): 也称recall或TPR(真阳性率，实际为正例并且模型预测为正例 占 所有所有正例 的比例)，越接近1越好</span><br><span>## specificity(特异性)：也称TNR(真阴性率，实际为负例并且模型预测为负例 占 所有所有负例 的比例)，越接近1越好</span><br>ggroc(roc_data)+geom_segment(aes(x = 1, xend = 0, y = 0, yend = 1), color=<span>"red"</span>,linetype=6)+<br>  annotate(<span>'text'</span>,x=c(0.12,0.12,0.12),y=c(0.1,0.06,0.02),label=c(paste0(<span>'desert_auc: '</span>,desert_auc),<br>                                                              paste0(<span>'inflamed_auc: '</span>,inflamed_auc),<br>                                                              paste0(<span>'excluded_auc: '</span>,excluded_auc))<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7010428736964078" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZDzjqBg2uEPDzp996OMENO73h8I4CNK2rWdTX0rPZicw0UxwPGgR7giag/640?wx_fmt=png" data-type="png" data-w="863" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZDzjqBg2uEPDzp996OMENO73h8I4CNK2rWdTX0rPZicw0UxwPGgR7giag/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>6. 用NMF把TCGA样本分为两个亚组，该细胞在这两个亚组的比例有显著差异<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'TCGA_OV.Rdata'</span>)<br>load(<span>'WGCNA_hub_gene.Rdata'</span>)<br><br>hubgene_exp &lt;- exp[hub_gene,]<br><br>estimate &lt;- nmf(hubgene_exp,rank = 2:10,method = <span>'brunet'</span>)<br>save(estimate,file = <span>'estimate.Rdata'</span>)<br>plot(estimate)<br><br>rank &lt;- 6<br>nmf.rank &lt;- nmf(hubgene_exp,rank = rank,method = <span>'brunet'</span>)<br>group &lt;- predict(nmf.rank)<br>index &lt;- extractFeatures(nmf.rank,<span>'max'</span>)<br>index &lt;- unlist(index)<br><br>nmf.exp &lt;- hubgene_exp[index,]<br>nmf.exp &lt;- na.omit(nmf.exp)<br><br>jco &lt;- c(<span>"#2874C5"</span>,<span>"#EABF00"</span>,<span>"#C6524A"</span>,<span>"#868686"</span>)<br>consensusmap(nmf.rank,labRow=NA,labCol=NA,<br>             annCol = data.frame(<span>"cluster"</span>=group[colnames(nmf.exp)]))<br></code></pre><p data-tool="mdnice编辑器"><strong>cophenetic值在6-7之间变化最大，因此rank选6，就会把379个样本分为6类</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="0.6944114149821641" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZJ01Z0HCuia5QOiawyjPJtP2h6joFrmC8xnklicx2kaiaKSlicB7Nb2sicAtg/640?wx_fmt=png" data-type="png" data-w="841" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZJ01Z0HCuia5QOiawyjPJtP2h6joFrmC8xnklicx2kaiaKSlicB7Nb2sicAtg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.670906200317965" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZMAA6ZGH99U913nAZGicnuPgNv6onblkMn2KXuy7T0BLjPIBkcP85Ayw/640?wx_fmt=png" data-type="png" data-w="629" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZMAA6ZGH99U913nAZGicnuPgNv6onblkMn2KXuy7T0BLjPIBkcP85Ayw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code>anno_col &lt;- data.frame(sample = colnames(nmf.exp),group = group)<br>anno_col &lt;- anno_col[order(anno_col<span>$group</span>),]<br>pheatmap(nmf.exp[,rownames(anno_col)],show_colnames = F,annotation_col = select(anno_col,group),<br>         cluster_cols = F)<br></code></pre><p data-tool="mdnice编辑器">这里把annotation_col调整了顺序，这样每一个类的样本就在一起，如果按默认的就会非常混乱</p><p data-tool="mdnice编辑器">这里annotation_col是一个一列的dataframe， 行名是样本名，唯一的一列是样本分组信息</p><figure data-tool="mdnice编辑器"><img data-ratio="0.7601851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZjTcZvmM2zzONLy0icscWXzoCmnSia9M5Kib8Ah9794MicFU1IJ1Y1axBQA/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZjTcZvmM2zzONLy0icscWXzoCmnSia9M5Kib8Ah9794MicFU1IJ1Y1axBQA/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 挑出两个组分析</span><br>group12 &lt;- group[group==2 | group==1]<br>group12 &lt;- sort(group12)<br>exp_temp &lt;- nmf.exp[,names(group12)]<br>pheatmap(exp_temp,show_colnames = F,annotation_col = data.frame(row.names = colnames(exp_temp),group = group12),<br>         cluster_cols = F)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.7583333333333333" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZhT8Z5DibdKR237hibnib76q4Ric1ib0iaKWEmz1jTVLEd9dPo6iao3nFibiaQKw/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZhT8Z5DibdKR237hibnib76q4Ric1ib0iaKWEmz1jTVLEd9dPo6iao3nFibiaQKw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># KM-plot</span><br>load(<span>'survival_data.Rdata'</span>)<br>load(<span>'TME_result.Rdata'</span>)<br>temp &lt;- data.frame(row.names = colnames(exp_temp),bcr_patient_barcode = substr(colnames(exp_temp),1,12),<br>                   group=group12)<br>temp &lt;- left_join(temp,sur_data,by=<span>'bcr_patient_barcode'</span>)<br>group_OS &lt;- survfit(Surv(OS.time,OS)~group,data = temp)<br>ggsurvplot(group_OS,pval = T,risk.table = T,surv.median.line = <span>'hv'</span>,<br>           title=<span>'Overall survival'</span>,xlab=<span>'Days'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6607142857142857" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZico1mTwfSSY1cjn7z1fzH4LFBxs3OtGTJPAxOcWf6apRKVTlibYoVKiaw/640?wx_fmt=png" data-type="png" data-w="840" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZico1mTwfSSY1cjn7z1fzH4LFBxs3OtGTJPAxOcWf6apRKVTlibYoVKiaw/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># M1细胞的小提琴图</span><br>vln_df &lt;- data.frame(row.names = names(group12),M1=TME.result[names(group12),<span>'Macrophages M1'</span>],group = group12)<br>ggplot(vln_df,aes(x=group,y=M1))+geom_violin(aes(fill=group))+geom_boxplot(width=0.2)+<br>    geom_signif(comparisons = list(c(<span>'1'</span>,<span>'2'</span>)),map_signif_level = F)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6864" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZHzbWk37zqicWpBNeJiafGX0gZRRvsGaC3nib3dViaQzB2YvGogOa97TR5w/640?wx_fmt=png" data-type="png" data-w="625" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZHzbWk37zqicWpBNeJiafGX0gZRRvsGaC3nib3dViaQzB2YvGogOa97TR5w/640?wx_fmt=png"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># KEGG富集</span><br>kegg_exp &lt;- exp[,names(group12)]<br>design &lt;- model.matrix(~factor(as.character(group12),levels = c(<span>'1'</span>,<span>'2'</span>)))<br>fit &lt;- lmFit(kegg_exp,design=design)<br>fit &lt;- eBayes(fit)<br>deg &lt;- topTable(fit,coef = 2,number = Inf)<br>deg<span>$change</span> &lt;- ifelse((deg<span>$logFC</span>&gt;log2(2))&amp;(deg<span>$adj</span>.P.Val&lt;0.05),<span>'up'</span>,<br>                     ifelse((deg<span>$logFC</span>&lt;log2(0.5))&amp;(deg<span>$adj</span>.P.Val&lt;0.05),<span>'down'</span>,<span>'nochange'</span>))<br>save(deg,file = <span>'TCGA-deg.Rdata'</span>)<br>up_1_id &lt;- bitr(rownames(deg[deg<span>$change</span>==<span>'up'</span>,]),fromType = <span>'SYMBOL'</span>,toType = <span>'ENTREZID'</span>,OrgDb = org.Hs.eg.db)<br>kegg &lt;- enrichKEGG(up_1_id<span>$ENTREZID</span>,organism = <span>'hsa'</span>,keyType = <span>'ncbi-geneid'</span>)<br>dotplot(kegg)<br><br>up_2_id &lt;- bitr(rownames(deg[deg<span>$change</span>==<span>'down'</span>,]),fromType = <span>'SYMBOL'</span>,toType = <span>'ENTREZID'</span>,OrgDb = org.Hs.eg.db)<br>kegg &lt;- enrichKEGG(up_2_id<span>$ENTREZID</span>,organism = <span>'hsa'</span>,keyType = <span>'ncbi-geneid'</span>)<br>dotplot(kegg)<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6656" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZsBFAfpvtOSo5dDyJtpN66vwZicKL2gam7E3HMjHMph6GPLXKyXNBibIg/640?wx_fmt=png" data-type="png" data-w="625" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZsBFAfpvtOSo5dDyJtpN66vwZicKL2gam7E3HMjHMph6GPLXKyXNBibIg/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>7. 批量单因素cox回归找出hub gene中与生存相关的gene<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'TCGA_OV.Rdata'</span>)<br>load(<span>'survival_data.Rdata'</span>)<br>load(<span>'TCGA-deg.Rdata'</span>)<br><span># 数据处理</span><br>deg_gene &lt;- rownames(deg[deg<span>$change</span>!=<span>'nochange'</span>,])<br>exp &lt;- as.data.frame(t(exp))<br>exp &lt;- exp[,deg_gene]<br>exp<span>$ID</span> &lt;- substr(rownames(exp),1,12)<br>exp &lt;- exp[!duplicated(exp<span>$ID</span>),]<br>index &lt;- match(rownames(sur_data),exp<span>$ID</span>)<br>index &lt;- index[!is.na(index)]<br><br>sur_data &lt;- merge(sur_data,exp,by.x=<span>'bcr_patient_barcode'</span>,by.y=<span>'ID'</span>)<br><br><span># 批量单因素COX回归</span><br>gene &lt;- c()<br>p_value &lt;- c()<br>HR &lt;- c()<br>lower95 &lt;- c()<br>upper95 &lt;- c()<br><span>for</span> (i <span>in</span> 6:ncol(sur_data)){<br>  res &lt;- coxph(Surv(OS.time,OS)~sur_data[,i],data=sur_data)<br>  sum_res &lt;- summary(res)<br>  p &lt;- sum_res<span>$coefficients</span>[,<span>'Pr(&gt;|z|)'</span>]<br>  <span>if</span> (p&lt;0.05){<br>    gene &lt;- c(gene,colnames(sur_data)[i])<br>    p_value &lt;- c(p_value,p)<br>    HR &lt;- c(HR,sum_res<span>$conf</span>.int[,<span>'exp(coef)'</span>])<br>    lower95 &lt;- c(lower95,sum_res<span>$conf</span>.int[,<span>'lower .95'</span>])<br>    upper95 &lt;- c(upper95,sum_res<span>$conf</span>.int[,<span>'upper .95'</span>])<br>  }<br>}<br>cox_df &lt;- data.frame(row.names = gene,pvalue=p_value,HR=HR,lower.95=lower95,upper.95=upper95)<br></code></pre><p data-tool="mdnice编辑器"><strong>用批量单因素cox回归，找到pvalue小于0.05的gene</strong></p><figure data-tool="mdnice编辑器"><img data-ratio="1.2464183381088825" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZZVha3479pFPAIEtdeHquKV6KJia4ExHOrCvcQKLsOVfhSzGgPrpxDfA/640?wx_fmt=png" data-type="png" data-w="349" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZZVha3479pFPAIEtdeHquKV6KJia4ExHOrCvcQKLsOVfhSzGgPrpxDfA/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>8. lasso回归进一步筛选gene<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># LASSO进一步筛选gene</span><br>sur_data &lt;- column_to_rownames(sur_data,<span>'bcr_patient_barcode'</span>)<br>sur_data &lt;- select(sur_data,c(OS,OS.time,rownames(cox_df)))<br>sur_data &lt;- sur_data[!is.na(sur_data<span>$OS</span>.time),]<br>x &lt;- as.matrix(sur_data[,5:ncol(sur_data)])<br>y &lt;- Surv(sur_data<span>$OS</span>.time,sur_data<span>$OS</span>)<br>glm.fit &lt;- glmnet(x,y,family = <span>'cox'</span>,alpha = 1)<br>plot(glm.fit)<br>cv.fit &lt;- cv.glmnet(x,y,alpha = 1,nfolds = 10,family=<span>"cox"</span>)<br>plot(cv.fit)<br>lambda &lt;- cv.fit<span>$lambda</span>.min<br><br>glm.fit &lt;- glmnet(x,y,family = <span>'cox'</span>,alpha = 1,lambda = lambda)<br>lasso_filter_gene &lt;- names(glm.fit<span>$beta</span>[glm.fit<span>$beta</span>[,1]!=0,1])<br>coef &lt;- glm.fit<span>$beta</span>[glm.fit<span>$beta</span>[,1]!=0,1]<br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6365131578947368" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZiceHVah15zloj0SNvachiaia989pKP3KFav2qba0LRbPayzgC61wqkR2Q/640?wx_fmt=png" data-type="png" data-w="608" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZiceHVah15zloj0SNvachiaia989pKP3KFav2qba0LRbPayzgC61wqkR2Q/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.625" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZbiazdojKR3iasgXc25Ib8nXkG50BAAYhhziaeT3TuSBjKOmeCq8YpyoKA/640?wx_fmt=png" data-type="png" data-w="600" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZbiazdojKR3iasgXc25Ib8nXkG50BAAYhhziaeT3TuSBjKOmeCq8YpyoKA/640?wx_fmt=png"></figure><h3 data-tool="mdnice编辑器"><span></span>9. 多因素cox回归，计算riskScore，riskScore与生存信息的相关性<span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 筛选后的gene用多因素cox回归建模</span><br>sur_data_temp &lt;- select(sur_data,c(OS,OS.time,lasso_filter_gene))<br><span># gene名IGKV4-1，在ggrisk时会报错，改成.</span><br>colnames(sur_data_temp) &lt;- c(<span>"OS"</span>,<span>"OS.time"</span>,<span>"LAMP3"</span>,<span>"STAT1"</span>,<span>"BATF2"</span>,<span>"CXCL10"</span>,<span>"CXCL11"</span>,<span>"IGKV4.1"</span>)<br>cox.res &lt;- coxph(Surv(OS.time,OS)~.,data = sur_data_temp)<br>riskScore &lt;- predict(cox.res,<span>type</span> = <span>'risk'</span>,newdata=sur_data_temp)<br>riskScore &lt;- as.data.frame(riskScore)<br>riskScore<span>$ID</span> &lt;- rownames(riskScore)<br>riskScore<span>$risk</span> &lt;- ifelse(riskScore<span>$riskScore</span>&gt;median(riskScore<span>$riskScore</span>),<span>'high'</span>,<span>'low'</span>)<br>riskScore<span>$OS</span> &lt;- sur_data<span>$OS</span><br>riskScore<span>$OS</span>.time &lt;- sur_data<span>$OS</span>.time<br><br>ggrisk(cox.res)<br><br><span># riskscore做生存分析</span><br>surv_fit &lt;- survfit(Surv(OS.time,OS)~risk,data = riskScore)<br>ggsurvplot(surv_fit,data = riskScore,pval = T,risk.table = T,surv.median.line = <span>'hv'</span>,<br>           legend.title = <span>'RiskScore'</span>,title = <span>'Overall survival'</span>,<br>           ylab=<span>'Cummulative survival'</span>,xlab=<span>'Time(Days)'</span>)<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-ratio="0.6404602109300096" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmP9u3XJWTPQ6Bjykib81mc8WzxRjYMvSLoM2V27ic3UXuYia9wIjLDmUg/640?wx_fmt=png" data-type="png" data-w="1043" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZmP9u3XJWTPQ6Bjykib81mc8WzxRjYMvSLoM2V27ic3UXuYia9wIjLDmUg/640?wx_fmt=png"></figure><figure data-tool="mdnice编辑器"><img data-ratio="0.6294173829990449" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZIqdbF1uRozLaLYicm3z7aZgRlsz9iawgATzk0nDcSKu6uicPfJwSjSEDA/640?wx_fmt=png" data-type="png" data-w="1047" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzlF3T8r0zxibQ1CqON9hLlZIqdbF1uRozLaLYicm3z7aZgRlsz9iawgATzk0nDcSKu6uicPfJwSjSEDA/640?wx_fmt=png"></figure></section><h4 data-tool="mdnice编辑器">文末友情宣传</h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247523501&amp;idx=1&amp;sn=08ba40250a2c2da72d324e985b1692c1&amp;chksm=9b4bdc16ac3c55008ba185e92683e24c80f258c3ad385ba6fb44746ecc75eaa7276eaeff8631&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉‍松授课（买一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a> ，你的生物信息学入门课</section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247522831&amp;idx=2&amp;sn=1744efdf428465425a145ff3a982198b&amp;chksm=9b4bdab4ac3c53a28fbecbbff4f254f470b54a7a20468bb753b295b930315e1ec45bcbabc10b&amp;scene=21#wechat_redirect" textvalue="144线程640Gb内存服务器共享一年‍仍然是仅需800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">144线程640Gb内存服务器共享一年仍然是仅需800</a></section></li><li><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247519765&amp;idx=1&amp;sn=ce5a8c8182f854c88043059f8c2cb9ff&amp;chksm=9b4bceaeac3c47b88c19941d43dbb1401f3a92206481a0afc41159927868199643f795d62a7e&amp;scene=21#wechat_redirect" textvalue="千呼万唤始出来的独享生物信息学云服务器" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤始出来的独享生物信息学云服务器</a></section></li></ul><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/qFfCDp5nDV0JHdUbAkltFw",target="_blank" rel="noopener noreferrer">原文链接</a>
