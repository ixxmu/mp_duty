---
title: "Python单细胞学习(Best practics)流程一"
date: 2025-08-05T08:14:44Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
Python单细胞学习(Best practics)流程一 by 生信方舟
------
<div><section><span leaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="生信方舟" data-alias="shengxinfangzhou" data-from="0" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfe15Xm0WHdoAMNGvE93bmxaF9iabfPiaO9ic6Tmd8XW1PMiaeuqicSFhCLQJibAUhHsamS1LbaJMFiaZXA/0?wx_fmt=png" data-signature="热爱医学和数据科学，站在巨人的肩膀上，学习和整理相关的知识。" data-id="MzkwMjYyMDA1OA==" data-is_biz_ban="0" data-service_type="1" data-verify_status="0"></mp-common-profile></span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100005032" data-ratio="1.0141752577319587" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/0SOG4MpDAyHAYfZ09Xo2tzOrSPYJnTU0mqBrVWRNfN9iaQq5A6CLsx7tdEJ2NP9ZypPgH4CiakZySx4NvibsaoJgw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="776" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/0SOG4MpDAyHAYfZ09Xo2tzOrSPYJnTU0mqBrVWRNfN9iaQq5A6CLsx7tdEJ2NP9ZypPgH4CiakZySx4NvibsaoJgw/640?wx_fmt=other&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">单细胞分析框架: Bioconductor, Seurat, scverse</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">在获得计数矩阵之后，如前所述，探索性数据分析阶段就开始了。由于数据的体量和复杂性，需要使用专门的工具。在单细胞分析的早期，人们通常使用自定义脚本来分析数据，而如今已经有了专为此目的而设计的框架。目前最流行的三个选择是：基于R的 Bioconductor和Seurat生态系统，以及基于 Python 的scverse生态系统。这些框架不仅在所用的编程语言上有所不同，还在底层数据结构和可用的专业分析工具上各具特色。</span></p><p data-tool="mdnice编辑器"><span leaf="">Bioconductor：是一个开发、支持并共享自由开源软件的项目，专注于多种生物实验数据的严格和可重复性分析，包括单细胞数据。统一的开发者与用户体验、丰富的文档资料以及用户友好的使用示例（vignettes）是 Bioconductor 的最大优势。</span></p><p data-tool="mdnice编辑器"><span leaf="">Seurat：是一个广受认可的 R 包，专门用于单细胞数据分析。它提供了贯穿整个分析流程的工具，涵盖了多模态数据和空间转录组数据。完善的示例文档以及庞大的用户群体使得 Seurat 深受欢迎。然而，对于极大规模的数据集（超过 50 万个细胞），这两个 R 方案可能会在可扩展性方面遇到瓶颈，这促使 Python 社区开发了 scverse 生态系统。</span></p><p data-tool="mdnice编辑器"><span leaf="">scverse：是一个组织以及生态系统，致力于为生命科学构建基础工具，最初聚焦于单细胞数据。其优势在于可扩展性强、易于拓展，并且与现有的 Python 数据分析与机器学习工具具有良好的互操作性。</span></p><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">使用AnnData存储数据</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">经过对齐和基因注释后，基因组数据通常会总结为特征矩阵。这个矩阵的形状为“观察数 x 变量数”——对于单细胞RNA测序，观察对应于细胞条形码，变量对应于注释基因。在分析过程中，该矩阵的观察和变量会被计算得出的度量（例如质量控制指标或潜在空间嵌入）以及先前知识（例如来源供体或替代基因标识符）进行注释。在scverse生态系统中，AnnData被用来将数据矩阵与这些注释关联起来。为了实现快速且内存高效的转换，AnnData还支持稀疏矩阵和部分读取。虽然AnnData与R生态系统中的数据结构（例如Bioconductor的SummarizedExperiment或Seurat的对象）大体相似，但R包使用的是转置的特征矩阵。 在其核心，AnnData对象在X中存储一个稀疏或密集矩阵（在scRNA-seq的情况下为计数矩阵）。这个矩阵的维度为obs_names x var_names，其中obs（观察）对应于细胞的条形码，var（变量）对应于基因标识符。矩阵X周围是Pandas DataFrame obs和var，分别保存细胞和基因的注释。此外，AnnData还保存观察（obsm）或变量（varm）的整个计算矩阵，具有相应的维度。将细胞与细胞或基因与基因关联的图形结构通常保存在obsp和varp中。任何其他不适合其他槽的数据将作为非结构化数据保存在uns中。此外，还可以在layers中存储X的更多值。使用场景例如在counts层中存储原始的、未归一化的计数数据，而在未命名的默认层中存储归一化的数据。 AnnData主要设计用于单模态（例如仅为scRNA-seq）数据。</span></p><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.导入</span></span><span></span></h5><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">import numpy as np</span><span leaf=""><br></span><span leaf="">import pandas as pd</span><span leaf=""><br></span><span leaf="">import anndata as ad</span><span leaf=""><br></span><span leaf="">from scipy.sparse import csr_matrix</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">2.初始化一个AnnData对象</span></span><span></span></h5><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">counts = csr_matrix(np.random.poisson(</span><span><span leaf="">1</span></span><span leaf="">, size=(</span><span><span leaf="">100</span></span><span leaf="">, </span><span><span leaf="">2000</span></span><span leaf="">)), dtype=np.float32)</span><span leaf=""><br></span><span leaf="">adata = ad.AnnData(counts)</span><span leaf=""><br></span><span leaf="">adata</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.查看adata.X</span></span><span></span></h5><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.X</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">4.创建obs和var的名称</span></span><span></span></h5><ol><li><section><span leaf="">adata.obs_names = [f"Cell_{i:d}" for i in range(adata.n_obs)]：这行代码为adata对象的每个观测（即每个细胞）创建一个名称。从0到adata.n_obs-1，给每个细胞命名为Cell_0、Cell_1、...、Cell_99。</span></section></li><li><section><span leaf="">adata.var_names = [f"Gene_{i:d}" for i in range(adata.n_vars)]：这行代码为adata对象的每个变量（即每个基因）创建一个名称。从0到adata.n_vars-1，给每个基因命名为Gene_0、Gene_1、...、Gene_1999。</span></section></li><li><section><span leaf="">print(adata.obs_names[:10])：这行代码打印出adata对象前10个观测的名称，也就是Cell_0到Cell_9。</span></section></li></ol><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.obs_names = [f</span><span><span leaf="">"Cell_{i:d}"</span></span><span leaf=""> </span><span><span leaf="">for</span></span><span leaf=""> i </span><span><span leaf="">in</span></span><span leaf=""> range(adata.n_obs)]</span><span leaf=""><br></span><span leaf="">adata.var_names = [f</span><span><span leaf="">"Gene_{i:d}"</span></span><span leaf=""> </span><span><span leaf="">for</span></span><span leaf=""> i </span><span><span leaf="">in</span></span><span leaf=""> range(adata.n_vars)]</span><span leaf=""><br></span><span leaf="">print(adata.obs_names[:</span><span><span leaf="">10</span></span><span leaf="">])</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.添加metadata</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">接下来的步骤是分别在观测（样本）和变量（特征）层面添加元数据。要记住，将这些注释分别存储在AnnData对象的.obs和.var槽中，.obs用于细胞注释，而.var用于基因注释。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ct = np.random.choice([</span><span><span leaf="">"B"</span></span><span leaf="">, </span><span><span leaf="">"T"</span></span><span leaf="">, </span><span><span leaf="">"Monocyte"</span></span><span leaf="">], size=(adata.n_obs,))</span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">"cell_type"</span></span><span leaf="">] = pd.Categorical(ct)  </span><span><span leaf=""># Categoricals are preferred for efficiency</span></span><span leaf=""><br></span><span leaf="">adata.obs</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/0SOG4MpDAyHAYfZ09Xo2tzOrSPYJnTU06NrA5USDqmJfxHQD2MOYI12h1Ij8aRxapA0dRUHgZcQ5CzqBG1HbmA/640?wx_fmt=other&amp;from=appmsg" data-ratio="2.4901960784313726" data-type="other" data-w="153" data-imgfileid="100005034" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/0SOG4MpDAyHAYfZ09Xo2tzOrSPYJnTU06NrA5USDqmJfxHQD2MOYI12h1Ij8aRxapA0dRUHgZcQ5CzqBG1HbmA/640?wx_fmt=other&amp;from=appmsg"></span></figure><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">6.取子集</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">这个取子集方式就有点R语言的感觉</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">bdata = adata[adata.obs.cell_type == </span><span><span leaf="">"B"</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">bdata</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">7.观测/变量-等级矩阵</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">在每个层级上都有多维的元数据，例如数据的UMAP嵌入。对于这种类型的元数据，AnnData具有</span><code><span leaf="">.obsm/.varm</span></code><span leaf="">属性。我们使用键来识别插入的不同矩阵。</span><code><span leaf="">.obsm/.varm</span></code><span leaf="">的限制是，</span><code><span leaf="">.obsm</span></code><span leaf="">矩阵的长度必须等于观测值的数量（</span><code><span leaf="">.n_obs</span></code><span leaf="">），而</span><code><span leaf="">.varm</span></code><span leaf="">矩阵的长度必须等于变量的数量（</span><code><span leaf="">.n_vars</span></code><span leaf="">）。它们各自可以独立具有不同的维度数量。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.obsm[</span><span><span leaf="">"X_umap"</span></span><span leaf="">] = np.random.normal(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">, size=(adata.n_obs, </span><span><span leaf="">2</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">adata.varm[</span><span><span leaf="">"gene_stuff"</span></span><span leaf="">] = np.random.normal(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">, size=(adata.n_vars, </span><span><span leaf="">5</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">adata.obsm</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">8.非结构化元数据</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">AnnData 具有 </span><em><span leaf="">uns</span></em><span leaf=""> 属性，它允许存储任何非结构化的元数据。这可以是任何东西，例如一个列表或一个包含一些对我们数据分析有用的通用信息的字典。请尽量只使用这个属性来存储不能有效保存在其他属性中的数据。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.uns[</span><span><span leaf="">"random"</span></span><span leaf="">] = [</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">3</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">adata.uns</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#OverloadedDict, wrapping:</span></span><span leaf=""><br></span><span><span leaf=""># OrderedDict([('random', [1, 2, 3])])</span></span><span leaf=""><br></span><span><span leaf="">#With overloaded keys:</span></span><span leaf=""><br></span><span><span leaf=""># ['neighbors'].</span></span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">9.Layers</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">在 AnnData 中使用 layers 是为了便于存储和管理同一数据集的多个数据表示或变换。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.layers[</span><span><span leaf="">"log_transformed"</span></span><span leaf="">] = np.log1p(adata.X)</span><span leaf=""><br></span><span leaf="">adata</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">10.另一种创建metadata的方式</span></span><span></span></h5><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">obs_meta = pd.DataFrame(</span><span leaf=""><br></span><span leaf="">    {</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"time_yr"</span></span><span leaf="">: np.random.choice([</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">4</span></span><span leaf="">, </span><span><span leaf="">8</span></span><span leaf="">], adata.n_obs),</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"subject_id"</span></span><span leaf="">: np.random.choice([</span><span><span leaf="">"subject 1"</span></span><span leaf="">, </span><span><span leaf="">"subject 2"</span></span><span leaf="">, </span><span><span leaf="">"subject 4"</span></span><span leaf="">, </span><span><span leaf="">"subject 8"</span></span><span leaf="">], adata.n_obs),</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"instrument_type"</span></span><span leaf="">: np.random.choice([</span><span><span leaf="">"type a"</span></span><span leaf="">, </span><span><span leaf="">"type b"</span></span><span leaf="">], adata.n_obs),</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">"site"</span></span><span leaf="">: np.random.choice([</span><span><span leaf="">"site x"</span></span><span leaf="">, </span><span><span leaf="">"site y"</span></span><span leaf="">], adata.n_obs),</span><span leaf=""><br></span><span leaf="">    },</span><span leaf=""><br></span><span leaf="">    index=adata.obs.index,  </span><span><span leaf=""># these are the same IDs of observations as above!</span></span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata = ad.AnnData(adata.X, obs=obs_meta, var=adata.var)</span><span leaf=""><br></span><span leaf="">adata</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">11.提取数据的方式</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">对 AnnData 进行索引时，整数参数 [] 的行为将类似于 pandas 的 .iloc，而字符串参数的行为则类似于 .loc。AnnData 始终假设使用字符串索引</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata_view = adata[:</span><span><span leaf="">5</span></span><span leaf="">, [</span><span><span leaf="">"Gene_1"</span></span><span leaf="">, </span><span><span leaf="">"Gene_3"</span></span><span leaf="">]]</span><span leaf=""><br></span><span leaf="">adata_view</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">print(adata[:</span><span><span leaf="">3</span></span><span leaf="">, </span><span><span leaf="">"Gene_1"</span></span><span leaf="">].X.toarray().tolist())</span><span leaf=""><br></span><span leaf="">adata[:</span><span><span leaf="">3</span></span><span leaf="">, </span><span><span leaf="">"Gene_1"</span></span><span leaf="">].X = [</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">print(adata[:</span><span><span leaf="">3</span></span><span leaf="">, </span><span><span leaf="">"Gene_1"</span></span><span leaf="">].X.toarray().tolist())</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># [[0.0], [2.0], [1.0]]</span></span><span leaf=""><br></span><span><span leaf=""># [[0.0], [0.0], [0.0]]</span></span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata_subset = adata[:</span><span><span leaf="">3</span></span><span leaf="">, [</span><span><span leaf="">"Gene_1"</span></span><span leaf="">, </span><span><span leaf="">"Gene_2"</span></span><span leaf="">]]</span><span leaf=""><br></span><span leaf="">adata_subset</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 增加一列foo ,里面含有数字1：3</span></span><span leaf=""><br></span><span leaf="">adata_subset.obs[</span><span><span leaf="">"foo"</span></span><span leaf="">] = range(</span><span><span leaf="">3</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata[adata.obs.time_yr.isin([</span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">4</span></span><span leaf="">])].obs.head()</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100005033" data-ratio="0.4908616187989556" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHAYfZ09Xo2tzOrSPYJnTU0mppNJiamuXNr2DJpgiasGG3vx6WYRy1PS0JFwpuRRZj8XDdqTrJ61VwA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="383" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHAYfZ09Xo2tzOrSPYJnTU0mppNJiamuXNr2DJpgiasGG3vx6WYRy1PS0JFwpuRRZj8XDdqTrJ61VwA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">参考资料：</span></span><span></span></h4><ol><li><section><span leaf="">single-cell-best-practices-zh github：https://github.com/master-XS/single-cell-best-practices-zh/tree/development/jupyter-book/introduction</span></section></li></ol></section><p><span leaf=""><br></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><strong><span leaf="">注</span></strong><span leaf="">：若对内容有疑惑或者有发现明确错误的朋友，请联系后台。更多相关内容可关注公众号：</span><strong><span leaf="">生信方舟</span></strong><span leaf=""> 。</span></p><h2 data-tool="mdnice编辑器"><span></span><span></span><span><span leaf="">结尾</span></span><span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">欢迎加入"</span><strong><span leaf="">生信&amp;临床</span></strong><span leaf="">“交流群，若有意向进群的小伙伴请加微信：</span><strong><span leaf="">couqiliugeziba321</span></strong><span leaf="">，请注明“</span><strong><span leaf="">单位或学校-专业或方向-姓名或昵称</span></strong><span leaf="">”。希望进群的你收获知识的同时也能够收获快乐~ 🤗<img data-imgfileid="100004857" data-ratio="0.5625" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/0SOG4MpDAyGHBmXVUqkHD93kSXqreoiaJCE8Dqgoo5icEaOOkaoO6WBVHAibwCYWM1E6rodTMyJ76qc3ZibeakWg7g/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="720" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/0SOG4MpDAyGHBmXVUqkHD93kSXqreoiaJCE8Dqgoo5icEaOOkaoO6WBVHAibwCYWM1E6rodTMyJ76qc3ZibeakWg7g/640?wx_fmt=jpeg&amp;from=appmsg"></span></p></section><p data-tool="mdnice编辑器"><span leaf=""><br></span></p></section></section><section><span><span leaf="">- END -</span></span></section><p><span leaf=""><br></span></p><p><span leaf=""><br></span></p><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/4bWJ9DUrqA38eYmQpy3Q-Q",target="_blank" rel="noopener noreferrer">原文链接</a>
