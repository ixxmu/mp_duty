---
title: "【学习笔记】Github Action部署workflow自动生成测试数据"
date: 2025-08-05T08:19:37Z
draft: ["false"]
tags: [
  "fetched",
  "Eula的生信小金鱼"
]
categories: ["Acdemic"]
---
【学习笔记】Github Action部署workflow自动生成测试数据 by Eula的生信小金鱼
------
<div><section data-tool="markdown编辑器" data-website="https://markdown.com.cn/editor" data-pm-slice="0 0 []"><h1 data-tool="markdown.com.cn编辑器"><span></span><span><span leaf=""><mp-common-clmusic data-pluginname="insertaudio" type="1" music_name="尘间星旅 Star Odyssey" albumurl="http://wx.y.gtimg.cn/music/photo_new/T002R500x500M000002itPL04LRG4h_1.jpg" singer="铃木爱理" count="0" is_vip="0" duration="194000" music_source="1" listenid="78352931706276321"></mp-common-clmusic></span></span></h1><blockquote><span><span leaf="">“</span></span><p><span leaf="">懒惰才是码农最好的品质</span></p><span></span></blockquote><h2 data-tool="markdown.com.cn编辑器"><span></span><span><span leaf="">写在前面</span></span></h2><p data-tool="markdown.com.cn编辑器"><span leaf="">好久没有更新公众号了。最近被主业搞得焦头烂额，手上几个开源社区的开发也没什么进展，整个人陷入了一种奇怪的迷茫。</span></p><p data-tool="markdown.com.cn编辑器"><span leaf="">前段时间发现HighFive这个c++库竟然有了CRAN可用的头文件包，只需在R包开发时link一下就能使用</span><span leaf="">。由于</span><code><span leaf="">BPCells</span></code><span leaf="">操作HDF5文件全部是基于HighFive，如果穿插使用</span><code><span leaf="">hdf5r</span></code><span leaf="">，会因为操作句柄的方式不同而产生很多未知冲突。现在，这不得把我的</span><code><span leaf="">hdf5r.Extra</span></code><span leaf="">用Rcpp重写一下？这样理论上就可以做到井水不犯河水。</span></p><p data-tool="markdown.com.cn编辑器"><span leaf="">之前写</span><code><span leaf="">hdf5r.Extra</span></code><span leaf="">的时候，我刻意让R的基础对象（</span><code><span leaf="">data.frame</span></code><span leaf="">、</span><code><span leaf="">matrix</span></code><span leaf="">或者稀疏矩阵等）全部按照</span><code><span leaf="">anndata</span></code><span leaf="">的格式规范来组织HDF5文件，这次重写也必定要保持这一点。这种涉及数据和文件结构的开发，离不开标准测试数据。然而，</span><code><span leaf="">anndata</span></code><span leaf="">毕竟是一个持续更新的软件，其数据格式偶尔会变化。那么，有没有一种办法，可以一键生成最新版</span><code><span leaf="">anndata</span></code><span leaf="">格式的</span><code><span leaf="">.h5ad</span></code><span leaf="">文件呢？</span></p><p data-tool="markdown.com.cn编辑器"><span leaf="">显然，写个python脚本就可以。但是，如果随便更新本地电脑上的</span><code><span leaf="">anndata</span></code><span leaf="">，很容易把原来的开发环境搞乱。而且，软件安装、脚本运行都会消耗本地的硬件和网络资源，还是有点麻烦。那么，有什么办法可以利用外部资源自动化完成环境部署、脚本运行和结果下载？</span></p><p data-tool="markdown.com.cn编辑器"><span leaf="">之前我写过一篇利用rhub + github action一键部署R包测试。那么，如果我用github action记录一个生成测试数据的workflow，当需要生成最新版本的</span><code><span leaf="">.h5ad</span></code><span leaf="">测试数据时，只需要一键点击运行workflow，是否就可以自动获得我需要的测试数据了？</span></p><h2 data-tool="markdown.com.cn编辑器"><span></span><span><span leaf="">准备工作</span></span></h2><p data-tool="markdown.com.cn编辑器"><span leaf="">新建一个github仓库</span><code><span leaf="">spatialdata_h5</span></code><span leaf="">，并clone到本地。添加如下文件：</span></p><pre data-tool="markdown.com.cn编辑器"><code><span leaf="">.`</span><span leaf=""><br></span><span leaf="">├── [ 511]  get_spatial_data.py</span><span leaf=""><br></span><span leaf="">├── [4.0K]  .github</span><span leaf=""><br></span><span leaf="">│   └── [4.0K]  workflows</span><span leaf=""><br></span><span leaf="">│       └── [ 729]  build-h5ad.yaml</span><span leaf=""><br></span><span leaf="">├── [  67]  README.md</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><p data-tool="markdown.com.cn编辑器"><span leaf="">其中</span><code><span leaf="">get_spatial_data.py</span></code><span leaf="">是用来生成测试数据的脚本，</span><code><span leaf="">.github/workflows</span></code><span leaf="">下则是各个workflow的配置文件。</span></p><p data-tool="markdown.com.cn编辑器"><code><span leaf="">get_spatial_data.py</span></code><span leaf="">比较简单，利用最新版的</span><code><span leaf="">spatialdata</span></code><span leaf="">和</span><code><span leaf="">squidpy</span></code><span leaf="">，从官方提供的示例数据中取子集，然后生成</span><code><span leaf="">AnnData</span></code><span leaf="">，并输出</span><code><span leaf="">.h5ad</span></code><span leaf="">文件：</span></p><pre data-tool="markdown.com.cn编辑器"><code><span leaf="">import geopandas as gpd</span><span leaf=""><br></span><span leaf="">import pandas as pd</span><span leaf=""><br></span><span leaf="">import spatialdata as sd</span><span leaf=""><br></span><span leaf="">import squidpy as sq</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">adata = sq.datasets.visium_hne_adata()</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">genes = adata.var.nlargest(200, "n_cells_by_counts").index</span><span leaf=""><br></span><span leaf="">cells = adata.obs.nlargest(100, "total_counts").index</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">adata = adata[cells, genes]</span><span leaf=""><br></span><span leaf="">print(adata)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">adata.write_h5ad("visium_mini.h5ad")</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><p data-tool="markdown.com.cn编辑器"><code><span leaf="">build-h5ad.yaml</span></code><span leaf="">就稍微复杂一点了：</span></p><ul><li><section><code><span leaf="">name</span></code><span leaf=""> 定义流程名称</span></section></li><li><section><code><span leaf="">on</span></code><span leaf=""> 定义触发方式</span></section></li><li><section><code><span leaf="">jobs</span></code><span leaf=""> 定义流程需要投递运行的任务：</span></section></li><ul><li><section><code><span leaf="">runs-on</span></code><span leaf=""> 定义操作系统</span></section></li><li><section><code><span leaf="">steps</span></code><span leaf=""> 定义任务的每个步骤。包括步骤的名称、命令和脚本等</span></section></li></ul></ul><pre data-tool="markdown.com.cn编辑器"><code><span leaf="">name: Build AnnData h5ad</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">on:</span><span leaf=""><br></span><span leaf="">  workflow_dispatch:   # 手动触发</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">jobs:</span><span leaf=""><br></span><span leaf="">  build:                              # 一个完整的job，名为build</span><span leaf=""><br></span><span leaf="">    runs-on: ubuntu-latest            # 该job使用的操作系统</span><span leaf=""><br></span><span leaf="">    steps:                            # 该job的每一个步骤</span><span leaf=""><br></span><span leaf="">      - name: Checkout repo           # 第一步的名称</span><span leaf=""><br></span><span leaf="">        uses: actions/checkout@v3     # 用uses直接引入github官方设置好的actions</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">      - name: Setup Python            # 第二步：设置python环境</span><span leaf=""><br></span><span leaf="">        uses: actions/setup-python@v4</span><span leaf=""><br></span><span leaf="">        with:</span><span leaf=""><br></span><span leaf="">          python-version: '3.12'</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">      - name: Install dependencies    # 第三步：安装依赖的软件，主要是spatialdata squidpy</span><span leaf=""><br></span><span leaf="">        run: |</span><span leaf=""><br></span><span leaf="">          pip install --upgrade pip</span><span leaf=""><br></span><span leaf="">          pip install --upgrade spatialdata squidpy</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">      - name: Run script to build h5ad  # 第四步：运行生成数据的脚本</span><span leaf=""><br></span><span leaf="">        run: python get_spatial_data.py</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">      - name: Upload h5ad artifact      # 第五步：将生成的.h5ad打包到artifact</span><span leaf=""><br></span><span leaf="">        uses: actions/upload-artifact@v4</span><span leaf=""><br></span><span leaf="">        with:</span><span leaf=""><br></span><span leaf="">          name: latest_h5ad</span><span leaf=""><br></span><span leaf="">          path: visium_mini.h5ad</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><p data-tool="markdown.com.cn编辑器"><span leaf="">整体上和</span><code><span leaf="">snakemake</span></code><span leaf="">有点像，就是规定了一个job的系统环境、每个步骤以及输入输出等。Github action会根据这个配置文件自动运行workflow。</span></p><p data-tool="markdown.com.cn编辑器"><span leaf="">把所有文件准备好就可以push到github仓库：</span><code><span leaf="">git add . git commit git push</span></code></p><h2 data-tool="markdown.com.cn编辑器"><span></span><span><span leaf="">运行流程</span></span></h2><p data-tool="markdown.com.cn编辑器"><span leaf="">打开github上的仓库，点击</span><code><span leaf="">Actions</span></code><span leaf="">，可以看到当前仓库已经配置的workflow。右上角有对应的运行按钮：</span></p><figure data-tool="markdown.com.cn编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/weQiaZ04F2NvtjdSDYgibyOO6tjb9HdmJR0wvHeOTFWzSGNxljyZY2NqJ9ujKFNVG3NgacRbDn3meI6zITwdXfUA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.3527777777777778" data-type="png" data-w="1080" data-imgfileid="100000345" src="https://mmbiz.qpic.cn/mmbiz_png/weQiaZ04F2NvtjdSDYgibyOO6tjb9HdmJR0wvHeOTFWzSGNxljyZY2NqJ9ujKFNVG3NgacRbDn3meI6zITwdXfUA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="markdown.com.cn编辑器"><span leaf="">点击</span><code><span leaf="">Run workflow</span></code><span leaf="">之后，整个流程就开始运行了。可以查看每一个step的输出日志，如果有报错中断，就需要修改workflow的配置文件，然后重复push + 运行的操作。</span></p><figure data-tool="markdown.com.cn编辑器"><span leaf=""><img data-imgfileid="100000347" data-ratio="0.5462962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/weQiaZ04F2NvtjdSDYgibyOO6tjb9HdmJRaibLmfEo4RJ6HOQehJNK4iaN454iagk2dz2mYR4Wo7QAQVsIR2nQhNUCg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/weQiaZ04F2NvtjdSDYgibyOO6tjb9HdmJRaibLmfEo4RJ6HOQehJNK4iaN454iagk2dz2mYR4Wo7QAQVsIR2nQhNUCg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="markdown.com.cn编辑器"><span leaf="">等流程成功运行完，</span><code><span leaf="">actions/upload-artifact</span></code><span leaf="">会提供一个下载链接，用浏览器就可以下载生成的测试数据啦！</span></p><figure data-tool="markdown.com.cn编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/weQiaZ04F2NvtjdSDYgibyOO6tjb9HdmJR8grxaibulwRzUbx6ZwEicTYdSGUKAwPmKClmbhmTBNf6bvyYy9Z5Y0pg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5324074074074074" data-type="png" data-w="1080" data-imgfileid="100000346" src="https://mmbiz.qpic.cn/mmbiz_png/weQiaZ04F2NvtjdSDYgibyOO6tjb9HdmJR8grxaibulwRzUbx6ZwEicTYdSGUKAwPmKClmbhmTBNf6bvyYy9Z5Y0pg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-tool="markdown.com.cn编辑器"><span></span><span><span leaf="">查看数据</span></span></h2><p data-tool="markdown.com.cn编辑器"><span leaf="">使用</span><code><span leaf="">h5ls</span></code><span leaf="">查看一下</span><code><span leaf="">anndata</span></code><span leaf="">的数据结构：</span></p><pre data-tool="markdown.com.cn编辑器"><code><span leaf="">h5ls -r visium_mini.h5ad </span><span leaf=""><br></span></code></pre><pre data-tool="markdown.com.cn编辑器"><code><span leaf="">/                        Group</span><span leaf=""><br></span><span leaf="">/X                       Group</span><span leaf=""><br></span><span leaf="">/X/data                  Dataset {19998/Inf}</span><span leaf=""><br></span><span leaf="">/X/indices               Dataset {19998/Inf}</span><span leaf=""><br></span><span leaf="">/X/indptr                Dataset {101/Inf}</span><span leaf=""><br></span><span leaf="">/layers                  Group</span><span leaf=""><br></span><span leaf="">/obs                     Group</span><span leaf=""><br></span><span leaf="">/obs/_index              Dataset {100}</span><span leaf=""><br></span><span leaf="">...</span><span leaf=""><br></span><span leaf="">/var/genome/categories   Dataset {1}</span><span leaf=""><br></span><span leaf="">/var/genome/codes        Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/highly_variable     Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/highly_variable_rank Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/log1p_mean_counts   Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/log1p_total_counts  Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/mean_counts         Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/means               Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/mt                  Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/n_cells             Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/n_cells_by_counts   Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/pct_dropout_by_counts Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/total_counts        Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/variances           Dataset {200}</span><span leaf=""><br></span><span leaf="">/var/variances_norm      Dataset {200}</span><span leaf=""><br></span><span leaf="">/varm                    Group</span><span leaf=""><br></span><span leaf="">/varm/PCs                Dataset {200, 50}</span><span leaf=""><br></span><span leaf="">/varp                    Group</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><h2 data-tool="markdown.com.cn编辑器"><span></span><span><span leaf="">写在后面</span></span></h2><p data-tool="markdown.com.cn编辑器"><span leaf="">至此，当我需要生成最新版</span><code><span leaf="">anndata</span></code><span leaf="">规范的测试数据时，只需要一键运行这个workflow，它就会自动配置软件环境，运行github上写好的python脚本，而我只需要等着下载数据即可。</span></p><p data-tool="markdown.com.cn编辑器"><span leaf="">当然，Github action的作用远不止于此，理论上任何需要反复运行的流程或测试，都可以通过配置workflow来完成，一次配置，自动运行，真正解放脑力和体力！而且整个实操学习的过程都是chatGPT帮助我完成的，跑通的一瞬间感觉重拾了初学生信时的成就感！</span></p><p data-tool="markdown.com.cn编辑器"><span leaf="">等我把封装</span><code><span leaf="">highfive</span></code><span leaf="">的R包写完，也许会再更一篇教程，看情况吧。目前的几个业余项目，仍然是在围绕</span><code><span leaf="">BPCells</span></code><span leaf="">做拓展开发。现实总比梦想要骨感，主业和生活还是一地鸡毛。不过嘛，人会被现实打败，不可以被现实打倒！</span></p></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/NA-EIypvsP8H6z7ebxaIdA",target="_blank" rel="noopener noreferrer">原文链接</a>
