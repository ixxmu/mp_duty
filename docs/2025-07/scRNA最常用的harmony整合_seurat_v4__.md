---
title: "scRNA最常用的harmony整合（seurat v4 ）"
date: 2025-07-18T10:50:06Z
draft: ["false"]
tags: [
  "fetched",
  "seqyuan"
]
categories: ["Acdemic"]
---
scRNA最常用的harmony整合（seurat v4 ） by seqyuan
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">seurat v4 分析环境配置</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">install.packages(</span><span><span leaf="">'devtools'</span></span><span leaf="">)</span><br><span leaf="">remotes::install_github(</span><span><span leaf="">"carmonalab/UCell"</span></span><span leaf="">, ref=</span><span><span leaf="">"v2.2"</span></span><span leaf="">)</span><br><span leaf="">remotes::install_github(</span><span><span leaf="">"immunogenomics/presto"</span></span><span leaf="">, upgrade=</span><span><span leaf="">'never'</span></span><span leaf="">)</span><br><span leaf="">remotes::install_version(</span><span><span leaf="">"Matrix"</span></span><span leaf="">,version = </span><span><span leaf="">"1.6-1.1"</span></span><span leaf="">, INSTALL_opts = </span><span><span leaf="">'--no-lock'</span></span><span leaf="">, force=</span><span><span leaf="">TRUE</span></span><span leaf="">, upgrade=</span><span><span leaf="">'never'</span></span><span leaf="">)</span><br><span leaf="">remotes::install_version(</span><span><span leaf="">"SeuratObject"</span></span><span leaf="">, </span><span><span leaf="">"4.1.4"</span></span><span leaf="">, repos = c(</span><span><span leaf="">"https://satijalab.r-universe.dev"</span></span><span leaf="">, getOption(</span><span><span leaf="">"repos"</span></span><span leaf="">)), upgrade=</span><span><span leaf="">'never'</span></span><span leaf="">)</span><br><span leaf="">remotes::install_version(package = </span><span><span leaf="">'Seurat'</span></span><span leaf="">, version = package_version(</span><span><span leaf="">'4.4.0'</span></span><span leaf="">), upgrade=</span><span><span leaf="">'never'</span></span><span leaf="">)</span><br><span leaf="">remotes::install_github(</span><span><span leaf="">'seqyuan/s4wrapper'</span></span><span leaf="">)</span><br><span leaf="">remotes::install_github(</span><span><span leaf="">'mojaveazure/seurat-disk'</span></span><span leaf="">, upgrade=</span><span><span leaf="">'never'</span></span><span leaf="">)</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">1. 载入包、读入测试数据</span></span><span></span></h2><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">library</span></span><span leaf="">(Seurat)</span><br><span><span leaf="">library</span></span><span leaf="">(dplyr)</span><br><span><span leaf="">library</span></span><span leaf="">(s4wrapper)</span><br><span><span leaf="">library</span></span><span leaf="">(ggplot2)</span><br><span><span leaf="">library</span></span><span leaf="">(harmony)</span><br><span leaf="">load(file=</span><span><span leaf="">'ifnb.rda'</span></span><span leaf="">)</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">2. 标准化-计算高变基因-PCA线性降维</span></span><span></span></h2><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">unique(ifnb@meta.data$stim)</span><br><span><span leaf=""># 'CTRL''STIM'</span></span><br><br><span leaf="">rds &lt;- NormalizeData(ifnb, normalization.method = </span><span><span leaf="">"LogNormalize"</span></span><span leaf="">, scale.factor = </span><span><span leaf="">10000</span></span><span leaf="">) %&gt;% </span><br><span leaf="">    FindVariableFeatures() %&gt;% ScaleData() %&gt;% </span><br><span leaf="">    RunPCA(verbose=</span><span><span leaf="">FALSE</span></span><span leaf="">)</span><br><span leaf="">    </span><br><span leaf="">ElbowPlot(rds)</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100001009" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKlUv1DYbquLYpzQ1lyVDpB2csqsNF7frKW8Ektn7WHlKic42pzggzysw/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKlUv1DYbquLYpzQ1lyVDpB2csqsNF7frKW8Ektn7WHlKic42pzggzysw/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">3. Harmony整合分群</span></span><span></span></h2><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">rds &lt;- RunHarmony(rds, group.by.vars = </span><span><span leaf="">"orig.ident"</span></span><span leaf="">)</span><br><span leaf="">rds &lt;- RunUMAP(rds, reduction = </span><span><span leaf="">"harmony"</span></span><span leaf="">, dims = </span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">20</span></span><span leaf="">)</span><br><span leaf="">rds &lt;- FindNeighbors(rds, reduction = </span><span><span leaf="">"harmony"</span></span><span leaf="">, dims = </span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">20</span></span><span leaf="">)</span><br><br><span leaf="">rds &lt;- FindClusters(rds, resolution = </span><span><span leaf="">0.3</span></span><span leaf="">)</span><br><span leaf="">p &lt;- DimPlot(rds, group.by = c(</span><span><span leaf="">"seurat_clusters"</span></span><span leaf="">, </span><span><span leaf="">"seurat_annotations"</span></span><span leaf="">),</span><br><span leaf="">              combine = </span><span><span leaf="">TRUE</span></span><span leaf="">, </span><br><span leaf="">             label.size = </span><span><span leaf="">4</span></span><span leaf="">, </span><br><span leaf="">             label=</span><span><span leaf="">TRUE</span></span><span leaf="">)</span><br><br><span leaf="">options(repr.plot.width=</span><span><span leaf="">11</span></span><span leaf="">, repr.plot.height=</span><span><span leaf="">5</span></span><span leaf="">)</span><br><span leaf="">p</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100001012" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKWL4Oiaf6yLsdX5RSFODYscoZDPs8m4GHaOSibPic49yKAgvPDW1dpTtCA/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKWL4Oiaf6yLsdX5RSFODYscoZDPs8m4GHaOSibPic49yKAgvPDW1dpTtCA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">下面是<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU1MDMyNzUyNQ==&amp;mid=2247484537&amp;idx=1&amp;sn=a1f1a2c85351e004a8e174bb320b4663&amp;scene=21#wechat_redirect" textvalue="" linktype="text" data-linktype="2">Seurat V5 harmony的整合效果</a>，两个版本基本是一致的。<img data-imgfileid="100001011" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQK5icaSbISricEzN6OEgCQCx57eYOHZibGjgw8fric4luajonktwRfUwgn1g/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQK5icaSbISricEzN6OEgCQCx57eYOHZibGjgw8fric4luajonktwRfUwgn1g/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">harmony整合聚类与数据自带的细胞注释标签overlap可以帮助判断分群效果</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">options(repr.plot.width=</span><span><span leaf="">10</span></span><span leaf="">, repr.plot.height=</span><span><span leaf="">7</span></span><span leaf="">)</span><br><span leaf="">par(mar = c(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">))</span><br><span leaf="">gplots::balloonplot(table(rds$seurat_clusters, rds$seurat_annotations), rowmar=</span><span><span leaf="">3</span></span><span leaf="">, colmar=</span><span><span leaf="">1</span></span><span leaf="">)</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100001010" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKtqLGEkjS55TCSWic1ickko32BhFezQMyIyicRwgJTLTky587IySdlWyGA/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKtqLGEkjS55TCSWic1ickko32BhFezQMyIyicRwgJTLTky587IySdlWyGA/640?wx_fmt=png&amp;from=appmsg"></span></figure><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">cell_fraction &lt;- </span><span><span leaf="">function</span></span><span leaf="">(RDS, group=c(</span><span><span leaf="">'orig.ident'</span></span><span leaf="">, </span><span><span leaf="">'celltype0'</span></span><span leaf="">)){</span><br><span leaf="">    sample_cluster_cells &lt;- table(RDS@meta.data[[group[</span><span><span leaf="">1</span></span><span leaf="">]]], RDS@meta.data[[group[</span><span><span leaf="">2</span></span><span leaf="">]]])</span><br><span leaf="">    sample_cluster_cells &lt;- as.data.frame(sample_cluster_cells)</span><br><span leaf="">    colnames(sample_cluster_cells) &lt;- c(group, </span><span><span leaf="">'cellnumber'</span></span><span leaf="">)</span><br><span leaf="">    </span><br><span leaf="">    p1 &lt;- ggplot(sample_cluster_cells, aes_string(x=group[</span><span><span leaf="">1</span></span><span leaf="">], weight=</span><span><span leaf="">"cellnumber"</span></span><span leaf="">, fill=group[</span><span><span leaf="">2</span></span><span leaf="">]))+</span><br><span leaf="">      geom_bar(position=</span><span><span leaf="">"fill"</span></span><span leaf="">,width = </span><span><span leaf="">0.7</span></span><span leaf="">,size = </span><span><span leaf="">0.5</span></span><span leaf="">,colour = </span><span><span leaf="">NA</span></span><span leaf="">)+</span><br><span leaf="">      theme(panel.grid = element_blank(),</span><br><span leaf="">            panel.background = element_rect(fill = </span><span><span leaf="">"transparent"</span></span><span leaf="">,colour = </span><span><span leaf="">NA</span></span><span leaf="">),</span><br><span leaf="">            axis.line.x = element_line(colour = </span><span><span leaf="">"black"</span></span><span leaf="">),</span><br><span leaf="">            axis.line.y = element_line(colour = </span><span><span leaf="">"black"</span></span><span leaf="">),</span><br><span leaf="">            axis.text.x = element_text(size = </span><span><span leaf="">12</span></span><span leaf="">),</span><br><span leaf="">            axis.text.y = element_text(size = </span><span><span leaf="">12</span></span><span leaf="">),</span><br><span leaf="">            plot.title = element_text(lineheight=</span><span><span leaf="">.8</span></span><span leaf="">, face=</span><span><span leaf="">"bold"</span></span><span leaf="">, hjust=</span><span><span leaf="">0.5</span></span><span leaf="">, size =</span><span><span leaf="">16</span></span><span leaf="">)</span><br><span leaf="">      )+labs(y=</span><span><span leaf="">"Percentage"</span></span><span leaf="">)+RotatedAxis()+coord_flip()</span><br><span leaf="">    </span><br><br><span leaf="">    </span><span><span leaf="">return</span></span><span leaf="">(p1)</span><br><span leaf="">}</span><br><br><span leaf="">p &lt;- cell_fraction(rds, group=c(</span><span><span leaf="">'stim'</span></span><span leaf="">, </span><span><span leaf="">'seurat_clusters'</span></span><span leaf="">))</span><br><span leaf="">options(repr.plot.width=</span><span><span leaf="">7</span></span><span leaf="">, repr.plot.height=</span><span><span leaf="">4</span></span><span leaf="">)</span><br><span leaf="">p</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100001008" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKZa7Dq7RJRHibeczcxlLEmJO4Xz6zD3hYKpeuia87gJnKPWWRcAvQOwIQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKZa7Dq7RJRHibeczcxlLEmJO4Xz6zD3hYKpeuia87gJnKPWWRcAvQOwIQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">4. 计算marker gene</span></span><span></span></h2><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">allmarkers &lt;- RunPrestoAll(rds, logfc.threshold = </span><span><span leaf="">0.15</span></span><span leaf="">, min.pct = </span><span><span leaf="">0.1</span></span><span leaf="">)</span><br><span leaf="">write.table(allmarkers, </span><span><span leaf="">"all_markers.tsv"</span></span><span leaf="">, sep=</span><span><span leaf="">"\t"</span></span><span leaf="">, quote=</span><span><span leaf="">FALSE</span></span><span leaf="">)</span><br><br><span><span leaf="">library</span></span><span leaf="">(dplyr)</span><br><span leaf="">allmarkers %&gt;%</span><br><span leaf="">    group_by(cluster) %&gt;%</span><br><span leaf="">    dplyr::filter(avg_log2FC &gt; </span><span><span leaf="">0.2</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    arrange(desc(avg_log2FC)) %&gt;%</span><br><span leaf="">    slice_head(n = </span><span><span leaf="">7</span></span><span leaf="">) %&gt;%</span><br><span leaf="">    ungroup() -&gt; top7</span><br><span leaf="">    </span><br><span><span leaf="">library</span></span><span leaf="">(ggplot2)</span><br><span leaf="">plot_dot &lt;- </span><span><span leaf="">function</span></span><span leaf="">(RDS, markers, group.by=</span><span><span leaf="">"rpca_clusters"</span></span><span leaf="">){</span><br><span leaf="">    genes &lt;- as.vector(unlist(markers))</span><br><span leaf="">    tmp &lt;- ScaleData(RDS, features = genes, verbose = </span><span><span leaf="">FALSE</span></span><span leaf="">)</span><br><br><span leaf="">    p &lt;- DotPlot(tmp, features=markers, group.by = group.by) + </span><br><span leaf="">        theme(axis.text.x = element_text(angle=</span><span><span leaf="">60</span></span><span leaf="">, vjust=</span><span><span leaf="">1</span></span><span leaf="">, hjust=</span><span><span leaf="">1</span></span><span leaf="">)) + </span><br><span leaf="">        xlab(</span><span><span leaf="">''</span></span><span leaf="">)+ylab(</span><span><span leaf="">''</span></span><span leaf="">) +</span><br><span leaf="">        guides(color = guide_colorbar(title = </span><span><span leaf="">'Scaled expression'</span></span><span leaf="">,order = </span><span><span leaf="">1</span></span><span leaf="">),</span><br><span leaf="">               size = guide_legend(</span><span><span leaf="">"Percent expressed"</span></span><span leaf="">), order = </span><span><span leaf="">0</span></span><span leaf=""> ) +</span><br><span leaf="">        scale_colour_gradientn(colours = c(</span><span><span leaf="">"dodgerblue1"</span></span><span leaf="">,</span><span><span leaf="">"#44c1f0"</span></span><span leaf="">, </span><span><span leaf="">'#fe2f4a'</span></span><span leaf="">)) + </span><br><span leaf="">        </span><span><span leaf="">#scale_colour_gradientn(colours = c("dodgerblue1","#44c1f0", "lightgoldenrod","#e20612",'#cc340c'))+  </span></span><br><span leaf="">        theme(legend.position = </span><span><span leaf="">"top"</span></span><span leaf="">) +</span><br><span leaf="">        </span><span><span leaf="">#theme(panel.border = element_rect(fill=NA,color="black", size=, linetype="solid")) +</span></span><br><span leaf="">        geom_point(aes(size=pct.exp), shape = </span><span><span leaf="">21</span></span><span leaf="">, colour=</span><span><span leaf="">NA</span></span><span leaf="">, stroke=</span><span><span leaf="">NA</span></span><span leaf="">)</span><br><br><span leaf="">    </span><span><span leaf="">return</span></span><span leaf="">(p)</span><br><span leaf="">}</span><br><br><span leaf="">p &lt;- plot_dot(rds, unique(top7$gene), </span><span><span leaf="">"seurat_clusters"</span></span><span leaf="">)</span><br><span leaf="">options(repr.plot.width=</span><span><span leaf="">18</span></span><span leaf="">, repr.plot.height=</span><span><span leaf="">6</span></span><span leaf="">)</span><br><span leaf="">p</span><br></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100001013" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKovT9XG81Kxmia34fSJNrsQkfKAp8bmVadLsyLKVzg9n59aIiaGyvQiaNw/640?wx_fmt=png&amp;from=appmsg" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDwhCMD0FuRJBI5axibtFLGQKovT9XG81Kxmia34fSJNrsQkfKAp8bmVadLsyLKVzg9n59aIiaGyvQiaNw/640?wx_fmt=png&amp;from=appmsg"></span></figure></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/zMb5loV6IcnCqydtxwyshA",target="_blank" rel="noopener noreferrer">原文链接</a>
