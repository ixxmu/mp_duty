---
title: "一个新版本的geom_xspline"
date: 2025-07-23T00:32:21Z
draft: ["false"]
tags: [
  "fetched",
  "YuLabSMU"
]
categories: ["Acdemic"]
---
一个新版本的geom_xspline by YuLabSMU
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7pcX89K9I6P6p5utT7uRxia3dKBECVc30ppnRAIElxIyfYMrGtyM0jiaQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9361111111111111" data-type="png" data-w="1080" data-imgfileid="100013763" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7pcX89K9I6P6p5utT7uRxia3dKBECVc30ppnRAIElxIyfYMrGtyM0jiaQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">收到CRAN的邮件，</span><code><span leaf="">ggalt</span></code><span leaf="">包即将移除，有几个包是使用了</span><code><span leaf="">ggalt</span></code><span leaf="">的，其中就包括我们团队的</span><code><span leaf="">ggmsa</span></code><span leaf="">，在这个包里，我们只在</span><code><span leaf="">ggSeqBundle</span></code><span leaf="">这一函数里调用了</span><code><span leaf="">ggalt::geom_xspline()</span></code><span leaf="">一个函数而已。</span></p><p data-tool="mdnice编辑器"><span leaf="">既然这样，那我就自己写一个吧。写之前，我先翻一下</span><code><span leaf="">ggalt</span></code><span leaf="">包，看他是怎么写的。</span></p><p data-tool="mdnice编辑器"><span leaf="">代码很简单，首先你得算出来xpline的坐标：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7ms87qJybEtBaRISPUPC5ajfW6uq9kYt435AnzRdL1p1eP7ibicIAH2XA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5953703703703703" data-type="png" data-w="1080" data-imgfileid="100013761" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7ms87qJybEtBaRISPUPC5ajfW6uq9kYt435AnzRdL1p1eP7ibicIAH2XA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">用了</span><code><span leaf="">xspline</span></code><span leaf="">函数，这是基于base plot的画图函数，然后这个函数在画图的时候，会悄咪咪地返回坐标。于是他就调用它去拿坐标。但是调用它会画图啊，于是他很聪明地把它画到文件里，然后画完把文件给删了。于是你在用它的时候，感受不到画图。如果不写文件，画图会弹窗，而如果你远程服务器，又没有窗口服务，那就会报错。所以这一招，既不出错，也毫无痕迹。</span></p><p data-tool="mdnice编辑器"><span leaf="">额外话，拿个画图数据挺有意思，比如我们可以拿</span><code><span leaf="">hist</span></code><span leaf="">的数据，然后用</span><code><span leaf="">ggplot2</span></code><span leaf="">画，就能画出一模一样的：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7eu9pVX1NADqzT6XHq8MGwAZyqyNztIOUPapb5g0OoY6Zia14kicjzJPg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.700925925925926" data-type="png" data-w="1080" data-imgfileid="100013762" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7eu9pVX1NADqzT6XHq8MGwAZyqyNztIOUPapb5g0OoY6Zia14kicjzJPg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">有了坐标，画图其实就是画线条，和</span><code><span leaf="">geom_line()</span></code><span leaf="">没区别：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7vqLnh3k9jvXYfa125kLFClL4hWLmicia5NFxLNunic8icnDvynmUH98pXA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.17777777777777778" data-type="png" data-w="1080" data-imgfileid="100013760" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7vqLnh3k9jvXYfa125kLFClL4hWLmicia5NFxLNunic8icnDvynmUH98pXA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">就是这么简单。但是它毕竟调用了base plot，虽然巧妙地解决了，但我想我再写一个的时候，还是避免这一过程吧。</span></p><p data-tool="mdnice编辑器"><span leaf="">那我自己写一个版本的</span><code><span leaf="">geom_xspline()</span></code><span leaf="">，我就只写这一个图层，不写</span><code><span leaf="">StatXspline</span></code><span leaf="">，没有一个需要去拿坐标的操作，直接是画图的图层，怎么画？最终是调用</span><code><span leaf="">grid::xsplineGrob()</span></code><span leaf="">来出图。我写的参数也和</span><code><span leaf="">ggalt::geom_xspline()</span></code><span leaf="">有一点差别：</span></p><ul><li><section><p><code><span leaf="">spline_shape</span></code><span leaf="">参数我改成</span><code><span leaf="">shape</span></code><span leaf="">，因为画线条，不会用到</span><code><span leaf="">shape</span></code><span leaf="">这个参数，不需要区别。</span></p></section></li><li><section><p><code><span leaf="">size</span></code><span leaf="">参数我换成</span><code><span leaf="">linewidth</span></code><span leaf="">，这个和当前的</span><code><span leaf="">ggplot2</span></code><span leaf="">版本匹配。</span></p></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">你只要改这两个参数，就完全可以和</span><code><span leaf="">ggalt::geom_xspline()</span></code><span leaf="">一样用。我们以</span><code><span leaf="">ggalt</span></code><span leaf="">的示例为例子：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">set.seed(</span><span><span leaf="">1492</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">dat &lt;- data.frame(x=c(</span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">:</span><span><span leaf="">10</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                  y=c(sample(</span><span><span leaf="">15</span></span><span leaf="">:</span><span><span leaf="">30</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">), </span><span><span leaf="">2</span></span><span leaf="">*sample(</span><span><span leaf="">15</span></span><span leaf="">:</span><span><span leaf="">30</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                      </span><span><span leaf="">3</span></span><span leaf="">*sample(</span><span><span leaf="">15</span></span><span leaf="">:</span><span><span leaf="">30</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">)),</span><span leaf=""><br></span><span leaf="">                  group=factor(c(rep(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">), rep(</span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">), rep(</span><span><span leaf="">3</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">)))</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7Ss0qktic0icT29e2iaiclSw0E835VmGNTee8LGNiabKZiaONzgh278GP1lSQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9074074074074074" data-type="png" data-w="1080" data-imgfileid="100013764" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7Ss0qktic0icT29e2iaiclSw0E835VmGNTee8LGNiabKZiaONzgh278GP1lSQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">我们用几乎一样的代码，除了把这两参数改了：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">ggplot(dat, aes(x, y, group=group, color=factor(group))) +</span><span leaf=""><br></span><span leaf="">  geom_point(color=</span><span><span leaf="">"black"</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  geom_smooth(se=</span><span><span leaf="">FALSE</span></span><span leaf="">, linetype=</span><span><span leaf="">"dashed"</span></span><span leaf="">, linewidth=</span><span><span leaf="">0.5</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  geom_xspline(shape=</span><span><span leaf="">1</span></span><span leaf="">, linewidth=</span><span><span leaf="">0.5</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">就能一样的出图了（仔细对比，图的坐标点有变化，这应该是不同R版本的随机数函数有更新的缘故）：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z783hYiasAfeic7IB7HghKhpk657RowajVTVT8efHGfDJCArKRIZq0YuNw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6583333333333333" data-type="png" data-w="1080" data-imgfileid="100013768" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z783hYiasAfeic7IB7HghKhpk657RowajVTVT8efHGfDJCArKRIZq0YuNw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">所以你只要改了这两个参数，原来调用</span><code><span leaf="">ggalt::xspline()</span></code><span leaf="">就可以完全换成</span><code><span leaf="">ggfun::xspline()</span></code><span leaf="">了。这个图层放在</span><code><span leaf="">ggfun</span></code><span leaf="">包里，这是我们课题组一些基础的图层、主题等和</span><code><span leaf="">ggplot2</span></code><span leaf="">相关的基础功能，在我们各种可视化包中，可能会被不同包反复调用的功能，都会放在此包，是我们可视化包的基础设施。要想用这个功能，你需要</span><code><span leaf="">ggfun</span></code><span leaf="">版本</span><code><span leaf="">v&gt;=0.2.0</span></code><span leaf="">。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7TLwRqXN9VTlZzpNpCUU7pKNyuvJxC5FmcLfXA8sfmmHZ9MobCHC9dQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.11851851851851852" data-type="png" data-w="1080" data-imgfileid="100013767" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7TLwRqXN9VTlZzpNpCUU7pKNyuvJxC5FmcLfXA8sfmmHZ9MobCHC9dQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">周六在长沙参加2025 The Innovation Conference，在酒店里写下了这个图层。</span></p><p data-tool="mdnice编辑器"><span leaf="">这样子，我们把</span><code><span leaf="">ggmsa::ggSeqBundle()</span></code><span leaf="">里调用</span><code><span leaf="">gglat::geom_xspline()</span></code><span leaf="">换成</span><code><span leaf="">ggfun::geom_xspline()</span></code><span leaf="">，就大功告成，照样出图：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">library</span></span><span leaf="">(ggmsa)</span><span leaf=""><br></span><span leaf="">aln &lt;- system.file(</span><span><span leaf="">"extdata"</span></span><span leaf="">, </span><span><span leaf="">"Gram-negative_AKL.fasta"</span></span><span leaf="">, package = </span><span><span leaf="">"ggmsa"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ggSeqBundle(aln)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7guZoY5w9Seia2GS5zVpJT0gCEQ6vcevqZXRL5yqPkY3JROQFfvMiaGPg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6138888888888889" data-type="png" data-w="1080" data-imgfileid="100013769" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4n0cBDH8icwHicvH2OFfDH7z7guZoY5w9Seia2GS5zVpJT0gCEQ6vcevqZXRL5yqPkY3JROQFfvMiaGPg/640?wx_fmt=png&amp;from=appmsg"></span></figure><ol><li><section><p><span leaf="">更多</span><code><span leaf="">ggmsa</span></code><span leaf="">的介绍，请猛击《<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzI5NjUyNzkxMg==&amp;mid=2247492065&amp;idx=1&amp;sn=e26a3c3ab575d575c9df4cb3204c3540&amp;scene=21#wechat_redirect" textvalue="" linktype="text" data-linktype="2">文章发表：ggmsa - 多序列比对和相关数据的可视化探索工具</a>》。</span></p></section></li><li><section><p><span leaf="">如果有别的包，也是用了</span><code><span leaf="">geom_xspline()</span></code><span leaf="">，就可以无痛迁移到</span><code><span leaf="">ggfun</span></code><span leaf="">包，不受</span><code><span leaf="">ggalt</span></code><span leaf="">下架的影响。</span></p></section></li></ol><section><section><section><span leaf=""><br></span></section></section><section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kRyPGNB6yZWxGd3Kd5gwlqlrY8dKXJ1ic4eESy51diaUstLVl34OPSowVWIojBB3YRCpnePvzFtLDQ/640?wx_fmt=png" data-ratio="1.25140712945591" data-type="jpg" data-w="1066" src="https://mmbiz.qpic.cn/mmbiz_png/MPBFtnFrw4kRyPGNB6yZWxGd3Kd5gwlqlrY8dKXJ1ic4eESy51diaUstLVl34OPSowVWIojBB3YRCpnePvzFtLDQ/640?wx_fmt=png"></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/3d-snC56x5B6t099AVViUA",target="_blank" rel="noopener noreferrer">原文链接</a>
