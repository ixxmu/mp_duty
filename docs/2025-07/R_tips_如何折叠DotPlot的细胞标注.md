---
title: "R tips：如何折叠DotPlot的细胞标注"
date: 2025-07-24T23:30:45Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
R tips：如何折叠DotPlot的细胞标注 by 生信菜鸟团
------
<div><p data-pm-slice="0 0 []"><span leaf="">Seurat绘制细胞的marker DotPlot时，如果细胞名称过长或者相应细胞的marker gene太少则可能会导致细胞名称显示不全，看如下实例，以Seurat自带的pbmc_small数据集为例，寻找其差异表达gene作为绘制Dotplot的marker gene。</span></p><pre><ol><li><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">Seurat</span></span><span><span leaf="">)</span></span></code></li><li><code><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span><span leaf="">tidyverse</span></span><span><span leaf="">)</span></span></code></li><li><code></code></li><li><code><span><span leaf="">all_markers </span></span><span><span leaf="">&lt;-</span></span></code></li><li><code><span><span leaf="">  pbmc_small </span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span></span><span><span leaf="">FindAllMarkers</span></span><span><span leaf="">(</span></span><span><span leaf="">group</span></span><span><span leaf="">.</span></span><span><span leaf="">by</span></span><span></span><span><span leaf="">=</span></span><span></span><span><span leaf="">"RNA_snn_res.0.8"</span></span><span><span leaf="">)</span></span></code></li><li><code></code></li><li><code><span><span leaf="">marker_gene </span></span><span><span leaf="">&lt;-</span></span></code></li><li><code><span><span leaf="">  all_markers </span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  group_by</span></span><span><span leaf="">(</span></span><span><span leaf="">cluster</span></span><span><span leaf="">)</span></span><span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  dplyr</span></span><span><span leaf="">::</span></span><span><span leaf="">filter</span></span><span><span leaf="">(</span></span></code></li><li><code><span><span leaf="">    p_val </span></span><span><span leaf="">&lt;</span></span><span></span><span><span leaf="">0.05</span></span><span><span leaf="">,</span></span></code></li><li><code><span><span leaf="">    pct</span></span><span><span leaf="">.</span></span><span><span leaf="">1</span></span><span></span><span><span leaf="">-</span></span><span><span leaf=""> pct</span></span><span><span leaf="">.</span></span><span><span leaf="">2</span></span><span></span><span><span leaf="">&gt;</span></span><span></span><span><span leaf="">0.2</span></span></code></li><li><code><span></span><span><span leaf="">)</span></span><span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  slice_max</span></span><span><span leaf="">(</span></span><span><span leaf="">avg_log2FC</span></span><span><span leaf="">,</span></span><span><span leaf=""> n </span></span><span><span leaf="">=</span></span><span></span><span><span leaf="">5</span></span><span><span leaf="">)</span></span><span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  dplyr</span></span><span><span leaf="">::</span></span><span><span leaf="">select</span></span><span><span leaf="">(</span></span><span><span leaf="">cluster</span></span><span><span leaf="">,</span></span><span><span leaf=""> gene</span></span><span><span leaf="">)</span></span><span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  deframe</span></span><span><span leaf="">()</span></span></code></li><li><code></code></li><li><code><span><span leaf="">marker_gene</span></span></code></li><li><code><span><span leaf=""># 0        0        0        0        0        1        1        1        1        1 </span></span></code></li><li><code><span><span leaf=""># "GZMM"   "GNLY"   "PRF1"   "GZMA"   "CTSW" "S100A8"   "CD14" "S100A9"   "FPR1"  "ASGR1" </span></span></code></li></ol></pre><p><span leaf="">根据差异基因的类别，指定0是cytotoxic T lymphocyte，1是myeloid cells，并绘制DotPlot：</span></p><pre><ol><li><code><span><span leaf="">names</span></span><span><span leaf="">(</span></span><span><span leaf="">marker_gene</span></span><span><span leaf="">)</span></span><span></span><span><span leaf="">&lt;-</span></span></code></li><li><code><span><span leaf="">  marker_gene </span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  names</span></span><span><span leaf="">()</span></span><span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  fct_recode</span></span><span><span leaf="">(</span></span></code></li><li><code><span></span><span><span leaf="">"cytotoxic T lymphocyte"</span></span><span></span><span><span leaf="">=</span></span><span></span><span><span leaf="">'0'</span></span><span><span leaf="">,</span></span></code></li><li><code><span></span><span><span leaf="">"myeloid cells"</span></span><span></span><span><span leaf="">=</span></span><span></span><span><span leaf="">'1'</span></span></code></li><li><code><span></span><span><span leaf="">)</span></span></code></li><li><code></code></li><li><code><span><span leaf="">p </span></span><span><span leaf="">&lt;-</span></span></code></li><li><code><span></span><span><span leaf="">DotPlot</span></span><span><span leaf="">(</span></span></code></li><li><code><span><span leaf="">    pbmc_small</span></span><span><span leaf="">,</span></span></code></li><li><code><span></span><span><span leaf="">group</span></span><span><span leaf="">.</span></span><span><span leaf="">by</span></span><span></span><span><span leaf="">=</span></span><span></span><span><span leaf="">"RNA_snn_res.0.8"</span></span><span><span leaf="">,</span></span></code></li><li><code><span><span leaf="">    features </span></span><span><span leaf="">=</span></span><span><span leaf=""> marker_gene</span></span></code></li><li><code><span></span><span><span leaf="">)</span></span></code></li><li><code><span><span leaf=""> p</span></span></code></li></ol></pre><p><span leaf="">理论上讲，这个图调宽是可以避开显示不全的问题的，但是实际场景中，这个图不可能无限加宽，不然比例失调。本例中每个细胞是5个marker基因，但是实际绘图是有可能只展示一个marker基因的，这个时候遮挡几乎是必然发生的事情，而肆意加宽图片往往都是很受限制的行为。</span></p><p><span leaf="">为了模拟效果，这里设置了一个较为窄的宽度，可以看到cell label的折叠状态：</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8uoFlibLCjZy6icYZa1icZoFcR71ia3jicpRbT7nZsib0bVZ4iaJkAw04F2qgd8KBmbCiaTExCcjsz6p1U7Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="1" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100051894" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8uoFlibLCjZy6icYZa1icZoFcR71ia3jicpRbT7nZsib0bVZ4iaJkAw04F2qgd8KBmbCiaTExCcjsz6p1U7Q/640?wx_fmt=png&amp;from=appmsg"></section><p><span leaf=""><br></span></p><p><span leaf="">可以发现上图有两个问题：x轴文字遮挡和上面的细胞label遮挡。x轴遮挡好解决，只需要加上Seurat的RotatedAxis即可。</span></p><pre><ol><li><code><span><span leaf="">p2 </span></span><span><span leaf="">&lt;-</span></span><span><span leaf=""> p </span></span><span><span leaf="">+</span></span><span></span><span><span leaf="">RotatedAxis</span></span><span><span leaf="">()</span></span></code></li><li><code><span><span leaf="">p2</span></span></code></li></ol></pre><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8uoFlibLCjZy6icYZa1icZoFcPwVgeZtUGGCwLsgLAW8GjWngmPDYF4OyicgYNaks8KaIZqUIniaaR1EA/640?wx_fmt=png&amp;from=appmsg" data-ratio="1" data-s="300,640" data-type="png" data-w="1080" type="block" data-imgfileid="100051895" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8uoFlibLCjZy6icYZa1icZoFcPwVgeZtUGGCwLsgLAW8GjWngmPDYF4OyicgYNaks8KaIZqUIniaaR1EA/640?wx_fmt=png&amp;from=appmsg"></section><p><span leaf=""><br></span></p><p><span leaf="">如果需要修改cell label遮挡的问题，可以使用ggtext包的element_markdown格式，它可以渲染markdown语法和部分html标记。因此可以选择在特定位置将字符替换为html的换行符即可。</span></p><p><span leaf="">有两个策略，直接修改marker_gene的名称，重新绘图，这个操作比较简单，不再赘述。第二方法是可以修改DotPlot返回的ggplot对象的data slot，如下所示：</span></p><pre><ol><li><code><span><span leaf="">p3 </span></span><span><span leaf="">&lt;-</span></span><span><span leaf=""> p2</span></span></code></li><li><code><span><span leaf="">p3$data$feature</span></span><span><span leaf="">.</span></span><span><span leaf="">groups  </span></span><span><span leaf="">&lt;-</span></span></code></li><li><code><span><span leaf="">  p3$data$feature</span></span><span><span leaf="">.</span></span><span><span leaf="">groups </span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  str_wrap</span></span><span><span leaf="">(</span></span><span><span leaf="">width </span></span><span><span leaf="">=</span></span><span></span><span><span leaf="">20</span></span><span><span leaf="">)</span></span><span></span><span><span leaf="">%&gt;%</span></span></code></li><li><code><span><span leaf="">  str_replace_all</span></span><span><span leaf="">(</span></span><span><span leaf="">"\\n"</span></span><span><span leaf="">,</span></span><span></span><span><span leaf="">"&lt;br/&gt;"</span></span><span><span leaf="">)</span></span></code></li><li><code><span><span leaf="">p3 </span></span><span><span leaf="">&lt;-</span></span><span><span leaf=""> p3 </span></span><span><span leaf="">+</span></span></code></li><li><code><span><span leaf="">  theme</span></span><span><span leaf="">(</span></span></code></li><li><code><span><span leaf="">    strip</span></span><span><span leaf="">.</span></span><span><span leaf="">text </span></span><span><span leaf="">=</span></span><span><span leaf=""> ggtext</span></span><span><span leaf="">::</span></span><span><span leaf="">element_textbox_simple</span></span><span><span leaf="">(</span></span><span><span leaf="">halign </span></span><span><span leaf="">=</span></span><span></span><span><span leaf="">0.5</span></span><span><span leaf="">),</span></span></code></li><li><code><span></span><span><span leaf="">)</span></span></code></li><li><code><span><span leaf="">p3</span></span></code></li></ol></pre><p><span leaf="">st</span><span leaf="">r_</span><em><span leaf="">wrap函数可以定义在多少字符的位置换行，而且str_</span></em><span leaf="">w</span><span leaf="">rap还可以只在空格位置换行，上述代码是选择第20位字符附近的空格处换行，由</span><span leaf="">于str_</span><em><span leaf="">wrap是补充了一个换行符，因此str_</span></em><span leaf="">re</span><span leaf="">place_all再将其转换为html换行符br即可，效果如下：</span></p><section nodeleaf=""><img data-imgfileid="100051896" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8uoFlibLCjZy6icYZa1icZoFcD6gBkoNUHQ2icQJHakVUI1jbTWASdibUtR13gx7icC1qxY1z3rEtiaaic0g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" type="block" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los8uoFlibLCjZy6icYZa1icZoFcD6gBkoNUHQ2icQJHakVUI1jbTWASdibUtR13gx7icC1qxY1z3rEtiaaic0g/640?wx_fmt=png&amp;from=appmsg"></section><p><span leaf=""><br></span></p><section><span leaf=""><br></span></section><section><span leaf=""><br></span></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/byMznhTgwsliOYJX5YoFVA",target="_blank" rel="noopener noreferrer">原文链接</a>
