---
title: "方法更新----单细胞CNV分析与CNA neighbourhood analysis"
date: 2025-01-10T09:17:04Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞空间交响乐"
]
categories: ["Acdemic"]
---
方法更新----单细胞CNV分析与CNA neighbourhood analysis by 单细胞空间交响乐
------
<div><h4><span leaf="">作者，Evil Genius</span></h4><h4><span leaf="">今天我们需要实现的目标</span></h4><section nodeleaf=""><img data-imgfileid="100010657" data-type="other" data-ratio="0.9796296296296296" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fauqJeZ1DJW4mbJjtyMpHIhniaWvUmvufWNXa6hR8hItD5ZcomXQqYxw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fauqJeZ1DJW4mbJjtyMpHIhniaWvUmvufWNXa6hR8hItD5ZcomXQqYxw/640?wx_fmt=other&amp;from=appmsg"></section><section><br></section><section nodeleaf=""><img data-imgfileid="100010665" data-type="other" data-ratio="1.2972222222222223" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9f2SSyFQYicymYg5oFx4NDJjPhia5vpDsqlGrhY2ReIuNK1mCB1HQeSh4w/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9f2SSyFQYicymYg5oFx4NDJjPhia5vpDsqlGrhY2ReIuNK1mCB1HQeSh4w/640?wx_fmt=other&amp;from=appmsg"></section><section><br></section><section nodeleaf=""><img data-imgfileid="100010656" data-type="other" data-ratio="1.0435185185185185" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fUC1PpFiaO0CIvth8kTTtvdyaHvvpZPLfzQIFIOPDW6LBcpqjkVrVjMA/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fUC1PpFiaO0CIvth8kTTtvdyaHvvpZPLfzQIFIOPDW6LBcpqjkVrVjMA/640?wx_fmt=other&amp;from=appmsg"></section><h4><span leaf="">看看方法部分</span></h4><section nodeleaf=""><img data-imgfileid="100010658" data-type="other" data-ratio="1.0790322580645162" data-w="620" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fTibkc0OK8MDp9kOn6qhGCNE5opPqmSa4RQkNp3kjbjsWMIXXK5E6vaw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fTibkc0OK8MDp9kOn6qhGCNE5opPqmSa4RQkNp3kjbjsWMIXXK5E6vaw/640?wx_fmt=other&amp;from=appmsg"></section><section><br></section><section nodeleaf=""><img data-imgfileid="100010655" data-type="other" data-ratio="0.5122349102773246" data-w="613" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fiaqqxCaSzIgKib87iaVArCCv9pAibVoBKIKMh9QCOrau6jnHflg6yeuyHg/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fiaqqxCaSzIgKib87iaVArCCv9pAibVoBKIKMh9QCOrau6jnHflg6yeuyHg/640?wx_fmt=other&amp;from=appmsg"></section><h4><span leaf="">其实就是CNV分数矩阵做均一化，PCA降维，然后采用miloR进行聚类分析，分析CNV事件的相互联系。</span></h4><h4><span leaf="">其实这种分析在python版本的inferCNVpy已经实现过了，链接在</span><span leaf="">Infer CNV on lung cancer dataset — infercnvpy</span></h4><section nodeleaf=""><img data-imgfileid="100010660" data-type="other" data-ratio="0.4535175879396985" data-w="796" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fqPeh9uhaXzFjezZMMqDM57UOm28nKFRichaicnvYAaec1yOXicA04oBSw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fqPeh9uhaXzFjezZMMqDM57UOm28nKFRichaicnvYAaec1yOXicA04oBSw/640?wx_fmt=other&amp;from=appmsg"></section><h4><span leaf="">我们来根据文献的内容实现一下，inferCNV大家自己做一下，我们从CNV矩阵开始。</span></h4><p><i aria-label="icon: copy"><svg viewbox="64 64 896 896" focusable="false" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></p><pre><code><span><span leaf="">libarary</span></span><span><span leaf="">(</span></span><span leaf="">Seurat</span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span leaf="">miloR</span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span leaf="">SingleCellExperiment</span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span leaf="">scater</span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span leaf="">scran</span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span leaf="">dplyr</span><span><span leaf="">)</span></span><br><span><span leaf="">library</span></span><span><span leaf="">(</span></span><span leaf="">patchwork</span><span><span leaf="">)</span></span><br><br><span leaf="">expression_matrix </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span leaf=""> read</span><span><span leaf="">.</span></span><span><span leaf="">csv</span></span><span><span leaf="">(</span></span><span><span leaf="">"cnv_matrix.csv"</span></span><span><span leaf="">,</span></span><span leaf=""> row</span><span><span leaf="">.</span></span><span leaf="">names </span><span><span leaf="">=</span></span><span><span leaf="">1</span></span><span><span leaf="">)</span></span><br><br><span leaf="">seurat_object </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span><span leaf="">CreateSeuratObject</span></span><span><span leaf="">(</span></span><span leaf="">counts </span><span><span leaf="">=</span></span><span leaf=""> expression_matrix</span><span><span leaf="">)</span></span><br><br><span leaf="">seurat_object </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span><span leaf="">NormalizeData</span></span><span><span leaf="">(</span></span><span leaf="">seurat_object</span><span><span leaf="">)</span></span><br><span leaf="">####这个地方看文献是均一化之后直接进行PCA分析</span><br><span leaf="">seurat_object </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span><span leaf="">RunPCA</span></span><span><span leaf="">(</span></span><span leaf="">seurat_object</span><span><span leaf="">,</span></span><span leaf=""> features </span><span><span leaf="">=</span></span><span><span leaf="">rownames</span></span><span><span leaf="">(</span></span><span leaf="">seurat_object</span><span><span leaf="">)</span></span><span><span leaf="">)</span></span><br><span leaf="">####获取PCA矩阵</span><br><span leaf="">pca_matrix </span><span><span leaf="">=</span></span><span leaf=""> seurat_object</span><span><span leaf="">@reductions</span></span><span leaf="">$pca</span><span><span leaf="">@cell</span></span><span><span leaf="">.</span></span><span leaf="">embeddings</span><br><span leaf="">pca_matrix</span><br><span aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><section nodeleaf=""><img data-imgfileid="100010662" data-type="other" data-ratio="0.5847255369928401" data-w="838" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9ffOc0lcxT2e7z2VR8ZiceWSkH7yUNkHmAfU2dYAuYzQOsQa1icKIeypPg/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9ffOc0lcxT2e7z2VR8ZiceWSkH7yUNkHmAfU2dYAuYzQOsQa1icKIeypPg/640?wx_fmt=other&amp;from=appmsg"></section><h4><span leaf="">这个时候就要进行miloR分析</span></h4><p><i aria-label="icon: copy"><svg viewbox="64 64 896 896" focusable="false" data-icon="copy" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2L263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></i></p><pre><code><span leaf="">sce </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span><span leaf="">SingleCellExperiment</span></span><span><span leaf="">(</span></span><span leaf="">assays</span><span><span leaf="">=</span></span><span leaf="">list</span><span><span leaf="">(</span></span><span leaf="">counts</span><span><span leaf="">=</span></span><span leaf="">seurat_object</span><span><span leaf="">@assays</span></span><span><span leaf="">$RNA</span></span><span><span leaf="">@counts</span></span><span><span leaf="">,</span></span><span leaf=""> logcounts</span><span><span leaf="">=</span></span><span leaf="">seurat_object</span><span><span leaf="">@assays</span></span><span><span leaf="">$RNA</span></span><span><span leaf="">@data</span></span><span><span leaf="">)</span></span><span><span leaf="">,</span></span><span leaf="">reducedDims</span><span><span leaf="">=</span></span><span><span leaf="">SimpleList</span></span><span><span leaf="">(</span></span><span><span leaf="">PCA</span></span><span><span leaf="">=</span></span><span leaf="">seurat_object</span><span><span leaf="">@reductions</span></span><span><span leaf="">$pca</span></span><span><span leaf="">@cell</span></span><span><span leaf="">.</span></span><span leaf="">embeddings</span><span><span leaf="">)</span></span><span><span leaf="">)</span></span><br><span leaf="">milo </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span><span leaf="">Milo</span></span><span><span leaf="">(</span></span><span leaf="">sce</span><span><span leaf="">)</span></span><br><span><span leaf="">###Construct KNN graph</span></span><br><span leaf="">milo </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span leaf=""> buildGraph</span><span><span leaf="">(</span></span><span leaf="">sce</span><span><span leaf="">,</span></span><span leaf=""> k </span><span><span leaf="">=</span></span><span><span leaf="">30</span></span><span><span leaf="">,</span></span><span leaf=""> d </span><span><span leaf="">=</span></span><span><span leaf="">30</span></span><span><span leaf="">,</span></span><span leaf=""> reduced</span><span><span leaf="">.</span></span><span leaf="">dim </span><span><span leaf="">=</span></span><span><span leaf="">"PCA"</span></span><span><span leaf="">)</span></span><br><span leaf="">milo </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span leaf=""> makeNhoods</span><span><span leaf="">(</span></span><span leaf="">milo</span><span><span leaf="">)</span></span><br><span><span leaf="">####Defining representative neighbourhoods on the KNN graph</span></span><br><span leaf="">milo </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span leaf=""> makeNhoods</span><span><span leaf="">(</span></span><span leaf="">milo</span><span><span leaf="">,</span></span><span leaf=""> prop </span><span><span leaf="">=</span></span><span><span leaf="">0.1</span></span><span><span leaf="">,</span></span><span leaf=""> k </span><span><span leaf="">=</span></span><span><span leaf="">30</span></span><span><span leaf="">,</span></span><span leaf=""> d</span><span><span leaf="">=</span></span><span><span leaf="">30</span></span><span><span leaf="">,</span></span><span leaf=""> refined </span><span><span leaf="">=</span></span><span><span leaf="">TRUE</span></span><span><span leaf="">,</span></span><span leaf=""> reduced_dims </span><span><span leaf="">=</span></span><span><span leaf="">"PCA"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">####Computing neighbourhood connectivity</span></span><br><span leaf="">milo </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span leaf=""> calcNhoodDistance</span><span><span leaf="">(</span></span><span leaf="">milo</span><span><span leaf="">,</span></span><span leaf=""> d</span><span><span leaf="">=</span></span><span><span leaf="">30</span></span><span><span leaf="">,</span></span><span leaf=""> reduced</span><span><span leaf="">.</span></span><span leaf="">dim </span><span><span leaf="">=</span></span><span><span leaf="">"PCA"</span></span><span><span leaf="">)</span></span><br><span><span leaf="">####testing</span></span><br><span><span leaf="">#####注释信息</span></span><br><span leaf="">design </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span leaf=""> data</span><span><span leaf="">.</span></span><span leaf="">frame</span><span><span leaf="">(</span></span><span leaf="">colData</span><span><span leaf="">(</span></span><span leaf="">embryo_milo</span><span><span leaf="">)</span></span><span><span leaf="">)</span></span><span><span leaf="">[</span></span><span><span leaf="">,</span></span><span leaf="">c</span><span><span leaf="">(</span></span><span><span leaf="">"sample"</span></span><span><span leaf="">,</span></span><span><span leaf="">"disease"</span></span><span><span leaf="">,</span></span><span><span leaf="">"celltype"</span></span><span><span leaf="">)</span></span><span><span leaf="">]</span></span><br><br><span leaf="">milo </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span leaf=""> buildNhoodGraph</span><span><span leaf="">(</span></span><span leaf="">milo</span><span><span leaf="">)</span></span><br><span leaf="">da_results </span><span><span leaf="">&lt;</span></span><span><span leaf="">-</span></span><span leaf=""> testNhoods</span><span><span leaf="">(</span></span><span leaf="">milo</span><span><span leaf="">,</span></span><span leaf=""> design </span><span><span leaf="">=</span></span><span><span leaf="">~</span></span><span leaf=""> sample </span><span><span leaf="">+</span></span><span leaf=""> disease</span><span><span leaf="">,</span></span><span leaf=""> design</span><span><span leaf="">.</span></span><span leaf="">df </span><span><span leaf="">=</span></span><span leaf=""> design</span><span><span leaf="">)</span></span><br><br><span leaf="">plotNhoodGroups</span><span><span leaf="">(</span></span><span leaf="">embryo_milo</span><span><span leaf="">,</span></span><span leaf=""> da_results</span><span><span leaf="">,</span></span><span leaf=""> layout</span><span><span leaf="">=</span></span><span><span leaf="">"umap"</span></span><span><span leaf="">)</span></span><br><span aria-hidden="true"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><section nodeleaf=""><img data-imgfileid="100010664" data-type="other" data-ratio="1" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fIEkS9ibcn0QkyoGWjqfZQXTPnlqYKXwx7lU3yL5iauDs2F4vnO2mM1Qw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fIEkS9ibcn0QkyoGWjqfZQXTPnlqYKXwx7lU3yL5iauDs2F4vnO2mM1Qw/640?wx_fmt=other&amp;from=appmsg"></section><section><br></section><section nodeleaf=""><img data-imgfileid="100010663" data-type="other" data-ratio="0.4896103896103896" data-w="770" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fAEVVYtxLLhJjOCRFAnslaYk0B8ZNkKLbG4dDZWcwYiblAnnibic0lDYSw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fAEVVYtxLLhJjOCRFAnslaYk0B8ZNkKLbG4dDZWcwYiblAnnibic0lDYSw/640?wx_fmt=other&amp;from=appmsg"></section><section><br></section><section nodeleaf=""><img data-imgfileid="100010661" data-type="other" data-ratio="0.46846846846846846" data-w="777" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fiakSib7YhaJap1gyiarBnwZKXbzicibPRnNa8Vj8sia9z6IQNVr3Hx9Q8vNA/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk9aa4zj4mhZP8MphuNFA9fiakSib7YhaJap1gyiarBnwZKXbzicibPRnNa8Vj8sia9z6IQNVr3Hx9Q8vNA/640?wx_fmt=other&amp;from=appmsg"></section><h4><span leaf="">生活很好，有你更好</span></h4><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/xieje9MOGyHIvp0t-EbQ1A",target="_blank" rel="noopener noreferrer">原文链接</a>
