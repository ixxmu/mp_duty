---
title: "生存分析新技能:小洁老师带你全代码实现生存曲线与风险表的完美融合"
date: 2025-01-24T06:36:15Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
生存分析新技能:小洁老师带你全代码实现生存曲线与风险表的完美融合 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><span></span><blockquote data-tool="mdnice编辑器"><span></span><p>前情提要：作为三年前的马拉松授课学员，参加了每个月一次的老学员在线互动答疑，收获颇多，分享给大家：</p></blockquote><span></span></section><ul><li><p>查找survminer是否自带保存生存图片的函数</p></li><li><p>查看帮助文档中是否有file这个参数</p></li><li><p>用帮助文档中的示例代码演示</p></li><li><p>示例代码中并没有保存的代码，那就搜一搜：</p></li><li><p>搜索的同时，尝试将图片单独保存</p></li><li><p>成功保存图片，困扰我很久的问题小洁老师5分钟就解决了啦！你说小洁老师厉害不厉害？</p></li></ul><p>为了让代码具有可重复性，保存图片也最好是用代码来实现，而不是用点鼠标的方式。最近有一个需求是将生存曲线和表格一起保存，尝试了经典的三段论、ggsave、图片数据类型转换、cowplot包的recordPlo函数都没能实现我的目的。恰好昨天是生信技能树的福利：每月1次的答疑时间。那就求助小洁老师来解决问题吧，小洁老师很快就找到了解决办法，实在是太厉害啦！下面是解答过程：</p><h3>查找survminer是否自带保存生存图片的函数</h3><pre><code><span>library</span>(survival)<br><span>library</span>(survminer)<br><span>#&gt; Loading required package: ggplot2</span><br><span>#&gt; Loading required package: ggpubr</span><br><span>#&gt; </span><br><span>#&gt; Attaching package: 'survminer'</span><br><span>#&gt; The following object is masked from 'package:survival':</span><br><span>#&gt; </span><br><span>#&gt;     myeloma</span><br>ls(<span>"package:survminer"</span>)<br><span>#&gt;  [1] "%++%"                "arrange_ggsurvplots" "BMT"                </span><br><span>#&gt;  [4] "BRCAOV.survInfo"     "ggadjustedcurves"    "ggcompetingrisks"   </span><br><span>#&gt;  [7] "ggcoxdiagnostics"    "ggcoxfunctional"     "ggcoxzph"           </span><br><span>#&gt; [10] "ggcumcensor"         "ggcumevents"         "ggflexsurvplot"     </span><br><span>#&gt; [13] "ggforest"            "ggrisktable"         "ggsurvevents"       </span><br><span>#&gt; [16] "ggsurvplot"          "ggsurvplot_add_all"  "ggsurvplot_combine" </span><br><span>#&gt; [19] "ggsurvplot_df"       "ggsurvplot_facet"    "ggsurvplot_group_by"</span><br><span>#&gt; [22] "ggsurvplot_list"     "ggsurvtable"         "myeloma"            </span><br><span>#&gt; [25] "pairwise_survdiff"   "surv_adjustedcurves" "surv_categorize"    </span><br><span>#&gt; [28] "surv_cutpoint"       "surv_fit"            "surv_group_by"      </span><br><span>#&gt; [31] "surv_median"         "surv_pvalue"         "surv_summary"       </span><br><span>#&gt; [34] "theme_cleantable"    "theme_survminer"</span></code></pre><h3>查看帮助文档中是否有file这个参数</h3><pre><code>?ggsurvplot</code></pre><h3>用帮助文档中的示例代码演示</h3><pre><code><span>require</span>(<span>"survival"</span>)<br>fit&lt;- survfit(Surv(time, status) ~ sex, data = lung)<br><br><span># Basic survival curves</span><br>ggsurvplot(fit, data = lung)</code></pre><p><img data-imgfileid="100000577" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pQTMYxUjYq3WZ7NNCWwRZK8x5jkzPplPy7oH0z8eYqSpUe1Dhcjw9mA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pQTMYxUjYq3WZ7NNCWwRZK8x5jkzPplPy7oH0z8eYqSpUe1Dhcjw9mA/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><br><span># Customized survival curves</span><br>ggsurvplot(fit, data = lung,<br> surv.median.line = <span>"hv"</span>, <span># Add medians survival</span><br><br> <span># Change legends: title &amp; labels</span><br> legend.title = <span>"Sex"</span>,<br> legend.labs = c(<span>"Male"</span>, <span>"Female"</span>),<br> <span># Add p-value and tervals</span><br> pval = <span>TRUE</span>,<br><br> conf.int = <span>TRUE</span>,<br> <span># Add risk table</span><br> risk.table = <span>TRUE</span>,<br> tables.height = <span>0.2</span>,<br> tables.theme = theme_cleantable(),<br><br> <span># Color palettes. Use custom color: c("#E7B800", "#2E9FDF"),</span><br> <span># or brewer color (e.g.: "Dark2"), or ggsci color (e.g.: "jco")</span><br> palette = c(<span>"#E7B800"</span>, <span>"#2E9FDF"</span>),<br> ggtheme = theme_bw() <span># Change ggplot2 theme</span><br>)</code></pre><p><img data-imgfileid="100000578" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pLYjDKKaZmWpmSwryCKfDY4qvlrYrfMsPU8WeyZ4Hsq8YgpjZKjib4Zg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pLYjDKKaZmWpmSwryCKfDY4qvlrYrfMsPU8WeyZ4Hsq8YgpjZKjib4Zg/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><br><span># Change font size, style and color</span><br><span>#++++++++++++++++++++++++++++++++++++</span><br><span>## Not run: </span><br><span># Change font size, style and color at the same time</span><br>ggsurvplot(fit, data = lung,  main = <span>"Survival curve"</span>,<br>   font.main = c(<span>16</span>, <span>"bold"</span>, <span>"darkblue"</span>),<br>   font.x = c(<span>14</span>, <span>"bold.italic"</span>, <span>"red"</span>),<br>   font.y = c(<span>14</span>, <span>"bold.italic"</span>, <span>"darkred"</span>),<br>   font.tickslab = c(<span>12</span>, <span>"plain"</span>, <span>"darkgreen"</span>))</code></pre><p><img data-imgfileid="100000579" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pzoibos2lfzYabOWWiahlsYiaVTAliaXETOvRQ27fqFtsSuULqXEBBsPRXQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pzoibos2lfzYabOWWiahlsYiaVTAliaXETOvRQ27fqFtsSuULqXEBBsPRXQ/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><br><span>## End(Not run)</span><br><br><br><br><span>#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span><br><span># Example 2: Facet ggsurvplot() output by</span><br><span># a combination of factors</span><br><span>#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span><br><br><span># Fit (complexe) survival curves</span><br><span>#++++++++++++++++++++++++++++++++++++</span><br><span>## Not run: </span><br><span>require</span>(<span>"survival"</span>)<br>fit3 &lt;- survfit( Surv(time, status) ~ sex + rx + adhere,<br>                data = colon )<br><br><span># Visualize</span><br><span>#++++++++++++++++++++++++++++++++++++</span><br>ggsurv &lt;- ggsurvplot(fit3, data = colon,<br>  fun = <span>"cumhaz"</span>, conf.int = <span>TRUE</span>,<br>  risk.table = <span>TRUE</span>, risk.table.col=<span>"strata"</span>,<br>  ggtheme = theme_bw())<br><br><span># Faceting survival curves</span><br>curv_facet &lt;- ggsurv$plot + facet_grid(rx ~ adhere)<br>curv_facet</code></pre><p><img data-imgfileid="100000580" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4p2IVf1aH2DCRV8AqEBRh2eNuV9Cu7xpOYYP09gQk2rSG4xbTTAvecuQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4p2IVf1aH2DCRV8AqEBRh2eNuV9Cu7xpOYYP09gQk2rSG4xbTTAvecuQ/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><br><span># Faceting risk tables:</span><br><span># Generate risk table for each facet plot item</span><br>ggsurv$table + facet_grid(rx ~ adhere, scales = <span>"free"</span>)+<br> theme(legend.position = <span>"none"</span>)</code></pre><p><img data-imgfileid="100000581" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4p5A8icsvYYpiavq5xsf2QXsDdXtClSlyB4kqzVZ5WqznYGbhJIM3o75uw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4p5A8icsvYYpiavq5xsf2QXsDdXtClSlyB4kqzVZ5WqznYGbhJIM3o75uw/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><br> <span># Generate risk table for each facet columns</span><br>tbl_facet &lt;- ggsurv$table + facet_grid(.~ adhere, scales = <span>"free"</span>)<br>tbl_facet + theme(legend.position = <span>"none"</span>)</code></pre><p><img data-imgfileid="100000582" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pbjCicichqy6TfnoFFdm0ub0bpIPERdv1ZWXahibVPHzgFkzeJDwt2KZmg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pbjCicichqy6TfnoFFdm0ub0bpIPERdv1ZWXahibVPHzgFkzeJDwt2KZmg/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><br><span># Arrange faceted survival curves and risk tables</span><br>g2 &lt;- ggplotGrob(curv_facet)<br>g3 &lt;- ggplotGrob(tbl_facet)<br>min_ncol &lt;- min(ncol(g2), ncol(g3))<br>g &lt;- gridExtra::gtable_rbind(g2[, <span>1</span>:min_ncol], g3[, <span>1</span>:min_ncol], size=<span>"last"</span>)<br>g$widths &lt;- grid::unit.pmax(g2$widths, g3$widths)<br>grid::grid.newpage()<br>grid::grid.draw(g)</code></pre><p><img data-imgfileid="100000586" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pyKqibby7LFuEt8VjnlbSciaavTFFZqQambplmIq3uaMUr1kb5iaYXib1dA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pyKqibby7LFuEt8VjnlbSciaavTFFZqQambplmIq3uaMUr1kb5iaYXib1dA/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><br><br><span>## End(Not run)</span><br><br><span>#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span><br><span># Example 3: CUSTOMIZED PVALUE</span><br><span>#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span><br><span># Customized p-value</span><br>ggsurvplot(fit, data = lung, pval = <span>TRUE</span>)</code></pre><p><img data-imgfileid="100000583" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pv7nvLjypHhDhg72grIDA1iabjSgvp1LvqeRgibfMzzpycibs7yVGAk1Yw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pv7nvLjypHhDhg72grIDA1iabjSgvp1LvqeRgibfMzzpycibs7yVGAk1Yw/640?wx_fmt=png&amp;from=appmsg"></p><pre><code>ggsurvplot(fit, data = lung, pval = <span>0.03</span>)</code></pre><p><img data-imgfileid="100000585" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pW6WxYbJ4u9aBwEYxuNz7NRTdjibkTqLf6Y9P3bnibE7ZUMQdGicObIA3w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pW6WxYbJ4u9aBwEYxuNz7NRTdjibkTqLf6Y9P3bnibE7ZUMQdGicObIA3w/640?wx_fmt=png&amp;from=appmsg"></p><pre><code>ggsurvplot(fit, data = lung, pval = <span>"The hot p-value is: 0.031"</span>)</code></pre><p><img data-imgfileid="100000584" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pXXj6FKapEORWoEry3E2mHJ9XT9Nko7LmmmJHib7p0OoYeyiauGnboD7g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pXXj6FKapEORWoEry3E2mHJ9XT9Nko7LmmmJHib7p0OoYeyiauGnboD7g/640?wx_fmt=png&amp;from=appmsg"></p><h3>示例代码中并没有保存的代码，那就搜一搜：</h3><p><img data-imgfileid="100000588" data-ratio="1.1444444444444444" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pfwwgibllIQxibZJrmsy6gV0o7DyVXGorY8ViaOxiayv6yLWu62TI8zwBRg/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4pfwwgibllIQxibZJrmsy6gV0o7DyVXGorY8ViaOxiayv6yLWu62TI8zwBRg/640?wx_fmt=jpeg&amp;from=appmsg"></p><h3>搜索的同时，尝试将图片单独保存</h3><pre><code><span>require</span>(<span>"survival"</span>)<br>fit&lt;- survfit(Surv(time, status) ~ sex, data = lung)<br><br><span># Customized survival curves</span><br>a = ggsurvplot(fit, data = lung,<br> surv.median.line = <span>"hv"</span>, <span># Add medians survival</span><br><br> <span># Change legends: title &amp; labels</span><br> legend.title = <span>"Sex"</span>,<br> legend.labs = c(<span>"Male"</span>, <span>"Female"</span>),<br> <span># Add p-value and tervals</span><br> pval = <span>TRUE</span>,<br><br> conf.int = <span>TRUE</span>,<br> <span># Add risk table</span><br> risk.table = <span>TRUE</span>,<br> tables.height = <span>0.2</span>,<br> tables.theme = theme_cleantable(),<br><br> <span># Color palettes. Use custom color: c("#E7B800", "#2E9FDF"),</span><br> <span># or brewer color (e.g.: "Dark2"), or ggsci color (e.g.: "jco")</span><br> palette = c(<span>"#E7B800"</span>, <span>"#2E9FDF"</span>),<br> ggtheme = theme_bw() <span># Change ggplot2 theme</span><br>)<br><br>class(a$plot)<br><span>#&gt; [1] "gg"     "ggplot"</span><br>class(a$table)<br><span>#&gt; [1] "gg"     "ggplot"</span></code></pre><pre><code><span>#a$table和a$plot都是ggplot格式的图，那么是否将这两个图拼起啦？试一试：</span></code></pre><pre><code><span>library</span>(patchwork)<br>a$plot / a$table</code></pre><p><img data-imgfileid="100000587" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4p8qUh245oHpWXMCibo5D6ecJPHvaNVG1ibK1cJudx5AyrSV66Cc95OG1A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" width="672" src="https://mmbiz.qpic.cn/mmbiz_png/aiaeCPicRlUjK48UG48ibaQdv4Iw7OibDg4p8qUh245oHpWXMCibo5D6ecJPHvaNVG1ibK1cJudx5AyrSV66Cc95OG1A/640?wx_fmt=png&amp;from=appmsg"></p><pre><code>ggsave(<span>"sur.pdf"</span>)<br><span>#&gt; Saving 7 x 5 in image</span></code></pre><h3>成功保存图片，困扰我很久的问题小洁老师5分钟就解决了啦！你说小洁老师厉害不厉害？</h3><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/ikj6zH2X8QVklcSwYyp9eQ",target="_blank" rel="noopener noreferrer">原文链接</a>
