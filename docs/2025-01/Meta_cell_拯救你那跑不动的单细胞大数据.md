---
title: "Meta cell：拯救你那跑不动的单细胞大数据"
date: 2025-01-25T05:47:51Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
Meta cell：拯救你那跑不动的单细胞大数据 by 生信星球
------
<div><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section><img data-imgfileid="100013059" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100013061" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第1029天</strong></span></span><img data-imgfileid="100013060" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span></span></section><section><blockquote><section><span>公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span><span>我的课程都是循环开课，</span><span>点进去咨询微信↓</span><br></section><section><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247496614&amp;idx=1&amp;sn=4177354e87d394a022c3d410f482546a&amp;scene=21#wechat_redirect" textvalue="生信分‍析直播课程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a>(每月初开一期，春节休一个月，下一期3月初)</section><section><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494919&amp;idx=2&amp;sn=967d8dcf0f9a22047ae0bd442b9d4ee6&amp;scene=21#wechat_redirect" textvalue="生信新手保护学‍习小组" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信新手保护学习小组</a>（每月两期）</section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247495036&amp;idx=1&amp;sn=fe8bab2c3d21e7b0a919ad4f1641ca9c&amp;chksm=fdfba53eca8c2c286522b2accc0d4cb9dda7cd9a5b36695e66d393abb5bff396d6bcaa4c9cb8&amp;scene=21#wechat_redirect" textvalue="单细胞陪伴学习小组内测完成，长期招生中" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞陪伴学习小组</a>（每月两期）</section></blockquote></section></section><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><h3 data-tool="mdnice编辑器"><span></span><span>1.Meta cell</span><span></span></h3><p data-tool="mdnice编辑器">现在的单细胞数据动辄十几万甚至几十万的细胞数量，对于没有服务器，用自己电脑进行分析的同学来说实在是很不友好。Meta cell算法是将相似的单细胞合并，减少细胞数量。比如你的数据是8万个细胞，压缩完后可以变成几千个细胞，计算量大大减少，且没有丢失重要信息。</p><p data-tool="mdnice编辑器">构建Meta cell的过程通常包括以下几个关键步骤：</p><ol data-tool="mdnice编辑器"><li><section>构建单细胞的k近邻网络（kNN），用于识别相似细胞。</section></li><li><section>根据用户定义的压缩比例（如<code>gamma</code>参数）将单细胞聚合为Meta cell。</section></li><li><section>对每个Meta cell计算其基因表达值，通常采用单细胞表达值的加权平均。</section></li></ol><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>Meta cell的后续使用</span><span><span> </span></span></h4><p data-tool="mdnice编辑器">seurat该吃多少内存还是得吃，咱说的是后续高级分析可以省点劲。</p><p data-tool="mdnice编辑器">metacell可以像单细胞一样完成降维、聚类、分群，可以用于后续分析（如差异表达分析、拟时序、细胞通讯、转录因子分析等），大大提高计算效率。</p><h3 data-tool="mdnice编辑器"><span></span><span>2.根据单细胞表达矩阵生成meta细胞表达矩阵</span><span></span></h3><p data-tool="mdnice编辑器">本文的示例数据是seu.obj.Rdata，有两个样本，已经用harmony整合过，并完成细胞类型注释。</p><p data-tool="mdnice编辑器">获取示例数据请在“生信星球”聊天框回复metacell1029。</p><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>自定义函数：<code>supercell_2_Seurat2</code></span><span><span> </span></span></h4><p data-tool="mdnice编辑器">Supercell包里自带了转换为Seurat对象的函数，但很久没更新了，碰上Seurat V5就会报错。所以我改写了<code>supercell_2_Seurat</code>函数，命名为<code>supercell_2_Seurat2</code>。</p><p data-tool="mdnice编辑器">将这段代码保存为脚本sc2seurat.R，后续使用只需source该脚本，就可以使用函数了。</p><pre data-tool="mdnice编辑器"><code>supercell_2_Seurat2=<span>function</span> (SC.GE, SC, fields = c(),is.log.normalized = <span>TRUE</span>)<br>{<br>  N.c &lt;- ncol(SC.GE)<br>  <span>if</span> (is.null(SC$supercell_size)) {<br>    <span>warning</span>(paste0(<span>"supercell_size field of SC is missing, size of all super-cells set to 1"</span>))<br>    supercell_size &lt;- rep(<span>1</span>, N.c)<br>  }<br>  <span>else</span> {<br>    supercell_size &lt;- SC$supercell_size<br>  }<br>  <span>if</span> (length(supercell_size) != N.c) {<br>    <span>stop</span>(paste0(<span>"length of SC$supercell_size has to be the same as number of super-cells "</span>,<br>                N.c))<br>  }<br>  <span>if</span> (is.null(colnames(SC.GE))) {<br>    colnames(SC.GE) &lt;- as.character(<span>1</span>:N.c)<br>  }<br>  counts &lt;- SC.GE<br>  <span>if</span> (is.numeric(fields)) {<br>    fields &lt;- names(SC)[fields]<br>  }<br>  fields &lt;- intersect(fields, names(SC))<br>  <span>if</span> (length(fields) &gt; <span>0</span>) {<br>    SC.fields &lt;- SC[fields]<br>  }<br>  <span>else</span> {<br>    SC.fields &lt;- <span>NULL</span><br>  }<br>  SC.field.length &lt;- lapply(SC.fields, length)<br>  SC.fields &lt;- SC.fields[which(SC.field.length == N.c)]<br>  meta &lt;- data.frame(size = supercell_size, row.names = colnames(SC.GE),<br>                     stringsAsFactors = <span>FALSE</span>)<br>  <span>if</span> (length(SC.fields) &gt; <span>0</span>) {<br>    meta &lt;- cbind(meta, SC.fields)<br>  }<br>  <br>  m.seurat &lt;- SeuratObject::CreateSeuratObject(counts = SC.GE, meta.data = meta)<br>  <span>if</span> (is.log.normalized) {<br>    print(<span>"Doing: data to normalized data"</span>)<br>    m.seurat@assays$RNA$data &lt;- m.seurat@assays$RNA$counts<br>  }<br>  <span>return</span>(m.seurat)<br>}<br></code></pre><p data-tool="mdnice编辑器">为了避免将不同样本的细胞整合在一起，建议是每个样本分开做metacell。</p><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br><span>library</span>(SuperCell)<br><span>library</span>(Seurat)<br><span>source</span>(<span>"sc2seurat.R"</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span><span> </span></span><span><span> </span>拿一个样本做metacell的代码示例</span><span><span> </span></span></h4><pre data-tool="mdnice编辑器"><code>load(<span>"data/seu.obj.Rdata"</span>)<br>seu.list &lt;- SplitObject(seu.obj, split.by = <span>"orig.ident"</span>)<br>length(seu.list)<br></code></pre><pre data-tool="mdnice编辑器"><code>## [1] 2<br></code></pre><pre data-tool="mdnice编辑器"><code>sce = seu.list[[<span>1</span>]]<br>sce &lt;- FindVariableFeatures(sce)<br>exp_mat &lt;- GetAssayData(sce, layer = <span>"data"</span>, assay = <span>'RNA'</span>)<br>dim(exp_mat)<br></code></pre><pre data-tool="mdnice编辑器"><code>## [1] 26571  2769<br></code></pre><p data-tool="mdnice编辑器">可见，目前该样本是有2769个细胞。</p><p data-tool="mdnice编辑器">通过SCimplify()函数，基于kNN网络（k=5）和高变基因，将单细胞数据简化为meta cell。gamma=20表示生成的meta cell数量是原始细胞数量的1/20。</p><p data-tool="mdnice编辑器">设置了cell.annotation参数后，就不会将不同类型的单细胞整合在一个meta cell里了。</p><pre data-tool="mdnice编辑器"><code>SC &lt;- SCimplify(exp_mat,  <br>                k.knn = <span>5</span>, <br>                gamma = <span>20</span>, <br>                genes.use = VariableFeatures(sce),<br>                cell.annotation = sce$celltype)<br></code></pre><p data-tool="mdnice编辑器">SC 是一个列表，其中的SC$membership记录了每个单细胞所属的Meta cell编号。</p><p data-tool="mdnice编辑器">接下来的几句代码：</p><p data-tool="mdnice编辑器"><code>supercell_GE</code>：计算meta cell的基因表达矩阵</p><p data-tool="mdnice编辑器"><code>supercell_assign</code>：根据单细胞注释数据，得出每个meta cell的细胞类型。</p><p data-tool="mdnice编辑器"><code>colnames(SC.GE)</code>为meta cell命名：将meta cell的列名设置为由细胞类型和编号组成的字符串，以便区分不同meta cell。</p><p data-tool="mdnice编辑器"><code>supercell_2_Seurat2</code>：将meta cell数据转换为Seurat对象：将meta cell的基因表达矩阵和相关信息整合为一个Seurat对象，方便后续使用Seurat进行分析。</p><pre data-tool="mdnice编辑器"><code>SC.GE &lt;- supercell_GE(exp_mat, SC$membership)<br>SC$celltype &lt;- supercell_assign(clusters = sce$celltype,<br>                                supercell_membership = SC$membership <span># single-cell assignment to metacells)</span><br>cn = data.frame(celltype = SC$celltype) %&gt;%<br>  group_by(celltype)%&gt;%<br>  mutate(n = paste0(celltype,<span>1</span>:n())) %&gt;%<br>  pull(n)<br>colnames(SC.GE) = cn<br>Super_sce &lt;- supercell_2_Seurat2(SC.GE = SC.GE, SC = SC,<br>                                 fields = <span>"celltype"</span>)<br>print(dim(Super_sce))<br></code></pre><pre data-tool="mdnice编辑器"><code>## [1] 26571   172<br></code></pre><p data-tool="mdnice编辑器">最终生成的meta cell数量是172,比2769/20多，是因为SCimplify()函数设置了cell.annotation参数。</p><h3 data-tool="mdnice编辑器"><span></span><span>3.拿一个meta cell来验证</span><span></span></h3><p data-tool="mdnice编辑器">例如最后一个meta cell，它由5个单细胞组成。</p><pre data-tool="mdnice编辑器"><code>cells = names(which(SC$membership==<span>172</span>))<br>cells<br></code></pre><pre data-tool="mdnice编辑器"><code>## [1] "CAGCATACACGCCAGT_9" "GCTGCTTGTCCGACGT_9"<br>## [3] "GCTGGGTCAAAGAATC_9" "TCGGTAATCCGGGTGT_9"<br>## [5] "TTAACTCTCGAGAGCA_9"<br></code></pre><pre data-tool="mdnice编辑器"><code>d1 = as.data.frame(Super_sce@assays$RNA$data[,<span>172</span>])<br>d2 = as.data.frame(sce@assays$RNA$data[,cells])<br></code></pre><pre data-tool="mdnice编辑器"><code>d2$mean = rowMeans(d2)<br>df = cbind(d2,d1)<br>df = df[df$mean!=<span>0</span>,]<br>head(df)<br></code></pre><pre data-tool="mdnice编辑器"><code>## CAGCATACACGCCAGT_9 GCTGCTTGTCCGACGT_9<br>## NOC2L           0.5911845          0.0000000<br>## HES4            0.3386579          0.2858357<br>## ISG15           0.9602131          0.5078699<br>## AGRN            0.0000000          0.2858357<br>## SDF4            0.3386579          0.5078699<br>## UBE2J2          0.0000000          0.5078699<br>## GCTGGGTCAAAGAATC_9 TCGGTAATCCGGGTGT_9<br>## NOC2L            0.000000          0.0000000<br>## HES4             0.000000          0.0000000<br>## ISG15            0.000000          0.0000000<br>## AGRN             0.000000          0.0000000<br>## SDF4             1.144938          1.1044461<br>## UBE2J2           1.144938          0.6975258<br>## TTAACTCTCGAGAGCA_9       mean<br>## NOC2L                   0 0.11823691<br>## HES4                    0 0.12489873<br>## ISG15                   0 0.29361660<br>## AGRN                    0 0.05716715<br>## SDF4                    0 0.61918229<br>## UBE2J2                  0 0.47006663<br>## Super_sce@assays$RNA$data[, 172]<br>## NOC2L                        0.11823691<br>## HES4                         0.12489873<br>## ISG15                        0.29361660<br>## AGRN                         0.05716715<br>## SDF4                         0.61918229<br>## UBE2J2                       0.47006663<br></code></pre><p data-tool="mdnice编辑器">可见最后两列值是相同的，说明确实是把一个meta cell中的所有单细胞的基因表达量求了个平均值。</p><h3 data-tool="mdnice编辑器"><span></span><span>4.lapply实现多个样本批量生成Metacell</span><span></span></h3><pre data-tool="mdnice编辑器"><code>rm(list = ls())<br><span>library</span>(SuperCell)<br><span>library</span>(Seurat)<br><span>source</span>(<span>"sc2seurat.R"</span>)<br>load(<span>"data/seu.obj.Rdata"</span>)<br>seu.list &lt;- SplitObject(seu.obj, split.by = <span>"orig.ident"</span>)<br>length(seu.list)<br>seu.all = lapply(seu.list, <span>function</span>(sce){<br>  <span>#sce = seu.list[[1]]</span><br>  sce &lt;- FindVariableFeatures(sce)<br>  exp_mat &lt;- GetAssayData(sce, layer = <span>"data"</span>, assay = <span>'RNA'</span>)<br>  dim(exp_mat)<br>  SC &lt;- SCimplify(exp_mat,  <br>                  k.knn = <span>5</span>, <br>                  gamma = <span>20</span>, <br>                  genes.use = VariableFeatures(sce),<br>                  cell.annotation = sce$celltype)<br>  SC.GE &lt;- supercell_GE(exp_mat, SC$membership)<br>  SC$celltype &lt;- supercell_assign(clusters = sce$celltype, <br>                                  supercell_membership = SC$membership)<br>  cn = data.frame(celltype = SC$celltype) %&gt;%<br>    group_by(celltype)%&gt;%<br>    mutate(n = paste0(celltype,<span>1</span>:n())) %&gt;%<br>    pull(n)<br>  colnames(SC.GE) = cn<br>  Super_sce &lt;- supercell_2_Seurat2(SC.GE = SC.GE, SC = SC,<br>                                   fields = <span>"celltype"</span>)<br>  print(dim(Super_sce))<br>})<br><br>seu.all2 = merge(seu.all[[<span>1</span>]],seu.all[-<span>1</span>],<br>                 add.cell.ids = unique(names(seu.list)))<br><br>seu.all2 = JoinLayers(seu.all2)<br>dim(seu.all2)<br><span>##[1] 26571   314</span><br>seu.all2@assays$RNA$data[<span>1</span>:<span>3</span>,<span>1</span>:<span>3</span>]<br></code></pre><pre data-tool="mdnice编辑器"><code><span>## 3 x 3 sparse Matrix of class "dgCMatrix"</span><br><span>##            GSM5573467_T1 GSM5573467_T2 GSM5573467_T3</span><br><span>## AL627309.1    . 0.003964396    .</span><br><span>## AL669831.5    . .              .</span><br><span>## FAM87B        . .              .</span><br></code></pre></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/hbLgMBxbt9TUC6sDMoarOA",target="_blank" rel="noopener noreferrer">原文链接</a>
