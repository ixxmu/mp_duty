---
title: "画出像烟花一样的单细胞umap图，原因竟然是？"
date: 2025-01-30T10:26:32Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
画出像烟花一样的单细胞umap图，原因竟然是？ by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>我们生信马拉松培训班的最后一周是单细胞学习，在上完这周的课后，有个学员做了一个GEO数据集的单细胞分析，但是<span>他画出来的umap图像是为了庆祝新年，像烟花一样绚烂</span>，如下：</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100053972" data-ratio="0.8717310087173101" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqYJAK04BejTAGI3Wb2292G2C6nmobuFia0S0DSWf8N1LfqWUhxibgj5mw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="803" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqYJAK04BejTAGI3Wb2292G2C6nmobuFia0S0DSWf8N1LfqWUhxibgj5mw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器">学员把他用的数据和代码打包发了出来，下面就来看看是怎么回事！<span>激动地搓搓手，这么有意思的umap图可不多见</span>：</h4><figure data-tool="mdnice编辑器"><img data-imgfileid="100053970" data-ratio="0.9123630672926447" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqHE5eY44VcDBCRmZtRibqW35ZhKuLE6ZQXNxtGtXLyAwM45CcPLgogUg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="639" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqHE5eY44VcDBCRmZtRibqW35ZhKuLE6ZQXNxtGtXLyAwM45CcPLgogUg/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>数据介绍：GSE125527</span></h2><p data-tool="mdnice编辑器">GSE125527数据：<span>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE125527</span>。</p><p data-tool="mdnice编辑器">样本为 健康状态和溃疡性结肠炎（UC）中胃肠道黏膜和外周免疫系统的组织，文献中的结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100053974" data-ratio="0.8933717579250721" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqODWx5ciaYBYib9gSYWXez5U0k0EUNysvb4Z0kmMOtUuxgqibR0Z97iaXnw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1041" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqODWx5ciaYBYib9gSYWXez5U0k0EUNysvb4Z0kmMOtUuxgqibR0Z97iaXnw/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>简单分析一下</span></h2><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1、数据预处理</span><span></span></h3><p data-tool="mdnice编辑器">学院给出的数据如下：共15个样本</p><pre data-tool="mdnice编辑器"><code>GSM3576396_HC-11.tsv.gz<br>GSM3576397_HC-12.tsv.gz<br>GSM3576398_HC-13.tsv.gz<br>GSM3576399_UC-12.tsv.gz<br>GSM3576400_UC-13.tsv.gz<br>GSM3576401_UC-14.tsv.gz<br>GSM3576402_UC-15.tsv.gz<br>GSM3576403_UC-16.tsv.gz<br>GSM3576404_UC-17.tsv.gz<br>GSM3576405_UC-18.tsv.gz<br>GSM3576406_HC-14.tsv.gz<br>GSM3576407_HC-15.tsv.gz<br>GSM3576408_HC-16.tsv.gz<br>GSM3576409_HC-17.tsv.gz<br>GSM3576410_HC-18.tsv.gz<br></code></pre><p data-tool="mdnice编辑器">批量读取并创建Seuart对象：</p><pre data-tool="mdnice编辑器"><code><span>###</span><br><span>### Create: Jianming Zeng</span><br><span>### Date:  2023-12-31  </span><br><span>### Email: jmzeng1314@163.com</span><br><span>### Blog: http://www.bio-info-trainee.com/</span><br><span>### Forum:  http://www.biotrainee.com/thread-1376-1-1.html</span><br><span>### CAFS/SUSTC/Eli Lilly/University of Macau</span><br><span>### Update Log: 2023-12-31   First version </span><br><span>### Update Log: 2024-12-09   by juan zhang (492482942@qq.com)</span><br><span>### </span><br><br>rm(list=ls())<br>options(stringsAsFactors = F)<br>library(ggsci)<br>library(dplyr) <br>library(future)<br>library(Seurat)<br>library(clustree)<br>library(cowplot)<br>library(data.table)<br>library(ggplot2)<br>library(patchwork)<br>library(stringr)<br>library(qs)<br>library(Matrix)<br>getwd()<br><br><span>###### step1: 导入数据 ######   </span><br>samples &lt;- list.files(<span>"GSE125527_RAW/"</span>)<br>samples <br><br>sceList &lt;- lapply(samples, <span>function</span>(pro){ <br>  <span>#pro &lt;- samples[1]</span><br>  <span>print</span>(pro)<br>  ct &lt;- fread(file.path(<span>"GSE125527_RAW/"</span> ,pro),data.table = F)<br>  ct[1:4,1:4]<br>  rownames(ct) &lt;- ct[,1]<br>  ct&lt;- ct[,-1]<br>  ct &lt;- t(ct)<br>  ct[1:4,1:4]<br>  sce &lt;- CreateSeuratObject(counts=ct , project = gsub(<span>".tsv.gz"</span>,<span>""</span>,pro))<br>  <span>return</span>(sce)<br>}) <br><br>sce.all &lt;- merge(x=sceList[[1]], y=sceList[ -1 ])<br>sce.all &lt;- JoinLayers(sce.all)<br>sce.all<br><br>names(sce.all@assays<span>$RNA</span>@layers)<br>dim(sce.all[[<span>"RNA"</span>]]<span>$counts</span> )<br>sce.all[[<span>"RNA"</span>]]<span>$counts</span>[1:5,1:5]<br><br>as.data.frame(sce.all@assays<span>$RNA</span><span>$counts</span>[1:10, 1:5])<br>head(sce.all@meta.data, 10)<br>table(sce.all<span>$orig</span>.ident) <br><br>temp &lt;- str_split(sce.all<span>$orig</span>.ident, <span>"_"</span>, n=2, simplify = T)<br>head(temp)<br><br><span># add group and sample</span><br>sce.all<span>$sample1</span> &lt;- temp[,1]<br>sce.all<span>$sample2</span> &lt;- temp[,2]<br>sce.all<span>$group</span> &lt;- str_split(temp[,2], pattern =<span>"-"</span> ,n = 2,simplify = T)[,1]<br><br>head(sce.all@meta.data)<br>table(sce.all<span>$sample1</span>)<br>table(sce.all<span>$sample2</span>)<br>table(sce.all<span>$group</span>,sce.all<span>$sample1</span>)<br>table(sce.all<span>$orig</span>.ident)<br><br>sce.all<span>$orig</span>.ident &lt;- sce.all<span>$sample2</span><br><br><br>library(qs)<br>qsave(sce.all, file=<span>"GSE125527/sce.all.qs"</span>)<br><br>sce.all<br></code></pre><p data-tool="mdnice编辑器">共得到：<span>32154个细胞，10105个基因</span>。</p><pre data-tool="mdnice编辑器"><code>&gt; sce.all<br>An object of class Seurat <br><span>10105</span> features across <span>32154</span> samples within <span>1</span> assay <br>Active assay: RNA (<span>10105</span> features, <span>0</span> variable features)<br> <span>1</span> layer present: counts<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>2、简单质控</span><span></span></h3><pre data-tool="mdnice编辑器"><code><span>###### step2: QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br><br><span># 1.计算线粒体基因比例</span><br>mito_genes &lt;- grep(<span>"^MT-"</span>, rownames(sce.all),ignore.case = T, value = T) <br><span># 可能是13个线粒体基因</span><br><span>print</span>(mito_genes)<br>sce.all &lt;- PercentageFeatureSet(sce.all, features = mito_genes, col.name = <span>"percent_mito"</span>)<br>fivenum(sce.all@meta.data<span>$percent_mito</span>)<br><br><span># 2.计算核糖体基因比例</span><br>ribo_genes &lt;- grep(<span>"^Rp[sl]"</span>, rownames(sce.all),ignore.case = T, value = T)<br>sce.all &lt;- PercentageFeatureSet(sce.all,  features = ribo_genes, col.name = <span>"percent_ribo"</span>)<br>fivenum(sce.all@meta.data<span>$percent_ribo</span>)<br><br><span># 3.计算红血细胞基因比例</span><br>Hb_genes &lt;- grep(<span>"^Hb[^(p)]"</span>, rownames(sce.all),ignore.case = T,value = T)<br><span>print</span>(Hb_genes)<br>sce.all &lt;- PercentageFeatureSet(sce.all, features=Hb_genes, col.name=<span>"percent_hb"</span>)<br>fivenum(sce.all@meta.data<span>$percent_hb</span>)<br><br><span># 可视化细胞的上述比例情况</span><br><span># pic1</span><br>p1 &lt;- VlnPlot(sce.all, group.by = <span>"orig.ident"</span>, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>), <br>              pt.size = 0.02, ncol = 2) + NoLegend()<br>w &lt;- length(unique(sce.all<span>$orig</span>.ident))/3+5;w<br>ggsave(filename=<span>"1-QC/Vlnplot1.pdf"</span>,plot=p1,width = w,height = 5)<br><br><span># pic2</span><br>p2 &lt;- VlnPlot(sce.all, group.by = <span>"orig.ident"</span>, features = c(<span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>), <br>              pt.size = 0.0, ncol = 3) +  NoLegend()<br>w &lt;- length(unique(sce.all<span>$orig</span>.ident))/2+5;w<br>ggsave(filename=<span>"1-QC/Vlnplot2.pdf"</span>,plot=p2,width = w,height = 5)<br><br><span>## 根据上述指标，过滤低质量细胞/基因</span><br><span># 过滤指标1:最少表达基因数的细胞&amp;最少表达细胞数的基因</span><br><span># 一般来说，在CreateSeuratObject的时候已经是进行了这个过滤操作</span><br><span># 如果后期看到了自己的单细胞降维聚类分群结果很诡异，就可以回过头来看质量控制环节</span><br><span># 先走默认流程即可</span><br>dim(sce.all)<br><br><span># 过滤细胞：细胞中基因表达数少于多少基因 以及 大于多少基因</span><br>summary(sce.all<span>$nFeature_RNA</span>)<br>sce.all.filt &lt;- subset(sce.all, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 2500)<br>dim(sce.all.filt)<br><br><span># 过滤细胞：细胞中基因表达count数少于多少 以及 大于多少</span><br>sce.all.filt &lt;- subset(sce.all.filt, subset = nCount_RNA &gt; 3 )<br>dim(sce.all.filt)<br><br><span># 过滤细胞指标2：线粒体/核糖体基因比例/红细胞(根据上面的violin图)</span><br>sce.all.filt &lt;- subset(sce.all.filt, subset = percent_mito &lt; 5)<br>dim(sce.all.filt)<br><span># sce.all.filt &lt;- subset(sce.all.filt, subset = percent_ribo &gt; 3)</span><br><span># dim(sce.all.filt)</span><br>sce.all.filt &lt;- subset(sce.all.filt, subset = percent_hb &lt; 1)<br>dim(sce.all.filt)<br><br><span># 过滤后每个样本中的细胞数</span><br>stat_raw &lt;- as.data.frame(table(sce.all<span>$orig</span>.ident))<br>colnames(stat_raw) &lt;- c(<span>"sampleid"</span>,<span>"cellnum_raw"</span>)<br>stat_filter &lt;- as.data.frame(table(sce.all.filt<span>$orig</span>.ident))<br>colnames(stat_filter) &lt;- c(<span>"sampleid"</span>,<span>"cellnum_filter"</span>)<br><span>stat</span> &lt;- merge(stat_raw, stat_filter, by=<span>"sampleid"</span>)<br><span>stat</span><span>$filtered</span> &lt;- <span>stat</span><span>$cellnum_raw</span> - <span>stat</span><span>$cellnum_filter</span><br>head(<span>stat</span>)<br>write.table(<span>stat</span>, <span>"1-QC/stat.xls"</span>,row.names = F,sep = <span>"\t"</span>,quote = F)<br><br><br><span># 可视化过滤后的情况</span><br>p1_filtered &lt;- VlnPlot(sce.all.filt, group.by = <span>"orig.ident"</span>, features = c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>), <br>                       pt.size = 0, ncol = 2) + NoLegend()<br>w &lt;- length(unique(sce.all.filt<span>$orig</span>.ident))/3+5;w <br>ggsave(filename=<span>"1-QC/Vlnplot1_filtered.pdf"</span>,plot=p1_filtered,width = w,height = 5)<br><br>p2_filtered &lt;- VlnPlot(sce.all.filt, group.by = <span>"orig.ident"</span>, features = c(<span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>), pt.size = 0, ncol = 3) + NoLegend()<br>w &lt;- length(unique(sce.all.filt<span>$orig</span>.ident))/2+5;w <br>ggsave(filename = <span>"1-QC/Vlnplot2_filtered.pdf"</span>,plot=p2_filtered,width = w,height = 5) <br></code></pre><p data-tool="mdnice编辑器">然后走标准的降维聚类流程，并进行harmony，得到的umap图如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100053973" data-ratio="0.9138297872340425" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqmoK0y9fhGjfDTvJIhKF6p9mHicBLkPxfZ1wmLj7qyowK3mhkBFuCx5A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="940" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqmoK0y9fhGjfDTvJIhKF6p9mHicBLkPxfZ1wmLj7qyowK3mhkBFuCx5A/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span>得到的结果非常标准，跟文献中的也是一致。</span></h4><h4 data-tool="mdnice编辑器">到这里，<span>心里开始非常好奇了，一开始我想了很多情况，是不是特殊的组织什么的</span>，因为以前看到过类似精子或者具有干性的样本得到的umap图也有一些像线条一样扭来扭曲的图。</h4><h4 data-tool="mdnice编辑器">如2022年2月发表在Hum Mol Genet杂志上的文章《<span>Single-cell ATAC-Seq reveals cell type-specific transcriptional regulation and unique chromatin accessibility in human spermatogenesis</span>》中的生殖细胞和6种睾丸体细胞分析结果umap图：</h4><figure data-tool="mdnice编辑器"><img data-imgfileid="100053971" data-ratio="0.5662949194547707" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqBaiaon5jdLoJPJzwsfjkwy8Pmt5OWfPyC4JB7eIic5neGoxvNiaGTiaNQQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="807" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqBaiaon5jdLoJPJzwsfjkwy8Pmt5OWfPyC4JB7eIic5neGoxvNiaGTiaNQQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器">又如 2018年发表在 Cell Stem Cell杂志上的文章《<span>Single-Cell RNA Sequencing Analysis Reveals Sequential Cell Fate Transition during Human Spermatogenesis</span>》中成人睾丸细胞单细胞umap图：</h4><figure data-tool="mdnice编辑器"><img data-imgfileid="100053979" data-ratio="0.31296296296296294" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqo3qBVlvcqbibX7Mf7GV5aDibiaZibEFTSqjZ7yeLicnvOdBcibAfg13E5Zdw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqo3qBVlvcqbibX7Mf7GV5aDibiaZibEFTSqjZ7yeLicnvOdBcibAfg13E5Zdw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>都是这种丝状，线条状连续的umap散点图。<span></span></h4><h3 data-tool="mdnice编辑器"><span></span><span></span><span>3、抽丝剥茧，看学员的操作</span><span></span></h3><p data-tool="mdnice编辑器">既然学员的代码都给了，那回头看看呀，初看没什么特别的，然后一步一步运行一下：</p><pre data-tool="mdnice编辑器"><code><span>#####-----step1:读取数据，创建合并Seurat对象   </span><br><br>dir=<span>'1step_LOAD/GSE125527_RAW'</span><br>samples=list.files( dir )<br>samples <br><br>sceList = lapply(samples,<span>function</span>(pro){ <br>  <span>print</span>(pro)  <br>  ct=fread(file.path( dir ,pro),data.table = F)<br>  ct[1:4,1:4]<br>  rownames(ct)=ct[,1]<br>  colnames(ct) = paste(gsub(<span>'_filtered_gene_bc_matrices.csv.gz'</span>,<span>''</span>,pro),<br>                       colnames(ct) ,sep = <span>'_'</span>)<br>  ct=ct[,-1] <br>  sce =CreateSeuratObject(counts =  ct ,<br>                          project =  pro  ,<br>                          min.cells = 5,<br>                          min.features = 300 )<br>  <span>return</span>(sce)<br>}) <br><br><br>do.call(rbind,lapply(sceList, dim))<br><br>sce.all=merge(x=sceList[[1]],<br>              y=sceList[ -1 ])<br><br><br><br>names(sce.all@assays<span>$RNA</span>@layers)<br>sce.all[[<span>"RNA"</span>]]<span>$counts</span> <br><br><span># Alternate accessor function with the same result</span><br>LayerData(sce.all, assay = <span>"RNA"</span>, layer = <span>"counts"</span>)<br>sce.all &lt;- JoinLayers(sce.all)<br>dim(sce.all[[<span>"RNA"</span>]]<span>$counts</span> )<br><br>as.data.frame(sce.all@assays<span>$RNA</span><span>$counts</span>[1:10, 1:2])<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100053978" data-ratio="0.327" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqx2JDkSQ0YtgEBW8ibwfhp1AjFic5yNYfvIagpNyrjHQticjBue3dpfbhQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyzVZTIm20gdjLcMj4yuJNqx2JDkSQ0YtgEBW8ibwfhp1AjFic5yNYfvIagpNyrjHQticjBue3dpfbhQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span>他的矩阵竟然行是细胞，列是基因，还给列的基因加上了样本名！</span></h4><h3 data-tool="mdnice编辑器"><span></span><span></span><span>再一次验证：基础不牢，地动山摇！</span><span></span></h3><blockquote data-tool="mdnice编辑器"><p>其实学员的代码有很多次机会他能发现他运行过程中的结果不对，但是从头跑到尾就是没发现！</p></blockquote><h4 data-tool="mdnice编辑器"><span></span>这个过程也挺有意思的，表达矩阵的行列互换后还能正常跑出来一个结果，还是一个烟花!<span></span></h4><h4 data-tool="mdnice编辑器"><span></span>祝大家新年快乐，初二应该都开始走亲戚了！<span></span></h4><h4 data-tool="mdnice编辑器">如果你也曾遇到过上述类似场景但是百思不得其解，可以看看我们下面的招生，<span>全年365天24小时在线为你排忧解难，为你的生信入门保驾护航</span>：</h4><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527230&amp;idx=1&amp;sn=7156afcd5ab734c7d391b9048695747a&amp;scene=21#wechat_redirect" data-linktype="2">生信入门&amp;数据挖掘线上直播课2025年1月班</a></p><p data-tool="mdnice编辑器"><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/QOCKM4DcLdFqCKKRlyqEng",target="_blank" rel="noopener noreferrer">原文链接</a>
