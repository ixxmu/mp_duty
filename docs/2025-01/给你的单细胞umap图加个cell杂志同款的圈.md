---
title: "给你的单细胞umap图加个cell杂志同款的圈"
date: 2025-01-23T04:50:32Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
给你的单细胞umap图加个cell杂志同款的圈 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>我们经常看到 <span>很多单细胞高分文章中都给它的umap注释结果加了一个圈圈，让读者的视角更集中在一个无形的圈圈上面</span>，今天来学习一下怎么操作吧。这个加了圈的高颜值UMAP散点图来自文献：《<strong>Molecular Pathways of Colon Inflammation Induced by Cancer Immunotherapy</strong>》，<strong>于 2020年8月份发表在顶刊Cell上</strong>。</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100053552" data-ratio="0.6940418679549114" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGt9ZxegbaV7fr8Inc6ePa66ffGqhNnIKlqzic2mWeoqYLlVXCOsFkyzA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="621" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGt9ZxegbaV7fr8Inc6ePa66ffGqhNnIKlqzic2mWeoqYLlVXCOsFkyzA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">图注：图中为所有的CD45+ 免疫细胞</p><blockquote data-tool="mdnice编辑器"><p><strong>Figure 1</strong> <strong>Global Analysis of Immune Cell Populations in CPI Colitis</strong></p><p>(C) Identification of colon CD45+ immune cell clusters across all samples (n = 5–6 subjects per cohort).</p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span>数据背景：三个分组</span></h2><p data-tool="mdnice编辑器">+CPI colitis全称：Check point inhibitor-induced colitis</p><p data-tool="mdnice编辑器"><strong>(1) +CPI colitis</strong>：经免疫检查点抑制剂（CPI）治疗且经组织学确诊为结肠炎的黑色素瘤患者（n = 8，+CPI结肠炎）；</p><p data-tool="mdnice编辑器"><strong>(2) Normal control</strong>：接受筛查性肠镜检查的健康成年人，其年龄与上述患者相近（n = 8，对照组）；</p><p data-tool="mdnice编辑器"><strong>(3) +CPI no colitis</strong>：经免疫检查点抑制剂（CPI）治疗的黑色素瘤患者，这些患者因疑似+CPI结肠炎接受了内镜检查，但内镜和组织学检查均显示其结肠黏膜正常（n = 6，+CPI无结肠炎）（图1B）</p><p data-tool="mdnice编辑器">这个研究设计能够区分由药物暴露引起的分子变化与实际的疾病过程。除每组中有1例患者接受抗CTLA-4单药治疗外，所有接受CPI治疗的患者最近都接受了CTLA-4和PD-1抗体的治疗。</p><p data-tool="mdnice编辑器">作者通过荧光激活细胞分选（FACS）技术，依次分离出活的<strong>CD45⁺单个核细胞</strong>以及<strong>CD3⁺T细胞</strong>，并使用10X Genomics 5‘端技术进行单细胞RNA测序（scRNA-seq）。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100053554" data-ratio="0.3611111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGkl7Ev4aLZIsJaYkNEjic46M4oZf6RuMVD7micApZXBR7jaHVKgiboH1UQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGkl7Ev4aLZIsJaYkNEjic46M4oZf6RuMVD7micApZXBR7jaHVKgiboH1UQ/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>数据可下载：</span></h2><p data-tool="mdnice编辑器">GSE144469：<span>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE144469</span></p><blockquote data-tool="mdnice编辑器"><p>Samples from 22 patients from 3 different cohorts (Normal control, +CPI no colitis, +CPI colitis)</p></blockquote><pre data-tool="mdnice编辑器"><code>GSE144469_RAW.tar<br>GSE144469_TCR_filtered_contig_annotations_all.csv.gz<br></code></pre><p data-tool="mdnice编辑器">GSE144469_RAW.tar：这个包中包括了 CD45+、CD3+细胞。此次我们使用图片中的 CD45+ 进行分析。</p><p data-tool="mdnice编辑器">数据下载下来后，整理成如下格式：每个样本下面三个标准文件</p><pre data-tool="mdnice编辑器"><code>├── outputs<br>│   ├── C1-CD45<br>│   │   ├── barcodes.tsv.gz<br>│   │   ├── features.tsv.gz<br>│   │   └── matrix.mtx.gz<br>│   ├── C2-CD45<br>│   │   ├── barcodes.tsv.gz<br>│   │   ├── features.tsv.gz<br>│   │   └── matrix.mtx.gz<br>│   ├── C3-CD45<br>│   │   ├── barcodes.tsv.gz<br>│   │   ├── features.tsv.gz<br>│   │   └── matrix.mtx.gz<br>...........................<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>简单处理一下这个数据</span></h2><p data-tool="mdnice编辑器">上面的数据下载并整理成上面的目录后，批量读取并创建seurat对象：</p><pre data-tool="mdnice编辑器"><code><span>###</span><br><span>### Create: Jianming Zeng</span><br><span>### Date:  2023-12-31  </span><br><span>### Email: jmzeng1314@163.com</span><br><span>### Blog: http://www.bio-info-trainee.com/</span><br><span>### Forum:  http://www.biotrainee.com/thread-1376-1-1.html</span><br><span>### CAFS/SUSTC/Eli Lilly/University of Macau</span><br><span>### Update Log: 2023-12-31   First version </span><br><span>### Update Log: 2024-12-09   by juan zhang (492482942@qq.com)</span><br><span>### </span><br><br>rm(list=ls())<br><span>library</span>(Seurat)<br><span>library</span>(data.table)<br><span>library</span>(Matrix)<br><span>library</span>(qs)<br><br><span># 参考：https://mp.weixin.qq.com/s/tw7lygmGDAbpzMTx57VvFw</span><br><span># https://ftp.ncbi.nlm.nih.gov/geo/series/GSE128nnn/GSE128531/suppl/GSE128531_RAW.tar</span><br>dir &lt;- <span>"GSE144469/cd45/outputs/"</span><br>samples &lt;- list.dirs(dir, recursive = <span>F</span>, full.names = <span>F</span>)<br>samples<br>scRNAlist &lt;- lapply(samples, <span>function</span>(pro){<br>  folder &lt;- file.path(dir, pro)<br>  print(folder)<br>  counts &lt;- Read10X(folder, gene.column = <span>2</span>)<br>  sce &lt;- CreateSeuratObject(counts, project=pro)<br>  <span>return</span>(sce)<br>})<br>names(scRNAlist) &lt;-  samples<br>scRNAlist<br><br><span># merge</span><br>scRNA &lt;- merge(scRNAlist[[<span>1</span>]], y=scRNAlist[-<span>1</span>], add.cell.ids=samples)<br>scRNA &lt;- JoinLayers(scRNA) <span># seurat v5</span><br>scRNA<br><br>head(scRNA@meta.data)<br>table(scRNA@meta.data$orig.ident)<br><br>temp &lt;- as.data.frame(table(scRNA@meta.data$orig.ident))<br>temp<br><br><span># qs保存速度快</span><br>qsave(scRNA, file=<span>"GSE144469/cd45/sce.all.qs"</span>)<br></code></pre><p data-tool="mdnice编辑器">然后经过简单的降维聚类分群、初始的注释，得到下面的UMAP图：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100053553" data-ratio="0.7899543378995434" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGqVricK1YO1oSDBOXwKboAQx2BFuu6LiaxqDHWOYOEwGcGzsXfWV1yykw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="876" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGqVricK1YO1oSDBOXwKboAQx2BFuu6LiaxqDHWOYOEwGcGzsXfWV1yykw/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>UMAP加轮廓</span></h2><p data-tool="mdnice编辑器">我们这里借助 R包 mascarade，官网为：</p><ul data-tool="mdnice编辑器"><li><section><p><span>https://github.com/alserglab/mascarade</span></p></section></li><li><section><p><span>https://rpubs.com/asergushichev/mascarade-tutorial</span></p></section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span></span><span>首先安装一下：</span><span></span></h3><pre data-tool="mdnice编辑器"><code><span>## 使用西湖大学的 Bioconductor镜像</span><br>options(BioC_mirror=<span>"https://mirrors.westlake.edu.cn/bioconductor"</span>)<br>options(<span>"repos"</span>=c(CRAN=<span>"https://mirrors.westlake.edu.cn/CRAN/"</span>))<br><span># 安装</span><br>remotes::install_github(<span>"alserglab/mascarade"</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>制作加圈需要的数据：</span><span></span></h3><pre data-tool="mdnice编辑器"><code><span>## Seurat对象</span><br>library(Seurat)<br>library(SeuratData)<br>library(mascarade)<br>library(tidyverse)<br>library(Seurat)<br>library(data.table)<br><br><span># 带有注释的seurat对象 v5</span><br>sce.all.filt_sub<br><br>df &lt;- FetchData(object=sce.all.filt_sub, vars=c(<span>"umap_1"</span>,<span>"umap_2"</span>,<span>"RNA_snn_res.0.5"</span>,<span>"celltype"</span>,<span>"celltype_cluster"</span>))<br>head(df)<br>str(df)<br>dim(df)<br></code></pre><p data-tool="mdnice编辑器">提取出来的umap坐标以及细胞亚群注释结果：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100053551" data-ratio="0.16545265348595214" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGsFrRW3Hg3k0juX2LJibnia5eyCiaAtqichlarbhlLLIUPUZ9prAiaaeDICQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="961" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGsFrRW3Hg3k0juX2LJibnia5eyCiaAtqichlarbhlLLIUPUZ9prAiaaeDICQ/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>制作masktable</span><span></span></h3><p data-tool="mdnice编辑器"><code>generateMask</code>函数中的</p><ul data-tool="mdnice编辑器"><li><section><code>minDensity </code>：控制 加圈的松紧成都，值越小，加的圈边界与umap散点距离越大越宽松</section></li><li><section><code>smoothSigma = 0.05</code>：控制加圈的平滑成都，值越大加的圈越平滑</section></li></ul><pre data-tool="mdnice编辑器"><code>maskTable &lt;- generateMask( dims=df[,1:2], cluster=df<span>$celltype</span>, minDensity = 1.5,smoothSigma = 0.05 )<br>class(maskTable)<br>dim(maskTable)<br>head(maskTable)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>先简单加个圈看看：</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><code>linewidth=0.3</code>：控制加的线粗细</section></li><li><section><code>linetype = 2</code>：控制加的线类型，虚线、实线等，2为虚线</section></li></ul><pre data-tool="mdnice编辑器"><code>p &lt;- ggplot(df, aes(x=umap_1, y=umap_2)) + <br>  geom_point(aes(color=celltype_cluster),size = 0.05) + <br>  geom_path(data=maskTable, aes(group=group),linewidth=0.3,linetype = 2) +<br>  coord_fixed() + <br>  theme_classic()<br><br>p<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100053555" data-ratio="0.7570224719101124" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGgoRib0bYTlKy2gd0NMiaUViboR3RhDFOD5yxicR0g9DricNXhN6zr2kpW1A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="712" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGgoRib0bYTlKy2gd0NMiaUViboR3RhDFOD5yxicR0g9DricNXhN6zr2kpW1A/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>特定的亚群上加圈：</span><span></span></h3><pre data-tool="mdnice编辑器"><code>p &lt;- ggplot(df, aes(x=umap_1, y=umap_2)) + <br>  geom_point(aes(color=celltype_cluster),size = <span>0.05</span>) + <br>  geom_path(data=maskTable[cluster==<span>"T cells"</span>], aes(group=group),linewidth=<span>0.3</span>,linetype = <span>2</span>) +<br>  coord_fixed() + <br>  theme_classic()<br>p<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100053559" data-ratio="0.7652050919377652" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGX8K7I545ub0ntLOblgFGTMHDpQIwejwdWAicibQoN1iauWdLxgS1ib4Mrw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="707" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGX8K7I545ub0ntLOblgFGTMHDpQIwejwdWAicibQoN1iauWdLxgS1ib4Mrw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">两个亚群圈：</p><pre data-tool="mdnice编辑器"><code>p &lt;- ggplot(df, aes(x=umap_1, y=umap_2)) + <br>  geom_point(aes(color=celltype_cluster),size = <span>0.05</span>) + <br>  geom_path(data=maskTable[cluster==<span>"T cells"</span> | cluster==<span>"B cells"</span>], aes(group=group),linewidth=<span>0.3</span>,linetype = <span>2</span>) +<br>  coord_fixed() + <br>  theme_classic()<br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100053558" data-ratio="0.7739628040057225" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGoADA2eibfhcPJXdcWXovNtcniboE9AIgXYlSIFHYxqETaJC8jcXiacwdA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="699" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGoADA2eibfhcPJXdcWXovNtcniboE9AIgXYlSIFHYxqETaJC8jcXiacwdA/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>再优化一下，加上细胞亚群 cluster 标签：</span><span></span></h3><p data-tool="mdnice编辑器">加上标签并同时圈住文中的三个亚群：</p><pre data-tool="mdnice编辑器"><code><span>## 文章中的</span><br>head(maskTable)<br><br>p1 &lt;- DimPlot(sce.all.filt_sub, reduction = <span>"umap"</span>, group.by = <span>"RNA_snn_res.0.5"</span>, label = T) + <br>  ggtitle(<span>"celltype_cluster"</span>)<br>p1<br><br><br>plots &lt;- lapply(p1, `+`,<br>                list(<br>                  geom_path(data=maskTable[cluster==<span>"T cells"</span> | cluster==<span>"B cells"</span>| cluster==<span>"Plasma B cells"</span>], <br>                            aes(x=umap_1, y=umap_2, group=group),linewidth=0.3,linetype = 2),<br>                  <span># so that borders aren't cropped:</span><br>                  scale_x_continuous(expand = expansion(mult = 0.05)),<br>                  scale_y_continuous(expand = expansion(mult = 0.05))) <br>)<br><br>patchwork::wrap_plots(plots)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100053560" data-ratio="0.8631239935587761" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGibDuWwZRdmLDUWGsibM5k7ZlGCLibahicoiau8ibKjPwaHDrQupiaosoyYejQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="621" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyAkKqDY1TQrAUTBTqiajWFGibDuWwZRdmLDUWGsibM5k7ZlGCLibahicoiau8ibKjPwaHDrQupiaosoyYejQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">还是很好看的！</p><p data-tool="mdnice编辑器">唯一不足的地方：细胞亚群注释label PS 加上去吧，后面看看源码是不是可以再优化一下。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span><strong>友情宣传：</strong></span><span></span></h3><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527230&amp;idx=1&amp;sn=7156afcd5ab734c7d391b9048695747a&amp;scene=21#wechat_redirect" data-linktype="2">生信入门&amp;数据挖掘线上直播课2025年1月班</a></p><p data-tool="mdnice编辑器"><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/smb7yTU8RBu7t8QlHhbOrQ",target="_blank" rel="noopener noreferrer">原文链接</a>
