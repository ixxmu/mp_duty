---
title: "你没见过的两种高颜值单细胞亚群相关性热图"
date: 2025-01-11T14:25:21Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
你没见过的两种高颜值单细胞亚群相关性热图 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>群里经常接到一些粉丝提问：<strong>单细胞不同亚群间的相关性怎么计算？经过简单检索，发现有两种类型的 相关性热图在已发表的文献中出现过，他们表示的含义不一样，一起来看看吧</strong>。</p></blockquote><h1 data-tool="mdnice编辑器"><span>第一种：使用</span><span><span>细胞亚群基因表达均值</span></span><span>计算亚群间的相关性热图绘制</span></h1><p data-tool="mdnice编辑器">这种相关性热图计算的是<strong><span>单细胞亚群间伪bulk基因表达的相关性</span></strong>，这里有两个应用。</p><h2 data-tool="mdnice编辑器"><span></span><span>文献案例1</span></h2><p data-tool="mdnice编辑器">文献标题为：《<span>Immunophenotyping of COVID-19 and influenza highlights the role oftype I interferons in development of severe COVID-19</span>》，于2020年7月份发表在杂志 Sci Immunol上。</p><blockquote data-tool="mdnice编辑器"><p>图注：(A) 使用皮尔逊相关系数（PCC）在对不同疾病分组的细胞亚群进行层次聚类，热图中的颜色表示皮尔逊相关系数的数值。热图上方的颜色条表示细胞类型和疾病组。黑色方框标出了在严重COVID-19和流感（FLU）组之间高度相关的细胞类型。</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100052916" data-ratio="0.7309562398703403" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxeEAv3jAYXIIUMTWEvy2akhMkjaia1NR5RE3eaOwDCX0nSciavsj6ic1Mw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="617" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxeEAv3jAYXIIUMTWEvy2akhMkjaia1NR5RE3eaOwDCX0nSciavsj6ic1Mw/640?wx_fmt=png&amp;from=appmsg"><figcaption>Fig. 2. Immune landscape of COVID-19</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>文献案例2</span></h2><p data-tool="mdnice编辑器">文献标题为：《<span>Single-Cell Reconstruction of Progression Trajectory Reveals Intervention Principles in Pathological Cardiac Hypertrophy</span>》，于2020年5月发表在Circulation杂志。</p><blockquote data-tool="mdnice编辑器"><p>图注D：10 CM subtypes were grouped into functional clusters (FCs) by Spearman correlation analysis. FC1=CM0+CM2+CM3+CM6, FC2=CM7+CM8, FC3=CM1+CM4+CM9, FC4=CM5。</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100052915" data-ratio="0.3957091775923719" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxW9IbPIR3IFzdlQniaNjjmUzty6QyK3eue2LvC3bjr5VBfU2K1Oic4URQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="839" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxW9IbPIR3IFzdlQniaNjjmUzty6QyK3eue2LvC3bjr5VBfU2K1Oic4URQ/640?wx_fmt=png&amp;from=appmsg"><figcaption>Figure 2</figcaption></figure><h2 data-tool="mdnice编辑器"><span></span><span>实战：基于基因表达 计算相关性热图绘制</span></h2><p data-tool="mdnice编辑器">这里就简单一点，使用经典的pbmc3k数据进行绘制。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1、首选得到数据，从 SeuratData包中获取：</span><span></span></h3><pre data-tool="mdnice编辑器"><code>rm(list=ls())<br>options(timeout=10000)<br>options(scipen = 1000)<br><span># 加载seurat数据集 </span><br>library(SeuratData) <span># pbmc3k 数据</span><br><span># InstallData("pbmc3k")  </span><br>library(Seurat)<br>library(tidyverse)<br>library(ggpubr)<br>library(ggplot2)<br>library(ggrastr)<br><span># devtools::install_github("LKremer/ggpointdensity")</span><br>library(ggpointdensity)<br><br><span>## 使用细胞亚群基因表达均值计算亚群间的相关性热图绘制</span><br><br><span># 加载数据</span><br>data(<span>"pbmc3k"</span>)  <br>pbmc3k<br>class(pbmc3k)<br><br>pbmc3k.final<br>sce &lt;- UpdateSeuratObject(pbmc3k.final) <br>sce<br>table(sce<span>$seurat_annotations</span>)<br>head(sce@meta.data)<br>str(sce@meta.data)<br><br>sce &lt;- sce %&gt;% <br>  NormalizeData %&gt;% <br>  FindVariableFeatures %&gt;% <br>  ScaleData(features = rownames(sce))<br><br>Idents(sce)<br>sce<span>$seurat_annotations</span> &lt;- as.character(sce<span>$seurat_annotations</span>)<br>table(sce<span>$seurat_annotations</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>2、计算每个亚群的基因表达均值</span><span></span></h3><p data-tool="mdnice编辑器">使用经典的<strong><span>AggregateExpression</span></strong>函数得到伪bulk 表达谱：</p><pre data-tool="mdnice编辑器"><code>cor_data &lt;- AggregateExpression(sce, group.by = <span>"seurat_annotations"</span>, assays = <span>"RNA"</span>,return.seurat = TRUE)<br>cor_data &lt;- cor_data[[<span>"RNA"</span>]]<span>$data</span><br>range(cor_data)<br>head(cor_data)<br></code></pre><p data-tool="mdnice编辑器">现在每一列为一个细胞亚群，每一行为一个基因：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052913" data-ratio="0.13796296296296295" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxvbREMvJ3tEFV12nvqJUYrliaG96zJoQjwjVrabiaMqQVwEJAwZNP6Vicg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxvbREMvJ3tEFV12nvqJUYrliaG96zJoQjwjVrabiaMqQVwEJAwZNP6Vicg/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>3、绘图</span><span></span></h3><p data-tool="mdnice编辑器">使用粗糙的pheatmap简单绘图：</p><pre data-tool="mdnice编辑器"><code>pheatmap::pheatmap(cor(cor_data))<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052914" data-ratio="0.7873239436619718" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxd95pWC7FNKs0WZB7IPv5Aicwmhww2EZLPJwkFkUNStjzZyP05AIfymA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="710" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxd95pWC7FNKs0WZB7IPv5Aicwmhww2EZLPJwkFkUNStjzZyP05AIfymA/640?wx_fmt=png&amp;from=appmsg"></figure><h1 data-tool="mdnice编辑器"><span>第二种：使用</span><strong><span>不同样本中各细胞亚群相对百分比</span></strong><span>计算亚群间的相关性热图绘制</span></h1><h2 data-tool="mdnice编辑器"><span></span><span>文献案例1</span></h2><p data-tool="mdnice编辑器"><span><strong>这种图比下面那个传统热图颜值要高！</strong></span></p><p data-tool="mdnice编辑器">文献：《<span>CAF-macrophage crosstalk in tumour microenvironments governs the response to immune checkpoint blockade in gastric cancer peritoneal  metastases</span>》中：</p><blockquote data-tool="mdnice编辑器"><p><strong>Figure 6</strong> Crosstalk between fibroblasts and macrophages in peritoneal metastases of gastric cancer. (A) Heatmap displaying the correlations across all cell types in the single-cell data. Gastric normal (GN) tissues (n=14), primary gastric cancer (GC) tissues (n=31) and gastric cancer peritoneal metastases (GCPM) tissues (n=24) were included in the analyses. (B) Correlations between cancer-associated fibroblasts (CAFs) and macrophages in the single-cell data</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100052917" data-ratio="0.8689516129032258" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxRWyaLXuSHT8n7NkthH5VFdibHMxFIF4FSicvsjqnkhUBNEVT3ic27nrEQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="496" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxRWyaLXuSHT8n7NkthH5VFdibHMxFIF4FSicvsjqnkhUBNEVT3ic27nrEQ/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>文献案例2</span></h2><p data-tool="mdnice编辑器">文献：《<span>Single-cell and spatial transcriptomics analysis of non-small cell lung cancer</span>》中：</p><blockquote data-tool="mdnice编辑器"><p><strong>Fig. 2 | Integrated single cell and spatial transcriptomics uncovers different interaction networks in LUAD and LUSC</strong>. A Heatmap showing the Pearson cor-relation between <strong>the relative cell-type abundance for each immune cell type (cal-culated within the CD235− enrichment)</strong>. Colour indicates the Pearson correlation value, asterisks indicate the level of significance of the two-sided association test computed on Pearson’s product-moment correlation coefficients (*P &lt; 0.05, ** P &lt; 0.01, ***P &lt; 0.001)</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100052921" data-ratio="0.7021996615905245" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxvWbsARiccCcs8UGsMPN3HOsuneToIWPesAQAUoXZmBWicuH9fpiaia8p0A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="591" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxvWbsARiccCcs8UGsMPN3HOsuneToIWPesAQAUoXZmBWicuH9fpiaia8p0A/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>实战：细胞比例 相关性热图绘制</span></h2><p data-tool="mdnice编辑器">我们以 GSE236581为例子，给大家演示 第二种 细胞比例 相关性热图绘制。关于这个 数据集的介绍和分析，可以前往我们前面的两个帖子：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247532399&amp;idx=2&amp;sn=d11dbaa1bb7ebf4acbe018b79efcb79b&amp;scene=21#wechat_redirect" data-linktype="2">百万级别数量的单细胞数据在r里面如何更快处理呢</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527245&amp;idx=1&amp;sn=e520bd70a2a07d6cdb566930b8196013&amp;scene=21#wechat_redirect" data-linktype="2">百万细胞舍我其谁（一晚上解决战斗）</a></section></li></ul><p data-tool="mdnice编辑器">这个数据集接近100万个细胞，而且研究者们给出来了比较好的单细胞亚群注释信息，下载文件为：<span>GSE236581_CRC-ICB_metadata.txt.gz</span>，在这里 可以下载到：<span>https://ftp.ncbi.nlm.nih.gov/geo/series/GSE236nnn/GSE236581/suppl/GSE236581%5FCRC%2DICB%5Fmetadata.txt.gz</span>。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052922" data-ratio="0.704" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxjERqDAenLzOPMJOakkiaicYvYyvuWDb6sichFys5yNTvPjbPTE8AqeFlg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="875" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxjERqDAenLzOPMJOakkiaicYvYyvuWDb6sichFys5yNTvPjbPTE8AqeFlg/640?wx_fmt=png&amp;from=appmsg"><figcaption>GSE236581</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1、先导入数据</span><span></span></h3><p data-tool="mdnice编辑器">选取样本ID列：Ident 与细胞细分亚群列：SubCellType</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052920" data-ratio="0.2574074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxZVeAYUmIJjdv2FagHMUHjU19zHUj1Wtl6U08HseJ2z2zGcJia6bUMYg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxZVeAYUmIJjdv2FagHMUHjU19zHUj1Wtl6U08HseJ2z2zGcJia6bUMYg/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><code>rm(list=ls())<br>options(scipen = 1000)<br><span># devtools::install_github("LKremer/ggpointdensity")</span><br>library(ggpointdensity)<br><span># InstallData("pbmc3k")</span><br><span># BiocManager::install('caijun/ggcorrplot2')</span><br>library(ggcorrplot2) <span># 绘制下三角相关性椭圆图ggcorrplot</span><br>library(ggplot2)<br>library(sur)<br>library(reshape2) <span># 数据长宽变换</span><br>library(psych) <span># 相关性计算</span><br><br><span>## 使用不同样本中各细胞亚群相对百分比计算亚群间的相关性热图绘制</span><br><span>## </span><br><br>phe &lt;- data.table::fread(<span>'GSE236581_CRC-ICB_metadata.txt.gz'</span>,data.table = F) <br>head(phe)<br>table(phe<span>$Ident</span>)<br>table(phe<span>$Patient</span>)<br>table(phe<span>$SubCellType</span>)<br>length(table(phe<span>$SubCellType</span>))<br><br>rownames(phe) &lt;- phe[,1]<br>phe &lt;- phe[,-1]<br>table(phe<span>$Ident</span>)<br><span># 169个样本</span><br>length(table(phe<span>$Ident</span>))<br><br><span># 返回的数据tible格式，转成dataframe后为三列，第一列不同样本ID：Ident, 第二列列为细胞亚群 SubCelltype</span><br><span># 第三列的值为每个样本中每种细胞亚群的细胞数</span><br>tbl &lt;- table(phe<span>$Ident</span>, phe<span>$SubCellType</span>)<br>head(as.data.frame(tbl))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100052918" data-ratio="0.3080082135523614" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkx2Z0UShSNXsrU6rl0O232el8JEFC3uiaw4ngSXDZDQpNKaiaiacndFibWng/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="487" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkx2Z0UShSNXsrU6rl0O232el8JEFC3uiaw4ngSXDZDQpNKaiaiacndFibWng/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">使用 <code>reshape2</code>包 中的<code>dcast</code>函数 将数据从长格式转换为宽格式，并将结果保存在<code>df</code>变量中：</p><p data-tool="mdnice编辑器"><code>dcast(..., x~y)</code>: <code>dcast</code>函数用于将数据从长格式转换为宽格式。这里的<code>x~y</code>是一个公式，指定了转换的规则：</p><ul data-tool="mdnice编辑器"><li><section><code>x</code>：这通常是一个或多个变量，它们在转换后将成为数据框的行名。在转换过程中，<code>x</code>变量的每个唯一值都会成为结果数据框中的一行。</section></li><li><section><code>y</code>：这是一个变量，它在转换后将成为数据框的列名。<code>y</code>变量的每个唯一值都会成为结果数据框中的一列。</section></li></ul><pre data-tool="mdnice编辑器"><code>x &lt;- phe<span>$Ident</span><br>y &lt;- phe<span>$SubCellType</span><br>df &lt;- dcast(as.data.frame(tbl), x~y)<br>head(df[, 1:6])<br>write.csv(df,<span>'SubCellType-table.csv'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100052919" data-ratio="0.1592554291623578" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxxTuksS3miaicF7lK9rEFUJw0PNofqh5gTSibaCM94BKia08w7nicBJibftyw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="967" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxxTuksS3miaicF7lK9rEFUJw0PNofqh5gTSibaCM94BKia08w7nicBJibftyw/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>2、计算每个样本中不同细胞亚群的相对比例</span><span></span></h3><p data-tool="mdnice编辑器">现在计算比例：每个样本中 不同细胞亚群的相对比例，即<strong>每一行的值除以这一行的行和</strong>。</p><pre data-tool="mdnice编辑器"><code>ptb &lt;- round(100*df[,-1]/rowSums(df[,-1]),3)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>3、绘图</span><span></span></h3><p data-tool="mdnice编辑器">计算相关性并使用 <strong><span>ggcorrplot</span></strong> 绘制下三角矩阵相关性图：</p><pre data-tool="mdnice编辑器"><code>cor_data &lt;- <span>ptb</span> <br>cor_value &lt;- cor(cor_data)<br>cor_test_mat &lt;- corr.test(cor_data)<span>$p</span>  <br><br>cor_pp1 &lt;- ggcorrplot(cor_value, method = <span>"ellipse"</span>,<span>type</span> = <span>"lower"</span>,<br>                    p.mat = cor_test_mat,col = c(<span>"#839EDB"</span>, <span>"white"</span>, <span>"#FF8D8D"</span>),<br>                    insig = <span>"label_sig"</span>, sig.lvl = c(0.05, 0.01, 0.001)) <br><br>cor_pp1 &lt;- cor_pp1 +<br>  theme(axis.text = element_text(size=10))<br><br>cor_pp1 <br><br><span># 保存</span><br>ggsave(filename = <span>'SubCelltype_cor.pdf'</span>,width = 20,height = 20)<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052927" data-ratio="0.8923076923076924" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxobBEYYuM3jicph7PicEoZiaOrhltniaxfsGUyNUsEia9wiamTFYwJ27OMw9g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="910" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwzWuaXyKWo0gb6MbuWGAkxobBEYYuM3jicph7PicEoZiaOrhltniaxfsGUyNUsEia9wiamTFYwJ27OMw9g/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>友情宣传：</strong></p><p data-tool="mdnice编辑器"><strong><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527230&amp;idx=1&amp;sn=7156afcd5ab734c7d391b9048695747a&amp;scene=21#wechat_redirect" data-linktype="2">生信入门&amp;数据挖掘线上直播课2025年1月班</a></strong></p><p data-tool="mdnice编辑器"><strong><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></strong></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/HM9c5a8V2uFFSRuAdBrS7g",target="_blank" rel="noopener noreferrer">原文链接</a>
