---
title: "百万级单细胞GSVA如何提速？"
date: 2025-01-02T03:47:58Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
百万级单细胞GSVA如何提速？ by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">在学完我们生信入门课程后，群里的小伙伴都陆陆续续开始了自己的数据分析，其中有一个学员可能是有一个超大的单细胞数据在跑GSVA分析：<span>已经过去了一个小时候，还没有运行完，就在这里等待着</span>，说不定一下子就等到了2025年... （现在是<strong>2024年12月31日</strong>21:33:26）</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052543" data-ratio="0.6344969199178645" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxk6chXS7UHRMcqMdjjfkyIKjxrJURVOcTMsjzhQIVGPeGpF1lxS7HcJg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="487" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxk6chXS7UHRMcqMdjjfkyIKjxrJURVOcTMsjzhQIVGPeGpF1lxS7HcJg/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span>那么，当我们遇到大数据量的时候，如何加速单细胞的GSVA分析呢？<span></span></h3><h4 data-tool="mdnice编辑器"><span></span>下面以 seurat 官网的 pbm3k 数据为例，进行演示：<span></span></h4><h4 data-tool="mdnice编辑器"><span></span>首先是加载这个经典的数据集：<span></span></h4><pre data-tool="mdnice编辑器"><code>library(gplots)<br>library(ggplot2) <br>library(clusterProfiler)<br>library(org.Hs.eg.db)<br>library(GSVA) <span># BiocManager::install('GSVA')</span><br>library(GSEABase)<br><span># install.packages('devtools')</span><br><span># devtools::install_github('satijalab/seurat-data')</span><br>library(SeuratData) <span>#加载seurat数据集  </span><br>getOption(<span>'timeout'</span>)<br>options(timeout=10000)<br><span># InstallData("pbmc3k")  </span><br>data(<span>"pbmc3k"</span>) <br><br>sce &lt;- pbmc3k.final  <br>table(Idents(sce)) <br>p1 &lt;- DimPlot(sce,label = T)<br>sce<span>$celltype</span> &lt;- Idents(sce)<br><br>sce<br>table(Idents(sce))<br></code></pre><p data-tool="mdnice编辑器">现在这个sce是一个seurat对象，并且Idents为注释的细胞亚类：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052544" data-ratio="0.06851851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkM8JzDxicibTSmQm3XSRvk7J80KBDQ2O4HyOyrCv7kQh4XhqfTAbgNWhQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkM8JzDxicibTSmQm3XSRvk7J80KBDQ2O4HyOyrCv7kQh4XhqfTAbgNWhQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>做GSVA还需要一个基因集，去msigdb上薅一个下来：<span></span></h4><pre data-tool="mdnice编辑器"><code>library(msigdbr)<br>all_gene_sets &lt;- msigdbr(species = <span>"Homo sapiens"</span>, category=<span>'C7'</span>)<br>length(unique(table(all_gene_sets<span>$gs_name</span>)))<br>tail(sort(table(all_gene_sets<span>$gs_name</span>)))<br><br><span># 转换成gsva分析需要的对象</span><br>gs &lt;- split(all_gene_sets<span>$gene_symbol</span>,all_gene_sets<span>$gs_name</span>)<br>gs &lt;- lapply(gs, unique)<br>gsc &lt;- GeneSetCollection(mapply(<span>function</span>(geneIds, keggId) {<br>  GeneSet(geneIds, geneIdType=EntrezIdentifier(),<br>          collectionType=KEGGCollection(keggId),<br>          setName=keggId)<br>}, gs, names(gs)))<br>gsc<br>geneset &lt;- gsc<br>geneset <span># 是一个 GeneSetCollection 对象</span><br></code></pre><h4 data-tool="mdnice编辑器"><span></span>常规的gsva分析是在细胞水平做<span></span></h4><p data-tool="mdnice编辑器">尽管可以使用parallel.sz进行加速，但是数据量大的依然非常耗费计算机资源，耗费时间：</p><pre data-tool="mdnice编辑器"><code><span># 非常耗费计算机资源，耗费时间哦</span><br>es.max &lt;- gsva(as.matrix( sce@assays<span>$RNA</span><span>$scale</span>.data), geneset, mx.diff=FALSE, verbose=FALSE, parallel.sz=8)<br>save(es.max,file = <span>'gsva_all_pbmc.Rdata'</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>提速一：使用亚群水平进行GSVA分析<span></span></h4><p data-tool="mdnice编辑器">这样从原来的单个细胞 变成 注释后的亚群，样本量直接降级。使用 AverageExpression 函数提取每个细胞 亚群的表达矩阵 ：</p><pre data-tool="mdnice编辑器"><code><span># v4 是 AverageExpression</span><br>av &lt;- AggregateExpression(sce , group.by = <span>"celltype"</span>, assays = <span>"RNA"</span>) <br>av &lt;- av[[1]]<br>dim(av)<br>head(av) <span># 可以看到是整数矩阵</span><br><br>X &lt;- av <br><span>## X修改为as.matrix(X)</span><br><span># 这里为 gsva 老版本代码</span><br>es.max &lt;- gsva(as.matrix(X), geneset, mx.diff=FALSE, verbose=FALSE,  parallel.sz=8)<br>head(es.max)<br>dim(es.max)<br>save(es.max,file = <span>'gsva_celltype_pbmc.Rdata'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100052542" data-ratio="0.24390243902439024" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxk0QYuAR9klFl7FliaFibP2LNnCohjqWM51BylDnicia7IeU6PeGfVaVuanA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="861" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxk0QYuAR9klFl7FliaFibP2LNnCohjqWM51BylDnicia7IeU6PeGfVaVuanA/640?wx_fmt=png&amp;from=appmsg"><figcaption><br></figcaption></figure><h4 data-tool="mdnice编辑器"><span></span>提速二：对单细胞进行了downsample处理<span></span></h4><pre data-tool="mdnice编辑器"><code><span>#抽样100个细胞测试展示</span><br>set.seed(1234)<br>table(Idents(sce))<br>sce_down &lt;- subset(sce, downsample=100)<br>table(Idents(sce_down))<br><br><span># 新版 gsva 软件</span><br>y &lt;- as.matrix(sce_down@assays<span>$RNA</span><span>$scale</span>.data)<br>gsvapar &lt;- gsvaParam(y, geneset, maxDiff=TRUE,kcdf=<span>"Gaussian"</span>)<br>es.max &lt;- gsva(as.matrix(sce_down@assays<span>$RNA</span><span>$scale</span>.data), geneset, mx.diff=FALSE, verbose=FALSE,  parallel.sz=8)<br>head(es.max)<br>dim(es.max)<br><span># [1]  50 751</span><br>save(es.max,file = <span>'gsva_celltype100_pbmc.Rdata'</span>)<br></code></pre><p data-tool="mdnice编辑器">降采样后，细胞亚群中细胞数大于100的取100个，小于100的为原来的细胞数：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052541" data-ratio="0.07037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkPOwn6XC8pSibjKaWdaRXznRHNhF6AeOkRvaTnwOkzbE6YicpPAZQ0E7w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkPOwn6XC8pSibjKaWdaRXznRHNhF6AeOkRvaTnwOkzbE6YicpPAZQ0E7w/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">得到为单个细胞水平的打分，单细细胞数已经是降采样后的：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052540" data-ratio="0.20185185185185187" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkSE9QnGfBoiaBRd0Z6ONksA8qK11qcF9IiavZ13xLmJw2JicGHGzOgriboQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkSE9QnGfBoiaBRd0Z6ONksA8qK11qcF9IiavZ13xLmJw2JicGHGzOgriboQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">抽样还可以解决的另外一个问题是计算机资源限制，现在的单细胞数据集很容易达到几十万甚至上百万的细胞数量，就容易出现下面的报错：</p><p><img data-galleryid="" data-imgfileid="100052554" data-ratio="0.12133550488599348" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxklaVdklic2GaQyibLiawUvxJIlyuuVYyYFmbdOkbrDpX9VZhib1vtl7O9bA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1228" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxklaVdklic2GaQyibLiawUvxJIlyuuVYyYFmbdOkbrDpX9VZhib1vtl7O9bA/640?wx_fmt=png&amp;from=appmsg"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span>拿到了每个细胞的每个通路的打分后的可视化</span><span></span></h3><p data-tool="mdnice编辑器">这个时候，可以直接参考Seurat标准流程的可视化方法学，不过它默认出图并不好看，详见以前我们做的投票：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247500816&amp;idx=1&amp;sn=25568540a54d63225def0804c05025f8&amp;scene=21#wechat_redirect" data-linktype="2">可视化单细胞亚群的标记基因的5个方法</a>，下面的5个基础函数相信大家都是已经烂熟于心了：</p><ul data-tool="mdnice编辑器"><li><section>VlnPlot(pbmc, features = c("MS4A1", "CD79A"))</section></li><li><section>FeaturePlot(pbmc, features = c("MS4A1", "CD79A"))</section></li><li><section>RidgePlot(pbmc, features = c("MS4A1", "CD79A"), ncol = 1)</section></li><li><section>DotPlot(pbmc, features = unique(features)) + RotatedAxis()</section></li><li><section>DoHeatmap(subset(pbmc, downsample = 100), features = features, size = 3)</section></li></ul><section>也可以把打分矩阵（每个细胞或者单细胞亚群在每个通路）单独拿出来，使用热图的方法学去可视化，如下所示：<br></section></section><pre data-tool="mdnice编辑器"><code>library(pheatmap)<br><br><span># note：降采样后的的打分对每个亚群取gsva打分均值</span><br>score &lt;- as.data.frame(t(es.max))<br>score<span>$cellid</span> &lt;- rownames(score)<br>head(sce_down@meta.data)<br>sce_down<span>$cellid</span> &lt;- rownames(sce_down@meta.data)<br>score &lt;- merge(sce_down@meta.data[,c(<span>"cellid"</span>,<span>"celltype"</span>)],score, by=<span>"cellid"</span>)<br>head(score[,1:10])<br><br>score_ave &lt;- limma::avereps(score[,-c(1,2)],ID=score<span>$celltype</span>)<br>score_ave &lt;- t(score_ave)<br>head(score_ave)<br><br>pheatmap(score_ave[1:50, ],show_rownames = F)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100052545" data-ratio="1.6784232365145229" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkssmBXABUBsW6tfJv11ZhA4asf2VgFrGdaSWkKVtsy5Pz3prLDjeRdg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="482" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkssmBXABUBsW6tfJv11ZhA4asf2VgFrGdaSWkKVtsy5Pz3prLDjeRdg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">随便找一篇高分文章，你可以看到里面大部分都是以细胞亚群水平进行GSVA打分展示：</p><p data-tool="mdnice编辑器">如 2020年 Cell Research 发表的《<span>Single-cell transcriptomics reveals regulators underlying immune cell diversity and immune subtypes associated with prognosis in nasopharyngeal carcinoma</span>》：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100052546" data-ratio="0.4728079911209767" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkaEPoB8zy55WWoLbbHCiaReoe9uG68Yc0aoKABzn36FUT5VovWstbb1g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="901" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxY25tX0LFZsiczoZy7mTgxkaEPoB8zy55WWoLbbHCiaReoe9uG68Yc0aoKABzn36FUT5VovWstbb1g/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span>文末友情宣传<span></span></h4><p data-tool="mdnice编辑器">强烈建议你推荐给身边的<strong>博士后以及年轻生物学PI</strong>，多一点数据认知，让他们的科研上一个台阶：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536035&amp;idx=2&amp;sn=dab1e47f7ca8aa2ff26a6e440d9bb044&amp;scene=21#wechat_redirect" data-linktype="2"><strong>生信入门&amp;数据挖掘线上直播课2025年1月班</strong></a><strong>，你的生物信息学入门课</strong></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" data-linktype="2"><strong>时隔5年，我们的生信技能树VIP学徒继续招生啦</strong></a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247530048&amp;idx=1&amp;sn=28aa7bbd5e00521f79e074496a5f5d66&amp;scene=21#wechat_redirect" data-linktype="2"><strong>满足你生信分析计算需求的低价解决方案</strong></a></section></li></ul></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Nzs4mnbvGWaN1rTRFXeCOw",target="_blank" rel="noopener noreferrer">原文链接</a>
