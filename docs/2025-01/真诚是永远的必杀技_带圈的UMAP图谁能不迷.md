---
title: "真诚是永远的必杀技，带圈的UMAP图谁能不迷"
date: 2025-01-28T00:05:46Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
真诚是永远的必杀技，带圈的UMAP图谁能不迷 by 生信星球
------
<div><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section><img data-imgfileid="100013088" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100013090" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第1030天</strong></span></span><img data-imgfileid="100013089" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></section><hr><section><span><span>   </span></span></section><section><blockquote><section><span>公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span><span>我的课程都是循环开课，</span><span>点进去咨询微信↓</span><br></section><section><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247496614&amp;idx=1&amp;sn=4177354e87d394a022c3d410f482546a&amp;scene=21#wechat_redirect" textvalue="生信分‍析直播课程" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a>(每月初开一期，春节休一个月，下一期3月初)</section><section><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494919&amp;idx=2&amp;sn=967d8dcf0f9a22047ae0bd442b9d4ee6&amp;scene=21#wechat_redirect" textvalue="生信新手保护学‍习小组" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信新手保护学习小组</a>（每月两期）</section><section><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247495036&amp;idx=1&amp;sn=fe8bab2c3d21e7b0a919ad4f1641ca9c&amp;chksm=fdfba53eca8c2c286522b2accc0d4cb9dda7cd9a5b36695e66d393abb5bff396d6bcaa4c9cb8&amp;scene=21#wechat_redirect" textvalue="单细胞陪伴学习小组内测完成，长期招生中" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞陪伴学习小组</a>（每月两期）<span></span></section></blockquote></section><p><br></p><section><img data-galleryid="" data-imgfileid="100013094" data-ratio="0.42407407407407405" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHqk1bVjtqTicXzJZtd0jcqFJUicbsy24etUPUp2bzKGKuDcSqUibdMtO9mQtPotPtZm1QLDZkEsoevXA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHqk1bVjtqTicXzJZtd0jcqFJUicbsy24etUPUp2bzKGKuDcSqUibdMtO9mQtPotPtZm1QLDZkEsoevXA/640?wx_fmt=png&amp;from=appmsg"></section><section>输入数据是一个注释好的adata对象，示例数据请在公众号聊天窗口回复‘adata1030’<br></section><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><pre data-tool="mdnice编辑器"><code><span>import</span> scanpy <span>as</span> sc<br>adata = sc.read_h5ad(<span>'adata.h5ad'</span>)<br>adata<br></code></pre><pre data-tool="mdnice编辑器"><code>AnnData object with n_obs × n_vars = 11727 × 21189<br>    obs: 'batch', 'group', 'n_genes', 'n_genes_by_counts', 'total_counts', 'total_counts_mt', 'pct_counts_mt', 'total_counts_ribo', 'pct_counts_ribo', 'total_counts_hb', 'pct_counts_hb', 'leiden', 'predicted_labels', 'over_clustering', 'majority_voting', 'conf_score', 'self_annotation'<br>    var: 'n_cells', 'mt', 'ribo', 'hb', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm', 'mean', 'std'<br>    uns: 'batch_colors', 'group_colors', 'hvg', 'leiden', 'leiden_colors', 'log1p', 'majority_voting_colors', 'neighbors', 'over_clustering', 'pca', 'self_annotation_colors', 'umap'<br>    obsm: 'X_pca', 'X_pca_harmony', 'X_umap'<br>    varm: 'PCs'<br>    obsp: 'connectivities', 'distances'<br></code></pre><pre data-tool="mdnice编辑器"><code><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span>import</span> numpy <span>as</span> np<br><span>import</span> seaborn <span>as</span> sns<br><span>from</span> sklearn.neighbors <span>import</span> KernelDensity<br><span>from</span> scipy.spatial.distance <span>import</span> cdist<br><br><span># 设置绘图样式</span><br>plt.style.use(<span>'default'</span>)<br><br><span># 绘制UMAP图</span><br>fig, ax = plt.subplots(figsize=(<span>8</span>, <span>6</span>))<br><br><span># 绘制UMAP散点图</span><br>sc.pl.umap(<br>    adata,<br>    color=<span>"self_annotation"</span>,  <span># 使用 self_annotation 作为细胞类型</span><br>    legend_loc=<span>None</span>,  <span># 不显示默认图例</span><br>    size=<span>20</span>,<br>    frameon=<span>False</span>,<br>    ax=ax,<br>    show=<span>False</span><br>)<br><br><span># 为每种细胞类型绘制平滑的外层轮廓</span><br><span>for</span> cell_type <span>in</span> adata.obs[<span>"self_annotation"</span>].unique():<br>    <span># 获取对应细胞类型的UMAP坐标</span><br>    mask = adata.obs[<span>"self_annotation"</span>] == cell_type<br>    x = adata.obsm[<span>"X_umap"</span>][mask, <span>0</span>]<br>    y = adata.obsm[<span>"X_umap"</span>][mask, <span>1</span>]<br>    <br>    <span># 创建网格</span><br>    x_min, x_max = x.min() - <span>0.5</span>, x.max() + <span>0.5</span><br>    y_min, y_max = y.min() - <span>0.5</span>, y.max() + <span>0.5</span><br>    xx, yy = np.mgrid[x_min:x_max:<span>100j</span>, y_min:y_max:<span>100j</span>]<br>    <br>    <span># 准备数据</span><br>    xy_train = np.vstack([x, y]).T<br>    xy_test = np.vstack([xx.ravel(), yy.ravel()]).T<br>    <br>    <span># 使用核密度估计</span><br>    kde = KernelDensity(bandwidth=<span>0.3</span>, metric=<span>'euclidean'</span>)<br>    kde.fit(xy_train)<br>    <br>    <span># 计算密度</span><br>    Z = np.exp(kde.score_samples(xy_test))<br>    Z = Z.reshape(xx.shape)<br>    <br>    <span># 绘制闭合轮廓</span><br>    plt.contour(<br>        xx, yy, Z, <br>        levels=[Z.max() * <span>0.1</span>],  <span># 使用最大密度的10%作为轮廓线</span><br>        colors=<span>'gray'</span>,  <span># 轮廓线颜色</span><br>        linestyles=<span>'--'</span>,  <span># 虚线样式</span><br>        linewidths=<span>1.2</span>,  <span># 线宽</span><br>        alpha=<span>0.8</span>  <span># 透明度</span><br>    )<br><br><span># 添加细胞类型的比例信息</span><br>cell_type_counts = adata.obs[<span>"self_annotation"</span>].value_counts(normalize=<span>True</span>) * <span>100</span><br><span>for</span> cell_type, percentage <span>in</span> cell_type_counts.items():<br>    mask = adata.obs[<span>"self_annotation"</span>] == cell_type<br>    x = np.median(adata.obsm[<span>"X_umap"</span>][mask, <span>0</span>])<br>    y = np.median(adata.obsm[<span>"X_umap"</span>][mask, <span>1</span>])<br>    ax.text(<br>        x, y, <span>f"<span>{cell_type}</span> (<span>{percentage:<span>.1</span>f}</span>%)"</span>,<br>        fontsize=<span>10</span>, <br>        ha=<span>"center"</span>, <br>        color=<span>"black"</span>,<br>        bbox=dict(facecolor=<span>'white'</span>, edgecolor=<span>'none'</span>, alpha=<span>0.7</span>)  <span># 可选：添加白色背景</span><br>    )<br><br><span># 设置标题</span><br>ax.set_title(<span>f"Overall (n = <span>{adata.n_obs}</span>)"</span>, fontsize=<span>14</span>)<br><br><span># 调整布局</span><br>plt.tight_layout()<br><br><span># 显示图形</span><br>plt.show()<br><br></code></pre><figure data-tool="mdnice编辑器"><br></figure></section><p><img data-imgfileid="100013095" data-ratio="0.7468354430379747" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHqk1bVjtqTicXzJZtd0jcqFJpNh0mQGHg7rGVcIafkMzBj4S3F3DcPgF0me3q63lZsa0IQFDPFR5eA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="790" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHqk1bVjtqTicXzJZtd0jcqFJpNh0mQGHg7rGVcIafkMzBj4S3F3DcPgF0me3q63lZsa0IQFDPFR5eA/640?wx_fmt=png&amp;from=appmsg"></p><section><br></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/khZcenKgzoPiyjYF_3RJ3Q",target="_blank" rel="noopener noreferrer">原文链接</a>
