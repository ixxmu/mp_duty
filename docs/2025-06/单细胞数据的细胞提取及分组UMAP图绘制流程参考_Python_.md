---
title: "单细胞数据的细胞提取及分组UMAP图绘制流程参考(Python)"
date: 2025-06-29T13:13:20Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
单细胞数据的细胞提取及分组UMAP图绘制流程参考(Python) by 生信方舟
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><section><span leaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="生信方舟" data-alias="shengxinfangzhou" data-from="0" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGfe15Xm0WHdoAMNGvE93bmxaF9iabfPiaO9ic6Tmd8XW1PMiaeuqicSFhCLQJibAUhHsamS1LbaJMFiaZXA/0?wx_fmt=png" data-signature="热爱医学和数据科学，站在巨人的肩膀上，学习和整理相关的知识。" data-id="MzkwMjYyMDA1OA==" data-service_type="1" data-verify_status="0"></mp-common-profile></span></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">在进行个性化探索的时候尝需要提取数据进行分组探索，以下就是一个简单流程。</span></p><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.导入</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">import matplotlib.pyplot as plt</span><span leaf=""><br></span><span leaf="">import seaborn as sns</span><span leaf=""><br></span><span leaf="">import pandas as pd</span><span leaf=""><br></span><span leaf="">import scanpy as sc</span><span leaf=""><br></span><span leaf="">import numpy as np</span><span leaf=""><br></span><span leaf="">import anndata as ad</span><span leaf=""><br></span><span leaf="">import pooch</span><span leaf=""><br></span><span leaf="">import os</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 确定位置</span></span><span leaf=""><br></span><span leaf="">os.getcwd()</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">2.读取位置</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 读取数据</span></span><span leaf=""><br></span><span leaf="">adata = sc.read_h5ad(</span><span><span leaf="">'./scRNA_V5.h5ad'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.obs</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100004919" data-ratio="0.5469083155650319" data-type="png" data-w="938" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVH2GD4icKV1Y5t6weJh6NicsiaBWLZCspCgmRmRgytNp7w3KwF980T9riaDA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVH2GD4icKV1Y5t6weJh6NicsiaBWLZCspCgmRmRgytNp7w3KwF980T9riaDA/640?wx_fmt=png&amp;from=appmsg"></span></figure><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 展示一下该数据集</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># PCA</span></span><span leaf=""><br></span><span leaf="">sc.tl.pca(adata)</span><span leaf=""><br></span><span><span leaf=""># Harmony 整合</span></span><span leaf=""><br></span><span leaf="">sce.pp.harmony_integrate(adata, </span><span><span leaf="">'orig.ident'</span></span><span leaf="">)  </span><span><span leaf=""># 或 'sample'</span></span><span leaf=""><br></span><span><span leaf=""># 构建邻接图</span></span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(adata, use_rep=</span><span><span leaf="">'X_pca_harmony'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 然后再运行 UMAP</span></span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata)</span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sc.pl.umap(</span><span leaf=""><br></span><span leaf="">    adata,                          </span><span><span leaf=""># AnnData 对象</span></span><span leaf=""><br></span><span leaf="">    color=</span><span><span leaf="">"celltype"</span></span><span leaf="">,              </span><span><span leaf=""># 按 celltype 分组上色</span></span><span leaf=""><br></span><span leaf="">    size=</span><span><span leaf="">0.8</span></span><span leaf="">,                      </span><span><span leaf=""># 点大小，类似 pt.size</span></span><span leaf=""><br></span><span leaf="">    legend_loc=</span><span><span leaf="">'right margin'</span></span><span leaf="">,          </span><span><span leaf=""># 在图上显示标签，等价于 label = TRUE</span></span><span leaf=""><br></span><span leaf="">    ncols=</span><span><span leaf="">2</span></span><span leaf="">,                       </span><span><span leaf=""># 控制子图排列列数</span></span><span leaf=""><br></span><span leaf="">    title=None,                    </span><span><span leaf=""># 可选：不显示默认标题</span></span><span leaf=""><br></span><span leaf="">    show =False</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100004918" data-ratio="0.5832147937411095" data-type="png" data-w="703" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVHfPW7hfK7W4HEhicHPoSWkNIKRo4j3IzIHTRHKKdpK09VMGNib4aPoCnw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVHfPW7hfK7W4HEhicHPoSWkNIKRo4j3IzIHTRHKKdpK09VMGNib4aPoCnw/640?wx_fmt=png&amp;from=appmsg"></span></figure><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.obs[</span><span><span leaf="">"celltype"</span></span><span leaf="">].unique()</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-ratio="0.08378088077336197" data-type="png" data-w="931" data-imgfileid="100004916" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVHiateAD82ytiaiaQ3TUyuQGsVqxicwgOxVGZWNvbD0a1LKfXITazgBdfyCw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVHiateAD82ytiaiaQ3TUyuQGsVqxicwgOxVGZWNvbD0a1LKfXITazgBdfyCw/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.模拟肿瘤和非肿瘤数据后进行比较</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">Tgroup = [</span><span><span leaf="">"sample1"</span></span><span leaf="">, </span><span><span leaf="">"sample3"</span></span><span leaf="">, </span><span><span leaf="">"sample5"</span></span><span leaf="">]</span><span leaf=""><br></span><span><span leaf=""># np.where有点像ifelse</span></span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">'type'</span></span><span leaf="">] = np.where(adata.obs[</span><span><span leaf="">'orig.ident'</span></span><span leaf="">].isin(Tgroup), </span><span><span leaf="">'Tumor'</span></span><span leaf="">, </span><span><span leaf="">'Normal'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100004915" data-ratio="0.5966386554621849" data-type="png" data-w="357" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVHOCgFh3wrehKjCibd42uOmSdibMcl3fdtaWnmnR6BxaDhRtALiaRgxCgrg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVHOCgFh3wrehKjCibd42uOmSdibMcl3fdtaWnmnR6BxaDhRtALiaRgxCgrg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">4.提取Tumor 和 Normal相同细胞数</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.obs[</span><span><span leaf="">"type"</span></span><span leaf="">].value_counts()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># type</span></span><span leaf=""><br></span><span><span leaf=""># Tumor     2048</span></span><span leaf=""><br></span><span><span leaf=""># Normal    1983</span></span><span leaf=""><br></span><span><span leaf=""># Name: count, dtype: int64</span></span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 获取 Tumor 和 Control 的索引</span></span><span leaf=""><br></span><span leaf="">tumor_indices = adata.obs.index[adata.obs[</span><span><span leaf="">"type"</span></span><span leaf="">] == </span><span><span leaf="">"Tumor"</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">control_indices = adata.obs.index[adata.obs[</span><span><span leaf="">"type"</span></span><span leaf="">] == </span><span><span leaf="">"Normal"</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 随机选择目标数量个细胞</span></span><span leaf=""><br></span><span leaf="">np.random.seed(</span><span><span leaf="">42</span></span><span leaf="">)  </span><span><span leaf=""># 设置随机种子，以便结果可重复</span></span><span leaf=""><br></span><span leaf="">selected_tumor_indices = np.random.choice(tumor_indices, size=</span><span><span leaf="">1000</span></span><span leaf="">, replace=False)</span><span leaf=""><br></span><span leaf="">selected_control_indices = np.random.choice(control_indices, size=</span><span><span leaf="">1000</span></span><span leaf="">, replace=False)</span><span leaf=""><br></span><span><span leaf="">#从 Tumor 和 Normal 各自中随机选取 1000 个细胞。</span></span><span leaf=""><br></span><span><span leaf="">#replace=False 表示不放回抽样。</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 生成Tumor/Normal的子集</span></span><span leaf=""><br></span><span leaf="">tumor_subset_adata = adata[selected_tumor_indices].copy()</span><span leaf=""><br></span><span leaf="">control_subset_adata = adata[selected_control_indices].copy()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 合并 Tumor 和 Control 子集</span></span><span leaf=""><br></span><span leaf="">combined_adata = tumor_subset_adata.concatenate(control_subset_adata)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 3. 进行 Harmony 处理</span></span><span leaf=""><br></span><span leaf="">sce.pp.harmony_integrate(combined_adata, </span><span><span leaf="">'orig.ident'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 进行邻接图构建和 UMAP 降维</span></span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(combined_adata, n_neighbors=</span><span><span leaf="">20</span></span><span leaf="">, n_pcs=</span><span><span leaf="">15</span></span><span leaf="">, use_rep=</span><span><span leaf="">'X_pca_harmony'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.tl.umap(combined_adata)</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.结果绘制</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 4. 绘制 UMAP 图，两张图分别显示 Tumor 和 Control</span></span><span leaf=""><br></span><span leaf="">fig, axes = plt.subplots(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, figsize=(</span><span><span leaf="">12</span></span><span leaf="">, </span><span><span leaf="">6</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 选择合并后的数据并绘制 Tumor 的 UMAP</span></span><span leaf=""><br></span><span leaf="">tumor_mask = combined_adata.obs[</span><span><span leaf="">'type'</span></span><span leaf="">] == </span><span><span leaf="">'Tumor'</span></span><span leaf=""><br></span><span leaf="">sc.pl.umap(combined_adata[tumor_mask], ax=axes[</span><span><span leaf="">0</span></span><span leaf="">], show=False, title=</span><span><span leaf="">'Tumor UMAP'</span></span><span leaf="">, color=</span><span><span leaf="">'celltype'</span></span><span leaf="">, legend_loc=None)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 选择合并后的数据并绘制 Control 的 UMAP</span></span><span leaf=""><br></span><span leaf="">control_mask = combined_adata.obs[</span><span><span leaf="">'type'</span></span><span leaf="">] == </span><span><span leaf="">'Normal'</span></span><span leaf=""><br></span><span leaf="">sc.pl.umap(combined_adata[control_mask], ax=axes[</span><span><span leaf="">1</span></span><span leaf="">], show=False, title=</span><span><span leaf="">'Normal UMAP'</span></span><span leaf="">, color=</span><span><span leaf="">'celltype'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 遍历所有文本对象，调节字体大小</span></span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> ax </span><span><span leaf="">in</span></span><span leaf=""> fig.axes:</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 调整 x 轴标签</span></span><span leaf=""><br></span><span leaf="">    ax.tick_params(axis=</span><span><span leaf="">'x'</span></span><span leaf="">, labelsize=</span><span><span leaf="">12</span></span><span leaf="">, rotation=</span><span><span leaf="">45</span></span><span leaf="">)  </span><span><span leaf=""># X轴字体大小+旋转</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 调整 y 轴标签</span></span><span leaf=""><br></span><span leaf="">    ax.tick_params(axis=</span><span><span leaf="">'y'</span></span><span leaf="">, labelsize=</span><span><span leaf="">12</span></span><span leaf="">)               </span><span><span leaf=""># Y轴字体大小</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 如果需要，可以加轴标题字体大小</span></span><span leaf=""><br></span><span leaf="">    ax.xaxis.label.set_size(</span><span><span leaf="">14</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    ax.yaxis.label.set_size(</span><span><span leaf="">14</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 可以设置更具体的标题字体</span></span><span leaf=""><br></span><span leaf="">    ax.title.set_fontsize(</span><span><span leaf="">16</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">plt.savefig(</span><span><span leaf="">"umapPlot_sub.pdf"</span></span><span leaf="">,bbox_inches=</span><span><span leaf="">'tight'</span></span><span leaf="">,dpi=</span><span><span leaf="">300</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">plt.show()</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100004917" data-ratio="0.45380710659898477" data-type="png" data-w="985" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVHXH3VOJKHOJ7zgeeVGVylicbv2wBgQtnbsABayBl1JjLQd9yts2yGMicQ/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyFPibtuLtXQdw7dZvJXQujVHXH3VOJKHOJ7zgeeVGVylicbv2wBgQtnbsABayBl1JjLQd9yts2yGMicQ/640?wx_fmt=png&amp;from=appmsg"></span></figure></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><figure data-tool="mdnice编辑器"><span leaf=""><br></span></figure><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><strong><span leaf=""><span textstyle="">注</span></span></strong><span leaf=""><span textstyle="">：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。更多相关内容可关注公众号：</span></span><strong><span leaf=""><span textstyle="">生信方舟</span></span></strong><span leaf=""><span textstyle=""> 。</span></span></p><h2 data-tool="mdnice编辑器"><span></span><span></span><span><span leaf="">结尾</span></span><span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">欢迎加入"</span></span><strong><span leaf=""><span textstyle="">生信&amp;临床</span></span></strong><span leaf=""><span textstyle="">“交流群，若有意向进群的小伙伴请加微信：</span></span><strong><span leaf=""><span textstyle="">couqiliugeziba321</span></span></strong><span leaf=""><span textstyle="">，请注明“</span></span><strong><span leaf=""><span textstyle="">单位或学校-专业或方向-姓名或昵称</span></span></strong><span leaf=""><span textstyle="">”。希望进群的你收获知识的同时也能够收获快乐~ 🤗</span><img data-imgfileid="100004857" data-ratio="0.5625" data-type="jpeg" data-w="720" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/0SOG4MpDAyGHBmXVUqkHD93kSXqreoiaJCE8Dqgoo5icEaOOkaoO6WBVHAibwCYWM1E6rodTMyJ76qc3ZibeakWg7g/640?wx_fmt=jpeg&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/0SOG4MpDAyGHBmXVUqkHD93kSXqreoiaJCE8Dqgoo5icEaOOkaoO6WBVHAibwCYWM1E6rodTMyJ76qc3ZibeakWg7g/640?wx_fmt=jpeg&amp;from=appmsg"></span></p></section></section></section><section><span><span leaf="">- END -</span></span></section></section></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/U03I5JOYqfY9x_AJ_jKCiQ",target="_blank" rel="noopener noreferrer">原文链接</a>
