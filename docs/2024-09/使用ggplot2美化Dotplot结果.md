---
title: "使用ggplot2美化Dotplot结果"
date: 2024-09-18T02:08:00Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
使用ggplot2美化Dotplot结果 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>前情提要</span><span></span></h3><p data-tool="mdnice编辑器">上期推文给大家分享了<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247525311&amp;idx=1&amp;sn=e5bcd6d2ce0edb630daf842b406b97c6&amp;scene=21#wechat_redirect" data-linktype="2">Dotplot可视化细节之如何计算百分比和表达量平均值</a>，里面整理了<strong>关于Dotplot结果图上<code>Average Expressed以及Percent Expressed</code>的计算方式，以及Dotplot的常用参数</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041686" data-ratio="1.268018018018018" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2ia89lFibjRicVGPceTBgNEia6BC9HncwvtnBNtL04PWcjmicVdcwe6mSlGA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="444" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2ia89lFibjRicVGPceTBgNEia6BC9HncwvtnBNtL04PWcjmicVdcwe6mSlGA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">并且基于pbmc3k的数据，使用Dotplot进行可视化和简单调整。这期一起来了解一下，<strong>使用Dotplot参数调整美化结果，以及基于ggplot2进行可视化</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041687" data-ratio="0.8009259259259259" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH20d4aKrUJzyicXjJGszGNjbKPkKX6b3xUM6VpagGW9iccuzcG3aM1qKZA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH20d4aKrUJzyicXjJGszGNjbKPkKX6b3xUM6VpagGW9iccuzcG3aM1qKZA/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>Dotplot可视化及美化</span><span></span></h3><p data-tool="mdnice编辑器">示例数据为pbmc-3k的注释分群后的数据，使用<code>FindAllMarkers</code>查找并获取<strong>top5的Marker基因</strong>进行可视化</p><pre data-tool="mdnice编辑器"><span></span><code><span>#top5 marker基因获取</span><br><br>pbmc.markers &lt;- FindAllMarkers(pbmc, only.pos = TRUE, min.pct = 0.25,  logfc.threshold = 0.25, verbose = FALSE)<br><br>top5 = pbmc.markers %&gt;% group_by(cluster) %&gt;% top_n(n = 5, wt = avg_log2FC)<br><br>g = unique(top5<span>$gene</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>默认参数绘图及调整美化</span><span></span></h3><p data-tool="mdnice编辑器">如果<strong>直接使用默认参数，不调节参数展示的情况</strong></p><pre data-tool="mdnice编辑器"><span></span><code>DotPlot(pbmc, features = g)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041684" data-ratio="0.8212962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH27n9RGuwCa2tOyMKq02gXLa3EfSUOqL7n60BboVNkEBLQ3f5a0MV9EQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH27n9RGuwCa2tOyMKq02gXLa3EfSUOqL7n60BboVNkEBLQ3f5a0MV9EQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">可以看到<strong>横坐标中features展示列全部挤在了一起，不便于阅读</strong>。因为Dotplot绘图是基于ggplot2的语法结构的，所以可以<strong>调用ggplot2包里面的函数去倾斜展示基因，或者将基因和细胞亚群调换位置</strong>的方式进行调整</p><h4 data-tool="mdnice编辑器"><span></span><span>1. 调节features的排列角度</span><span></span></h4><p data-tool="mdnice编辑器"><strong>使用<code>RotatedAxis()</code>函数将坐标轴标签旋转</strong>，让features列展示的基因，由最开始的平铺变为倾斜，方便阅读</p><pre data-tool="mdnice编辑器"><span></span><code>DotPlot(pbmc, features = g) + RotatedAxis()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041685" data-ratio="0.7972222222222223" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2hiaggfAq3aX6DrpMxj0IiajdPF5yxSXpbvnIGSqMD33xAOzCUPWEPfLA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2hiaggfAq3aX6DrpMxj0IiajdPF5yxSXpbvnIGSqMD33xAOzCUPWEPfLA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">不过<code>RotatedAxis()</code>函数里面角度是确定了的，如果需要<strong>根据自己的需求调整角度可以使用<code>theme()函数</code>来调整x轴的具体倾斜角度</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041683" data-ratio="0.2490740740740741" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2tfrTwYMoMd9Fqfn59WZz9omsVdazblArIo8hwbXNaycs6ejucibyZzA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2tfrTwYMoMd9Fqfn59WZz9omsVdazblArIo8hwbXNaycs6ejucibyZzA/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>DotPlot(pbmc, features = g) + <br>  theme(axis.text.x=element_text(angle=70,hjust = 1))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041690" data-ratio="0.6907407407407408" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH272uanfhicibjyFA7C0siclxo3hnBEaOWpficAgQBIfMUicC5iaaiakxXhAw7w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH272uanfhicibjyFA7C0siclxo3hnBEaOWpficAgQBIfMUicC5iaaiakxXhAw7w/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>2.将features和identity调换位置</strong></p><ul data-tool="mdnice编辑器"><li><section>使用<code>coord_flip()函数</code>翻转坐标轴，使得图形的布局更加合理。</section></li><li><section>使用<code>RotatedAxis()函数</code>旋转坐标轴标签，以便更好地展示和阅读。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>DotPlot(pbmc, features = g) + coord_flip()+ RotatedAxis()<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041688" data-ratio="0.8009259259259259" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2lVUFdfXX8azY2rJ4LhibzMhnibYnDqt78YYxxcXleVNgesCWPCX7uIDw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2lVUFdfXX8azY2rJ4LhibzMhnibYnDqt78YYxxcXleVNgesCWPCX7uIDw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>3. 分组展示Marker基因</strong></p><ul data-tool="mdnice编辑器"><li><section>使用<code>split函数</code>按照基因列表以及分类列表进行分组，Marker基因将根据它们所属的群组（cluster）被分组显示。</section></li><li><section>基于<code>cols函数</code>指定点图的颜色</section></li><li><section>使用<code>RotatedAxis函数</code>将x轴标签旋转</section></li><li><section>基于theme函数去调整坐标轴，设置文本颜色和大小、添加边框、调整间距等</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code>DotPlot(pbmc,<br>        features = split(top5<span>$gene</span>, top5<span>$cluster</span>),<br>        cols = c(<span>"#ffffff"</span>, <span>"firebrick3"</span>)<br>) +<br>  RotatedAxis() + <br>  theme(<br>    strip.text.x = element_text(size = 8),<br>    axis.text.x  = element_text(color=<span>"black"</span>,size=10),<br>    panel.border = element_rect(color = <span>"black"</span>),<br>    panel.spacing = unit(1, <span>"mm"</span>),<br>    axis.title = element_blank(),<br>    axis.text.y = element_blank(),<br>  )<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041691" data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2aM7XVClcMibLhPGULMHPhc1dDVb7DmkiatFjsvaWSbHYfpQToAz2x3EQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2aM7XVClcMibLhPGULMHPhc1dDVb7DmkiatFjsvaWSbHYfpQToAz2x3EQ/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>使用ggplot2绘图及美化</span><span></span></h3><p data-tool="mdnice编辑器">已经<strong>有很多推文基于ggplot2去可视化及美化点图：</strong></p><ul data-tool="mdnice编辑器"><li><section>比如咱们<code>生信菜鸟团</code>的<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247512727&amp;idx=1&amp;sn=37494651eed7cd694b4449d332bc6392&amp;scene=21#wechat_redirect" data-linktype="2">Dotplot美化</a>——使用ggplot2基于结果美化</section></li><li><section><code>生信益站</code>的<a href="https://mp.weixin.qq.com/s?__biz=MzU1NTk0MTUxMg==&amp;mid=2247501277&amp;idx=3&amp;sn=823772e89b7fac647870e4601ff06ac1&amp;scene=21#wechat_redirect" data-linktype="2">Seurat::DotPlot美化 (二) ——细胞亚群坐标轴Color Bar注释</a></section></li></ul><p data-tool="mdnice编辑器">那这边小谢就偷个懒，<strong>基于前辈们整理好的代码来使用ggplot2绘制marker基因的点图。</strong></p><h4 data-tool="mdnice编辑器"><span></span><span>1. 提取数据并整理细胞亚群排序</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#获取需要的数据</span><br>p &lt;- DotPlot(pbmc,<br>             features = split(top5<span>$gene</span>, top5<span>$cluster</span>),<br>             cols = c(<span>"#ffffff"</span>, <span>"firebrick3"</span>)) <br><br><span>#重新整理细胞亚群的排列，倒序排列</span><br>p<span>$data</span><span>$feature</span>.groups2 &lt;- factor(p<span>$data</span><span>$feature</span>.groups, <br>                                 levels = c(<span>"Platelet"</span>,<span>"DC"</span>,<span>"NK"</span>,<br>                                            <span>"FCGR3A+ Mono"</span>,<span>"CD8 T"</span>,<span>"B"</span>,<br>                                            <span>"Memory CD4 T"</span>,<span>"CD14+ Mono"</span>,<span>"Naive CD4 T"</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041689" data-ratio="0.6037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH26dbLOOlP8qsM7WGRTTE0Hj5EbTGeVf2fjNsB3IAomENT9kQkIoGt5Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH26dbLOOlP8qsM7WGRTTE0Hj5EbTGeVf2fjNsB3IAomENT9kQkIoGt5Q/640?wx_fmt=png&amp;from=appmsg"><figcaption>p</figcaption></figure><figure data-tool="mdnice编辑器"><img data-imgfileid="100041692" data-ratio="1.1157407407407407" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2S6uLVu2umZwyV1AYpIMXG51U69umI3WNdkJzd6doVgNp23CgOSict6w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2S6uLVu2umZwyV1AYpIMXG51U69umI3WNdkJzd6doVgNp23CgOSict6w/640?wx_fmt=png&amp;from=appmsg"><figcaption>p$data</figcaption></figure><h4 data-tool="mdnice编辑器"><span></span><span>2. 使用ggplot2绘图</span><span></span></h4><p data-tool="mdnice编辑器">ggplot2绘图相关的内容是需要反复练习的，如果没有R语言基础想要系统学习的话，可以了解一下<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533462&amp;idx=1&amp;sn=db7335a759233b4cea8b56c394e4171e&amp;scene=21#wechat_redirect" data-linktype="2">生物信息学马拉松授课</a>,最近一期在广州线下，欢迎大家来广州相聚！</p><pre data-tool="mdnice编辑器"><span></span><code><span>## 加载R包定义图例颜色----</span><br>library(ggh4x)<br>library(RColorBrewer)<br><br>strip &lt;- strip_themed(<br>  background_x = elem_list_rect(fill = brewer.pal(9, <span>"Paired"</span>)))<br><br><span>## 可视化----</span><br>p1 &lt;- p<span>$data</span> %&gt;% <br>  ggplot(aes(x = features.plot,<br>             y = id)) + <br>  geom_point(aes(size = pct.exp, <br>                 color = avg.exp.scaled)) + <br>  facet_wrap2(~feature.groups2, <br>              scales = <span>"free_x"</span>, <br>              strip = strip, <br>              nrow = 1) + <br>  theme_classic() + <br>  RotatedAxis()+<br>  theme(strip.text.x = element_text(size = 8),<br>        axis.text.x = element_text(color=<span>"black"</span>,size=10),<br>        axis.title = element_blank(),<br>        strip.background = element_rect(color = <span>"white"</span>),<br>        axis.text.y = element_blank()) + <br>  scale_color_gradient(low = <span>"#ffffff"</span>,<br>                       high = <span>"firebrick3"</span>, <br>                       name = <span>"avg.exp"</span>)<br><br>p1<br></code></pre><p data-tool="mdnice编辑器">这样就得到了带有背景颜色图例的结果，为了简洁将左边的细胞亚群标签信息使用<code>axis.text.y = element_blank()</code>不进行展示，当然我们也可以调整之后，将y轴的图例加上</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041696" data-ratio="0.7296296296296296" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2rL70Nd3RBrtpQavW46Ohw9GdXYRnQfScMc3e7g1c7ibZZRmCZFM0zicQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2rL70Nd3RBrtpQavW46Ohw9GdXYRnQfScMc3e7g1c7ibZZRmCZFM0zicQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>3. 整理y轴标签</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>## 图例信息----</span><br>library(ggplot2)<br><br>df &lt;- data.frame(x = 0, y = levels(pbmc), stringsAsFactors = F )<br>df<span>$y</span> &lt;- factor(df<span>$y</span>, levels = df<span>$y</span> )<br><br><span>#通过shape选择自己想要的图例形状</span><br>p2 &lt;- ggplot(df, aes(x, y, color = factor(y))) +<br>  geom_point(size = 6, shape = 18, show.legend = F) +<br>  scale_color_manual(values = rev(brewer.pal(9, <span>"Paired"</span>))) +<br>  theme_classic() +<br>  scale_x_continuous(expand = c(0,0)) +<br>  theme(<br>    plot.margin = margin(r=0),<br>    axis.title = element_blank(),<br>    axis.text.x = element_blank(),<br>    axis.text.y = element_text(size = 9),<br>    axis.ticks = element_blank(),<br>    axis.line = element_blank()<br>  )<br><br>p2<br></code></pre><p data-tool="mdnice编辑器"><strong>选择了shape=18的实心菱形</strong><img data-imgfileid="100041695" data-ratio="2.1954732510288064" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2sdTAGSicNg8Y6zU9EAKnXEsfBpMCakpT1U363RbNFNXteHoEHNoGjEg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="486" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2sdTAGSicNg8Y6zU9EAKnXEsfBpMCakpT1U363RbNFNXteHoEHNoGjEg/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">然后<strong>将整理好的图例和点图拼接到一起即可</strong></p><pre data-tool="mdnice编辑器"><span></span><code>library(cowplot)<br>plot_grid(p2, p1, align = <span>"h"</span>, axis=<span>"bt"</span>, rel_widths = c(1.5, 9))<br><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041697" data-ratio="0.812962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2VryeFeS6LRYdur3xKJhjUBvZZicVsdicUeNwU1NhGQWwslDJXPPpiabWw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS2KdaeY2zM9nQyvjrjPqH2VryeFeS6LRYdur3xKJhjUBvZZicVsdicUeNwU1NhGQWwslDJXPPpiabWw/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>小结</span><span></span></h3><p data-tool="mdnice编辑器">这期<strong>基于ggplot2在Dotplot结果的基础上进行调整，以及提取Dotplot的结果数据，使用ggplot2进行美化和可视化</strong></p><p data-tool="mdnice编辑器">如果你也想做单细胞转录组数据分析，最好是有自己的计算机资源哦，比如我们的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a>，而且还需要有基本的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533462&amp;idx=1&amp;sn=db7335a759233b4cea8b56c394e4171e&amp;scene=21#wechat_redirect" data-linktype="2">生物信息学基础</a>，也可以看看我们的生物信息学马拉松授课，你的生物信息学入门课。</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/rXbm4SQO6tl5hjY_BTI3dQ",target="_blank" rel="noopener noreferrer">原文链接</a>
