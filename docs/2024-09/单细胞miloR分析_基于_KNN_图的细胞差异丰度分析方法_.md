---
title: "单细胞miloR分析(基于 KNN 图的细胞差异丰度分析方法)"
date: 2024-09-29T12:38:13Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
单细胞miloR分析(基于 KNN 图的细胞差异丰度分析方法) by 生信方舟
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">通常情况下，对两组或多组样本进行了不同处理/干预之后，研究者首先会进行同种细胞亚群处理前后的细胞数量的比较，但在单细胞分辨率时代之后，即使是同一个亚群中的不同细胞也应当看成不同的样本。</p><p data-tool="mdnice编辑器">那么问题就来了，既然应当看做是不同的样本，那么干预之后假设同一种细胞亚群中的细胞数量产生了变化，这种变化是否还有借鉴和研究的价值(单从细胞数层面来看)，笔者认为必然是有借鉴和研究的价值的。虽然确实是需要把不同细胞看做是不同类型的样本，但这种差异也还是不能掩盖它们在生物学上作为某一大类细胞的本身属性，而每一个细胞的异质性也应当认为是基于大类细胞的特征之下的子分类。</p><p data-tool="mdnice编辑器">那么还有人可能会钻一下牛角尖，由于细胞亚群定义是基于先验知识，也就是人为的先根据已知的几个重要标记基因去定义细胞亚群，那么假设细胞亚群定义错了会不会导致最后的差异分析结果产生问题呢，这种情况也必然是存在的(主要存在于复杂的细胞亚群)。</p><p data-tool="mdnice编辑器">因此有研究者就提出了miloR这种细胞亚群差异丰度的方法，这种方法有一个非常大的优势在于能够<strong>避免预先定义的聚类依赖性(预先定义的细胞亚群)</strong> 。<img data-imgfileid="100002185" data-ratio="0.6903073286052009" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hv0FKUS2C4fTCEwUZqO5hT5lYq2kDiaVM4kDBA9ewLxrrPjdVro1PTKw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="846" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hv0FKUS2C4fTCEwUZqO5hT5lYq2kDiaVM4kDBA9ewLxrrPjdVro1PTKw/640?wx_fmt=png&amp;from=appmsg">假设我们有一批包含了疾病和正常信息的单细胞测序数据，<strong>miloR先随机定义细胞中的细胞节点(数据点)，然后通过K最近邻法(K-neareat neighbors)去识别所定义节点与周围的其他细胞数据点之间的邻近关系，找到跟这些节点最近的(比如欧几里得法)其他数据点(细胞)</strong> ，将这些具有邻近关系的细胞小群看做不同的群组，此时我们可以想象一下，每个群组中都会存在具有疾病和正常信息的许多细胞，接着再将这些群组中疾病与否的细胞数分别进行比较和汇总，最后可以<strong>得到基于某一大类细胞中内部细胞变化趋势的结果</strong>(比如是否倾向与疾病的方向)。</p><p data-tool="mdnice编辑器">有了这个结果之后，<strong>无论是结合预先定义的细胞分群结果还是后续作为细胞分群结果的参考都有助于使用者更好的去了解疾病与否的不同细胞亚群的变化状态</strong>，因此使用miloR可以有效的作为<strong>单细胞水平上细胞差异分析的补充工具</strong>。</p><h4 data-tool="mdnice编辑器"><span></span><span>分析流程</span><span></span></h4><h5 data-tool="mdnice编辑器"><span></span><span>1.导入</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br>V5_path = <span>"/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/seurat5/"</span><br>.libPaths(V5_path)<br>.libPaths()<br><span>library</span>(stringr)<br><span>library</span>(Seurat)<br><span>library</span>(miloR)<br><span>library</span>(scater)<br><span>library</span>(scran)<br><span>library</span>(dplyr)<br><span>library</span>(patchwork)<br><span>library</span>(qs)<br><span>library</span>(BiocParallel)<br>register(MulticoreParam(workers = <span>4</span>, progressbar = <span>TRUE</span>))<br><br>load(<span>"scRNA.Rdata"</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>2.数据预处理</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 提取两个样本</span><br><span># check</span><br>table(scRNA$orig.ident)<br><span># sample1 sample2 sample3 sample4 sample5 sample6 </span><br><span>#     687     622     683     686     678     675 </span><br>table(scRNA$celltype)<br>     <span># CD4+ T-cells       Fibroblasts           B-cells      CD8+ T-cells       Neutrophils </span><br>     <span>#         1007               762               667               547               378 </span><br>     <span>#    Monocytes        Adipocytes          NK cells Endothelial cells </span><br>     <span>#          311               244                87                28 </span><br>dat &lt;- scRNA@meta.data<br><span># 增加一下批次信息,转换成数字</span><br>dat$batch &lt;- ifelse(grepl(<span>"sample2|sample4|sample6"</span>, dat$orig.ident), <span>"1"</span>, <span>"2"</span>)<br><span># 增加一下分组信息，这里是随意编造的</span><br>dat$group &lt;- ifelse(grepl(<span>"sample[1-3]"</span>, dat$orig.ident), <span>"con"</span>, <span>"treat"</span>)<br>scRNA@meta.data &lt;- dat<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>3.构建miloR对象</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 由于需要输入SingleCellExperiment对象</span><br><span># 因此先进行转化一下</span><br>scRNA_pre &lt;- as.SingleCellExperiment(scRNA_pre)<br><span># 构建miloR对象</span><br>scRNA_pre &lt;- Milo(scRNA_pre)<br>scRNA_pre<br><span># class: Milo </span><br><span># dim: 24357 1309 </span><br><span># metadata(0):</span><br><span># assays(3): counts logcounts scaledata</span><br><span># rownames(24357): AL627309.1 AL627309.3 ... AF127936.2 AF127577.3</span><br><span># rowData names(0):</span><br><span># colnames(1309): AAAGAACAGTCTGTAC-1_1 AAAGGGCTCTCGCGTT-1_1 ...</span><br><span>#   TTTGGAGAGTTCCGGC-1_2 TTTGTTGCAAGTTCGT-1_2</span><br><span># colData names(10): orig.ident nCount_RNA ... celltype ident</span><br><span># reducedDimNames(4): PCA HARMONY UMAP TSNE</span><br><span># mainExpName: RNA</span><br><span># altExpNames(0):</span><br><span># nhoods dimensions(2): 1 1</span><br><span># nhoodCounts dimensions(2): 1 1</span><br><span># nhoodDistances dimension(1): 0</span><br><span># graph names(0):</span><br><span># nhoodIndex names(1): 0</span><br><span># nhoodExpression dimension(2): 1 1</span><br><span># nhoodReducedDim names(0):</span><br><span># nhoodGraph names(0):</span><br><span># nhoodAdjacency dimension(2): 1 1</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>4.构建K最邻图谱</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># d值与降维时选定的pca值一致</span><br><span># k值与FindNeighbors时选定的值一致</span><br>reducedDims(scRNA_pre)<br><span># List of length 4</span><br><span># names(4): PCA HARMONY UMAP TSNE</span><br>scRNA_pre &lt;- buildGraph(scRNA_pre, k = <span>15</span>, d = <span>15</span>,reduced.dim = <span>"PCA"</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>5.在 KNN 图上定义具有代表性的邻域</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 定义数据点的值(Prop)</span><br><span># 对于小于3万细胞的数据集,Prop设为0.1</span><br><span># 对于超过3万细胞的数据集,prop设为0.05。</span><br>scRNA_pre &lt;- makeNhoods(scRNA_pre, prop = <span>0.1</span>, k = <span>15</span>, d = <span>15</span>, <br>                        refined = <span>TRUE</span>, reduced_dims = <span>"PCA"</span>)<br>plotNhoodSizeHist(scRNA_pre)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100002181" data-ratio="0.22182468694096602" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hfoYib2eaZkIo5fI95VBwibdKAaaqlZhh6zniaaIZ7LtFyn6OD4kQeHjXA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="559" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hfoYib2eaZkIo5fI95VBwibdKAaaqlZhh6zniaaIZ7LtFyn6OD4kQeHjXA/640?wx_fmt=png&amp;from=appmsg">这里定义的每个neighbourhood大小是不少于5个细胞/样本(笔者个人理解)<img data-imgfileid="100002182" data-ratio="1.228395061728395" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hek51PZicicXou18xxwLCzwIwQoEFibSTGbS23m5Oobsb8Dq3RiaomRftzA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="648" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hek51PZicicXou18xxwLCzwIwQoEFibSTGbS23m5Oobsb8Dq3RiaomRftzA/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>6.计算neighbourhoods中的细胞</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>scRNA &lt;- countCells(scRNA, <br>                    meta.data = as.data.frame(colData(scRNA)),<br>                    sample=<span>"orig.ident"</span>)<br><br><span># colData(scRNA_pre) 相当于代表了metadata的信息</span><br><span># sample代表了样本数</span><br>head(nhoodCounts(scRNA))<br><span># 这个步骤能够给scRNA_pre数据中增加一个n*m的matrix</span><br><span># n代表不同的neighborhood数量,m代表实验样本</span><br><span># 6 x 6 sparse Matrix of class "dgCMatrix"</span><br><span>#   sample1 sample2 sample3 sample4 sample5 sample6</span><br><span># 1       .      10       .       7      20       9</span><br><span># 2       .      17       .       6       6       4</span><br><span># 3      22       2      50       .       .       1</span><br><span># 4      20       2      18       1       1       7</span><br><span># 5       2       6       6       7       1       5</span><br><span># 6       5       9       3       .       .       5</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>7.实验设计定义</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 笔者这里batch为批次信息</span><br>scRNA_design &lt;- data.frame(colData(scRNA))[,c(<span>"orig.ident"</span>,<span>"group"</span>,<span>"batch"</span>)]<br><br><span>## 将批次信息转换为整数</span><br>scRNA_design$batch &lt;- as.factor(scRNA_design$batch) <br>scRNA_design &lt;- distinct(scRNA_design)<br>rownames(scRNA_design) &lt;- scRNA_design$orig.ident<br><br>scRNA_design<br><span>#         orig.ident group batch</span><br><span># sample1    sample1   con     2</span><br><span># sample2    sample2   con     1</span><br><span># sample3    sample3   con     2</span><br><span># sample4    sample4 treat     1</span><br><span># sample5    sample5 treat     2</span><br><span># sample6    sample6 treat     1</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>8.计算邻里连通性</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># MiloR使用了由cydar引入的空间FDR校正,这一步可以校正邻里之间重叠的p值</span><br>scRNA &lt;- calcNhoodDistance(scRNA, d=<span>15</span>, reduced.dim = <span>"PCA"</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>9.检测结果</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 把批次和分组信息加到design中去</span><br>da_results &lt;- testNhoods(scRNA,design = ~ batch + group, design.df = scRNA_design)<br><br>head(da_results)<br><span>#        logFC   logCPM           F    PValue       FDR Nhood SpatialFDR</span><br><span># 1  3.1406854 12.86784 1.053518712 0.3049667 0.7636565     1  0.9681699</span><br><span># 2  1.5241056 12.40488 0.463991996 0.4959349 0.9371039     2  0.9681699</span><br><span># 3 -3.9628982 12.75593 1.284826869 0.2572975 0.7258632     3  0.9681699</span><br><span># 4 -1.0256918 12.35456 0.131264086 0.7172078 0.9382545     4  0.9681699</span><br><span># 5 -0.1763181 12.06026 0.008314397 0.9273667 0.9649626     5  0.9681699</span><br><span># 6 -2.5291223 11.67320 1.547069145 0.2138841 0.6816075     6  0.9681699</span><br><br>da_results %&gt;%<br>  arrange(SpatialFDR) %&gt;%<br>  head() <br><br>ggplot(da_results, aes(PValue)) + geom_histogram(bins=<span>50</span>)<br><br>ggplot(da_results, aes(logFC, -log10(SpatialFDR))) + <br>  geom_point() +<br>  geom_hline(yintercept = <span>1</span>) <span>## Mark significance threshold (10% FDR)</span><br></code></pre><p data-tool="mdnice编辑器">P-value 直方图：展示了 P 值的分布。通常，在差异丰度测试（例如 MiloR）中，P 值可以衡量每个邻域的统计显著性。如果一个 P 值接近 0，意味着该邻域在两个条件之间有显著差异。从图中可以看出，P 值接近 0 的邻域数量最多，但 P 值分布相对均匀。这表明大多数邻域没有很强的统计显著性，少数邻域具有较低的 P 值（即显著差异）<img data-imgfileid="100002183" data-ratio="1.228395061728395" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6h7CopCjWFODHhIR7F8qWbtG9WFWEApvrA4hLk1pBweNDprRm0c91cHA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="648" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6h7CopCjWFODHhIR7F8qWbtG9WFWEApvrA4hLk1pBweNDprRm0c91cHA/640?wx_fmt=png&amp;from=appmsg">logFC vs -log10(SpatialFDR) 散点图：一个火山图样式的散点图，x 轴是 logFC，y 轴是 -log10(SpatialFDR)。logFC 表示对数折叠变化，用来表示不同分组（如 treat 和 con）中某个邻域的相对丰度变化。正值表示该邻域在 treatment 组中富集，负值表示在 control 组中富集。SpatialFDR 是经过空间校正的FDR。通过绘制 -log10(SpatialFDR)，该值越高，显著性越强（因为 FDR 越小）。绝大多数点都位于 y 轴较低的地方，表明这些邻域的 SpatialFDR 值较高（即不显著）。换句话说，测试发现的差异邻域很少，表明数据中没有强烈的差异丰度信号。<img data-imgfileid="100002184" data-ratio="1.228395061728395" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hIZVJvDH4RjPq3YbQSias1J5TicBDNsFsk0TzuPzjyN05TRvDpDHBsoHQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="648" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hIZVJvDH4RjPq3YbQSias1J5TicBDNsFsk0TzuPzjyN05TRvDpDHBsoHQ/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>10.可视化</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>scRNA &lt;- buildNhoodGraph(scRNA)<br><br><span>## Plot single-cell UMAP</span><br>umap_pl &lt;- plotReducedDim(scRNA, dimred = <span>"UMAP"</span>, <br>                          colour_by=<span>"group"</span>, text_by = <span>"celltype"</span>, <br>                          text_size = <span>3</span>, point_size=<span>0.5</span>) + guides(fill=<span>"none"</span>)<br>umap_pl<br><br><span>## Plot neighbourhood graph</span><br>nh_graph_pl &lt;- plotNhoodGraphDA(scRNA, da_results,<br>                                layout=<span>"UMAP"</span>,alpha=<span>0.9</span>)  <span>#alpha默认0.1</span><br>  <br>umap_pl + nh_graph_pl +<br>plot_layout(guides=<span>"collect"</span>)<br></code></pre><p data-tool="mdnice编辑器">UMAP 图（左图）：显示了不同细胞类型在两个实验组之间的分布。图中使用了两种颜色，蓝色（con） 和 橙色（treat），分别代表对照组和处理组。不同的细胞类型被明确标注（如 Fibroblasts、B-cells、Monocytes 等），并且可以看到处理组（橙色）和对照组（蓝色）之间的细胞分布。</p><p data-tool="mdnice编辑器">邻域网络图（右图）：右边的图是基于 MiloR 分析的邻域图。每个圈代表一个邻域（Nhood），邻域的大小与其中细胞的数量成比例。颜色梯度（从蓝色到红色）表示了 logFC（对数折叠变化）：正的 logFC（蓝色）意味着该邻域中的细胞在对照组中富集，负的 logFC（红色）则表明该邻域中的细胞在处理组中富集。邻域之间的连线表示邻域之间的相似性或重叠，线条的厚度表示邻域之间的重叠度（overlap size），越厚的线表示两个邻域之间的细胞更为相似。<img data-imgfileid="100002188" data-ratio="0.6094117647058823" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6h8iawDfVqmBjXlUicGTO2o4pp2a6ic1wzmmk9Q3uM4Djfe2VgqSQqNn5jQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="850" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6h8iawDfVqmBjXlUicGTO2o4pp2a6ic1wzmmk9Q3uM4Djfe2VgqSQqNn5jQ/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>11.数据注释</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>da_results &lt;- annotateNhoods(scRNA, <br>                             da_results, <br>                             coldata_col = <span>"celltype"</span>)<br>head(da_results)<br><span>#        logFC   logCPM           F    PValue       FDR Nhood SpatialFDR     celltype celltype_fraction</span><br><span># 1  3.1406854 12.86784 1.053518712 0.3049667 0.7636565     1  0.9681699  Neutrophils         1.0000000</span><br><span># 2  1.5241056 12.40488 0.463991996 0.4959349 0.9371039     2  0.9681699     NK cells         1.0000000</span><br><span># 3 -3.9628982 12.75593 1.284826869 0.2572975 0.7258632     3  0.9681699 CD4+ T-cells         1.0000000</span><br><span># 4 -1.0256918 12.35456 0.131264086 0.7172078 0.9382545     4  0.9681699 CD4+ T-cells         1.0000000</span><br><span># 5 -0.1763181 12.06026 0.008314397 0.9273667 0.9649626     5  0.9681699    Monocytes         1.0000000</span><br><span># 6 -2.5291223 11.67320 1.547069145 0.2138841 0.6816075     6  0.9681699 CD4+ T-cells         0.9545455</span><br><br>ggplot(da_results, aes(celltype_fraction)) + geom_histogram(bins=<span>50</span>)<br><br>str(da_results)<br>table(da_results$celltype)<br>range(da_results$SpatialFDR)<br>plotDAbeeswarm(da_results, group.by = <span>"celltype"</span>,alpha = <span>0.9</span>) <span># alpha默认0.1</span><br></code></pre><p data-tool="mdnice编辑器">celltype_fraction 直方图：展示了邻域中某种特定细胞类型的比例分布（celltype_fraction）。Y轴代表邻域的数量，X轴表示邻域中细胞类型所占的比例（范围从0到1）。大部分邻域的细胞类型比例接近1，说明大多数邻域是单一细胞类型主导的。大多数邻域由某一类型的细胞主导（celltype_fraction 为 1）。这意味着邻域中的细胞几乎都是同一种类型，没有明显的混合细胞类型。这种结果通常出现在较为纯净的细胞群或具有显著分离特征的细胞亚群。<img data-imgfileid="100002186" data-ratio="0.8743093922651933" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hykQTTbbNjlCCurXKElYoao5tXxOAEEa97EWXNCFDj3mfrzGJImBia7g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="724" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hykQTTbbNjlCCurXKElYoao5tXxOAEEa97EWXNCFDj3mfrzGJImBia7g/640?wx_fmt=png&amp;from=appmsg">logFC 与细胞类型关联的 beeswarm 图：展示了不同细胞类型的 Log Fold Change（logFC）在不同邻域中的分布。Y轴表示细胞类型，X轴表示logFC（即不同处理组之间在邻域中的差异丰度变化）。每个点代表一个邻域，其中不同的颜色代表不同的显著性水平（根据FDR或p值筛选）。每个细胞类型的点代表其在不同邻域中的表现。图中logFC值分布较为广泛的细胞类型，如Fibroblasts和CD8+ T-cells，在不同处理组间表现出显著的差异丰度变化。而某些细胞类型，如Endothelial cells，可能在各组间差异较小。logFC较大的值（例如正向logFC较大）表明在“treat”组中这些邻域的丰度较高。(笔者的示例数据没有很大差异)<img data-imgfileid="100002190" data-ratio="0.8743093922651933" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hPmE6PmqOw5CXnTo5f1Nyj5chkotSNzlzZrEugASqCEyRl95VaHG5rA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="724" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hPmE6PmqOw5CXnTo5f1Nyj5chkotSNzlzZrEugASqCEyRl95VaHG5rA/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>12.找到DA群体的marker</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span>## Add log normalized count to Milo object</span><br>scRNA &lt;- logNormCounts(scRNA)<br><br><span># alpha默认0.1,所以SpatialFDR &lt; 0.9是修改过的</span><br>da_results$NhoodGroup &lt;- as.numeric(da_results$SpatialFDR &lt; <span>0.9</span> &amp; da_results$logFC &lt; <span>0</span>)<br>da_nhood_markers &lt;- findNhoodGroupMarkers(scRNA, da_results, <br>                                          subset.row = rownames(scRNA), <br>                                          aggregate.samples = <span>TRUE</span>, <span># 建议设置为TRUE</span><br>                                          sample_col = <span>"orig.ident"</span>)<br>head(da_nhood_markers)<br><span>#       GeneID       logFC_0 adj.P.Val_0       logFC_1 adj.P.Val_1</span><br><span># 1 AL627309.1 -0.0007221833   0.9413661  0.0007221833   0.9413661</span><br><span># 2 AL627309.3 -0.0001256128   0.9413661  0.0001256128   0.9413661</span><br><span># 3 AL645608.1 -0.0156444426   0.2788002  0.0156444426   0.2788002</span><br><span># 4 AL669831.5  0.0100744381   0.9413661 -0.0100744381   0.9413661</span><br><span># 5     FAM41C  0.0076732647   0.9413661 -0.0076732647   0.9413661</span><br><span># 6     FAM87B -0.0056002509   0.3247399  0.0056002509   0.3247399</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>12.1.自动对邻域进行分组</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span>#在许多情况下，DA邻域位于KNN图的不同区域，将所有重要的 DA 群体分组在一起可能并不理想,因为它们可能包括非常不同细胞类型的细胞。</span><br><span># 对于这种场景,开发者用了一个邻里函数,它使用社区检测根据(1)两个邻域之间共享的小区数量将邻域划分为组;(2)DA 社区的倍数变化方向;(3)折叠变化的差异。</span><br><br><span>## Run buildNhoodGraph to store nhood adjacency matrix</span><br>scRNA &lt;- buildNhoodGraph(scRNA)<br><br><span>## Find groups</span><br>da_results &lt;- groupNhoods(scRNA, da_results, <br>                          max.lfc.delta = <span>2</span>,da.fdr = <span>0.9</span>)<span>#da.fdr默认0，1</span><br>head(da_results)<br><br>plotNhoodGroups(scRNA, da_results, layout=<span>"UMAP"</span>) <br>plotDAbeeswarm(da_results, <span>"NhoodGroup"</span>,alpha = <span>0.9</span>) <span>#alpha默认是0.1</span><br></code></pre><p data-tool="mdnice编辑器">这个步骤是按照DA的结果进行自动划分簇，还可以找到差异基因。max.lfc.delta这个值可以自行修改！ 正式分析的时候需要探索。<img data-imgfileid="100002187" data-ratio="0.8743093922651933" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hkUXEibMkxfiauwbNVvrdicATGpLxRUn8ibCKV2gh8S1bjbD2FaBmc0JK5g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="724" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hkUXEibMkxfiauwbNVvrdicATGpLxRUn8ibCKV2gh8S1bjbD2FaBmc0JK5g/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100002189" data-ratio="0.8743093922651933" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hhy8sOeOZVTd5BrpRliahxqUKtMh63lEOGwbChWvyaqqV8Z5icXJrPNtA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="724" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hhy8sOeOZVTd5BrpRliahxqUKtMh63lEOGwbChWvyaqqV8Z5icXJrPNtA/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>12.2 找到特征基因</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span>## Exclude zero counts genes</span><br>keep.rows &lt;- rowSums(logcounts(scRNA)) != <span>0</span><br>scRNA &lt;- scRNA[keep.rows, ]<br><br><span>## Find HVGs</span><br>dec &lt;- modelGeneVar(scRNA)<br>hvgs &lt;- getTopHVGs(dec, n=<span>2000</span>)<br>head(hvgs)<br><span># [1] "CFD"    "DCN"    "MGP"    "CXCL8"  "MT2A"   "S100A9"</span><br><br><span># 找到每个邻里群的one-vs-all差异基因表达</span><br>nhood_markers &lt;- findNhoodGroupMarkers(scRNA, da_results, subset.row = hvgs, <br>                                       aggregate.samples = <span>TRUE</span>, sample_col = <span>"orig.ident"</span>)<br><br>head(nhood_markers)[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br><span>#   GeneID     logFC_1 adj.P.Val_1     logFC_2</span><br><span># 1    A2M -0.43376837  0.35815985 -0.43132559</span><br><span># 2   AAK1 -0.55965379  0.03462636  0.74914069</span><br><span># 3  ABCA1  0.20200482  0.46368550 -0.31103802</span><br><span># 4 ABCA10 -0.08910405  0.50766539 -0.09984058</span><br><br><span># 找到group2的差异基因</span><br>gr2_markers &lt;- nhood_markers[c(<span>"logFC_2"</span>, <span>"adj.P.Val_2"</span>)] <br>colnames(gr2_markers) &lt;- c(<span>"logFC"</span>, <span>"adj.P.Val"</span>)<br>head(gr2_markers[order(gr2_markers$adj.P.Val), ])<br><br><span># 如果明确了对第二组细胞感兴趣</span><br>nhood_markers &lt;- findNhoodGroupMarkers(scRNA, da_results, subset.row = hvgs, <br>                                       aggregate.samples = <span>TRUE</span>, sample_col = <span>"orig.ident"</span>,<br>                                       subset.groups = c(<span>"2"</span>)<br>                                       )<br><br>head(nhood_markers)<br><span>#        logFC_2  adj.P.Val_2 GeneID</span><br><span># GNLY  4.529267 9.977073e-54   GNLY</span><br><span># CLIC3 1.273255 4.886386e-40  CLIC3</span><br><span># PRF1  2.186990 4.886386e-40   PRF1</span><br><span># KLRF1 1.310507 2.133371e-35  KLRF1</span><br><span># KLRD1 2.746359 9.425077e-32  KLRD1</span><br><span># GZMB  2.731049 3.720297e-29   GZMB</span><br><br><span># 如果明确了相比较的邻域</span><br>nhood_markers &lt;- findNhoodGroupMarkers(scRNA, da_results, subset.row = hvgs,<br>                                       subset.nhoods = da_results$NhoodGroup %<span>in</span>% c(<span>'11'</span>,<span>'2'</span>),<br>                                       aggregate.samples = <span>TRUE</span>, sample_col = <span>"orig.ident"</span>)<br><br>head(nhood_markers)<br><span>#   GeneID    logFC_2 adj.P.Val_2   logFC_11 adj.P.Val_11</span><br><span># 1    A2M -1.1629210 0.004322766  1.1629210  0.004322766</span><br><span># 2   AAK1  0.6881532 0.038952082 -0.6881532  0.038952082</span><br><span># 3  ABCA1 -0.2253056 0.063886117  0.2253056  0.063886117</span><br><span># 4 ABCA10 -0.1581780 0.064434029  0.1581780  0.064434029</span><br><span># 5  ABCA6 -0.3517706 0.019652787  0.3517706  0.019652787</span><br><span># 6  ABCA7 -0.1191482 0.307535525  0.1191482  0.307535525</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>12.3 差异基因可视化</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>ggplot(nhood_markers, aes(logFC_2,-log10(adj.P.Val_2 ))) + <br>  geom_point(alpha=<span>0.5</span>, size=<span>0.5</span>) +<br>  geom_hline(yintercept = <span>2</span>)<br><br><span># 筛选标准可以自行修改</span><br>markers &lt;- rownames(nhood_markers)[nhood_markers$adj.P.Val_2 &lt; <span>0.01</span> &amp; nhood_markers$logFC_2 &gt; <span>0</span>]<br><br>plotNhoodExpressionGroups(scRNA, da_results, features=markers,<br>                          subset.nhoods = da_results$NhoodGroup %<span>in</span>% c(<span>'11'</span>,<span>'2'</span>), <br>                          scale=<span>TRUE</span>,<br>                          grid.space = <span>"fixed"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100002196" data-ratio="0.8743093922651933" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hXbru0y91tWTpOuNoiaVCtTSj2AHlA1mXfaCyC7gcKj9TB4YZoNdwbSw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="724" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHWDPNnhzQ3JH2ZTd6UDu6hXbru0y91tWTpOuNoiaVCtTSj2AHlA1mXfaCyC7gcKj9TB4YZoNdwbSw/640?wx_fmt=png&amp;from=appmsg"></figure><h6 data-tool="mdnice编辑器"><span></span><span>12.4 同一邻域但是不同干预的细胞比较</span><span></span></h6><pre data-tool="mdnice编辑器"><span></span><code>dge_9 &lt;- testDiffExp(scRNA, da_results, design = ~ group, <br>                     meta.data = data.frame(colData(scRNA)),<br>                     subset.row = rownames(scRNA),<br>                     subset.nhoods=da_results$NhoodGroup==<span>"9"</span>)<br>dge_9<br><span># $`9`</span><br><span>#                   logFC     AveExpr          t   P.Value adj.P.Val          B Nhood.Group</span><br><span># KLHL17      0.017612117 0.011781245  1.4215277 0.1558631 0.6982049  -9.789123           9</span><br><span># LINC00115   0.026119993 0.041024269  1.1226770 0.2621795 0.6982049 -10.168746           9</span><br><span># AL627309.1  0.002904512 0.001411100  1.0242142 0.3062900 0.6982049 -10.274403           9</span><br><span># SAMD11     -0.006652596 0.003305143 -1.0015076 0.3171252 0.6982049 -10.297400           9</span><br><span># NOC2L      -0.030967073 0.180208912 -0.9373189 0.3491025 0.6982049 -10.359634           9</span><br><span># AL669831.5 -0.005367254 0.007952223 -0.5865251 0.5578198 0.9296997 -10.627143           9</span><br><span># FAM41C     -0.002584961 0.014220774 -0.1830747 0.8548227 1.0000000 -10.782673           9</span><br><span># AL627309.3  0.000000000 0.000000000  0.0000000 1.0000000 1.0000000 -10.799468           9</span><br><span># FAM87B      0.000000000 0.000000000  0.0000000 1.0000000 1.0000000 -10.799468           9</span><br><span># AL645608.1  0.000000000 0.000000000  0.0000000 1.0000000 1.0000000 -10.799468           9</span><br></code></pre><p data-tool="mdnice编辑器">需要提醒一下，其中很多参数笔者做了修改也做了注释，使用的时候需要先从默认值开始分析！</p><h4 data-tool="mdnice编辑器"><span></span><span>参考资料：</span><span></span></h4><ol data-tool="mdnice编辑器"><li><section>Differential abundance testing on single-cell data using k-nearest neighbor graphs. Nat Biotechnol. 2022 Feb;40(2):245-253.</section></li><li><section>miloR：https://rawcdn.githack.com/MarioniLab/miloR/7c7f906b94a73e62e36e095ddb3e3567b414144e/vignettes/milo_gastrulation.html#5_Finding_markers_of_DA_populations</section></li><li><section>单细胞天地：https://mp.weixin.qq.com/s/yYTxb_kOjeRSkzzuUoI4mA</section></li></ol><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。更多内容可关注公众号：<strong>生信方舟</strong></p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/0A9hiXqV1RfWz8UAnratAA",target="_blank" rel="noopener noreferrer">原文链接</a>
