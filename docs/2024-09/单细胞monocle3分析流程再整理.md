---
title: "单细胞monocle3分析流程再整理"
date: 2024-09-22T14:11:52Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
单细胞monocle3分析流程再整理 by 生信方舟
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">重读上一篇关于monocle3的推文的时候感觉内容冗长繁琐，因此笔者把关键部分代码稍作了整理。</p><p data-tool="mdnice编辑器">推文链接：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkwMjYyMDA1OA==&amp;mid=2247485400&amp;idx=1&amp;sn=e0b0e6c5cca4c390e13f70a8e080b08e&amp;chksm=c0a3f12df7d4783b2afcd5629fec969c151bebf9b6ab6120ee6731526ccc5a1037a0ada6ade9&amp;scene=21#wechat_redirect" textvalue="单细胞拟时序/轨迹分析monocle3流程学习和整理" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞拟时序/轨迹分析monocle3流程学习和整理</a> </p><p data-tool="mdnice编辑器">也可以看一看monocle2推文： <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkwMjYyMDA1OA==&amp;mid=2247485346&amp;idx=1&amp;sn=3418a827191460b099b3db8a27be6427&amp;chksm=c0a3f157f7d47841baf9d636bb6cd32f647167e11d333383c8e5f36a92032f1054611dfbce9b&amp;scene=21#wechat_redirect" textvalue="单细胞拟时序/轨迹分析原理及monocle2流程学习和整理" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞拟时序/轨迹分析原理及monocle2流程学习和整理</a></p><h4 data-tool="mdnice编辑器"><span></span>分析步骤<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>1、导入<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(paletteer)<br><span>library</span>(Seurat)<br><span>library</span>(monocle3)<br><span>library</span>(dplyr)<br><span>library</span>(BiocParallel)<br><span>library</span>(ggplot2)<br>register(MulticoreParam(workers = <span>4</span>, progressbar = <span>TRUE</span>))<br>load(<span>"scRNA.Rdata"</span>)<br><span># check一下</span><br>DimPlot(scRNA,pt.size = <span>0.8</span>,group.by = <span>"celltype"</span>,label = <span>T</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100002074" data-ratio="0.843859649122807" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT3qZzaJ2PFatJtM4alKcTn8kSo1iaicd4otHqumiaWvruHUdUHTeQ8XK2wg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="570" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT3qZzaJ2PFatJtM4alKcTn8kSo1iaicd4otHqumiaWvruHUdUHTeQ8XK2wg/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span>2、数据预处理<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>levels(Idents(scRNA)) <span>#打出来细胞类型供复制</span><br><span># [1] "CD4+ T-cells"      "Fibroblasts"       "B-cells"          </span><br><span># [4] "CD8+ T-cells"      "Neutrophils"       "Monocytes"        </span><br><span># [7] "Adipocytes"        "NK cells"          "Endothelial cells"</span><br><br><span># 重设等级也可以不设</span><br><span># scRNA$celltype &lt;- factor(scRNA$celltype,</span><br><span>#                          levels = c("Endothelial cells"))</span><br><br>Idents(scRNA) &lt;- scRNA$celltype<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>3.提取数据<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>expression_matrix &lt;- GetAssayData(scRNA, assay = <span>'RNA'</span>,layer  = <span>'counts'</span>)<br>cell_metadata &lt;- scRNA@meta.data <br>gene_annotation &lt;- data.frame(gene_short_name = rownames(expression_matrix))<br>rownames(gene_annotation) &lt;- rownames(expression_matrix)<br>cds &lt;- new_cell_data_set(expression_matrix,<br>                         cell_metadata = cell_metadata,<br>                         gene_metadata = gene_annotation)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>4.数据处理<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 归一化/预处理数据</span><br>cds &lt;- preprocess_cds(cds, num_dim = <span>100</span>)<br><span># 这个函数用于确认设定的dim数是否足够代表主要变异</span><br>plot_pc_variance_explained(cds)<br><br><br><span># 降维聚类，可选择UMAP、PCA或者TSNE</span><br>cds &lt;- reduce_dimension(cds,reduction_method=<span>'UMAP'</span>,<br>                        preprocess_method = <span>'PCA'</span>)<br>cds &lt;- cluster_cells(cds) <span>#cluster your cells</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span>5.轨迹推断<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 轨迹推断</span><br>cds &lt;- learn_graph(cds,verbose=<span>T</span>,<br>                       use_partition=<span>T</span>, <span>#默认是T，T时是顾及全局的情况</span><br>)<br><br>plot_cells(cds, <br>           color_cells_by = <span>'celltype'</span>,<br>           label_groups_by_cluster=<span>FALSE</span>,<br>           cell_size=<span>1</span>,group_label_size=<span>4</span>,<br>           trajectory_graph_color=<span>'#023858'</span>,<br>           trajectory_graph_segment_size = <span>1</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100002070" data-ratio="0.843859649122807" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT3jhXIk6V8efmib4ddmsBEl00mMFFabd6hmXffibJEMTCv2Ol4Iyn2ppzQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="570" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT3jhXIk6V8efmib4ddmsBEl00mMFFabd6hmXffibJEMTCv2Ol4Iyn2ppzQ/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span>6.定义起点-轨迹可视化<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 定义root cell, 推断拟时方向</span><br><span># 结合先验知识自定(示例数据)</span><br>cds &lt;- order_cells(cds) <br><br><span># 可视化</span><br>plot_cells(cds, label_cell_groups = <span>F</span>, <br>           color_cells_by = <span>"pseudotime"</span>, <br>           label_branch_points = <span>F</span>, <br>           graph_label_size = <span>0</span>, <br>           cell_size=<span>2</span>, <br>           trajectory_graph_color=<span>'black'</span>,<br>           trajectory_graph_segment_size = <span>2</span>)<br></code></pre><p data-tool="mdnice编辑器">示例数据，起点是随便点的。<img data-imgfileid="100002071" data-ratio="0.843859649122807" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT3UicTGzKCe6LKL0MQia3I9sZNGfVMAQ6IXMjY2SNjWxGRECkCfrBjJZkw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="570" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT3UicTGzKCe6LKL0MQia3I9sZNGfVMAQ6IXMjY2SNjWxGRECkCfrBjJZkw/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span>7.轨迹差异基因分析<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 提取不同轨迹的差异基因/并选择前12个</span><br><span># neighbor_graph="principal_graph"提取轨迹上相似位置是否有相关的表达</span><br>trace_genes &lt;- graph_test(cds, <br>                          neighbor_graph = <span>"principal_graph"</span>, <br>                          cores = <span>4</span>)<br><br>track_genes_sig &lt;- trace_genes %&gt;%<br>  top_n(n=<span>12</span>, morans_I) %&gt;%<br>  pull(gene_short_name) %&gt;%<br>  as.character()<br><br><span># 差异基因绘制</span><br>levels(Idents(scRNA)) <span>#打出来细胞类型供复制</span><br><span># [1] "CD4+ T-cells"      "Fibroblasts"       "B-cells"          </span><br><span># [4] "CD8+ T-cells"      "Neutrophils"       "Monocytes"        </span><br><span># [7] "Adipocytes"        "NK cells"          "Endothelial cells"</span><br><br>lineage_cds &lt;- cds[rowData(cds)$gene_short_name %<span>in</span>% track_genes_sig,<br>                      colData(cds)$celltype %<span>in</span>% c(<span>"NK cells"</span>,<br>                                                   <span>"Adipocytes"</span>,<br>                                                   <span>"Monocytes"</span>)]<br><span>#lineage_cds &lt;- order_cells(lineage_cds)</span><br>plot_genes_in_pseudotime(lineage_cds,<br>                         color_cells_by=<span>"celltype"</span>,<br>                         min_expr=<span>0.5</span>)<br><br><span># 细胞映射</span><br>plot_cells(cds, genes= track_genes_sig,<br>           cell_size=<span>1</span>, <br>           show_trajectory_graph=<span>FALSE</span>,<br>           label_cell_groups=<span>FALSE</span>,<br>           label_leaves=<span>FALSE</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>morans I</strong> 是一种用于测量基因表达的空间自相关性的统计量，<strong>判断某个基因的表达是否显示出空间聚集或空间模式</strong>。一般会用这个值结合/不结合P值去做基因筛选。得到了基因之后后续就可以做拟时序的热图了</p><p data-tool="mdnice编辑器">下面的图是不同细胞群中的某一些基因随着时间变化的表达图。其中TIMP3这个基因在2.5-5.0之间出现了一个小的峰，说明在这个时间段的Adipocytes中这个基因表达增加了，但过了这个时间点之后后面表达又降低回去了，并且后面的时间点钟这三种细胞几乎都没有了。<img data-imgfileid="100002072" data-ratio="0.843859649122807" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT3ibAOFmG3VBeoFhHbzwibCuSCib23kibvLic51RfqolNMFoqIzFibYibkJQwyQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="570" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT3ibAOFmG3VBeoFhHbzwibCuSCib23kibvLic51RfqolNMFoqIzFibYibkJQwyQ/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">这是不同差异基因的UMAP表达图。<img data-imgfileid="100002073" data-ratio="0.843859649122807" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT31eibG8tGSict5aGdYwvVHsKuXMq8zPHiapH6G8NaAIcGRPBCdEoCJFAcQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="570" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyE4M8M26KUoX4ibLrpGqvGT31eibG8tGSict5aGdYwvVHsKuXMq8zPHiapH6G8NaAIcGRPBCdEoCJFAcQ/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。更多内容可关注公众号：<strong>生信方舟</strong></p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/vnTh5hVoKzGBjjCU1fmaYQ",target="_blank" rel="noopener noreferrer">原文链接</a>
