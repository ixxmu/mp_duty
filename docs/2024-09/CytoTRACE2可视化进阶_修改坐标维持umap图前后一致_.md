---
title: "CytoTRACE2可视化进阶(修改坐标维持umap图前后一致)"
date: 2024-09-18T22:58:59Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
CytoTRACE2可视化进阶(修改坐标维持umap图前后一致) by 生信方舟
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">上一期推文已经简单说明了CytoTRACE2的分析流程、注意事项和可视化。</p><p data-tool="mdnice编辑器">推文：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkwMjYyMDA1OA==&amp;mid=2247485509&amp;idx=1&amp;sn=86e3e35168ea0f176a492eba4c9125fe&amp;chksm=c0a3feb0f7d477a6986800e8941187855c18816bedf9c3de37e9ea942028881f7c6351ea081c&amp;scene=21#wechat_redirect" textvalue="CytoTRACE2单细胞分化潜力预测工具学习" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">CytoTRACE2单细胞分化潜力预测工具学习</a><br></p><p data-tool="mdnice编辑器">有小伙伴观察到使用CytoTRACE2之后的图形会与原始的umap图有些许的不同，虽然在实际应用的时候这种情况是无伤大雅的。</p><p data-tool="mdnice编辑器">但既然提出了问题，笔者就尝试着去解决一下~</p><h4 data-tool="mdnice编辑器"><span></span><span>步骤流程</span><span></span></h4><h5 data-tool="mdnice编辑器"><span></span><span>1、导入</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span>library</span>(tidyverse)<br><span>library</span>(CytoTRACE2) <br><span>library</span>(Seurat)<br><span>library</span>(paletteer)<br><span>library</span>(BiocParallel)<br>register(MulticoreParam(workers = <span>4</span>, progressbar = <span>TRUE</span>))<br><br>load(<span>"scRNA.Rdata"</span>)<br>sub_dat &lt;- subset(scRNA, subset = celltype %<span>in</span>% c(<span>"CD8+ T-cells"</span>, <span>"CD4+ T-cells"</span>))<br>DimPlot(sub_dat,label = <span>T</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001882" data-ratio="0.9171075837742504" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHXicOoWY5jjkmgE9eSIh6INpvtBnOwHMcOGsHXWX5T7weJdibG6lZibwaG0E3W8icpiajibDK1Cz6HeNYw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="567" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHXicOoWY5jjkmgE9eSIh6INpvtBnOwHMcOGsHXWX5T7weJdibG6lZibwaG0E3W8icpiajibDK1Cz6HeNYw/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span><span>2、提取数据/运行CytoTRACE2</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 提取表达矩阵信息</span><br>expression_data &lt;- GetAssayData(sub_dat,layer = <span>"counts"</span>)<br><br><span># 运行CytoTRACE2</span><br>cytotrace2_result &lt;- cytotrace2(expression_data,species = <span>'human'</span>)<br><br><span># 提取注释信息</span><br>annotation &lt;- data.frame(phenotype = sub_dat@meta.data$celltype) %&gt;% <br>  set_rownames(., colnames(sub_dat))<br><br><span># 使用plotData函数生成预测和表型关联图</span><br>plots &lt;- plotData(cytotrace2_result = cytotrace2_result, <br>                  annotation = annotation,<br>                  expression_data = expression_data<br>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>3、坐标修改</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>umap_raw &lt;- as.data.frame(sub_dat@reductions$umap@cell.embeddings) <span># 为后面修改坐标有用</span><br><span># 创建一个包含所有需要更新的 plot 名称的向量</span><br>plot_names &lt;- c(<span>"CytoTRACE2_UMAP"</span>, <span>"CytoTRACE2_Potency_UMAP"</span>, <br>                <span>"CytoTRACE2_Relative_UMAP"</span>, <span>"Phenotype_UMAP"</span> <br>)<br><span># 循环遍历每个plot并更新坐标</span><br><span>for</span> (plot_name <span>in</span> plot_names) {<br>  <span>if</span> (!is.null(plots[[plot_name]][[<span>1</span>]]$data)) {<br>    plots[[plot_name]][[<span>1</span>]]$data$umap_1 &lt;- umap_raw$umap_1<br>    plots[[plot_name]][[<span>1</span>]]$data$umap_2 &lt;- umap_raw$umap_2<br>  }<br>}<br><br><span># 了解数据类型</span><br>class(plots$CytoTRACE2_UMAP[[<span>1</span>]]) <br><span># [1] "gg"     "ggplot"</span><br>class(plots$CytoTRACE2_Potency_UMAP[[<span>1</span>]]) <br><span># [1] "gg"     "ggplot"</span><br>class(plots$CytoTRACE2_Relative_UMAP[[<span>1</span>]]) <br><span># [1] "gg"     "ggplot"</span><br>class(plots$Phenotype_UMAP[[<span>1</span>]])<br><span># [1] "gg"     "ggplot"</span><br><br><span># 确认umap的数据范围</span><br>x_limits &lt;- range(umap_raw$umap_1, na.rm = <span>TRUE</span>)<br>y_limits &lt;- range(umap_raw$umap_2, na.rm = <span>TRUE</span>)<br><br><span># 导出图片</span><br>plots$CytoTRACE2_UMAP[[<span>1</span>]] &lt;- plots$CytoTRACE2_UMAP[[<span>1</span>]] + <br>  scale_x_continuous(limits = x_limits) + <br>  scale_y_continuous(limits = y_limits)<br>plots$CytoTRACE2_UMAP<br><br>plots$CytoTRACE2_Potency_UMAP[[<span>1</span>]] &lt;- plots$CytoTRACE2_Potency_UMAP[[<span>1</span>]] + <br>  coord_cartesian(xlim = x_limits, ylim = y_limits)<br>plots$CytoTRACE2_Potency_UMAP<br><br>plots$CytoTRACE2_Relative_UMAP[[<span>1</span>]] &lt;- plots$CytoTRACE2_Relative_UMAP[[<span>1</span>]] + <br>  coord_cartesian(xlim = x_limits, ylim = y_limits)<br>plots$CytoTRACE2_Relative_UMAP<br><br>plots$Phenotype_UMAP[[<span>1</span>]] &lt;- plots$Phenotype_UMAP[[<span>1</span>]] + <br>  coord_cartesian(xlim = x_limits, ylim = y_limits)<br>plots$Phenotype_UMAP<br><br><span>library</span>(patchwork)<br><span># 拼接为2x2布局</span><br>combined_plot &lt;- (p1[[<span>1</span>]] | p2[[<span>1</span>]]) / (p3[[<span>1</span>]] | p4[[<span>1</span>]])<br><span># 显示拼接后的图形</span><br>combined_plot<br>ggsave(<span>"combined_plot.png"</span>, plot = combined_plot, width = <span>10</span>, height = <span>10</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100001883" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHXicOoWY5jjkmgE9eSIh6INC9DicpqnxnjXnuoVoqphzYGJLXSVibVT89LYr4s1jhmwkEXCqOzPibQAA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1000" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHXicOoWY5jjkmgE9eSIh6INC9DicpqnxnjXnuoVoqphzYGJLXSVibVT89LYr4s1jhmwkEXCqOzPibQAA/640?wx_fmt=png&amp;from=appmsg">对比之前的结果，是不是新的很棒~<img data-imgfileid="100001881" data-ratio="0.9171075837742504" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHXicOoWY5jjkmgE9eSIh6INiceVrbicOKYWV8nBl2OK4zCD6r6kSlCMY5VuTxJDZMsYr66EibQzPsSbg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="567" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyHXicOoWY5jjkmgE9eSIh6INiceVrbicOKYWV8nBl2OK4zCD6r6kSlCMY5VuTxJDZMsYr66EibQzPsSbg/640?wx_fmt=png&amp;from=appmsg">但是笔者不明白的是每次图片导出的时候需要调试下面的两种缩放坐标轴的代码，<strong>如果自行使用的时候遇到图片显示不全的情况，就用另一种试一试</strong>。</p><p data-tool="mdnice编辑器">第一种：</p><p data-tool="mdnice编辑器"><strong>coord_cartesian(xlim = x_limits, ylim = y_limits)</strong></p><p data-tool="mdnice编辑器">第二种：</p><p data-tool="mdnice编辑器"><strong>scale_x_continuous(limits = x_limits) + scale_y_continuous(limits = y_limits)</strong></p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。更多内容可关注公众号：<strong>生信方舟</strong></p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/qnudX6OMbLuzLJxrp1hg8Q",target="_blank" rel="noopener noreferrer">原文链接</a>
