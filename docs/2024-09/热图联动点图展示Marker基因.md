---
title: "热图联动点图展示Marker基因"
date: 2024-09-25T02:19:15Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
热图联动点图展示Marker基因 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>前情提要</span><span></span></h3><p data-tool="mdnice编辑器">最近在<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzI1Njk4ODE0MQ==&amp;action=getalbum&amp;album_id=3418409629246324742&amp;scene=173&amp;subscene=&amp;sessionid=svr_157e45f3260&amp;enterid=1726709833&amp;from_msgid=2247525311&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" data-linktype="2">#单细胞常见图表</a>会整理<strong>五种方法可视化Marker基因系列</strong></p><p data-tool="mdnice编辑器">目前已经整理前两种——<code>Doheatmap以及Dotplot</code>可视化Marker基因及美化</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041821" data-ratio="0.7716049382716049" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1Udpk7jFVpTiaYtCtLOv86gGFias6NBQGqTsf2wrfb2DghiaFTsiaoCsLVgQXUg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="972" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1Udpk7jFVpTiaYtCtLOv86gGFias6NBQGqTsf2wrfb2DghiaFTsiaoCsLVgQXUg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">在整理完<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247525311&amp;idx=1&amp;sn=e5bcd6d2ce0edb630daf842b406b97c6&amp;scene=21#wechat_redirect" data-linktype="2">Dotplot可视化细节之如何计算百分比和表达量平均值</a><strong>提到了文章中会使用Dotplot的结果，用热图的形式进行展示</strong>**</p><p data-tool="mdnice编辑器">文章是<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247531158&amp;idx=1&amp;sn=5e0e79287dbbc173c56c517e4ef86c5f&amp;scene=21#wechat_redirect" data-linktype="2">单细胞文献复现月更交流群（门票99哦）</a>里面复现的第一篇，胃癌的文章。<img data-imgfileid="100041825" data-ratio="0.45092592592592595" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkQ9ictFicqMBpo7ERE6yBzd8NTjTLRibDHDNShvSBmR80ibkNs1hrm7ibK1w/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkQ9ictFicqMBpo7ERE6yBzd8NTjTLRibDHDNShvSBmR80ibkNs1hrm7ibK1w/640?wx_fmt=jpeg&amp;from=appmsg"></p><p data-tool="mdnice编辑器">那这期一起来学习尝试复现一下，文章使用的里面展示Marker基因的方式。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>获取绘图数据</span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span>获取需要展示的Marker基因集</span><span></span></h4><p data-tool="mdnice编辑器">这里使用<strong>Pbmc-3K的数据</strong>进行尝试，首先还是<strong>注释后的数据集，使用FindAllMarker计算每个亚群的Marker基因，并获取Top5的Marker基因用于后续的展示</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span>#计算所有簇的Marker基因，并且可视化TOP5基因</span><br><span># only.pos = TRUE，只关注上调；min.pct = 0.25，一个基因至少要在25%的细胞中表达</span><br><br>pbmc.markers &lt;- FindAllMarkers(pbmc, only.pos = TRUE, min.pct = 0.25,  logfc.threshold = 0.25, verbose = FALSE)<br>top5 = pbmc.markers %&gt;% group_by(cluster) %&gt;% top_n(n = 5, wt = avg_log2FC)<br>g = unique(top5<span>$gene</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>Dotplot结果数据获取</span><span></span></h4><p data-tool="mdnice编辑器"><strong>使用Dotplot绘图时候，可以将其保存给一个变量p</strong>，这时候直接输出p就是点图，使用<code>View(p)</code>查看就可以看到绘图的数据和变量</p><pre data-tool="mdnice编辑器"><span></span><code>p &lt;- DotPlot(pbmc, features = g)<br><br>View(p)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041823" data-ratio="0.5324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkWN9vY927Sk1LXPDQViae5XCNfbpVHHGfibtukmicRUESvrJ7LacIrFQ9A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkWN9vY927Sk1LXPDQViae5XCNfbpVHHGfibtukmicRUESvrJ7LacIrFQ9A/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">我们需要的数据就保存在<code>data</code>里面，提取出来用于绘图即可</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041822" data-ratio="0.9021065675340768" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkKHicqCoQ8QrF8sE0EjeiamGa9vrPL1BjmGACgCo7oib65zfNiaDF4KZNGQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="807" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkKHicqCoQ8QrF8sE0EjeiamGa9vrPL1BjmGACgCo7oib65zfNiaDF4KZNGQ/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>整理数据并绘图</span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span>1. 首先将data数据提取出来保存为新的变量，然后整理为热图需要的格式</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#提取数据</span><br><span># 加载必要的包</span><br>library(tidyr)<br>library(dplyr)<br>library(pheatmap)<br><br><span># 将数据存储在 dotplot_data 中</span><br>dotplot_data &lt;- p<span>$data</span><br>class(dotplot_data)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041824" data-ratio="0.9197452229299363" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkxcuVZGNgOg8r5PFdHyGXOZmkjScgkGDUyTR3M9DaDpWlNdvmmiaGuOA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="785" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkxcuVZGNgOg8r5PFdHyGXOZmkjScgkGDUyTR3M9DaDpWlNdvmmiaGuOA/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 将数据转换为宽格式，以 `avg.exp.scaled` 为数值</span><br>heatmap_data &lt;- dotplot_data %&gt;%<br>  select(features.plot, id, avg.exp.scaled) %&gt;%<br>  pivot_wider(names_from = features.plot, values_from = avg.exp.scaled)<br><br><span># 将细胞分群ID列设置为行名</span><br>heatmap_data = column_to_rownames(heatmap_data,var = <span>"id"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041828" data-ratio="0.27685185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkVBCVzsz8Vicr92a7B3TMBUvvmOlytAw3c0iaiaTq5M6OasFCe3nfqhbvg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkVBCVzsz8Vicr92a7B3TMBUvvmOlytAw3c0iaiaTq5M6OasFCe3nfqhbvg/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>2. 使用pheatmap绘图</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>pheatmap(heatmap_data, <br>         cluster_rows = F, <br>         cluster_cols = F)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041829" data-ratio="0.6351851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkCIaIvuweSoDcpWX05PINBy9tFC6oEdagAdianEFDqehO7K5Gu3OpHRQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkCIaIvuweSoDcpWX05PINBy9tFC6oEdagAdianEFDqehO7K5Gu3OpHRQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>3. 调整颜色添加注释信息</span><span></span></h4><p data-tool="mdnice编辑器">虽然没有直接复现文献的结果图，但是会可以<strong>根据它的配色来调整热图的颜色</strong></p><pre data-tool="mdnice编辑器"><span></span><code>pheatmap(heatmap_data, <br>         cluster_rows = F, <br>         cluster_cols = F, <br>         color = colorRampPalette(c(<span>"#c3ddf0"</span>, <span>"#eaf2f9"</span>, <span>"#e85a40"</span>))(100))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041826" data-ratio="0.5851851851851851" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1Udpkkiaw68fZoTHEVo25vqCKn9M7U8L9LLtyB8pd1cfDAFrVOgcDemnbGTg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1Udpkkiaw68fZoTHEVo25vqCKn9M7U8L9LLtyB8pd1cfDAFrVOgcDemnbGTg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>添加细胞注释条例图</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 添加注释</span><br>annotation &lt;- data.frame(CellType = row.names(heatmap_data))<br>row.names(annotation) &lt;- row.names(heatmap_data)<br><br>pheatmap(heatmap_data, <br>         cluster_rows = F, <br>         cluster_cols = F, <br>         color = colorRampPalette(c(<span>"#c3ddf0"</span>, <span>"#eaf2f9"</span>, <span>"#e85a40"</span>))(100),<br>         annotation_row = annotation)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041830" data-ratio="0.7231481481481481" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkPxGnURwicFDgI231NzZCRQo8AY253YZMdkqoJ6wvrFK4H6sl1Tr5PBA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkPxGnURwicFDgI231NzZCRQo8AY253YZMdkqoJ6wvrFK4H6sl1Tr5PBA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>调整一下热图格子的大小</strong></p><pre data-tool="mdnice编辑器"><span></span><code>pheatmap(heatmap_data,<br>         cellwidth = 10,<br>         cellheight = 15,<br>         cluster_rows = F, <br>         cluster_cols = F,<br>         color = colorRampPalette(c(<span>"#c3ddf0"</span>, <span>"#eaf2f9"</span>, <span>"#e85a40"</span>))(100))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100041827" data-ratio="0.41574074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkM2PbvhzrwW9PBFpbOb9BiabK4DEk4YX9vuuha2pgLr1vdUylmL2zobg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkM2PbvhzrwW9PBFpbOb9BiabK4DEk4YX9vuuha2pgLr1vdUylmL2zobg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">调整之后看起来和文章的结果差不太多，那就暂时先调整到这里叭。大家如果感兴趣也可以自己调整试试看！</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041834" data-ratio="0.3343621399176955" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkzKkicmdPFTsQ3tAj3k59vfibgHgMticiapEicMNiaicuYG53AytHcNf1b4GMw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="972" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkzKkicmdPFTsQ3tAj3k59vfibgHgMticiapEicMNiaicuYG53AytHcNf1b4GMw/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>结尾小结</span><span></span></h3><p data-tool="mdnice编辑器">这次使用热图基于Dotplot结果展示marker基因的代码，使用ChatGPT辅助进行整理。</p><p data-tool="mdnice编辑器">作为一个还在努力学习掌握R语言的小菜鸟，<strong>真的太爱能给出正确代码的chatGPT啦！</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041833" data-ratio="0.5956738768718802" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1Udpk1zRf2sykFbhstVMrlNiap78YXKEOopich5k1ULETnEPnto9TQhUeSL5w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="601" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjR90LFNLy4icTFEUCkE1Udpk1zRf2sykFbhstVMrlNiap78YXKEOopich5k1ULETnEPnto9TQhUeSL5w/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>曾老师工作日会在生信技能树视频号给大家演示使用kimi进行答疑，大家可以参与直播互动呀！</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100041835" data-ratio="0.5537037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkAE8Jeaa7TMSeAib7ulM3WjiaS3ZPsDPG5rf3ibf5lmD2fbkNDv8P8YBCg/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjR90LFNLy4icTFEUCkE1UdpkAE8Jeaa7TMSeAib7ulM3WjiaS3ZPsDPG5rf3ibf5lmD2fbkNDv8P8YBCg/640?wx_fmt=jpeg&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>不管是Kimi还是chatGPT，用好了都可以帮助提升工作效率，所以要好好借助这些工具呀！</strong></p><p data-tool="mdnice编辑器"><strong>chatGPT的话还是推荐</strong>：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247523773&amp;idx=1&amp;sn=75c7726c348c16a20ccb5f00ca032379&amp;scene=21#wechat_redirect" data-linktype="2">国内可稳定使用的GPT-4，还自带联网功能</a></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>文末友情宣传</span><span></span></h3><p data-tool="mdnice编辑器"><strong>如果你也想做单细胞转录组数据分析，最好是有自己的计算机资源哦，比如我们的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a>，而且还需要有基本的生物信息学基础，也可以看看我们的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533791&amp;idx=1&amp;sn=ff5e109daa321a13ba17f7ce1fabc799&amp;scene=21#wechat_redirect" data-linktype="2">生物信息学马拉松授课</a>，你的生物信息学入门课。</strong></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/gkRsxPvJhAOu3GSo8h-xwg",target="_blank" rel="noopener noreferrer">原文链接</a>
