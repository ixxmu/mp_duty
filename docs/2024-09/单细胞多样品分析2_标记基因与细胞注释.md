---
title: "单细胞多样品分析2-标记基因与细胞注释"
date: 2024-09-26T07:08:15Z
draft: ["false"]
tags: [
  "fetched",
  "生信漫漫学"
]
categories: ["Acdemic"]
---
单细胞多样品分析2-标记基因与细胞注释 by 生信漫漫学
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h1 data-tool="mdnice编辑器"><span></span><span>单细胞测序—标准流程代码(2) — 标记基因与细胞注释</span><span></span></h1><p data-tool="mdnice编辑器">书接上回——<a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247489521&amp;idx=1&amp;sn=fd49f3c1f9fec1fee82c1bda1a05440a&amp;scene=21#wechat_redirect" data-linktype="2">单细胞多样品标准流程代码-1</a>，已经做好<em><strong>数据质控、过滤、去批次、降维聚类分群</strong></em>后，接下来就是进行细胞注释方面的工作</p><h2 data-tool="mdnice编辑器"><span></span><span>step4:  看标记基因库</span><span></span></h2><pre data-tool="mdnice编辑器"><span></span><code><span># 原则上分辨率是需要自己肉眼判断，取决于个人经验</span><br><span># 为了省力，我们直接看  0.1和0.8即可</span><br><br>table(Idents(sce.all.int))<br>   <span>0</span>    <span>1</span>    <span>2</span>    <span>3</span>    <span>4</span>    <span>5</span> <br><span>5241</span> <span>4859</span> <span>1365</span> <span>1261</span> <span>1062</span>  <span>138</span> <br>table(sce.all.int$seurat_clusters)<br>   <span>0</span>    <span>1</span>    <span>2</span>    <span>3</span>    <span>4</span>    <span>5</span>    <span>6</span>    <span>7</span>    <span>8</span>    <span>9</span>   <span>10</span>   <span>11</span>   <span>12</span>   <span>13</span>   <span>14</span> <br><span>2460</span> <span>2200</span> <span>1998</span> <span>1878</span> <span>1061</span>  <span>936</span>  <span>690</span>  <span>635</span>  <span>598</span>  <span>511</span>  <span>428</span>  <span>241</span>  <span>139</span>   <span>92</span>   <span>59</span> <br>table(sce.all.int$RNA_snn_res.0.1) <br>   <span>0</span>    <span>1</span>    <span>2</span>    <span>3</span>    <span>4</span>    <span>5</span> <br><span>5241</span> <span>4859</span> <span>1365</span> <span>1261</span> <span>1062</span>  <span>138</span> <br>table(sce.all.int$RNA_snn_res.0.8)  <br>getwd()<br><br><span>#选择分辨率为0.1的分群进行标记</span><br>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br><span>#选择分辨率为0.8的分群进行标记</span><br>dir.create(<span>'check-by-0.8'</span>)<br>setwd(<span>'check-by-0.8'</span>)<br>sel.clust = <span>"RNA_snn_res.0.8"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>last_markers_to_check<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>4.1 <strong>check-all-markers.R</strong></span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 代码需要保证统一</span><br><span># 只能是 sce.all</span><br>gastric_cancer_markers = c(<span>'PTPRC'</span>, <br>                   <span>'MUC2'</span> , <span>'ITLN1'</span>,<br>                   <span>'FABP1'</span> , <span>'APOA1'</span>,<br>                   <span>'CEACAM5'</span> , <span>'CEACAM6'</span>,<br>                   <span>'EPCAM'</span>, <span>'KRT18'</span>, <span>'MUC1'</span>,<br>                   <span>'MUC6'</span> , <span>'TFF2'</span>,<br>                   <span>'PGA4'</span> , <span>'PGA3'</span>,<br>                   <span>'MUC5AC'</span> , <span>'TFF1'</span>,<span>'CHGA'</span> , <span>'CHGB'</span>) <br>Myo=c(<span>"Krt17"</span>, <span>"Krt14"</span>, <span>"Krt5"</span>, <span>"Acta2"</span>, <span>"Myl9"</span>, <span>"Mylk"</span>, <span>"Myh11"</span>)<br>Lum=c(<span>"Krt19"</span>, <span>"Krt18"</span>, <span>"Krt8"</span>)<br>Hs=c(<span>"Prlr"</span>, <span>"Cited1"</span>, <span>"Pgr"</span>, <span>"Prom1"</span>, <span>"Esr1"</span>)  <br>AV=c(<span>"Mfge8"</span>, <span>"Trf"</span>, <span>"Csn3"</span>, <span>"Wfdc18"</span>, <span>"Elf5"</span>, <span>"Ltf"</span>)<br>Lp=c(<span>"Kit"</span>, <span>"Aldh1a3"</span>, <span>"Cd14"</span>)<br>Fib=c(<span>"Col1a1"</span>, <span>"Col1a2"</span>, <span>"Col3a1"</span>, <span>"Fn1"</span>)<br>GSE150580_breast_cancer_markers_list =list(<br>  Myo=Myo,<br>  Lum=Lum,<br>  Hs=Hs, <br>  AV=AV,<br>  Lp=Lp,  <br>  Fib=Fib <br>  <br>) <br><br><span># macrophages (Adgre1, Cd14, and Fcgr3),</span><br><span># cDCs (Xcr1, Flt3, and Ccr7),</span><br><span># pDCs (Siglech, Clec10a, and Clec12a), </span><br><span># monocytes (Ly6c2 and Spn), </span><br><span># neutrophils (Csf3r, S100a8, and Cxcl3),</span><br>macrophages=c(<span>'Adgre1'</span>, <span>'Cd14'</span>,  <span>'Fcgr3'</span>)<br>cDCs=c(<span>'Xcr1'</span>, <span>'Flt3'</span>,  <span>'Ccr7'</span>)<br>pDCs=c(<span>'Siglech'</span>, <span>'Clec10a'</span>,  <span>'Clec12a'</span>)  <br>monocytes=c(<span>'Ly6c2'</span> , <span>'Spn'</span>)<br>neutrophils=c(<span>'Csf3r'</span>, <span>'S100a8'</span>,  <span>'Cxcl3'</span>) <br>SCP1661_meyloids_markers_list =list(<br>  macrophages=macrophages,<br>  cDCs=cDCs,<br>  pDCs=pDCs, <br>  monocytes=monocytes,<br>  neutrophils=neutrophils  <br>) <br> <br>lung_epi_markers =  c(<span>'TPPP3'</span>,<span>"SPRR3"</span>,<span>"GDPD3"</span>,<span>"SPRR1A"</span>,<span>"SPRR2A"</span>,<span>"RARRES2"</span>,<span>"TMPRSS11E"</span>,<br>                    <span>"ASCL3"</span>,<span>"CFTR"</span>,<span>"FOXI2"</span>,<span>"1SG20"</span>,<span>"FOXI1"</span>,<br>                    <span>"SAA4"</span>,<span>"SAA2"</span>,<span>"EFHC1"</span>,<span>"CCDC153"</span>,<span>"CCDC113"</span>,<span>"SAA1"</span>,<span>"CDC20B"</span>,<span>"FOXJ1"</span>,<br>                    <span>"MYCL"</span>,<span>"FOXN4"</span>,<span>"CCNO"</span>,<br>                    <span>"PIGR"</span>,<span>"BP1"</span>,<span>"MUC5A"</span>,<span>"VMO1"</span>,<span>"SCGB3A1"</span>,<span>"CYP2A13"</span>,<span>"CYP2B6"</span>,<span>"SCGB1A1"</span>,<br>                    <span>"BCAM"</span>,<span>"KRT15"</span>,<span>"KRT5"</span>,<span>"TP63"</span>)<br><br>myeloids_markers_list1 =list(<br>  CM=c(<span>"TTN"</span>,<span>"MYH7"</span>,<span>"MYH6"</span>,<span>"TNNT2"</span>) ,<br>  EC=c(<span>"VWF"</span>, <span>"IFI27"</span>, <span>"PECAM1"</span>,<span>"MGP"</span>),<br>  FB=c(<span>"DCN"</span>, <span>"C7"</span> ,<span>"LUM"</span>,<span>"FBLN1"</span>,<span>"COL1A2"</span>),<br>  MP=c(<span>"CD163"</span>, <span>"CCL4"</span>, <span>"CXCL8"</span>,<span>"PTPRC"</span>),<br>  SMC=c(<span>"ACTA2"</span>, <span>"CALD1"</span>, <span>"MYH11"</span>),<br>  Tc=c(<span>"CD3D"</span>,<span>"CD3E"</span>),<br>  DC1 = c( <span>'Clec9a'</span>, <span>'Xcr1'</span>,   <span>'Wdfy4'</span>), <br>  DC2 = c(<span>'Itgax'</span>, <span>'Sirpa'</span>,   <span>'Cd209a'</span>), <br>  mregDCs= c(<span>'Ccr7'</span>, <span>'Cd80'</span>, <span>'Cd200'</span>,   <span>'Cd247'</span>) ,<br>  hypoxia=c(<span>'Hif1a'</span>, <span>'Slc2a1'</span>, <span>'Vegfa'</span>, <span>'Hmox1'</span>, <br>            <span>'Bnip3'</span>, <span>'Nos2'</span>, <span>'Mmp2'</span>, <span>'Sod3'</span>, <br>            <span>'Cited2'</span>, <span>'Ldha'</span>),<br>  peric=c(<span>"ABCC9"</span>,<span>"PDGFRB"</span>,<span>"RGS5"</span>)<br>)<br><br>myeloids_markers_list2 = list(pDC = c(<span>"CLEC4C"</span>,<span>"IRF7"</span>,<span>"TCF4"</span>,<span>"GZMB"</span>),<br>                      cDC1 = c(<span>"XCR1"</span>,<span>"CLNK"</span>,<span>"CLEC9A"</span>),<br>                      cDC2 = c(<span>"FCER1A"</span>,<span>"HLA-DPB1"</span>,<span>"HLA-DQB1"</span>,<span>"CD1E"</span>,<span>"CD1C"</span>,<span>"CLEC10A"</span>,<span>"HLA-DQA2"</span>),<br>                      DC3 = c(<span>"CCL19"</span>,<span>"LAMP3"</span>,<span>"IDO1"</span>,<span>"IDO2"</span>,<span>"LAD1"</span>,<span>"FSCN1"</span>,<span>"CCR7"</span>,<span>"LY75"</span>,<span>"CCL22"</span>,<span>"CD40"</span>,<span>"BIRC3"</span>,<span>"NFKB2"</span>),<br>                      Macrophages = c(<span>"APOC1"</span>,<span>"HLA-DRB5"</span>,<span>"C1QA"</span>,<span>"C1QB"</span>),<br>                      RTMs = c(<span>"THBS1"</span>),<span>#Resident tissue macrophages</span><br>                      Lam = c(<span>"APOE"</span>),<span>#Lipid associated macrophages</span><br>                      Monocytes = c(<span>"LYZ"</span>,<span>"HLA-DRB1"</span>,<span>"TIMP1"</span>,<span>"S100A11"</span>,<span>"CXCL8"</span>,<span>"IL1B"</span>,<span>"PTGS2"</span>,<span>"S100A9"</span>,<span>"S100A8"</span>,<span>"MMP19"</span>),<br>                      Mono_C = c(<span>'CD14'</span>),<span>#Mono_CD14</span><br>                      Mono_F = c(<span>'FCGR3A'</span>),<span>#Mono_FCGR3A</span><br>                      Mast = c(<span>'TPSAB1'</span> , <span>'TPSB2'</span>))<br> <br><br>Tcells_markers = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<br>                   <span>'CCR7'</span>, <span>'SELL'</span> , <span>'TCF7'</span>,<span>'CXCR6'</span> , <span>'ITGA1'</span>,<br>                   <span>'FOXP3'</span>, <span>'IL2RA'</span>,  <span>'CTLA4'</span>,<span>'GZMB'</span>, <span>'GZMK'</span>,<span>'CCL5'</span>,<br>                   <span>'IFNG'</span>, <span>'CCL4'</span>, <span>'CCL3'</span> ,<br>                   <span>'PRF1'</span> , <span>'NKG7'</span>) <br><span>###CD4T</span><br>CD4_markers_list =list(<br>  Tc=c(<span>"CD3D"</span>,<span>"CD3E"</span>),<br>  CD4=c(<span>"CD4"</span> ),<br>  Treg=c(<span>"TNFRSF4"</span>,<span>"BATF"</span>,<span>"TNFRSF18"</span>,<span>"FOXP3"</span>,<span>"IL2RA"</span>,<span>"IKZF2"</span>),<br>  naive=c(<span>"CCR7"</span>,<span>"SELL"</span>,<span>"CD5"</span>),<br>  Tfh=c(<span>"CXCR5"</span>,<span>"BCL6"</span>,<span>"ICA1"</span>,<span>"TOX"</span>,<span>"TOX2"</span>,<span>"IL6ST"</span>),<span>#滤泡辅助性T细胞</span><br>  ILC=c(<span>"TNFRSF25"</span>,<span>"KRT81"</span>,<span>"LST1"</span>,<span>"AREG"</span>,<span>"LTB"</span>,<span>"CD69"</span>)<br>) <br><br><span>###CD8T</span><br>CD8_markers_list1 =list(<br>  CD8=c(<span>"CD8A"</span>,<span>"CD8B"</span>),<br>  TN_TCM=c(<span>"CCR7"</span>,<span>"SELL"</span>,<span>"TCF7"</span>,<span>"LEF1"</span>),<br>  TEM=c(<span>"GZMK"</span>  ),<br>  TEFF=c(<span>"TBX21"</span>,<span>"FCGR3A"</span>,<span>"FGFBP2"</span>),<br>  TRM=c(<span>"XCL1"</span>,<span>"XCL2"</span>,<span>"ITGAE"</span>,<span>"CD69"</span>),<br>  IEL_T = c(<span>"TMIGD2"</span>),<br>  yT1c=c(<span>"GNLY"</span>,<span>"PTGDS"</span>,<span>"GZMB"</span>,<span>"TRDC"</span>),<br>  yT2c=c(<span>"TMN1"</span>,<span>"HMGB2"</span>,<span>"TYMS"</span>),<br>  MAIT_T = c(<span>"SLC4A10"</span>)<br>) <br>CD8_markers_list2 =list(<br>  CD8T=c(<span>"CD8A"</span>,<span>"CD8B"</span>),<br>  MAIT=c(<span>"ZBTB16"</span>,<span>"NCR3"</span>,<span>"RORA"</span>),<br>  ExhaustedCD8T=c(<span>"LAG3"</span>,<span>"TIGIT"</span>,<span>"PDCD1"</span>,<span>"HAVCR2"</span>,<span>"CTLA4"</span>),<br>  EffMemoryCD8=c(<span>"EOMES"</span>,<span>"ITM2C"</span>),<br>  Resting_NK=c(<span>"XCL1"</span>,<span>"XCL2"</span>,<span>"KLRC1"</span>),<br>  Cytotoxic_NK=c(<span>"CX3CR1"</span>,<span>"FGFBP2"</span>,<span>"FCGR3A"</span>,<span>"KLRD1"</span>),<br>  Pre_exhausted=c(<span>"IFNG"</span>,<span>"PRF1"</span>,<span>"GNLY"</span>,<span>"GZMA"</span>,<span>"NKG7"</span>,<span>"GZMK"</span>)<br>)<br> <br>cd4_and_cd8T_markers_list  =list( <br>  naive=c(<span>"CCR7"</span>,<span>"SELL"</span>,<span>"TCF7"</span>,<span>"IL7R"</span>,<span>"CD27"</span>,<span>"CD28"</span>,<span>"LEF1"</span>,<span>"S1PR1"</span>),<br>  CD8Trm=c(<span>"XCL1"</span>,<span>"XCL2"</span>,<span>"MYADM"</span>),<br>  NKTc=c(<span>"GNLY"</span>,<span>"GZMA"</span>), <br>  Tfh=c(<span>"CXCR5"</span>,<span>"BCL6"</span>,<span>"ICA1"</span>,<span>"TOX"</span>,<span>"TOX2"</span>,<span>"IL6ST"</span>),<br>  th17=c(<span>"IL17A"</span>,<span>"KLRB1"</span>,<span>"CCL20"</span>,<span>"ANKRD28"</span>,<span>"IL23R"</span>,<span>"RORC"</span>,<span>"FURIN"</span>,<span>"CCR6"</span>,<span>"CAPG"</span>,<span>"IL22"</span>),<br>  CD8Tem=c(<span>"CXCR4"</span>,<span>"GZMH"</span>,<span>"CD44"</span>,<span>"GZMK"</span>),<br>  Treg=c(<span>"FOXP3"</span>,<span>"IL2RA"</span>,<span>"TNFRSF18"</span>,<span>"IKZF2"</span>),<br>  naive=c(<span>"CCR7"</span>,<span>"SELL"</span>,<span>"TCF7"</span>,<span>"IL7R"</span>,<span>"CD27"</span>,<span>"CD28"</span>),<br>  CD8Trm=c(<span>"XCL1"</span>,<span>"XCL2"</span>,<span>"MYADM"</span>), <br>  MAIT=c(<span>"KLRB1"</span>,<span>"ZBTB16"</span>,<span>"NCR3"</span>,<span>"RORA"</span>),<br>  yT1c=c(<span>"GNLY"</span>,<span>"PTGDS"</span>,<span>"GZMB"</span>,<span>"TRDC"</span>),<br>  yT2c=c(<span>"TMN1"</span>,<span>"HMGB2"</span>,<span>"TYMS"</span>),<br>  yt=c(<span>"TRGV9"</span>,<span>"TRDV2"</span>)<br>) <br><br><br><span># CD20 (MS4A1)表达于除plasma B 之外的所有B，很关键的区分naive 和plasma的marker</span><br><span># SDC1 = CD138 plasma B （接受抗原，可表达抗体） </span><br>Bcels_markers_list = list(<br>  All = c(<span>'MS4A1'</span>,<span>'SDC1'</span>,<span>'CD27'</span>,<span>'CD38'</span>,<span>'CD19'</span>, <span>'CD79A'</span>),<br>  GC_B = c(<span>'IL4R'</span>,<span>'TCL1A'</span>,<span>'LRMP'</span>,<span>'SUGCT'</span>),<br>  IGA_plasm_B= c ( <span>'IGHA1'</span>), <br>  IGG_plasm_B= c ( <span>'IGHG1'</span>)<br>)  <br><br>Hepatic_stellate_markers_list =list(<br>  qHSC=c(<span>"Lrat"</span>,<span>"Ecm1"</span>,<span>"Angptl6"</span>,<span>"Vipr1"</span> ),<br>  S1=c(<span>"Ccl2"</span> ,<span>"Cxcl10"</span> ,<span>"Cxcl1"</span> ,<span>"Ccl7"</span> ),<br>  S2=c(<span>"Acta2"</span> ,<span>"Tpm1"</span> ,<span>"Vim"</span> ,<span>"Tagln"</span>,<span>"Tnc"</span>,<span>"Tpm2"</span>),<br>  S3=c(<span>"Col1a1"</span>,<span>"Col1a2"</span>,<span>"Col3a1"</span> ,<span>"Lox"</span>,<span>"Lum"</span> )<br>)<br>  <br><span># arteries (HEY1, IGFBP3), capillaries (CD36, CA4), veins (ACKR1) and</span><br><span># lymphatic ECs (LECs; CCL21, PROX1). </span><br>stromal_markers = c(<span>'TEK'</span>,<span>"PTPRC"</span>,<span>"EPCAM"</span>,<span>"PDPN"</span>,<br>                   <span>"PECAM1"</span>,<span>'PDGFRB'</span>,<span>"PLVAP"</span>,<span>'PROX1'</span>,<span>'ACKR1'</span>,<span>'CA4'</span>,<span>'HEY1'</span>,<br>                   <span>'CSPG4'</span>,<span>'GJB2'</span>, <span>'RGS5'</span>,<span>'ITGA7'</span>,<br>                   <span>'ACTA2'</span>,<span>'RBP1'</span>,<span>'CD36'</span>, <br>                   <span>'ADGRE5'</span>,<span>'COL11A1'</span>,<span>'FGF7'</span>, <span>'MME'</span>) <br><br>last_markers = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>, <span>'CD4'</span>,<span>'CD8A'</span>,<br>                   <span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>                   <span>'IGHG1'</span>, <span>'MZB1'</span>, <span>'SDC1'</span>,<br>                   <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>, <br>                   <span>'TPSAB1'</span> , <span>'TPSB2'</span>,  <span># mast cells,</span><br>                   <span>'RCVRN'</span>,<span>'FPR1'</span> , <span>'ITGAM'</span> ,<br>                   <span>'C1QA'</span>,  <span>'C1QB'</span>,  <span># mac</span><br>                   <span>'S100A9'</span>, <span>'S100A8'</span>, <span>'MMP19'</span>,<span># monocyte</span><br>                   <span>'FCGR3A'</span>,<br>                   <span>'LAMP3'</span>, <span>'IDO1'</span>,<span>'IDO2'</span>,<span>## DC3 </span><br>                   <span>'CD1E'</span>,<span>'CD1C'</span>, <span># DC2</span><br>                   <span>'KLRB1'</span>,<span>'NCR1'</span>, <span># NK </span><br>                   <span>'FGF7'</span>,<span>'MME'</span>, <span>'ACTA2'</span>, <span>## human  fibo </span><br>                 <span>'GJB2'</span>, <span>'RGS5'</span>,<br>                   <span>'DCN'</span>, <span>'LUM'</span>,  <span>'GSN'</span> , <span>## mouse PDAC fibo </span><br>                   <span>'MKI67'</span> , <span>'TOP2A'</span>, <br>                   <span>'PECAM1'</span>, <span>'VWF'</span>,  <span>## endo </span><br>                 <span>"PLVAP"</span>,<span>'PROX1'</span>,<span>'ACKR1'</span>,<span>'CA4'</span>,<span>'HEY1'</span>,<br>                   <span>'EPCAM'</span> , <span>'KRT19'</span>,<span>'KRT7'</span>, <span># epi </span><br>                   <span>'FYXD2'</span>, <span>'TM4SF4'</span>, <span>'ANXA4'</span>,<span># cholangiocytes</span><br>                   <span>'APOC3'</span>, <span>'FABP1'</span>,  <span>'APOA1'</span>,  <span># hepatocytes</span><br>                   <span>'Serpina1c'</span>,<br>                   <span>'PROM1'</span>, <span>'ALDH1A1'</span> )<br><br>gastric_cancer_markers <br>lung_epi_markers<br>Tcells_markers<br>stromal_markers <br>last_markers <br><br>GSE150580_breast_cancer_markers_list <br>SCP1661_meyloids_markers_list <br>myeloids_markers_list1 <br>myeloids_markers_list2 <br>CD4_markers_list <br>CD8_markers_list1 <br>CD8_markers_list2 <br>cd4_and_cd8T_markers_list   <br>Bcels_markers_list <br>Hepatic_stellate_markers_list <br><br><br>markers = c(<span>'gastric_cancer_markers'</span>,<span>'lung_epi_markers'</span>,<br>            <span>'Tcells_markers'</span>,<br>            <span>'stromal_markers'</span>, <br>            <span>'last_markers'</span> )<br>markers_list &lt;- c(<br>  <span>'GSE150580_breast_cancer_markers_list'</span> ,<br>  <span>'SCP1661_meyloids_markers_list'</span> ,<br>  <span>'myeloids_markers_list1'</span> ,<br>  <span>'myeloids_markers_list2'</span> ,<br>  <span>'CD4_markers_list'</span> ,<br>  <span>'CD8_markers_list1'</span> ,<br>  <span>'CD8_markers_list2'</span> ,<br>  <span>'cd4_and_cd8T_markers_list'</span>   ,<br>  <span>'Bcels_markers_list'</span> ,<br>  <span>'Hepatic_stellate_markers_list'</span> <br>)<br><br>p_umap=DimPlot(sce.all.int, reduction = <span>"umap"</span>,raster = F,<br>               label = T,repel = T) <br>p_umap <br><br><span>if</span>(sp==<span>'human'</span>){<br>   lapply(markers, <span>function</span>(x){<br>     <span>#x=markers[1]</span><br>     genes_to_check=str_to_upper(get(x)) <br>     DotPlot(sce.all.int , features = genes_to_check )  + <br>       coord_flip() + <br>       theme(axis.text.x=element_text(angle=45,hjust = 1))<br>     <br>     h=length( genes_to_check )/6+3;h<br>     ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),height = h)<br>   })<br>  lapply(markers_list, <span>function</span>(x){<br>    <span># x=markers_list[1]</span><br>    genes_to_check = lapply(get(x), str_to_upper)<br>    dup=names(table(unlist(genes_to_check)))[table(unlist(genes_to_check))&gt;1]<br>    genes_to_check = lapply(genes_to_check, <span>function</span>(x) x[!x %<span>in</span>% dup])<br>  <br>    DotPlot(sce.all.int , features = genes_to_check )  + <br>     <span># coord_flip() + </span><br>      theme(axis.text.x=element_text(angle=45,hjust = 1))<br>    <br>    w=length( unique(unlist(genes_to_check)) )/5+6;w<br>    ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),width  = w)<br>  })<br>  <br>  last_markers_to_check &lt;&lt;- str_to_upper(last_markers ) <br><br> }<span>else</span> <span>if</span>(sp==<span>'mouse'</span>){<br>   lapply(markers, <span>function</span>(x){<br>     <span>#x=markers[1]</span><br>     genes_to_check=str_to_title(get(x)) <br>     DotPlot(sce.all.int , features = genes_to_check )  + <br>       coord_flip() + <br>       theme(axis.text.x=element_text(angle=45,hjust = 1))<br>     <br>     h=length( genes_to_check )/6+3;h<br>     ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),height = h)<br>   })<br>   lapply(markers_list, <span>function</span>(x){<br>     <span># x=markers_list[1]</span><br>     genes_to_check = lapply(get(x), str_to_title)<br>     dup=names(table(unlist(genes_to_check)))[table(unlist(genes_to_check))&gt;1]<br>     genes_to_check = lapply(genes_to_check, <span>function</span>(x) x[!x %<span>in</span>% dup])<br>     <br>     DotPlot(sce.all.int , features = genes_to_check )  + <br>       <span># coord_flip() + </span><br>       theme(axis.text.x=element_text(angle=45,hjust = 1))<br>     <br>     w=length( unique(unlist(genes_to_check)) )/5+6;w<br>     ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),width  = w)<br>   })<br>   <br>   last_markers_to_check &lt;&lt;- str_to_title(last_markers ) <br>}<span>else</span> {<br>  <span>print</span>(<span>'we only accept human or mouse'</span>)<br>} <br><br>p_all_markers = DotPlot(sce.all.int , features = last_markers_to_check )  + <br>  coord_flip() + <br>  theme(axis.text.x=element_text(angle=45,hjust = 1)) <br>p_all_markers+p_umap<br>h=length( last_markers_to_check )/6+3;h<br>w=length( unique( Idents(sce.all.int)) )/5+10;w<br>ggsave(paste(<span>'last_markers_and_umap.pdf'</span>),width  = w,height = h)<br><br>pro = <span>'qc-'</span><br><span>if</span>(<span>"percent_mito"</span> %<span>in</span>% colnames(sce.all.int@meta.data ) ){<br><br>  <span>#可视化细胞的上述比例情况</span><br>  feats &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>, <span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br>  <br>  feats &lt;- c(<span>"nFeature_RNA"</span>, <span>"nCount_RNA"</span>)<br>  p1=VlnPlot(sce.all.int , features = feats, pt.size = 0, ncol = 2) + <br>    NoLegend()<br>  w=length(unique(sce.all.int<span>$orig</span>.ident))/3+5;w<br>  ggsave(filename=paste0(pro,<span>"Vlnplot1.pdf"</span>),plot=p1,width = w,height = 5)<br>  <br>  feats &lt;- c(<span>"percent_mito"</span>, <span>"percent_ribo"</span>, <span>"percent_hb"</span>)<br>  p2=VlnPlot(sce.all.int,  features = feats, pt.size = 0, ncol = 3, same.y.lims=T) + <br>    scale_y_continuous(breaks=seq(0, 100, 5)) +<br>    NoLegend()<br>  w=length(unique(sce.all.int<span>$orig</span>.ident))/2+5;w<br>  ggsave(filename=paste0(pro,<span>"Vlnplot2.pdf"</span>),plot=p2,width = w,height = 5)<br>  <br>}<br>p3=FeatureScatter(sce.all.int , <span>"nCount_RNA"</span>, <span>"nFeature_RNA"</span>, <br>                  pt.size = 0.5)<br>ggsave(filename=paste0(pro,<span>"Scatterplot.pdf"</span>),plot=p3)<br><br><br><span>if</span>(T){<br>  <span>#  remotes::install_github('genecell/COSGR')</span><br>  <span>#  genexcell &lt;- Seurat::GetAssayData(object = object[[assay]],slot = slot)</span><br>  marker_cosg &lt;- cosg(<br>    sce.all.int,<br>    groups=<span>'all'</span>,<br>    assay=<span>'RNA'</span>,<br>    slot=<span>'data'</span>,<br>    mu=1,<br>    n_genes_user=100)<br>  <br>  save(marker_cosg,file = paste0(pro,<span>'_marker_cosg.Rdata'</span>))<br>  head(marker_cosg)<br>  <br>  <span>## Top10 genes</span><br>  library(dplyr)  <br>  top_10 &lt;- unique(as.character(apply(marker_cosg<span>$names</span>,2,head,10)))<br>  <span># width &lt;-0.006*dim(sce.all.int)[2];width</span><br>  <span># height &lt;- 0.25*length(top_10)+4.5;height</span><br>  <br>  width &lt;- 15+0.5*length(unique(Idents(sce.all.int)));width<br>  height &lt;- 8+0.1*length(top_10);height<br>  <br>  sce.Scale &lt;- ScaleData(sce.all.int ,features =  top_10  )  <br>  <br>  DoHeatmap(  sce.Scale , top_10 , <br>              size=3)<br>  <br>  ggsave(filename=paste0(pro,<span>'DoHeatmap_check_top10_markers_by_clusters.pdf'</span>) ,<br>         <span># limitsize = FALSE,</span><br>         units = <span>"cm"</span>,width=width,height=height)<br>  width &lt;- 8+0.6*length(unique(Idents(sce.all.int)));width<br>  height &lt;- 8+0.2*length(top_10);height<br>  DotPlot(sce.all.int, features = top_10 ,<br>          assay=<span>'RNA'</span>  )  + coord_flip() +FontSize(y.text = 4)<br>  ggsave(paste0(pro,<span>'DotPlot_check_top10_markers_by_clusters.pdf'</span>),<br>         units = <span>"cm"</span>,width=width,height=height)<br>  <br>  <br>  <span>## Top3 genes</span><br>  top_3 &lt;- unique(as.character(apply(marker_cosg<span>$names</span>,2,head,3)))<br>  <br>  width &lt;- 15+0.2*length(unique(Idents(sce.all.int)));width<br>  height &lt;- 8+0.1*length(top_3);height<br>  <br>  sce.Scale &lt;- ScaleData(sce.all.int ,features =  top_3  )  <br>  <br>  DoHeatmap(  sce.Scale , top_3 , <br>              size=3)<br>  ggsave(filename=paste0(pro,<span>'DoHeatmap_check_top3_markers_by_clusters.pdf'</span>) ,<br>         units = <span>"cm"</span>,width=width,height=height)<br>  <br>  width &lt;- 8+0.2*length(unique(Idents(sce.all.int)));width<br>  height &lt;- 8+0.1*length(top_3);height<br>  DotPlot(sce.all.int, features = top_3 ,<br>          assay=<span>'RNA'</span>  )  + coord_flip()<br>  ggsave(paste0(pro,<span>'DotPlot_check_top3_markers_by_clusters.pdf'</span>),width=width,height=height)<br>  <br>}<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>4.2 标记基因总结</span><span></span></h3><ol data-tool="mdnice编辑器"><li><section><strong>gastric_cancer_markers</strong>（胃癌标记基因）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表包含了与胃癌相关的标记基因，用于识别或研究胃癌细胞。</section></li></ul><ol start="2" data-tool="mdnice编辑器"><li><section><strong>lung_epi_markers</strong>（肺上皮细胞标记基因）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表包含了与肺上皮细胞相关的标记基因，可能用于研究肺组织或肺癌中的上皮细胞。</section></li></ul><ol start="3" data-tool="mdnice编辑器"><li><section><strong>Tcells_markers</strong>（T细胞标记基因）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表包含了与T细胞相关的标记基因，T细胞是免疫系统中的一种关键细胞类型，参与适应性免疫反应。</section></li></ul><ol start="4" data-tool="mdnice编辑器"><li><section><strong>stromal_markers</strong>（基质细胞标记基因）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表包含了与基质细胞相关的标记基因，基质细胞构成组织中的支持性框架，参与组织结构和信号传导。</section></li></ul><ol start="5" data-tool="mdnice编辑器"><li><section><strong>last_markers</strong>（最后标记基因）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个名称看起来比较通用，可能是指某个研究中最后一组基因标记。</section></li></ul><ol start="6" data-tool="mdnice编辑器"><li><section><strong>GSE150580_breast_cancer_markers_list</strong>（乳腺癌标记基因列表）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>如前所述，这个列表包含了与乳腺癌相关的多种细胞类型的标记基因，用于分析乳腺癌中的不同细胞。</section></li></ul><ol start="7" data-tool="mdnice编辑器"><li><section><strong>SCP1661_meyloids_markers_list</strong>（髓系细胞标记基因列表）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表包含了与髓系细胞相关的标记基因，用于研究髓系细胞的功能和特性。</section></li></ul><ol start="8" data-tool="mdnice编辑器"><li><section><strong>myeloids_markers_list1</strong> 和 <strong>myeloids_markers_list2</strong>（髓系细胞标记基因列表1和2）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这两个列表可能包含了不同髓系细胞亚群的标记基因，分别用于研究这些亚群在特定条件或研究中的表现。</section></li></ul><ol start="9" data-tool="mdnice编辑器"><li><section><strong>CD4_markers_list</strong>（CD4+ T细胞标记基因列表）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表包含了与CD4+ T细胞相关的标记基因，这些细胞在免疫应答中起重要作用。</section></li></ul><ol start="10" data-tool="mdnice编辑器"><li><section><strong>CD8_markers_list1</strong> 和 <strong>CD8_markers_list2</strong>（CD8+ T细胞标记基因列表1和2）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这两个列表包含了与CD8+ T细胞相关的标记基因，可能代表不同亚群的CD8+ T细胞，研究这些细胞在免疫反应中的特性。</section></li></ul><ol start="11" data-tool="mdnice编辑器"><li><section><strong>cd4_and_cd8T_markers_list</strong>（CD4+ 和 CD8+ T细胞标记基因列表）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表可能包含了同时与CD4+ T细胞和CD8+ T细胞相关的基因，用于比较或综合分析这两种细胞类型。</section></li></ul><ol start="12" data-tool="mdnice编辑器"><li><section><strong>Bcels_markers_list</strong>（B细胞标记基因列表）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表包含了与B细胞相关的标记基因，B细胞是免疫系统中产生抗体的细胞。</section></li></ul><ol start="13" data-tool="mdnice编辑器"><li><section><strong>Hepatic_stellate_markers_list</strong>（肝星状细胞标记基因列表）：</section></li></ol><ul data-tool="mdnice编辑器"><li><section>这个列表包含了与肝星状细胞相关的标记基因，这些细胞在肝脏纤维化和其他肝脏病理过程中起重要作用。</section></li></ul><p data-tool="mdnice编辑器">这些基因标记列表可以在各种生物医学研究中帮助识别和分析不同的细胞类型及其在疾病中的作用</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>4.3 代码解释</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>p_umap=DimPlot(sce.all.int, reduction = <span>"umap"</span>,raster = <span>F</span>,<br>               label = <span>T</span>,repel = <span>T</span>) <br></code></pre><p data-tool="mdnice编辑器">reduction = "umap": 指定使用UMAP进行降维。</p><p data-tool="mdnice编辑器">raster = F: 禁用栅格化，使用矢量图形。</p><p data-tool="mdnice编辑器">label = T: 在图中标记每个细胞群的标签。</p><p data-tool="mdnice编辑器">repel = T: 避免标签重叠。</p><pre data-tool="mdnice编辑器"><span></span><code><span>if</span>(sp==<span>'human'</span>){<br>    lapply(markers, <span>function</span>(x){<br>      genes_to_check=str_to_upper(get(x)) <br>      DotPlot(sce.all.int , features = genes_to_check )  + <br>        coord_flip() + <br>        theme(axis.text.x=element_text(angle=<span>45</span>,hjust = <span>1</span>))<br>      <br>      h=length( genes_to_check )/<span>6</span>+<span>3</span>;h<br>      ggsave(paste(<span>'check_for_'</span>,x,<span>'.pdf'</span>),height = h)<br>    })<br>    <br> ....<br></code></pre><ul data-tool="mdnice编辑器"><li><section><p><code>lapply</code> 函数对 <code>markers</code> 列表中的每个元素执行指定操作。</p></section></li><li><section><p>genes_to_check=str_to_upper(get(x))</p><p><em><strong>将当前标记列表 <code>x</code> 中的所有基因名称转换为大写，以便与人类基因名称匹配。</strong></em></p></section></li></ul><p data-tool="mdnice编辑器">分别对markers、markers_list列表中的基因进行可视化的操作。</p><pre data-tool="mdnice编辑器"><span></span><code>last_markers_to_check &lt;&lt;- str_to_upper(last_markers ) <br></code></pre><p data-tool="mdnice编辑器">将变量 last_markers 中的所有基因名称转换为大写，并将结果存储在一个<em><strong>全局变量</strong></em> last_markers_to_check中。</p><p data-tool="mdnice编辑器">注：</p><p data-tool="mdnice编辑器"><em><strong>&lt;&lt;- 是 R 语言中的一种赋值操作符，用于在函数内部将值赋给全局变量或父级作用域中的变量。与常规的 <code>&lt;-</code> 不同，&lt;&lt;- 可以改变当前函数环境之外的变量。</strong></em></p><pre data-tool="mdnice编辑器"><span></span><code><span>else</span> <span>if</span>(sp==<span>'mouse'</span>){<br>   lapply(markers, <span>function</span>(x){<br>     genes_to_check=str_to_title(get(x)<br>     <span>...</span><br>   }<br>   lapply(markers_list, <span>function</span>(x){<br>     genes_to_check = lapply(get(x), str_to_title)<br>     <span>...</span><br>   }<br>   <br>   last_markers_to_check &lt;&lt;- str_to_title(last_markers ) <br></code></pre><p data-tool="mdnice编辑器">与human不同，小鼠的基因名需要首字母大写</p><p data-tool="mdnice编辑器"><em><strong>基因名称转换为首字母大写（str_to_title），因为小鼠基因的标准命名方式是首字母大写。</strong></em></p><pre data-tool="mdnice编辑器"><span></span><code>  marker_cosg &lt;- cosg(<br>    sce.all.int,<br>    groups=<span>'all'</span>,<br>    assay=<span>'RNA'</span>,<br>    slot=<span>'data'</span>,<br>    mu=<span>1</span>,<br>    n_genes_user=<span>100</span>)<br>  <br>  save(marker_cosg,file = paste0(pro,<span>'_marker_cosg.Rdata'</span>))<br>  head(marker_cosg)<br></code></pre><ul data-tool="mdnice编辑器"><li><section>cosg函数用于识别细胞群体的特征基因（marker基因）。</section></li><li><section>marker_cosg 是一个保存结果的变量，包含识别到的marker基因。</section></li></ul><p data-tool="mdnice编辑器">sce.all.int: 输入的单细胞对象（SingleCellExperiment 或 Seurat 对象），包含了所有细胞的数据。</p><p data-tool="mdnice编辑器">groups = all: 指定要对所有群体进行分析，即识别所有群体的marker基因。</p><p data-tool="mdnice编辑器">assay = 'RNA': 指定使用RNA测序数据进行分析。</p><p data-tool="mdnice编辑器">slot = 'data': 指定从数据的哪个部分提取表达值，这里选择 data插槽，通常包含标准化后的表达数据。</p><p data-tool="mdnice编辑器">mu = 1: 参数 mu可能控制分析过程中的一个参数，具体含义取决于 <code>cosg</code> 函数的实现。通常可能与某种筛选标准或过滤条件有关。</p><p data-tool="mdnice编辑器">n_genes_user = 100: 指定要识别的每个群体的marker基因数量，这里设置为100个。</p><pre data-tool="mdnice编辑器"><span></span><code><span>## Top10 genes</span><br>  <span>library</span>(dplyr)  <br>  top_10 &lt;- unique(as.character(apply(marker_cosg$names,<span>2</span>,head,<span>10</span>))) <br>  width &lt;- <span>15</span>+<span>0.5</span>*length(unique(Idents(sce.all.int)));width<br>  height &lt;- <span>8</span>+<span>0.1</span>*length(top_10);height<br>  <br>  sce.Scale &lt;- ScaleData(sce.all.int ,features =  top_10  )  <br>  DoHeatmap(  sce.Scale , top_10 , <br>              size=<span>3</span>)<br>  <br>  ggsave(filename=paste0(pro,<span>'DoHeatmap_check_top10_markers_by_clusters.pdf'</span>) ,<br>         units = <span>"cm"</span>,width=width,height=height)<br>  width &lt;- <span>8</span>+<span>0.6</span>*length(unique(Idents(sce.all.int)));width<br>  height &lt;- <span>8</span>+<span>0.2</span>*length(top_10);height<br>  DotPlot(sce.all.int, features = top_10 ,<br>          assay=<span>'RNA'</span>  )  + coord_flip() +FontSize(y.text = <span>4</span>)<br>  ggsave(paste0(pro,<span>'DotPlot_check_top10_markers_by_clusters.pdf'</span>),<br>         units = <span>"cm"</span>,width=width,height=height)<br><br><span>## Top3 genes</span><br><br><span>...</span><br></code></pre><p data-tool="mdnice编辑器"><em><strong>使用 <code>DoHeatmap</code> 函数绘制热图，显示 <code>top_10</code> 中基因在不同细胞群体中的表达情况。</strong></em></p><p data-tool="mdnice编辑器"><em><strong>使用 <code>DotPlot</code> 函数绘制点图，显示 <code>top_10</code> 基因在不同细胞群体中的表达情况。</strong></em></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>4.4 总结</span><span></span></h3><p data-tool="mdnice编辑器">以下代码均是分辨率为0.1的运行结果，其他分辨率类似</p><pre data-tool="mdnice编辑器"><span></span><code>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>即这一步会生成21张图</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005907" data-ratio="0.7849196538936959" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2Tqbq0B0MedTY8A0WtC6qib5icXkFNvDqoYPxm2cjdcUicCicHx7sXTCqX4Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1618" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2Tqbq0B0MedTY8A0WtC6qib5icXkFNvDqoYPxm2cjdcUicCicHx7sXTCqX4Q/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><em><strong>前8张为各个基因list中，在各个细胞分群中的表达情况</strong></em>：</p><p data-tool="mdnice编辑器">如</p><p data-tool="mdnice编辑器"><em><strong>check_for_ Tcells_markers .pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005904" data-ratio="0.6688829787234043" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2T74ic4NWSULLyTAseJYeqUIKYZ2hDobqEgtnia6Aadb9UevdeaOxjqnaA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1504" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2T74ic4NWSULLyTAseJYeqUIKYZ2hDobqEgtnia6Aadb9UevdeaOxjqnaA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><em><strong>check_for_ myeloids_markers_list2 .pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005903" data-ratio="0.4105504587155963" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TIa0kyiccfmjqZyculYybGpCATfLUsn9pUxwIjZd8xl6lw3MQqePsO7A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1744" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TIa0kyiccfmjqZyculYybGpCATfLUsn9pUxwIjZd8xl6lw3MQqePsO7A/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">后面的last_markers_and_umap.pdf同时可视化了umap降维图，和<strong>last_markers基因列表（包含多数细胞类型的特征基因）</strong>中在各个分群中的表达情况。</p><p data-tool="mdnice编辑器"><em><strong>last_markers_and_umap.pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005906" data-ratio="0.8345771144278606" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2To8d6MEMkIkhls1cHmJq5Iwe6lMia6FLHt67LYtmRWbich4b49Vn0LhYw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1608" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2To8d6MEMkIkhls1cHmJq5Iwe6lMia6FLHt67LYtmRWbich4b49Vn0LhYw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">后面的四张图是可视化了当前分辨率中各个分群中的top10基因的热图和点图。</p><p data-tool="mdnice编辑器"><em><strong>qc-DoHeatmap_check_top10_markers_by_clusters.pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005905" data-ratio="0.6532467532467533" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TnUu0veiaIicovrS7Z2gQUp5HjtoEvk0YwCoxkA3vJCQCl8VQiboUpGQaQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1540" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TnUu0veiaIicovrS7Z2gQUp5HjtoEvk0YwCoxkA3vJCQCl8VQiboUpGQaQ/640?wx_fmt=jpeg&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><em><strong>qc-DotPlot_check_top10_markers_by_clusters.pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005912" data-ratio="1.0799418604651163" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TC6s5kbmicyMZicRrHuTRmBoVKUl60s9JbhlDOey2icmY9tnwNKa3urkxA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1376" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TC6s5kbmicyMZicRrHuTRmBoVKUl60s9JbhlDOey2icmY9tnwNKa3urkxA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">最后3张是可视化了当前分群中的nFeature、nCount、线粒体核糖体血红细胞基因的分布、以及相关性图。</p><p data-tool="mdnice编辑器"><em><strong>qc-Vlnplot1.pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005908" data-ratio="0.697632058287796" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TUNJtdx5fDKsMsDpvPXc5QjetI6XhTQnu1s6djbyLHtHhdnvUibTz4mQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1098" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TUNJtdx5fDKsMsDpvPXc5QjetI6XhTQnu1s6djbyLHtHhdnvUibTz4mQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><em><strong>qc-Vlnplot2.pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005909" data-ratio="0.7509803921568627" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TAuib1YhvC8cibZs28LNBBnP4CicofgcNKx7icNCnNAn0ibckXwWHLl0hZRw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1020" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TAuib1YhvC8cibZs28LNBBnP4CicofgcNKx7icNCnNAn0ibckXwWHLl0hZRw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><em><strong>qc-Scatterplot.pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005910" data-ratio="0.7645348837209303" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2T75nT81dd0UyTVsQ36JZZu13GAN9oXb4ubhvjtSGHv2H20Q9V9AxLicA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1376" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2T75nT81dd0UyTVsQ36JZZu13GAN9oXb4ubhvjtSGHv2H20Q9V9AxLicA/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>step5: 确定单细胞亚群生物学名字</span><span></span></h2><p data-tool="mdnice编辑器">一般来说，为了节省工作量，我们选择0.1的分辨率进行命名</p><p data-tool="mdnice编辑器">因为命名这个步骤是纯人工 操作</p><p data-tool="mdnice编辑器">除非0.1确实分群太粗狂了，我们就选择0.8</p><p data-tool="mdnice编辑器"><em><strong>根据上述图片手动给细胞分群命名</strong></em></p><p data-tool="mdnice编辑器">这里因为用的是测试数据集，其自带细胞注释。因此用气泡图比较了本身和手动注释的区别。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>5.1 比较注释间差别（可选）</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br>sce.all.int = readRDS(<span>'2-harmony/sce.all_int.rds'</span>)<br>sp=<span>'human'</span><br>colnames(sce.all.int@meta.data) <br>table(sce.all.int$RNA_snn_res.0.1)<br><span># pbmc_small &lt;- BuildClusterTree(object = sce.all.int)</span><br><span># plot(Tool(object = pbmc_small, slot = 'BuildClusterTree'))</span><br><span># plot(pbmc_small@tools$BuildClusterTree)</span><br><br><span># 如果是手动给各个单细胞亚群命名</span><br><span>if</span>(<span>F</span>){<br>  sce.all.int<br>  celltype=data.frame(ClusterID=<span>0</span>:<span>5</span> ,<br>                      celltype= <span>0</span>:<span>5</span>) <br>  <span>#定义细胞亚群        </span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span> ,<span>4</span> ),<span>2</span>]=<span>'mono'</span>  <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>3</span> ),<span>2</span>]=<span>'Tcells'</span> <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>2</span> ),<span>2</span>]=<span>'Bcells'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>5</span> ),<span>2</span>]=<span>'pDC'</span><br>  <br>  head(celltype)<br>  celltype<br>  table(celltype$celltype)<br>  sce.all.int@meta.data$celltype = <span>"NA"</span><br>  <br>  <span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>    sce.all.int@meta.data[which(sce.all.int@meta.data$RNA_snn_res.0.1 == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>  Idents(sce.all.int)=sce.all.int$celltype<br>  <br>  <br>}<br><br>table(sce.all.int$seurat_annotations)<br><span>#比较和数据集自带的细胞分群的差别</span><br>gplots::balloonplot(<br>  table(sce.all.int$RNA_snn_res.0.8,<br>        sce.all.int$seurat_annotations)<br>)<br><br>gplots::balloonplot(<br>  table(sce.all.int$celltype,<br>        sce.all.int$seurat_annotations)<br>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100005911" data-ratio="0.7680722891566265" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TtsFvs8rIJg2oe413a1HLT7NweegyRy4S47khiaQrkWKCLRooIb0YZoA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1328" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TtsFvs8rIJg2oe413a1HLT7NweegyRy4S47khiaQrkWKCLRooIb0YZoA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>注：</strong></p><p data-tool="mdnice编辑器">sce.all.int = readRDS('2-harmony/sce.all_int.rds')</p><ul data-tool="mdnice编辑器"><li><section>从文件 sce.all_int.rds 中读取 SingleCellExperiment 对象并存储在变量 sce.all.int中。该对象包含了所有细胞的表达数据以及相关的元数据。</section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span></span><span>5.2<strong>手动注释部分</strong></span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>celltype=data.frame(ClusterID=<span>0</span>:<span>5</span> ,<br>                      celltype= <span>0</span>:<span>5</span>) <br>      <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span> ,<span>4</span> ),<span>2</span>]=<span>'mono'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>3</span> ),<span>2</span>]=<span>'Tcells'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>2</span> ),<span>2</span>]=<span>'Bcells'</span><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>5</span> ),<span>2</span>]=<span>'pDC'</span><br></code></pre><p data-tool="mdnice编辑器">这个步骤创建了一个名为 celltype 的数据框，包含两列：</p><ul data-tool="mdnice编辑器"><li><section>ClusterID: 表示聚类的ID，这里是0到5的整数。</section></li><li><section>celltype: 初始化时与 ClusterID 相同，也填充为0到5的整数</section></li></ul><p data-tool="mdnice编辑器"><em><strong>这里的0～5需要根据当前分辨率的细胞分群修改对应的数</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005913" data-ratio="0.32149200710479575" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2Trcbw2k3PAEMzPxXSveJBcrib2ibeN6Q2zBV3zqic4YaW8DJXMibxIgz4NQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1126" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2Trcbw2k3PAEMzPxXSveJBcrib2ibeN6Q2zBV3zqic4YaW8DJXMibxIgz4NQ/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#初始化celltype列</span><br>sce.all.int@meta.data$celltype = <span>"NA"</span><br><span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>    sce.all.int@meta.data[which(sce.all.int@meta.data$RNA_snn_res.0.1 == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>  Idents(sce.all.int)=sce.all.int$celltype<br></code></pre><ul data-tool="mdnice编辑器"><li><section><p>为 sce.all.int 对象的元数据（meta.data）<em><strong>添加一个新的 celltype 列</strong></em>，并将其初始值设置为 "NA"。</p></section></li><li><section><p>使用一个 for循环遍历 celltype数据框的每一行：</p><p><strong>which()函数返回满足条件的索引位置，即返回 TRUE 的位置。这个表达式会找到 sce.all.int对象中 RNA_snn_res.0.1 列中等于当前 ClusterID 的所有行索引。</strong></p><pre><span></span><code>sce.all.int@meta.data[which(<span>...</span>),<span>'celltype'</span>]<br></code></pre><p><strong>对选择出的那些行中的 celltype列进行操作。</strong></p><pre><span></span><code>sce.all.int@meta.data[which(<span>...</span>),<span>'celltype'</span>] &lt;- celltype$celltype[i]<br></code></pre><p>将特定聚类 ID 对应的细胞的 celltype 列更新为相应的细胞类型。</p></section></li><li><section><p>Idents(sce.all.int)是Seurat包中用于标识细胞身份的函数。将细胞的身份标识符更新为刚刚分配的 celltype，从而可以在后续分析和绘图中使用这些细胞类型标签。</p></section></li></ul><p data-tool="mdnice编辑器">这里手动注释还是比较粗糙的，为了方便显示，还是使用数据集本身自带的细胞注释进行后续的分析</p><pre data-tool="mdnice编辑器"><span></span><code><span>#DimPlot(sce.all.int, reduction = "umap",raster = F,group.by = 'RNA_snn_res.0.1',</span><br><span>#       label = T,repel = T) +</span><br><span># DimPlot(sce.all.int, reduction = "umap",raster = F,group.by = 'seurat_annotations',</span><br><span>#          label = T,repel = T) </span><br><br><span># 如果前面成功的给各个细胞亚群命名了</span><br><span># 就可以运行下面的代码</span><br>sce.all.int$celltype = as.character(sce.all.int$seurat_annotations)<br><span>if</span>(<span>"celltype"</span> %<span>in</span>% colnames(sce.all.int@meta.data ) ){<br>  <br>  sel.clust = <span>"celltype"</span><br>  sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>  table(sce.all.int@active.ident) <br>  <br>  dir.create(<span>'check-by-celltype'</span>)<br>  setwd(<span>'check-by-celltype'</span>)<br>  <span>source</span>(<span>'../scRNA_scripts/check-all-markers.R'</span>)<br>  setwd(<span>'../'</span>) <br>  getwd()<br>  phe=sce.all.int@meta.data<br>  save(phe,file = <span>'phe.Rdata'</span>)<br>  pdf(<span>'celltype-vs-orig.ident.pdf'</span>,width = <span>10</span>)<br>  gplots::balloonplot(table(sce.all.int$orig.ident,<br>                            sce.all.int$celltype))<br>  dev.off()<br>}<br><br></code></pre><p data-tool="mdnice编辑器">同样再跑下check-all-markers.R这个脚本，会出21张图。如</p><p data-tool="mdnice编辑器"><em><strong>qc-Vlnplot1.pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005914" data-ratio="0.7665562913907285" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2Tpqg5CRtJrXE3ksIudjbwBhpcAU22BFyuMUyhtM8yCvMxDUhqbX95Ow/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1208" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2Tpqg5CRtJrXE3ksIudjbwBhpcAU22BFyuMUyhtM8yCvMxDUhqbX95Ow/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>qc-DoHeatmap_check_top3_markers_by_clusters.pdf</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005917" data-ratio="0.65" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2T83xDbaHIXxdLtBCWU1DicssK1oqYaec8c9I9pmVkabz2lr84SucCRLQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1320" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2T83xDbaHIXxdLtBCWU1DicssK1oqYaec8c9I9pmVkabz2lr84SucCRLQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>qc-DotPlot_check_top3_markers_by_clusters.pdf</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005915" data-ratio="0.8538681948424068" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2Ticv8RXfL2UNVthnQQP5xRYFf793FXiaqiaxcQ15qcqpUsicEDRIFYicFjKQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1396" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2Ticv8RXfL2UNVthnQQP5xRYFf793FXiaqiaxcQ15qcqpUsicEDRIFYicFjKQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>last_markers_and_umap.pdf</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005918" data-ratio="0.9078404401650619" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2ThGJeyjsZwqcdfjduic6A6MrticeiaUK0ZbGMN76bVEMLeUy9dCtuH3bmA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1454" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2ThGJeyjsZwqcdfjduic6A6MrticeiaUK0ZbGMN76bVEMLeUy9dCtuH3bmA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">最后</p><pre data-tool="mdnice编辑器"><span></span><code> pdf(<span>'celltype-vs-orig.ident.pdf'</span>,width = <span>10</span>)<br>  gplots::balloonplot(table(sce.all.int$orig.ident,<br>                            sce.all.int$celltype))<br></code></pre><p data-tool="mdnice编辑器">展示了每个细胞群中在多分组中的分布情况</p><p data-tool="mdnice编辑器"><em><strong>celltype-vs-orig.ident.pdf</strong></em></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100005923" data-ratio="0.6666666666666666" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TEPJvUmGJQsoPLySuP6YUbTF9lsfog42OvjmvVWrVyEaDErhEZgg49g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1572" src="https://mmbiz.qpic.cn/sz_mmbiz_png/icQem1PXnP9bPpkU8SlGEzgXMh5KGuR2TEPJvUmGJQsoPLySuP6YUbTF9lsfog42OvjmvVWrVyEaDErhEZgg49g/640?wx_fmt=png&amp;from=appmsg"></figure></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Hoy-j3CfsshpzFcPaSRkRw",target="_blank" rel="noopener noreferrer">原文链接</a>
