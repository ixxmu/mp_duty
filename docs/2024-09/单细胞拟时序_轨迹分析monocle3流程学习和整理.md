---
title: "单细胞拟时序/轨迹分析monocle3流程学习和整理"
date: 2024-09-11T09:42:04Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
单细胞拟时序/轨迹分析monocle3流程学习和整理 by 生信方舟
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">拟时序/轨迹分析的基础知识和Monocle2流程可见推文： <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkwMjYyMDA1OA==&amp;mid=2247485346&amp;idx=1&amp;sn=3418a827191460b099b3db8a27be6427&amp;chksm=c0a3f157f7d47841baf9d636bb6cd32f647167e11d333383c8e5f36a92032f1054611dfbce9b&amp;scene=21#wechat_redirect" textvalue="单细胞拟时序/轨迹分析原理及monocle2流程学习和整理" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞拟时序/轨迹分析原理及monocle2流程学习和整理</a></p><p data-tool="mdnice编辑器">Monocle3的主要更新：<img data-imgfileid="100001702" data-ratio="0.6835106382978723" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVD3hBP9tHNepUeS0JFA1vbcibrT5ibN9SDvQMibicyBGvzHefjXF0I285tw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="752" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVD3hBP9tHNepUeS0JFA1vbcibrT5ibN9SDvQMibicyBGvzHefjXF0I285tw/640?wx_fmt=png&amp;from=appmsg"></p><ol data-tool="mdnice编辑器"><li><section>更完善的开发流程：Monocle 3 提供了更好结构化的工作流程，用于学习发育轨迹。</section></li><li><section>支持 UMAP 算法：UMAP 算法用于初始化轨迹推断，为轨迹推断提供了更优的起点。</section></li><li><section>支持多起点的轨迹：能够处理包含多个起点的轨迹推断，从而更好地反映复杂的发育过程。</section></li><li><section>学习含有环路或汇聚点的轨迹：可以学习到包含环形结构或收敛点的复杂轨迹。</section></li><li><section>自动分区算法：使用“近似图抽象”的概念，自动将细胞分区，以学习不相交或并行的轨迹。</section></li><li><section>新的统计测试：为那些具有轨迹相关表达的基因设计了新的统计检验方法，替代旧版的 differentialGeneTest() 和 BEAM()。</section></li><li><section>查询数据集映射到参考集：能够将查询的数据集投射到一个已知的参考集上。</section></li><li><section>注释转移：可以将参考集的注释转移到查询数据集中，便于不同数据集之间的比较和分析。</section></li><li><section>保存和加载 Monocle 对象和转换模型：支持 Monocle 对象和转换模型的保存和加载，方便后续分析。</section></li><li><section>将计数矩阵存储于磁盘：支持将数据存储在磁盘上而不是系统内存中，以节省内存空间。</section></li><li><section>混合负二项分布模型：改进了模型拟合，使用了混合负二项分布，适应更复杂的数据特征。</section></li><li><section>3D 界面：新增 3D 界面，可以用于轨迹和基因表达的可视化，使得数据分析更加直观。<img data-imgfileid="100001699" data-ratio="0.3384418901660281" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVoWkoHx19s9iblrSurDAsOsf5t1cZx4CUWLeWOWWvWf6pAWI0WvJbG8Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="783" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVoWkoHx19s9iblrSurDAsOsf5t1cZx4CUWLeWOWWvWf6pAWI0WvJbG8Q/640?wx_fmt=png&amp;from=appmsg"></section></li></ol><h4 data-tool="mdnice编辑器"><span></span><span>步骤流程</span><span></span></h4><h5 data-tool="mdnice编辑器"><span></span><span>1.导入</span><span></span></h5><p data-tool="mdnice编辑器">示例数据跟monocle2中的一样</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(Seurat)<br><span>library</span>(monocle3)<br><span>library</span>(dplyr)<br>load(<span>"scRNA.Rdata"</span>)<br>table(Idents(scRNA))<br><br>table(scRNA$orig.ident)<br>head(scRNA@meta.data)<br><br>DimPlot(scRNA,label = <span>T</span>)+NoLegend()<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>2.数据预处理</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>scRNA$celltype = Idents(scRNA)<br>levels(Idents(scRNA)) <span>#打出来细胞类型供复制</span><br>scRNA = subset(scRNA,idents = c(<span>"CD8+ T-cells"</span>,<span>"NK cells"</span>))<br>table(Idents(scRNA))<br><br>set.seed(<span>1234</span>)<br>scRNA = subset(scRNA,downsample = <span>100</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>3.提取数据</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>expression_matrix &lt;- GetAssayData(scRNA, assay = <span>'RNA'</span>,slot = <span>'counts'</span>)<br>cell_metadata &lt;- scRNA@meta.data <br>gene_annotation &lt;- data.frame(gene_short_name = rownames(data))<br>rownames(gene_annotation) &lt;- rownames(data)<br>cds &lt;- new_cell_data_set(expression_matrix,<br>                         cell_metadata = cell_metadata,<br>                         gene_metadata = gene_annotation)<br>                         <br><span># 官方文档推荐用稀疏矩阵，如下所示</span><br><span># cds &lt;- new_cell_data_set(as(umi_matrix, "sparseMatrix"),</span><br><span># cell_metadata = cell_metadata,</span><br><span># gene_metadata = gene_metadata)</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>4.数据处理</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 归一化/预处理数据</span><br><span># 这一步使用的PCA分析，num_dim数代表纳入的PCA数量</span><br>cds &lt;- preprocess_cds(cds, num_dim = <span>100</span>)<br><span># 这个函数用于确认设定的num_dim数是否足够代表主要变异</span><br>plot_pc_variance_explained(cds)<br><br><span># 去批次，这一步是可选的</span><br><span># cds &lt;- align_cds(cds, alignment_group = "batch")</span><br><br><span># umap降维</span><br>cds &lt;- reduce_dimension(cds, preprocess_method = <span>"PCA"</span>) <span># PCA或者LSI</span><br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>5.plot_cells展示</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># color_cells_by 设置展示分组情况</span><br>plot_cells(cds,color_cells_by = <span>"celltype"</span>)<br><span># genes参数可视化基因的变化</span><br>plot_cells(cds, genes=c(<span>"TP53"</span>,<span>"CDK4"</span>, <span>"CDK6"</span>))<br></code></pre><p data-tool="mdnice编辑器">这张图可以用于确认设定的num_dim数是否代表足够的变异，可以看到在PC大概在15左右就足够了~ 这样子就可以重新对num_dim数进行设置，减少计算资源浪费。<img data-imgfileid="100001701" data-ratio="0.8703007518796992" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVQVb6Me7Tv6l1fvF53ZPMVkWeHwpgk9dfJmzsMDicTHuxgQlJOFRGr8Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1064" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVQVb6Me7Tv6l1fvF53ZPMVkWeHwpgk9dfJmzsMDicTHuxgQlJOFRGr8Q/640?wx_fmt=png&amp;from=appmsg">color_cells_by参数设定为celltype之后的细胞展示<img data-imgfileid="100001703" data-ratio="0.8703007518796992" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVN8JX1Ws230PDBYhK68TGwnd9ktITsONU7HOibaA12zuUDZWF4EFsicvw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1064" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVN8JX1Ws230PDBYhK68TGwnd9ktITsONU7HOibaA12zuUDZWF4EFsicvw/640?wx_fmt=png&amp;from=appmsg">genes展示，颜色深浅表示特定基因在该细胞中的表达水平<img data-imgfileid="100001700" data-ratio="0.8706666666666667" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVlIjBv48YkRgspSUbNlL68AA4woPh53CFZ65jquHiaKW95uPH3016ETw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVlIjBv48YkRgspSUbNlL68AA4woPh53CFZ65jquHiaKW95uPH3016ETw/640?wx_fmt=png&amp;from=appmsg">其中研究者给出了使用UAMP的理由，“快”，当然也可以使用t-SNE。<img data-imgfileid="100001704" data-ratio="0.1321762349799733" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVC29vTnAp80bVfawgIlEHjIlbQiawTAqZujzqSCTVbN449bu9s1OicG7g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="749" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVC29vTnAp80bVfawgIlEHjIlbQiawTAqZujzqSCTVbN449bu9s1OicG7g/640?wx_fmt=png&amp;from=appmsg">甚至对于更多的细胞来说，还可以加速分析！需要设置umap.fast_sgd=true<img data-imgfileid="100001706" data-ratio="0.3437094682230869" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVJnvnp2cWfshCNlF1pDO5xHTibpAyt0X9wrJq6RwEQznp1l6cPnDU69A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="771" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVJnvnp2cWfshCNlF1pDO5xHTibpAyt0X9wrJq6RwEQznp1l6cPnDU69A/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><strong>管理批次问题</strong></p><pre data-tool="mdnice编辑器"><span></span><code><span># 开发者建议在colData中增加批次信息</span><br>plot_cells(cds, color_cells_by=<span>"orig.ident"</span>, label_cell_groups=<span>FALSE</span>)<br>cds &lt;- align_cds(cds, num_dim = <span>100</span>, alignment_group = <span>"orig.ident"</span>)<br>cds &lt;- reduce_dimension(cds)<br>plot_cells(cds, color_cells_by=<span>"orig.ident"</span>, label_cell_groups=<span>FALSE</span>)<br></code></pre><p data-tool="mdnice编辑器">开发者认为批次问题需要严格控制，因此如果下图出现单一样本占多数时，就需要进行去批次处理。<img data-imgfileid="100001707" data-ratio="0.8703007518796992" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVc8rZib9U7PQGQmL4HibmibJquHzSbFHjShahFUtjOwiaLOWySeKJGfyhyg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1064" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVc8rZib9U7PQGQmL4HibmibJquHzSbFHjShahFUtjOwiaLOWySeKJGfyhyg/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>6.将细胞进行聚类分组</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>cds &lt;- cluster_cells(cds, resolution=<span>1e-5</span>)<br>plot_cells(cds)<br>plot_cells(cds, color_cells_by=<span>"partition"</span>,<br>          group_cells_by=<span>"partition"</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100001705" data-ratio="0.10615989515072084" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVTibFNE4GWrzYkW6I9FcEAGicBNib2LaDCcNtl0ry8VHcpse5Brfeu9YicQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="763" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVTibFNE4GWrzYkW6I9FcEAGicBNib2LaDCcNtl0ry8VHcpse5Brfeu9YicQ/640?wx_fmt=png&amp;from=appmsg">这个分群的目的是进一步把纳入分析的细胞进行划分(采用community detection方式)。<img data-imgfileid="100001708" data-ratio="0.8703007518796992" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVLEVzJ7rWIqQgicLXu3jqYjyK6ibHYVnobRJZZibHFWqvFiabq006k3MP6g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1064" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVLEVzJ7rWIqQgicLXu3jqYjyK6ibHYVnobRJZZibHFWqvFiabq006k3MP6g/640?wx_fmt=png&amp;from=appmsg"></p><pre data-tool="mdnice编辑器"><span></span><code><span># cluster_cells之后再安装celltype进行映射一下</span><br>plot_cells(cds, color_cells_by=<span>"celltype"</span>,<br>           label_groups_by_cluster=<span>F</span>)<br>plot_cells(cds, color_cells_by=<span>"celltype"</span>,<br>           label_groups_by_cluster=<span>T</span>)<br></code></pre><p data-tool="mdnice编辑器">label_groups_by_cluster=F， 之后不会把细胞类型映射到聚类分群之后的细胞上<img data-imgfileid="100001713" data-ratio="0.8703007518796992" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVrNBvehgZRKW6LKMc4JSnsTPO036AfoaA0pNSUBDso8d6vDJiaFOm5Ug/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1064" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVrNBvehgZRKW6LKMc4JSnsTPO036AfoaA0pNSUBDso8d6vDJiaFOm5Ug/640?wx_fmt=png&amp;from=appmsg">label_groups_by_cluster=T， 之后会把细胞类型映射到聚类分群之后的细胞上<img data-imgfileid="100001714" data-ratio="0.8703007518796992" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVmHdC5SjKvzg8Y9X74e0u6xt9U67KZYnicSuT29I17CdXrnTyf5JKicgA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1064" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVmHdC5SjKvzg8Y9X74e0u6xt9U67KZYnicSuT29I17CdXrnTyf5JKicgA/640?wx_fmt=png&amp;from=appmsg">这个分析在细胞数量和种类多的时候就会有很大的视觉效果。</p><h5 data-tool="mdnice编辑器"><span></span><span>7.找出每个簇表达的标记基因</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>marker_test_res &lt;- top_markers(cds, group_cells_by=<span>"partition"</span>, <br>                               reference_cells=<span>1000</span>, cores=<span>8</span>)<br>top_specific_markers &lt;- marker_test_res %&gt;%<br>                            filter(fraction_expressing &gt;= <span>0.10</span>) %&gt;%<br>                            group_by(cell_group) %&gt;%<br>                            top_n(<span>3</span>, pseudo_R2) <span>#pseudo_R2是一种排序方法</span><br>top_specific_marker_ids &lt;- unique(top_specific_markers %&gt;%<br>                                    pull(gene_id))<br>plot_genes_by_group(cds,<br>                    top_specific_marker_ids,<br>                    group_cells_by=<span>"partition"</span>,<br>                    ordering_type=<span>"maximal_on_diag"</span>,<br>                    max.size=<span>3</span>)<br></code></pre><p data-tool="mdnice编辑器">跟上面的图进行对比，聚类一共分了四群，其中1/4是成纤维细胞，2/3是B细胞。然后选择了每一个亚群中表达排序前3的基因进行展示。<img data-imgfileid="100001712" data-ratio="0.8703007518796992" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVfQgLScyW8IibnylQKyKS0jyNN7MosEIuCoFuVUJe24BOlmENSib0pkFg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1064" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVfQgLScyW8IibnylQKyKS0jyNN7MosEIuCoFuVUJe24BOlmENSib0pkFg/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>8. 对亚群重新命名</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>colData(cds)$assigned_cell_type &lt;- as.character(partitions(cds))<br>colData(cds)$assigned_cell_type &lt;- dplyr::recode(colData(cds)$assigned_cell_type,<br>                                                 <span>"1"</span>=<span>"F1"</span>,<br>                                                 <span>"2"</span>=<span>"B1"</span>,<br>                                                 <span>"3"</span>=<span>"B2"</span>,<br>                                                 <span>"4"</span>=<span>"F4"</span><br>                                                 )<br>plot_cells(cds, group_cells_by=<span>"partition"</span>, color_cells_by=<span>"assigned_cell_type"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001710" data-ratio="1.4935483870967743" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVCX0H3SRaiaWC7NoqJlAtIMDDtjxRKg432QSO5Od6kNAMPTonS7k0Ajg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="310" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVCX0H3SRaiaWC7NoqJlAtIMDDtjxRKg432QSO5Od6kNAMPTonS7k0Ajg/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span><span>9. 若有细胞群分的不明显</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>cds_subset &lt;- choose_cells(cds)<br></code></pre><p data-tool="mdnice编辑器">自动跳转选择起点的页面，可以把混杂细胞框选出来进一步分析(本次分析内容没有明显混杂，使用的图片是官方示例文件)<img data-imgfileid="100001711" data-ratio="0.688" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVJCLLnTqP71o1atvP3ib0Bte9opN27gfGicDydDD7CtYLZt82sjHrwNUQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVJCLLnTqP71o1atvP3ib0Bte9opN27gfGicDydDD7CtYLZt82sjHrwNUQ/640?wx_fmt=png&amp;from=appmsg"></p><pre data-tool="mdnice编辑器"><span></span><code><span># 探索混杂细胞群中的差异基因</span><br>pr_graph_test_res &lt;- graph_test(cds_subset, neighbor_graph=<span>"knn"</span>, cores=<span>8</span>)<br>pr_deg_ids &lt;- row.names(subset(pr_graph_test_res, morans_I &gt; <span>0.01</span> &amp; q_value &lt; <span>0.05</span>))<br><span># 将具有相似表达模式的基因分组到模块</span><br>gene_module_df &lt;- find_gene_modules(cds_subset[pr_deg_ids,], resolution=<span>1e-3</span>)<br><span># 绘制这些模块的聚集表达值/揭示不同细胞表达的不同模式</span><br>plot_cells(cds_subset, genes=gene_module_df, <br>           show_trajectory_graph=<span>FALSE</span>, <br>           label_cell_groups=<span>FALSE</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100001719" data-ratio="0.7506666666666667" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVwzBxX2fTCMpzRfjNiaTE9ic0BkJ3zWacP655nibYz8hesWpUbzb4Gicbuw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVwzBxX2fTCMpzRfjNiaTE9ic0BkJ3zWacP655nibYz8hesWpUbzb4Gicbuw/640?wx_fmt=png&amp;from=appmsg">想要进一步区分混杂细胞可以探索每个模块中的基因并对它们进行富集分析</p><p data-tool="mdnice编辑器">这部分的参数来自官网数据，需要自行修改！！</p><p data-tool="mdnice编辑器">官方文件中也推荐采用他们开发的自动注释的方式——Garnett</p><pre data-tool="mdnice编辑器"><span></span><code>cds_subset &lt;- cluster_cells(cds_subset, resolution=<span>1e-2</span>)<br>plot_cells(cds_subset, color_cells_by=<span>"cluster"</span>)<br><br>colData(cds_subset)$assigned_cell_type &lt;- as.character(clusters(cds_subset)[colnames(cds_subset)])<br>colData(cds_subset)$assigned_cell_type &lt;- dplyr::recode(colData(cds_subset)$assigned_cell_type,<br>                                                        <span>"1"</span>=<span>"Sex myoblasts"</span>,<br>                                                        <span>"2"</span>=<span>"Somatic gonad precursors"</span>,<br>                                                        <span>"3"</span>=<span>"Vulval precursors"</span>,<br>                                                        <span>"4"</span>=<span>"Sex myoblasts"</span>,<br>                                                        <span>"5"</span>=<span>"Vulval precursors"</span>,<br>                                                        <span>"6"</span>=<span>"Somatic gonad precursors"</span>,<br>                                                        <span>"7"</span>=<span>"Sex myoblasts"</span>,<br>                                                        <span>"8"</span>=<span>"Sex myoblasts"</span>,<br>                                                        <span>"9"</span>=<span>"Ciliated neurons"</span>,<br>                                                        <span>"10"</span>=<span>"Vulval precursors"</span>,<br>                                                        <span>"11"</span>=<span>"Somatic gonad precursor"</span>,<br>                                                        <span>"12"</span>=<span>"Distal tip cells"</span>,<br>                                                        <span>"13"</span>=<span>"Somatic gonad precursor"</span>,<br>                                                        <span>"14"</span>=<span>"Sex myoblasts"</span>,<br>                                                        <span>"15"</span>=<span>"Vulval precursors"</span>)<br><br>plot_cells(cds_subset, group_cells_by=<span>"cluster"</span>, color_cells_by=<span>"assigned_cell_type"</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>10.轨迹图</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>cds &lt;- cluster_cells(cds, resolution=<span>1e-5</span>)<br>cds &lt;- learn_graph(cds)<br>plot_cells(cds, color_cells_by = <span>"partition"</span>, <span># color_cells_by可以修改</span><br>           label_groups_by_cluster=<span>FALSE</span>, <br>           label_leaves=<span>FALSE</span>,<br>           label_branch_points=<span>FALSE</span>)<br><br><span># 降低维度并可视化</span><br><span># 这里其实就是产生轨迹图之后+基因，跟上面的plot_cells很相似</span><br>cds &lt;- reduce_dimension(cds)<br>plot_cells(cds, label_groups_by_cluster=<span>FALSE</span>,  color_cells_by = <span>"celltype"</span>)<br><br>ciliated_genes &lt;- c(<span>"TP53"</span>,<span>"CDK4"</span>, <span>"CDK6"</span>)<br>plot_cells(cds,<br>           genes=ciliated_genes,<br>           label_cell_groups=<span>FALSE</span>,<br>           show_trajectory_graph=<span>FALSE</span>)<br><span># 同样还有聚类</span><br>cds &lt;- cluster_cells(cds)<br>plot_cells(cds, color_cells_by = <span>"partition"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001718" data-ratio="1.4935483870967743" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVdIQZZtRrfgUd5OOg7wfxNicTLrEU8rtI7spEZzQYhBVzkpicdWJYdH2w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="620" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVdIQZZtRrfgUd5OOg7wfxNicTLrEU8rtI7spEZzQYhBVzkpicdWJYdH2w/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 用order_cells进行起点排序</span><br>cds &lt;- cluster_cells(cds, resolution=<span>1e-5</span>)<br>cds &lt;- learn_graph(cds)<br>cds &lt;- order_cells(cds)<br>plot_cells(cds,<br>           color_cells_by = <span>"celltype"</span>,<br>           label_cell_groups=<span>FALSE</span>,<br>           label_leaves=<span>TRUE</span>,<br>           label_branch_points=<span>TRUE</span>,<br>           graph_label_size=<span>1.5</span>)<br></code></pre><p data-tool="mdnice编辑器">起点可以自定，要结合先验知识！！！ 其实会变得很主观。<img data-imgfileid="100001715" data-ratio="0.9685863874345549" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVaq8wKBFn7zu96aNAHMNMAIF1nTpsmLMvJa3TzPXjzwgIHJhfM2tu8g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="573" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVaq8wKBFn7zu96aNAHMNMAIF1nTpsmLMvJa3TzPXjzwgIHJhfM2tu8g/640?wx_fmt=png&amp;from=appmsg"></p><h6 data-tool="mdnice编辑器"><span></span><span>pseudotime</span><span></span></h6><pre data-tool="mdnice编辑器"><span></span><code>plot_cells(cds,<br>           color_cells_by = <span>"pseudotime"</span>,<br>           label_cell_groups=<span>FALSE</span>,<br>           label_leaves=<span>FALSE</span>,<br>           label_branch_points=<span>FALSE</span>,<br>           graph_label_size=<span>1.5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001716" data-ratio="0.9685863874345549" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVfT2n0nEBBUOYoY30nEhWnbgyDxiayfhWnAvdLV6SEyvibia2jMcxcy0gA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="573" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVfT2n0nEBBUOYoY30nEhWnbgyDxiayfhWnAvdLV6SEyvibia2jMcxcy0gA/640?wx_fmt=png&amp;from=appmsg"></figure><h6 data-tool="mdnice编辑器"><span></span><span>自动选择轨迹起点</span><span></span></h6><p data-tool="mdnice编辑器">这个方法适用于自己数据集中包含时间信息(比如有时间分组)</p><pre data-tool="mdnice编辑器"><span></span><code><span># 假设我的数据集中seurat_clusters是时间信息，请注意是假设！！！</span><br>head(colData(cds))<br><span># DataFrame with 6 rows and 11 columns</span><br><span>#                       orig.ident nCount_RNA nFeature_RNA percent.mt percent.rp percent.hb RNA_snn_res.0.5 seurat_clusters    celltype Size_Factor</span><br><span>#                      &lt;character&gt;  &lt;numeric&gt;    &lt;integer&gt;  &lt;numeric&gt;  &lt;numeric&gt;  &lt;numeric&gt;        &lt;factor&gt;        &lt;factor&gt;    &lt;factor&gt;   &lt;numeric&gt;</span><br><span># AAAGGTACAATTGGTC-1_1     sample1       3806         1215   7.777194    37.1256 0.00000000               2               2 B-cells        0.645389</span><br><span># AAAGTGATCTCAACCC-1_1     sample1       3111         1328   6.010929    28.9939 0.06428801               2               2 B-cells        0.527537</span><br><span># AACAACCTCGTTTACT-1_1     sample1      12631         3134   4.409785    26.5062 0.00791703               8               8 B-cells        2.141857</span><br><span># AACAAGACATAATCCG-1_1     sample1       5366         1616   4.789415    28.5315 0.00000000               2               2 B-cells        0.909920</span><br><span># AAGCCATTCTAGACCA-1_1     sample1      22292         4632   0.103176    18.8453 0.00000000               1               1 Fibroblasts    3.780086</span><br><span># AAGCGAGCAGGTCCGT-1_1     sample1       5689          464   0.123044     4.5878 0.00000000               8               8 B-cells        0.964692</span><br><span>#                      assigned_cell_type</span><br><span>#                             &lt;character&gt;</span><br><span># AAAGGTACAATTGGTC-1_1                 B1</span><br><span># AAAGTGATCTCAACCC-1_1                 B1</span><br><span># AACAACCTCGTTTACT-1_1                 B1</span><br><span># AACAAGACATAATCCG-1_1                 B1</span><br><span># AAGCCATTCTAGACCA-1_1                 F1</span><br><span># AAGCGAGCAGGTCCGT-1_1                 B2</span><br><br><span># 以下是官网给的代码</span><br><span># time_bin 官网设定是130-170</span><br>get_earliest_principal_node &lt;- <span>function</span>(cds, time_bin=<span>"2"</span>){<br>  cell_ids &lt;- which(colData(cds)[, <span>"seurat_clusters"</span>] == time_bin)<br>  <br>  closest_vertex &lt;-cds@principal_graph_aux[[<span>"UMAP"</span>]]$pr_graph_cell_proj_closest_vertex<br>  closest_vertex &lt;- as.matrix(closest_vertex[colnames(cds), ])<br>  root_pr_nodes &lt;- igraph::V(principal_graph(cds)[[<span>"UMAP"</span>]])$name[as.numeric(names(which.max(table(closest_vertex[cell_ids,]))))]<br>  root_pr_nodes<br>}<br>cds &lt;- order_cells(cds, <br>                   root_pr_nodes=get_earliest_principal_node(cds))<br><br>plot_cells(cds, color_cells_by = <span>"pseudotime"</span>,<br>           label_cell_groups=<span>FALSE</span>,label_leaves=<span>FALSE</span>,<br>           label_branch_points=<span>FALSE</span>,graph_label_size=<span>1.5</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100001717" data-ratio="0.13440860215053763" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVvvIcmwMWgOHm4n90loMb6Z0u0kuTyo27icVRYbzUSibVcLaRqmLbTFqQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="744" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVvvIcmwMWgOHm4n90loMb6Z0u0kuTyo27icVRYbzUSibVcLaRqmLbTFqQ/640?wx_fmt=png&amp;from=appmsg">time_bin的含义：这个参数用于指定分析中的特定时间窗口。在单细胞实验中，尤其是那些涉及时间序列的实验，研究者可能会根据细胞的采样时间将细胞分组到不同的时间窗口（bins）。time_bin 参数就是用来表示这些时间窗口的标签。例如，"130-170" 可能指的是某个具体的发育阶段或实验条件下的时间区间。</p><p data-tool="mdnice编辑器"><strong>所以time_bin是需要咱们的先验信息的！ 也就是说要是没这个信息，也没法自动计算起始点。笔者的数据没有时间信息，用了seurat_clusters假装时间信息</strong>！<img data-imgfileid="100001720" data-ratio="0.8409785932721713" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIV2koLCRUaYibsrmRm0FkXVLHNsWmBXreuu4aibwZFz6VjV5hOf5OxwIPA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="654" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIV2koLCRUaYibsrmRm0FkXVLHNsWmBXreuu4aibwZFz6VjV5hOf5OxwIPA/640?wx_fmt=png&amp;from=appmsg"></p><h6 data-tool="mdnice编辑器"><span></span><span>3D轨迹</span><span></span></h6><pre data-tool="mdnice编辑器"><span></span><code>cds_3d &lt;- reduce_dimension(cds, max_components = <span>3</span>)<br>cds_3d &lt;- cluster_cells(cds_3d)<br>cds_3d &lt;- learn_graph(cds_3d)<br>cds_3d &lt;- order_cells(cds_3d, root_pr_nodes=get_earliest_principal_node(cds))<br><br>cds_3d_plot_obj &lt;- plot_cells_3d(cds_3d, color_cells_by=<span>"celltype"</span>)<br>cds_3d_plot_obj<br></code></pre><p data-tool="mdnice编辑器">官网图片很好看的，笔者的数据比较丑。<img data-imgfileid="100001724" data-ratio="0.8404907975460123" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIV0utIbxunFxpicgky50jMkAhPhibD7zJnOiaxNPBh40C1ZmxDyOp5JKojA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="652" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIV0utIbxunFxpicgky50jMkAhPhibD7zJnOiaxNPBh40C1ZmxDyOp5JKojA/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>11.基因差异表达分析</span><span></span></h5><p data-tool="mdnice编辑器">一共两种方法：回归分析/用于比较聚类的图自相关分析</p><p data-tool="mdnice编辑器">其中回归分析需要有时间信息！</p><p data-tool="mdnice编辑器">用于比较聚类的图自相关分析(Graph-autocorrelation analysis for comparing clusters)不需要时间</p><pre data-tool="mdnice编辑器"><span></span><code><span># 提取含有B的细胞</span><br>cds_test &lt;- cds[,grepl(<span>"B"</span>, colData(cds)$assigned_cell_type, ignore.case=<span>TRUE</span>)]<br><span># check图像</span><br>plot_cells(cds_test, color_cells_by=<span>"partition"</span>)<br><span># graph_test(自空间自相关分析的统计数据)</span><br>pr_graph_test_res &lt;- graph_test(cds_test, neighbor_graph=<span>"knn"</span>, cores=<span>8</span>)<br>pr_deg_ids &lt;- row.names(subset(pr_graph_test_res, q_value &lt; <span>0.05</span>))<br><br><span># 寻找共调控基因的模块</span><br>gene_module_df &lt;- find_gene_modules(cds_test[pr_deg_ids,], resolution=<span>1e-2</span>)<br>cell_group_df &lt;- tibble::tibble(cell=row.names(colData(cds_test)), <br>                                cell_group=partitions(cds)[colnames(cds_test)])<br>agg_mat &lt;- aggregate_gene_expression(cds_test, gene_module_df, cell_group_df)<br>row.names(agg_mat) &lt;- stringr::str_c(<span>"Module "</span>, row.names(agg_mat))<br>colnames(agg_mat) &lt;- stringr::str_c(<span>"Partition "</span>, colnames(agg_mat))<br><br>pheatmap::pheatmap(agg_mat, cluster_rows=<span>TRUE</span>, cluster_cols=<span>TRUE</span>,<br>                   scale=<span>"column"</span>, clustering_method=<span>"ward.D2"</span>,<br>                   fontsize=<span>6</span>)<br></code></pre><p data-tool="mdnice编辑器">pr_deg_ids 得到是一群差异基因！！然后把这个基因进行模块化分析，之后提取差异模块并映射在不同簇中进行可视化<img data-imgfileid="100001722" data-ratio="0.8409785932721713" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVZFXuHVquAGeTqhfnmN4Vj4JsKaZFHvKJFMX7ZDVEsHuROZpQNhXMibw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="654" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVZFXuHVquAGeTqhfnmN4Vj4JsKaZFHvKJFMX7ZDVEsHuROZpQNhXMibw/640?wx_fmt=png&amp;from=appmsg"></p><pre data-tool="mdnice编辑器"><span></span><code><span># 查看module</span><br>plot_cells(cds_test, <br>           genes=gene_module_df %&gt;% filter(module %<span>in</span>% c(<span>18</span>, <span>24</span>, <span>30</span>, <span>33</span>)),<br>           group_cells_by=<span>"partition"</span>,<br>           color_cells_by=<span>"partition"</span>,<br>           show_trajectory_graph=<span>FALSE</span>)<br></code></pre><p data-tool="mdnice编辑器">要注意这个图上顶部的数字和图中的数字是不同概念，图片顶部的数字代表module情况(gene_module_df)，图中的数字代表不同细胞分组(cell_group_df)。<img data-imgfileid="100001723" data-ratio="0.8409785932721713" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVXrB2VgLsDQHEcicAc74MJAiaSUtNPwjYXYMB9tFBQndMGC2sUfyiarpFg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="654" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVXrB2VgLsDQHEcicAc74MJAiaSUtNPwjYXYMB9tFBQndMGC2sUfyiarpFg/640?wx_fmt=png&amp;from=appmsg"></p><h6 data-tool="mdnice编辑器"><span></span><span>寻找随伪时间而变化的基因</span><span></span></h6><pre data-tool="mdnice编辑器"><span></span><code><span># 处理数据</span><br><span># cds &lt;- new_cell_data_set(expression_matrix,</span><br><span>#                          cell_metadata = cell_metadata,</span><br><span>#                          gene_metadata = gene_annotation)</span><br><span># cds &lt;- preprocess_cds(cds, num_dim = 50)</span><br><span># cds &lt;- align_cds(cds)</span><br><span># cds &lt;- reduce_dimension(cds)</span><br><span># cds &lt;- cluster_cells(cds)</span><br><span># cds &lt;- learn_graph(cds)</span><br><span># cds &lt;- order_cells(cds)</span><br><span># plot_cells(cds,</span><br><span>#            color_cells_by = "cell.type",</span><br><span>#            label_groups_by_cluster=FALSE,</span><br><span>#            label_leaves=FALSE,</span><br><span>#            label_branch_points=FALSE)</span><br><br>ciliated_cds_pr_test_res &lt;- graph_test(cds, neighbor_graph=<span>"principal_graph"</span>, cores=<span>8</span>)<br>pr_deg_ids &lt;- ciliated_cds_pr_test_res %&gt;% <br>  filter(q_value &lt; <span>0.05</span>) %&gt;% <br>  arrange(-morans_I)<br><span># Moran's I 统计量是衡量一个变量在空间分布上是否表现出系统性变化（即空间相关性）的方法。其值范围通常在 -1（完全离散）到 +1（完全集聚）之间，值为0表示随机分布</span><br><br>plot_cells(cds, genes=c(<span>"TP53"</span>,<span>"CDK4"</span>,<span>"CDK6"</span>),<br>           show_trajectory_graph=<span>T</span>,<br>           label_cell_groups=<span>T</span>,<br>           label_leaves=<span>T</span>)<br><span># 里边T/F的选择可以自行探索</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100001721" data-ratio="0.8409785932721713" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVTDperdVxLeuicnBLFG1rYhSPic6XglKEmPYSIDT4gictYESlqUnR0qMxQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="654" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIVTDperdVxLeuicnBLFG1rYhSPic6XglKEmPYSIDT4gictYESlqUnR0qMxQ/640?wx_fmt=png&amp;from=appmsg"></figure><h6 data-tool="mdnice编辑器"><span></span><span>基因沿单一路径的动态图</span><span></span></h6><pre data-tool="mdnice编辑器"><span></span><code>test_genes &lt;- c(<span>"TP53"</span>,<span>"CDK4"</span>,<span>"CDK6"</span>)<br>test_lineage_cds &lt;- cds[rowData(cds)$gene_short_name %<span>in</span>% test_genes,<br>                       colData(cds)$celltype %<span>in</span>% c(<span>"Fibroblasts"</span>)]<br>test_lineage_cds &lt;- order_cells(test_lineage_cds)<br><br>plot_genes_in_pseudotime(test_lineage_cds,<br>                         color_cells_by=<span>"seurat_clusters"</span>,<br>                         min_expr=<span>0.5</span>)<br></code></pre><p data-tool="mdnice编辑器">图片诡异的原因是笔者的数据里面没有包含时间信息！！！笔者的数据没有时间信息，用了seurat_clusters假装时间信息！<img data-imgfileid="100001729" data-ratio="0.8409785932721713" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIViaBEib8fgic3AdZCCmicM7OxibyhicjH9E3OJDUB3p3eoG7NpCIicU6hGRRicg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="654" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGtkTld3n7GdYAG15FTibuIViaBEib8fgic3AdZCCmicM7OxibyhicjH9E3OJDUB3p3eoG7NpCIicU6hGRRicg/640?wx_fmt=png&amp;from=appmsg">总体感觉这个工具还是不够science的..分析过程中主观性/可人为操作性很强，这是优点也是缺点吧..</p><p data-tool="mdnice编辑器"><strong>如果自己的数据中涉及到时间信息那么这个工具还算是有用处，不然纯粹是一个“绘图工具”</strong>。</p><h4 data-tool="mdnice编辑器"><span></span><span>参考资料</span><span></span></h4><p data-tool="mdnice编辑器">1、monocle3：https://cole-trapnell-lab.github.io/monocle3/docs/introduction/</p><p data-tool="mdnice编辑器">2、单细胞天地：https://mp.weixin.qq.com/s/siD_cLk4VGD_L-UEIQkm0g</p><p data-tool="mdnice编辑器">3、Hayley：https://www.jianshu.com/p/c402b6588e17</p><p data-tool="mdnice编辑器"><strong>致谢</strong>：感谢曾老师、小洁老师以及生信技能树团队全体成员。</p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。更多内容可关注公众号：<strong>生信方舟</strong></p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/NRrFH8sjdUUq20z9hWAFyQ",target="_blank" rel="noopener noreferrer">原文链接</a>
