---
title: "【R-mlr3新书节选】手动计算并绘制任意二分类机器学习模型决策曲线（DCA）"
date: 2024-09-18T03:33:14Z
draft: ["false"]
tags: [
  "fetched",
  "R语言与数学建模"
]
categories: ["Acdemic"]
---
【R-mlr3新书节选】手动计算并绘制任意二分类机器学习模型决策曲线（DCA） by R语言与数学建模
------
<div><p><span>手动实现一遍，是理解概念或算法最佳的方式，没有之一。</span><br><span>—— 我的观点</span></p><hr><p><span></span></p><h2 data-block="true" data-editor="24t96" data-offset-key="2u6np-0-0"></h2><p><span data-offset-key="2u6np-0-0">1 概念原理</span></p><p><span data-offset-key="3brkg-0-0">当临床预测/诊断模型想要应用到临床上时，如何选择合适的阈值是临床医生需要考虑的问题。对于不同的疾病，有的可能需要更高的灵敏度，有的需要更高的特异度，但是究竟什么阈值能够使得患者利益最大化，就需要</span><span data-offset-key="3brkg-0-1">决策曲线分析（DCA）</span><span data-offset-key="3brkg-0-2">。</span></p><p><span data-offset-key="f1jbf-0-0">它是一种通过考虑患者风险和获益的可能范围来评估临床决策是否可行的方法（即临床实用性），也越来越多的应用在预测/诊断模型的研究上。</span></p><p><span data-offset-key="bu8oe-0-0">DCA 中有两个关键概念，一个是阈值概率，即判断/预测为阳性而患者选择接受治疗/干预的概率水平。通常预测/诊断模型会输出一个介于 0 到 1 之间的一个概率，当此概率大于阈值概率，就界定为阳性，对患者采取治疗/干预措施。</span></p><p><span data-offset-key="e0gi1-0-0">但是每个阈值概率判断的阳性组中显然仍然存在真阳性（TP）和假阳性（FP）患者，治疗真阳性患者会带来获益，而治疗假阳性患者会造成伤害，选择不同的阈值概率，会改变 TP 和 FP 的比值，进而引起受益和伤害的改变。因此，DCA 中另一个的关键概念就是接受治疗患者的</span><span data-offset-key="e0gi1-0-1">净获益</span><span data-offset-key="e0gi1-0-2">：</span></p><p><img data-galleryid="" data-imgfileid="100002637" data-ratio="0.1912280701754386" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukFIFckHhBrnl9R4Zqtg0riakhqG31aN6PCM5T3fkYYbNNKkJgl9bWraw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="570" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukFIFckHhBrnl9R4Zqtg0riakhqG31aN6PCM5T3fkYYbNNKkJgl9bWraw/640?wx_fmt=png&amp;from=appmsg"></p><p>其中，n 为观测数，TP <span>为治疗患者中包含的真阳数，FP </span><span>为治疗患者中包含的假阳数，pt </span><span>为阈值概率。</span></p><p><span data-offset-key="ep9td-0-0">净获益是同时考虑获益和伤害后的一个指标。对于每一个概率，都可以计算出一个净获益，把所有的点连起来，就是</span><span data-offset-key="ep9td-0-1">决策曲线</span><span data-offset-key="ep9td-0-2">。</span></p><p><span data-offset-key="2qemh-0-0">另外，绘制决策曲线时，通常还绘制两条特殊曲线：</span></p><ul><li><p><span data-offset-key="2qemh-0-0"><span data-offset-key="cne7i-0-0"><span data-text="true">治疗所有患者：</span></span><span data-offset-key="cne7i-0-1"><span data-text="true">从治疗患者中考虑，</span></span></span></p></li></ul><p><img data-galleryid="" data-imgfileid="100002638" data-ratio="0.23284313725490197" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukppaIdtZDQSHhjTPqiatn83VrzG8RG8vEOag9FibON8sj7V2oicPG6icJDQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="408" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukppaIdtZDQSHhjTPqiatn83VrzG8RG8vEOag9FibON8sj7V2oicPG6icJDQ/640?wx_fmt=png&amp;from=appmsg"></p><section>其中，<img data-galleryid="" data-imgfileid="100002639" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPuknfBicB2ic4iar8cp3sicKMXMFpUdup8RZW4ibjBfIazEZYib6fseR7nI1Qcw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="29" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPuknfBicB2ic4iar8cp3sicKMXMFpUdup8RZW4ibjBfIazEZYib6fseR7nI1Qcw/640?wx_fmt=png&amp;from=appmsg">为<span>患病率，即事件发生率。此时</span></section><p><img data-galleryid="" data-imgfileid="100002640" data-ratio="0.148479427549195" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukBH48AYrKfywbPLAZ3KwrbpR1xnOGOgO23bPR8mFSPhcIfzibAK8RA3w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="559" src="https://mmbiz.qpic.cn/sz_mmbiz_png/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukBH48AYrKfywbPLAZ3KwrbpR1xnOGOgO23bPR8mFSPhcIfzibAK8RA3w/640?wx_fmt=png&amp;from=appmsg"></p><ul><li><p><strong>不治疗任何患者：</strong><span>从治疗患者中考虑，TP = 0，FP = 0，<span>因此在任何阈值概率下，净获益都是 0。</span></span></p></li></ul><p><span><span><br></span></span></p><p data-pid="z8xcKxbk"><span>注：</span>还可以定义<span>未接受治疗患者的净获益</span>、<span>总体净获益</span>、确定预测模型效用的<span>概率阈值平均偏差（ADAPT）指数</span>，具体可参阅本文参考文献。</p><h2>2 R 语言实现</h2><h3>2.1 生成 DCA 数据</h3><p data-pid="YO9aouUf">自定义生成（计算） DCA 数据的函数，该函数设计为根据模型预测结果（真实标签、预测概率）计算，这样就相当于为任何二分类机器学习算法提供了通用接口。</p><pre><code><span>DCA_data</span> <span>=</span> <span>function</span><span>(</span><span>prediction</span><span>,</span> <span>pt</span><span>=</span><span>seq</span><span>(</span><span>0</span><span>.</span><span>01</span><span>,</span><span>0</span><span>.</span><span>99</span><span>,</span> <span>by</span><span>=</span><span>0</span><span>.</span><span>01</span><span>))</span> <span>{</span><br>  <span>#</span> <span>根据模型预测结果</span><span>、</span><span>阈值概率向量计算接受治疗的DCA净获益</span><br>  <span>#</span> <span>prediction为数据框</span><span>，</span><span>要包含两列</span><span>:</span> <span>truth为因子型的真实标签</span><span>,</span> <span>第一水平为正例</span><span>;</span> <br>  <span>#</span>                                 <span>prob为预测为正例的概率</span><br>  <span>#</span> <span>pt为阈值概率向量</span><span>，</span><span>默认为0</span><span>.</span><span>01</span><span>,</span><span>0.02</span><span>,</span> <span>...,</span> <span>0.99</span><br>  <span>N</span> <span>=</span> <span>nrow</span><span>(</span><span>prediction</span><span>)</span><br>  <span>lpt</span> <span>=</span> <span>length</span><span>(</span><span>pt</span><span>)</span><br>  <span>lvs</span> <span>=</span> <span>levels</span><span>(</span><span>prediction</span><span>$</span><span>truth</span><span>)</span><br>  <span>nb</span> <span>=</span> <span>double</span><span>(</span><span>lpt</span><span>)</span><br>  <span>for</span><span>(</span><span>i</span> <span>in</span> <span>1</span><span>:</span><span>lpt</span><span>)</span> <span>{</span><br>    <span>dt</span> <span>=</span> <span>prediction</span> <span>|</span><span>&gt;</span><br>      <span>mutate</span><span>(</span><span>response</span> <span>=</span> <span>ifelse</span><span>(</span><span>prob</span> <span>&gt;=</span> <span>pt</span><span>[</span><span>i</span><span>]</span><span>,</span> <span>lvs</span><span>[</span><span>1</span><span>]</span><span>,</span> <span>lvs</span><span>[</span><span>2</span><span>]</span><span>)</span> <span>|</span><span>&gt;</span><br>               <span>factor</span><span>(</span><span>levels</span> <span>=</span> <span>lvs</span><span>))</span><br>    <span>cm</span> <span>=</span> <span>table</span><span>(</span><span>dt</span><span>$</span><span>response</span><span>,</span> <span>dt</span><span>$</span><span>truth</span><span>)</span><br>    <span>#</span> <span>tp</span> <span>=</span> <span>cm</span><span>[</span><span>1</span><span>,</span><span>1</span><span>]</span><span>;</span> <span>tn</span> <span>=</span> <span>cm</span><span>[</span><span>2</span><span>,</span><span>2</span><span>]</span><span>;</span> <span>fp</span> <span>=</span> <span>cm</span><span>[</span><span>1</span><span>,</span><span>2</span><span>]</span><span>;</span> <span>fn</span> <span>=</span> <span>cm</span><span>[</span><span>2</span><span>,</span><span>1</span><span>]</span><br>    <span>nb</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>cm</span><span>[</span><span>1</span><span>,</span><span>1</span><span>]</span><span>/</span><span>N</span> <span>-</span> <span>cm</span><span>[</span><span>1</span><span>,</span><span>2</span><span>]</span><span>/</span><span>N</span> <span>*</span> <span>(</span><span>pt</span><span>[</span><span>i</span><span>]</span> <span>/</span> <span>(</span><span>1</span><span>-</span><span>pt</span><span>[</span><span>i</span><span>]</span><span>))</span><br>  <span>}</span><br>  <span>event</span><span>.</span><span>rate</span> <span>=</span> <span>table</span><span>(</span><span>prediction</span><span>$</span><span>truth</span><span>)</span><span>[[</span><span>1</span><span>]]</span> <span>/</span> <span>N</span><br>  <span>tibble</span><span>(</span><span>threshold</span> <span>=</span> <span>pt</span><span>,</span> <span>none</span> <span>=</span> <span>0</span><span>,</span> <span>pred</span> <span>=</span> <span>nb</span><span>,</span><br>         <span>all</span> <span>=</span> <span>event</span><span>.</span><span>rate</span> <span>-</span> <span>(</span><span>1</span><span>-</span><span>event</span><span>.</span><span>rate</span><span>)</span> <span>*</span> <span>pt</span><span>/</span><span>(</span><span>1</span><span>-</span><span>pt</span><span>))</span><br><span>}</span></code></pre><h2>2.2 绘制 DCA 曲线</h2><p data-pid="FdmUawWV">针对上述函数生成的 DCA 数据，再定义绘制 DCA 曲线的函数：</p><pre><code><span>plot_DCA</span> <span>=</span> <span>function</span><span>(</span><span>nb</span><span>,</span> <span>ylim</span> <span>=</span> <span>c</span><span>(</span><span>-</span><span>0</span><span>.</span><span>1</span><span>,</span> <span>0</span><span>.</span><span>4</span><span>))</span> <span>{</span><br>  <span>#</span> <span>根据DCA数据绘制DCA曲线</span><br>  <span>#</span> <span>nb为DCA_data</span><span>()</span><span>生成的DCA数据</span><br>  <span>#</span> <span>ylim设置y轴绘制范围</span><span>，</span><span>不同数据模型的净获益取值范围不同</span><span>，</span><span>经常需要调整</span><br>  <span>nb</span> <span>|</span><span>&gt;</span><br>    <span>pivot_longer</span><span>(</span><span>-</span><span>1</span><span>,</span> <span>names_to</span> <span>=</span> <span>"Models"</span><span>,</span> <span>values_to</span> <span>=</span> <span>"Net Benefit"</span><span>)</span> <span>|</span><span>&gt;</span><br>    <span>ggplot</span><span>(</span><span>aes</span><span>(</span><span>threshold</span><span>,</span> <span>`</span><span>Net</span> <span>Benefit</span><span>`</span><span>,</span> <span>color</span> <span>=</span> <span>Models</span><span>,</span> <span>linetype</span> <span>=</span> <span>Models</span><span>))</span> <span>+</span><br>    <span>geom_line</span><span>()</span> <span>+</span><br>    <span>scale_y_continuous</span><span>(</span><span>limits</span> <span>=</span> <span>ylim</span><span>)</span> <span>+</span><br>    <span>xlab</span><span>(</span><span>"Threshold Probability"</span><span>)</span> <span>+</span><br>    <span>theme_minimal</span><span>()</span> <span>+</span><br>    <span>theme</span><span>(</span><span>legend</span><span>.</span><span>position</span> <span>=</span> <span>"top"</span><span>)</span><br><span>}</span></code></pre><h3>2.3 演示案例</h3><p data-pid="ZD2Jp6iA">加载包：</p><pre><code><span>library</span><span>(</span><span>tidyverse</span><span>)</span><br><span>library</span><span>(</span><span>mlr3verse</span><span>)</span></code></pre><p data-pid="xtqPM0n1">以 <code>pima</code> 数据训练决策树模型为例，任何二分类数据、任何机器学习算法都可以类似实现。</p><p data-pid="2t2o8Sp0"><span>第一步：</span>常规机器学习步骤，想在测试集上做 DCA，就生成测试集上的预测结果对象。</p><pre><code><span>task</span> <span>=</span> <span>tsk</span><span>(</span><span>"pima"</span><span>)</span><br><span>split</span> <span>=</span> <span>partition</span><span>(</span><span>task</span><span>,</span> <span>ratio</span> <span>=</span> <span>0.7</span><span>)</span><br><span>learner</span> <span>=</span> <span>lrn</span><span>(</span><span>"classif.rpart"</span><span>,</span> <span>predict_type</span> <span>=</span> <span>"prob"</span><span>)</span><br><span>learner</span><span>$</span><span>train</span><span>(</span><span>task</span><span>,</span> <span>row_ids</span> <span>=</span> <span>split</span><span>$</span><span>train</span><span>)</span><br><span>pred</span> <span>=</span> <span>learner</span><span>$</span><span>predict</span><span>(</span><span>task</span><span>,</span> <span>row_ids</span> <span>=</span> <span>split</span><span>$</span><span>test</span><span>)</span><br><span>pred</span></code></pre><figure data-size="normal"><img data-imgfileid="100002642" data-ratio="0.3834808259587021" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukqibicZSIKnSqhu3MysjicM1owWsKop311GIVmCKLalROpkAt1AbfxNNUw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="678" height="260" width="678" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukqibicZSIKnSqhu3MysjicM1owWsKop311GIVmCKLalROpkAt1AbfxNNUw/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="bTgpKjAk"><span>第二步：</span>转化为数据框、修改列名，以适配 <code>DCA_data()</code> 函数的参数要求，然后调用函数生成 DCA 数据。</p><pre><code><span>pred</span> <span>=</span> <span>as</span><span>.</span><span>data</span><span>.</span><span>table</span><span>(</span><span>pred</span><span>)</span> <span>|</span><span>&gt;</span><br>  <span>rename</span><span>(</span><span>prob</span> <span>=</span> <span>prob</span><span>.</span><span>pos</span><span>)</span><br><span>pred</span></code></pre><figure data-size="normal"><img data-imgfileid="100002641" data-ratio="0.5181058495821727" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukKeot673ibuD3qvLCXO0vbfeb0SziaYAzqQAB1pNXHDnHpMhL0jnbiaOXg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="718" height="372" width="718" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukKeot673ibuD3qvLCXO0vbfeb0SziaYAzqQAB1pNXHDnHpMhL0jnbiaOXg/640?wx_fmt=other&amp;from=appmsg"></figure><pre><code><span>nb</span> <span>=</span> <span>DCA_data</span><span>(</span><span>pred</span><span>)</span><br><span>nb</span></code></pre><figure data-size="normal"><img data-imgfileid="100002643" data-ratio="0.7272727272727273" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukkXvCcfUMXYfHHvmMw3tdBMhW9A7XX7LoJb6eOc8tUJNOzYaTEmqBsQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="594" height="432" width="594" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukkXvCcfUMXYfHHvmMw3tdBMhW9A7XX7LoJb6eOc8tUJNOzYaTEmqBsQ/640?wx_fmt=other&amp;from=appmsg"></figure><p data-pid="LQlzIChC">其中，<code>none</code> 列为不治疗任何患者的净获益；<code>all</code> 为治疗所有患者的净获益；<code>pred</code> 为基于模型预测的净获益。</p><p data-pid="_DojQZER"><span>第三步：</span>可视化，绘制 DCA 曲线。</p><pre><code><span>plot_DCA</span><span>(</span><span>nb</span><span>,</span> <span>ylim</span> <span>=</span> <span>c</span><span>(</span><span>-</span><span>0.25</span><span>,</span> <span>0.4</span><span>))</span></code></pre><figure data-size="normal"><img data-imgfileid="100002644" data-ratio="0.7394084732214229" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukF21O5KuG7eZp0n7S7MPpdF3TheXfDc99sdo95lQRyPrYZ0ovuicphgg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1251" height="925" width="1251" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/oh2MbgfdUWCaTPkJOlg4rfOTRKNmibPukF21O5KuG7eZp0n7S7MPpdF3TheXfDc99sdo95lQRyPrYZ0ovuicphgg/640?wx_fmt=other&amp;from=appmsg"></figure><p><br></p><h2>最后注：本文主要是阐释 DCA 原理和计算细节，真正做DCA，更建议使用 dcurves 包，也包含生存任务的 DCA。</h2><h2>主要参考文献</h2><ol><li><p>Decision curve analysis: a technical note</p></li></ol><ol><li><p>https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6123195/<br></p></li></ol><hr><p data-pid="uaG92j2n">以上内容经过修改后，将出现在我的R语言新书：《R机器学习：基于mlr3verse》附录，所以禁止用于任何出版。</p><p><span><span><br></span></span></p><section><br></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/QwJyIyW7XqarH4wPZpYFOw",target="_blank" rel="noopener noreferrer">原文链接</a>
