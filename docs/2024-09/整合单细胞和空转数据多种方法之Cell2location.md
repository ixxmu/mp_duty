---
title: "整合单细胞和空转数据多种方法之Cell2location"
date: 2024-09-16T08:41:27Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
整合单细胞和空转数据多种方法之Cell2location by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">除了我们上期介绍过的<code>CellTrek</code>算法【<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487640&amp;idx=1&amp;sn=131cdd1c6067350cf40af0c16e442dd0&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞和空转数据多种方法之CellTrek</a>】，还有非常多的算法用于整合单细胞和空转数据，如何快速系统的了解更多的主流整合算法呢？这么多种算法我们又应该选择哪种呢？<strong>答案是查阅综述+大量实践！</strong></p><ul data-tool="mdnice编辑器"><li><section>例如，2022年发表在Nat Methods上的这篇空转Benchmarking文章（DOI: 10.1038/s41592-022-01480-9），来自<strong>瞿昆老师团队</strong>。文章系统比较了16个空间转录组数据分析算法：</section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100035551" data-ratio="0.8774373259052924" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibYhbpox2IyM9fVuHPyM1sS9eKsVucgiavIrpCtyCkbtRGNV82KIBEE8A/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="718" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibYhbpox2IyM9fVuHPyM1sS9eKsVucgiavIrpCtyCkbtRGNV82KIBEE8A/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228152056060</figcaption></figure><p data-tool="mdnice编辑器">结果显示，<strong>cell2location、spatialDWLS、RCTD</strong>等算法具有更优异的去卷积性能，能够更准确地拆分空间转录组数据的细胞类型组成。</p><ul data-tool="mdnice编辑器"><li><section>另外，来自2022年的Briefings in Bioinformatics综述文章（DOI: 10.1093/bib/bbac245）测试了10种整合算法：</section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100035554" data-ratio="0.44907407407407407" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibI5zPUNRh3AdSWqUjeBA8UquALs8qErBCAicAcabCYkY4WYspetIZ8Fw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibI5zPUNRh3AdSWqUjeBA8UquALs8qErBCAicAcabCYkY4WYspetIZ8Fw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228152625154</figcaption></figure><p data-tool="mdnice编辑器">“Taken together patterns observed from internal and external reference, our results suggest that RCTD, cell2location and stereoscope are among the most robust to batch effects between reference scRNA-seq and target ST data.”</p><p data-tool="mdnice编辑器">同样表明RCTD和cell2location算法依旧"遥遥领先"！</p><p data-tool="mdnice编辑器">整合算法很多，我们按照排名一个一个来，这次我们先介绍cell2location以及代码实战。</p><p data-tool="mdnice编辑器">Cell2location发表于2022年的<strong>Nature Biotechnology</strong>，题为《Cell2location maps fine-grained cell types in spatial transcriptomics》。该方法依赖于贝叶斯模型，旨在解析空间转录组数据中更为精细的细胞类型的，并创建不同组织的细胞组成图谱。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035552" data-ratio="0.4889502762430939" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibH0gEGHX26PQ2zmLccmibqr8kaUgY9qrzC9NnSzPwZlqaXcCqB674z6Q/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="724" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibH0gEGHX26PQ2zmLccmibqr8kaUgY9qrzC9NnSzPwZlqaXcCqB674z6Q/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228154347929</figcaption></figure><p data-tool="mdnice编辑器"><strong>本文将介绍：</strong></p><ul data-tool="mdnice编辑器"><li><section>Cell2location算法的工作流程；</section></li><li><section>使用Python代码实战。</section></li></ul><h3 data-tool="mdnice编辑器">一. Cell2location算法的工作流程</h3><figure data-tool="mdnice编辑器"><img data-imgfileid="100035550" data-ratio="0.3037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibtHh0Qf4xLicshXytsUPGMXHM20rn7dr91HbxIDBbBpGgmibyEjXn7g8A/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibtHh0Qf4xLicshXytsUPGMXHM20rn7dr91HbxIDBbBpGgmibyEjXn7g8A/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228154505635</figcaption></figure><p data-tool="mdnice编辑器">Cell2location采用贝叶斯层次框架。首先使用外部单细胞RNA测序数据作为参考数据，估计细胞类型特异性基因表达特征。然后，通过负二项分布（negative binomial regression）对观察到的空间表达计数矩阵建模，其中均值参数取决于参考细胞类型的特征，过度分散参数使用指数-伽马复合先验建模，旨在使大多数基因具有低过度分散。基因特异性技术灵敏度和基因-位置特异性的加性偏移被包括在均值参数的一部分，每个都使用单独的层次伽马先验进行建模。Cell2location进一步使用层次伽马先验对细胞类型特征的回归权重进行建模，并将回归权重分解为多个潜在组的贡献，这可以解释为具有共享细胞类型丰度特征的斑点，旨在跨具有相似细胞组成的位置借用强度。最后，cell2location采用变分贝叶斯推断来近似后验分布，并相应地生成参数估计。总的来说，Cell2location提供了一种可靠的途径来处理模型中的不确定因素，可以解释细胞类型丰度的线性依存关系。相比于其他的联合分析工具，Cell2location体现了更高的运算效率。</p><p data-tool="mdnice编辑器"><strong>注意Cell2location运行非常慢，建议使用GPU进行加速！</strong></p><h3 data-tool="mdnice编辑器">二. Cell2location代码实现</h3><h4 data-tool="mdnice编辑器">Step0.环境部署</h4><p data-tool="mdnice编辑器">github在https://github.com/BayraktarLab/cell2location#Installation</p><p data-tool="mdnice编辑器">官方教程在：https://cell2location.readthedocs.io/en/latest/</p><p data-tool="mdnice编辑器">可以使用Conda安装Cell2location：</p><pre data-tool="mdnice编辑器"><span></span><code>conda create -y -n cell2loc python=3.9<br><br>conda activate cell2loc<br>pip install cell2location[tutorials]<br></code></pre><p data-tool="mdnice编辑器">如果需要衔接<code>Jupyter notebook</code>使用的话，需要在<code>cell2loc</code>这个环境里安装一下几个插件，然后就能在<code>Jupyter notebook</code>里选择<code>cell2loc</code>这个环境：</p><pre data-tool="mdnice编辑器"><span></span><code>mamba install -y nb_conda_kernels ipykernel<br>python -m ipykernel install --user --name cell2loc --display-name cell2loc<br></code></pre><h4 data-tool="mdnice编辑器">Step1.加载示例数据及预处理</h4><p data-tool="mdnice编辑器">示例数据我们使用上期的<code>CellTrek</code>算法的示例<strong>小鼠皮层数据</strong>【<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487640&amp;idx=1&amp;sn=131cdd1c6067350cf40af0c16e442dd0&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞和空转数据多种方法之CellTrek</a>】。运行流程图：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035553" data-ratio="1.1842592592592593" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib4pXXcaPNY136Irh9HZxVsvGyvnjiaZOWLYPIQs6Wbe3sBXMam1kFBcA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib4pXXcaPNY136Irh9HZxVsvGyvnjiaZOWLYPIQs6Wbe3sBXMam1kFBcA/640?wx_fmt=other&amp;from=appmsg"><figcaption>Figure 1.</figcaption></figure><p data-tool="mdnice编辑器">Python包加载：</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> scanpy <span>as</span> sc<br><span>import</span> numpy <span>as</span> np<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><span>import</span> matplotlib <span>as</span> mpl<br><br><span>import</span> cell2location<br><br><span>from</span> matplotlib <span>import</span> rcParams<br>rcParams[<span>'pdf.fonttype'</span>] = <span>42</span> <span># enables correct plotting of text for PDFs</span><br></code></pre><p data-tool="mdnice编辑器"><strong>注意：cell2location需要count原始数据作为input数据，不能用标准化后的。参考：https://github.com/BayraktarLab/cell2location/issues/249</strong></p><h5 data-tool="mdnice编辑器">1.1 加载示例空转数据：</h5><pre data-tool="mdnice编辑器"><span></span><code>adata_st = sc.read_h5ad(<span>'Step1.brain_st_cortex.h5ad'</span>)<br>adata_st<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span> AnnData object with n_obs × n_vars = 1075 × 31053</span><br><span>    obs: 'in_tissue', 'array_row', 'array_col', 'orig.ident', 'nCount_Spatial', 'nFeature_Spatial', 'slice', 'region', 'id', 'Spatial_snn_res.0.8', 'seurat_clusters', 'keep_idx'</span><br><span>    var: 'vst.mean', 'vst.variance', 'vst.variance.expected', 'vst.variance.standardized', 'vst.variable'</span><br><span>    uns: 'seurat_clusters_colors', 'spatial'</span><br><span>    obsm: 'X_pca', 'X_umap', 'spatial'</span><br></code></pre><p data-tool="mdnice编辑器">检查数据：</p><pre data-tool="mdnice编辑器"><span></span><code>sc.pl.spatial(adata_st, color=<span>'seurat_clusters'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035559" data-ratio="0.6312594840667678" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibbEyIRgHs59q5pmgydqbsdnzZsuMCmROc715wwja7OO3kbiapUkOFGCA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="659" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibbEyIRgHs59q5pmgydqbsdnzZsuMCmROc715wwja7OO3kbiapUkOFGCA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228210651319</figcaption></figure><p data-tool="mdnice编辑器">线粒体编码基因与空间定位无关，因为它们的表达代表单细胞和细胞核数据中的技术产物，而不是线粒体的生物丰度。然而，这些基因在每个位置组成了15-40%的mRNA。<strong>因此，为了避免噪音，我们强烈建议去除线粒体基因：</strong></p><ul data-tool="mdnice编辑器"><li><section><code>mt-</code>小鼠</section></li><li><section><code>MT-</code>人</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span># find mitochondria-encoded (MT) genes</span><br>adata_st.var[<span>'MT_gene'</span>] = [gene.startswith(<span>'mt-'</span>) <span>for</span> gene <span>in</span> adata_st.var.index]<br><br><span># remove MT genes for spatial mapping (keeping their counts in the object)</span><br>adata_st.obsm[<span>'MT'</span>] = adata_st[:, adata_st.var[<span>'MT_gene'</span>].values].X.toarray()<br>adata_st = adata_st[:, ~adata_st.var[<span>'MT_gene'</span>].values]<br>adata_st<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span> View of AnnData object with n_obs × n_vars = 1075 × 31040</span><br><span>    obs: 'in_tissue', 'array_row', 'array_col', 'orig.ident', 'nCount_Spatial', 'nFeature_Spatial', 'slice', 'region', 'id', 'Spatial_snn_res.0.8', 'seurat_clusters', 'keep_idx'</span><br><span>    var: 'vst.mean', 'vst.variance', 'vst.variance.expected', 'vst.variance.standardized', 'vst.variable', 'MT_gene'</span><br><span>    uns: 'seurat_clusters_colors', 'spatial'</span><br><span>    obsm: 'X_pca', 'X_umap', 'spatial', 'MT'</span><br></code></pre><p data-tool="mdnice编辑器">过滤掉一些线粒体基因。</p><h5 data-tool="mdnice编辑器">1.2 加载示例单细胞数据：</h5><pre data-tool="mdnice编辑器"><span></span><code>adata_ref = sc.read_h5ad(<span>'Step1.brain_sc.h5ad'</span>)<br>adata_ref<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span> AnnData object with n_obs × n_vars = 4785 × 34617</span><br><span>    obs: 'orig.ident', 'nCount_RNA', 'nFeature_RNA', 'sample_id', 'sample_type', 'organism', 'donor', 'sex', 'age_days', 'eye_condition', 'genotype', 'driver_lines', 'reporter_lines', 'brain_hemisphere', 'brain_region', 'brain_subregion', 'injection_label_direction', 'injection_primary', 'injection_secondary', 'injection_tract', 'injection_material', 'injection_exclusion_criterion', 'facs_date', 'facs_container', 'facs_sort_criteria', 'rna_amplification_set', 'library_prep_set', 'library_prep_avg_size_bp', 'seq_name', 'seq_tube', 'seq_batch', 'total_reads', 'percent_exon_reads', 'percent_intron_reads', 'percent_intergenic_reads', 'percent_rrna_reads', 'percent_mt_exon_reads', 'percent_reads_unique', 'percent_synth_reads', 'percent_ecoli_reads', 'percent_aligned_reads_total', 'complexity_cg', 'genes_detected_cpm_criterion', 'genes_detected_fpkm_criterion', 'tdt_cpm', 'gfp_cpm', 'class', 'subclass', 'cluster', 'confusion_score', 'cluster_correlation', 'core_intermediate_call', 'id', 'cell_type', 'dbscan_filter'</span><br><span>    var: 'vst.mean', 'vst.variance', 'vst.variance.expected', 'vst.variance.standardized', 'vst.variable'</span><br><span>    obsm: 'X_pca', 'X_umap'</span><br></code></pre><p data-tool="mdnice编辑器">检查数据：</p><pre data-tool="mdnice编辑器"><span></span><code>sc.settings.set_figure_params(dpi=<span>100</span>, dpi_save=<span>300</span>, figsize=(<span>4</span>, <span>4</span>))<br>sc.pl.umap(adata_ref, color=<span>'seurat_clusters'</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035555" data-ratio="0.6697936210131332" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibW8McJOz13D3dB6GLs2d950WSwwSHQPFs3n0dLceHxKbzGhtaEJysPg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="533" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibW8McJOz13D3dB6GLs2d950WSwwSHQPFs3n0dLceHxKbzGhtaEJysPg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228212749887</figcaption></figure><p data-tool="mdnice编辑器"><strong>注意：</strong>在估计参考细胞类型的signature之前，作者建议进行宽松一点的基因选择。作者更推荐于这种方式，而不是标准的高变异基因选择，因为作者的程序保留了罕见基因的标记，同时去除了大多数无信息的基因。</p><p data-tool="mdnice编辑器">默认参数<code>cell_count_cutoff=5，cell_percentage_cutoff2=0.03，nonz_mean_cutoff=1.12</code>比较合适，但是用户可以增加截断值以排除更多的基因。为了保留罕见细胞类型的标记基因，作者建议将<code>cell_count_cutoff</code>设置为较低的值，例如5，但是<code>cell_percentage_cutoff2</code>和n<code>onz_mean_cutoff</code>可以适当增加，可以控制在8,000至16,000个基因。</p><pre data-tool="mdnice编辑器"><span></span><code><span>from</span> cell2location.utils.filtering <span>import</span> filter_genes<br>selected = filter_genes(adata_ref, cell_count_cutoff=<span>5</span>, cell_percentage_cutoff2=<span>0.03</span>, nonz_mean_cutoff=<span>1.12</span>)<br><br><span># filter the object</span><br>adata_ref = adata_ref[:, selected].copy()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035558" data-ratio="0.7688266199649737" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibQ2SJiaFB7plaYibgpiaJljTbBENeDwg9B3ib85AeWUUuMwiaXj5octC1qxg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="571" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibQ2SJiaFB7plaYibgpiaJljTbBENeDwg9B3ib85AeWUUuMwiaXj5octC1qxg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228211554743</figcaption></figure><p data-tool="mdnice编辑器">在这个二维直方图中，橙色矩形突出显示了基于表达该基因的细胞数量（Y轴）和检测到该基因的细胞的平均RNA计数（X轴）的组合而排除的基因。</p><h4 data-tool="mdnice编辑器">Step2. 参考细胞类型特征估计(NB回归)</h4><p data-tool="mdnice编辑器">根据scRNA-seq数据估计特征，考虑批效应，使用负二项回归模型。这个步骤非常慢，最好有GPU加速：</p><p data-tool="mdnice编辑器">首先，为回归模型准备一个数据对象:</p><pre data-tool="mdnice编辑器"><span></span><code><span># prepare anndata for the regression model</span><br>cell2location.models.RegressionModel.setup_anndata(adata=adata_ref,<br>                         batch_key=<span>'orig.ident'</span>, <span># 10X reaction / sample / batch</span><br>                         labels_key=<span>'cell_type'</span> <span># cell type, covariate used for constructing signatures</span><br>                         <span>#categorical_covariate_keys=['Method'] # multiplicative technical effects (platform, 3' vs 5', donor effect)</span><br>                       )<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span># create the regression model</span><br><span>from</span> cell2location.models <span>import</span> RegressionModel<br>mod = RegressionModel(adata_ref)<br><br><span># view anndata_setup as a sanity check</span><br>mod.view_anndata_setup()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035557" data-ratio="1.8179723502304148" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib9Ez9icamiaricfZ968iaiaGqxbRp5vdEZu84NLzeJdPdYOxjLyebpYvo1ww/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="434" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib9Ez9icamiaricfZ968iaiaGqxbRp5vdEZu84NLzeJdPdYOxjLyebpYvo1ww/640?wx_fmt=other&amp;from=appmsg"><figcaption>训练模型。</figcaption></figure><p data-tool="mdnice编辑器">现在我们训练模型以估计参考细胞类型的特征。</p><p data-tool="mdnice编辑器">请注意，为了在您的数据上实现收敛（即获得损失的稳定），用户可能需要增加 <code>max_epochs=250</code>（请参见下文）。</p><p data-tool="mdnice编辑器">还请注意，这里我们使用的 <code>batch_size=2500</code> 要比 scvi-tools 默认值大得多，并对所有数据中的所有细胞进行训练（<code>train_size=1</code>）- 这两个参数都是默认值。</p><pre data-tool="mdnice编辑器"><span></span><code>mod.train(max_epochs=<span>250</span>, use_gpu=<span>True</span>,train_size=<span>1</span>)<br></code></pre><p data-tool="mdnice编辑器">确定模型是否需要更多训练。</p><p data-tool="mdnice编辑器">在这里，我们绘制训练过程中的 ELBO 损失历史，从图中去掉前 20 个 epochs。这个图应该呈下降趋势，并在训练结束时趋于平稳。如果仍在下降，请增加 <code>max_epochs</code>。</p><pre data-tool="mdnice编辑器"><span></span><code>mod.plot_history(<span>20</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035556" data-ratio="1.0566572237960339" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibicesdSwWwIdQ3RExDD6khWEtPgTaDstd4ZQeM5ooK9wcenY5D8NeV3g/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="353" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibicesdSwWwIdQ3RExDD6khWEtPgTaDstd4ZQeM5ooK9wcenY5D8NeV3g/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228215456711</figcaption></figure><blockquote data-tool="mdnice编辑器"><p>上面这幅图就提示我们需要增加<code>max_epochs</code>了，官方教程的图是这样的，在训练结束时趋于平稳：</p><img data-imgfileid="100035560" data-ratio="0.7210031347962382" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibeke93fymB5o1jOlcUNSeRibuPkS1q03svbMfYyQBsibVFOa7Y3nSCtxg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="638" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibeke93fymB5o1jOlcUNSeRibuPkS1q03svbMfYyQBsibVFOa7Y3nSCtxg/640?wx_fmt=other&amp;from=appmsg"></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span># In this section, we export the estimated cell abundance (summary of the posterior distribution).</span><br>adata_ref = mod.export_posterior(<br>    adata_ref, sample_kwargs={<span>'num_samples'</span>: <span>1000</span>, <span>'batch_size'</span>: <span>2500</span>, <span>'use_gpu'</span>: <span>True</span>}<br>)<br><br><span># Save model</span><br>mod.save(<span>"./reference_signatures/"</span>, overwrite=<span>True</span>)<br><br><span># Save anndata object with results</span><br>adata_ref.write(<span>"./sc_cell2location.h5ad"</span>)<br></code></pre><p data-tool="mdnice编辑器">用户可以直接计算后验分布的5%、50%和95%分位数，而不是使用1000个样本（或其他任何分位数）从分布中抽取。这样可以加快在大型数据集上的应用并减少内存需求，但无法用这种方式计算后验均值和标准差。</p><p data-tool="mdnice编辑器">下面使用的是官方的代码报错了：</p><pre data-tool="mdnice编辑器"><span></span><code>adata_ref = mod.export_posterior(<br>    adata_ref, use_quantiles=<span>True</span>,<br>    <span># choose quantiles</span><br>    add_to_obsm=[<span>"q05"</span>,<span>"q50"</span>, <span>"q95"</span>, <span>"q0001"</span>],<br>    sample_kwargs={<span>'batch_size'</span>: <span>2500</span>, <span>'use_gpu'</span>: <span>True</span>}<br>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035561" data-ratio="0.47218259629101283" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibfnPoR6DgAlklVNZ6otuD3M3TRJNwficonOKZT26mq2jKwwicxnsY3s3A/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="701" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibfnPoR6DgAlklVNZ6otuD3M3TRJNwficonOKZT26mq2jKwwicxnsY3s3A/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228215931322</figcaption></figure><p data-tool="mdnice编辑器">我检查了这个函数：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100035563" data-ratio="0.45" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibo7MWH9q6WOHIHfOnUKvg7Mh5xKPaMYLVlUia6IvgSdQKerzrwCb5RxA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibo7MWH9q6WOHIHfOnUKvg7Mh5xKPaMYLVlUia6IvgSdQKerzrwCb5RxA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228220006931</figcaption></figure><p data-tool="mdnice编辑器"><code>add_to_obsm</code>似乎被<code>add_to_varm</code>替换了，更新一下作者的代码，运行就成功了：</p><pre data-tool="mdnice编辑器"><span></span><code>adata_ref = mod.export_posterior(<br>    adata_ref, use_quantiles=<span>True</span>,<br>    <span># choose quantiles</span><br>    add_to_varm=[<span>"q05"</span>,<span>"q50"</span>, <span>"q95"</span>, <span>"q0001"</span>],<br>    sample_kwargs={<span>'batch_size'</span>: <span>2500</span>, <span>'use_gpu'</span>: <span>True</span>}<br>)<br></code></pre><blockquote data-tool="mdnice编辑器"><p>接下来的<code>mod.plot_QC</code>也报错了，我这里跳过：</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span>#报错了，跳过</span><br><span>#mod.plot_QC()</span><br><br><span>#模型和输出的h5ad，可以像这样加载:</span><br>adata_ref = sc.read_h5ad(<span>"./sc_cell2location.h5ad"</span>)<br>mod = cell2location.models.RegressionModel.load(<span>"./reference_signatures/"</span>, adata_ref)<br></code></pre><p data-tool="mdnice编辑器">提取参考细胞类型签名作为<code>pd.DataFrame</code>。</p><p data-tool="mdnice编辑器">负二项回归模型的所有参数都被导出到参考 anndata 对象中，但是对于空间映射，我们只需要每个基因在每个细胞类型中的估计表达。在这里，我们从标准输出中提取这些信息：</p><pre data-tool="mdnice编辑器"><span></span><code><span># export estimated expression in each cluster</span><br><span>if</span> <span>'means_per_cluster_mu_fg'</span> <span>in</span> adata_ref.varm.keys():<br>    inf_aver = adata_ref.varm[<span>'means_per_cluster_mu_fg'</span>][[<span>f'means_per_cluster_mu_fg_<span>{i}</span>'</span><br>                                    <span>for</span> i <span>in</span> adata_ref.uns[<span>'mod'</span>][<span>'factor_names'</span>]]].copy()<br><span>else</span>:<br>    inf_aver = adata_ref.var[[<span>f'means_per_cluster_mu_fg_<span>{i}</span>'</span><br>                                    <span>for</span> i <span>in</span> adata_ref.uns[<span>'mod'</span>][<span>'factor_names'</span>]]].copy()<br>inf_aver.columns = adata_ref.uns[<span>'mod'</span>][<span>'factor_names'</span>]<br>inf_aver.iloc[<span>0</span>:<span>5</span>, <span>0</span>:<span>15</span>]<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035564" data-ratio="0.17592592592592593" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibEicW3UcwYI96gD8XVM86gWmibBDNB3vXMZZM12TiawEspLicpDI0DEN3HA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibEicW3UcwYI96gD8XVM86gWmibBDNB3vXMZZM12TiawEspLicpDI0DEN3HA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228220607391</figcaption></figure><h4 data-tool="mdnice编辑器">Step3. Cell2location: spatial mapping</h4><p data-tool="mdnice编辑器">寻找共享基因，准备数据。基于参考signature，对空转数据取子集:</p><pre data-tool="mdnice编辑器"><span></span><code><span># find shared genes and subset both anndata and reference signatures</span><br>intersect = np.intersect1d(adata_st.var_names, inf_aver.index)<br>adata_st = adata_st[:, intersect].copy()<br>inf_aver = inf_aver.loc[intersect, :].copy()<br><br><span># prepare anndata for cell2location model</span><br>cell2location.models.Cell2location.setup_anndata(adata=adata_st, batch_key=<span>"orig.ident"</span>)<br></code></pre><p data-tool="mdnice编辑器"><strong>重要提示：</strong> 要使用cell2location空间映射模型，用户需要指定两个超参数（<code>N_cells_per_location</code>和<code>detection_alpha</code>）。有关设置这些超参数及其影响的详细指导，请参阅流程图和说明。</p><blockquote data-tool="mdnice编辑器"><p>这个cell2location好多重要提示。。。</p></blockquote><ul data-tool="mdnice编辑器"><li><section>选择超参数 <code>N_cells_per_location</code>！</section></li></ul><p data-tool="mdnice编辑器">将预期的每个组织位置的细胞丰度N_cells_per_location调整到实际组织情况是很有用的。这个值可以从成对的组织学图像中估计，如上面的说明所述。请将本教程中呈现的值（N_cells_per_location=30）更改为您的组织中观察到的值。</p><ul data-tool="mdnice编辑器"><li><section>选择超参数 <code>detection_alpha</code>！</section></li></ul><p data-tool="mdnice编辑器">为了提高在幻灯片/批次内RNA检测敏感性存在较大技术变异性的数据集上的准确性和灵敏性 - 用户需要放宽对每个位置规范化的正则化（使用detection_alpha=20）。当用户观察到每个位置的总RNA计数的空间分布与基于组织学检查的预期细胞数不匹配时，说明在用户的样本中存在较大的RNA检测敏感性技术变异性。</p><p data-tool="mdnice编辑器">作者最初选择高正则化（detection_alpha=200）作为默认值，因为作者在论文中使用的小鼠大脑和人类淋巴结数据集具有较低的技术效应，并且使用高正则化强度提高了每个位置的总估计细胞丰度与组织学定量核数之间的一致性（请参见cell2location论文的图S8F）。然而，在许多合作中，作者发现在人类组织的Visium实验中存在技术效应。这促使了将detection_alpha的新默认值设为20以及建议在用户的数据上测试这两个设置（detection_alpha=20和detection_alpha=200）。</p><pre data-tool="mdnice编辑器"><span></span><code><span># create and train the model</span><br>mod = cell2location.models.Cell2location(<br>    adata_st, cell_state_df=inf_aver,<br>    <span># the expected average cell abundance: tissue-dependent</span><br>    <span># hyper-prior which can be estimated from paired histology:</span><br>    N_cells_per_location=<span>30</span>,<br>    <span># hyperparameter controlling normalisation of</span><br>    <span># within-experiment variation in RNA detection:</span><br>    detection_alpha=<span>20</span><br>)<br>mod.view_anndata_setup()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035562" data-ratio="1.2104377104377104" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibXMIicBBpyiaMXuIJ281w0ceDW9z2mIyTeQgEhqBXBsspTxGicXewMcXBQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="594" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibXMIicBBpyiaMXuIJ281w0ceDW9z2mIyTeQgEhqBXBsspTxGicXewMcXBQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228221410647</figcaption></figure><p data-tool="mdnice编辑器"><strong>Training cell2location（这个步骤非常慢）:</strong></p><pre data-tool="mdnice编辑器"><span></span><code>mod.train(max_epochs=<span>30000</span>,<br>          <span># train using full data (batch_size=None)</span><br>          batch_size=<span>None</span>,<br>          <span># use all data points in training because</span><br>          <span># we need to estimate cell abundance at all locations</span><br>          train_size=<span>1</span>,<br>          use_gpu=<span>True</span>,<br>         )<br><br><span># plot ELBO loss history during training, removing first 100 epochs from the plot</span><br>mod.plot_history(<span>1000</span>)<br>plt.legend(labels=[<span>'full data training'</span>]);<br></code></pre><p data-tool="mdnice编辑器">这里我遇到报错了:</p><pre data-tool="mdnice编辑器"><span></span><code><span>    ValueError: Expected value argument (Tensor of shape (2500, 20925)) to be within the support (IntegerGreaterThan(lower_bound=0)) of the distribution GammaPoisson(), but found invalid values:</span><br><span>    tensor([[0.0000, 0.9725, 0.9725, ..., 0.0000, 0.0000, 0.0000],</span><br><span>    [0.0000, 0.0000, 0.0000, ..., 0.0000, 0.0000, 0.0000],</span><br><span>    [0.0000, 0.0000, 0.0000, ..., 0.0000, 0.0000, 0.0000],</span><br><span>    ...,</span><br><span>    [0.0000, 0.0000, 0.0000, ..., 0.0000, 0.0000, 0.0000],</span><br><span>    [0.0000, 0.0000, 0.0000, ..., 0.0000, 0.0000, 0.0000],</span><br><span>    [0.0000, 0.0000, 0.0000, ..., 0.0000, 0.0000, 0.0000]],</span><br><span>    device='cuda:0')</span><br></code></pre><p data-tool="mdnice编辑器">查了github：</p><ul data-tool="mdnice编辑器"><li><section>https://github.com/BayraktarLab/cell2location/issues/128</section></li><li><section>https://github.com/BayraktarLab/cell2location/issues/120</section></li></ul><p data-tool="mdnice编辑器">原来是我的空转数据不是raw count数据，我重新把空转数据读入scanpy...这里跳过这个debug步骤，<strong>再次强调：cell2location的单细胞和空转需要raw count数据作为input！</strong></p><p data-tool="mdnice编辑器"><strong>另外，遇到报错不用紧张，多查查github或者是中英文帖子，如果一个算法不是很小众的话，基本会有答案的！</strong></p><p data-tool="mdnice编辑器">这里为了节省时间，我没有跑30000次迭代（在GPU的加速下需要运行50分钟），而是选择了300次，在GPU的加速下运行1分钟不到。</p><h4 data-tool="mdnice编辑器">Step4. 导出预测的细胞丰度结果</h4><pre data-tool="mdnice编辑器"><span></span><code><span># In this section, we export the estimated cell abundance (summary of the posterior distribution).</span><br>adata_st = mod.export_posterior(<br>    adata_st, sample_kwargs={<span>'num_samples'</span>: <span>1000</span>, <span>'batch_size'</span>: mod.adata.n_obs, <span>'use_gpu'</span>: <span>True</span>}<br>)<br><br><span># Save model</span><br>mod.save(<span>"./cell2location_map/"</span>, overwrite=<span>True</span>)<br><br><span># Save anndata object with results</span><br>adata_st.write(<span>"./cell2location_map/st_cell2location_res.h5ad"</span>)<br></code></pre><p data-tool="mdnice编辑器">模型和输出h5ad，可以像这样重新加载：</p><pre data-tool="mdnice编辑器"><span></span><code>adata_st = sc.read_h5ad(<span>"./cell2location_map/st_cell2location_res.h5ad"</span>)<br>mod = cell2location.models.Cell2location.load(<span>"./cell2location_map/"</span>, adata_st)<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>mod.plot_QC()<br><span>#fig = mod.plot_spatial_QC_across_batches()</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035566" data-ratio="0.8723404255319149" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib2xPcHI9jQImWGpn4lBtVc5nQDkgULicsWpcyv3c4TacTYsbS6Io7Z6g/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="376" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib2xPcHI9jQImWGpn4lBtVc5nQDkgULicsWpcyv3c4TacTYsbS6Io7Z6g/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231229105129862</figcaption></figure><p data-tool="mdnice编辑器">图形呈对角线状说明质量较好。</p><p data-tool="mdnice编辑器">导出预测的细胞丰度结果为csv文件：</p><blockquote data-tool="mdnice编辑器"><p>作者建议使用后验分布的5%分位数的结果，表示模型具有高置信度的细胞丰度值(即“至少存在这个数量”)。结果在<code>adata_st.obsm</code>下：</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code>adata_st.obsm<br><span>#AxisArrays with keys: spatial, MT, means_cell_abundance_w_sf, stds_cell_abundance_w_sf, q05_cell_abundance_w_sf, q95_cell_abundance_w_sf</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>pd.DataFrame(adata_st.obsm[<span>'q05_cell_abundance_w_sf'</span>]).to_csv(<span>"./cell2location_map/st_cell2location_res.csv"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035569" data-ratio="0.3675925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibVwmAbH9xiacIjdfJ2YgFh4VNexCia0I9jf2gjticicmRiaaczMGd9He5eag/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibVwmAbH9xiacIjdfJ2YgFh4VNexCia0I9jf2gjticicmRiaaczMGd9He5eag/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228231738126</figcaption></figure><blockquote data-tool="mdnice编辑器"><p>这个结果可能对Python党来说没啥用，作为R语言老用户，我觉得可以读到Seurat对象里进行可视化。</p></blockquote><h4 data-tool="mdnice编辑器">Step5. 可视化</h4><blockquote data-tool="mdnice编辑器"><p>终于到可视化环节了，<code>cell2location</code>运行确实有点慢...</p></blockquote><p data-tool="mdnice编辑器">作者建议使用后验分布的5%分位数的结果，表示模型具有高置信度的细胞丰度值(即“至少存在这个数量”):</p><pre data-tool="mdnice编辑器"><span></span><code><span># add 5% quantile, representing confident cell abundance, 'at least this amount is present',</span><br><span># to adata.obs with nice names for plotting</span><br>adata_vis.obs[adata_vis.uns[<span>'mod'</span>][<span>'factor_names'</span>]] = adata_vis.obsm[<span>'q05_cell_abundance_w_sf'</span>]<br>adata_st.obsm[<span>'q05_cell_abundance_w_sf'</span>]<br></code></pre><p data-tool="mdnice编辑器">我们这里只有一张切片，就不用跑这个步骤了<code>slide = select_slide(adata_vis, 'V1_Human_Lymph_Node')</code></p><pre data-tool="mdnice编辑器"><span></span><code><span># select one slide</span><br><span>from</span> cell2location.utils <span>import</span> select_slide<br><span>#slide = select_slide(adata_vis, 'V1_Human_Lymph_Node')</span><br><br><span># plot in spatial coordinates</span><br><span>with</span> mpl.rc_context({<span>'axes.facecolor'</span>:  <span>'black'</span>,<br>                     <span>'figure.figsize'</span>: [<span>4.5</span>, <span>5</span>]}):<br><br>    sc.pl.spatial(adata_st, cmap=<span>'magma'</span>,<br>                  <span># show first 8 cell types</span><br>                  color=[<span>'L6 CT'</span>, <span>'L5 IT'</span>, <span>'L6b'</span>, <span>'L2/3 IT'</span>, <span>'L4'</span>, <span>'Astro'</span>],<br>                  ncols=<span>4</span>, size=<span>1.3</span>,<br>                  img_key=<span>'lowres'</span>,<br>                  <span># limit color scale at 99.2% quantile of cell abundance</span><br>                  vmin=<span>0</span>, vmax=<span>'p99.2'</span><br>                 )<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035568" data-ratio="0.4722222222222222" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib6eC9uWz74ZajHL21LYvRy8KUPL7RFz1V6ibZ3FxjrAb2FxibWQfgjFZQ/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib6eC9uWz74ZajHL21LYvRy8KUPL7RFz1V6ibZ3FxjrAb2FxibWQfgjFZQ/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228230033246</figcaption></figure><blockquote data-tool="mdnice编辑器"><p>我不是很懂皮层，可以参考了Seurat官网的结果，可以看到cell2location预测还是比较准确的：</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100035565" data-ratio="1.1315068493150684" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib8icYDub6I4KrgE81gjfZ6icASTusJsDGU9Fib1tGMP4hETzABibwP1hTYw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="730" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib8icYDub6I4KrgE81gjfZ6icASTusJsDGU9Fib1tGMP4hETzABibwP1hTYw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228225831646</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span># Now we use cell2location plotter that allows showing multiple cell types in one panel</span><br><span>from</span> cell2location.plt <span>import</span> plot_spatial<br><br><span># select up to 6 clusters</span><br>clust_labels = [<span>'L6 CT'</span>, <span>'L5 IT'</span>, <span>'L6b'</span>]<br>clust_col = [<span>''</span> + str(i) <span>for</span> i <span>in</span> clust_labels] <span># in case column names differ from labels</span><br><br><span>#slide = select_slide(adata_st, 'V1_Human_Lymph_Node')</span><br><br><span>with</span> mpl.rc_context({<span>'figure.figsize'</span>: (<span>10</span>, <span>10</span>)}):<br>    fig = plot_spatial(<br>        adata=adata_st,<br>        <span># labels to show on a plot</span><br>        color=clust_col, labels=clust_labels,<br>        show_img=<span>True</span>,<br>        img_key=<span>'lowres'</span>,<br>        <span># 'fast' (white background) or 'dark_background'</span><br>        style=<span>'fast'</span>,<br>        <span># limit color scale at 99.2% quantile of cell abundance</span><br>        max_color_quantile=<span>0.992</span>,<br>        <span># size of locations (adjust depending on figure size)</span><br>        circle_diameter=<span>6</span>,<br>        colorbar_position=<span>'right'</span><br>    )<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035567" data-ratio="0.7014925373134329" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibBHYPicffOrX60wuiaKqfPYOiboSoYX5SHZiceVfMMpdtvB4e7MOriaYIF1w/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="804" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibBHYPicffOrX60wuiaKqfPYOiboSoYX5SHZiceVfMMpdtvB4e7MOriaYIF1w/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228230852858</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span># Now we use cell2location plotter that allows showing multiple cell types in one panel</span><br><span>from</span> cell2location.plt <span>import</span> plot_spatial<br><br><span># select up to 6 clusters</span><br>clust_labels = [<span>'L6 CT'</span>, <span>'L5 IT'</span>, <span>'L6b'</span>]<br>clust_col = [<span>''</span> + str(i) <span>for</span> i <span>in</span> clust_labels] <span># in case column names differ from labels</span><br><br><span>#slide = select_slide(adata_st, 'V1_Human_Lymph_Node')</span><br><br><span>with</span> mpl.rc_context({<span>'figure.figsize'</span>: (<span>10</span>, <span>10</span>)}):<br>    fig = plot_spatial(<br>        adata=adata_st,<br>        <span># labels to show on a plot</span><br>        color=clust_col, labels=clust_labels,<br>        show_img=<span>False</span>,<br>        img_key=<span>'lowres'</span>,<br>        <span># 'fast' (white background) or 'dark_background'</span><br>        style=<span>'fast'</span>,<br>        <span># limit color scale at 99.2% quantile of cell abundance</span><br>        max_color_quantile=<span>0.992</span>,<br>        <span># size of locations (adjust depending on figure size)</span><br>        circle_diameter=<span>6</span>,<br>        colorbar_position=<span>'right'</span><br>    )<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035573" data-ratio="0.6658385093167701" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibIhiaZ3M0e1kiazNpPQaoncrSnvSohj7rPq1HWFAP89Ffib6h48jc0WLbw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="805" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibIhiaZ3M0e1kiazNpPQaoncrSnvSohj7rPq1HWFAP89Ffib6h48jc0WLbw/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231228230914261</figcaption></figure><h4 data-tool="mdnice编辑器">Step6. 下游分析</h4><h5 data-tool="mdnice编辑器">6.1 用Leiden聚类识别离散组织区域</h5><p data-tool="mdnice编辑器">通过使用由cell2location估计的细胞丰度对位置进行聚类，我们识别在细胞组成方面存在差异的组织区域。</p><p data-tool="mdnice编辑器">通过使用每种细胞类型的估计细胞丰度对Visium点进行聚类，我们找到组织区域。我们构建一个表示在估计的细胞丰度中位置相似性的K最近邻（KNN）图，然后应用Leiden聚类。KNN邻居的数量应根据数据集的大小和解剖学定义的区域大小进行调整（例如，与大脑的大小相比，海马区域相对较小，因此可能被大量邻居掩盖）。可以在一系列的KNN邻居和Leiden聚类分辨率下执行此操作，直到获得与组织解剖结构匹配的聚类。</p><p data-tool="mdnice编辑器">聚类是在所有Visium截面/批次中共同完成的，因此区域身份是直接可比的。当存在多个批次之间的强技术效应时（在本例中并非如此），原则上可以使用sc.external.pp.bbknn来在KNN构建过程中考虑这些效应。</p><blockquote data-tool="mdnice编辑器"><p>下图的seurat_clusters是来自seurat的无监督聚类结果，可以看到除了分辨率设置高低的区别以外，scanpy与Seurat的亚群大致是对应的（包含关系）。</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span># compute UMAP using KNN graph based on the cell2location output</span><br>sc.tl.umap(adata_st, min_dist = <span>0.3</span>, spread = <span>1</span>)<br><br><span># show regions in UMAP coordinates</span><br><span>with</span> mpl.rc_context({<span>'axes.facecolor'</span>:  <span>'white'</span>,<br>                     <span>'figure.figsize'</span>: [<span>5</span>, <span>5</span>]}):<br>    sc.pl.umap(adata_st, color=[<span>'seurat_clusters'</span>,<span>'region_cluster'</span>], size=<span>30</span>,<br>               color_map = <span>'RdPu'</span>, ncols = <span>2</span>, legend_loc=<span>'on data'</span>,<br>               legend_fontsize=<span>20</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035570" data-ratio="0.4672395273899033" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibXJXU8bX9qyAFUM3f8zNggw99j77wfyz9gy2L2aK7aHXNtNp7mbInfg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="931" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibXJXU8bX9qyAFUM3f8zNggw99j77wfyz9gy2L2aK7aHXNtNp7mbInfg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231229114655817</figcaption></figure><pre data-tool="mdnice编辑器"><span></span><code><span># plot in spatial coordinates</span><br><span>with</span> mpl.rc_context({<span>'axes.facecolor'</span>:  <span>'black'</span>,<br>                     <span>'figure.figsize'</span>: [<span>4.5</span>, <span>5</span>]}):<br>    sc.pl.spatial(adata_st, color=[<span>'seurat_clusters'</span>,<span>'region_cluster'</span>],<br>                  size=<span>1.3</span>, img_key=<span>'lowres'</span>, alpha=<span>0.5</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035572" data-ratio="0.34126163391933817" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib4jzliavKibOA7bjVNtYpzDa9Xc4AbR1ux1OqnmxNB7WYLHlKj9vcdxGA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="967" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib4jzliavKibOA7bjVNtYpzDa9Xc4AbR1ux1OqnmxNB7WYLHlKj9vcdxGA/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231229114516433</figcaption></figure><h5 data-tool="mdnice编辑器">6.2 使用矩阵分解(NMF)识别细胞区室/组织区</h5><p data-tool="mdnice编辑器">在这里，我们使用cell2location映射结果来识别细胞类型的空间共存，以更好地理解组织结构并预测细胞间的相互作用。我们对来自cell2location的细胞类型丰度估计进行了非负矩阵分解（NMF）。类似于将NMF应用于常规scRNA-seq的已建立的优势，加性NMF分解将空间细胞类型丰度文件组成组件，捕获共定位的细胞类型。这种基于NMF的分解自然地考虑了多个细胞类型和微环境可以在同一Visium位置共存的事实，同时在组织区域之间共享信息。</p><p data-tool="mdnice编辑器"><strong>提示：</strong></p><p data-tool="mdnice编辑器">在实践中，最好对一系列因子<code>R=5,..,30</code>进行NMF训练，并选择合适的R。</p><p data-tool="mdnice编辑器">如果要找到一些最明显的细胞区，使用较少的因子。如果要找到非常强的共定位信号并假设大多数细胞类型不共定位，则使用大量因子（&gt;30）。</p><p data-tool="mdnice编辑器">下面作者展示了如何执行这个分析。作者将NMF包装成一个pipeline：</p><pre data-tool="mdnice编辑器"><span></span><code><span>from</span> cell2location <span>import</span> run_colocation<br>res_dict, adata_st = run_colocation(<br>    adata_st,<br>    model_name=<span>'CoLocatedGroupsSklearnNMF'</span>,<br>    train_args={<br>      <span>'n_fact'</span>: np.arange(<span>11</span>, <span>13</span>), <span># IMPORTANT: use a wider range of the number of factors (5-30)</span><br>      <span>'sample_name_col'</span>: <span>'orig.ident'</span>, <span># columns in adata_vis.obs that identifies sample</span><br>      <span>'n_restarts'</span>: <span>3</span> <span># number of training restarts</span><br>    },<br>    <span># the hyperparameters of NMF can be also adjusted:</span><br>    model_kwargs={<span>'alpha'</span>: <span>0.01</span>, <span>'init'</span>: <span>'random'</span>, <span>"nmf_kwd_args"</span>: {<span>"tol"</span>: <span>0.000001</span>}},<br>    export_args={<span>'path'</span>: <span>'./CoLocatedComb/'</span>}<br>)<br></code></pre><p data-tool="mdnice编辑器">对于每个因子编号，模型都会生成以下文件夹输出列表：</p><ul data-tool="mdnice编辑器"><li><section><p><code>cell_type_fractions_heatmap/</code>”：细胞类型（行）在NMF组件（列）上估计的NMF权重的点图；</p></section></li><li><section><p><code>cell_type_fractions_mean/</code>：用于点图的数据</p></section></li><li><section><p><code>factor_markers/</code>：列出每个NMF因子最具特异性的前10个细胞类型的表格</p></section></li><li><section><p><code>models/</code>：保存的NMF模型</p></section></li><li><section><p><code>predictive_accuracy/</code>：2D直方图绘图，显示NMF如何解释cell2location输出</p></section></li><li><section><p><code>spatial/</code>：空间坐标中位置上的NMF权重</p></section></li><li><section><p><code>location_factors_mean/</code>：用于空间坐标图的数据</p></section></li><li><section><p><code>stability_plots/</code>：在训练重新启动之间NMF权重的稳定性</p></section></li></ul><p data-tool="mdnice编辑器">提示：</p><p data-tool="mdnice编辑器">NMF模型的输出，如因子加载，存储在<code>adata.uns[f"mod_coloc_n_fact{n_fact}"]</code>中，格式与<code>adata.uns['mod']</code>中的主要cell2location结果类似。</p><pre data-tool="mdnice编辑器"><span></span><code><span># Here we plot the NMF weights (Same as saved to `cell_type_fractions_heatmap`)</span><br>res_dict[<span>'n_fact12'</span>][<span>'mod'</span>].plot_cell_type_loadings()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035571" data-ratio="1.0382059800664452" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib1qUpJQibMS7FXkZE7eXLAhkYYQ8FObSzRlIibt6oOKEmSaWhb4Ktg96w/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="602" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjib1qUpJQibMS7FXkZE7eXLAhkYYQ8FObSzRlIibt6oOKEmSaWhb4Ktg96w/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231229125151536</figcaption></figure><h5 data-tool="mdnice编辑器">6.3 估计空间数据中每个基因的细胞类型特异性表达</h5><p data-tool="mdnice编辑器">在空间坐标中绘制基因的细胞类型特异性表达。</p><pre data-tool="mdnice编辑器"><span></span><code><span># Compute expected expression per cell type</span><br>expected_dict = mod.module.model.compute_expected_per_cell_type(<br>    mod.samples[<span>"post_sample_q05"</span>], mod.adata_manager<br>)<br><br><span># Add to anndata layers</span><br><span>for</span> i, n <span>in</span> enumerate(mod.factor_names_):<br>    adata_st.layers[n] = expected_dict[<span>'mu'</span>][i]<br><br><span># Save anndata object with results</span><br><span>#adata_st.write("./sp.h5ad")</span><br></code></pre><p data-tool="mdnice编辑器">遇到报错了，解决方案：</p><ul data-tool="mdnice编辑器"><li><section>https://github.com/BayraktarLab/cell2location/issues/302</section></li><li><section>https://github.com/BayraktarLab/cell2location/issues/143</section></li></ul><p data-tool="mdnice编辑器">运行上述代码前需要先运行：</p><pre data-tool="mdnice编辑器"><span></span><code>mod.samples = adata_st.uns[<span>'mod'</span>]<br></code></pre><p data-tool="mdnice编辑器">然后运行：</p><pre data-tool="mdnice编辑器"><span></span><code><span># Compute expected expression per cell type</span><br>expected_dict = mod.module.model.compute_expected_per_cell_type(<br>    mod.samples[<span>"post_sample_q05"</span>], mod.adata_manager<br>)<br><br><span># Add to anndata layers</span><br><span>for</span> i, n <span>in</span> enumerate(mod.factor_names_):<br>    adata_st.layers[n] = expected_dict[<span>'mu'</span>][i]<br><br><span># Save anndata object with results</span><br><span>#adata_st.write("./sp.h5ad")</span><br></code></pre><blockquote data-tool="mdnice编辑器"><p>下面的可视化部分也有bug，主要是plot_genes_per_cell_type这个绘图函数没有封装进cell2location 【ModuleNotFoundError: No module named 'tutorial_utils'】，解决方案https://github.com/BayraktarLab/cell2location/issues/280；</p><p>原因是plot_genes_per_cell_type这个函数适合用来运行作者的示例数据，但是不适合我们自己的数据，所以作者没把这个函数封装进python包。</p><p>这里我对plot_genes_per_cell_type函数改造了一下：</p></blockquote><pre data-tool="mdnice编辑器"><span></span><code><span><span>def</span> <span>plot_genes_per_cell_type</span><span>(slide, genes, ctypes)</span>:</span><br>    slide.var[<span>'SYMBOL'</span>] = slide.var.index<br>    n_genes = len(genes)<br>    n_ctypes = len(ctypes)<br>    fig, axs = plt.subplots(<br>        nrows=n_genes, ncols=n_ctypes + <span>1</span>, figsize=(<span>4.5</span> * (n_ctypes + <span>1</span>) + <span>2</span>, <span>5</span> * n_genes + <span>1</span>), squeeze=<span>False</span><br>    )<br>    <span># axs = axs.reshape((n_genes, n_ctypes+1))</span><br><br>    <span># plots of every gene</span><br>    <span>for</span> j <span>in</span> range(n_genes):<br>        <span># limit color scale at 99.2% quantile of gene expression (computed across cell types)</span><br>        quantile_across_ct = np.array(<br>            [<br>                np.quantile(slide.layers[n][:, slide.var[<span>"SYMBOL"</span>] == genes[j]].toarray(), <span>0.992</span>)<br>                <span>for</span> n <span>in</span> slide.uns[<span>"mod"</span>][<span>"factor_names"</span>]<br>            ]<br>        )<br>        quantile_across_ct = np.partition(quantile_across_ct.flatten(), <span>-2</span>)[<span>-2</span>]<br>        sc.pl.spatial(<br>            slide,<br>            cmap=<span>"magma"</span>,<br>            color=genes[j],<br>            <span># layer=ctypes[i],</span><br>            <span>#gene_symbols="SYMBOL",</span><br>            ncols=<span>4</span>,<br>            size=<span>1.3</span>,<br>            <span>#img_key="hires",</span><br>            <span># limit color scale at 99.2% quantile of gene expression</span><br>            vmin=<span>0</span>,<br>            vmax=<span>"p99.2"</span>,<br>            ax=axs[j, <span>0</span>],<br>            show=<span>False</span>,<br>        )<br><br>        <span># plots of every cell type</span><br>        <span>for</span> i <span>in</span> range(n_ctypes):<br>            sc.pl.spatial(<br>                slide,<br>                cmap=<span>"magma"</span>,<br>                color=genes[j],<br>                layer=ctypes[i],<br>                gene_symbols=<span>"SYMBOL"</span>,<br>                ncols=<span>4</span>,<br>                size=<span>1.3</span>,<br>                <span>#img_key="hires",</span><br>                <span># limit color scale at 99.2% quantile of gene expression</span><br>                vmin=<span>0</span>,<br>                vmax=quantile_across_ct,<br>                ax=axs[j, i + <span>1</span>],<br>                show=<span>False</span>,<br>            )<br>            axs[j, i + <span>1</span>].set_title(<span>f"<span>{genes[j]}</span> <span>{ctypes[i]}</span>"</span>)<br><br>    <span>return</span> fig, axs<br></code></pre><p data-tool="mdnice编辑器">然后运行就成功了：</p><pre data-tool="mdnice编辑器"><span></span><code><span># list cell types and genes for plotting</span><br>ctypes = [<span>'L6 CT'</span>, <span>'L5 IT'</span>, <span>'L6b'</span>]<br>genes = [<span>"Hpca"</span>, <span>"Plp1"</span>]<br><br><span>with</span> mpl.rc_context({<span>'axes.facecolor'</span>:  <span>'black'</span>}):<br>    <span># select one slide</span><br>    <span># slide = select_slide(adata_vis, 'V1_Human_Lymph_Node')</span><br>    plot_genes_per_cell_type(adata_st, genes,ctypes);<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100035574" data-ratio="0.5462962962962963" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibBr5LzgYBt8XCA9r3fyLHZ59Mia2QPPtGgFjCiajRwic2J3014eAp4exLg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2Los9mfprXKtXRicpGUUN4oUkjibBr5LzgYBt8XCA9r3fyLHZ59Mia2QPPtGgFjCiajRwic2J3014eAp4exLg/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20231229143541554</figcaption></figure><blockquote data-tool="mdnice编辑器"><p>我不太懂皮层，所以随便找了几个基因做可视化展示。</p></blockquote><p data-tool="mdnice编辑器">除了这些可视化内容，cell2location还有一些个性化绘图内容，有机会我们再做介绍！</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Y1rBQh-G7R_EaEdNMENHdA",target="_blank" rel="noopener noreferrer">原文链接</a>
