---
title: "不是造假胜似造假的单细胞降维聚类分群"
date: 2024-09-28T12:27:40Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
不是造假胜似造假的单细胞降维聚类分群 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>胃癌单细胞数据集GSE163558，我做了解读，详见 ：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533053&amp;idx=1&amp;sn=bd155638b280e875dcae14622198b65b&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录组降维聚类分群过滤基因和过滤细胞的区别</a> 。而且前面已经是完成了降维聚类分群，在<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533061&amp;idx=1&amp;sn=de67737df31c0302667d9c7a75214415&amp;scene=21#wechat_redirect" data-linktype="2">学习单细胞亚群命名的层次结构</a> 演示了一个降维聚类分群结果。</p></blockquote><p data-tool="mdnice编辑器">然后大家就可以使用这个全流程代码去处理任意单细胞转录组数据集，但是每个数据都有自己的特殊性。比如一个小伙伴就马不停蹄的处理了2021发表在NG的乳腺癌单细胞数据集：《A single-cell and spatially resolved atlas of human breast cancers》，文献里面给出来的是如下所示第一层次降维聚类分群结果：</p><p><img data-galleryid="" data-imgfileid="100049985" data-ratio="0.5" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMz2icgBYYib6tD3U4r4bqrPGWUhOV08maen0xbgLHDPN4FJH3zegmhIQ7g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMz2icgBYYib6tD3U4r4bqrPGWUhOV08maen0xbgLHDPN4FJH3zegmhIQ7g/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>第一层次降维聚类分群结果</figcaption></figure><p data-tool="mdnice编辑器">可以看到，并没有我们授课的数据集那样的不同单细胞亚群的泾渭分明。这个乳腺癌单细胞数据集id是GSE176078，需要去geo官网下载这个500多M的文件：GSE176078_Wu_etal_2021_BRCA_scRNASeq.tar.gz 然后解压后分开读取，代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code><span>if</span>(T){<br>  library(data.table)<br>  library(Matrix) <br>  <span># https://hbctraining.github.io/scRNA-seq/lessons/readMM_loadData.html</span><br>  <span>#  </span><br>  mtx=readMM(<span>'Wu_etal_2021_BRCA_scRNASeq/count_matrix_sparse.mtx.gz'</span>)<br>  mtx<br>  dim(mtx)<br>  <span># 10万细胞，3万基因 </span><br>  cl=fread(<span>'Wu_etal_2021_BRCA_scRNASeq/count_matrix_barcodes.tsv.gz'</span>,<br>           header = F,data.table = F ) <br>  head(cl)<br>  rl=fread(<span>'Wu_etal_2021_BRCA_scRNASeq/count_matrix_genes.tsv.gz'</span>,<br>           header = F,data.table = F ) <br>  head(cl)<br>  head(rl)<br>  dim(mtx)<br>  colnames(mtx) &lt;- cl<span>$V1</span><br>  rownames(mtx) &lt;-  rl<span>$V1</span><br>  meta = fread(<span>'Wu_etal_2021_BRCA_scRNASeq/metadata.csv.gz'</span>)<br>  <br>  sce.all=CreateSeuratObject(counts =  mtx , <br>                             <span>#meta.data = meta,</span><br>                             min.cells = 5,<br>                             min.features = 300 )<br>  as.data.frame(sce.all@assays<span>$RNA</span><span>$counts</span>[1:10, 1:2])<br>  head(sce.all@meta.data, 10)<br> sort( table(sce.all<span>$orig</span>.ident))<br>length( table(sce.all<span>$orig</span>.ident))  <br>}<br><br></code></pre><p data-tool="mdnice编辑器">我们自己做降维聚类分群会得到看起来确实是不那么好看的UMAP图，如下所示 ：</p><p><img data-galleryid="" data-imgfileid="100049986" data-ratio="1.2185185185185186" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMzMTZIHicTCQ5a9WlWic8afPOJq1PS1ZsPMWYgg5Uc59wMvp200PYle9iaw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMzMTZIHicTCQ5a9WlWic8afPOJq1PS1ZsPMWYgg5Uc59wMvp200PYle9iaw/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>不那么好看的UMAP图</figcaption></figure><p data-tool="mdnice编辑器">实际上，我们并不需要在乎这个颜值，因为我们对单细胞表达量矩阵做降维聚类分群其实是为了给每个单细胞一个身份而已，只需要身份本身没有错误，或者没有很大的冲突， 就不需要介意umap图上面的斑点。不同数据分析流程最后拿到了每个细胞身份是可以比较的，详见：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533087&amp;idx=1&amp;sn=0397ea00da43ef1de3dc5119480b4692&amp;scene=21#wechat_redirect" data-linktype="2">没有绝对正确的单细胞转录组质量控制指标</a>。</p><h3 data-tool="mdnice编辑器"><span></span><span>如果一定要让每个亚群泾渭分明呢</span><span></span></h3><p data-tool="mdnice编辑器">我在 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533595&amp;idx=1&amp;sn=87d9f3e71c78a803c356c30a6a4b6a89&amp;scene=21#wechat_redirect" data-linktype="2">有监督的挑选了特征之后的无监督的分析还可靠吗</a> 跟大家讨论了<strong>层次聚类或者pca分析这样的无监督数据分析方法理论上是本应该是在数据前期处理做有监督的挑选</strong>，比如选择了差异基因，就显得很刻意。</p><p data-tool="mdnice编辑器">但是，<strong>如果我们本来就是要做有监督的分析，比如降维聚类分群后想把不同单细胞亚群泾渭分明的区分开， 那么就可以在数据前期处理做有监督的挑选</strong>，比如我们仅仅是挑选那些不同单细胞亚群的特异性高表达量基因去做降维聚类分群。代码如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>input_sce=CreateSeuratObject(<br>  counts = sce.all@assays$RNA$counts,<br>  meta.data = sce.all@meta.data<br>)<br>print(dim(input_sce))<br>input_sce &lt;- NormalizeData(input_sce, <br>                           normalization.method = <span>"LogNormalize"</span>,<br>                           scale.factor = <span>1e4</span>) <br><span>#input_sce &lt;- FindVariableFeatures(input_sce)</span><br>load(<span>'check-by-celltype/qc-_marker_cosg.Rdata'</span>)<br>cg=unique(as.character(unlist(marker_cosg$names)))<br>input_sce &lt;- ScaleData(input_sce,features = cg)<br>input_sce &lt;- RunPCA(input_sce,   features =  cg)<br>seuratObj &lt;- RunHarmony(input_sce, <span>"orig.ident"</span>)<br>names(seuratObj@reductions)<br>seuratObj &lt;- RunUMAP(seuratObj,  dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>)<br>p = DimPlot(seuratObj,reduction = <span>"umap"</span>,label=<span>T</span>,group.by = <span>'celltype'</span> ) ;p<br>ggsave(filename=<span>'umap-by-cosg-genes-by-celltype.pdf'</span>,plot = p) <br><br><br></code></pre><p data-tool="mdnice编辑器">也就是说，首先你需要对自己的单细胞表达量矩阵进行降维聚类分群和命名，然后依据不同的单细胞亚群进行cosg找各个亚群的特征基因。</p><p data-tool="mdnice编辑器">可以看到， 每个单细胞亚群确实是泾渭分明了：</p><p><img data-galleryid="" data-imgfileid="100049984" data-ratio="0.7694444444444445" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMzvDYfrbO8gSzicFU1spext4gxibVoLBgBs7TzU7h95JSpSdIJQhdbHYDA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMzvDYfrbO8gSzicFU1spext4gxibVoLBgBs7TzU7h95JSpSdIJQhdbHYDA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption> </figcaption></figure><p data-tool="mdnice编辑器">而且可以看到上面的上皮细胞会混入一点点到SMC里面，其实这部分上皮细胞就是乳腺basal上皮细胞，它强烈的具有平滑肌的特征。恰好与我前面的单细胞亚群命名统一起来了 ：</p><pre data-tool="mdnice编辑器"><span></span><code>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>7</span> ),<span>2</span>]=<span>'Bcells'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>8</span> ),<span>2</span>]=<span>'plasma'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>0</span>,<span>10</span>  ),<span>2</span>]=<span>'Tcells'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c(  <span>2</span> ),<span>2</span>]=<span>'myeloids'</span>  <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>3</span> ),<span>2</span>]=<span>'endo'</span>   <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>1</span>,<span>6</span>,<span>9</span>,<span>11</span> ),<span>2</span>]=<span>'epi'</span><br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>4</span> ),<span>2</span>]=<span>'fibro'</span>  <br>  celltype[celltype$ClusterID %<span>in</span>% c( <span>5</span> ),<span>2</span>]=<span>'SMC'</span>  <br></code></pre><p data-tool="mdnice编辑器">如下所示的第9群，这部分上皮细胞就是乳腺basal上皮细胞：</p><p><img data-galleryid="" data-imgfileid="100049987" data-ratio="0.7425925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMzeBXuOwYBLYHhxgLm6FtIfPPQ4FHxPmfoc4rJ7LibRBRpXV3M6KpHXgg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMzeBXuOwYBLYHhxgLm6FtIfPPQ4FHxPmfoc4rJ7LibRBRpXV3M6KpHXgg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>第9群，这部分上皮细胞就是乳腺basal上皮细胞</figcaption></figure><p data-tool="mdnice编辑器">确实是很明显的看到乳腺basal上皮细胞，它强烈的具有平滑肌的特征，同时也有上皮细胞的特征基因：</p><p><img data-galleryid="" data-imgfileid="100049988" data-ratio="0.6833333333333333" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMz2iaDrsdLS9cqR22oApMdIddrxEn31jSjFNaBjDhFD6QuDyM8eVzvQFg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwEWyeYVq2icCCdcFAicbARMz2iaDrsdLS9cqR22oApMdIddrxEn31jSjFNaBjDhFD6QuDyM8eVzvQFg/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>乳腺basal上皮细胞，它强烈的具有平滑肌的特征</figcaption></figure></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>写在文末</span></h3></section><p>如果你也想做单细胞转录组数据分析，<span>最好是有自己的计算机资源哦，比如我们的</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533037&amp;idx=2&amp;sn=e6dd07e9339a84c8cbad2a9d6b42c8ca&amp;chksm=9b4b0156ac3c88403c55822722f6a93cde401fbb7b7cdbaee2a07211347e751ce414b7a47ec7&amp;scene=21#wechat_redirect" textvalue="2024的共享服务器交个朋友福利价仍然‍是800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">2024的共享服务器交个朋友福利价仍然是800</a><span>，而且还需要有基本的生物信息学基础，也可以看看我们的</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247531929&amp;idx=1&amp;sn=f6f16b7bf6b907360d6d0052e3d10cf6&amp;chksm=9b4b3d22ac3cb434b6aa7753a4cf0f266578147ccf10b49cc834e46af578ee6de99be0accb30&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉‍松授课（买一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a><span> ，你的生物信息学入门课。而且下周六日我们在广州线上授课哦：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533462&amp;idx=1&amp;sn=db7335a759233b4cea8b56c394e4171e&amp;chksm=9b4b032dac3c8a3b3cec594bf475a12f6feec734d27c216a59d06f48164eaf04ea26e6e6746e&amp;scene=21#wechat_redirect" textvalue="千呼万唤，让我们广州线下约起" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">千呼万唤，让我们广州线下约起</a></span></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/0YTC6SBoMolBEu7GZsBXAA",target="_blank" rel="noopener noreferrer">原文链接</a>
