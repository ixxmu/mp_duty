---
title: "Cell2location环境部署详解（2024年9月）"
date: 2024-09-16T08:42:18Z
draft: ["false"]
tags: [
  "fetched",
  "生信随笔"
]
categories: ["Acdemic"]
---
Cell2location环境部署详解（2024年9月） by 生信随笔
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">关于Cell2location，我有写过一个推文，见【<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247519266&amp;idx=1&amp;sn=2a7ead4dd345ba58f56a0cb710052d03&amp;scene=21#wechat_redirect" data-linktype="2">整合单细胞和空转数据多种方法之Cell2location</a>】。但是最近换了电脑和学校的服务器，在部署Cell2location环境时发现Cell2location怎么装都有问题。要么是Cell2location无法正常import，要么是无法调用GPU。我查看了官方github，发现很多人存在类似的问题。我尝试进行debug，发现坑还是挺多的，所以本帖记录一下Cell2location GPU版的环境部署问题。</p><ul data-tool="mdnice编辑器"><li><section><p>Cell2location官方github在https://github.com/BayraktarLab/cell2location#Installation</p></section></li><li><section><p>官方教程在：https://cell2location.readthedocs.io/en/latest/</p></section></li></ul><p data-tool="mdnice编辑器">首先使用Conda创建Cell2location的小环境，安装cell2location以及scvi，注意版本问题：</p><pre data-tool="mdnice编辑器"><code>mamba create -n cell2env python=3.11<br>conda activate cell2env<br>pip3 install torch torchvision torchaudio<br>pip install cell2location==0.1.3<br>pip install scvi-tools==1.0.4<br>pip3 install igraph leidenalg<br></code></pre><p data-tool="mdnice编辑器">然后，对于GPU的调用，需要安装pytorch-cuda，但是在安装前确认一下本机Cuda的版本（每台电脑版本可能不一样）：</p><pre data-tool="mdnice编辑器"><span></span><code>$ nvcc --version<br>nvcc: NVIDIA (R) Cuda compiler driver<br>Copyright (c) 2005-2021 NVIDIA Corporation<br>Built on Thu_Nov_18_09:45:30_PST_2021<br>Cuda compilation tools, release 11.5, V11.5.119<br>Build cuda_11.5.r11.5/compiler.30672275_0<br></code></pre><p data-tool="mdnice编辑器">例如这里的Cuda是11.5版本的，那么安装对应版本的PyTorch（https://pytorch.org/get-started/previous-versions/）：</p><pre data-tool="mdnice编辑器"><span></span><code>pip install --upgrade jax==0.4.14 jaxlib==0.4.14+cuda12.cudnn89 \<br>-f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html<br><br>pip install orbax-checkpoint==0.4.1 flax==0.7.4 scipy==1.11.3<br></code></pre><p data-tool="mdnice编辑器">如果需要衔接<code>Jupyter notebook</code>使用的话，需要在<code>cell2loc</code>这个环境里安装如下几个插件，然后就能在<code>Jupyter notebook</code>里选择<code>cell2loc</code>这个环境：</p><pre data-tool="mdnice编辑器"><span></span><code>mamba install -y nb_conda_kernels ipykernel<br>python -m ipykernel install --user --name cell2loc --display-name cell2loc<br></code></pre><p data-tool="mdnice编辑器">测试一下GPU是否能正常调用：</p><pre data-tool="mdnice编辑器"><span></span><code>from jax.lib import xla_bridge<br><span>print</span>(xla_bridge.get_backend().platform)<br><span># 正常调用会会输出“gpu” </span><br><br>import torch<br><span># 检查 CUDA 版本</span><br><span>print</span>(f<span>"CUDA Version: {torch.version.cuda}"</span>)<br><span>#CUDA Version: 12.1</span><br><br><span># 检查 cuDNN 版本</span><br><span>print</span>(f<span>"cuDNN Version: {torch.backends.cudnn.version()}"</span>)<br><span>#cuDNN Version: 90100</span><br><br>import torch<br><span># 检查是否有可用的GPU</span><br><span>if</span> torch.cuda.is_available():<br>    <span>print</span>(<span>"GPU is available"</span>)<br>    <span>print</span>(f<span>"GPU Name: {torch.cuda.get_device_name(0)}"</span>)<br><span>else</span>:<br>    <span>print</span>(<span>"GPU is not available"</span>)<br><span>#GPU is available</span><br><span>#GPU Name: NVIDIA GeForce RTX 3080 Ti</span><br></code></pre><p data-tool="mdnice编辑器">完美解决！我测了两台新电脑，暂时没问题。</p><p data-tool="mdnice编辑器">大家有问题可以后台留言~</p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/s2aPTUxujlh7OPTzCG2dWQ",target="_blank" rel="noopener noreferrer">原文链接</a>
