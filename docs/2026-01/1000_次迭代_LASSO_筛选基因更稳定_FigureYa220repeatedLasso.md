---
title: "1000 次迭代 LASSO，筛选基因更稳定｜FigureYa220repeatedLasso"
date: 2026-01-07T23:28:21Z
draft: ["false"]
tags: [
  "fetched",
  "小丫画图"
]
categories: ["Acdemic"]
---
1000 次迭代 LASSO，筛选基因更稳定｜FigureYa220repeatedLasso by 小丫画图
------
<div><section><section powered-by="xiumi.us"><section><section><section><section><section><p><span><span leaf="">小丫碎碎念：</span></span></p><p><span><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=Mzg3NTA1MTM0NQ==&amp;mid=2247487905&amp;idx=1&amp;sn=f43abd70cf0703ea779ed2abd9685432&amp;scene=21#wechat_redirect" textvalue="预后分析第一关——筛选候选基因｜FigureYa66UnivariateCox" data-itemshowtype="0" linktype="text" data-linktype="2">预后分析第一关——筛选候选基因｜FigureYa66UnivariateCox</a></span></span></p><p><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=Mzg3NTA1MTM0NQ==&amp;mid=2247487915&amp;idx=1&amp;sn=e848392b67a665c86b39de0953d3d2a5&amp;scene=21#wechat_redirect" textvalue="预后分析第二关——精选独立预后因子｜FigureYa31lasso" data-itemshowtype="0" linktype="text" data-linktype="2">预后分析第二关——精选独立预后因子｜FigureYa31lasso</a></span></p></section></section></section></section></section></section></section><section data-pm-slice='3 4 ["para",{"tagName":"section","attributes":{"style":"margin-bottom: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"powered-by":"xiumi.us"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><section data-pm-slice="10 10 []"><section><section><p><span leaf="">同样的 LASSO 算法，</span><span leaf="">FigureYa220repeatedLasso</span><span leaf=""> 通过 1000 次迭代解决 FigureYa31lasso 的稳定性问题。筛选出的不是</span><span data-pm-slice="0 0 []"><span leaf="">单一基因集，而是</span></span><span leaf="">基因频率 + 共识基因集。</span></p><p><span leaf=""><br></span></p><span leaf="">https://zread.ai/ying-ge/FigureYa对该方法的评价是：</span><p><span data-pm-slice="0 0 []"><span leaf=""><span textstyle="">从</span></span></span><strong><span leaf=""><span textstyle="">实用主义</span></span></strong><span leaf=""><span textstyle="">角度合理，从</span></span><strong><span leaf=""><span textstyle="">统计严格性</span></span></strong><span leaf=""><span textstyle="">角度有争议。</span></span></p><p><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"style":"margin-bottom: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"powered-by":"xiumi.us"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><br></span></p><h4 data-pm-slice="0 0 []"><strong><span leaf="">什么情况下可以用 </span><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"data-pm-slice":"3 4 [\"para\",{\"tagName\":\"section\",\"attributes\":{\"style\":\"margin-bottom: 0px;\"},\"namespaceURI\":\"http://www.w3.org/1999/xhtml\"},\"para\",{\"tagName\":\"section\",\"attributes\":{\"powered-by\":\"xiumi.us\"},\"namespaceURI\":\"http://www.w3.org/1999/xhtml\"},\"para\",{\"tagName\":\"section\",\"attributes\":{},\"namespaceURI\":\"http://www.w3.org/1999/xhtml\"},\"para\",{\"tagName\":\"section\",\"attributes\":{},\"namespaceURI\":\"http://www.w3.org/1999/xhtml\"},\"para\",{\"tagName\":\"section\",\"attributes\":{},\"namespaceURI\":\"http://www.w3.org/1999/xhtml\"},\"para\",{\"tagName\":\"section\",\"attributes\":{},\"namespaceURI\":\"http://www.w3.org/1999/xhtml\"}]","style":"margin-bottom: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"style":"margin-bottom: 0px;","data-pm-slice":"10 10 []"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'>FigureYa220repeatedLasso</span><span leaf="">？</span></strong></h4><p><span leaf="">✅ </span><strong><span leaf="">可以用</span></strong><span leaf="">：</span></p><ul><li><section><span leaf="">你的数据样本量小（&lt;200）</span></section></li><li><section><span leaf="">候选基因高度相关（如同一通路）</span></section></li><li><section><span leaf="">单次LASSO结果明显不稳定</span></section></li><li><section><span leaf="">审稿人质疑结果稳定性</span></section></li></ul><p><span leaf="">❌ </span><strong><span leaf="">不建议用</span></strong><span leaf="">：</span></p><ul><li><section><span leaf="">样本量大（&gt;500），单次LASSO已经稳定</span></section></li></ul><ul><li><section><span leaf="">你追求统计学严谨性</span></section></li><li><section><span leaf="">有条件用Stability Selection，例如</span><span leaf="">Bootstrap+lasso</span></section></li></ul></section><section><ul><li></ul><pre data-lang="apache"><code><span leaf=""><span>for</span> (i in <span>1</span>:<span>1000</span>) {  boot_sample = sample(<span>1</span>:nrow(data), replace=TRUE)  # 重采样  x_boot = x[boot_sample, ]  y_boot = y[boot_sample]    cvfit = cv.glmnet(x_boot, y_boot, family=<span>"cox"</span>)  记录被选中的基因}选择频率&gt;阈值的基因</span></code></pre></section><section><section><span leaf=""><br></span></section><h4><strong><span leaf=""><span textstyle="">如果必须用，怎么降低风险？</span></span></strong></h4><ol><li><p><strong><span leaf=""><span textstyle="">明确说明是启发式方法</span></span></strong></p><blockquote><p><span leaf=""><span textstyle="">"We used a frequency-based heuristic approach to enhance robustness..."</span></span></p></blockquote></li><li><p><strong><span leaf=""><span textstyle="">强调外部验证</span></span></strong></p><blockquote><p><span leaf=""><span textstyle="">"The selected gene set was validated in three independent cohorts..."</span></span></p></blockquote></li><li><p><strong><span leaf=""><span textstyle="">报告敏感性分析</span></span></strong></p><blockquote><p><span leaf=""><span textstyle="">"Results were consistent across frequency thresholds of 70%, 80%, and 90%..."</span></span></p></blockquote></li><li><p><strong><span leaf=""><span textstyle="">对比单次LASSO</span></span></strong></p><blockquote><p><span leaf=""><span textstyle="">"Compared to single LASSO (C-index=0.72), repeated LASSO improved stability (C-index=0.75±0.02 across 10 validation sets)..."</span></span></p></blockquote></li></ol><p><span leaf="" data-pm-slice='1 1 ["para",{"tagName":"section","attributes":{"style":"margin-bottom: 0px;"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{"powered-by":"xiumi.us"},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"section","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"},"para",{"tagName":"p","attributes":{},"namespaceURI":"http://www.w3.org/1999/xhtml"}]'><br></span></p><h1><span leaf="">下载代码文档、输入和输出文件，</span><span leaf="">分类检索、看缩略图，</span><span><span leaf="">请访问</span></span></h1><p><span leaf="">https://ying-ge.github.io/FigureYa/</span></p><p><span leaf=""><span textstyle="">或https://figureya.online/，国内访问更顺畅</span></span></p></section></section></section><section><section><section><h1 tabindex="-1" dir="auto" data-pm-slice="0 0 []"><strong><span leaf=""><span textstyle="">1 Citation</span></span></strong></h1><section><span><span leaf="">Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. </span><span><span leaf=""> 1: e70005.</span></span><span leaf=""> https://doi.org/10.1002/imm3.70005</span></span></section><h2 data-pm-slice="0 0 []"><span><span leaf="">2</span></span><span leaf=""> 需求描述</span></h2><p><span leaf="">FigureYa182RFSurv和FigureYa198SignatureComb都是根据基因的重要性筛选的。直接根据随机森林的准确度或cox模型的frequency筛选，又是另一种不同的展示方式。</span></p><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7Bwuzdua4wibGsCiaal8IV2jubW9bmGaJ9PibB5RAuZMGlLZ8xOnU3dUfK36ia1cp77w2aDlMyKhsQWoLLPDQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5127272727272727" data-type="png" data-w="825" data-imgfileid="100004308" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7Bwuzdua4wibGsCiaal8IV2jubW9bmGaJ9PibB5RAuZMGlLZ8xOnU3dUfK36ia1cp77w2aDlMyKhsQWoLLPDQ/640?wx_fmt=png&amp;from=appmsg"></section><p><span leaf=""><span textstyle="">Fig. 2 a Generation of the ten gene groups after 1000 iteration. The gene model with 30 immune related genes was selected to construct the signature as its highest frequencies of 211 compared to other nine gene models. b The c‐index of both training and testing sets. The c‐index for TCGA dataset, GSE30219, GSE31210, GSE3141, and GSE81089 were 0.723, 0.657, 0.7061, 0.641, and 0.619 respectively</span></span></p><p><span leaf=""><span textstyle="">Fromhttps://translational-medicine.biomedcentral.com/articles/10.1186/s12967-019-1824-4</span></span></p><h2><span><span leaf="">3</span></span><span leaf=""> 应用场景</span></h2><p><span leaf="">这里用的cox模型的10折交叉验证</span></p><p><span leaf="">Using Cox proportional hazards model (iteration = 1000) with an lasso penalty to find the best gene model.</span></p><h2><span><span leaf="">4</span></span><span leaf=""> 环境设置</span></h2><pre><code><span><span><span leaf="">source</span></span><span leaf="">(</span><span><span leaf="">"install_dependencies.R"</span></span><span leaf="">)  </span><span><span leaf=""># 加载依赖安装脚本 # Load dependency installation script</span></span></span></code></pre><pre><code><span leaf="">## 开始安装R包...</span><span leaf=""><br></span><span leaf="">## ===========================================</span><span leaf=""><br></span><span leaf="">## </span><span leaf=""><br></span><span leaf="">## 安装CRAN包...</span><span leaf=""><br></span><span leaf="">## 包已安装: glmnet </span><span leaf=""><br></span><span leaf="">## 包已安装: pbapply </span><span leaf=""><br></span><span leaf="">## 包已安装: survival </span><span leaf=""><br></span><span leaf="">## </span><span leaf=""><br></span><span leaf="">## 安装Bioconductor包...</span><span leaf=""><br></span><span leaf="">## 正在安装Bioconductor包: survcomp</span></code></pre><pre><code><span leaf="">## 'getOption("repos")' replaces Bioconductor standard repositories, see</span><span leaf=""><br></span><span leaf="">## 'help("repositories", package = "BiocManager")' for details.</span><span leaf=""><br></span><span leaf="">## Replacement repositories:</span><span leaf=""><br></span><span leaf="">##     CRAN: https://cloud.r-project.org/</span></code></pre><pre><code><span leaf="">## Bioconductor version 3.21 (BiocManager 1.30.27), R 4.5.1 (2025-06-13)</span></code></pre><pre><code><span leaf="">## Installing package(s) 'survcomp'</span></code></pre><pre><code><span leaf="">## 还安装依赖关系'survivalROC', 'bootstrap', 'rmeta'</span></code></pre><pre><code><span leaf="">## </span><span leaf=""><br></span><span leaf="">## 下载的二进制程序包在</span><span leaf=""><br></span><span leaf="">##  /var/folders/m3/lm0qsytj6gg0dbd7sk2clpr40000gs/T//RtmpHAI1iM/downloaded_packages里</span><span leaf=""><br></span><span leaf="">## 成功安装: survcomp </span><span leaf=""><br></span><span leaf="">## </span><span leaf=""><br></span><span leaf="">## ===========================================</span><span leaf=""><br></span><span leaf="">## 包安装完成！</span><span leaf=""><br></span><span leaf="">## 现在可以运行此目录中的R脚本了。</span></code></pre><pre><code><span><span><span leaf="">library</span></span><span leaf="">(survival)  </span><span><span leaf=""># 用于生存分析的包 # For survival analysis</span></span></span><span leaf=""><br></span><span><span><span leaf="">library</span></span><span leaf="">(glmnet)    </span><span><span leaf=""># 用于Lasso和Elastic-Net正则化的包 # For Lasso and Elastic-Net regularization</span></span></span></code></pre><pre><code><span leaf="">## 载入需要的程序包：Matrix</span></code></pre><pre><code><span leaf="">## Loaded glmnet 4.1-10</span></code></pre><pre><code><span><span><span leaf="">library</span></span><span leaf="">(pbapply)   </span><span><span leaf=""># 用于显示进度条的包 # For displaying progress bars</span></span></span><span leaf=""><br></span><span><span><span leaf="">library</span></span><span leaf="">(survcomp)  </span><span><span leaf=""># 用于生存数据比较的包 # For survival data comparison</span></span></span></code></pre><pre><code><span leaf="">## 载入需要的程序包：prodlim</span></code></pre><pre><code><span><span><span leaf="">Sys.setenv</span></span><span leaf="">(</span><span><span leaf="">LANGUAGE =</span></span><span><span leaf="">"en"</span></span><span leaf="">) </span><span><span leaf=""><a topic-id="mk15bu6v-3m8pfy" data-topic="1">#显示英文报错信息</a> # error messages are displayed in English</span></span></span><span leaf=""><br></span><span><span><span leaf="">options</span></span><span leaf="">(</span><span><span leaf="">stringsAsFactors =</span></span><span><span leaf="">FALSE</span></span><span leaf="">) </span><span><span leaf=""><a topic-id="mk15bu6w-wkw040" data-topic="1">#禁止chr转成factor</a> # chr is not allowed to be converted to factor</span></span></span></code></pre><p><span leaf="">自定义函数</span></p><pre><code><span><span leaf="">display.progress </span><span><span leaf="">=</span></span><span><span leaf="">function</span></span><span leaf=""> (index, totalN, </span><span><span leaf="">breakN=</span></span><span><span leaf="">20</span></span><span leaf="">) {</span></span><span leaf=""><br></span><span></span><span leaf=""><br></span><span><span><span leaf="">if</span></span><span leaf=""> ( index </span><span><span leaf="">%%</span></span><span><span leaf="">ceiling</span></span><span leaf="">(totalN</span><span><span leaf="">/</span></span><span leaf="">breakN)  </span><span><span leaf="">==</span></span><span><span leaf="">0</span></span><span leaf="">  ) {</span></span><span leaf=""><br></span><span><span><span leaf="">cat</span></span><span leaf="">(</span><span><span leaf="">paste</span></span><span leaf="">(</span><span><span leaf="">round</span></span><span leaf="">(index</span><span><span leaf="">*</span></span><span><span leaf="">100</span></span><span><span leaf="">/</span></span><span leaf="">totalN), </span><span><span leaf="">"% "</span></span><span leaf="">, </span><span><span leaf="">sep=</span></span><span><span leaf="">""</span></span><span leaf="">))</span></span><span leaf=""><br></span><span><span leaf="">  }</span></span><span leaf=""><br></span><span><span leaf="">} </span></span></code></pre><h2><span><span leaf="">5</span></span><span leaf=""> 输入文件</span></h2><p><span leaf="">表达谱文件</span></p><ul><li><section><span leaf="">InnateDB_genes.csv，免疫基因集。数据来自https://www.innatedb.com/redirect.do?go=resourcesGeneLists Immunogenetic Related Information Source (IRIS)</span></section></li><li><section><span leaf="">训练集</span></section></li><ul><li><section><span leaf="">easy_input_expr.txt，表达谱</span></section></li><li><section><span leaf="">easy_input_surv.txt，生存数据</span></section></li></ul><li><section><span leaf="">测试集，GEO数据的下载及数据预处理请参考FigureYa203ComBat，其余测试集如法炮制</span></section></li><ul><li><section><span leaf="">easy_validation_expr.txt，表达谱</span></section></li><li><section><span leaf="">easy_validation_surv.txt，生存数据</span></section></li></ul></ul><pre><code><span><span><span leaf="">## 加载训练集表达谱和生存数据</span></span></span><span leaf=""><br></span><span><span><span leaf="">## Load the expression spectrum and survival data of the training set</span></span></span><span leaf=""><br></span><span><span leaf="">expr </span><span><span leaf="">&lt;-</span></span><span><span leaf="">read.table</span></span><span leaf="">(</span><span><span leaf="">"easy_input_expr.txt"</span></span><span leaf="">,</span><span><span leaf="">sep =</span></span><span><span leaf="">"</span></span><span><span leaf="">\t</span></span><span><span leaf="">"</span></span><span leaf="">,</span><span><span leaf="">row.names =</span></span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">check.names =</span></span><span leaf=""> F,</span><span><span leaf="">stringsAsFactors =</span></span><span leaf=""> F,</span><span><span leaf="">header =</span></span><span leaf=""> T)</span></span><span leaf=""><br></span><span><span leaf="">surv </span><span><span leaf="">&lt;-</span></span><span><span leaf="">read.table</span></span><span leaf="">(</span><span><span leaf="">"easy_input_surv.txt"</span></span><span leaf="">,</span><span><span leaf="">sep =</span></span><span><span leaf="">"</span></span><span><span leaf="">\t</span></span><span><span leaf="">"</span></span><span leaf="">,</span><span><span leaf="">row.names =</span></span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">check.names =</span></span><span leaf=""> F,</span><span><span leaf="">stringsAsFactors =</span></span><span leaf=""> F,</span><span><span leaf="">header =</span></span><span leaf=""> T)</span></span><span leaf=""><br></span><span><span leaf="">pct </span><span><span leaf="">=</span></span><span><span leaf="">0.1</span></span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf=""># 1. 根据情况对表达谱做对数转换</span></span></span><span leaf=""><br></span><span><span><span leaf=""># 1. Logarithmic conversion of the expression spectrum as appropriate</span></span></span><span leaf=""><br></span><span><span leaf="">expr </span><span><span leaf="">&lt;-</span></span><span><span leaf="">t</span></span><span leaf="">(</span><span><span leaf="">log2</span></span><span leaf="">(expr </span><span><span leaf="">+</span></span><span><span leaf="">1</span></span><span leaf="">))</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf=""># 2. 取方差大于1的基因</span></span></span><span leaf=""><br></span><span><span><span leaf=""># 2. Genes with variances greater than 1 were taken</span></span></span><span leaf=""><br></span><span><span leaf="">expr </span><span><span leaf="">&lt;-</span></span><span leaf=""> expr[,</span><span><span leaf="">apply</span></span><span leaf="">(expr, </span><span><span leaf="">2</span></span><span leaf="">, sd) </span><span><span leaf="">&gt;</span></span><span><span leaf="">0</span></span><span leaf="">]</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf=""># 3. 取表达量为0的样本数目小于总样本数pct%的样本，这里pct默认为0.1，即10%</span></span></span><span leaf=""><br></span><span><span><span leaf=""># 3. If the number of samples with an expression level of 0 is less than the total number of samples pct%, the default pct is 0.1, that is, 10%</span></span></span><span leaf=""><br></span><span><span leaf="">expr </span><span><span leaf="">&lt;-</span></span><span leaf=""> expr[,</span><span><span leaf="">apply</span></span><span leaf="">(expr, </span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">function</span></span><span leaf="">(x) </span><span><span leaf="">sum</span></span><span leaf="">(x </span><span><span leaf="">==</span></span><span><span leaf="">0</span></span><span leaf="">) </span><span><span leaf="">&lt;</span></span><span leaf=""> pct </span><span><span leaf="">*</span></span><span><span leaf="">nrow</span></span><span leaf="">(expr))]</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf=""># 4. 防止基因名出错</span></span></span><span leaf=""><br></span><span><span><span leaf=""># 4. Prevent gene name errors</span></span></span><span leaf=""><br></span><span><span><span leaf="">colnames</span></span><span leaf="">(expr) </span><span><span leaf="">&lt;-</span></span><span><span leaf="">make.names</span></span><span leaf="">(</span><span><span leaf="">colnames</span></span><span leaf="">(expr))</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf="">## 加载免疫基因集</span></span></span><span leaf=""><br></span><span><span><span leaf="">## Load the immune gene set</span></span></span><span leaf=""><br></span><span><span leaf="">immune.gene </span><span><span leaf="">&lt;-</span></span><span><span leaf="">read.csv</span></span><span leaf="">(</span><span><span leaf="">"InnateDB_genes.csv"</span></span><span leaf="">,</span><span><span leaf="">row.names =</span></span><span><span leaf="">NULL</span></span><span leaf="">,</span><span><span leaf="">check.names =</span></span><span leaf=""> F,</span><span><span leaf="">stringsAsFactors =</span></span><span leaf=""> F,</span><span><span leaf="">header =</span></span><span leaf=""> T)</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf=""># 取出基因和样本</span></span></span><span leaf=""><br></span><span><span><span leaf=""># Remove genes and samples</span></span></span><span leaf=""><br></span><span><span leaf="">comgene </span><span><span leaf="">&lt;-</span></span><span><span leaf="">unique</span></span><span leaf="">(</span><span><span leaf="">intersect</span></span><span leaf="">(</span><span><span leaf="">colnames</span></span><span leaf="">(expr),immune.gene</span><span><span leaf="">$</span></span><span leaf="">name))</span></span><span leaf=""><br></span><span><span leaf="">comsam </span><span><span leaf="">&lt;-</span></span><span><span leaf="">intersect</span></span><span leaf="">(</span><span><span leaf="">rownames</span></span><span leaf="">(surv),</span><span><span leaf="">rownames</span></span><span leaf="">(expr))</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">expr.surv </span><span><span leaf="">&lt;-</span></span><span><span leaf="">cbind.data.frame</span></span><span leaf="">(surv[comsam,</span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">"OS"</span></span><span leaf="">,</span><span><span leaf="">"OS.time"</span></span><span leaf="">)],</span></span><span leaf=""><br></span><span><span><span leaf="">as.data.frame</span></span><span leaf="">(expr[comsam,comgene]))</span></span><span leaf=""><br></span><span><span leaf="">expr.surv </span><span><span leaf="">&lt;-</span></span><span leaf=""> expr.surv[</span><span><span leaf="">which</span></span><span leaf="">(expr.surv</span><span><span leaf="">$</span></span><span leaf="">OS.time </span><span><span leaf="">&gt;</span></span><span><span leaf="">0</span></span><span leaf="">),]</span></span></code></pre><h2><span><span leaf="">6</span></span><span leaf=""> 用训练集筛基因</span></h2><p><span leaf="">单变量cox模型筛选基因，KM估计筛选基因，二者取交集。</span></p><pre><code><span><span><span leaf=""># 单变量cox模型筛选基因</span></span></span><span leaf=""><br></span><span><span><span leaf=""># Univariate Cox model for gene screening</span></span></span><span leaf=""><br></span><span><span leaf="">Coxoutput </span><span><span leaf="">&lt;-</span></span><span><span leaf="">NULL</span></span></span><span leaf=""><br></span><span><span><span leaf="">for</span></span><span leaf="">(i </span><span><span leaf="">in</span></span><span><span leaf="">3</span></span><span><span leaf="">:</span></span><span><span leaf="">ncol</span></span><span leaf="">(expr.surv)){</span></span><span leaf=""><br></span><span><span><span leaf="">display.progress</span></span><span leaf="">(</span><span><span leaf="">index =</span></span><span leaf=""> i,</span><span><span leaf="">totalN =</span></span><span><span leaf="">ncol</span></span><span leaf="">(expr.surv),</span><span><span leaf="">breakN =</span></span><span><span leaf="">20</span></span><span leaf="">)</span></span><span leaf=""><br></span><span><span leaf="">  g </span><span><span leaf="">&lt;-</span></span><span><span leaf="">colnames</span></span><span leaf="">(expr.surv)[i]</span></span><span leaf=""><br></span><span><span leaf="">  cox </span><span><span leaf="">&lt;-</span></span><span><span leaf="">coxph</span></span><span leaf="">(</span><span><span leaf="">Surv</span></span><span leaf="">(OS.time,OS) </span><span><span leaf="">~</span></span><span leaf=""> expr.surv[,i], </span><span><span leaf="">data =</span></span><span leaf=""> expr.surv)</span></span><span leaf=""><br></span><span><span leaf="">  coxSummary </span><span><span leaf="">=</span></span><span><span leaf="">summary</span></span><span leaf="">(cox)</span></span><span leaf=""><br></span><span><span leaf="">  Coxoutput</span><span><span leaf="">=</span></span><span><span leaf="">rbind</span></span><span leaf="">(Coxoutput,</span><span><span leaf="">data.frame</span></span><span leaf="">(</span><span><span leaf="">gene=</span></span><span leaf="">g,</span></span><span leaf=""><br></span><span><span><span leaf="">HR=</span></span><span><span leaf="">as.numeric</span></span><span leaf="">(coxSummary</span><span><span leaf="">$</span></span><span leaf="">coefficients[,</span><span><span leaf="">"exp(coef)"</span></span><span leaf="">])[</span><span><span leaf="">1</span></span><span leaf="">],</span></span><span leaf=""><br></span><span><span><span leaf="">z=</span></span><span><span leaf="">as.numeric</span></span><span leaf="">(coxSummary</span><span><span leaf="">$</span></span><span leaf="">coefficients[,</span><span><span leaf="">"z"</span></span><span leaf="">])[</span><span><span leaf="">1</span></span><span leaf="">],</span></span><span leaf=""><br></span><span><span><span leaf="">pvalue=</span></span><span><span leaf="">as.numeric</span></span><span leaf="">(coxSummary</span><span><span leaf="">$</span></span><span leaf="">coefficients[,</span><span><span leaf="">"Pr(&gt;|z|)"</span></span><span leaf="">])[</span><span><span leaf="">1</span></span><span leaf="">],</span></span><span leaf=""><br></span><span><span><span leaf="">lower=</span></span><span><span leaf="">as.numeric</span></span><span leaf="">(coxSummary</span><span><span leaf="">$</span></span><span leaf="">conf.int[,</span><span><span leaf="">3</span></span><span leaf="">][</span><span><span leaf="">1</span></span><span leaf="">]),</span></span><span leaf=""><br></span><span><span><span leaf="">upper=</span></span><span><span leaf="">as.numeric</span></span><span leaf="">(coxSummary</span><span><span leaf="">$</span></span><span leaf="">conf.int[,</span><span><span leaf="">4</span></span><span leaf="">][</span><span><span leaf="">1</span></span><span leaf="">]),</span><span><span leaf="">stringsAsFactors =</span></span><span leaf=""> F))</span></span><span leaf=""><br></span><span><span leaf="">}</span></span></code></pre><pre><code><span leaf="">## 5% 10% 15% 20% 25% 30% 35% 40% 45% 50% 55% 60% 65% 70% 75% 80% 85% 90% 95%</span></code></pre><pre><code><span><span leaf="">cox.res </span><span><span leaf="">&lt;-</span></span><span leaf=""> Coxoutput[</span><span><span leaf="">which</span></span><span leaf="">(Coxoutput</span><span><span leaf="">$</span></span><span leaf="">pvalue </span><span><span leaf="">&lt;</span></span><span><span leaf="">0.05</span></span><span leaf="">),</span><span><span leaf="">"gene"</span></span><span leaf="">] </span><span><span leaf=""># 取出FDR&lt;0.05的基因为候选基因 # The gene with FDR&lt;0.05 was taken out as a candidate gene</span></span></span><span leaf=""><br></span><span></span><span leaf=""><br></span><span><span><span leaf=""># KM估计筛选基因</span></span></span><span leaf=""><br></span><span><span><span leaf=""># KM estimation of screening genes</span></span></span><span leaf=""><br></span><span><span leaf="">kmoutput </span><span><span leaf="">&lt;-</span></span><span><span leaf="">NULL</span></span></span><span leaf=""><br></span><span><span><span leaf="">for</span></span><span leaf="">(i </span><span><span leaf="">in</span></span><span><span leaf="">3</span></span><span><span leaf="">:</span></span><span><span leaf="">ncol</span></span><span leaf="">(expr.surv)){</span></span><span leaf=""><br></span><span><span><span leaf="">display.progress</span></span><span leaf="">(</span><span><span leaf="">index =</span></span><span leaf=""> i,</span><span><span leaf="">totalN =</span></span><span><span leaf="">ncol</span></span><span leaf="">(expr.surv),</span><span><span leaf="">breakN =</span></span><span><span leaf="">20</span></span><span leaf="">)</span></span><span leaf=""><br></span><span><span leaf="">  g </span><span><span leaf="">&lt;-</span></span><span><span leaf="">colnames</span></span><span leaf="">(expr.surv)[i]</span></span><span leaf=""><br></span><span><span leaf="">  tmp </span><span><span leaf="">&lt;-</span></span><span leaf=""> expr.surv[,</span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">"OS.time"</span></span><span leaf="">,</span><span><span leaf="">"OS"</span></span><span leaf="">,g)]</span></span><span leaf=""><br></span><span><span leaf="">  tmp</span><span><span leaf="">$</span></span><span leaf="">group </span><span><span leaf="">&lt;-</span></span><span><span leaf="">ifelse</span></span><span leaf="">(tmp[,</span><span><span leaf="">3</span></span><span leaf="">] </span><span><span leaf="">&gt;</span></span><span><span leaf="">median</span></span><span leaf="">(tmp[,</span><span><span leaf="">3</span></span><span leaf="">]),</span><span><span leaf="">"High"</span></span><span leaf="">,</span><span><span leaf="">"Low"</span></span><span leaf="">)</span></span><span leaf=""><br></span><span><span leaf="">  fitd</span><span><span leaf="">=</span></span><span><span leaf="">survdiff</span></span><span leaf="">(</span><span><span leaf="">Surv</span></span><span leaf="">(OS.time, OS)</span><span><span leaf="">~</span></span><span leaf=""> group, </span><span><span leaf="">data=</span></span><span leaf="">tmp, </span><span><span leaf="">na.action=</span></span><span leaf="">na.exclude)</span></span><span leaf=""><br></span><span><span leaf="">  p.val </span><span><span leaf="">&lt;-</span></span><span><span leaf="">1</span></span><span><span leaf="">-</span></span><span><span leaf="">pchisq</span></span><span leaf="">(fitd</span><span><span leaf="">$</span></span><span leaf="">chisq, </span><span><span leaf="">length</span></span><span leaf="">(fitd</span><span><span leaf="">$</span></span><span leaf="">n)</span><span><span leaf="">-</span></span><span><span leaf="">1</span></span><span leaf="">)</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">  kmoutput</span><span><span leaf="">=</span></span><span><span leaf="">rbind</span></span><span leaf="">(kmoutput,</span><span><span leaf="">data.frame</span></span><span leaf="">(</span><span><span leaf="">gene=</span></span><span leaf="">g,</span></span><span leaf=""><br></span><span><span><span leaf="">pvalue=</span></span><span leaf="">p.val,</span></span><span leaf=""><br></span><span><span><span leaf="">stringsAsFactors =</span></span><span leaf=""> F))</span></span><span leaf=""><br></span><span><span leaf="">}</span></span></code></pre><pre><code><span leaf="">## 5% 10% 15% 20% 25% 30% 35% 40% 45% 50% 55% 60% 65% 70% 75% 80% 85% 90% 95%</span></code></pre><pre><code><span><span leaf="">km.res </span><span><span leaf="">&lt;-</span></span><span leaf=""> kmoutput[</span><span><span leaf="">which</span></span><span leaf="">(kmoutput</span><span><span leaf="">$</span></span><span leaf="">pvalue </span><span><span leaf="">&lt;</span></span><span><span leaf="">0.05</span></span><span leaf="">),</span><span><span leaf="">"gene"</span></span><span leaf="">]</span></span><span leaf=""><br></span><span></span><span leaf=""><br></span><span><span><span leaf=""># 取出交集基因</span></span></span><span leaf=""><br></span><span><span><span leaf=""># Remove the intersecting genes</span></span></span><span leaf=""><br></span><span><span leaf="">candidate.gene </span><span><span leaf="">&lt;-</span></span><span><span leaf="">intersect</span></span><span leaf="">(cox.res,km.res)</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf=""># 运行1000次multivariate cox model with lasso penalty</span></span></span><span leaf=""><br></span><span><span><span leaf=""># Run the Multivariate Cox Model with Lasso Penalty 1000 times</span></span></span><span leaf=""><br></span><span><span leaf="">iter.times </span><span><span leaf="">&lt;-</span></span><span><span leaf="">1000</span></span><span><span leaf=""># 设置迭代次数，速度非常慢请耐心，例文是1000次 # Set the number of iterations, the speed is very slow, please be patient, the example is 1000 times</span></span></span><span leaf=""><br></span><span><span leaf="">surv.obj </span><span><span leaf="">&lt;-</span></span><span><span leaf="">Surv</span></span><span leaf="">(expr.surv</span><span><span leaf="">$</span></span><span leaf="">OS.time, expr.surv</span><span><span leaf="">$</span></span><span leaf="">OS)</span></span><span leaf=""><br></span><span><span leaf="">lasso_fea_list </span><span><span leaf="">&lt;-</span></span><span><span leaf="">list</span></span><span leaf="">()</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">list.of.seed </span><span><span leaf="">&lt;-</span></span><span><span leaf="">1</span></span><span><span leaf="">:</span></span><span leaf="">iter.times</span></span><span leaf=""><br></span><span><span leaf="">lasso_fea_list </span><span><span leaf="">&lt;-</span></span><span><span leaf="">pblapply</span></span><span leaf="">(list.of.seed, </span><span><span leaf="">function</span></span><span leaf="">(x){ </span><span><span leaf=""># 大概运行2天 # It will run for about 2 days</span></span></span><span leaf=""><br></span><span><span><span leaf="">set.seed</span></span><span leaf="">(list.of.seed[x])</span></span><span leaf=""><br></span><span><span leaf="">  cvfit </span><span><span leaf="">=</span></span><span><span leaf="">cv.glmnet</span></span><span leaf="">(</span><span><span leaf="">x =</span></span><span><span leaf="">as.matrix</span></span><span leaf="">(expr.surv[,candidate.gene]), </span></span><span leaf=""><br></span><span><span><span leaf="">y =</span></span><span leaf=""> surv.obj, </span></span><span leaf=""><br></span><span><span><span leaf="">nfolds =</span></span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf=""># 10-fold交叉验证选取最优lambda # 10-fold cross-validation to select the optimal lambda</span></span></span><span leaf=""><br></span><span><span><span leaf="">alpha =</span></span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf=""># alpha = 1 意味着 lasso # alpha = 1 means lasso</span></span></span><span leaf=""><br></span><span><span><span leaf="">family =</span></span><span><span leaf="">"cox"</span></span><span leaf="">, </span><span><span leaf=""># 依赖cox模型 # Rely on the COX model</span></span></span><span leaf=""><br></span><span><span><span leaf="">maxit =</span></span><span><span leaf="">1000</span></span><span leaf="">) </span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf=""># 取出最优lambda</span></span></span><span leaf=""><br></span><span><span><span leaf=""># Take out the optimal lambda</span></span></span><span leaf=""><br></span><span><span leaf="">  fea </span><span><span leaf="">&lt;-</span></span><span><span leaf="">rownames</span></span><span leaf="">(</span><span><span leaf="">coef</span></span><span leaf="">(cvfit, </span><span><span leaf="">s =</span></span><span><span leaf="">'lambda.min'</span></span><span leaf="">))[</span><span><span leaf="">coef</span></span><span leaf="">(cvfit, </span><span><span leaf="">s =</span></span><span><span leaf="">'lambda.min'</span></span><span leaf="">)[,</span><span><span leaf="">1</span></span><span leaf="">]</span><span><span leaf="">!=</span></span><span><span leaf="">0</span></span><span leaf="">]</span></span><span leaf=""><br></span><span><span><span leaf="">if</span></span><span leaf="">(</span><span><span leaf="">is.element</span></span><span leaf="">(</span><span><span leaf="">"(Intercept)"</span></span><span leaf="">, fea)) {</span></span><span leaf=""><br></span><span><span leaf="">    lasso_fea </span><span><span leaf="">&lt;-</span></span><span><span leaf="">sort</span></span><span leaf="">(fea[</span><span><span leaf="">-</span></span><span><span leaf="">1</span></span><span leaf="">]) </span><span><span leaf=""># 去掉截距项并排序 # Remove the intercept items and sort</span></span></span><span leaf=""><br></span><span><span leaf="">  } </span><span><span leaf="">else</span></span><span leaf=""> {</span></span><span leaf=""><br></span><span><span leaf="">    lasso_fea </span><span><span leaf="">&lt;-</span></span><span><span leaf="">sort</span></span><span leaf="">(fea)</span></span><span leaf=""><br></span><span><span leaf="">  }</span></span><span leaf=""><br></span><span><span><span leaf="">return</span></span><span leaf="">(lasso_fea)</span></span><span leaf=""><br></span><span><span leaf="">}</span></span></code></pre><pre data-pm-slice="0 0 []"><code><span><span leaf="">myCoefs </span><span><span leaf="">&lt;-</span></span><span><span leaf="">coef</span></span><span leaf="">(cvfit, </span><span><span leaf="">s=</span></span><span><span leaf="">"lambda.min"</span></span><span leaf="">)</span></span><span leaf=""><br></span><span><span leaf="">fea </span><span><span leaf="">&lt;-</span></span><span><span leaf="">rownames</span></span><span leaf="">(</span><span><span leaf="">coef</span></span><span leaf="">(cvfit, </span><span><span leaf="">s =</span></span><span><span leaf="">'lambda.min'</span></span><span leaf="">))[</span><span><span leaf="">coef</span></span><span leaf="">(cvfit, </span><span><span leaf="">s =</span></span><span><span leaf="">'lambda.min'</span></span><span leaf="">)[,</span><span><span leaf="">1</span></span><span leaf="">]</span><span><span leaf="">!=</span></span><span><span leaf="">0</span></span><span leaf="">]</span></span><span leaf=""><br></span><span><span><span leaf="">if</span></span><span leaf="">(</span><span><span leaf="">is.element</span></span><span leaf="">(</span><span><span leaf="">"(Intercept)"</span></span><span leaf="">, fea)) {</span></span><span leaf=""><br></span><span><span leaf="">  lasso_fea </span><span><span leaf="">&lt;-</span></span><span leaf=""> fea[</span><span><span leaf="">-</span></span><span><span leaf="">1</span></span><span leaf="">] </span><span><span leaf=""># 去掉截距项并排序 # Remove the intercept items and sort</span></span></span><span leaf=""><br></span><span><span leaf="">  lasso_coef </span><span><span leaf="">&lt;-</span></span><span leaf=""> myCoefs</span><span><span leaf="">@</span></span><span leaf="">x; </span><span><span leaf="">names</span></span><span leaf="">(lasso_coef) </span><span><span leaf="">&lt;-</span></span><span leaf=""> lasso_fea</span></span><span leaf=""><br></span><span><span leaf="">} </span><span><span leaf="">else</span></span><span leaf=""> {</span></span><span leaf=""><br></span><span><span leaf="">  lasso_fea </span><span><span leaf="">&lt;-</span></span><span leaf=""> fea</span></span><span leaf=""><br></span><span><span leaf="">  lasso_coef </span><span><span leaf="">&lt;-</span></span><span leaf=""> myCoefs</span><span><span leaf="">@</span></span><span leaf="">x; </span><span><span leaf="">names</span></span><span leaf="">(lasso_coef) </span><span><span leaf="">&lt;-</span></span><span leaf=""> lasso_fea</span></span><span leaf=""><br></span><span><span leaf="">}</span></span><span leaf=""><br></span><span><span leaf="">tmp </span><span><span leaf="">&lt;-</span></span><span><span leaf="">as.matrix</span></span><span leaf="">(expr.surv[,lasso_fea])</span></span><span leaf=""><br></span><span><span leaf="">risk.score </span><span><span leaf="">&lt;-</span></span><span><span leaf="">apply</span></span><span leaf="">(tmp,</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">function</span></span><span leaf="">(x) {x </span><span><span leaf="">%*%</span></span><span><span leaf="">as.numeric</span></span><span leaf="">(lasso_coef)}) </span><span><span leaf=""># 表达加权系数求和计算riskscore # Expression weighting coefficient summation calculates riskscore</span></span></span><span leaf=""><br></span><span><span leaf="">cindex.tcga </span><span><span leaf="">&lt;-</span></span><span><span leaf="">concordance.index</span></span><span leaf="">(risk.score,</span></span><span leaf=""><br></span><span><span><span leaf="">surv.time =</span></span><span leaf=""> expr.surv</span><span><span leaf="">$</span></span><span leaf="">OS.time,</span></span><span leaf=""><br></span><span><span><span leaf="">surv.event =</span></span><span leaf=""> expr.surv</span><span><span leaf="">$</span></span><span leaf="">OS,</span></span><span leaf=""><br></span><span><span><span leaf="">method =</span></span><span><span leaf="">"noether"</span></span><span leaf="">)</span></span></code></pre><h2><span><span leaf="">8</span></span><span leaf=""> 测试集 - 计算riskscore和C指数</span></h2><pre><code><span><span><span leaf="">## 加载测试集表达谱和生存数据</span></span></span><span leaf=""><br></span><span><span><span leaf=""># 表达谱预处理</span></span></span><span leaf=""><br></span><span><span><span leaf="">## Load the test set expression profile and survival data</span></span></span><span leaf=""><br></span><span><span><span leaf=""># Expression profile preprocessing</span></span></span><span leaf=""><br></span><span><span leaf="">gse31210.expr </span><span><span leaf="">&lt;-</span></span><span><span leaf="">read.delim</span></span><span leaf="">(</span><span><span leaf="">"easy_validation_expr.txt"</span></span><span leaf="">,</span><span><span leaf="">sep =</span></span><span><span leaf="">"</span></span><span><span leaf="">\t</span></span><span><span leaf="">"</span></span><span leaf="">,</span><span><span leaf="">row.names =</span></span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">check.names =</span></span><span leaf=""> F,</span><span><span leaf="">stringsAsFactors =</span></span><span leaf=""> F,</span><span><span leaf="">header =</span></span><span leaf=""> T)</span></span><span leaf=""><br></span><span><span leaf="">gse31210.expr[</span><span><span leaf="">1</span></span><span><span leaf="">:</span></span><span><span leaf="">6</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span><span leaf="">:</span></span><span><span leaf="">3</span></span><span leaf="">] </span><span><span leaf=""># 注意到行名里存在多种匹配，取///符号前的基因名（可以在EXCEL里检查一下，但不要用EXCEL进行任何操作，千万不要保存，否则可能出现月份） # Notice that there are multiple matches in the row name, take the gene name before the /// symbol (you can check it in excel, but don't use excel to do any operation, don't save it, otherwise there may be a month)</span></span></span></code></pre><pre><code><span leaf="">##                          GSM773540  GSM773541   GSM773542</span><span leaf=""><br></span><span leaf="">## T                         80.59206   115.6124    24.48005</span><span leaf=""><br></span><span leaf="">## OSCP1                    337.20940   337.3154   300.00810</span><span leaf=""><br></span><span leaf="">## ITGB6 /// LOC100505984   246.30563   340.4212   247.17783</span><span leaf=""><br></span><span leaf="">## AR                       160.38811   148.2839   833.48480</span><span leaf=""><br></span><span leaf="">## C2                      1080.40426   426.2887  1001.86759</span><span leaf=""><br></span><span leaf="">## C3                     25088.01600 11490.5730 18100.90000</span></code></pre><pre><code><span><span leaf="">gse31210.expr</span><span><span leaf="">$</span></span><span leaf="">Gene </span><span><span leaf="">&lt;-</span></span><span><span leaf="">sapply</span></span><span leaf="">(</span><span><span leaf="">strsplit</span></span><span leaf="">(</span><span><span leaf="">rownames</span></span><span leaf="">(gse31210.expr),</span><span><span leaf="">" /// "</span></span><span leaf="">,</span><span><span leaf="">fixed =</span></span><span leaf=""> T),</span><span><span leaf="">"["</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">)</span></span><span leaf=""><br></span><span><span leaf="">gse31210.expr </span><span><span leaf="">&lt;-</span></span><span><span leaf="">apply</span></span><span leaf="">(gse31210.expr[,</span><span><span leaf="">setdiff</span></span><span leaf="">(</span><span><span leaf="">colnames</span></span><span leaf="">(gse31210.expr), </span><span><span leaf="">"Gene"</span></span><span leaf="">)], </span><span><span leaf="">2</span></span><span leaf="">, </span><span><span leaf="">function</span></span><span leaf="">(x) </span><span><span leaf="">tapply</span></span><span leaf="">(x, </span><span><span leaf="">INDEX=</span></span><span><span leaf="">factor</span></span><span leaf="">(gse31210.expr</span><span><span leaf="">$</span></span><span leaf="">Gene), </span><span><span leaf="">FUN=</span></span><span leaf="">median, </span><span><span leaf="">na.rm=</span></span><span><span leaf="">TRUE</span></span><span leaf="">))</span></span><span leaf=""><br></span><span><span leaf="">gse31210.expr </span><span><span leaf="">&lt;-</span></span><span><span leaf="">as.data.frame</span></span><span leaf="">(</span><span><span leaf="">round</span></span><span leaf="">(gse31210.expr,</span><span><span leaf="">2</span></span><span leaf="">))</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf=""># 生存数据预处理</span></span></span><span leaf=""><br></span><span><span><span leaf=""># Preprocessing of survival data</span></span></span><span leaf=""><br></span><span><span leaf="">gse31210.surv </span><span><span leaf="">&lt;-</span></span><span><span leaf="">read.delim</span></span><span leaf="">(</span><span><span leaf="">"easy_validation_surv.txt"</span></span><span leaf="">,</span><span><span leaf="">sep =</span></span><span><span leaf="">"</span></span><span><span leaf="">\t</span></span><span><span leaf="">"</span></span><span leaf="">,</span><span><span leaf="">row.names =</span></span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">check.names =</span></span><span leaf=""> F,</span><span><span leaf="">stringsAsFactors =</span></span><span leaf=""> F,</span><span><span leaf="">header =</span></span><span leaf=""> T)</span></span><span leaf=""><br></span><span><span leaf="">gse31210.surv </span><span><span leaf="">&lt;-</span></span><span leaf=""> gse31210.surv[</span><span><span leaf="">which</span></span><span leaf="">(gse31210.surv</span><span><span leaf="">$</span></span><span><span leaf="">`</span></span><span><span leaf="">1:DEATH</span></span><span><span leaf="">`</span></span><span><span leaf="">%in%</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">"alive"</span></span><span leaf="">,</span><span><span leaf="">"dead"</span></span><span leaf="">)),] </span><span><span leaf=""># 剔除无结局样本 # Excluded samples with no outcome</span></span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">comsam </span><span><span leaf="">&lt;-</span></span><span><span leaf="">intersect</span></span><span leaf="">(</span><span><span leaf="">rownames</span></span><span leaf="">(gse31210.surv),</span><span><span leaf="">colnames</span></span><span leaf="">(gse31210.expr)) </span><span><span leaf=""># 取出共享样本 # Take out the shared sample</span></span></span><span leaf=""><br></span><span><span leaf="">gse31210.expr </span><span><span leaf="">&lt;-</span></span><span leaf=""> gse31210.expr[,comsam]</span></span><span leaf=""><br></span><span><span leaf="">gse31210.surv </span><span><span leaf="">&lt;-</span></span><span leaf=""> gse31210.surv[comsam,]</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">gse31210.expr.surv </span><span><span leaf="">&lt;-</span></span><span><span leaf="">cbind.data.frame</span></span><span leaf="">(</span><span><span leaf="">data.frame</span></span><span leaf="">(</span><span><span leaf="">"OS"</span></span><span><span leaf="">=</span></span><span><span leaf="">ifelse</span></span><span leaf="">(gse31210.surv</span><span><span leaf="">$</span></span><span><span leaf="">`</span></span><span><span leaf="">1:DEATH</span></span><span><span leaf="">`</span></span><span><span leaf="">==</span></span><span><span leaf="">"dead"</span></span><span leaf="">, </span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">),</span></span><span leaf=""><br></span><span><span><span leaf="">"OS.time"</span></span><span><span leaf="">=</span></span><span leaf=""> gse31210.surv</span><span><span leaf="">$</span></span><span><span leaf="">`</span></span><span><span leaf="">1:DAYS BEFORE DEATH/CENSOR</span></span><span><span leaf="">`</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">stringsAsFactors =</span></span><span leaf=""> F),</span></span><span leaf=""><br></span><span><span><span leaf="">t</span></span><span leaf="">(</span><span><span leaf="">log2</span></span><span leaf="">(</span><span><span leaf="">as.matrix</span></span><span leaf="">(gse31210.expr[lasso_fea,]) </span><span><span leaf="">+</span></span><span><span leaf="">1</span></span><span leaf="">))) </span><span><span leaf=""># 表达谱对数化 # Logarithmicization of expression spectrum</span></span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf="">## 计算riskscore和C指数</span></span></span><span leaf=""><br></span><span><span><span leaf="">## Calculate riskscore and C index</span></span></span><span leaf=""><br></span><span><span leaf="">tmp </span><span><span leaf="">&lt;-</span></span><span><span leaf="">t</span></span><span leaf="">(</span><span><span leaf="">log2</span></span><span leaf="">(</span><span><span leaf="">as.matrix</span></span><span leaf="">(gse31210.expr[lasso_fea,]) </span><span><span leaf="">+</span></span><span><span leaf="">1</span></span><span leaf="">))</span></span><span leaf=""><br></span><span><span leaf="">risk.score.gse </span><span><span leaf="">&lt;-</span></span><span><span leaf="">apply</span></span><span leaf="">(tmp,</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">function</span></span><span leaf="">(x) {x </span><span><span leaf="">%*%</span></span><span><span leaf="">as.numeric</span></span><span leaf="">(lasso_coef)}) </span><span><span leaf=""># 表达加权系数求和计算riskscore # Expression weighting coefficient summation calculates riskscore</span></span></span><span leaf=""><br></span><span><span leaf="">cindex.gse </span><span><span leaf="">&lt;-</span></span><span><span leaf="">concordance.index</span></span><span leaf="">(risk.score.gse,</span></span><span leaf=""><br></span><span><span><span leaf="">surv.time =</span></span><span leaf=""> gse31210.expr.surv</span><span><span leaf="">$</span></span><span leaf="">OS.time,</span></span><span leaf=""><br></span><span><span><span leaf="">surv.event =</span></span><span leaf=""> gse31210.expr.surv</span><span><span leaf="">$</span></span><span leaf="">OS,</span></span><span leaf=""><br></span><span><span><span leaf="">method =</span></span><span><span leaf="">"noether"</span></span><span leaf="">)</span></span></code></pre><h2><span><span leaf="">9</span></span><span leaf=""> 开始画图</span></h2><pre><code><span><span><span leaf="">par</span></span><span leaf="">(</span><span><span leaf="">mfrow =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">2</span></span><span leaf="">)) </span><span><span leaf=""># 创建画图并分割成左右两块 # Create a drawing and divide it into left and right pieces</span></span></span><span leaf=""><br></span><span><span><span leaf="">## 图A</span></span></span><span leaf=""><br></span><span><span><span leaf="">## Figure A</span></span></span><span leaf=""><br></span><span><span><span leaf="">par</span></span><span leaf="">(</span><span><span leaf="">bty=</span></span><span><span leaf="">"o"</span></span><span leaf="">, </span><span><span leaf="">mgp =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">1.9</span></span><span leaf="">,.</span><span><span leaf="">33</span></span><span leaf="">,</span><span><span leaf="">0</span></span><span leaf="">), </span><span><span leaf="">mar=</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">5.1</span></span><span leaf="">,</span><span><span leaf="">3.1</span></span><span leaf="">,</span><span><span leaf="">2.1</span></span><span leaf="">,</span><span><span leaf="">2.1</span></span><span leaf="">)</span><span><span leaf="">+</span></span><span leaf="">.</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">las=</span></span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">tcl=</span></span><span><span leaf="">-</span></span><span leaf="">.</span><span><span leaf="">25</span></span><span leaf="">)</span></span><span leaf=""><br></span><span><span leaf="">plotdata </span><span><span leaf="">&lt;-</span></span><span><span leaf="">sort</span></span><span leaf="">(</span><span><span leaf="">table</span></span><span leaf="">(lasso_res</span><span><span leaf="">$</span></span><span leaf="">label))</span></span><span leaf=""><br></span><span><span leaf="">a </span><span><span leaf="">&lt;-</span></span><span><span leaf="">barplot</span></span><span leaf="">(plotdata,</span></span><span leaf=""><br></span><span><span><span leaf="">ylab =</span></span><span><span leaf="">"Frequency"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">col =</span></span><span><span leaf="">"<a topic-id="mk15dnmo-hqx1il" data-topic="1">#00CDCD</a>"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">main =</span></span><span><span leaf="">"Frequency of models"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">border =</span></span><span><span leaf="">NA</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">xaxt =</span></span><span><span leaf="">"n"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">ylim =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">max</span></span><span leaf="">(plotdata) </span><span><span leaf="">+</span></span><span><span leaf="">70</span></span><span leaf="">))</span></span><span leaf=""><br></span><span><span><span leaf="">axis</span></span><span leaf="">(</span><span><span leaf="">side =</span></span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">at =</span></span><span leaf=""> a, </span><span><span leaf="">names</span></span><span leaf="">(plotdata), </span><span><span leaf="">las =</span></span><span><span leaf="">2</span></span><span leaf="">) </span><span><span leaf=""># 添加x轴标签 # Add x-axis labels</span></span></span><span leaf=""><br></span><span><span><span leaf="">text</span></span><span leaf="">(a, </span><span><span leaf="">as.numeric</span></span><span leaf="">(plotdata) </span><span><span leaf="">+</span></span><span><span leaf="">30</span></span><span leaf="">, </span><span><span leaf="">as.numeric</span></span><span leaf="">(plotdata), </span><span><span leaf="">xpd =</span></span><span leaf=""> T) </span><span><span leaf=""># 添加基因数目 # Add the number of genes</span></span></span><span leaf=""><br></span><span><span><span leaf="">par</span></span><span leaf="">(</span><span><span leaf="">new =</span></span><span leaf=""> T, </span><span><span leaf="">bty=</span></span><span><span leaf="">"o"</span></span><span leaf="">, </span><span><span leaf="">mgp =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">1.9</span></span><span leaf="">,.</span><span><span leaf="">33</span></span><span leaf="">,</span><span><span leaf="">0</span></span><span leaf="">), </span><span><span leaf="">mar=</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">5.1</span></span><span leaf="">,</span><span><span leaf="">3.1</span></span><span leaf="">,</span><span><span leaf="">2.1</span></span><span leaf="">,</span><span><span leaf="">2.1</span></span><span leaf="">)</span><span><span leaf="">+</span></span><span leaf="">.</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">las=</span></span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">tcl=</span></span><span><span leaf="">-</span></span><span leaf="">.</span><span><span leaf="">25</span></span><span leaf="">) </span><span><span leaf=""># 补全黑色边框 # Complete the black border</span></span></span><span leaf=""><br></span><span><span><span leaf="">plot</span></span><span leaf="">(</span><span><span leaf="">NULL</span></span><span leaf="">, </span><span><span leaf="">NULL</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">col =</span></span><span><span leaf="">"white"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">xlim =</span></span><span><span leaf="">range</span></span><span leaf="">(a), </span><span><span leaf="">ylim =</span></span><span><span leaf="">range</span></span><span leaf="">(plotdata),</span></span><span leaf=""><br></span><span><span><span leaf="">xlab =</span></span><span><span leaf="">""</span></span><span leaf="">, </span><span><span leaf="">ylab =</span></span><span><span leaf="">""</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">xaxt =</span></span><span><span leaf="">"n"</span></span><span leaf="">, </span><span><span leaf="">yaxt =</span></span><span><span leaf="">"n"</span></span><span leaf="">)</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span><span leaf="">## 图B</span></span></span><span leaf=""><br></span><span><span><span leaf="">## Figure B</span></span></span><span leaf=""><br></span><span><span><span leaf="">par</span></span><span leaf="">(</span><span><span leaf="">bty=</span></span><span><span leaf="">"o"</span></span><span leaf="">, </span><span><span leaf="">mgp =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">1.9</span></span><span leaf="">,.</span><span><span leaf="">33</span></span><span leaf="">,</span><span><span leaf="">0</span></span><span leaf="">), </span><span><span leaf="">mar=</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">5.1</span></span><span leaf="">,</span><span><span leaf="">3.1</span></span><span leaf="">,</span><span><span leaf="">2.1</span></span><span leaf="">,</span><span><span leaf="">2.1</span></span><span leaf="">)</span><span><span leaf="">+</span></span><span leaf="">.</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">las=</span></span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">tcl=</span></span><span><span leaf="">-</span></span><span leaf="">.</span><span><span leaf="">25</span></span><span leaf="">)</span></span><span leaf=""><br></span><span><span leaf="">cindex </span><span><span leaf="">&lt;-</span></span><span><span leaf="">c</span></span><span leaf="">(cindex.gse</span><span><span leaf="">$</span></span><span leaf="">c.index, cindex.tcga</span><span><span leaf="">$</span></span><span leaf="">c.index)</span></span><span leaf=""><br></span><span><span leaf="">b </span><span><span leaf="">&lt;-</span></span><span><span leaf="">barplot</span></span><span leaf="">(cindex,</span></span><span leaf=""><br></span><span><span><span leaf="">border =</span></span><span><span leaf="">NA</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">ylim =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">),</span></span><span leaf=""><br></span><span><span><span leaf="">col =</span></span><span><span leaf="">"<a topic-id="mk15dnmo-i700hm" data-topic="1">#00CDCD</a>"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">main =</span></span><span><span leaf="">"c-index"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">ylab =</span></span><span><span leaf="">"c-index"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">xaxt =</span></span><span><span leaf="">"n"</span></span><span leaf="">)</span></span><span leaf=""><br></span><span><span><span leaf="">axis</span></span><span leaf="">(</span><span><span leaf="">side =</span></span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">at =</span></span><span leaf=""> b, </span><span><span leaf="">labels =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">"GSE31210"</span></span><span leaf="">,</span><span><span leaf="">"TCGA"</span></span><span leaf="">), </span><span><span leaf="">las =</span></span><span><span leaf="">2</span></span><span leaf="">) </span><span><span leaf=""># 添加x轴标签 # Add x-axis labels</span></span></span><span leaf=""><br></span><span><span><span leaf="">par</span></span><span leaf="">(</span><span><span leaf="">new =</span></span><span leaf=""> T, </span><span><span leaf="">bty=</span></span><span><span leaf="">"o"</span></span><span leaf="">, </span><span><span leaf="">mgp =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">1.9</span></span><span leaf="">,.</span><span><span leaf="">33</span></span><span leaf="">,</span><span><span leaf="">0</span></span><span leaf="">), </span><span><span leaf="">mar=</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">5.1</span></span><span leaf="">,</span><span><span leaf="">3.1</span></span><span leaf="">,</span><span><span leaf="">2.1</span></span><span leaf="">,</span><span><span leaf="">2.1</span></span><span leaf="">)</span><span><span leaf="">+</span></span><span leaf="">.</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">las=</span></span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">tcl=</span></span><span><span leaf="">-</span></span><span leaf="">.</span><span><span leaf="">25</span></span><span leaf="">) </span><span><span leaf=""># 补全黑色边框 # Complete the black border</span></span></span><span leaf=""><br></span><span><span><span leaf="">plot</span></span><span leaf="">(</span><span><span leaf="">NULL</span></span><span leaf="">, </span><span><span leaf="">NULL</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">col =</span></span><span><span leaf="">"white"</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">xlim =</span></span><span><span leaf="">range</span></span><span leaf="">(b), </span><span><span leaf="">ylim =</span></span><span><span leaf="">c</span></span><span leaf="">(</span><span><span leaf="">0</span></span><span leaf="">,</span><span><span leaf="">1</span></span><span leaf="">),</span></span><span leaf=""><br></span><span><span><span leaf="">xlab =</span></span><span><span leaf="">""</span></span><span leaf="">, </span><span><span leaf="">ylab =</span></span><span><span leaf="">""</span></span><span leaf="">,</span></span><span leaf=""><br></span><span><span><span leaf="">xaxt =</span></span><span><span leaf="">"n"</span></span><span leaf="">, </span><span><span leaf="">yaxt =</span></span><span><span leaf="">"n"</span></span><span leaf="">)</span></span></code></pre><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7Bwuzdua4wibGsCiaal8IV2jubW9bgOxXYic5a9H1icicGEYfiazeHQSibDGn0bjkHSUOJtmUozUuveDl4zCPdZA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7138888888888889" data-type="png" data-w="1080" width="672" data-imgfileid="100004309" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/fTGTY7Bwuzdua4wibGsCiaal8IV2jubW9bgOxXYic5a9H1icicGEYfiazeHQSibDGn0bjkHSUOJtmUozUuveDl4zCPdZA/640?wx_fmt=png&amp;from=appmsg"></section><pre><code><span><span><span leaf="">dev.copy2pdf</span></span><span leaf="">(</span><span><span leaf="">file =</span></span><span><span leaf="">"frequency and cindex of model.pdf"</span></span><span leaf="">, </span><span><span leaf="">width =</span></span><span><span leaf="">8</span></span><span leaf="">, </span><span><span leaf="">height =</span></span><span><span leaf="">4.5</span></span><span leaf="">) </span><span><span leaf=""># 保存图片 # Save the image</span></span></span></code></pre><pre><code><span leaf="">## quartz_off_screen </span><span leaf=""><br></span><span leaf="">##                 2</span></code></pre></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/hjGJuj9F9lmgKPao8VW_bA",target="_blank" rel="noopener noreferrer">原文链接</a>
