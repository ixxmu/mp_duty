---
title: "python版单细胞注释：基于已知marker基因注释"
date: 2026-01-27T04:20:57Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
python版单细胞注释：基于已知marker基因注释 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">前面看到一个学妹在学习python，她的一篇推文中提到了一个python代码的学习资源，今天来看看里面的细胞注释部分。</span></p><blockquote><span></span><p><span leaf="">https://www.sc-best-practices.org/preamble.html</span></p></blockquote><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">So what is a cell type?</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">什么是细胞类型？</span></p><p data-tool="mdnice编辑器"><strong><span leaf=""><span textstyle="">生物学家使用"细胞类型"这一术语指代在数据集中具有稳定性、可通过特定标记物（如蛋白质或基因转录本）表达进行识别，且常与特定功能相关联的细胞表型。</span></span></strong><span leaf="">例如，浆细胞B细胞是一种能分泌抗体对抗病原体的白细胞类型，可通过特定标记物进行识别。了解样本中存在的细胞类型对理解数据至关重要。比如，发现肿瘤中存在特定免疫细胞类型，或骨髓样本中出现异常造血干细胞，可能为您研究的疾病提供宝贵见解。</span></p><p data-tool="mdnice编辑器"><span leaf="">专业词汇：<span textstyle="">“subtypes” or “cell states” ，“cell identity”</span>，三者往往混用有区别又有联系，看下面这两个文献对其的讨论与定义：</span></p><ul><li><section><p><span leaf="">Revealing the vectors of cellular identity with single-cell genomics. Nature Biotechnology</span></p></section></li><li><section><p><span leaf="">Hongkui Zeng. What is a cell type and how to define it? Cell</span></p></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">那么，在单细胞数据中如何进行细胞注释？注释方法多种多样，下文将概述不同策略。<span textstyle="">由于我们处理的是</span><span textstyle="">转录组数据</span><span textstyle="">，所有方法最终都基于特定基因或基因集的表达，以及细胞间的整体转录组相似性。</span></span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKbiaeWdwzhvNxbevdicl6aLOJos1G6DsUibFhNaGPxT2qQUWfAYib4T5XEA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7074074074074074" data-type="png" data-w="1080" data-imgfileid="100065050" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKbiaeWdwzhvNxbevdicl6aLOJos1G6DsUibFhNaGPxT2qQUWfAYib4T5XEA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">图来源：https://www.worksheetsplanet.com/what-is-a-cell/</span></p><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">1 环境配置</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">过滤掉不影响代码运行的弃用警告和性能警告：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">import</span></span><span leaf=""> warnings</span><span leaf=""><br></span><span leaf="">warnings.filterwarnings(</span><span><span leaf="">"ignore"</span></span><span leaf="">, category=DeprecationWarning)</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> numba.core.errors </span><span><span leaf="">import</span></span><span leaf=""> NumbaDeprecationWarning</span><span leaf=""><br></span><span leaf="">warnings.simplefilter(</span><span><span leaf="">"ignore"</span></span><span leaf="">, category=NumbaDeprecationWarning)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">导入模块：</span></p><p data-tool="mdnice编辑器"><span leaf="">我都装在了conda小环境 sc中，这里有个自动注释的模块很难配置（scarches），但是本期没有安装上不会影响下面的内容。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">import</span></span><span leaf=""> urllib.request</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> pathlib </span><span><span leaf="">import</span></span><span leaf=""> Path</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> celltypist</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> matplotlib.pyplot </span><span><span leaf="">as</span></span><span leaf=""> plt</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> numpy </span><span><span leaf="">as</span></span><span leaf=""> np</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> pandas </span><span><span leaf="">as</span></span><span leaf=""> pd</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> scanpy </span><span><span leaf="">as</span></span><span leaf=""> sc</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> scarches </span><span><span leaf="">as</span></span><span leaf=""> sca</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> seaborn </span><span><span leaf="">as</span></span><span leaf=""> sns</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> celltypist </span><span><span leaf="">import</span></span><span leaf=""> models</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> scipy.sparse </span><span><span leaf="">import</span></span><span leaf=""> csr_matrix</span><span leaf=""><br></span></code></pre><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">2 示例数据</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">数据来自这里，https://openreview.net/forum?id=gN35BGa1Rt，该数据集捕获了来自<span textstyle="">12位健康人类供者的骨髓单核细胞</span>单细胞多组学数据。</span></p><p data-tool="mdnice编辑器"><span leaf="">下载地址：</span></p><blockquote><span></span><p><span leaf="">https://figshare.com/ndownloader/files/41436666</span></p></blockquote><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">3 细胞注释</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">两种路径：</span></p><ul><li><section><span leaf="">从已知细胞类型标记基因表出发 → 匹配至聚类群组</span></section></li><li><section><span leaf="">从聚类的高表达基因出发 → 关联至已知细胞类型</span></section></li></ul><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">3.1 从标记基因到聚类注释</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">首先列出一组基于文献的骨髓细胞类型标记基因：这些标记来自以往研究特定细胞类型和亚型、并报道了相应标记基因的论文。</span><strong><span leaf=""><span textstyle="">需要注意的是，蛋白质水平的标记（例如用于流式细胞术的标记）</span><span textstyle="">有时在转录组数据中效果不佳</span><span textstyle="">，因此使用基于RNA研究的论文中的标记通常更有效。</span></span></strong></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">理想情况下，标记基因集应在多个数据集中得到验证。</span></span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">此外，与领域专家合作通常很有帮助</span>：作为生物信息学家，尝试与更深入了解组织特性、生物学背景、预期细胞类型和标记基因的生物学家合作。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">marker_genes = {</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"CD14+ Mono"</span></span><span leaf="">: [</span><span><span leaf="">"FCN1"</span></span><span leaf="">, </span><span><span leaf="">"CD14"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"CD16+ Mono"</span></span><span leaf="">: [</span><span><span leaf="">"TCF7L2"</span></span><span leaf="">, </span><span><span leaf="">"FCGR3A"</span></span><span leaf="">, </span><span><span leaf="">"LYN"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"ID2-hi myeloid prog"</span></span><span leaf="">: [</span><span><span leaf="">"CD14"</span></span><span leaf="">, </span><span><span leaf="">"ID2"</span></span><span leaf="">, </span><span><span leaf="">"VCAN"</span></span><span leaf="">, </span><span><span leaf="">"S100A9"</span></span><span leaf="">, </span><span><span leaf="">"CLEC12A"</span></span><span leaf="">, </span><span><span leaf="">"KLF4"</span></span><span leaf="">, </span><span><span leaf="">"PLAUR"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"cDC1"</span></span><span leaf="">: [</span><span><span leaf="">"CLEC9A"</span></span><span leaf="">, </span><span><span leaf="">"CADM1"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"cDC2"</span></span><span leaf="">: [</span><span><span leaf="">"CST3"</span></span><span leaf="">, </span><span><span leaf="">"COTL1"</span></span><span leaf="">, </span><span><span leaf="">"LYZ"</span></span><span leaf="">, </span><span><span leaf="">"DMXL2"</span></span><span leaf="">, </span><span><span leaf="">"CLEC10A"</span></span><span leaf="">, </span><span><span leaf="">"FCER1A"</span></span><span leaf="">],  </span><span><span leaf=""># Note: DMXL2 should be negative</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Normoblast"</span></span><span leaf="">: [</span><span><span leaf="">"SLC4A1"</span></span><span leaf="">, </span><span><span leaf="">"SLC25A37"</span></span><span leaf="">, </span><span><span leaf="">"HBB"</span></span><span leaf="">, </span><span><span leaf="">"HBA2"</span></span><span leaf="">, </span><span><span leaf="">"HBA1"</span></span><span leaf="">, </span><span><span leaf="">"TFRC"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Erythroblast"</span></span><span leaf="">: [</span><span><span leaf="">"MKI67"</span></span><span leaf="">, </span><span><span leaf="">"HBA1"</span></span><span leaf="">, </span><span><span leaf="">"HBB"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Proerythroblast"</span></span><span leaf="">: [</span><span><span leaf="">"CDK6"</span></span><span leaf="">, </span><span><span leaf="">"SYNGR1"</span></span><span leaf="">, </span><span><span leaf="">"HBM"</span></span><span leaf="">, </span><span><span leaf="">"GYPA"</span></span><span leaf="">],  </span><span><span leaf=""># Note HBM and GYPA are negative markers</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"NK"</span></span><span leaf="">: [</span><span><span leaf="">"GNLY"</span></span><span leaf="">, </span><span><span leaf="">"NKG7"</span></span><span leaf="">, </span><span><span leaf="">"CD247"</span></span><span leaf="">, </span><span><span leaf="">"GRIK4"</span></span><span leaf="">, </span><span><span leaf="">"FCER1G"</span></span><span leaf="">, </span><span><span leaf="">"TYROBP"</span></span><span leaf="">, </span><span><span leaf="">"KLRG1"</span></span><span leaf="">, </span><span><span leaf="">"FCGR3A"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"ILC"</span></span><span leaf="">: [</span><span><span leaf="">"ID2"</span></span><span leaf="">, </span><span><span leaf="">"PLCG2"</span></span><span leaf="">, </span><span><span leaf="">"GNLY"</span></span><span leaf="">, </span><span><span leaf="">"SYNE1"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Lymph prog"</span></span><span leaf="">: [</span><span><span leaf="">"VPREB1"</span></span><span leaf="">, </span><span><span leaf="">"MME"</span></span><span leaf="">, </span><span><span leaf="">"EBF1"</span></span><span leaf="">, </span><span><span leaf="">"SSBP2"</span></span><span leaf="">, </span><span><span leaf="">"BACH2"</span></span><span leaf="">, </span><span><span leaf="">"CD79B"</span></span><span leaf="">, </span><span><span leaf="">"IGHM"</span></span><span leaf="">, </span><span><span leaf="">"PAX5"</span></span><span leaf="">, </span><span><span leaf="">"PRKCE"</span></span><span leaf="">, </span><span><span leaf="">"DNTT"</span></span><span leaf="">, </span><span><span leaf="">"IGLL1"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Naive CD20+ B"</span></span><span leaf="">: [</span><span><span leaf="">"MS4A1"</span></span><span leaf="">, </span><span><span leaf="">"IL4R"</span></span><span leaf="">, </span><span><span leaf="">"IGHD"</span></span><span leaf="">, </span><span><span leaf="">"FCRL1"</span></span><span leaf="">, </span><span><span leaf="">"IGHM"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"B1 B"</span></span><span leaf="">: [</span><span><span leaf="">"MS4A1"</span></span><span leaf="">, </span><span><span leaf="">"SSPN"</span></span><span leaf="">, </span><span><span leaf="">"ITGB1"</span></span><span leaf="">, </span><span><span leaf="">"EPHA4"</span></span><span leaf="">, </span><span><span leaf="">"COL4A4"</span></span><span leaf="">, </span><span><span leaf="">"PRDM1"</span></span><span leaf="">, </span><span><span leaf="">"IRF4"</span></span><span leaf="">, </span><span><span leaf="">"CD38"</span></span><span leaf="">, </span><span><span leaf="">"XBP1"</span></span><span leaf="">, </span><span><span leaf="">"PAX5"</span></span><span leaf="">, </span><span><span leaf="">"BCL11A"</span></span><span leaf="">, </span><span><span leaf="">"BLK"</span></span><span leaf="">, </span><span><span leaf="">"IGHD"</span></span><span leaf="">, </span><span><span leaf="">"IGHM"</span></span><span leaf="">, </span><span><span leaf="">"ZNF215"</span></span><span leaf="">],  </span><span><span leaf=""># Note IGHD and IGHM are negative markers</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Transitional B"</span></span><span leaf="">: [</span><span><span leaf="">"MME"</span></span><span leaf="">, </span><span><span leaf="">"CD38"</span></span><span leaf="">, </span><span><span leaf="">"CD24"</span></span><span leaf="">, </span><span><span leaf="">"ACSM3"</span></span><span leaf="">, </span><span><span leaf="">"MSI2"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Plasma cells"</span></span><span leaf="">: [</span><span><span leaf="">"MZB1"</span></span><span leaf="">, </span><span><span leaf="">"HSP90B1"</span></span><span leaf="">, </span><span><span leaf="">"FNDC3B"</span></span><span leaf="">, </span><span><span leaf="">"PRDM1"</span></span><span leaf="">, </span><span><span leaf="">"IGKC"</span></span><span leaf="">, </span><span><span leaf="">"JCHAIN"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Plasmablast"</span></span><span leaf="">: [</span><span><span leaf="">"XBP1"</span></span><span leaf="">, </span><span><span leaf="">"RF4"</span></span><span leaf="">, </span><span><span leaf="">"PRDM1"</span></span><span leaf="">, </span><span><span leaf="">"PAX5"</span></span><span leaf="">],  </span><span><span leaf=""># Note PAX5 is a negative marker</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"CD4+ T activated"</span></span><span leaf="">: [</span><span><span leaf="">"CD4"</span></span><span leaf="">, </span><span><span leaf="">"IL7R"</span></span><span leaf="">, </span><span><span leaf="">"TRBC2"</span></span><span leaf="">, </span><span><span leaf="">"ITGB1"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"CD4+ T naive"</span></span><span leaf="">: [</span><span><span leaf="">"CD4"</span></span><span leaf="">, </span><span><span leaf="">"IL7R"</span></span><span leaf="">, </span><span><span leaf="">"TRBC2"</span></span><span leaf="">, </span><span><span leaf="">"CCR7"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"CD8+ T"</span></span><span leaf="">: [</span><span><span leaf="">"CD8A"</span></span><span leaf="">, </span><span><span leaf="">"CD8B"</span></span><span leaf="">, </span><span><span leaf="">"GZMK"</span></span><span leaf="">, </span><span><span leaf="">"GZMA"</span></span><span leaf="">, </span><span><span leaf="">"CCL5"</span></span><span leaf="">, </span><span><span leaf="">"GZMB"</span></span><span leaf="">, </span><span><span leaf="">"GZMH"</span></span><span leaf="">, </span><span><span leaf="">"GZMA"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"T activation"</span></span><span leaf="">: [</span><span><span leaf="">"CD69"</span></span><span leaf="">, </span><span><span leaf="">"CD38"</span></span><span leaf="">],  </span><span><span leaf=""># CD69 much better marker!</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"T naive"</span></span><span leaf="">: [</span><span><span leaf="">"LEF1"</span></span><span leaf="">, </span><span><span leaf="">"CCR7"</span></span><span leaf="">, </span><span><span leaf="">"TCF7"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"pDC"</span></span><span leaf="">: [</span><span><span leaf="">"GZMB"</span></span><span leaf="">, </span><span><span leaf="">"IL3RA"</span></span><span leaf="">, </span><span><span leaf="">"COBLL1"</span></span><span leaf="">, </span><span><span leaf="">"TCF4"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"G/M prog"</span></span><span leaf="">: [</span><span><span leaf="">"MPO"</span></span><span leaf="">, </span><span><span leaf="">"BCL2"</span></span><span leaf="">, </span><span><span leaf="">"KCNQ5"</span></span><span leaf="">, </span><span><span leaf="">"CSF3R"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"HSC"</span></span><span leaf="">: [</span><span><span leaf="">"NRIP1"</span></span><span leaf="">, </span><span><span leaf="">"MECOM"</span></span><span leaf="">, </span><span><span leaf="">"PROM1"</span></span><span leaf="">, </span><span><span leaf="">"NKAIN2"</span></span><span leaf="">, </span><span><span leaf="">"CD34"</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"MK/E prog"</span></span><span leaf="">: [</span><span><span leaf="">"ZNF385D"</span></span><span leaf="">, </span><span><span leaf="">"ITGA2B"</span></span><span leaf="">, </span><span><span leaf="">"RYR3"</span></span><span leaf="">, </span><span><span leaf="">"PLCB1"</span></span><span leaf="">],  </span><span><span leaf=""># Note PLCB1 is a negative marker</span></span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">筛选出仅在本数据中检测到的标记基因：仅保留在adata对象中能找到的基因作为该细胞类型的标记。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">marker_genes_in_data = {}</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> ct, markers </span><span><span leaf="">in</span></span><span leaf=""> marker_genes.items():</span><span leaf=""><br></span><span leaf="">    markers_found = []</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">for</span></span><span leaf=""> marker </span><span><span leaf="">in</span></span><span leaf=""> markers:</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf="">if</span></span><span leaf=""> marker </span><span><span leaf="">in</span></span><span leaf=""> adata.var.index:</span><span leaf=""><br></span><span leaf="">            markers_found.append(marker)</span><span leaf=""><br></span><span leaf="">    marker_genes_in_data[ct] = markers_found</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">UMAP图展示marker基因的表达</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">先使用scran对数据进行标准化处理，然后降维：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">adata.var[</span><span><span leaf="">"highly_variable"</span></span><span leaf="">] = adata.var[</span><span><span leaf="">"highly_deviant"</span></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">sc.tl.pca(adata, n_comps=</span><span><span leaf="">50</span></span><span leaf="">, use_highly_variable=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(adata)</span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">如展示 展示B细胞/浆细胞亚型的marker基因：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">B_plasma_cts = [</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Naive CD20+ B"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"B1 B"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Transitional B"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Plasma cells"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Plasmablast"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 绘图</span></span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> ct </span><span><span leaf="">in</span></span><span leaf=""> B_plasma_cts:</span><span leaf=""><br></span><span leaf="">    print(</span><span><span leaf="">f"</span><span><span leaf="">{ct.upper()}</span></span><span leaf="">:"</span></span><span leaf="">)  </span><span><span leaf=""># print cell subtype name</span></span><span leaf=""><br></span><span leaf="">    sc.pl.umap( adata, color=marker_genes_in_data[ct], vmin=</span><span><span leaf="">0</span></span><span leaf="">, vmax=</span><span><span leaf="">"p99"</span></span><span leaf="">,  sort_order=</span><span><span leaf="">False</span></span><span leaf="">,  frameon=</span><span><span leaf="">False</span></span><span leaf="">, cmap=</span><span><span leaf="">"Reds"</span></span><span leaf="">, </span><span leaf=""><br></span><span leaf="">    )</span><span leaf=""><br></span><span leaf="">    print(</span><span><span leaf="">"\n\n\n"</span></span><span leaf="">)  </span><span><span leaf=""># print white space for legibility</span></span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwK3nulyAWWo8iaxVOBvxJAWFyeQiakqoS0EhE376H1J3ZhPblhMIJRs92w/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.45555555555555555" data-type="png" data-w="1080" data-imgfileid="100065049" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwK3nulyAWWo8iaxVOBvxJAWFyeQiakqoS0EhE376H1J3ZhPblhMIJRs92w/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">上面共画了5个B细胞亚群，这里放其中一组。从上面（还没有做聚类）可以看出：</span></p><blockquote><span></span><p><strong><span leaf="">标记基因的表达往往较为稀疏，即通常仅在细胞类型的一部分细胞中检测到标记基因表达。</span></strong><span leaf="">这是由于scRNA-seq数据的本质决定的：我们仅对细胞中总RNA分子的一个小子集进行测序，由于这种抽样特性，有时即便基因在细胞中表达，我们也可能无法捕获该基因的转录本。</span></p></blockquote><p data-tool="mdnice编辑器"><span leaf="">scRNA-seq细胞注释应基于聚类群体的整体标记基因表达模式，而非依赖单个细胞或基因的表达阈值，以克服数据稀疏性和技术噪声的影响。</span></p><p data-tool="mdnice编辑器"><span leaf="">此外，其他的色系可选：</span></p><blockquote><span></span><p><span leaf="">https://matplotlib.org/stable/tutorials/colors/colormaps.html</span></p></blockquote><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">聚类</span></span><span></span></h4><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 测试多个分辨率并保存结果</span></span><span leaf=""><br></span><span leaf="">resolutions = [</span><span><span leaf="">1</span></span><span leaf="">,</span><span><span leaf="">2</span></span><span leaf="">]</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> i, res </span><span><span leaf="">in</span></span><span leaf=""> enumerate(resolutions):</span><span leaf=""><br></span><span leaf="">    sc.tl.leiden(adata, resolution=res, key_added=</span><span><span leaf="">f"leiden_res</span><span><span leaf="">{res}</span></span><span leaf="">"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    </span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata, color=</span><span><span leaf="">"leiden_res2"</span></span><span leaf="">, legend_loc=</span><span><span leaf="">'on data'</span></span><span leaf="">,legend_fontsize=</span><span><span leaf="">12</span></span><span leaf="">)  </span><span><span leaf=""># 在数据点上显示</span></span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKk2luRicq30DicFuWx2Nk7mKLCD0uDY0fggVCLp4XVBk78Tz7b7f6msicQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.0316546762589929" data-type="png" data-w="695" data-imgfileid="100065046" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKk2luRicq30DicFuWx2Nk7mKLCD0uDY0fggVCLp4XVBk78Tz7b7f6msicQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">点图</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">通过点图对标记基因表达模式进行可视化验证</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">B_plasma_markers = {</span><span leaf=""><br></span><span leaf="">    ct: [m </span><span><span leaf="">for</span></span><span leaf=""> m </span><span><span leaf="">in</span></span><span leaf=""> ct_markers </span><span><span leaf="">if</span></span><span leaf=""> m </span><span><span leaf="">in</span></span><span leaf=""> adata.var.index]</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">for</span></span><span leaf=""> ct, ct_markers </span><span><span leaf="">in</span></span><span leaf=""> marker_genes.items()</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">if</span></span><span leaf=""> ct </span><span><span leaf="">in</span></span><span leaf=""> B_plasma_cts</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sc.pl.dotplot( adata, groupby=</span><span><span leaf="">"leiden_res2"</span></span><span leaf="">, var_names=B_plasma_markers, </span><span leaf=""><br></span><span leaf="">              standard_scale=</span><span><span leaf="">"var"</span></span><span leaf="">,  </span><span><span leaf=""># standard scale: normalize each gene to range from 0 to 1</span></span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKC29kRhEaUxOia7AbaYMO9mwADUqnYbVOKNSD3IeUeEmb5qexO8EAY6A/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6666666666666666" data-type="png" data-w="1080" data-imgfileid="100065048" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKC29kRhEaUxOia7AbaYMO9mwADUqnYbVOKNSD3IeUeEmb5qexO8EAY6A/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">注释</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">结合UMAP图的直观观察与上述点图分析，我们现在可以开始对聚类进行注释：</span></p><blockquote><span></span><p><span leaf="">B1 B细胞的注释较为困难，没有哪个聚类能表达所有B1 B标记基因，而多个聚类仅表达了部分标记。<span textstyle="">我们常发现适用于某个数据集的标记基因在其他数据集中效果不佳。这可能源于测序深度的差异，也可能因数据集或样本间的其他变异因素所致。</span></span></p></blockquote><pre data-tool="mdnice编辑器"><code><span leaf="">cl_annotation = {</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"5"</span></span><span leaf="">: </span><span><span leaf="">"Naive CD20+ B"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"6"</span></span><span leaf="">: </span><span><span leaf="">"Naive CD20+ B"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"8"</span></span><span leaf="">: </span><span><span leaf="">"Transitional B"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"17"</span></span><span leaf="">: </span><span><span leaf="">"B1 B"</span></span><span leaf="">,  </span><span><span leaf=""># note that IGHD and IGHM are negative markers, in this case more lowly expressed than in the other B cell clusters</span></span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">"manual_celltype_annotation"</span></span><span leaf="">] = adata.obs.leiden_res2.map(cl_annotation)</span><span leaf=""><br></span><span leaf="">sc.pl.umap(adata, color=[</span><span><span leaf="">"manual_celltype_annotation"</span></span><span leaf="">])</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKm7mGLsEeCAibIP33icYUXJDqMX79bufLj5cp1cXrQzLibu9QnOCud1BGA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7316326530612245" data-type="png" data-w="980" data-imgfileid="100065047" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKm7mGLsEeCAibIP33icYUXJDqMX79bufLj5cp1cXrQzLibu9QnOCud1BGA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">3.2 从聚类差异表达基因到聚类注释</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">相反地，我们可以计算每个聚类的差异表达基因，然后查证这些基因是否与已知的生物学特征（如细胞类型和/或状态）相关联。</span></p><p data-tool="mdnice编辑器"><span leaf="">计算每个聚类相对于adata中其余细胞的差异表达基因：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">sc.tl.rank_genes_groups(</span><span leaf=""><br></span><span leaf="">    adata, groupby=</span><span><span leaf="">"leiden_res2"</span></span><span leaf="">, method=</span><span><span leaf="">"wilcoxon"</span></span><span leaf="">, key_added=</span><span><span leaf="">"dea_leiden_2"</span></span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 过滤</span></span><span leaf=""><br></span><span leaf="">sc.tl.filter_rank_genes_groups(</span><span leaf=""><br></span><span leaf="">    adata,</span><span leaf=""><br></span><span leaf="">    min_in_group_fraction=</span><span><span leaf="">0.2</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    max_out_group_fraction=</span><span><span leaf="">0.2</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    key=</span><span><span leaf="">"dea_leiden_2"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    key_added=</span><span><span leaf="">"dea_leiden_2_filtered"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 展示top5</span></span><span leaf=""><br></span><span leaf="">sc.pl.rank_genes_groups_dotplot(</span><span leaf=""><br></span><span leaf="">    adata,</span><span leaf=""><br></span><span leaf="">    groupby=</span><span><span leaf="">"leiden_res2"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    standard_scale=</span><span><span leaf="">"var"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    n_genes=</span><span><span leaf="">5</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    key=</span><span><span leaf="">"dea_leiden_2_filtered"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKFaKk6TnRvtlv0ZgiaU61Gz0QjmuHCBqdabRRK1bky1Q8Zj84gXHhsKQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.2490740740740741" data-type="png" data-w="1080" data-imgfileid="100065053" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKFaKk6TnRvtlv0ZgiaU61Gz0QjmuHCBqdabRRK1bky1Q8Zj84gXHhsKQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">聚类13:</span></span><span></span></h4><blockquote><span></span><p><span leaf="">似乎拥有一组相对独特的标记基因，包括CDK6、ETV6、NKAIN2和GNAQ。通过检索发现，NKAIN2和ETV6是造血干细胞标记物[Shi等人, 2022][Wang等人, 1998]（NKAIN2也出现在我们之前的列表中）。</span></p></blockquote><p data-tool="mdnice编辑器"><span leaf="">从UMAP图中可以看到，这些基因在整个聚类13中均有表达：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKIxiaK5iaZTsTk4MAQhlmwMQBomfb49oIDA1iaR2JkdLfsg77uCicSoUv1g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.44907407407407407" data-type="png" data-w="1080" data-imgfileid="100065054" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKIxiaK5iaZTsTk4MAQhlmwMQBomfb49oIDA1iaR2JkdLfsg77uCicSoUv1g/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">但是，观察巨核细胞/红细胞祖细胞（"MK/E prog"）的已知标记基因时，我们发现聚类13的部分细胞似乎属于该细胞类型：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">sc.pl.umap(</span><span leaf=""><br></span><span leaf="">    adata,</span><span leaf=""><br></span><span leaf="">    color=[ </span><span><span leaf="">"ZNF385D"</span></span><span leaf="">,</span><span><span leaf="">"ITGA2B"</span></span><span leaf="">,</span><span><span leaf="">"RYR3"</span></span><span leaf="">,</span><span><span leaf="">"PLCB1"</span></span><span leaf="">,],</span><span leaf=""><br></span><span leaf="">    vmax=</span><span><span leaf="">"p99"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    legend_loc=</span><span><span leaf="">"on data"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    frameon=</span><span><span leaf="">False</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    cmap=</span><span><span leaf="">"Reds"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKRq9wLBBoupp792MTjcsETAvxHz7GeicCKaNZvwMMZH2MWlNFcZVo7VQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.22870370370370371" data-type="png" data-w="1080" data-imgfileid="100065055" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzIacbAQJMwXrrLHBYE8VwKRq9wLBBoupp792MTjcsETAvxHz7GeicCKaNZvwMMZH2MWlNFcZVo7VQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">以上 两种方式凸显了基于标记基因注释的复杂性：它对所选聚类分辨率、所用标记基因集的稳健性和独特性，以及你对数据中预期细胞类型的了解程度均较为敏感。</span></p><p data-tool="mdnice编辑器"><span leaf="">最后保存一下数据：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">cl_annotation[</span><span><span leaf="">"13"</span></span><span leaf="">] = </span><span><span leaf="">"HSCs + MK/E prog (?)"</span></span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">"manual_celltype_annotation"</span></span><span leaf="">] = adata.obs.leiden_res2.map(cl_annotation)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">下一篇我们来做基于自动化的数据注释。</span></p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">转发：</span></span></p></section><ul><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247547917&amp;idx=1&amp;sn=76afb50b6e9e433e3f2b3d039f72dac4&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课2026年1月班" data-itemshowtype="0" linktype="text" data-linktype="2">生信入门&amp;数据挖掘线上直播课2026年1月班</a><span textstyle="">，你的生物信息学入门课</span></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247525079&amp;idx=1&amp;sn=0b997af16a58195b4192691373048fd5&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" data-itemshowtype="0" linktype="text" data-linktype="2"><span textstyle="">时隔5年，我们的生信技能树VIP学徒继续招生啦</span></a></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247530048&amp;idx=1&amp;sn=28aa7bbd5e00521f79e074496a5f5d66&amp;scene=21#wechat_redirect" textvalue="满足你生信分析计算需求的低价解决方案" data-itemshowtype="0" linktype="text" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=1679199708449144836&amp;scene=173&amp;subscene=207&amp;sessionid=1745492310&amp;enterid=1745492314&amp;from_msgid=2247541298&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="生信故事会" data-itemshowtype="0" linktype="text" data-linktype="2">生信故事会</a>，来看看他们的生信入门故事</span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=3690970204957147140&amp;scene=173&amp;subscene=207&amp;sessionid=1745066271&amp;enterid=1745066274&amp;from_msgid=2247540702&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="生信马拉松答疑专辑" data-itemshowtype="0" linktype="text" data-linktype="2">生信马拉松答疑专辑</a>，获取你的生信专属答疑</span></section></li></ul><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/_h9It_xvj2-nifEfCyfOzg",target="_blank" rel="noopener noreferrer">原文链接</a>
