---
title: "使用python来分析一下张泽民院士2018年的单细胞数据"
date: 2026-01-14T23:34:08Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
使用python来分析一下张泽民院士2018年的单细胞数据 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><blockquote><p><span leaf="">python基本部分学完了之后，见专辑《<a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=3824390528290897922&amp;scene=173&amp;subscene=207&amp;sessionid=1745573869&amp;enterid=1745573880&amp;from_msgid=2247541027&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="" linktype="text" data-linktype="2">python生信笔记</a>》，就需要开始进行大量的数据分析实战练习进行掌握了。今天来学习一篇顶刊杂志的单细胞数据处理，使用python！</span></p></blockquote><p data-tool="mdnice编辑器"><span leaf="">note：这个数据主要来自最近开一个直播进行实战训练，详细情况以及进群方式见：<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247547189&amp;idx=1&amp;sn=ac86db63a389fa5f819246db527475f0&amp;scene=21#wechat_redirect" textvalue="" linktype="text" data-linktype="2">python单细胞数据分析实战直播交流群</a></span></p><p data-tool="mdnice编辑器"><span leaf="">直播计划大纲：</span><span leaf="">https://www.yuque.com/xinnigegui-uqv7c/nneog4/ecg5ec5hscuiudqq</span></p><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">数据背景</span></span></h2><p data-tool="mdnice编辑器"><span leaf="">Guo_Zhang_2018_NSCLC  数据处理</span></p><p data-tool="mdnice编辑器"><span leaf="">今天分析直播的那篇文献里面里面提到的 Guo, Zhang et al. 数据，来自文献 10.1038/s41591-018-0045-3 。文献标题为《Global characterization of T cells in non-small-cell lung cancer by single-cell sequencing》。 2018 年6月25号发表在杂志Nature Medicine。</span></p><p data-tool="mdnice编辑器"><span leaf="">数据集为：data/12_input_adatas/guo_zhang_2018_nsclc.h5ad，在文献里面的下载地址为 ：https://zenodo.org/records/7227571，在里面的 input_data.tar.xz</span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">文献内容简介</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">本研究对 14 例未经治疗的非小细胞肺癌患者的 12,346 个T细胞进行了深度单细胞RNA测序。通过联合基因表达谱与基于T细胞抗原受体的谱系追踪技术，<span textstyle="">发现了具有高迁移特性的组织间效应T细胞的重要亚群。</span>除处于耗竭状态的 tumor-infiltrating CD8+ T cells 外，还观察到两个处于耗竭前状态的细胞群，且 <span textstyle="">pre-exhausted 与 exhausted T cells 的高比例与肺腺癌患者的良好预后相关</span>。此外，研究还发现 the tumor regulatory T cells (Tregs) 存在更深层异质性，其特征表现为抗原特异性 Tregs 激活标志物 TNFRSF9 的双峰分布。这些活化肿瘤 Tregs 的基因标志（包括 IL1R2 ）与肺腺癌不良预后相关。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGJnDBKWice5lebf4MwITdwdtibREIXVkVnia4pEYx3pg7ECEh31gmP2SQg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7462962962962963" data-type="png" data-w="1080" data-imgfileid="100064887" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGJnDBKWice5lebf4MwITdwdtibREIXVkVnia4pEYx3pg7ECEh31gmP2SQg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">细胞类型比例在不同分组中的比例差异：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGbRBVdotjaVHDR3V28oysFeSUu096W2gcHJX7l38O3845osIETWxRzA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.2972222222222222" data-type="png" data-w="1080" data-imgfileid="100064885" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGbRBVdotjaVHDR3V28oysFeSUu096W2gcHJX7l38O3845osIETWxRzA/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">数据读取</span></span></h2><p data-tool="mdnice编辑器"><span leaf="">先加载模块：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># %%</span></span><span leaf=""><br></span><span><span leaf=""># %load_ext autoreload</span></span><span leaf=""><br></span><span><span leaf=""># %autoreload 2</span></span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> scanpy </span><span><span leaf="">as</span></span><span leaf=""> sc</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> numpy </span><span><span leaf="">as</span></span><span leaf=""> np</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> pandas </span><span><span leaf="">as</span></span><span leaf=""> pd</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> scipy.sparse </span><span><span leaf="">as</span></span><span leaf=""> sp</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> scanpy_helpers.annotation </span><span><span leaf="">import</span></span><span leaf=""> AnnotationHelper</span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> nxfvars </span><span><span leaf="">import</span></span><span leaf=""> nxfvars</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sc.set_figure_params(figsize=(</span><span><span leaf="">5</span></span><span leaf="">, </span><span><span leaf="">5</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># %%</span></span><span leaf=""><br></span><span leaf="">adata = sc.read_h5ad(filename=</span><span><span leaf="">"data/12_input_adatas/guo_zhang_2018_nsclc.h5ad"</span></span><span leaf=""> )</span><span leaf=""><br></span><span leaf="">adata</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGZJSLiawP0VkFibXROFOibV4ib6dIaibunoaV1EOXJL4NK7xGL0eeSFaYcBg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.28425925925925927" data-type="png" data-w="1080" data-imgfileid="100064884" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGZJSLiawP0VkFibXROFOibV4ib6dIaibunoaV1EOXJL4NK7xGL0eeSFaYcBg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">11477个细胞。</span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">其他信息</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">看看给的数据里面其他的表型：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">adata.obs</span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">'patient'</span></span><span leaf="">].value_counts()</span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">'condition'</span></span><span leaf="">].value_counts()</span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">'origin'</span></span><span leaf="">].value_counts()</span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">'majorCluster'</span></span><span leaf="">].value_counts()</span><span leaf=""><br></span><span leaf="">adata.obs[</span><span><span leaf="">'cell_type'</span></span><span leaf="">].value_counts()</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGeZe0f7RbBuakaPxTdicJcJcKP2SiaFg6TtlCC2T0V2eejIJibVLPzQZbA/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.5190274841437632" data-type="png" data-w="946" data-imgfileid="100064886" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGeZe0f7RbBuakaPxTdicJcJcKP2SiaFg6TtlCC2T0V2eejIJibVLPzQZbA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">细胞给了详细的注释。</span></p><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">数据过滤</span></span></h2><p data-tool="mdnice编辑器"><span leaf="">我们目前已经做了好几个数据的python代码训练，所以这里应该很熟悉。</span></p><p data-tool="mdnice编辑器"><span leaf="">计算每个细胞中线粒体基因，核糖体基因，红血细胞基因表达比例：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 计算线粒体基因比例</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'mt'</span></span><span leaf="">]=adata.var_names.str.startswith(</span><span><span leaf="">'MT-'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 计算核糖体基因比例</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'ribo'</span></span><span leaf="">]=adata.var_names.str.match(</span><span><span leaf="">'^RP[SL]'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 计算红血细胞基因比例</span></span><span leaf=""><br></span><span leaf="">adata.var[</span><span><span leaf="">'hb'</span></span><span leaf="">]=adata.var_names.str.match(</span><span><span leaf="">'^HB[^(P)]'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># 计算</span></span><span leaf=""><br></span><span leaf="">sc.pp.calculate_qc_metrics(adata,qc_vars=[</span><span><span leaf="">'mt'</span></span><span leaf="">,</span><span><span leaf="">'ribo'</span></span><span leaf="">,</span><span><span leaf="">'hb'</span></span><span leaf="">],percent_top=</span><span><span leaf="">None</span></span><span leaf="">,log1p=</span><span><span leaf="">False</span></span><span leaf="">,inplace=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 质控</span></span><span leaf=""><br></span><span leaf="">adata.obs.head()</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGfaeVEemicCr9FcxFPDhjOyTkOw5y9wQc6lFG4eicACAmXmlj1nI6VXOw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.13240740740740742" data-type="png" data-w="1080" data-imgfileid="100064883" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGfaeVEemicCr9FcxFPDhjOyTkOw5y9wQc6lFG4eicACAmXmlj1nI6VXOw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">计算结果，然后可视化看看：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">from</span></span><span leaf=""> matplotlib.pyplot </span><span><span leaf="">import</span></span><span leaf=""> rc_context</span><span leaf=""><br></span><span><span leaf="">with</span></span><span leaf=""> rc_context({</span><span><span leaf="">"figure.figsize"</span></span><span leaf="">: (</span><span><span leaf="">9</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">)}):</span><span leaf=""><br></span><span leaf="">    sc.pl.violin(</span><span leaf=""><br></span><span leaf="">        adata,</span><span leaf=""><br></span><span leaf="">        [</span><span><span leaf="">'n_genes_by_counts'</span></span><span leaf="">,</span><span><span leaf="">'total_counts'</span></span><span leaf="">,</span><span><span leaf="">'pct_counts_mt'</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">        groupby=</span><span><span leaf="">"patient"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        jitter=</span><span><span leaf="">0.4</span></span><span leaf="">,rotation=</span><span><span leaf="">90</span></span><span leaf="">,multi_panel=</span><span><span leaf="">True</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    )</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGeYbSlzUIsYRZaWtwtntNgcZ13oMC3qEic5y9JrC6lib04kzyCIRXhGgg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.2833333333333333" data-type="png" data-w="1080" data-imgfileid="100064891" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGeYbSlzUIsYRZaWtwtntNgcZ13oMC3qEic5y9JrC6lib04kzyCIRXhGgg/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">看看文献给的过滤标准：</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGzxdMZpJzo3r3I0AKyS8dAK8cj3x0UPEb09OaTykttKRvWp4X9jcI3g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5120370370370371" data-type="png" data-w="1080" data-imgfileid="100064889" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGzxdMZpJzo3r3I0AKyS8dAK8cj3x0UPEb09OaTykttKRvWp4X9jcI3g/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">过滤：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">## 过滤前的数据</span></span><span leaf=""><br></span><span leaf="">adata.shape</span><span leaf=""><br></span><span><span leaf=""># 基本过滤</span></span><span leaf=""><br></span><span leaf="">sc.pp.filter_genes(adata, min_cells=</span><span><span leaf="">3</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 过滤</span></span><span leaf=""><br></span><span><span leaf=""># 方法2：一次性过滤所有条件（更高效）</span></span><span leaf=""><br></span><span leaf="">adata = adata[</span><span leaf=""><br></span><span leaf="">    (adata.obs[</span><span><span leaf="">'n_genes_by_counts'</span></span><span leaf="">] &gt; </span><span><span leaf="">1000</span></span><span leaf="">) &amp; </span><span leaf=""><br></span><span leaf="">    (adata.obs[</span><span><span leaf="">'n_genes_by_counts'</span></span><span leaf="">] &lt; </span><span><span leaf="">20000</span></span><span leaf="">) &amp;</span><span leaf=""><br></span><span leaf="">    (adata.obs[</span><span><span leaf="">'total_counts'</span></span><span leaf="">] &gt; </span><span><span leaf="">20000</span></span><span leaf="">) &amp; </span><span leaf=""><br></span><span leaf="">    (adata.obs[</span><span><span leaf="">'total_counts'</span></span><span leaf="">] &lt; </span><span><span leaf="">3000000</span></span><span leaf="">) &amp;</span><span leaf=""><br></span><span leaf="">    (adata.obs[</span><span><span leaf="">'pct_counts_mt'</span></span><span leaf="">] &lt; </span><span><span leaf="">20</span></span><span leaf="">), :</span><span leaf=""><br></span><span leaf="">].copy()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 过滤后的数据</span></span><span leaf=""><br></span><span leaf="">adata.shape</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGrZf1XQeul38ImKeONTG0fdicxywqEGJlds6SmLxsIuQN4uh4ElahOrQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.41821946169772256" data-type="png" data-w="483" data-imgfileid="100064888" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGrZf1XQeul38ImKeONTG0fdicxywqEGJlds6SmLxsIuQN4uh4ElahOrQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">过滤前后细胞数没有很大变化。</span></p><p data-tool="mdnice编辑器"><span leaf="">过滤后的小提琴：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">from</span></span><span leaf=""> matplotlib.pyplot </span><span><span leaf="">import</span></span><span leaf=""> rc_context</span><span leaf=""><br></span><span><span leaf="">with</span></span><span leaf=""> rc_context({</span><span><span leaf="">"figure.figsize"</span></span><span leaf="">: (</span><span><span leaf="">9</span></span><span leaf="">, </span><span><span leaf="">10</span></span><span leaf="">)}):</span><span leaf=""><br></span><span leaf="">    sc.pl.violin(</span><span leaf=""><br></span><span leaf="">        adata,</span><span leaf=""><br></span><span leaf="">        [</span><span><span leaf="">'n_genes_by_counts'</span></span><span leaf="">,</span><span><span leaf="">'total_counts'</span></span><span leaf="">,</span><span><span leaf="">'pct_counts_mt'</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">        groupby=</span><span><span leaf="">"patient"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        jitter=</span><span><span leaf="">0.4</span></span><span leaf="">,rotation=</span><span><span leaf="">90</span></span><span leaf="">,multi_panel=</span><span><span leaf="">True</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        </span><span><span leaf=""><a topic-id="mkcoh9qn-85zmar" data-topic="1">#stripplot</a>=False,  # remove the internal dots</span></span><span leaf=""><br></span><span leaf="">        </span><span><span leaf=""><a topic-id="mkcoh9qo-ca5b3i" data-topic="1">#inner</a>="box",  # adds a boxplot inside violins</span></span><span leaf=""><br></span><span leaf="">    )</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnG1p5274WYChRwnS9F3iaog0MibhvrkDcge7gvaXic4Z7aGdKyXibqOkHTag/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.2833333333333333" data-type="jpeg" data-w="1080" data-imgfileid="100064890" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnG1p5274WYChRwnS9F3iaog0MibhvrkDcge7gvaXic4Z7aGdKyXibqOkHTag/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">保存数据：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">## 保存数据</span></span><span leaf=""><br></span><span leaf="">adata.write(</span><span><span leaf="">"01_qc/guo_zhang_2018_nsclc_qc.h5ad"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">降维聚类</span></span></h2><p data-tool="mdnice编辑器"><span leaf="">scanpy的标准流程：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 首先将数据矩阵标准化（校正文库大小）：</span></span><span leaf=""><br></span><span leaf="">sc.pp.normalize_total(adata,target_sum=</span><span><span leaf="">1e4</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 对数据进行log</span></span><span leaf=""><br></span><span leaf="">sc.pp.log1p(adata)</span><span leaf=""><br></span><span leaf="">adata.raw = adata.copy()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 高变基因</span></span><span leaf=""><br></span><span leaf="">sc.pp.highly_variable_genes(adata)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 归一化</span></span><span leaf=""><br></span><span leaf="">sc.pp.scale(adata)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># pca分析</span></span><span leaf=""><br></span><span leaf="">sc.tl.pca(adata,use_highly_variable=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># harmony整合</span></span><span leaf=""><br></span><span leaf="">sc.external.pp.harmony_integrate(adata,</span><span><span leaf="">'patient'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 聚类</span></span><span leaf=""><br></span><span leaf="">sc.pp.neighbors(adata,use_rep=</span><span><span leaf="">'X_pca_harmony'</span></span><span leaf="">,n_pcs=</span><span><span leaf="">30</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># sc.pp.neighbors(adata,use_rep='X_pca',n_pcs=30)</span></span><span leaf=""><br></span><span leaf="">sc.tl.umap(adata)</span><span leaf=""><br></span><span><span leaf=""># Using the igraph implementation and a fixed number of iterations can be significantly faster, especially for larger datasets</span></span><span leaf=""><br></span><span leaf="">sc.tl.leiden(adata, flavor=</span><span><span leaf="">"igraph"</span></span><span leaf="">, n_iterations=</span><span><span leaf="">2</span></span><span leaf="">,resolution=</span><span><span leaf="">0.5</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">可视化一下：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># umap图</span></span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> matplotlib.pyplot </span><span><span leaf="">import</span></span><span leaf=""> rc_context</span><span leaf=""><br></span><span><span leaf="">with</span></span><span leaf=""> rc_context({</span><span><span leaf="">"figure.figsize"</span></span><span leaf="">: (</span><span><span leaf="">6.5</span></span><span leaf="">, </span><span><span leaf="">6</span></span><span leaf="">)}):</span><span leaf=""><br></span><span leaf="">    sc.pl.umap(adata, color=[</span><span><span leaf="">"leiden"</span></span><span leaf="">,</span><span><span leaf="">'patient'</span></span><span leaf="">], legend_loc=</span><span><span leaf="">"on data"</span></span><span leaf="">, size=</span><span><span leaf="">7</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGynsviaFPJc0yaEQFukw7Yb0w7d2d7IGYKcaWqtDz35L5XdibTPg3Vg2g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4527777777777778" data-type="png" data-w="1080" data-imgfileid="100064892" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGynsviaFPJc0yaEQFukw7Yb0w7d2d7IGYKcaWqtDz35L5XdibTPg3Vg2g/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">harmony整合效果还可以。但是我打算后面试一下其他的整合方法。</span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">看看亚群</span></span><span></span></h3><pre data-tool="mdnice编辑器"><code><span><span leaf=""># umap图</span></span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> matplotlib.pyplot </span><span><span leaf="">import</span></span><span leaf=""> rc_context</span><span leaf=""><br></span><span><span leaf="">with</span></span><span leaf=""> rc_context({</span><span><span leaf="">"figure.figsize"</span></span><span leaf="">: (</span><span><span leaf="">8</span></span><span leaf="">, </span><span><span leaf="">7</span></span><span leaf="">)}):</span><span leaf=""><br></span><span leaf="">    sc.pl.umap(adata, color=[</span><span><span leaf="">"cell_type"</span></span><span leaf="">], legend_loc=</span><span><span leaf="">"on data"</span></span><span leaf="">, size=</span><span><span leaf="">7</span></span><span leaf="">) </span><span><span leaf=""># 样本太多了所以是灰色？</span></span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGeeteAGYzD8umKuKrUV33euTDER7BjUrar7eeh3icVFFNf9yLYWiaX11Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8960674157303371" data-type="png" data-w="1068" data-imgfileid="100064897" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnGeeteAGYzD8umKuKrUV33euTDER7BjUrar7eeh3icVFFNf9yLYWiaX11Q/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">跟原有的注释结果还算吻合，CD8与CD4有比较清晰的分群界限。</span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">看看marker基因</span></span><span></span></h3><pre data-tool="mdnice编辑器"><code><span leaf="">sc.pl.umap(adata, color=[</span><span><span leaf="">"PTPRC"</span></span><span leaf="">, </span><span><span leaf="">"CD3D"</span></span><span leaf="">,</span><span><span leaf="">"CD8A"</span></span><span leaf="">,</span><span><span leaf="">"CD8B"</span></span><span leaf="">,</span><span><span leaf="">"CD4"</span></span><span leaf="">,</span><span><span leaf="">"NKG7"</span></span><span leaf="">])</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnG7qP0azj8r4uLXJDBLhxBOeu09Zaes4UNurYJvEqbt1gEBVMUNicuOGQ/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="0.45925925925925926" data-type="jpeg" data-w="1080" data-imgfileid="100064896" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wxHXBdzUM8MHWqWtSl3yibnG7qP0azj8r4uLXJDBLhxBOeu09Zaes4UNurYJvEqbt1gEBVMUNicuOGQ/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">最后保存一下数据：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">## 保存数据</span></span><span leaf=""><br></span><span leaf="">adata.write(</span><span><span leaf="">"01_qc/guo_zhang_2018_nsclc_umap.h5ad"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">今天分享到这里，要一起来学习python单细胞数据分析吗，加我Biotree123，进python分析群一起实战~</span></p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">转发：</span></span></p></section><ul><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247547917&amp;idx=1&amp;sn=76afb50b6e9e433e3f2b3d039f72dac4&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课2026年1月班" data-itemshowtype="0" linktype="text" data-linktype="2">生信入门&amp;数据挖掘线上直播课2026年1月班</a><span textstyle="">，你的生物信息学入门课</span></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247525079&amp;idx=1&amp;sn=0b997af16a58195b4192691373048fd5&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" data-itemshowtype="0" linktype="text" data-linktype="2"><span textstyle="">时隔5年，我们的生信技能树VIP学徒继续招生啦</span></a></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247530048&amp;idx=1&amp;sn=28aa7bbd5e00521f79e074496a5f5d66&amp;scene=21#wechat_redirect" textvalue="满足你生信分析计算需求的低价解决方案" data-itemshowtype="0" linktype="text" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=1679199708449144836&amp;scene=173&amp;subscene=207&amp;sessionid=1745492310&amp;enterid=1745492314&amp;from_msgid=2247541298&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="生信故事会" data-itemshowtype="0" linktype="text" data-linktype="2">生信故事会</a>，来看看他们的生信入门故事</span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=3690970204957147140&amp;scene=173&amp;subscene=207&amp;sessionid=1745066271&amp;enterid=1745066274&amp;from_msgid=2247540702&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="生信马拉松答疑专辑" data-itemshowtype="0" linktype="text" data-linktype="2">生信马拉松答疑专辑</a>，获取你的生信专属答疑</span></section></li></ul><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/8uc-xOZu0I_wPFHzwF9f-w",target="_blank" rel="noopener noreferrer">原文链接</a>
