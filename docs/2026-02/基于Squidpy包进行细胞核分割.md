---
title: "基于Squidpy包进行细胞核分割"
date: 2026-02-22T06:44:15Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
基于Squidpy包进行细胞核分割 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">在空间转录组/组织影像分析里，“细胞核分割”往往是后续定量（细胞计数、细胞邻域、表达汇聚、形态学特征等）的第一步。今天这篇推文介绍一下基于 Squidpy 包进行 Cellpose细胞核分割，包括在 Visium 荧光图像（DAPI） 和 H&amp;E 组织切片上跑通核分割流程。</span></p><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.  Squidpy及Cellpose简介</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">Squidpy在之前的推文中已经介绍多次了。简单来说，Squidpy 是基于 Scanpy 生态构建的空间组学图像分析工具包（https://squidpy.readthedocs.io/en/stable/index.html），专注于将组织图像与空间转录组数据进行整合分析。它提供了图像处理、分割、特征提取、空间邻域分析等一整套功能模块，能够高效连接“图像层信息”与“基因表达层信息”，在空间多组学研究中被广泛使用。</span></p><p data-tool="mdnice编辑器"><span leaf="">而Cellpose 是由 Stringer 等人于 2021 年提出的通用细胞分割算法。它基于深度学习和流场（flow field）建模思想，能够在不同组织类型、不同成像模式（荧光、H&amp;E 等）下实现稳健的细胞或细胞核分割。Cellpose 提供了预训练模型（如 cytoplasm、nuclei），开箱即用，同时也支持参数调优和自定义训练，具有较强的泛化能力。</span></p><p data-tool="mdnice编辑器"><span leaf="">在实际应用中，我们可以通过 Squidpy 的 sq.im.segment 接口，将 Cellpose 作为底层分割引擎，从而在空间转录组图像中实现高质量的细胞核分割。</span></p><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">2. 环境部署</span></span><span></span></h4><p data-tool="mdnice编辑器"><strong><span leaf="">Squidpy安装：</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">mamba create -n squid python=3.10 -y</span><span leaf=""><br></span><span leaf="">conda activate squid</span><span leaf=""><br></span><span leaf="">pip install squidpy -i https://mirrors.aliyun.com/pypi/simple</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 其他安装方式</span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mlxcy3po-7rkkff" data-topic="1">#pip</a> install squidpy</span></span><span leaf=""><br></span><span><span leaf=""><a topic-id="mlxcy3po-tsqj10" data-topic="1">#国内安装可能需要加镜像</a></span></span><span leaf=""><br></span><span leaf="">pip install squidpy</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><strong><span leaf="">cellpose安装：</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">pip install cellpose</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">如果你想本地跑 notebook，推荐用 conda 环境：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">mamba install -y nb_conda_kernels ipykernel</span><span leaf=""><br></span><span leaf="">python -m ipykernel install --user --name squid --display-name squid</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">3. 自定义分割函数</span></span><span></span></h4><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">import</span></span><span leaf=""> numpy </span><span><span leaf="">as</span></span><span leaf=""> np</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> matplotlib.pyplot </span><span><span leaf="">as</span></span><span leaf=""> plt</span><span leaf=""><br></span><span><span leaf="">import</span></span><span leaf=""> squidpy </span><span><span leaf="">as</span></span><span leaf=""> sq</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">from</span></span><span leaf=""> cellpose </span><span><span leaf="">import</span></span><span leaf=""> models</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">这里导入 Cellpose 的分割模型。相关 API 文档可参考：</span></p><p data-tool="mdnice编辑器"><span leaf="">https://cellpose.readthedocs.io/en/latest/api.html<a topic-id="mlxcy3po-y9gr1r" data-topic="1">#cellpose</a>-class</span></p><p data-tool="mdnice编辑器"><span leaf="">为了使用 Cellpose 模型，我们需要定义一个封装函数（wrapper）：在函数内部完成模型初始化、模型推理（eval），并返回分割得到的掩膜（segmentation masks）。同时，我们还可以通过传入参数（例如每个分割目标的最小像素数 min_size）来使用 Cellpose 的特定选项。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span><span leaf="">def</span></span><span leaf=""> </span><span><span leaf="">cellpose</span></span><span><span leaf="">(img, min_size=</span><span><span leaf="">15</span></span><span leaf="">)</span></span><span leaf="">:</span></span><span leaf=""><br></span><span leaf="">    model = models.Cellpose(model_type=</span><span><span leaf="">"nuclei"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    res, _, _, _ = model.eval(</span><span leaf=""><br></span><span leaf="">        img,</span><span leaf=""><br></span><span leaf="">        channels=[</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">],</span><span leaf=""><br></span><span leaf="">        diameter=</span><span><span leaf="">None</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        min_size=min_size,</span><span leaf=""><br></span><span leaf="">    )</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">return</span></span><span leaf=""> res</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><strong><span leaf="">4. 场景一：Visium 荧光图像（DAPI 通道）核分割</span></strong></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">加载并裁剪图像：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">img = sq.datasets.visium_fluo_image_crop()</span><span leaf=""><br></span><span leaf="">crop = img.crop_corner(</span><span><span leaf="">1000</span></span><span leaf="">, </span><span><span leaf="">1000</span></span><span leaf="">, size=</span><span><span leaf="">1000</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">crop.show(channelwise=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8VG5DrU3qaRcxGaRALULkCEyJ86UictwnNfmJZSX1DbmgPetWw6u8z7RpLc5diaBKDdR0zqHfKDm8BM7f8HjFZHuagl1JCh53JBw/640?wx_fmt=png&amp;from=appmsg" alt="image-20260220152616847" data-ratio="0.35462962962962963" data-type="png" data-w="1080" data-imgfileid="100055909" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8VG5DrU3qaRcxGaRALULkCEyJ86UictwnNfmJZSX1DbmgPetWw6u8z7RpLc5diaBKDdR0zqHfKDm8BM7f8HjFZHuagl1JCh53JBw/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20260220152616847</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">使用cellpose自定义函数分割DAPI通道，DAPI 通常在第 0 通道：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sq.im.segment(img=crop, layer=</span><span><span leaf="">"image"</span></span><span leaf="">, channel=</span><span><span leaf="">0</span></span><span leaf="">, method=cellpose)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">绘制图像裁剪区域中的 DAPI 通道以及对应的分割结果：</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">print(crop)</span><span leaf=""><br></span><span leaf="">print(</span><span><span leaf="">f"Number of segments in crop: </span><span><span leaf="">{len(np.unique(crop[</span><span><span leaf="">'segmented_custom'</span></span><span leaf="">]))}</span></span><span leaf="">"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">fig, axes = plt.subplots(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, figsize=(</span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">20</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"image"</span></span><span leaf="">, channel=</span><span><span leaf="">0</span></span><span leaf="">, ax=axes[</span><span><span leaf="">0</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">0</span></span><span leaf="">].set_title(</span><span><span leaf="">"DAPI"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"segmented_custom"</span></span><span leaf="">, cmap=</span><span><span leaf="">"jet"</span></span><span leaf="">, interpolation=</span><span><span leaf="">"none"</span></span><span leaf="">, ax=axes[</span><span><span leaf="">1</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">1</span></span><span leaf="">].set_title(</span><span><span leaf="">"Cellpose segmentation"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">示例输出：</span><strong><span leaf="">360 个核实例</span></strong><span leaf="">（分割数量会随裁剪区域和参数变化）。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/Go1sLc9TF8XUMVSO0H6QtgkgYtECN8nbyo7VOakicmWfnd1ibqMgEE8RAsuElHibNgLIWzvtibkNic8hOTbCUDYmq0oUTfw5Y1hCibNickCAZaZcC8/640?wx_fmt=png&amp;from=appmsg" alt="image-20260220152753291" data-ratio="0.4824074074074074" data-type="png" data-w="1080" data-imgfileid="100055907" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/Go1sLc9TF8XUMVSO0H6QtgkgYtECN8nbyo7VOakicmWfnd1ibqMgEE8RAsuElHibNgLIWzvtibkNic8hOTbCUDYmq0oUTfw5Y1hCibNickCAZaZcC8/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20260220152753291</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">sq.im.segment 方法会将任何额外的参数传递给 cellpose 函数，因此我们也可以过滤掉像素数小于 200 的分割目标，并将其结果与前面使用默认最小像素数 15 时得到的分割结果进行比较。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sq.im.segment(img=crop, layer=</span><span><span leaf="">"image"</span></span><span leaf="">, channel=</span><span><span leaf="">0</span></span><span leaf="">, method=cellpose, min_size=</span><span><span leaf="">200</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">print(crop)</span><span leaf=""><br></span><span leaf="">print(</span><span><span leaf="">f"Number of segments in crop: </span><span><span leaf="">{len(np.unique(crop[</span><span><span leaf="">'segmented_custom'</span></span><span leaf="">]))}</span></span><span leaf="">"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">fig, axes = plt.subplots(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, figsize=(</span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">20</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"image"</span></span><span leaf="">, channel=</span><span><span leaf="">0</span></span><span leaf="">, ax=axes[</span><span><span leaf="">0</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">0</span></span><span leaf="">].set_title(</span><span><span leaf="">"DAPI"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"segmented_custom"</span></span><span leaf="">, cmap=</span><span><span leaf="">"jet"</span></span><span leaf="">, interpolation=</span><span><span leaf="">"none"</span></span><span leaf="">, ax=axes[</span><span><span leaf="">1</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">1</span></span><span leaf="">].set_title(</span><span><span leaf="">"Cellpose segmentation"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8WXMYntITd7IdZb4ibm3QS174x1Im01ylxsrQk4MMXXAnRiaCicGH2h8icYLj9pFluJSdF3R8HCl1JVLAvbIsgpic6UsmkdU9Z5W7cI/640?wx_fmt=png&amp;from=appmsg" alt="image-20260220152930201" data-ratio="0.49537037037037035" data-type="png" data-w="1080" data-imgfileid="100055908" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8WXMYntITd7IdZb4ibm3QS174x1Im01ylxsrQk4MMXXAnRiaCicGH2h8icYLj9pFluJSdF3R8HCl1JVLAvbIsgpic6UsmkdU9Z5W7cI/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20260220152930201</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">这会过滤掉小于 200 像素的目标，示例中数量从 </span><strong><span leaf="">360 降到 221</span></strong><span leaf="">。这种做法通常适合：</span><strong><span leaf="">噪点多、碎片多、希望更“保守”</span></strong><span leaf="">的分割策略。</span></p><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">5. 场景二：H&amp;E 组织切片核分割（更接近真实项目）</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">对于荧光数据，我们只是将 DAPI 通道直接传递给 Cellpose 模型，便完成了细胞核分割。对于 H&amp;E 图像，我们同样会使用 nuclei 模型。Cellpose 官方文档中说明：</span></p><p data-tool="mdnice编辑器"><span leaf="">Cellpose 中的核分割模型是在双通道图像上训练的，其中第一个通道是需要进行分割的通道，第二个通道始终设置为全零数组。因此，第一个通道可以设置为：0=灰度，1=红色，2=绿色，3=蓝色；第二个通道固定为 0。例如，如果你想在灰度图像或单通道图像上分割细胞核，可以设置 channels = [0,0]；如果想分割蓝色通道中的细胞核，则可以设置 channels = [3,0]。</span></p><p data-tool="mdnice编辑器"><span leaf="">让我们来看下面这张图像。</span></p><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.1 加载 H&amp;E 图像并观察通道含义</span></span><span></span></h5><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">img = sq.datasets.visium_hne_image_crop()</span><span leaf=""><br></span><span leaf="">crop = img.crop_corner(</span><span><span leaf="">0</span></span><span leaf="">, </span><span><span leaf="">0</span></span><span leaf="">, size=</span><span><span leaf="">1000</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"image"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8UeUJGoVTb7IPib91z1TibXp5m8H5Mk4c7hIzpVZjJLEq7bnEq9FBBLa5kejIfuhXokqwduA6CHKrGpjTs9vYRZFCdKicmr6VibeDA/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.012037037037037" data-type="png" data-w="1080" data-imgfileid="100055911" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8UeUJGoVTb7IPib91z1TibXp5m8H5Mk4c7hIzpVZjJLEq7bnEq9FBBLa5kejIfuhXokqwduA6CHKrGpjTs9vYRZFCdKicmr6VibeDA/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">示例中通道对应：</span></p><ul><li><section><span leaf="">image:0 -&gt; 红色（red）</span></section></li><li><section><span leaf="">image:1 -&gt; 绿色（green）</span></section></li><li><section><span leaf="">image:2 -&gt; 蓝色（blue）</span></section></li></ul><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">crop.show(</span><span><span leaf="">"image"</span></span><span leaf="">, channelwise=</span><span><span leaf="">True</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8WYZDIyibLvWcSmViaV1Hv3jSwicOnTWjDveJBdg8AbiaChnE2FfEEGoadWUbaOETdScb11BboVcF4kAia6f1TKdYVM17LhZKxicNwuA/640?wx_fmt=png&amp;from=appmsg" alt="image-20260220153058848" data-ratio="0.36944444444444446" data-type="png" data-w="1080" data-imgfileid="100055910" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8WYZDIyibLvWcSmViaV1Hv3jSwicOnTWjDveJBdg8AbiaChnE2FfEEGoadWUbaOETdScb11BboVcF4kAia6f1TKdYVM17LhZKxicNwuA/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20260220153058848</span></figcaption></figure><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.2 先写一个更“可调”的 Cellpose wrapper（H&amp;E 专用）</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">基于以上两张图像，我们可以提出两种思路：</span></p><p data-tool="mdnice编辑器"><span leaf="">A）由于 H&amp;E 染色过程中，细胞核通常呈现蓝色/紫色调，因此我们可以将整张 H&amp;E 图像输入到 Cellpose 中，并将分割模式设置为蓝色通道（在 Cellpose 中使用通道编号 3）。</span></p><p data-tool="mdnice编辑器"><span leaf="">B）从上图可以看到，红色通道（image:0）具有较好的对比度，因此我们也可以只使用该通道，并将其视为灰度图像进行分割（在 Cellpose 中使用通道编号 0）。</span></p><p data-tool="mdnice编辑器"><span leaf="">接下来，我们定义自定义的分割函数，并分别尝试这两种方案。这里，我们将 channels 参数中的第二个值设置为 0，因为我们只会传入一个图像通道。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span><span leaf="">def</span></span><span leaf=""> </span><span><span leaf="">cellpose_he</span></span><span><span leaf="">(img, min_size=</span><span><span leaf="">15</span></span><span leaf="">, flow_threshold=</span><span><span leaf="">0.4</span></span><span leaf="">, channel_cellpose=</span><span><span leaf="">0</span></span><span leaf="">)</span></span><span leaf="">:</span></span><span leaf=""><br></span><span leaf="">    model = models.Cellpose(model_type=</span><span><span leaf="">"nuclei"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    res, _, _, _ = model.eval(</span><span leaf=""><br></span><span leaf="">        img,</span><span leaf=""><br></span><span leaf="">        channels=[channel_cellpose, </span><span><span leaf="">0</span></span><span leaf="">],  </span><span><span leaf=""># second channel is always 0</span></span><span leaf=""><br></span><span leaf="">        diameter=</span><span><span leaf="">None</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        min_size=min_size,</span><span leaf=""><br></span><span leaf="">        invert=</span><span><span leaf="">True</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">        flow_threshold=flow_threshold,</span><span leaf=""><br></span><span leaf="">    )</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">return</span></span><span leaf=""> res</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">参数解释：</span></p><ul><li><section><span leaf="">channel_cellpose：告诉 Cellpose “用哪个颜色/灰度作为待分割通道”</span></section></li><li><section><span leaf="">invert=True：适用于“核更暗/背景更亮”的情况（H&amp;E 常见）</span></section></li><li><section><span leaf="">flow_threshold：越高越严格，能减少一些不可信的分割，但也可能漏检</span></section></li></ul><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.3 策略 A：输入 RGB 全通道，让 Cellpose 以“蓝色核”模式分割</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">直觉是：H&amp;E 的核偏蓝紫，所以设 Cellpose 通道为 3（blue）。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">hne_channel_to_segment = </span><span><span leaf="">None</span></span><span leaf="">  </span><span><span leaf=""># so that we feed in all channels</span></span><span leaf=""><br></span><span leaf="">cellpose_channel_setting = </span><span><span leaf="">3</span></span><span><span leaf=""># corresponds to "blue"</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sq.im.segment(</span><span leaf=""><br></span><span leaf="">    img=crop,</span><span leaf=""><br></span><span leaf="">    layer=</span><span><span leaf="">"image"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    channel=hne_channel_to_segment,</span><span leaf=""><br></span><span leaf="">    method=cellpose_he,</span><span leaf=""><br></span><span leaf="">    channel_cellpose=cellpose_channel_setting,</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">print(crop)</span><span leaf=""><br></span><span leaf="">print(</span><span><span leaf="">f"Number of segments in crop: </span><span><span leaf="">{len(np.unique(crop[</span><span><span leaf="">'segmented_custom'</span></span><span leaf="">]))}</span></span><span leaf="">"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">fig, axes = plt.subplots(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, figsize=(</span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">20</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"image"</span></span><span leaf="">, channel=hne_channel_to_segment, ax=axes[</span><span><span leaf="">0</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">0</span></span><span leaf="">].set_title(</span><span><span leaf="">"H&amp;E"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"segmented_custom"</span></span><span leaf="">, cmap=</span><span><span leaf="">"jet"</span></span><span leaf="">, interpolation=</span><span><span leaf="">"none"</span></span><span leaf="">, ax=axes[</span><span><span leaf="">1</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">1</span></span><span leaf="">].set_title(</span><span><span leaf="">"Cellpose segmentation"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8VWIG7eaLpB1SibRWqhIfARQTuRiaZZ1WB9MzBjhQrdcfEpJjGLiaSpn7jv8WibwgpBj44Tno6hSnONsicY702vpLId38e7g1NdA7Zo/640?wx_fmt=png&amp;from=appmsg" alt="image-20260220153334692" data-ratio="0.4861111111111111" data-type="png" data-w="1080" data-imgfileid="100055915" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8VWIG7eaLpB1SibRWqhIfARQTuRiaZZ1WB9MzBjhQrdcfEpJjGLiaSpn7jv8WibwgpBj44Tno6hSnONsicY702vpLId38e7g1NdA7Zo/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20260220153334692</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">示例结果：</span><strong><span leaf="">1149 个核</span></strong><span leaf="">。</span></p><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.4 策略 B：只用红通道（image:0）当灰度，反而更清晰</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">在不少 H&amp;E 图里，红通道有时对核/背景的对比更“干净”。我们只传红通道，并把 Cellpose 设为灰度（0）。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">hne_channel_to_segment = </span><span><span leaf="">0</span></span><span leaf="">  </span><span><span leaf=""># corresponds to the red channel</span></span><span leaf=""><br></span><span leaf="">cellpose_channel_setting = </span><span><span leaf="">0</span></span><span><span leaf=""># corresponds to "greyscale" mode</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sq.im.segment(</span><span leaf=""><br></span><span leaf="">    img=crop,</span><span leaf=""><br></span><span leaf="">    layer=</span><span><span leaf="">"image"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    channel=hne_channel_to_segment,</span><span leaf=""><br></span><span leaf="">    method=cellpose_he,</span><span leaf=""><br></span><span leaf="">    channel_cellpose=cellpose_channel_setting,</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">print(crop)</span><span leaf=""><br></span><span leaf="">print(</span><span><span leaf="">f"Number of segments in crop: </span><span><span leaf="">{len(np.unique(crop[</span><span><span leaf="">'segmented_custom'</span></span><span leaf="">]))}</span></span><span leaf="">"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">fig, axes = plt.subplots(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, figsize=(</span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">20</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"image"</span></span><span leaf="">, channel=hne_channel_to_segment, ax=axes[</span><span><span leaf="">0</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">0</span></span><span leaf="">].set_title(</span><span><span leaf="">"H&amp;E"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"segmented_custom"</span></span><span leaf="">, cmap=</span><span><span leaf="">"jet"</span></span><span leaf="">, interpolation=</span><span><span leaf="">"none"</span></span><span leaf="">, ax=axes[</span><span><span leaf="">1</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">1</span></span><span leaf="">].set_title(</span><span><span leaf="">"Cellpose segmentation"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8W7fY9rF3ST9PIktVMRmvs44p7NYf2YnybQ6mibQMEA1Uu6OpHIbwP0Iz5ledBzia1TTVVxZKROicCjLPqfCRAvuSuRvrdSgmcWOY/640?wx_fmt=png&amp;from=appmsg" alt="image-20260220153403785" data-ratio="0.47962962962962963" data-type="png" data-w="1080" data-imgfileid="100055916" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/Go1sLc9TF8W7fY9rF3ST9PIktVMRmvs44p7NYf2YnybQ6mibQMEA1Uu6OpHIbwP0Iz5ledBzia1TTVVxZKROicCjLPqfCRAvuSuRvrdSgmcWOY/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20260220153403785</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">示例结果：</span><strong><span leaf="">1630 个核</span></strong><span leaf="">（比策略 A 多）。</span></p><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.5 参数优化</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">我们可以看到，仅使用红色通道并将其作为灰度图像进行分割时，得到的细胞数量更多。接下来，我们通过将 flow_threshold 提高到 0.8，进一步优化这一方案。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">hne_channel_to_segment = </span><span><span leaf="">0</span></span><span leaf="">  </span><span><span leaf=""># corresponds to the red channel</span></span><span leaf=""><br></span><span leaf="">cellpose_channel_setting = </span><span><span leaf="">0</span></span><span><span leaf=""># corresponds to "greyscale" mode</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sq.im.segment(</span><span leaf=""><br></span><span leaf="">    img=crop,</span><span leaf=""><br></span><span leaf="">    layer=</span><span><span leaf="">"image"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    channel=hne_channel_to_segment,</span><span leaf=""><br></span><span leaf="">    method=cellpose_he,</span><span leaf=""><br></span><span leaf="">    flow_threshold=</span><span><span leaf="">0.8</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">    channel_cellpose=cellpose_channel_setting,</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">print(crop)</span><span leaf=""><br></span><span leaf="">print(</span><span><span leaf="">f"Number of segments in crop: </span><span><span leaf="">{len(np.unique(crop[</span><span><span leaf="">'segmented_custom'</span></span><span leaf="">]))}</span></span><span leaf="">"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">fig, axes = plt.subplots(</span><span><span leaf="">1</span></span><span leaf="">, </span><span><span leaf="">2</span></span><span leaf="">, figsize=(</span><span><span leaf="">10</span></span><span leaf="">, </span><span><span leaf="">20</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"image"</span></span><span leaf="">, channel=</span><span><span leaf="">None</span></span><span leaf="">, ax=axes[</span><span><span leaf="">0</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">0</span></span><span leaf="">].set_title(</span><span><span leaf="">"H&amp;E"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">crop.show(</span><span><span leaf="">"segmented_custom"</span></span><span leaf="">, cmap=</span><span><span leaf="">"jet"</span></span><span leaf="">, interpolation=</span><span><span leaf="">"none"</span></span><span leaf="">, ax=axes[</span><span><span leaf="">1</span></span><span leaf="">])</span><span leaf=""><br></span><span leaf="">_ = axes[</span><span><span leaf="">1</span></span><span leaf="">].set_title(</span><span><span leaf="">"Cellpose segmentation"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/Go1sLc9TF8VFhiauAOWsxiaJrJO6DlF1hEmxFInq8DEtXiacIky9jxHdhA0bkfLTnPggRk0jCUNAdpTqQyHgicmgvrh5jP9oJ4k3WAJyndFTtYU/640?wx_fmt=png&amp;from=appmsg" alt="image-20260220153440502" data-ratio="0.49074074074074076" data-type="png" data-w="1080" data-imgfileid="100055914" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/Go1sLc9TF8VFhiauAOWsxiaJrJO6DlF1hEmxFInq8DEtXiacIky9jxHdhA0bkfLTnPggRk0jCUNAdpTqQyHgicmgvrh5jP9oJ4k3WAJyndFTtYU/640?wx_fmt=png&amp;from=appmsg"></span><figcaption><span leaf="">image-20260220153440502</span></figcaption></figure><p data-tool="mdnice编辑器"><span leaf="">示例结果：</span><strong><span leaf="">1767 个核</span></strong><span leaf="">，我们可以看到，这个步骤增加了分割得到的细胞数量。</span></p><p data-tool="mdnice编辑器"><strong><span leaf="">⚠️ 然而，需要注意的是，单纯以“分割对象数量最多”为优化目标并不是最佳策略。因为当参数调得过于激进时，可能会导致过分割（over-segmentation）。例如一个细胞被错误地分成两个对象，或者将灰尘颗粒、组织碎片等误识别为细胞。</span></strong></p><p data-tool="mdnice编辑器"><span leaf="">因此，在实际分析中，应当结合中间结果进行可视化检查，仔细评估分割质量，并尝试不同参数组合进行对比，而不是仅仅追求数量的增加。</span></p></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/VFbozpGMeCXVs2fKL0WVwQ",target="_blank" rel="noopener noreferrer">原文链接</a>
