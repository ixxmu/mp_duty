---
title: "单细胞数据里的生存分析怎么做？（超详细代码~）"
date: 2026-02-18T15:20:27Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
单细胞数据里的生存分析怎么做？（超详细代码~） by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><blockquote><span></span><p><span leaf="">看到我们生信入门班里有学员问：单细胞里面怎么将亚群与预后关联起来呢？来看看~</span></p><p><span leaf="">比如这篇2025年10月10号发表在Oncogene杂志的研究mast细胞的泛癌文献，标题为《Comprehensive single-cell analysis reveals mast cells’ roles in cancer immunity》。里面就有很好的一个示例~</span></p></blockquote><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">亚群生存分析策略</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">这篇文献整理了超多公共数据库的数据，然后注释，提取其中的mast细胞整合到一起，细分了9个亚群。其中重点研究了 C7-HLA-DR cluster 这个亚群与临床生存结局之间的相关性，图如下：</span></p><p data-tool="mdnice编辑器"><span leaf="">策略：拿到 C7-HLA-DR cluster 这个亚群的特征基因作为signature，使用带有生存信息的bulk-RNA seq数据做打分，根据打分对bulk-RNA seq数据样本进行分组，然后看两个组别之间的OS等生存差异。</span></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/P6FfAMT9SUiamdjLeCAv0y6dwzv1kdZ1icyr5hLBRJalr5Kia90enGoXJOc8c6QJg5IrLn9eHIGic7LaFENYDGF5pvqyfKah7ojoTODrquEQvtk/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.3190104166666667" data-type="png" data-w="768" data-imgfileid="100065728" data-aistatus="1" src="https://mmbiz.qpic.cn/mmbiz_png/P6FfAMT9SUiamdjLeCAv0y6dwzv1kdZ1icyr5hLBRJalr5Kia90enGoXJOc8c6QJg5IrLn9eHIGic7LaFENYDGF5pvqyfKah7ojoTODrquEQvtk/640?wx_fmt=png&amp;from=appmsg"></span></figure><blockquote><span></span><p><span leaf="">Fig. 4 The relationship between C7-HLA-DR cluster and clinical outcomes.</span></p></blockquote><p data-tool="mdnice编辑器"><span leaf="">我们这里以TCGA数据库中的肝癌样本为例，来分析看看~</span></p><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">step1：TCGA肝癌样本数据下载</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">这里参考我们之前的文章：<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536544&amp;idx=2&amp;sn=1f0db014df16769bf1419e51f4181aa9&amp;scene=21#wechat_redirect" textvalue="" linktype="text" data-linktype="2">TCGA数据库| 如何将表达矩阵与样本临床数据进行合并？</a></span></p><pre data-tool="mdnice编辑器"><code><span><span leaf="">## download tcga data</span></span><span leaf=""><br></span><span><span leaf="">## update: 2024-02-22</span></span><span leaf=""><br></span><span><span leaf="">## Author: zhang juan</span></span><span leaf=""><br></span><span><span leaf="">## load packages</span></span><span leaf=""><br></span><span leaf="">rm(list=ls())</span><span leaf=""><br></span><span leaf="">library(TCGAbiolinks)</span><span leaf=""><br></span><span leaf="">library(SummarizedExperiment)</span><span leaf=""><br></span><span leaf="">library(tidyverse)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 癌症类型，用 getGDCprojects()$project_id 查看所有</span></span><span leaf=""><br></span><span leaf="">getGDCprojects()</span><span><span leaf="">$project_id</span></span><span leaf=""><br></span><span><span leaf=""># "TCGA-LIHC"</span></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 设置query </span></span><span leaf=""><br></span><span leaf="">query &lt;- GDCquery(</span><span leaf=""><br></span><span leaf="">  project = </span><span><span leaf="">"TCGA-LIHC"</span></span><span leaf="">,  </span><span><span leaf=""># 癌症类型，用 getGDCprojects()$project_id 查看所有</span></span><span leaf=""><br></span><span leaf="">  data.category=</span><span><span leaf="">"Transcriptome Profiling"</span></span><span leaf="">,     </span><span><span leaf=""># 数据类别, 用getProjectSummary(project)查看所有类别</span></span><span leaf=""><br></span><span leaf="">  data.type =</span><span><span leaf="">"Gene Expression Quantification"</span></span><span leaf="">, </span><span><span leaf=""># 数据类型</span></span><span leaf=""><br></span><span leaf="">  workflow.type=</span><span><span leaf="">"STAR - Counts"</span></span><span leaf="">                </span><span><span leaf=""># 工作流类型</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 下载数据</span></span><span leaf=""><br></span><span leaf="">GDCdownload(query=query, files.per.chunk= 50, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">## 整理数据并存储为 R对象</span></span><span leaf=""><br></span><span leaf="">GDCprepare(query,save=T, save.filename=</span><span><span leaf="">"TCGA-LIHC.transcriptome.Rdata"</span></span><span leaf="">, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">load(</span><span><span leaf="">"TCGA-LIHC.transcriptome.Rdata"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">ls()</span><span leaf=""><br></span><span leaf="">names(assays(data))</span><span leaf=""><br></span><span leaf="">rowdata &lt;- rowData(data)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">提取其中的表达矩阵：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">table(rowdata</span><span><span leaf="">$gene_type</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">count &lt;- assay(data,</span><span><span leaf="">"unstranded"</span></span><span leaf="">)   </span><span><span leaf=""># counts矩阵</span></span><span leaf=""><br></span><span leaf="">tpm &lt;- assay(data, </span><span><span leaf="">"tpm_unstrand"</span></span><span leaf="">)  </span><span><span leaf=""># tpm矩阵</span></span><span leaf=""><br></span><span leaf="">fpkm &lt;- assay(data,</span><span><span leaf="">"fpkm_unstrand"</span></span><span leaf="">) </span><span><span leaf=""># fpkm矩阵</span></span><span leaf=""><br></span><span leaf="">count[1:5,1:6]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 添加gene_symbol, 先提取gene_name</span></span><span leaf=""><br></span><span leaf="">symbol &lt;- rowData(data)</span><span leaf=""><br></span><span leaf="">head(symbol)</span><span leaf=""><br></span><span leaf="">count_symbol &lt;- cbind(data.frame(symbol</span><span><span leaf="">$gene_name</span></span><span leaf="">), as.data.frame(count))</span><span leaf=""><br></span><span leaf="">kp &lt;- duplicated(count_symbol</span><span><span leaf="">$symbol</span></span><span leaf="">.gene_name)</span><span leaf=""><br></span><span leaf="">temp &lt;- count_symbol[kp,]</span><span leaf=""><br></span><span leaf="">count_symbol &lt;- count_symbol[!kp,]</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">tpm_symbol &lt;- cbind(data.frame(symbol</span><span><span leaf="">$gene_name</span></span><span leaf="">), as.data.frame(tpm))  </span><span><span leaf=""># tpm矩阵</span></span><span leaf=""><br></span><span leaf="">tpm_symbol &lt;- tpm_symbol[!kp,]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 最后保存</span></span><span leaf=""><br></span><span leaf="">save(count_symbol, tpm_symbol, file = </span><span><span leaf="">"exp.RData"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">step2：临床信息下载</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">这里主要是得到样本的生存时间和生存结局：</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">query &lt;- GDCquery(</span><span leaf=""><br></span><span leaf="">  project = </span><span><span leaf="">"TCGA-LIHC"</span></span><span leaf="">, </span><span leaf=""><br></span><span leaf="">  data.category = </span><span><span leaf="">"Clinical"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  data.format = </span><span><span leaf="">"bcr xml"</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span><span leaf=""># save(query, file = "TCGA-LIHC.clinic.query.rdata")</span></span><span leaf=""><br></span><span><span leaf=""># <a topic-id="mljkoudt-as27o5" data-topic="1">#load</a>("TCGA-LIHC.clinic.query.rdata")</span></span><span leaf=""><br></span><span leaf="">GDCdownload(query, files.per.chunk= 50, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">clinical &lt;- GDCprepare_clinic(query, clinical.info = </span><span><span leaf="">"patient"</span></span><span leaf="">, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">clinical.follow_up &lt;- GDCprepare_clinic(query, clinical.info = </span><span><span leaf="">"follow_up"</span></span><span leaf="">, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">clinical.stage_event &lt;- GDCprepare_clinic(query, clinical.info = </span><span><span leaf="">"stage_event"</span></span><span leaf="">, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">clinical.drug &lt;- GDCprepare_clinic(query, clinical.info = </span><span><span leaf="">"drug"</span></span><span leaf="">, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">clinical.radiation &lt;- GDCprepare_clinic(query, clinical.info = </span><span><span leaf="">"radiation"</span></span><span leaf="">, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">clinical.admin &lt;- GDCprepare_clinic(query, clinical.info = </span><span><span leaf="">"admin"</span></span><span leaf="">, directory = </span><span><span leaf="">"./"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 保存</span></span><span leaf=""><br></span><span leaf="">saveRDS(clinical, file = </span><span><span leaf="">"TCGA-LIHC.clinical_patient.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">saveRDS(clinical.admin, file = </span><span><span leaf="">"TCGA-LIHC.clinical_admin.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">saveRDS(clinical.drug, file = </span><span><span leaf="">"TCGA-LIHC.clinical_drug.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">saveRDS(clinical.follow_up, file = </span><span><span leaf="">"TCGA-LIHC.clinical_follow_up.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">saveRDS(clinical.radiation, file = </span><span><span leaf="">"TCGA-LIHC.clinical_radiation.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">saveRDS(clinical.stage_event, file = </span><span><span leaf="">"TCGA-LIHC.clinical_stage_event.rds"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">step3：计算打分</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">使用AUCell：https://bioconductor.org/packages/release/bioc/vignettes/AUCell/inst/doc/AUCell.html</span></p><p data-tool="mdnice编辑器"><span leaf="">输入表达矩阵：使用count矩阵，这里的基因集使用的文献给的代码中放好的，就是有点奇怪，每个亚群的基因只用了5个，但是表格里面不止这么多。</span></p><pre data-tool="mdnice编辑器"><code><span leaf="">library(AUCell)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 定义基因集</span></span><span leaf=""><br></span><span leaf="">geneSets = list(c0=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"RPL27A"</span></span><span leaf="">,</span><span><span leaf="">"RPS27"</span></span><span leaf="">,</span><span><span leaf="">"RPL41"</span></span><span leaf="">,</span><span><span leaf="">"RPL35"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c1=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"DNAJB1"</span></span><span leaf="">,</span><span><span leaf="">"HSPH1"</span></span><span leaf="">,</span><span><span leaf="">"JUN"</span></span><span leaf="">,</span><span><span leaf="">"BAG3"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c2=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"NFKB1"</span></span><span leaf="">,</span><span><span leaf="">"NR4A3"</span></span><span leaf="">,</span><span><span leaf="">"VEGFA"</span></span><span leaf="">,</span><span><span leaf="">"KDM6B"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c3=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"RGS1"</span></span><span leaf="">,</span><span><span leaf="">"CMA1"</span></span><span leaf="">,</span><span><span leaf="">"CTSG"</span></span><span leaf="">,</span><span><span leaf="">"FOS"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c4=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"PKM"</span></span><span leaf="">,</span><span><span leaf="">"MYDGF"</span></span><span leaf="">,</span><span><span leaf="">"PDIA3"</span></span><span leaf="">,</span><span><span leaf="">"PPIB"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c5=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"CREM"</span></span><span leaf="">,</span><span><span leaf="">"BCL2A1"</span></span><span leaf="">,</span><span><span leaf="">"BIRC3"</span></span><span leaf="">,</span><span><span leaf="">"EIF1"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c6=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"TXNIP"</span></span><span leaf="">,</span><span><span leaf="">"TPSB2"</span></span><span leaf="">,</span><span><span leaf="">"CTSD"</span></span><span leaf="">,</span><span><span leaf="">"S100A4"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c7=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"HLA-DPB1"</span></span><span leaf="">,</span><span><span leaf="">"HLA-DPA1"</span></span><span leaf="">,</span><span><span leaf="">"HLA-DQB1"</span></span><span leaf="">,</span><span><span leaf="">"HLA-DMB"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c8=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"HSPA1A"</span></span><span leaf="">,</span><span><span leaf="">"EGR1"</span></span><span leaf="">,</span><span><span leaf="">"HSPE1"</span></span><span leaf="">,</span><span><span leaf="">"FOS"</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">                c9=c(</span><span><span leaf="">"TPSAB1"</span></span><span leaf="">,</span><span><span leaf="">"CCL5"</span></span><span leaf="">,</span><span><span leaf="">"IL32"</span></span><span leaf="">,</span><span><span leaf="">"NKG7"</span></span><span leaf="">,</span><span><span leaf="">"IL7R"</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 加载表达矩阵</span></span><span leaf=""><br></span><span leaf="">load(</span><span><span leaf="">"./TCGA-LIHC/exp.RData"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">count_symbol[1:6,1:5]</span><span leaf=""><br></span><span leaf="">rownames(count_symbol) &lt;- count_symbol</span><span><span leaf="">$symbol</span></span><span leaf="">.gene_name</span><span leaf=""><br></span><span leaf="">count_symbol &lt;- count_symbol[,-1]</span><span leaf=""><br></span><span leaf="">count_symbol[1:6,1:5]</span><span leaf=""><br></span><span><span leaf=""># 过滤低表达</span></span><span leaf=""><br></span><span leaf="">kp &lt;- rowSums(count_symbol)&gt;1</span><span leaf=""><br></span><span leaf="">table(kp)</span><span leaf=""><br></span><span leaf="">expr_data &lt;- count_symbol[kp,]</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sparse_expr &lt;- as(as.matrix(expr_data), </span><span><span leaf="">"sparseMatrix"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">cells_rankings &lt;- AUCell_buildRankings(sparse_expr )</span><span leaf=""><br></span><span leaf="">auc_scores &lt;- AUCell_calcAUC(geneSets, cells_rankings)</span><span leaf=""><br></span><span leaf="">temp &lt;- getAUC(auc_scores)</span><span leaf=""><br></span><span leaf="">auc_df &lt;- data.frame(id = colnames(expr_data), score = t(temp))</span><span leaf=""><br></span><span leaf="">head(auc_df)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-aistatus="1" data-imgfileid="100065727" data-ratio="0.10740740740740741" data-src="https://mmbiz.qpic.cn/mmbiz_png/P6FfAMT9SUiaXQ26ekSsO1wpXCOnrNgCObjSwVibmmtGZyqFlEj7Pjnct5UD8NvwQONv7w1yPsxEHpicuMO8JpDkPV8GLHib6Spn4uza3xpDS0A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/P6FfAMT9SUiaXQ26ekSsO1wpXCOnrNgCObjSwVibmmtGZyqFlEj7Pjnct5UD8NvwQONv7w1yPsxEHpicuMO8JpDkPV8GLHib6Spn4uza3xpDS0A/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">这样就得到了每个样本的9个基因集的打分。</span></p><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">step4：打分与临床信息整合</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">现在加载之前的临床信息与上面的打分合并，整理后就可以根据打分对样本进行分组，看两组间的生存时间差异啦！</span></p><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">先加载临床信息，预处理</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">过滤小于30天的patients，没有临床结局的patients。</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 加载临床信息</span></span><span leaf=""><br></span><span leaf="">clinical &lt;- readRDS(</span><span><span leaf="">"./TCGA-LIHC/TCGA-LIHC.clinical_follow_up.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">colnames(clinical)</span><span leaf=""><br></span><span leaf="">clinical &lt;- clinical[,c(</span><span><span leaf="">"bcr_followup_barcode"</span></span><span leaf="">,</span><span><span leaf="">"vital_status"</span></span><span leaf="">,</span><span><span leaf="">"days_to_last_followup"</span></span><span leaf="">,</span><span><span leaf="">"days_to_death"</span></span><span leaf=""> )]</span><span leaf=""><br></span><span leaf="">head(clinical)</span><span leaf=""><br></span><span leaf="">clinical</span><span><span leaf="">$OS</span></span><span leaf=""> &lt;- ifelse(!is.na(clinical</span><span><span leaf="">$days_to_death</span></span><span leaf="">), clinical</span><span><span leaf="">$days_to_death</span></span><span leaf="">, clinical</span><span><span leaf="">$days_to_last_followup</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">clinical &lt;- clinical[clinical</span><span><span leaf="">$OS</span></span><span leaf="">&gt;30,]</span><span leaf=""><br></span><span leaf="">table(clinical</span><span><span leaf="">$vital</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">clinical &lt;- clinical[clinical</span><span><span leaf="">$vital</span></span><span leaf="">!=</span><span><span leaf="">""</span></span><span leaf="">,]</span><span leaf=""><br></span><span leaf="">clinical</span><span><span leaf="">$vital</span></span><span leaf=""> &lt;- ifelse(clinical</span><span><span leaf="">$vital_status</span></span><span leaf="">==</span><span><span leaf="">"Dead"</span></span><span leaf="">,1,0)</span><span leaf=""><br></span><span leaf="">dim(clinical)</span><span leaf=""><br></span></code></pre><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">与上面的表达矩阵合并</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">这里先提取肿瘤样本：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># auc打分选肿瘤样本</span></span><span leaf=""><br></span><span leaf="">kp &lt;- substr(rownames(auc_df),14,16)</span><span leaf=""><br></span><span leaf="">table(kp)</span><span leaf=""><br></span><span leaf="">auc_df_tumor &lt;- auc_df[rownames(auc_df)[kp==</span><span><span leaf="">"01A"</span></span><span leaf="">],]</span><span leaf=""><br></span><span leaf="">auc_df_tumor</span><span><span leaf="">$patient</span></span><span leaf=""> &lt;- substr(auc_df_tumor</span><span><span leaf="">$id</span></span><span leaf="">,1,12)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 合并</span></span><span leaf=""><br></span><span leaf="">auc_clin &lt;- merge(clinical, auc_df_tumor,by.x = </span><span><span leaf="">"bcr_patient_barcode"</span></span><span leaf="">, by.y = </span><span><span leaf="">"patient"</span></span><span leaf=""> )</span><span leaf=""><br></span><span leaf="">head(auc_clin)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-aistatus="1" data-imgfileid="100065726" data-ratio="0.1814814814814815" data-src="https://mmbiz.qpic.cn/mmbiz_png/P6FfAMT9SUg5bd2pjDuBXXxIZJIL2gxzuqkq3XHH4ibK9O5IJkxlaOoazAt1ic2iakgvA5LLrtv8nz5FqaDqQmdeRWlfvfSkjqVsJ2Fy2BaiaPI/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/P6FfAMT9SUg5bd2pjDuBXXxIZJIL2gxzuqkq3XHH4ibK9O5IJkxlaOoazAt1ic2iakgvA5LLrtv8nz5FqaDqQmdeRWlfvfSkjqVsJ2Fy2BaiaPI/640?wx_fmt=png&amp;from=appmsg"></span></figure><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">step5：绘制 C7-HLA-DR cluster 亚群相关KM曲线</span></span><span></span></h2><p data-tool="mdnice编辑器"><span leaf="">与LICH的预后相关性：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 选择最佳阈值分组点</span></span><span leaf=""><br></span><span leaf="">res.cut &lt;- surv_cutpoint(auc_clin, time = </span><span><span leaf="">"OS"</span></span><span leaf="">, event = </span><span><span leaf="">"vital"</span></span><span leaf="">, variables = </span><span><span leaf="">"score.c7"</span></span><span leaf="">  )</span><span leaf=""><br></span><span leaf="">res.cat &lt;- surv_categorize(res.cut)</span><span leaf=""><br></span><span leaf="">head(res.cat)</span><span leaf=""><br></span><span leaf="">auc_clin</span><span><span leaf="">$group</span></span><span leaf=""> &lt;- res.cat[,</span><span><span leaf="">"score.c7"</span></span><span leaf="">] </span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">绘制KM曲线：</span></p><pre data-tool="mdnice编辑器"><code><span><span leaf=""># 生存分析</span></span><span leaf=""><br></span><span leaf="">fit &lt;- survfit(Surv(OS, vital) ~score.c7, data = res.cat)</span><span leaf=""><br></span><span leaf="">p3 &lt;- ggsurvplot(fit, pval=TRUE, </span><span leaf=""><br></span><span leaf="">                 legend.labs=c( </span><span><span leaf="">"High"</span></span><span leaf="">,</span><span><span leaf="">"Low"</span></span><span leaf="">), size = 1, </span><span leaf=""><br></span><span leaf="">                 risk.table = F, palette = c(</span><span><span leaf="">"<a topic-id="mljkoudt-qam3v1" data-topic="1">#fc9272</a>"</span></span><span leaf="">,</span><span><span leaf="">"<a topic-id="mljkoudt-zri4rn" data-topic="1">#6baed6</a>"</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">p &lt;- p3</span><span><span leaf="">$plot</span></span><span leaf=""> + </span><span leaf=""><br></span><span leaf="">  xlab(</span><span><span leaf="">"Time(Days) "</span></span><span leaf="">) + </span><span leaf=""><br></span><span leaf="">  labs(title = </span><span><span leaf="">"LIHC"</span></span><span leaf="">, color = </span><span><span leaf="">"C7-HLA-DR"</span></span><span leaf=""> ) +   </span><span><span leaf=""># 修改颜色图例的标题</span></span><span leaf=""><br></span><span leaf="">  theme(</span><span leaf=""><br></span><span leaf="">    plot.title = element_text(hjust = 0.5),  </span><span><span leaf=""># 标题居中</span></span><span leaf=""><br></span><span leaf="">    legend.position = </span><span><span leaf="">"right"</span></span><span leaf=""> )              </span><span><span leaf=""># 图例放到右侧</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">p</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/P6FfAMT9SUgI66OynyTicMn6iaxwsKIfmibbicapCW6062FBtt2g9n0DEtGFmJMCGDf067xlnv5MJs9KgyPiaVqSu0LswicdicHJ3OG79Vc8Wn2Wy8/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7644376899696048" data-type="png" data-w="658" data-imgfileid="100065729" data-aistatus="1" src="https://mmbiz.qpic.cn/sz_mmbiz_png/P6FfAMT9SUgI66OynyTicMn6iaxwsKIfmibbicapCW6062FBtt2g9n0DEtGFmJMCGDf067xlnv5MJs9KgyPiaVqSu0LswicdicHJ3OG79Vc8Wn2Wy8/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><span leaf="">上面的pvalue小于0.05，说明这个亚群可能与病人的生存相关~</span></p><p data-tool="mdnice编辑器"><span leaf="">这一套学废了吗？</span></p><p data-tool="mdnice编辑器"><span leaf="">后面还会有其他的单细胞生存分析技巧，欢迎关注~</span></p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">如果上面的内容对你有用，欢迎一键三连~</span></p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">转发：</span></span></p></section><ul><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247547917&amp;idx=1&amp;sn=76afb50b6e9e433e3f2b3d039f72dac4&amp;scene=21#wechat_redirect" textvalue="生信入门&amp;数据挖掘线上直播课2026年1月班" data-itemshowtype="0" linktype="text" data-linktype="2">生信入门&amp;数据挖掘线上直播课2026年1月班</a><span textstyle="">，你的生物信息学入门课</span></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247525079&amp;idx=1&amp;sn=0b997af16a58195b4192691373048fd5&amp;scene=21#wechat_redirect" textvalue="时隔5年，我们的生信技能树VIP学徒继续招生啦" data-itemshowtype="0" linktype="text" data-linktype="2"><span textstyle="">时隔5年，我们的生信技能树VIP学徒继续招生啦</span></a></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247530048&amp;idx=1&amp;sn=28aa7bbd5e00521f79e074496a5f5d66&amp;scene=21#wechat_redirect" textvalue="满足你生信分析计算需求的低价解决方案" data-itemshowtype="0" linktype="text" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=1679199708449144836&amp;scene=173&amp;subscene=207&amp;sessionid=1745492310&amp;enterid=1745492314&amp;from_msgid=2247541298&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="生信故事会" data-itemshowtype="0" linktype="text" data-linktype="2">生信故事会</a>，来看看他们的生信入门故事</span></section></li><li><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=3690970204957147140&amp;scene=173&amp;subscene=207&amp;sessionid=1745066271&amp;enterid=1745066274&amp;from_msgid=2247540702&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" textvalue="生信马拉松答疑专辑" data-itemshowtype="0" linktype="text" data-linktype="2">生信马拉松答疑专辑</a>，获取你的生信专属答疑</span></section></li></ul><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/TzwntPKJfm75bWzIzoemMg",target="_blank" rel="noopener noreferrer">原文链接</a>
