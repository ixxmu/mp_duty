---
title: "Cell 复现|惊艳审稿人的相关性聚类热图"
date: 2025-02-20T11:22:32Z
draft: ["false"]
tags: [
  "fetched",
  "MsTt笔记"
]
categories: ["Acdemic"]
---
Cell 复现|惊艳审稿人的相关性聚类热图 by MsTt笔记
------
<div><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkxNDcwNzY2NQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJLwvM2QW48QKCicY8yHrEfwZA1qzJqmnSDuICrXOZEk6YYntc7QSLbdwg12uibFOEziaEVEXhEJQ4vQ/0?wx_fmt=png" data-nickname="MsTt笔记" data-alias="" data-signature="Keep learning 代码分享" data-from="1" data-is_biz_ban="0"></mp-common-profile></section><section data-mpa-powered-by="yiban.io"><span><br></span></section><section data-mpa-powered-by="yiban.io"><span>请尊重原创劳动成果</span></section><p><span>未经允许，不得转载</span></p><p data-tool="mdnice编辑器">今天来复现 <strong>Cell</strong> 文章中 (Luo, Yikai et al. Neoadjuvant PARPi or chemotherapy in ovarian cancer informs targeting effector Treg cells for homologous-recombination-deficient tumors. Cell, Volume 187, Issue 18, 4905 - 4925.e24. https://doi.org/10.1016/j.cell.2024.06.013) 的 Figure 3A</p><h2 data-tool="mdnice编辑器"><span></span><span>原图</span></h2><p data-tool="mdnice编辑器"><img data-imgfileid="100000427" data-ratio="0.5324074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYh9S8vlkEI66Dv1ULmxB5yV8zF9WW0gpGIicHdPoUNOItGDV1kezDvK4w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYh9S8vlkEI66Dv1ULmxB5yV8zF9WW0gpGIicHdPoUNOItGDV1kezDvK4w/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">这个聚类热图很清晰地展示了两个数据集：</p><ul data-tool="mdnice编辑器"><li><section>右上半三角展示的是 GEO 验证数据的结果。</section></li><li><section>左下半三角展示的是 in-house 数据的结果。</section></li><li><section>通过这种可视化方式，两个数据集的一致性和差异性，就一目了然。</section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span>复现图</span></h2><p><img data-galleryid="" data-imgfileid="100000433" data-ratio="0.85546875" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYh7W0Tnj9OG3sLJuxSvCicjybvr5X58iadhScQHEhAdSedpxW07RibQoPDw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1024" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYh7W0Tnj9OG3sLJuxSvCicjybvr5X58iadhScQHEhAdSedpxW07RibQoPDw/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">此图复现使用的是 Python 语言，亲测 Seaborn 库 clustermap 很好用。</p><h2 data-tool="mdnice编辑器"><span></span><span>加载库，准备数据</span></h2><pre data-tool="mdnice编辑器"><code><span>import</span> csv<br><span>import</span> pandas <span>as</span> pd<br><span>import</span> seaborn <span>as</span> sns<br><span>import</span> numpy <span>as</span> np<br><span>from</span> scipy.cluster.hierarchy <span>import</span> dendrogram<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br><br><span># 数据</span><br>df_gse165897 = pd.read_csv(<span>"data_GSE.csv"</span>)<br>df_inhouse = pd.read_csv(<span>"data_inhouse.csv"</span>)<br></code></pre><p data-tool="mdnice编辑器">原文未提供用于绘图的单细胞测序数据，我编写了两个随机数据集来做测试，仅供参考无实际意义，文末可以自助获取。</p><h2 data-tool="mdnice编辑器"><span></span><span>绘图 - 右上半三角热图</span></h2><pre data-tool="mdnice编辑器"><code><span># 计算相关性矩阵</span><br>df_corr = df_gse165897.corr(<span>'pearson'</span>)<br><br><span># 创建 clustermap</span><br>cm = sns.clustermap(df_corr,<br>                    annot=<span>False</span>, <br>                    cmap=plt.cm.Spectral_r, <span>#文章颜色 PiYG_r</span><br>                    vmin=<span>-1</span>, <br>                    vmax=<span>1</span>, <br>                    linewidth=<span>0</span>,<br>                    xticklabels=<span>False</span>, <br>                    yticklabels=<span>True</span>,<br>                    metric=<span>'correlation'</span>,<br>                    figsize=(<span>14.7</span>, <span>12</span>))<br><br><span># 创建 mask 和调整 heatmap</span><br>mask = np.tril(np.ones_like(df_corr), <span>-1</span>)<br>values = cm.ax_heatmap.collections[<span>0</span>].get_array().reshape(df_corr.shape)<br>new_values = np.ma.array(values, mask=mask)<br>cm.ax_heatmap.collections[<span>0</span>].set_array(new_values)<br><br><span># 设置 y 轴标签字体大小</span><br><span>for</span> label <span>in</span> cm.ax_heatmap.get_yticklabels():<br>    label.set_size(<span>20</span>)<br><br><span># 隐藏横向的树状图</span><br>cm.ax_row_dendrogram.set_visible(<span>False</span>)<br><br><span># 修改列聚类树中线的粗细</span><br><span>for</span> line <span>in</span> cm.ax_col_dendrogram.collections:<br>    line.set_linewidth(<span>2</span>)<br>    line.set_color(<span>'#4B4B4B'</span>)<br><br><span># 设置 colorbar 标题</span><br>cm.ax_cbar.set_title(<span>'Rp'</span>)<br></code></pre><ol data-tool="mdnice编辑器"><li><section>使用 seaborn 库的 <code>clustermap()</code> 函数创建聚类热图。</section></li></ol><ul data-tool="mdnice编辑器"><li><section><code>annot=False</code>：不显示单元格上的数值注释。</section></li><li><section><code>cmap=plt.cm.Spectral_r</code>：设置热图的颜色映射（colormap），使用 matplotlib 的 Spectral_r 反转颜色映射。</section></li><li><section><code>vmin=-1</code> 和 <code>vmax=1</code>：设置颜色映射的最小值和最大值，范围从 -1 到 1。</section></li><li><section><code>linewidth=0</code>：设置单元格之间的线宽为 0。</section></li><li><section><code>metric='correlation'</code>：使用相关性作为距离度量进行聚类。</section></li></ul><ol start="2" data-tool="mdnice编辑器"><li><section>创建 mask</section></li></ol><ul data-tool="mdnice编辑器"><li><section><code>np.tril(np.ones_like(df_corr), -1)</code>：创建一个下三角矩阵（包括主对角线以下的元素为 1，其余为 0），用于掩盖热图中的上三角部分。</section></li><li><section><code>values = cm.ax_heatmap.collections[0].get_array().reshape(df_corr.shape)</code>：获取热图中的数据值，并将其形状重塑为原始相关性矩阵的形状。</section></li><li><section><code>new_values = np.ma.array(values, mask=mask)</code>：应用掩码创建一个新的遮盖数组，其中上三角部分将被掩盖。</section></li><li><section><code>cm.ax_heatmap.collections[0].set_array(new_values)</code>：将新的遮盖数组设置回热图。</section></li></ul><p><img data-backh="174" data-backw="233" data-galleryid="" data-imgfileid="100000430" data-ratio="0.7481481481481481" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYhdrBnAvqFRrrscepoledkzLibWNib4CnzTPGxjatK9PA7iaVAJT4Ovwhgg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYhdrBnAvqFRrrscepoledkzLibWNib4CnzTPGxjatK9PA7iaVAJT4Ovwhgg/640?wx_fmt=png&amp;from=appmsg"></p><h2 data-tool="mdnice编辑器"><span></span><span>绘图 - 左下半三角热图</span></h2><pre data-tool="mdnice编辑器"><code><span># 计算相关性矩阵</span><br>df_inhouse_corr = df_inhouse.corr(<span>'pearson'</span>)<br><br><span># 绘制 clustermap</span><br>cm = sns.clustermap(df_inhouse_corr,<br>                    annot=<span>False</span>,<br>                    cmap=plt.cm.PuOr_r,  <span>#文章颜色 RdBu_r </span><br>                    vmin=<span>-1</span>,<br>                    vmax=<span>1</span>, <br>                    linewidth=<span>0</span>,   <br>                    xticklabels=<span>False</span>,<br>                    yticklabels=<span>True</span>, <br>                    metric=<span>'correlation'</span>, <br>                    figsize=(<span>14.7</span>, <span>12</span>))<br><br><span># 创建 mask 和调整 heatmap</span><br>mask = np.triu(np.ones_like(df_inhouse_corr),<span>1</span>)<br>values = cm.ax_heatmap.collections[<span>0</span>].get_array().reshape(df_inhouse_corr.shape)<br>new_values = np.ma.array(values, mask=mask)<br>cm.ax_heatmap.collections[<span>0</span>].set_array(new_values)<br><br><span># 移动 y 轴标签在左侧</span><br>cm.ax_heatmap.yaxis.set_label_position(<span>'left'</span>)<br>cm.ax_heatmap.yaxis.set_ticks_position(<span>'left'</span>)<br><br><span># 设置 y 轴标签字体大小</span><br><span>for</span> label <span>in</span> cm.ax_heatmap.get_yticklabels():<br>    label.set_size(<span>20</span>)<br><br><span># 隐藏原始的树状图</span><br>cm.ax_row_dendrogram.set_visible(<span>False</span>)<br>cm.ax_col_dendrogram.set_visible(<span>False</span>)<br><br><span># 计算新的聚类树数据</span><br>col_linkage = cm.dendrogram_col.linkage<br><br><span># 创建新的 subplot 以显示树状图</span><br>fig = plt.gcf()<br><br><span># 树状图的 axes</span><br>ax_dendro_row = fig.add_axes([<span>0.183</span>, <span>-0.19</span>, <span>0.69</span>, <span>0.2</span>]) <span># 调整为适当位置</span><br>ax_dendro_row.axis(<span>'off'</span>)<br><br><span># 绘制新的树状图</span><br>dendro=dendrogram(col_linkage, ax=ax_dendro_row, orientation=<span>'bottom'</span>, no_labels=<span>True</span>)<br><br><span># 修改横向树状图中线的粗细</span><br><span>for</span> i <span>in</span> range(len(ax_dendro_row.collections)):<br>    ax_dendro_row.collections[i].set_linewidth(<span>2</span>)  <span># 2 是设置的线条粗细，你可以调整</span><br>    ax_dendro_row.collections[i].set_color(<span>'#4B4B4B'</span>)<br><br><span># 设置 colorbar 标题</span><br>cm.ax_cbar.set_title(<span>'Rs'</span>)<br></code></pre><ol start="3" data-tool="mdnice编辑器"><li><section>使用 seaborn 库的 <code>clustermap()</code> 函数创建聚类热图，代码同上。</section></li><li><section>创建 mask，代码与前面差异之处：</section></li></ol><ul data-tool="mdnice编辑器"><li><section><code>np.triu(np.ones_like(df_inhouse_corr),1)</code>：创建一个上三角矩阵，用于掩盖热图中的下三角部分。</section></li></ul><ol start="5" data-tool="mdnice编辑器"><li><section>移动 Y 轴标签和聚类树，因为 Seaborn 默认的标签在下侧和右侧。</section></li></ol><ul data-tool="mdnice编辑器"><li><section><code>cm.ax_heatmap.yaxis.set_label_position('left')</code>：设置 y 轴的标签位置为左侧。</section></li><li><section><code>cm.ax_heatmap.yaxis.set_ticks_position('left')</code>：设置 y 轴的刻度位置为左侧。</section></li></ul><ol start="6" data-tool="mdnice编辑器"><li><section>移动聚类树，因为 Seaborn 默认的聚类树在顶部和左侧。我的思路是先隐藏原始的树状图，然后计算新的聚类树数据，再绘制新的树状图。</section></li></ol><ul data-tool="mdnice编辑器"><li><section><code>cm.ax_row_dendrogram.set_visible(False)</code>：将行树状图（左侧的树状图）设置为不可见。</section></li><li><section><code>cm.ax_col_dendrogram.set_visible(False)</code>：将列树状图（顶部的树状图）设置为不可见。</section></li><li><section><code>cm.dendrogram_col.linkage</code>：获取列聚类的链接矩阵，用于重新绘制树状图。</section></li><li><section>使用 scipy 库的<code>dendrogram()</code>函数：在新的轴上绘制树状图。</section></li></ul><p><img data-galleryid="" data-imgfileid="100000431" data-ratio="1.0583333333333333" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYhRt7HZ2k8qEboia9V9P3SJvkYNcUia0hN3cFHXYXZxpHDgMO6P2HtKNew/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYhRt7HZ2k8qEboia9V9P3SJvkYNcUia0hN3cFHXYXZxpHDgMO6P2HtKNew/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">关于边缘的气泡图，如果是单细胞数据的话，可以直接用 scanpy 库的<code>sc.pl.dotplot()</code> 函数来绘制，超级简单，所以我这里就不再复现了。</p><p data-tool="mdnice编辑器">最后可以用 AI 或 PPT 将两张热图组合在一起，我偷个懒直接用 PPT 简单弄了一下。</p><p><img data-galleryid="" data-imgfileid="100000434" data-ratio="0.85546875" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYh7W0Tnj9OG3sLJuxSvCicjybvr5X58iadhScQHEhAdSedpxW07RibQoPDw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1024" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJpX2gS6vkicymhwnQLOULYh7W0Tnj9OG3sLJuxSvCicjybvr5X58iadhScQHEhAdSedpxW07RibQoPDw/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><span>获取 .ipynb 格式绘图代码、测试数据和运行环境，后台回复关键词: <strong><em>240918_double_clustermap</em></strong></span><span></span></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/nB4W7qAnHsZ5M1fkxftgVA",target="_blank" rel="noopener noreferrer">原文链接</a>
