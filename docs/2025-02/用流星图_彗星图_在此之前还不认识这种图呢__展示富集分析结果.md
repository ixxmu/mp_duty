---
title: "用流星图/彗星图（在此之前还不认识这种图呢！）展示富集分析结果"
date: 2025-02-09T08:11:51Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
用流星图/彗星图（在此之前还不认识这种图呢！）展示富集分析结果 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p><strong>我们生信技能树的单细胞python群里面收到一位学员的需求，问下面这个图怎么画</strong>。我一看，我去这是什么图啊，看上去都是一排排的美甲！激动地搓搓手，这就来研究一下怎么搞！</p></blockquote><figure data-tool="mdnice编辑器"><img data-imgfileid="100054312" data-ratio="0.5750332005312085" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPuUo62FYylVfsZjlTj055nOB2UVCibQuoicrbkf45F7nGf0Yb4oxskg7Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="753" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPuUo62FYylVfsZjlTj055nOB2UVCibQuoicrbkf45F7nGf0Yb4oxskg7Q/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>图片背景</span><span></span></h2><p data-tool="mdnice编辑器">这幅图来自 2024 年 6 月份发表在 Int J Mol Sci杂志上的文献：《Novel AT2 Cell Subpopulations and Diagnostic Biomarkers in IPF: Integrating Machine Learning with Single-Cell Analysis》。<strong>我左思右想没能想到这是个什么图，图的含义当然很好理解，就去问了一下张俊，果然他画过，一下子就从他那里得到了图的名字：流星图（机智如我）。</strong>他的笔记见：<a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247513571&amp;idx=1&amp;sn=65c28c7798caee6a68208c7f8c50cc2b&amp;scene=21#wechat_redirect" data-linktype="2">富集分析流星图?</a></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100054316" data-ratio="0.7118811881188118" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPric6BFvcSicxUBwJLXib1mdIr5OZ2PeQxxkIibI3IIRneT1mHdFYiaSf0pQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1010" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPric6BFvcSicxUBwJLXib1mdIr5OZ2PeQxxkIibI3IIRneT1mHdFYiaSf0pQ/640?wx_fmt=jpeg&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">图注：横坐标为-log10(pvalue)，纵坐标为通路，彗星的头为一个圈，里面是此通路中的差异基因个数，颜色为不同的细胞亚群。</p><blockquote data-tool="mdnice编辑器"><span></span><p>Figure 2. Molecular characterization of the cellular heterogeneity of human IPF lung tissue according to dataset GSE128033. (E) Representative enriched GO terms enriched in each cell type are depicted. The numbers at the front end of the column represent the number of genes enriched in the GO term.</p></blockquote><h2 data-tool="mdnice编辑器"><span></span><span>数据背景</span><span></span></h2><p data-tool="mdnice编辑器">文章中的单细胞数据为：GSE128033，<span>https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE128033</span>。</p><p data-tool="mdnice编辑器">包括 8个特发性纤维化（IPF）样本和10个正常样本，共66500个细胞（文章中过滤后的细胞数）。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100054314" data-ratio="0.3733055265901981" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPRX4CA7YFOGotJXNzNLtHKH2pbhgUTsWHyviacoxd5tZhs58IO7dkyIA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="959" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPRX4CA7YFOGotJXNzNLtHKH2pbhgUTsWHyviacoxd5tZhs58IO7dkyIA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">以下是来自这个数据对应的文献中使用 kimi 整理后的细胞类型及其对应的 marker 基因，细胞名与基因名放在同一行：</p><ul data-tool="mdnice编辑器"><li><section>Club cells: SCGB1A1, SCGB3A2</section></li><li><section>Alveolar type I (AT1) cells: AGER</section></li><li><section>Alveolar type II (AT2) cells: SFTPC</section></li><li><section>Ciliated cells: FOXJ1</section></li><li><section>Basal airway cells: KRT5</section></li><li><section>Goblet cells: MUC5B</section></li><li><section>Fibroblasts: COL1A1, COL1A2, PDGFRA</section></li><li><section>Smooth muscle cells: DES, ACTG2</section></li><li><section>Endothelial cells: VWF</section></li><li><section>Lymphatic endothelial cells: LYVE1</section></li><li><section>Pericytes: RGS5</section></li><li><section>Macrophages: AIF1, CD163</section></li><li><section>Dendritic cells: CD1C</section></li><li><section>Mast cells: TPSAB1</section></li><li><section>T lymphocytes: CD3, CD8A</section></li><li><section>B lymphocytes: MS4A1, CD20, IGKC, MZB1</section></li><li><section>NK cells: GNLY</section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span>数据预处理：GSE128033</span><span></span></h2><p data-tool="mdnice编辑器">简单读取进来：</p><pre data-tool="mdnice编辑器"><span></span><code><span>###</span><br><span>### Create: Jianming Zeng</span><br><span>### Date:  2023-12-31  </span><br><span>### Email: jmzeng1314@163.com</span><br><span>### Blog: http://www.bio-info-trainee.com/</span><br><span>### Forum:  http://www.biotrainee.com/thread-1376-1-1.html</span><br><span>### CAFS/SUSTC/Eli Lilly/University of Macau</span><br><span>### Update Log: 2023-12-31   First version </span><br><span>### Update Log: 2024-12-09   by juan zhang (492482942@qq.com)</span><br><span>### </span><br><br>rm(list=ls())<br>options(stringsAsFactors = F)<br>library(ggsci)<br>library(dplyr) <br>library(future)<br>library(Seurat)<br>library(clustree)<br>library(cowplot)<br>library(data.table)<br>library(ggplot2)<br>library(patchwork)<br>library(stringr)<br>library(qs)<br>library(Matrix)<br>getwd()<br><br><span># 创建目录</span><br>getwd()<br>gse &lt;- <span>"GSE128033"</span><br>dir.create(gse)<br><br><span># 下载 raw 文件夹</span><br><span># https://ftp.ncbi.nlm.nih.gov/geo/series/GSE163nnn/GSE163558/suppl/GSE163558_RAW.tar</span><br><span># 使用正则表达式替换：\w{3}$ 匹配每个单词最后的三个字符替换为空字符串，即去掉它们</span><br>s &lt;- gsub(<span>"(\\w{3}$)"</span>, <span>""</span>, gse, perl = TRUE)<br>s<br>url &lt;- paste0(<span>"https://ftp.ncbi.nlm.nih.gov/geo/series/"</span>,s,<span>"nnn/"</span>,gse,<span>"/suppl/"</span>,gse,<span>"_RAW.tar"</span>)<br>url<br>file &lt;- paste0(gse,<span>"_RAW.tar"</span>)<br>file<br><span># downloader::download(url, destfile = file)</span><br><br><span>###### step1: 导入数据 ######  </span><br><span># GSE128033为整理后的每个文件里都是标准的三个文件</span><br>samples &lt;- list.dirs(<span>"GSE128033/"</span>, recursive = F, full.names = F)<br>samples<br>scRNAlist &lt;- lapply(samples, <span>function</span>(pro){<br>  <span>#pro &lt;- samples[1]</span><br>  <span>print</span>(pro)<br>  folder &lt;- file.path(<span>"GSE128033/"</span>, pro)<br>  folder<br>  counts &lt;- Read10X(folder, gene.column = 2)<br>  sce &lt;- CreateSeuratObject(counts, project=pro, min.features=3)<br>  <span>return</span>(sce)<br>})<br>names(scRNAlist) &lt;-  samples<br>scRNAlist<br><br><span># merge</span><br>sce.all &lt;- merge(scRNAlist[[1]], y=scRNAlist[-1], add.cell.ids=samples)<br>sce.all &lt;- JoinLayers(sce.all) <span># seurat v5</span><br>sce.all<br><br><br><span># 查看特征</span><br>as.data.frame(sce.all@assays<span>$RNA</span><span>$counts</span>[1:10, 1:2])<br>sce.all<span>$Sample</span> &lt;- sce.all<span>$orig</span>.ident<br>sce.all<span>$orig</span>.ident &lt;- str_split(sce.all<span>$orig</span>.ident, pattern = <span>"_"</span>, n=2,simplify = T)[,2]<br>head(sce.all@meta.data, 10)<br>table(sce.all<span>$orig</span>.ident) <br><br>library(qs)<br>qsave(sce.all, file=<span>"GSE128033/sce.all.qs"</span>)<br></code></pre><p data-tool="mdnice编辑器">然后经过简单的质控与去批次，并降维聚类细胞注释，得到下面的UMAP图：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100054313" data-ratio="0.6947115384615384" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPlHDN6STd0ia27LXDibJsc2GjZzrjoIM4lx2QGR2Mt44CpQYrIibWPgyiaA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="832" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPlHDN6STd0ia27LXDibJsc2GjZzrjoIM4lx2QGR2Mt44CpQYrIibWPgyiaA/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>绘图，开整</span><span></span></h2><h3 data-tool="mdnice编辑器"><span></span><span></span><span>1、对每个亚群做差异分析得到差异基因</span><span></span></h3><p data-tool="mdnice编辑器">这里先去掉双细胞：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 加载包</span><br>library(org.Hs.eg.db)<br>library(clusterProfiler)<br>library(ggplot2)<br><br>table(Idents(sce.all.int))<br>sce.all.int &lt;- subset(sce.all.int, ident=<span>"Double cells"</span>, invert=T)<br><br><span># 差异分析</span><br>sce.markers &lt;- FindAllMarkers(sce.all.int, only.pos = TRUE, min.pct = 0.2, return.thresh = 0.01)<br>head(sce.markers)<br><br><span># 查看top10</span><br>top10 &lt;- sce.markers %&gt;%<br>  group_by(cluster) %&gt;%<br>  dplyr::filter(avg_log2FC &gt; 1) %&gt;%<br>  slice_head(n = 10) %&gt;%<br>  ungroup()<br><br><span># 基因转成ENTREZID</span><br>Symbol &lt;- mapIds(get(<span>"org.Hs.eg.db"</span>), keys = sce.markers<span>$gene</span>, keytype = <span>"SYMBOL"</span>, column=<span>"ENTREZID"</span>)<br>head(Symbol)<br>ids &lt;- bitr(sce.markers<span>$gene</span>,fromType = <span>"SYMBOL"</span>,toType = <span>"ENTREZID"</span>, OrgDb = <span>"org.Hs.eg.db"</span>)<br>head(ids)<br><br><span># 合并ENTREZID到obj.markers中</span><br>data &lt;- merge(sce.markers, ids, by.x=<span>"gene"</span>, by.y=<span>"SYMBOL"</span>)<br>head(data)<br><br>gcSample &lt;- split(data<span>$ENTREZID</span>, data<span>$cluster</span>)<br>gcSample<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>2、富集分析</span><span></span></h3><p data-tool="mdnice编辑器">这里单细胞的多个亚群功能富集使用 <code>clusterProfiler</code> 包的<code>compareCluster</code>函数：</p><pre data-tool="mdnice编辑器"><span></span><code><span>## 富集分析 </span><br><span># KEGG</span><br><span># xx_kegg &lt;- compareCluster(gcSample, fun="enrichKEGG", organism="hsa", pvalueCutoff=1, qvalueCutoff=1)</span><br><span># GO</span><br>xx_go &lt;- compareCluster(gcSample, fun=<span>"enrichGO"</span>, OrgDb=<span>"org.Hs.eg.db"</span>, ont=<span>"BP"</span>, pvalueCutoff=1, qvalueCutoff=1)<br>res &lt;- xx_go@compareClusterResult<br>head(res)<br><br><span>## 将富集结果中的 ENTREZID 重新转为 SYMBOL</span><br><span>for</span> (i <span>in</span> 1:dim(res)[1]) {<br>  arr = unlist(strsplit(as.character(res[i,<span>"geneID"</span>]), split=<span>"/"</span>))<br>  gene_names = paste(unique(names(Symbol[Symbol %<span>in</span>% arr])), collapse=<span>"/"</span>)<br>  res[i,<span>"geneID"</span>] = gene_names<br>}<br>head(res)<br><br><span>## 通路筛选Top5</span><br>enrich &lt;- res %&gt;% <br>  group_by(Cluster) %&gt;% <br>  top_n(n = 5, wt = -pvalue) <br><br>dt &lt;- enrich<br>dt &lt;- dt[order(dt<span>$pvalue</span>,dt<span>$Cluster</span>, decreasing = F), ]<br>dt<span>$Description</span> &lt;- factor(dt<span>$Description</span>, levels = unique(dt<span>$Description</span>))<br>colnames(dt)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>3、绘图</span><span></span></h3><p data-tool="mdnice编辑器">用到的包为<code>ggforce</code>。<code>geom_link()</code>这是<code>ggplot2</code>中用于绘制线段的函数。</p><ul data-tool="mdnice编辑器"><li><section><code>x = 0</code>：设置线段起点的x坐标为0。</section></li><li><section><code>y = Description</code>：设置线段起点的y坐标为数据框中的<code>Description</code>列的值。</section></li><li><section><code>xend = -log10(pvalue)</code>：设置线段终点的x坐标为<code>pvalue</code>列值的负对数（以10为底）。</section></li><li><section><code>yend = Description</code>：设置线段终点的y坐标与起点相同，即<code>Description</code>列的值。</section></li><li><section><code>alpha = after_stat(index)</code>：设置线段的透明度，<code>after_stat(index)</code>表示在计算统计量后使用<code>index</code>值来确定透明度。</section></li><li><section><code>color = Cluster</code>：根据<code>Cluster</code>列的值来设置线段的颜色。</section></li><li><section><code>size = after_stat(index)</code>：根据<code>index</code>值来设置线段的大小。</section></li><li><section><code>n = 500</code>：设置线段的平滑度，<code>n</code>参数指定了在绘制线段时使用的点的数量，较大的值会使线段更平滑。</section></li><li><section><code>index</code> 是 <code>stat</code> 函数计算后生成的一个内部变量，通常用于表示数据点在统计变换后的位置或顺序，值的范围为0-1。</section></li><li><section><code>after_stat(index)</code>：根据密度估计的值调整线段的透明度或大小，从而在图中突出显示密度较高的区域。</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>## 绘图</span><br>library(ggforce)<br>head(dt)<br>table(dt<span>$Cluster</span>)<br><br>colors &lt;- c(<br>  <span>"Macrophages"</span> = <span>"#B0C4DE"</span>,<br>  <span>"Mast cells"</span> = <span>"#FF69B4"</span>, <br>  <span>"Endothelial cells"</span> = <span>"#FFB6C1"</span>, <br>  <span>"ILC1/NK cells"</span> = <span>"#FFFFE0"</span>, <br>  <span>"B cells"</span> = <span>"#ADD8E6"</span>,  <br>  <span>"T cells"</span> = <span>"#90EE90"</span>,   <br>  <span>"Fibroblasts"</span> = <span>"#FFA07A"</span>,  <br>  <span>"Smooth muscle cells"</span> = <span>"#D3D3D3"</span>,<br>  <span>"Epithelial cells"</span> = <span>"#D8BFD8"</span>,   <br>  <span>"Cycling macrophages"</span> = <span>"#E6E6FA"</span>, <br>  <span>"Lymphatic endothelial cells"</span> = <span>"#FFD700"</span> <br>)<br><br>p &lt;- ggplot(dt) +<br>  geom_link(aes(x = 0, y = Description,<br>               xend = -log10(pvalue), yend = Description,<br>               alpha = after_stat(index),<br>               color = Cluster,<br>               size = after_stat(index)), <br>            n = 500, show.legend = T) <br>p<br><br>p1 &lt;- p +<br>  geom_point(aes(x = -log10(pvalue),y = Description), color = <span>"black"</span>, fill = <span>"white"</span>,size = 6,shape = 21) +<br>  geom_text(aes(x = -log10(pvalue), y = Description), label=dt<span>$Count</span>, size=3, nudge_x=0.05) + <br>  theme_classic() +<br>  theme(panel.grid = element_blank(),<br>        strip.text = element_text(face = <span>"bold.italic"</span>),<br>        <span>#axis.text = element_text(color = "black"),</span><br>        axis.line = element_line(color = <span>"black"</span>, size = 0.6), <span># 加粗x轴和y轴的线条</span><br>        axis.text = element_text(face = <span>"bold"</span>), <span># 加粗x轴和y轴的标签</span><br>        axis.title = element_text( size = 13)    <span># 加粗x轴和y轴的标题</span><br>        ) +<br>  xlab(<span>"-Log10 Pvalue"</span>) + ylab(<span>""</span>) + <br>  scale_color_manual(values = colors)<br>p1<br>ggsave(filename = <span>"Enrich_cometplot.pdf"</span>, width = 15, height = 8, plot = p1)<br></code></pre><p data-tool="mdnice编辑器">结果如下：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100054315" data-ratio="0.5305555555555556" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIP9nibXvMqIs7XWfKHNHPy1W9DeICyJQaSUPZHB5N36lHAIJ91d9FtnDA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIP9nibXvMqIs7XWfKHNHPy1W9DeICyJQaSUPZHB5N36lHAIJ91d9FtnDA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">但是这里感觉像张俊那个做分面会更好看，来看下：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 加分面</span><br>p2 &lt;- p1 + <br>  facet_wrap(~Cluster,scales = <span>"free"</span>,ncol = 2) <br>p2<br><br>ggsave(filename = <span>"Enrich_cometplot_facet.pdf"</span>, width = 16, height = 10, plot = p2)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100054321" data-ratio="0.6305555555555555" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPqGN36YQZ3pZD4Eu6tOJpMAoXP1J5kKYnke1d2D1LO6sBSFzfwWKQDg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxPrpBYPL5jdFiaA9czJ5vIPqGN36YQZ3pZD4Eu6tOJpMAoXP1J5kKYnke1d2D1LO6sBSFzfwWKQDg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">Perfect！又学了一种新图！如果你需要这里面处理后的数据，可以留言或者：Biotree123。</p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>友情宣传</span><span></span></h3><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527230&amp;idx=1&amp;sn=7156afcd5ab734c7d391b9048695747a&amp;scene=21#wechat_redirect" data-linktype="2">生信入门&amp;数据挖掘线上直播课2025年1月班</a></p><p data-tool="mdnice编辑器"><a href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247524148&amp;idx=1&amp;sn=7806da6feb41a36493c519c1cfc1d3ac&amp;chksm=9b4bdf8fac3c569960369602f1ef26639cb366b250f233b2297d1f059471c0458335bfc0b829&amp;scene=21#wechat_redirect" data-linktype="2">时隔5年，我们的生信技能树VIP学徒继续招生啦</a></p><p data-tool="mdnice编辑器"><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247535760&amp;idx=2&amp;sn=1e02a2e982a046ecf6389231e6768d5b&amp;scene=21#wechat_redirect" data-linktype="2">满足你生信分析计算需求的低价解决方案</a></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/8A6NV2M56FF3y2mLMAA3Gw",target="_blank" rel="noopener noreferrer">原文链接</a>
