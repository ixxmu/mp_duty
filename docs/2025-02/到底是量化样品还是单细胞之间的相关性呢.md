---
title: "到底是量化样品还是单细胞之间的相关性呢"
date: 2025-02-18T03:50:56Z
draft: ["false"]
tags: [
  "fetched",
  "珠海健明生物医药科技"
]
categories: ["Acdemic"]
---
到底是量化样品还是单细胞之间的相关性呢 by 珠海健明生物医药科技
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>前面一直介绍的胃癌单细胞数据集GSE163558，是10个样品的10x技术的单细胞转录组，可以分成6组，并不适合做相关性探索。首先是组别太多了，其次每个组就单个或者两三个样品。</p></blockquote><p data-tool="mdnice编辑器">这个是时候我们可以拿2022的这个胃癌单细胞文献做案例，标题是：《Parallel single-cell and bulk transcriptome analyses reveal key features of the gastric tumor microenvironment》，它的实验设计是 48 samples from tumors and matched normal tissue of 24 treatment-naïve patients were sequenced using 10X single-cell RNA-seq platform and then analyzed.</p><p data-tool="mdnice编辑器">也就是说，这个GSE206785也是胃癌单细胞数据集，但是就两个分组，每个组是24个样品，首先同样的同时量化不同样品的不同单细胞亚群的相关性，如下所示的代码：</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1726017245869" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>)<br><br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><span>library</span>(clustree)<br><span>library</span>(cowplot)<br><span>library</span>(dplyr)<br><span>library</span>(stringr)<br><span>library</span>(ggsci) <br><span>library</span>(patchwork) <br><span>library</span>(ggsci)<br><span>library</span>(ggpubr)<br><span>library</span>(RColorBrewer) <br>sce.all = readRDS(<span>'./2-harmony/sce.all_int.rds'</span>)<br>sp=<span>'human'</span> <br>load(<span>'./phe.Rdata'</span>) <br>identical(rownames(phe) , colnames(sce.all))<br>sce.all@meta.data = phe<br>sel.clust = <span>"celltype"</span><br>sce.all &lt;- SetIdent(sce.all, value = sel.clust)<br>table(sce.all@active.ident) <br>DimPlot(sce.all)  <br><span># v4 是 AverageExpression</span><br>av &lt;-AggregateExpression(sce.all ,<br>                         group.by = c(<span>"orig.ident"</span>,<span>"celltype"</span>),<br>                         assays = <span>"RNA"</span>) <br>av=as.data.frame(av[[<span>1</span>]])<br>head(av) <span># 可以看到是整数矩阵</span><br><span>#write.csv(av,file = 'AverageExpression-0.8.csv')</span><br>cg=names(tail(sort(apply(log(av+<span>1</span>), <span>1</span>, sd)),<span>1000</span>)) <br>df =cor(as.matrix(log(av[cg,]+<span>1</span>)))<br>ac=as.data.frame(str_split(colnames(df),<span>'_'</span>,simplify = <span>T</span>))<br>rownames(ac)=colnames(df)<br>ac$group = ifelse(grepl(<span>'N'</span>,ac$V1),<span>'normal'</span>,<span>'tumor'</span>)<br>pheatmap::pheatmap(df ,<br>                   show_colnames = <span>F</span>,show_rownames = <span>F</span>,<br>                   annotation_col = ac,<br>                   filename = <span>'cor_celltype-vs-orig.ident.pdf'</span> ) <br>dev.off()<br>save(av,file = <span>'av_for_pseudobulks.Rdata'</span>)<br></code></pre><p data-tool="mdnice编辑器">可以看到不同单细胞亚群之间的这个差异仍然是最大的，其次是各个亚群里面的样品差异或者分组差异，如下所示：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100049843" data-ratio="1.0361111111111112" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyt0ib2dmzuhyr9tJhzdRCx5VGqlvoevfVP3lj5ibJt9eIzFHnuo55W2B0XgcnkfnAEeR4mfKFSJENQ/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/cZNhZQ6j4wyt0ib2dmzuhyr9tJhzdRCx5VGqlvoevfVP3lj5ibJt9eIzFHnuo55W2B0XgcnkfnAEeR4mfKFSJENQ/640?wx_fmt=jpeg&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>如果我们仅仅是看样品直接的相关性</span><span></span></h3><p data-tool="mdnice编辑器">代码就会简单很多：</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1726017245870" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>av &lt;-AggregateExpression(sce.all ,<br>                         group.by = c(<span>"orig.ident"</span> ),<br>                         assays = <span>"RNA"</span>) <br>av=as.data.frame(av[[<span>1</span>]])<br>cg=names(tail(sort(apply(log(av+<span>1</span>), <span>1</span>, sd)),<span>1000</span>)) <br>df =cor(as.matrix(log(av[cg,]+<span>1</span>))) <br>pheatmap::pheatmap(df ,<br>                   show_colnames = <span>F</span>,show_rownames = <span>T</span>,<br>                   filename = <span>'cor_orig.ident.pdf'</span>,height = <span>9</span>  ) <br>dev.off()<br><br></code></pre><p data-tool="mdnice编辑器">可以看到， 如果我们忽略了不同样品其实是由不同的单细胞亚群组成的， 那么它们这些样品虽然说来源于两个很明显的分组，癌症组织和正常组织，它们其实并不会泾渭分明：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100049842" data-ratio="1.3277777777777777" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyt0ib2dmzuhyr9tJhzdRCx5Ft6icBV5tcNc9zoOWo1e6CCx1vUHmGstAVtflL32t7DfhrhOjWiblctA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyt0ib2dmzuhyr9tJhzdRCx5Ft6icBV5tcNc9zoOWo1e6CCx1vUHmGstAVtflL32t7DfhrhOjWiblctA/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>不妨看看另外一种无监督方法：主成分分析！</span><span></span></h3><p data-tool="mdnice编辑器">层次聚类（Hierarchical Clustering）和主成分分析（PCA）都是无监督学习方法，它们可以用来探索样品之间的关系，而不需要预先定义的类别或标签 ，其中：</p><ol data-tool="mdnice编辑器"><li><section><p><strong>层次聚类（Hierarchical Clustering）</strong>：</p></section></li></ol><ul><li><section>层次聚类是一种聚类算法，通过构建一个多层次的嵌套聚类树来组织数据。</section></li><li><section>它不需要预先指定聚类的数量，而是生成一个聚类树（树状图或dendrogram），可以从中选择不同的切割点来得到不同数量的聚类。</section></li><li><section>层次聚类可以是凝聚的（从单个样本开始，逐步合并聚类）或分裂的（从所有样本作为一个聚类开始，逐步分割）。</section></li></ul><li><section><p><strong>主成分分析（PCA）</strong>：</p></section></li><ul><li><section>PCA是一种降维技术，通过线性变换将数据投影到较低维度的空间，同时尽可能保留原始数据的变异性。</section></li><li><section>它通过找到数据中方差最大的方向（主成分），并将数据投影到这些方向上，从而揭示样品之间的结构关系。</section></li><li><section>PCA通常用于数据可视化和预处理，帮助识别数据中的模式和结构。</section></li></ul><p data-tool="mdnice编辑器">这两种方法在生物信息学、基因表达分析、图像处理等领域有广泛的应用。层次聚类更多地用于探索样品的分类和分组，而PCA则常用于数据的可视化和预处理，以便于进一步分析。在实际应用中，这两种方法可以结合使用，先通过PCA降维以减少计算复杂性，然后使用层次聚类来探索样品之间的关系。</p><p data-tool="mdnice编辑器">我们还是使用上面的表达量矩阵，如下所示的批量；</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1726017245871" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>av &lt;-AggregateExpression(sce.all ,<br>                         group.by = c(<span>"orig.ident"</span>,<span>"celltype"</span>),<br>                         assays = <span>"RNA"</span>) <br>av=as.data.frame(av[[<span>1</span>]])<br>df=log(av +<span>1</span>)<br>ac=as.data.frame(str_split(colnames(df),<span>'_'</span>,simplify = <span>T</span>))<br>rownames(ac)=colnames(df)<br>ac$group = ifelse(grepl(<span>'N'</span>,ac$V1),<span>'normal'</span>,<span>'tumor'</span>)<br>head(ac)<br>celltp = unique(ac$V2);celltp<br><span>library</span>(patchwork) <br><span>library</span>(<span>"FactoMineR"</span>) <br><span>library</span>(<span>"factoextra"</span>)  <br><span>library</span>(ggstatsplot)<br><span>library</span>(pheatmap)<br>pca_list &lt;- lapply(celltp, <span>function</span>(x){<br>  <span># x=celltp[1]</span><br>  x<br>  <span>#～～～主成分分析图p2～～～</span><br>  exp &lt;- df[,rownames(ac[ac$V2==x,])]  <br>  dat.pca &lt;- PCA(as.data.frame(t(exp)) , graph = <span>FALSE</span>)<br>  group_list=ac[ac$V2==x,<span>'group'</span>]<br>  this_title &lt;- paste0(x,<span>'_PCA'</span>)<br>  p2 &lt;- fviz_pca_ind(dat.pca,<br>                     geom.ind = <span>"point"</span>, <span># show points only (nbut not "text")</span><br>                     col.ind = group_list, <span># color by groups</span><br>                     palette = <span>"Dark2"</span>,<br>                     addEllipses = <span>TRUE</span>, <span># Concentration ellipses</span><br>                     legend.title = <span>"Groups"</span>)+<br>    ggtitle(this_title)+<br>    theme_ggstatsplot()+<br>    theme(plot.title = element_text(size=<span>12</span>,hjust = <span>0.5</span>))<br>  <br>  p2<br>})<br>wrap_plots(pca_list, byrow = <span>T</span>, nrow = <span>2</span> )<br>ggsave(<span>'all_pca.pdf'</span>,width = <span>12</span>,height = <span>6</span>)<br>ggsave(<span>'all_pca.png'</span>,dpi = <span>300</span>,width = <span>12</span>,height = <span>6</span>)<br><br><br></code></pre><p data-tool="mdnice编辑器">可以看到如下所示不同单细胞亚群在两个分组的无监督PCA情况 ：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100049844" data-ratio="0.5" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyt0ib2dmzuhyr9tJhzdRCx5ZObboS5tsaVciajJafoRvcZc4GNObTbSOg61A0K8dN9Qxpgswo0GobA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wyt0ib2dmzuhyr9tJhzdRCx5ZObboS5tsaVciajJafoRvcZc4GNObTbSOg61A0K8dN9Qxpgswo0GobA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">值得注意的是，上面的每个单细胞亚群内部的表达量矩阵的pca分析的时候其实是可以进行简单的表达量矩阵过滤的， 比如：</p><pre data-tool="mdnice编辑器"><span data-remoteid="c1726017245872" data-cacheurl="https://files.mdnice.com/user/3441/876cad08-0422-409d-bb5a-08afec5da8ee.svg"></span><code>  cg=names(tail(sort(apply(exp, <span>1</span>, sd)),<span>1000</span>)) <br>  exp=exp[cg,]<br></code></pre><p data-tool="mdnice编辑器">出图就会不一样哦 ，主要是上面的离群点样品没有了 ：</p><p><img data-galleryid="" data-imgfileid="100049948" data-ratio="0.5" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwQ0IsDHpvjycRbBkibD1fkXZ4sZ5B5ogM8DTBhwIHIuo6JfGVJNMcjyCDuibkhfRgf0BTbMvMWcHug/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwQ0IsDHpvjycRbBkibD1fkXZ4sZ5B5ogM8DTBhwIHIuo6JfGVJNMcjyCDuibkhfRgf0BTbMvMWcHug/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">可以看到，总体来说，成纤维细胞，平滑肌细胞，还有内皮细胞，这样的肿瘤基质细胞确实是在肿瘤组织和正常组织非常的不一样。<strong>这个背后有什么生物学解释吗？（感兴趣的小伙伴可以发邮件给我讨论这个现象哈）</strong></p><h2 cid="n3795" mdtype="heading"><span md-inline="plain">（</span><span md-inline="url" spellcheck="false">jmzeng1314@163.com</span><span md-inline="plain">)  我会在我们的视频号给大家直播答疑：</span></h2><section><br></section><section><mp-common-videosnap data-pluginname="mpvideosnap" data-url="https://findermp.video.qq.com/251/20304/stodownload?encfilekey=rjD5jyTuFrIpZ2ibE8T7Ym3K77SEULgkiaIlDFtc1ic9yxmibM4r90w5uVAIMpXQDpQRYPicz4PDktJQzu8F9nkHx8dsj8A52P3iaoXEoSFAqcFrJsULT1rwFZDw&amp;token=2lt8WBSnjTmEYrNic5Agj9XOl3cVktQcOaKNotJ9lpqSibCicSqYoyWiaDA5yRqsDIBV1yNPR7GjvXiaqwXJSuWicyf4jCkHRnKiaUYy6DTWGwzyHibeROvupuzZwTDWsOv6EWFqc9XGfDA2GdTichQe1CPRa5RpZYdRTLastGScAVkpMNEE&amp;idx=1&amp;dotrans=0&amp;hy=SZ&amp;m=&amp;scene=2&amp;uzid=2" data-headimgurl="http://wx.qlogo.cn/finderhead/PiajxSqBRaEI7scvWIPdECSfnUpSjTib9Y7RI14r1VVzxaA57PjcCERw/0" data-username="v2_060000231003b20faec8c7e1881bcad2ca06ec35b07788412aec898c89eb1e34f9a354475e8c@finder" data-nickname="生信技能树" data-desc="差异分析-P值?变化倍数?哪个更重要" data-nonceid="10330301935950362245" data-type="video" data-mediatype="undefined" data-authiconurl="https://dldir1v6.qq.com/weixin/checkresupdate/auth_icon_level1_ba9f2ea346de48a3ae0428273fc48117.png" data-from="new" data-width="1920" data-height="1080" data-id="export/UzFfAgtgekIEAQAAAAAAYRIZFj5U1gAAAAstQy6ubaLX4KHWvLEZgBPE_5Nge11aXbuLzNPgMIt3uae7w0Z0zfAuCn03j9U0" data-isdisabled="0" data-errortips=""></mp-common-videosnap></section><p data-tool="mdnice编辑器"><br></p><p data-tool="mdnice编辑器">反正蛮有意思的，肿瘤微环境里面的3大亚群，就是上皮细胞和免疫细胞，以及间质细胞。绝大部分文章都是抓住免疫细胞亚群进行细分，包括淋巴系（T,B,NK细胞）和髓系（单核，树突，巨噬，粒细胞）的两大类作为第二次细分亚群。但是也有不少文章是抓住stromal 里面的 fibro 和endo进行细分，并且编造生物学故事的。</p></section><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>写在文末</span></h3></section><p>如果你也想做单细胞转录组数据分析，<span>最好是有自己的计算机资源哦，比如我们的</span><a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a><span>，而且还需要有基本的生物信息学基础，也可以看看我们的</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247531929&amp;idx=1&amp;sn=f6f16b7bf6b907360d6d0052e3d10cf6&amp;chksm=9b4b3d22ac3cb434b6aa7753a4cf0f266578147ccf10b49cc834e46af578ee6de99be0accb30&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉‍松授课（买一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a><span> ，你的生物信息学入门课。 </span></p><p><br></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/6EK0QC5z5-1cGOge-mK03A",target="_blank" rel="noopener noreferrer">原文链接</a>
