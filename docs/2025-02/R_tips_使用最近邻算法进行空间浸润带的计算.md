---
title: "R tips：使用最近邻算法进行空间浸润带的计算"
date: 2025-02-15T14:30:41Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
R tips：使用最近邻算法进行空间浸润带的计算 by 生信菜鸟团
------
<div><p>本文使用最近邻算法进行浸润带的计算。</p><p>空间组学中，有的时候需要对免疫浸润带进行特定距离的划分，形成一层一层的浸润区域。</p><p>以10X的官方xenium示例数据为例https://www.10xgenomics.com/datasets/ffpe-human-breast-with-pre-designed-panel-1-standard。</p><h3>圈选ROI并计算浸润边界</h3><p>下载的数据使用Xenium explorer打开，然后找到需要进行计算浸润带的位置，并根据方向将相应的全部选中。</p><p>如下图所示，假设中间的位置是需要进行浸润带计算的位置，而需要计算浸润带的方向是向下，则在Xenium explorer中选择套索工具仔细的圈画浸润边界，并将浸润带计算方向上的所有细胞选中。</p><p>然后在Xenium explorer中将图示的ROI区域的边界坐标下载下来。</p><p><img data-imgfileid="100048059" data-ratio="0.5314814814814814" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9CWhiczia4Cevh640XdIHhvBiaclKF70dQKbzZOAujtV1yU5pgWaGDpcjia8TyawKujy3iaBeXWog16mw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9CWhiczia4Cevh640XdIHhvBiaclKF70dQKbzZOAujtV1yU5pgWaGDpcjia8TyawKujy3iaBeXWog16mw/640?wx_fmt=png&amp;from=appmsg"></p><p>由于Xenium explorer无法圈画单条线，至少也是一个闭合区域，因此需要先计算好浸润边界的位置：</p><pre><ol><li><p><span><span><code><span>library</span><span>(</span><span>tidyverse</span><span>)</span></code></span></span></p></li><li><p><span><span><code><span>library</span><span>(</span><span>sp</span><span>)</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span># 读取ROI的边界坐标及细胞的质心坐标</span></code></span></span></p></li><li><p><span><span><code><span>tumor_boundary </span><span>&lt;-</span><span> read_csv</span><span>(</span><span>"data/coordinates.csv"</span><span>,</span><span> skip </span><span>=</span><span> </span><span>2</span><span>)</span></code></span></span></p></li><li><p><span><span><code><span>cells_position </span><span>&lt;-</span><span> arrow</span><span>::</span><span>read_parquet</span><span>(</span><span>"Xenium_V1_FFPE_Human_Breast_IDC/cells.parquet"</span><span>)</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span># 然后根据ROI边界坐标，将细胞分配到ROI中</span></code></span></span></p></li><li><p><span><span><code><span>cell_idx </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>  sp</span><span>::</span><span>point</span><span>.</span><span>in</span><span>.</span><span>polygon</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    cells_position$x_centroid</span><span>,</span><span> </span><span># point</span></code></span></span></p></li><li><p><span><span><code><span>    cells_position$y_centroid</span><span>,</span><span> </span><span># point</span></code></span></span></p></li><li><p><span><span><code><span>    tumor_boundary$X</span><span>,</span><span> </span><span># polygon</span></code></span></span></p></li><li><p><span><span><code><span>    tumor_boundary$Y</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>as</span><span>.</span><span>logical  </span><span># only 0 is FALSE, all others is TRUE</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span># 于是tumor_area_1即是ROI中的细胞，图示中的所有细胞</span></code></span></span></p></li><li><p><span><span><code><span># tumor_area_2是剩余细胞，也就是图示中的上方未被框选中的细胞</span></code></span></span></p></li><li><p><span><span><code><span>tumor_area_1 </span><span>&lt;-</span><span> cells_position</span><span>[</span><span>cell_idx</span><span>,</span><span> </span><span>]</span><span>  </span><span>%&gt;%</span><span> mutate</span><span>(</span><span>x </span><span>=</span><span> x_centroid</span><span>,</span><span> y </span><span>=</span><span> y_centroid </span><span>)</span></code></span></span></p></li><li><p><span><span><code><span>tumor_area_2 </span><span>&lt;-</span><span> cells_position</span><span>[!</span><span>cell_idx</span><span>,</span><span> </span><span>]</span><span> </span><span>%&gt;%</span><span> mutate</span><span>(</span><span>x </span><span>=</span><span> x_centroid</span><span>,</span><span> y </span><span>=</span><span> y_centroid </span><span>)</span></code></span></span></p></li></ol></pre><p>获得了浸润边界的两组细胞之后，就可以进行浸润边界的计算：</p><pre><ol><li><p><span><span><code><span># 根据tumor_area_1和tumor_area_2找到绘制的tumor boundary</span></code></span></span></p></li><li><p><span><span><code><span># 寻找1和2中的最近邻点，以20um（大概一个细胞，根据效果调整）为限度，</span></code></span></span></p></li><li><p><span><span><code><span># 如果没有nn点则不是边界点。</span></code></span></span></p></li><li><p><span><span><code><span># 找到1和2中的边界点，取均值即是最终的边界点</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span># dat: tumor_area_1</span></code></span></span></p></li><li><p><span><span><code><span># query: tumor_area_2</span></code></span></span></p></li><li><p><span><span><code><span>nn_left_right </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>  RANN</span><span>::</span><span>nn2</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    tumor_area_1</span><span>[</span><span>2</span><span>:</span><span>3</span><span>],</span></code></span></span></p></li><li><p><span><span><code><span>    tumor_area_2</span><span>[</span><span>2</span><span>:</span><span>3</span><span>],</span></code></span></span></p></li><li><p><span><span><code><span>    k </span><span>=</span><span> </span><span>10</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    searchtype </span><span>=</span><span> </span><span>'radius'</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    radius </span><span>=</span><span> </span><span>20</span><span> </span><span># 若边界未能找到，则调整radius的值</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>non_boundary_idx </span><span>&lt;-</span><span> apply</span><span>(</span><span>nn_left_right$nn</span><span>.</span><span>idx </span><span>==</span><span> </span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> all</span><span>)</span></code></span></span></p></li><li><p><span><span><code><span>if</span><span>(</span><span>sum</span><span>(</span><span>non_boundary_idx</span><span>)</span><span> </span><span>==</span><span> nrow</span><span>(</span><span>tumor_area_2</span><span>)){</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>print</span><span>(</span><span>"radius is small, no boundary point."</span><span>)</span></code></span></span></p></li><li><p><span><span><code><span>}</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>boundary_idx_1   </span><span>&lt;-</span><span> nn_left_right$nn</span><span>.</span><span>idx</span><span>[!</span><span> non_boundary_idx</span><span>,</span><span> </span><span>1</span><span>]</span></code></span></span></p></li><li><p><span><span><code><span>boundary_1       </span><span>&lt;-</span><span> tumor_area_1</span><span>[</span><span>boundary_idx_1</span><span>,</span><span> </span><span>]</span></code></span></span></p></li><li><p><span><span><code><span>boundary_idx_2   </span><span>&lt;-</span><span> </span><span>!</span><span> non_boundary_idx</span></code></span></span></p></li><li><p><span><span><code><span>boundary_2       </span><span>&lt;-</span><span> tumor_area_2</span><span>[</span><span>boundary_idx_2</span><span>,</span><span> </span><span>]</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span># comuted boudary coords</span></code></span></span></p></li><li><p><span><span><code><span>boundary_coords_df </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>  data</span><span>.</span><span>frame</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    x </span><span>=</span><span> </span><span>(</span><span>boundary_1$x_centroid </span><span>+</span><span> boundary_2$x_centroid</span><span>)</span><span> </span><span>/</span><span> </span><span>2</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    y </span><span>=</span><span> </span><span>(</span><span>boundary_1$y_centroid </span><span>+</span><span> boundary_2$y_centroid</span><span>)</span><span> </span><span>/</span><span> </span><span>2</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span></code></span></span></p></li></ol></pre><p>绘图展示，计算的圈画的浸润边界位置：</p><pre><ol><li><p><span><span><code><span># 只展示浸润边界附近区域的细胞</span></code></span></span></p></li><li><p><span><span><code><span>boundary_df_for_plot </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>  boundary_coords_df </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>.[</span><span>chull</span><span>(.),</span><span> </span><span>]</span><span> </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  map</span><span>(</span><span>range</span><span>)</span><span> </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  map</span><span>(~</span><span> </span><span>.</span><span>x </span><span>+</span><span> c</span><span>(-</span><span>500</span><span>,</span><span> </span><span>500</span><span>))</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span># 定义用于筛选细胞的函数</span></code></span></span></p></li><li><p><span><span><code><span>filter_points </span><span>&lt;-</span><span> </span><span>function</span><span>(</span><span>dat</span><span>,</span><span> boundary</span><span>){</span></code></span></span></p></li><li><p><span><span><code><span>  x_idx </span><span>&lt;-</span><span> dat$x_centroid </span><span>&gt;</span><span> boundary$x</span><span>[</span><span>1</span><span>]</span><span> </span><span>&amp;</span><span> dat$x_centroid </span><span>&lt;</span><span> boundary$x</span><span>[</span><span>2</span><span>]</span></code></span></span></p></li><li><p><span><span><code><span>  y_idx </span><span>&lt;-</span><span> dat$y_centroid </span><span>&gt;</span><span> boundary$y</span><span>[</span><span>1</span><span>]</span><span> </span><span>&amp;</span><span> dat$y_centroid </span><span>&lt;</span><span> boundary$y</span><span>[</span><span>2</span><span>]</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>  dat</span><span>[</span><span>x_idx </span><span>&amp;</span><span> y_idx</span><span>,</span><span> </span><span>]</span></code></span></span></p></li><li><p><span><span><code><span>}</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span># 绘图</span></code></span></span></p></li><li><p><span><span><code><span>ggplot</span><span>()</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span># left area</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> tumor_area_1 </span><span>%&gt;%</span><span> dplyr</span><span>::</span><span>slice_sample</span><span>(</span><span>prop </span><span>=</span><span> </span><span>0.1</span><span>)</span><span> </span><span>%&gt;%</span><span> filter_points</span><span>(</span><span>boundary_df_for_plot</span><span>),</span><span> </span><span># 仅绘制10%的点，加快绘制速度</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x_centroid</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y_centroid</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    color </span><span>=</span><span> </span><span>"gray"</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span># right area</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> tumor_area_2 </span><span>%&gt;%</span><span> dplyr</span><span>::</span><span>slice_sample</span><span>(</span><span>prop </span><span>=</span><span> </span><span>0.1</span><span>)</span><span> </span><span>%&gt;%</span><span> filter_points</span><span>(</span><span>boundary_df_for_plot</span><span>),</span><span> </span><span># 仅绘制10%的点，加快绘制速度</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x_centroid</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y_centroid</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    color </span><span>=</span><span> </span><span>"gray50"</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span># comute left_boundary</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> boundary_1</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    color </span><span>=</span><span> </span><span>"red"</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    size </span><span>=</span><span> </span><span>0.1</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span># compute right_boundary</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> boundary_2</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    color </span><span>=</span><span> </span><span>"blue"</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    size </span><span>=</span><span> </span><span>0.1</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span># the final tumor boundary</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> boundary_coords_df</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    color </span><span>=</span><span> </span><span>"green"</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    size </span><span>=</span><span> </span><span>0.1</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  theme_void</span><span>()</span></code></span></span></p></li></ol></pre><p>如下图所示，计算的浸润边界是绿色点，用于计算浸润边界的上下边界配对点是红蓝色点。</p><p><img data-imgfileid="100048060" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9CWhiczia4Cevh640XdIHhvBxQgyrLHhbZjrxTaeyJHJVwoXrKvr98ndZemzoxRibmnbOAHj2icmUPUw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9CWhiczia4Cevh640XdIHhvBxQgyrLHhbZjrxTaeyJHJVwoXrKvr98ndZemzoxRibmnbOAHj2icmUPUw/640?wx_fmt=png&amp;from=appmsg"></p><h3>使用最近邻算法往下寻找浸润区域</h3><p>假设需要以250um为单位，分别找到250um 500um及750um的浸润区域，则可如下操作：</p><p>先定义一个最近邻的工具函数：</p><pre><ol><li><p><span><span><code><span># reduceFindNN find all (k) nn points in a certain radius,</span></code></span></span></p></li><li><p><span><span><code><span># k would be increased when k is not enough for a certain radius</span></code></span></span></p></li><li><p><span><span><code><span>reduceFindNN </span><span>&lt;-</span><span> </span><span>function</span><span>(</span><span>dat</span><span>,</span><span> k </span><span>=</span><span> </span><span>10</span><span>,</span><span> query </span><span>=</span><span> NULL</span><span>,</span><span> searchtype </span><span>=</span><span> </span><span>"radius"</span><span>,</span><span> radius </span><span>=</span><span> </span><span>100</span><span>,</span><span> mpp </span><span>=</span><span> </span><span>1</span><span>,</span><span> max_k </span><span>=</span><span> </span><span>2000</span><span>){</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>if</span><span>(</span><span>is</span><span>.</span><span>null</span><span>(</span><span>query</span><span>)){</span></code></span></span></p></li><li><p><span><span><code><span>    query </span><span>&lt;-</span><span> dat</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>}</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>  stopifnot</span><span>(</span><span>all</span><span>(</span><span>c</span><span>(</span><span>'x'</span><span>,</span><span> </span><span>'y'</span><span>)</span><span> </span><span>%</span><span>in</span><span>%</span><span> colnames</span><span>(</span><span>dat</span><span>)))</span></code></span></span></p></li><li><p><span><span><code><span>  stopifnot</span><span>(</span><span>all</span><span>(</span><span>c</span><span>(</span><span>'x'</span><span>,</span><span> </span><span>'y'</span><span>)</span><span> </span><span>%</span><span>in</span><span>%</span><span> colnames</span><span>(</span><span>query</span><span>)))</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>  dat   </span><span>&lt;-</span><span> dat</span><span>[</span><span>c</span><span>(</span><span>'x'</span><span>,</span><span> </span><span>'y'</span><span>)]</span></code></span></span></p></li><li><p><span><span><code><span>  query </span><span>&lt;-</span><span> query</span><span>[</span><span>c</span><span>(</span><span>'x'</span><span>,</span><span> </span><span>'y'</span><span>)]</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>  nn_dat </span><span>&lt;-</span><span> RANN</span><span>::</span><span>nn2</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    dat</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    query </span><span>=</span><span> query</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    k </span><span>=</span><span> k</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    radius </span><span>=</span><span> radius </span><span>/</span><span> mpp </span><span># radius, um -&gt; pixel</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>  k_enough </span><span>&lt;-</span><span> sum</span><span>(</span><span>apply</span><span>(</span><span>nn_dat$nn</span><span>.</span><span>idx </span><span>==</span><span> </span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> any</span><span>))/</span><span>nrow</span><span>(</span><span>nn_dat$nn</span><span>.</span><span>idx</span><span>)</span></code></span></span></p></li><li><p><span><span><code><span>  cat</span><span>(</span><span>str_glue</span><span>(</span><span>"k is {k} and is enough for {k_enough * 100}% cells.\n\n"</span><span>))</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>  </span><span>while</span><span>(</span><span>k </span><span>&lt;</span><span> max_k </span><span>&amp;&amp;</span><span> k_enough </span><span>&lt;</span><span> </span><span>0.99</span><span>){</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>    </span><span>if</span><span>(</span><span>k </span><span>&lt;</span><span> </span><span>700</span><span>){</span></code></span></span></p></li><li><p><span><span><code><span>      k </span><span>&lt;-</span><span> k </span><span>+</span><span> </span><span>100</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span>}</span><span>else</span><span> </span><span>if</span><span>(</span><span>k </span><span>&lt;</span><span> </span><span>2000</span><span>){</span></code></span></span></p></li><li><p><span><span><code><span>      k </span><span>&lt;-</span><span> k </span><span>+</span><span> </span><span>200</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span>}</span><span>else</span><span> </span><span>if</span><span>(</span><span>k </span><span>&lt;</span><span> </span><span>5000</span><span>){</span></code></span></span></p></li><li><p><span><span><code><span>      k </span><span>&lt;-</span><span> k </span><span>+</span><span> </span><span>500</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span>}</span><span>else</span><span>{</span></code></span></span></p></li><li><p><span><span><code><span>      k </span><span>&lt;-</span><span> k </span><span>+</span><span> </span><span>1000</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span>}</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>    nn_dat </span><span>&lt;-</span><span> RANN</span><span>::</span><span>nn2</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>      dat</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>      query </span><span>=</span><span> query</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>      searchtype </span><span>=</span><span> searchtype</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>      k </span><span>=</span><span> k</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>      radius </span><span>=</span><span> radius </span><span>/</span><span> mpp </span><span># radius, um -&gt; pixel</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span>)</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>    k_enough </span><span>&lt;-</span><span> sum</span><span>(</span><span>apply</span><span>(</span><span>nn_dat$nn</span><span>.</span><span>idx </span><span>==</span><span> </span><span>0</span><span>,</span><span> </span><span>1</span><span>,</span><span> any</span><span>))/</span><span>nrow</span><span>(</span><span>nn_dat$nn</span><span>.</span><span>idx</span><span>)</span></code></span></span></p></li><li><p><span><span><code><span>    cat</span><span>(</span><span>str_glue</span><span>(</span><span>"k is {k} and is enough for {k_enough * 100}% cells.\n\n"</span><span>))</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>  </span><span>}</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>return</span><span>(</span><span>nn_dat</span><span>)</span></code></span></span></p></li><li><p><span><span><code><span>}</span></code></span></span></p></li></ol></pre><p>浸润带的计算：</p><pre><ol><li><p><span><span><code><span>radius_ls </span><span>&lt;-</span><span> c</span><span>(</span><span>250</span><span>,</span><span> </span><span>500</span><span>,</span><span> </span><span>750</span><span>)</span><span> </span><span>%&gt;%</span><span> set_names</span><span>(.,</span><span> </span><span>.)</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>coords_tumor_infiltration_ls </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>  radius_ls </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  map</span><span>(</span><span>function</span><span>(</span><span>radius</span><span>){</span></code></span></span></p></li><li><p><span><span><code><span>    dat_nn </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>      reduceFindNN</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>        dat   </span><span>=</span><span> tumor_area_1</span><span>,</span><span> </span><span># %&gt;% rbind(tumor_boundary_coords) %&gt;% distinct(),</span></code></span></span></p></li><li><p><span><span><code><span>        query </span><span>=</span><span> boundary_coords_df</span><span>,</span><span> </span><span># tumor_boundary_coords,</span></code></span></span></p></li><li><p><span><span><code><span>        radius </span><span>=</span><span> radius</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>        mpp    </span><span>=</span><span> </span><span>1</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>        k      </span><span>=</span><span> </span><span>100</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>        max_k  </span><span>=</span><span> nrow</span><span>(</span><span>tumor_area_1</span><span>)</span><span> </span><span># 2000</span></code></span></span></p></li><li><p><span><span><code><span>      </span><span>)</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>    </span><span># all nn points is infiltration points</span></code></span></span></p></li><li><p><span><span><code><span>    points_idx </span><span>&lt;-</span><span> dat_nn$nn</span><span>.</span><span>idx </span><span>%&gt;%</span><span> c</span><span>()</span><span> </span><span>%&gt;%</span><span> </span><span>.[.</span><span> </span><span>!=</span><span> </span><span>0</span><span>]</span><span> </span><span>%&gt;%</span><span> unique</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>    </span><span># infiltration area</span></code></span></span></p></li><li><p><span><span><code><span>    coords    </span><span>&lt;-</span><span> tumor_area_1</span><span>[</span><span>points_idx</span><span>,</span><span> </span><span>]</span></code></span></span></p></li><li><p><span><span><code><span>    coords</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>})</span></code></span></span></p></li></ol></pre><p>750um浸润带减去500um浸润带就是500-750um浸润带，以此类推：</p><pre><ol><li><p><span><span><code><span># 当前浸润带减去上一层的浸润带</span></code></span></span></p></li><li><p><span><span><code><span>coords_tumor_infiltration_ls2 </span><span>&lt;-</span><span> list</span><span>()</span></code></span></span></p></li><li><p><span><span><code><span>for</span><span>(</span><span>i </span><span>in</span><span> rev</span><span>(</span><span>seq_along</span><span>(</span><span>coords_tumor_infiltration_ls</span><span>))){</span></code></span></span></p></li><li><p><span><span><code><span>  name </span><span>&lt;-</span><span> names</span><span>(</span><span>coords_tumor_infiltration_ls</span><span>)[</span><span>i</span><span>]</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>if</span><span>(</span><span>i </span><span>==</span><span> </span><span>1</span><span>){</span></code></span></span></p></li><li><p><span><span><code><span>    coords_tumor_infiltration_ls2</span><span>[[</span><span>name</span><span>]]</span><span> </span><span>&lt;-</span><span> coords_tumor_infiltration_ls</span><span>[[</span><span>1</span><span>]]</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span>return</span><span>()</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>}</span></code></span></span></p></li><li><p><span><span><code><span>  present_df </span><span>&lt;-</span><span> coords_tumor_infiltration_ls</span><span>[[</span><span>i</span><span>]]</span></code></span></span></p></li><li><p><span><span><code><span>  next_df    </span><span>&lt;-</span><span> coords_tumor_infiltration_ls</span><span>[[</span><span>i</span><span>-</span><span>1</span><span>]]</span></code></span></span></p></li><li><p><span><span><code><span>  coords_tumor_infiltration_ls2</span><span>[[</span><span>name</span><span>]]</span><span> </span><span>&lt;-</span><span> present_df</span><span>[!</span><span>present_df$cell_id </span><span>%</span><span>in</span><span>%</span><span> next_df$cell_id</span><span>,</span><span> </span><span>]</span></code></span></span></p></li><li><p><span><span><code><span>}</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span># 获得浸润带 ----------</span></code></span></span></p></li><li><p><span><span><code><span>coords_tumor_infiltration_df </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>  coords_tumor_infiltration_ls2 </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  enframe</span><span>(</span><span>name </span><span>=</span><span> </span><span>"radius"</span><span>)</span><span> </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  unnest</span><span>(</span><span>value</span><span>)</span></code></span></span></p></li></ol></pre><p>获得浸润区域如下：</p><pre><ol><li><p><span><span><code><span>p_infile_full </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>  cells_position </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  ggplot</span><span>(</span><span>aes</span><span>(</span><span>x </span><span>=</span><span> x_centroid </span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y_centroid</span><span>))</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>()</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> boundary_coords_df</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    color </span><span>=</span><span> </span><span>"red"</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    size </span><span>=</span><span> </span><span>0.5</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> coords_tumor_infiltration_df</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y</span><span>,</span><span> color </span><span>=</span><span> radius</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span># color = "blue",</span></code></span></span></p></li><li><p><span><span><code><span>    alpha </span><span>=</span><span> </span><span>0.5</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    size </span><span>=</span><span> </span><span>0.5</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  theme_void</span><span>()</span></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code></code></span></span></p></li><li><p><span><span><code><span>p_infile_subset </span><span>&lt;-</span></code></span></span></p></li><li><p><span><span><code><span>  cells_position </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  dplyr</span><span>::</span><span>slice_sample</span><span>(</span><span>prop </span><span>=</span><span> </span><span>0.1</span><span>)</span><span> </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  filter_points</span><span>(</span><span>boundary_df_for_plot</span><span>)</span><span> </span><span>%&gt;%</span></code></span></span></p></li><li><p><span><span><code><span>  ggplot</span><span>(</span><span>aes</span><span>(</span><span>x </span><span>=</span><span> x_centroid </span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y_centroid</span><span>))</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>()</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> boundary_coords_df</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    color </span><span>=</span><span> </span><span>"red"</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    size </span><span>=</span><span> </span><span>0.5</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  geom_point</span><span>(</span></code></span></span></p></li><li><p><span><span><code><span>    data </span><span>=</span><span> coords_tumor_infiltration_df</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    aes</span><span>(</span><span>x </span><span>=</span><span> x</span><span>,</span><span> y </span><span>=</span><span> </span><span>-</span><span>y</span><span>,</span><span> color </span><span>=</span><span> radius</span><span>),</span></code></span></span></p></li><li><p><span><span><code><span>    </span><span># color = "blue",</span></code></span></span></p></li><li><p><span><span><code><span>    alpha </span><span>=</span><span> </span><span>0.5</span><span>,</span></code></span></span></p></li><li><p><span><span><code><span>    size </span><span>=</span><span> </span><span>0.5</span></code></span></span></p></li><li><p><span><span><code><span>  </span><span>)</span><span> </span><span>+</span></code></span></span></p></li><li><p><span><span><code><span>  theme_void</span><span>()</span></code></span></span></p></li></ol></pre><p>如下图所示，浸润边界的浸润带展示：</p><p><img data-imgfileid="100048061" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9CWhiczia4Cevh640XdIHhvBmnZFk9lddUakrYthGFGfDkvYQ3WpF175LaKOAznViagbz7F2cHrHnWg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9CWhiczia4Cevh640XdIHhvBmnZFk9lddUakrYthGFGfDkvYQ3WpF175LaKOAznViagbz7F2cHrHnWg/640?wx_fmt=png&amp;from=appmsg"></p><p>全图展示的浸润带：</p><p><img data-imgfileid="100048062" data-ratio="2" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9CWhiczia4Cevh640XdIHhvB3ibc2H9OCz7Bj8CR961ddNJxb6aRAZkdbWKch6NGLCjzqCWP8tfNVkQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/iaRJcrq2Los9CWhiczia4Cevh640XdIHhvB3ibc2H9OCz7Bj8CR961ddNJxb6aRAZkdbWKch6NGLCjzqCWP8tfNVkQ/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/3gj3-Rh_ZpapsV9iO_mSIQ",target="_blank" rel="noopener noreferrer">原文链接</a>
