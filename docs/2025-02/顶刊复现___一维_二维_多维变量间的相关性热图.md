---
title: "顶刊复现 | 一维/二维/多维变量间的相关性热图"
date: 2025-02-20T11:19:26Z
draft: ["false"]
tags: [
  "fetched",
  "MsTt笔记"
]
categories: ["Acdemic"]
---
顶刊复现 | 一维/二维/多维变量间的相关性热图 by MsTt笔记
------
<div><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><section nodeleaf=""><mp-common-profile data-pluginname="mpprofile" data-nickname="MsTt笔记" data-from="1" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKJLwvM2QW48QKCicY8yHrEfwZA1qzJqmnSDuICrXOZEk6YYntc7QSLbdwg12uibFOEziaEVEXhEJQ4vQ/0?wx_fmt=png" data-signature="💕Keep learning 代码分享😹只分享，不答疑，感谢理解" data-id="MzkxNDcwNzY2NQ==" data-is_biz_ban="0"></mp-common-profile></section><section data-mpa-powered-by="yiban.io"><span><span leaf=""><br></span></span></section><section data-mpa-powered-by="yiban.io"><span><span leaf="">请尊重原创劳动成果</span></span></section><p><span><span leaf="">未经允许，不得转载</span></span></p><p data-tool="mdnice编辑器"><span leaf="">今天我们来复现三种相关性热图：</span></p><ul><li><section><span leaf=""><span textstyle="">一维变量</span>的相关性热图（</span><strong><span leaf="">corrplot</span></strong><span leaf="">）</span></section></li><li><section><span leaf=""><span textstyle="">二维变量</span>的相关性热图（</span><strong><span leaf="">pheatmap</span></strong><span leaf="">）</span></section></li><li><section><span leaf=""><span textstyle="">多维变量</span>的相关性热图（</span><strong><span leaf="">linkET</span></strong><span leaf="">）</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">通过这些热图，我们可以直观地分析和理解数据之间的关系和相互影响，从而更好地进行数据分析和决策。</span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现1： 一维变量</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">第 1 篇是 </span><strong><span leaf="">Nature</span></strong><span leaf=""> 文章中 (Borton, M.A., McGivern, B.B., Willi, K.R. et al. A functional microbiome catalogue crowdsourced from North American rivers. Nature 637, 103–112 (2025). https://doi.org/10.1038/s41586-024-08240-z) 的 Fig.3b</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">原图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3cwzoicgCW08KL5njOXcWI2UhvXjiaKfFb2XN7aBHX4fW39kw8SjRDmlw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8509554140127389" data-type="png" data-w="785" data-imgfileid="100000826" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3cwzoicgCW08KL5njOXcWI2UhvXjiaKfFb2XN7aBHX4fW39kw8SjRDmlw/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">这个相关性热图展示了46个变量之间的关系：</span></p><ul><li><section><span leaf="">这些变量分为四个组，用不同的颜色表示。</span></section></li><li><section><span leaf="">每个单元格表示两个变量之间的 Pearson 相关系数，颜色从红色（负相关）到黑色（正相关），颜色的强度表示相关性的强度；空格则表示该相关性在统计上不显著（P &gt; 0.05），只有显著的相关性才被显示。</span></section></li><li><section><span leaf="">这种可视化方法在多变量分析中非常有用，有助于揭示复杂数据集中的关键模式和趋势。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3cm6DXiaiaEnoo7s37xyYbaH3sAbcJ7nKicTXzjoVicNVmubrg4sic8utgqg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9227323628219485" data-type="png" data-w="893" data-imgfileid="100000827" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3cm6DXiaiaEnoo7s37xyYbaH3sAbcJ7nKicTXzjoVicNVmubrg4sic8utgqg/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">使用 <span textstyle="">R corrplot</span> 包复现，由于数据是随机生成的，所以与原图的趋势不同。</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">加载R包，准备数据</span></span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span leaf=""><span># 加载必要的包</span></span></code><code><span leaf=""><span>library(RColorBrewer)</span></span></code><code><span leaf=""><span>library(corrplot)</span></span></code><code><span leaf=""><span>library(ggplot2)</span></span></code><code><span leaf=""><span>library(grid)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 读入文件</span></span></code><code><span leaf=""><span>data </span><span>&lt;-</span><span> read.csv(</span><span>'corrplot/data/data.csv'</span><span>,row.names </span><span>=</span><span> </span><span>1</span><span>, check.names </span><span>=</span><span> F)</span></span></code><code><span leaf=""><span>group</span><span> </span><span>&lt;-</span><span> read.csv("corrplot/data/group.csv", check.names </span><span>=</span><span> </span><span>FALSE</span><span>)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 设置颜色</span></span></code><code><span leaf=""><span># color bar</span></span></code><code><span leaf=""><span>col </span><span>=</span><span> (brewer.pal(n </span><span>=</span><span> </span><span>8</span><span>, name </span><span>=</span><span> "RdGy"))</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 分类及变量的颜色</span></span></code><code><span leaf=""><span>coltext </span><span>&lt;-</span><span> c("#66009b", "#00defc", "#ff9933", "#00089d")</span></span></code><code><span leaf=""><span>group</span><span>$color </span><span>&lt;-</span><span> coltext[factor(</span><span>group</span><span>$Type, levels </span><span>=</span><span> c("Microbial", "Site", "Land use", "Watershed"))]</span></span></code><code><span leaf=""><span>variable_color </span><span>&lt;-</span><span> </span><span>group</span><span>[</span><span>match</span><span>(colnames(data), </span><span>group</span><span>$Variable),]$color</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">读入变量值和分组信息，并设置热图和分组的颜色。</span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">此绘图数据，如需文末可以自助获取。</span></span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">相关性分析</span></span></h2><section><ul><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span leaf=""><span># 计算相关性</span></span></code><code><span leaf=""><span>data_log </span><span>&lt;-</span><span> </span><span>log10</span><span>(data </span><span>+</span><span> </span><span>0.000001</span><span>)</span></span></code><code><span leaf=""><span>cor </span><span>&lt;-</span><span> cor(data_log, use </span><span>=</span><span> </span><span>'pairwise.complete.obs'</span><span>, </span><span>method</span><span> </span><span>=</span><span> </span><span>'pearson'</span><span>)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 相关性检验</span></span></code><code><span leaf=""><span>p.mat </span><span>&lt;-</span><span> cor.mtest(cor, conf.level </span><span>=</span><span> </span><span>.95</span><span>)$p</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">cor()</span></code><span leaf="">函数计算数据的相关性。先将数据转换为对数尺度，有助于减小数据的差异性，更好地展示数据的特征。</span></p><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">cor.mtest()</span></code><span leaf="">函数评估相关矩阵中的每个相关系数是否显著：</span></p><ul><li><section><code><span leaf="">cor.mtest(cor, conf.level = .95)</span></code><span leaf="">：对相关矩阵 cor 进行显著性检验，置信水平为 95%，输出相关系数的 p 值等信息。</span></section></li><li><section><code><span leaf="">$p</span></code><span leaf="">：提取其中的 p 值矩阵。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">绘图</span></span></h2><h4 data-tool="mdnice编辑器"><span></span><span leaf="">1. 相关性热图</span><span></span></h4><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span leaf=""><span>corrplot(cor, </span><span>method</span><span> </span><span>=</span><span> "square", type </span><span>=</span><span> "upper", </span><span>order</span><span> </span><span>=</span><span> "original",</span></span></code><code><span leaf=""><span>         #设置p值样式</span></span></code><code><span leaf=""><span>         p.mat </span><span>=</span><span> p.mat, sig.level </span><span>=</span><span> </span><span>0.01</span><span>, insig </span><span>=</span><span> "blank", </span></span></code><code><span leaf=""><span>         #设置color bar</span></span></code><code><span leaf=""><span>         col </span><span>=</span><span> col, cl.pos </span><span>=</span><span> "b", </span></span></code><code><span leaf=""><span>         #设置文本颜色及字体大小</span></span></code><code><span leaf=""><span>         tl.col </span><span>=</span><span> variable_color, tl.cex </span><span>=</span><span> </span><span>0.7</span><span>, </span></span></code><code><span leaf=""><span>         #设置四周边距，在右侧预留注释信息的空间</span></span></code><code><span leaf=""><span>         mar </span><span>=</span><span> c(</span><span>0</span><span>, </span><span>0</span><span>, </span><span>0</span><span>, </span><span>1</span><span>))</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">corrplot()</span></code><span leaf="">函数绘制相关性热图：</span></p><ul><li><section><code><span leaf="">method = "square"</span></code><span leaf="">: 设置形状为方形。</span></section></li><li><section><code><span leaf="">type = "upper"</span></code><span leaf="">: 绘制矩阵的上三角部分。</span></section></li><li><section><code><span leaf="">order = "original"</span></code><span leaf="">: 设置矩阵的排列顺序。"original" 表示保持原始顺序不变。</span></section></li><li><section><code><span leaf="">p.mat = p.mat</span></code><span leaf="">: 设置先前计算的 p 值矩阵。</span></section></li><li><section><code><span leaf="">sig.level = 0.01</span></code><span leaf="">: 设置显著性水平为 0.01。</span></section></li><li><section><code><span leaf="">insig = "blank"</span></code><span leaf="">: 设置非显著的相关系数为“空白”。即，p 值大于显著性水平时，相关系数的方格将被留空，而不是显示数值或颜色。</span></section></li><li><section><code><span leaf="">tl.col = variable_color</span></code><span leaf="">: 设置变量（轴标签）的文本颜色。</span></section></li></ul><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3PdRUL8R8iaBJCL9XnSKFRRDfdsdAXNCaw9SmvvZNqaaycbX4K19YMpA/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.2466460268317854" data-s="300,640" data-type="png" data-w="969" type="block" data-imgfileid="100000828" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3PdRUL8R8iaBJCL9XnSKFRRDfdsdAXNCaw9SmvvZNqaaycbX4K19YMpA/640?wx_fmt=png&amp;from=appmsg"></section><h4 data-tool="mdnice编辑器"><span></span><span leaf="">2. 注释</span><span></span></h4><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span leaf=""><span>ggplot(</span><span>group</span><span>, aes(x </span><span>=</span><span> </span><span>10</span><span>, y </span><span>=</span><span> seq_along(Variable))) </span><span>+</span></span></code><code><span leaf=""><span>  geom_rect(aes(xmin</span><span>=</span><span>0</span><span>, xmax</span><span>=</span><span>0.4</span><span>, </span></span></code><code><span leaf=""><span>                ymin</span><span>=</span><span>seq_along(Variable)</span><span>-0.5</span><span>, ymax</span><span>=</span><span>seq_along(Variable)</span><span>+</span><span>0.5</span><span>, </span></span></code><code><span leaf=""><span>                fill </span><span>=</span><span> factor(Type, levels </span><span>=</span><span> c("Microbial", "Site", "Land use", "Watershed")), </span></span></code><code><span leaf=""><span>                color </span><span>=</span><span> factor(Type, levels </span><span>=</span><span> c("Microbial", "Site", "Land use", "Watershed")))) </span><span>+</span></span></code><code><span leaf=""><span>  geom_text(aes(x </span><span>=</span><span> </span><span>0.5</span><span>, y </span><span>=</span><span> seq_along(Variable), label </span><span>=</span><span> Variable), </span></span></code><code><span leaf=""><span>            hjust </span><span>=</span><span> </span><span>0</span><span>, size</span><span>=</span><span>2.5</span><span>, color</span><span>=</span><span>"black") </span><span>+</span></span></code><code><span leaf=""><span>  scale_fill_manual(</span><span>values</span><span>=</span><span>coltext) </span><span>+</span></span></code><code><span leaf=""><span>  scale_color_manual(</span><span>values</span><span>=</span><span>coltext) </span><span>+</span></span></code><code><span leaf=""><span>  annotate(geom</span><span>=</span><span>'text'</span><span>, x </span><span>=</span><span> </span><span>0.2</span><span>, y </span><span>=</span><span> </span><span>5</span><span>, label </span><span>=</span><span> "Microbial", size</span><span>=</span><span>2.5</span><span>, color</span><span>=</span><span>"white", angle </span><span>=</span><span> </span><span>90</span><span>) </span><span>+</span></span></code><code><span leaf=""><span>  annotate(geom</span><span>=</span><span>'text'</span><span>, x </span><span>=</span><span> </span><span>0.2</span><span>, y </span><span>=</span><span> </span><span>14</span><span>, label </span><span>=</span><span> "Site", size</span><span>=</span><span>2.5</span><span>, color</span><span>=</span><span>"black", angle </span><span>=</span><span> </span><span>90</span><span>) </span><span>+</span></span></code><code><span leaf=""><span>  annotate(geom</span><span>=</span><span>'text'</span><span>, x </span><span>=</span><span> </span><span>0.2</span><span>, y </span><span>=</span><span> </span><span>26.5</span><span>, label </span><span>=</span><span> "Land use", size</span><span>=</span><span>2.5</span><span>, color</span><span>=</span><span>"black", angle </span><span>=</span><span> </span><span>90</span><span>) </span><span>+</span></span></code><code><span leaf=""><span>  annotate(geom</span><span>=</span><span>'text'</span><span>, x </span><span>=</span><span> </span><span>0.2</span><span>, y </span><span>=</span><span> </span><span>38</span><span>, label </span><span>=</span><span> "Watershed", size</span><span>=</span><span>2.5</span><span>, color</span><span>=</span><span>"white", angle </span><span>=</span><span> </span><span>90</span><span>) </span><span>+</span></span></code><code><span leaf=""><span>  xlab(</span><span>NULL</span><span>) </span><span>+</span><span> ylab(</span><span>NULL</span><span>) </span><span>+</span><span> </span></span></code><code><span leaf=""><span>  scale_y_reverse() </span><span>+</span></span></code><code><span leaf=""><span>  theme_void() </span><span>+</span></span></code><code><span leaf=""><span>  theme(legend.position </span><span>=</span><span> "none")</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_rect()</span></code><span leaf="">：绘制矩形</span></p><ul><li><section><code><span leaf="">xmin = 0, xmax = 0.4</span></code><span leaf="">：每个矩形的水平范围，从 0 到 0.4。所有矩形宽度相同。</span></section></li><li><section><code><span leaf="">ymin = seq_along(Variable)-0.5, ymax = seq_along(Variable)+0.5</span></code><span leaf="">：每个矩形的垂直范围。每个矩形的 y 位置对应 Variable 的元素顺序，-0.5 和 +0.5 是用来创建每个矩形的上下边界，使得每个矩形垂直方向上有一定的高度（1单位的高度）。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">geom_text()</span></code><span leaf="">：添加文本标签</span></p><ul><li><section><code><span leaf="">x = 0.5</span></code><span leaf="">：文本位于矩形的中间（水平居中）。</span></section></li><li><section><code><span leaf="">y = seq_along(Variable)</span></code><span leaf="">：文本位置。</span></section></li><li><section><code><span leaf="">hjust = 0</span></code><span leaf="">：文本对齐方式，0 表示左对齐。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">annotate()</span></code><span leaf="">：添加垂直文本标签</span></p><ul><li><section><code><span leaf="">x</span></code><span leaf="">和</span><code><span leaf="">y</span></code><span leaf="">控制文本的位置。</span></section></li></ul><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3gt2IibJrEu3vJYiaj4Lic5DGQMVP0NIDAWic5qooGARzoicqtzFnFJiaKTrg/640?wx_fmt=png&amp;from=appmsg" data-ratio="2.4069478908188584" data-s="300,640" data-type="png" data-w="403" type="block" data-imgfileid="100000829" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3gt2IibJrEu3vJYiaj4Lic5DGQMVP0NIDAWic5qooGARzoicqtzFnFJiaKTrg/640?wx_fmt=png&amp;from=appmsg"></section><h4 data-tool="mdnice编辑器"><span></span><span leaf="">3.合并图片</span><span></span></h4><section><ul><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span>pdf(</span><span>"corrplot/corrplot.correlation_heatmap.pdf"</span><span>, width = 10, height = 8)</span></span></code><code><span leaf=""><span>p1</span></span></code><code><span leaf=""><span>vie1 &lt;- viewport(width=0.38, height=0.585, x=0.9, y=0.36)</span></span></code><code><span leaf=""><span>print</span><span>(p2, vp=vie1)</span></span></code><code><span leaf=""><span>dev.off()</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">grid::viewport()</span></code><span leaf="">函数来精确控制组合图形的位置和大小。</span></p><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3cm6DXiaiaEnoo7s37xyYbaH3sAbcJ7nKicTXzjoVicNVmubrg4sic8utgqg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.9227323628219485" data-type="png" data-w="893" data-imgfileid="100000830" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3cm6DXiaiaEnoo7s37xyYbaH3sAbcJ7nKicTXzjoVicNVmubrg4sic8utgqg/640?wx_fmt=png&amp;from=appmsg"></span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现2：二维变量</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">第 2 篇是 </span><strong><span leaf="">Nature Genetics</span></strong><span leaf=""> 文章中 (Franzén, L., Olsson Lindvall, M., Hühn, M. et al. Mapping spatially resolved transcriptomes in human and mouse pulmonary fibrosis. Nat Genet 56, 1725–1736 (2024). https://doi.org/10.1038/s41588-024-01819-2) 的 Fig.1f</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">原图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3NB0KDKtXLnicR2fOX2kAqaiaDKKG1bdHOGY6dCS6oEN7oT9jW94n7CyA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.851764705882353" data-type="png" data-w="850" data-imgfileid="100000831" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3NB0KDKtXLnicR2fOX2kAqaiaDKKG1bdHOGY6dCS6oEN7oT9jW94n7CyA/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">这个相关性热图展示了 NMF 因子与细胞类型之间的关系：</span></p><ul><li><section><span leaf="">热图顶部的列表示 NMF 因子，左侧的行表示不同的细胞类型，这些细胞类型被分为五个组。</span></section></li><li><section><span leaf="">热图中的颜色表示 Pearson 相关系数，颜色从绿色（负相关）到紫色（正相关），颜色的强度表示相关性的强度，白色表示没有显著相关性。</span></section></li><li><section><span leaf="">热图顶部和左侧的树状图显示了 NMF 因子和细胞类型的层次聚类结果，帮助识别相似的因子和细胞类型。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3zlIPqF2AYvWGjBWclP44HXKy9m3ViaEZCwpsGCSmDAayVmDqGPryjhQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6429980276134122" data-type="png" data-w="1014" data-imgfileid="100000834" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3zlIPqF2AYvWGjBWclP44HXKy9m3ViaEZCwpsGCSmDAayVmDqGPryjhQ/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">使用 <span textstyle="">R pheatmap</span> 包复现，学习到的技巧:</span></p><p data-tool="mdnice编辑器"><span leaf="">如何创建一个对称的颜色刻度？先根据数据的范围创建一个数值向量，用这些向量来定义热图的颜色区间，再使用</span><code><span leaf="">breaks</span></code><span leaf="">参数来创建颜色刻度。</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">加载R包，准备数据</span></span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span leaf=""><span># 加载必要的包</span></span></code><code><span leaf=""><span>library(pheatmap)</span></span></code><code><span leaf=""><span>library(dplyr)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 读入文件</span></span></code><code><span leaf=""><span># 两个矩阵的相关性系数</span></span></code><code><span leaf=""><span>r_data </span><span>&lt;-</span><span> read.csv(</span><span>'pheatmap/data/cell_factor_corr.csv'</span><span>,row.names </span><span>=</span><span> </span><span>1</span><span>, check.names </span><span>=</span><span> F)</span></span></code><code><span leaf=""><span># 分组信息，用于热图的分类注释</span></span></code><code><span leaf=""><span>group_row </span><span>&lt;-</span><span> read.csv(</span><span>'pheatmap/data/group_row.csv'</span><span>,row.names </span><span>=</span><span> </span><span>1</span><span>, check.names </span><span>=</span><span> F)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 设置颜色</span></span></code><code><span leaf=""><span>#热图的 color bar</span></span></code><code><span leaf=""><span>col_scale_mako </span><span>&lt;-</span><span> viridis::mako(</span><span>13</span><span>, direction </span><span>=</span><span> </span><span>-1</span><span>)[</span><span>1</span><span>:</span><span>10</span><span>]</span></span></code><code><span leaf=""><span>col_scale_acton </span><span>&lt;-</span><span> scico::scico(</span><span>10</span><span>, direction </span><span>=</span><span> </span><span>-1</span><span>, palette </span><span>=</span><span> "acton")</span></span></code><code><span leaf=""><span>my_color </span><span>&lt;-</span><span> c(rev(col_scale_mako[</span><span>1</span><span>:</span><span>8</span><span>]), "white", col_scale_acton[</span><span>1</span><span>:</span><span>8</span><span>])</span></span></code><code><span leaf=""><span>col_length </span><span>&lt;-</span><span> length(my_color)</span></span></code><code><span leaf=""><span>#根据数据的范围，创建一个对称的颜色刻度</span></span></code><code><span leaf=""><span>abs_max_val </span><span>&lt;-</span><span> </span><span>max</span><span>(r_data, na.rm </span><span>=</span><span> T)</span></span></code><code><span leaf=""><span>ph_breaks </span><span>&lt;-</span><span> c(seq(</span><span>-</span><span>abs_max_val, </span><span>0</span><span>, length.out</span><span>=</span><span>ceiling</span><span>(col_length</span><span>/</span><span>2</span><span>) </span><span>+</span><span> </span><span>1</span><span>),</span></span></code><code><span leaf=""><span>               seq(abs_max_val</span><span>/</span><span>col_length, abs_max_val, length.out</span><span>=</span><span>floor</span><span>(col_length</span><span>/</span><span>2</span><span>)))</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 分组的颜色</span></span></code><code><span leaf=""><span>group_colors </span><span>=</span><span> list(</span></span></code><code><span leaf=""><span>  cell_group </span><span>=</span><span> setNames(c("#b36692", "#fbb03c", "#0070bc", "#faee90", "#a0e0b8"),</span></span></code><code><span leaf=""><span>                        nm </span><span>=</span><span> group_row$cell_group </span><span>%&gt;%</span><span> </span><span>unique</span><span>() </span><span>%&gt;%</span><span> sort()))</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">读入相关性数据和分组信息，并设置热图和分组的颜色。</span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">此绘图数据，如需文末可以自助获取。</span></span></p><p data-tool="mdnice编辑器"><span leaf="">创建对称的 breaks：</span></p><ul><li><section><span leaf="">计算数据矩阵中绝对值的最大值 (abs_max_val)</span></section></li><li><section><span leaf="">使用</span><code><span leaf="">seq()</span></code><span leaf="">函数从 -abs_max_val 到 0 创建一组 breaks。</span></section></li><li><section><span leaf="">使用</span><code><span leaf="">seq()</span></code><span leaf="">函数从 abs_max_val / col_length 到 abs_max_val 创建另一组 breaks。</span></section></li><li><section><span leaf="">合并两组 breaks 以确保颜色刻度对称。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">绘图</span></span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="swift"><code><span leaf=""><span>pheatmap(</span><span>as</span><span>.matrix(r_data),</span></span></code><code><span leaf=""><span>         #设置颜色梯度</span></span></code><code><span leaf=""><span>         color </span><span>=</span><span> my_color,</span></span></code><code><span leaf=""><span>         breaks </span><span>=</span><span> ph_breaks,</span></span></code><code><span leaf=""><span>         #设置格子</span></span></code><code><span leaf=""><span>         cellwidth </span><span>=</span><span> </span><span>10</span><span>,</span></span></code><code><span leaf=""><span>         cellheight </span><span>=</span><span> </span><span>10</span><span>,</span></span></code><code><span leaf=""><span>         #border_color </span><span>=</span><span> </span><span>"grey50"</span><span>,</span></span></code><code><span leaf=""><span>         #设置行</span><span>/列tree个数</span></span></code><code><span leaf=""><span>         cutree_cols = 3,</span></span></code><code><span leaf=""><span>         cutree_rows = 3,</span></span></code><code><span leaf=""><span>         #设置聚类树样式</span></span></code><code><span leaf=""><span>         treeheight_row = 12,</span></span></code><code><span leaf=""><span>         treeheight_col = 10,</span></span></code><code><span leaf=""><span>         #设置行注释</span></span></code><code><span leaf=""><span>         annotation_row = group_row,</span></span></code><code><span leaf=""><span>         annotation_colors = group_colors,</span></span></code><code><span leaf=""><span>         annotation_names_row = F,</span></span></code><code><span leaf=""><span>         #设置行/列的字体</span></span></code><code><span leaf=""><span>         fontsize_row </span><span>=</span><span> </span><span>10</span><span>, </span></span></code><code><span leaf=""><span>         fontsize_col </span><span>=</span><span> </span><span>10</span><span>, </span></span></code><code><span leaf=""><span>         angle_col </span><span>=</span><span> </span><span>90</span><span>,</span></span></code><code><span leaf=""><span>         #设置</span><span>NA格子</span></span></code><code><span leaf=""><span>         na_col </span><span>=</span><span> </span><span>"grey80"</span><span>)</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用</span><code><span leaf="">pheatmap()</span></code><span leaf="">函数来生成一个热图:</span></p><ul><li><section><span leaf="">color = my_color：设置热图的颜色梯度。</span></section></li><li><section><span leaf="">breaks = ph_breaks：定义颜色分段的断点。</span></section></li></ul><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3zlIPqF2AYvWGjBWclP44HXKy9m3ViaEZCwpsGCSmDAayVmDqGPryjhQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6429980276134122" data-type="png" data-w="1014" data-imgfileid="100000833" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3zlIPqF2AYvWGjBWclP44HXKy9m3ViaEZCwpsGCSmDAayVmDqGPryjhQ/640?wx_fmt=png&amp;from=appmsg"></span></p><h3 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现3：多维变量</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">第 3 篇是 </span><strong><span leaf="">Nature communications</span></strong><span leaf=""> 文章中 (Ji, M., Zhou, J., Li, Y. et al. Biodiversity of mudflat intertidal viromes along the Chinese coasts. Nat Commun 15, 8611 (2024). https://doi.org/10.1038/s41467-024-52996-x) 的 Fig.5a</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">原图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3m0a2wBYic5SWT2zpv2987BBNzkXKEbzhicjGylGxPn0ytxsQY7DrSGIw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5982742090124641" data-type="png" data-w="1043" data-imgfileid="100000835" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3m0a2wBYic5SWT2zpv2987BBNzkXKEbzhicjGylGxPn0ytxsQY7DrSGIw/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">这张图展示了环境因素与病毒/微生物群落之间的关系：</span></p><ul><li><section><span leaf=""><span textstyle="">部分 Mantel test</span>：左侧的节点表示不同的群落，节点之间的边表示群落与环境因素之间的 Mantel 相关系数（Mantel's r）和显著性（Mantel's p），边的颜色和宽度表示 Mantel 的 r 和 p 值。</span></section></li><li><section><span leaf=""><span textstyle="">Pearson 相关系数</span>：右侧热图中的颜色表示不同环境因素之间的 Pearson 相关系数，从负相关（-1，红色）到正相关（1，蓝色）。颜色的强度表示相关性的强度，热图中的星号表示相关性的显著性水平。</span></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">复现图</span></span></h2><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3QQ6ic4ZRPrPHSyKw8tsKEc7KeBmY7UuH23JfqSbicv7UAuWXUXpVQO9Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6533466533466533" data-type="png" data-w="1001" data-imgfileid="100000836" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3QQ6ic4ZRPrPHSyKw8tsKEc7KeBmY7UuH23JfqSbicv7UAuWXUXpVQO9Q/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf="">使用<span textstyle=""> </span><span textstyle="">R linkET</span> 包复现。</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">加载R包，准备数据</span></span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="objectivec"><code><span leaf=""><span># 加载必要的包</span></span></code><code><span leaf=""><span>library(linkET)</span></span></code><code><span leaf=""><span>library(ggplot2)</span></span></code><code><span leaf=""><span>library(Hmisc)</span></span></code><code><span leaf=""><span>library(dplyr)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span># 读入文件</span></span></code><code><span leaf=""><span># 环境因子</span></span></code><code><span leaf=""><span>env&lt;-read.csv(</span><span>'mantel_test/data/Environment.CSV'</span><span>,row.names = </span><span>1</span><span>, check.names = F)</span></span></code><code><span leaf=""><span># 各类群落数据</span></span></code><code><span leaf=""><span>host&lt;-t(read.delim(</span><span>'mantel_test/data/host.txt'</span><span>,row.names = </span><span>1</span><span>))</span></span></code><code><span leaf=""><span>mOTUs&lt;-t(read.delim(</span><span>'mantel_test/data/mOTUs.txt'</span><span>,row.names = </span><span>1</span><span>)) </span></span></code><code><span leaf=""><span>virus&lt;-t(read.delim(</span><span>'mantel_test/data/virus.txt'</span><span>,row.names = </span><span>1</span><span>))</span></span></code><code><span leaf=""><span>vOTUs&lt;-t(read.delim(</span><span>'mantel_test/data/vOTUs.txt'</span><span>,row.names = </span><span>1</span><span>))</span></span></code><code><span leaf=""><span># 样本的地理位置(经纬度)</span></span></code><code><span leaf=""><span>geo&lt;-read.csv(</span><span>'mantel_test/data/distance.CSV'</span><span>,row.names = </span><span>1</span><span>)</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">读入环境因子数据、各类群落数据、以及样本的地理位置数据（作为环境控制变量，来消除噪音，使分析更加精细）。</span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">此绘图数据，如需文末可以自助获取。</span></span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">Mantel 测试</span></span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span leaf=""><span>spec &lt;- </span><span>as</span><span>.</span><span>data</span><span>.frame(cbind(host, mOTUs, virus, vOTUs))</span></span></code><code><span leaf=""><span>mantel &lt;- mantel_test(spec, env[</span><span>1</span><span>:</span><span>11</span><span>],</span></span></code><code><span leaf=""><span>                      spec_select = list(</span><span>"host"</span><span> = </span><span>1</span><span>:ncol(host),</span></span></code><code><span leaf=""><span>                                         </span><span>"mOTUs"</span><span> = (ncol(host)+</span><span>1</span><span>):(ncol(host)+ncol(mOTUs)),</span></span></code><code><span leaf=""><span>                                         </span><span>"virus"</span><span> = (ncol(host)+ncol(mOTUs)+</span><span>1</span><span>):(ncol(host)+ncol(mOTUs)+ncol(virus)),</span></span></code><code><span leaf=""><span>                                         </span><span>"vOTUs"</span><span> = (ncol(host)+ncol(mOTUs)+ncol(virus)+</span><span>1</span><span>):(ncol(host)+ncol(mOTUs)+ncol(virus)+ncol(vOTUs))),</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>                      env_ctrl = geo,</span></span></code><code><span leaf=""><span>                      # 使用mantel.partial计算相关性，这种方法允许在计算相关性时控制其他变量的影响</span></span></code><code><span leaf=""><span>                      mantel_fun = </span><span>"mantel.partial"</span><span>,</span></span></code><code><span leaf=""><span>                      permutations = </span><span>999</span><span>) %&gt;% </span></span></code><code><span leaf=""><span>  # 对分析结果中r和p的值, 设定一个分类区间</span></span></code><code><span leaf=""><span>  mutate(r_value = cut(r, breaks = c(-Inf, </span><span>0.1</span><span>, </span><span>0.2</span><span>, Inf),</span></span></code><code><span leaf=""><span>                  labels = c(</span><span>"&lt; 0.1"</span><span>, </span><span>"0.1 - 0.2"</span><span>, </span><span>"&gt;= 0.2"</span><span>)),</span></span></code><code><span leaf=""><span>         p_value = cut(p, breaks = c(-Inf, </span><span>0.001</span><span>, </span><span>0.05</span><span>, Inf),</span></span></code><code><span leaf=""><span>                  labels = c(</span><span>"&lt; 0.001"</span><span>, </span><span>"0.001 - 0.05"</span><span>, </span><span>"&gt;= 0.05"</span><span>)))</span></span></code></pre></section><p data-tool="mdnice编辑器"><span leaf="">使用部分 Mantel 测试（mantel.partial）来计算物种数据和环境数据之间的相关性，并根据 r 值和 p 值的大小，将结果分成不同的区间进行分类。</span></p><h2 data-tool="mdnice编辑器"><span></span><span><span leaf="">绘图</span></span></h2><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span leaf=""><span># 环境因子中有缺失值，需要转成</span><span>numeric</span><span>类型</span></span></code><code><span leaf=""><span>env_numeric </span><span>&lt;-</span><span> apply(env[,</span><span>1</span><span>:</span><span>11</span><span>],</span><span>2</span><span>,as.numeric)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>qcorrplot(rcorr(env_numeric), type </span><span>=</span><span> "upper", diag </span><span>=</span><span> </span><span>FALSE</span><span>, grid_size </span><span>=</span><span> </span><span>0.4</span><span>,grid_col </span><span>=</span><span> "lightgray") </span><span>+</span></span></code><code><span leaf=""><span>  geom_square(linetype</span><span>=</span><span>0</span><span>) </span><span>+</span></span></code><code><span leaf=""><span>  geom_couple(data </span><span>=</span><span> mantel, aes(colour </span><span>=</span><span> p_value, size </span><span>=</span><span> r_value),  </span></span></code><code><span leaf=""><span>              node.shape </span><span>=</span><span> </span><span>21</span><span>, node.size </span><span>=</span><span> </span><span>2</span><span>, node.colour </span><span>=</span><span> "#0000ff", node.fill </span><span>=</span><span> "#9ba9f1",</span></span></code><code><span leaf=""><span>              curvature </span><span>=</span><span> </span><span>0.1</span><span>) </span><span>+</span></span></code><code><span leaf=""><span>  scale_fill_gradientn(limits </span><span>=</span><span> c(</span><span>-1</span><span>, </span><span>1</span><span>),</span></span></code><code><span leaf=""><span>                       breaks </span><span>=</span><span> seq(</span><span>-1</span><span>, </span><span>1</span><span>, </span><span>0.5</span><span>),</span></span></code><code><span leaf=""><span>                       colours </span><span>=</span><span> c("#FF8040","white","#5BC2CD")) </span><span>+</span><span> </span></span></code><code><span leaf=""><span>  scale_size_manual(</span><span>values</span><span> </span><span>=</span><span> c(</span><span>0.2</span><span>, </span><span>0.5</span><span>, </span><span>0.8</span><span>))</span><span>+</span><span> </span></span></code><code><span leaf=""><span>  scale_colour_manual(</span><span>values</span><span>=</span><span>c("#87CEEB","#9ACD32","gray")) </span><span>+</span></span></code><code><span leaf=""><span>  guides(size </span><span>=</span><span> guide_legend(title </span><span>=</span><span> expression("Mantel's" </span><span>~</span><span> italic("r")),</span></span></code><code><span leaf=""><span>                             override.aes </span><span>=</span><span> list(colour </span><span>=</span><span> "grey35"), </span></span></code><code><span leaf=""><span>                             </span><span>order</span><span> </span><span>=</span><span> </span><span>2</span><span>),</span></span></code><code><span leaf=""><span>         colour </span><span>=</span><span> guide_legend(title </span><span>=</span><span> expression("Mantel's" </span><span>~</span><span> italic("p")), </span></span></code><code><span leaf=""><span>                               override.aes </span><span>=</span><span> list(size </span><span>=</span><span> </span><span>2</span><span>), </span></span></code><code><span leaf=""><span>                               </span><span>order</span><span> </span><span>=</span><span> </span><span>1</span><span>),</span></span></code><code><span leaf=""><span>         fill </span><span>=</span><span> guide_colorbar(title </span><span>=</span><span> expression("Pearson's" </span><span>~</span><span> italic("r")), </span><span>order</span><span> </span><span>=</span><span> </span><span>3</span><span>))</span><span>+</span></span></code><code><span leaf=""><span>  geom_mark(only_mark </span><span>=</span><span> T,</span></span></code><code><span leaf=""><span>            size </span><span>=</span><span> </span><span>6</span><span>,</span></span></code><code><span leaf=""><span>            sig_level </span><span>=</span><span> c(</span><span>0.05</span><span>, </span><span>0.01</span><span>, </span><span>0.001</span><span>),</span></span></code><code><span leaf=""><span>            sig_thres </span><span>=</span><span> </span><span>0.05</span><span>,</span></span></code><code><span leaf=""><span>            colour </span><span>=</span><span> "black")</span></span></code></pre></section><ul><li><section><span leaf="">使用</span><code><span leaf="">rcorr()</span></code><span leaf="">函数计算 Pearson 相关系数矩阵，并通过</span><code><span leaf="">qcorrplot()</span></code><span leaf="">函数绘制相关性图。</span></section></li><li><section><span leaf="">使用</span><code><span leaf="">geom_couple()</span></code><span leaf="">函数添加 Mantel 测试结果的连线：</span></section></li><ul><li><section><code><span leaf="">data = mantel</span></code><span leaf="">：使用之前计算的 Mantel 测试结果数据。</span></section></li><li><section><code><span leaf="">aes(colour = p_value, size = r_value)</span></code><span leaf="">：使用 p_value 作为颜色，r_value 作为线的粗细。</span></section></li><li><section><span leaf="">curvature = 0.1：设置连线的弯曲度。</span></section></li></ul><li><section><span leaf="">使用</span><code><span leaf="">geom_mark()</span></code><span leaf="">：添加显著性*标记：</span></section></li><ul><li><section><span leaf="">only_mark = T：仅标记显著性。</span></section></li><li><section><span leaf="">sig_level = c(0.05, 0.01, 0.001)：设置显著性水平。</span></section></li><li><section><span leaf="">sig_thres = 0.05：设置显著性阈值。</span></section></li></ul></ul><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3QQ6ic4ZRPrPHSyKw8tsKEc7KeBmY7UuH23JfqSbicv7UAuWXUXpVQO9Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6533466533466533" data-type="png" data-w="1001" data-imgfileid="100000837" src="https://mmbiz.qpic.cn/mmbiz_png/mEOTibibBIwKLwuib5kEicZqH7Ao9SNGJ8Q3QQ6ic4ZRPrPHSyKw8tsKEc7KeBmY7UuH23JfqSbicv7UAuWXUXpVQO9Q/640?wx_fmt=png&amp;from=appmsg"></span></p><p data-tool="mdnice编辑器"><span leaf=""><span textstyle="">获取以 RProject 形式保存的绘图代码和测试数据，后台回复关键词: </span></span><strong><em><span leaf=""><span textstyle="">250210_correlation_heatmaps</span></span></em></strong></p><section nodeleaf=""><mp-common-cpsad data-pluginname="mpcps" data-templateid="list" data-cpsversion="v120" data-goodssouce="1" data-traceid="4d363462-efe8-46ed-b51a-0c512d098706" data-pid="101_14835066"></mp-common-cpsad></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/yPGgFO8Y050w5itmkcpvoQ",target="_blank" rel="noopener noreferrer">原文链接</a>
