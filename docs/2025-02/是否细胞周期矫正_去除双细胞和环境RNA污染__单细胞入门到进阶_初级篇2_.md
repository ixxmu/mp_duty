---
title: "是否细胞周期矫正，去除双细胞和环境RNA污染——单细胞入门到进阶(初级篇2）"
date: 2025-02-09T23:51:11Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
是否细胞周期矫正，去除双细胞和环境RNA污染——单细胞入门到进阶(初级篇2） by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>我们在上一讲<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527846&amp;idx=1&amp;sn=5f5addd46277460176b485be5ad2e71b&amp;scene=21#wechat_redirect" textvalue="单细胞实战之样本整理，细胞注释和部分图表绘制---从入门到进阶(初级篇1）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞实战之样本整理，细胞注释和部分图表绘制---从入门到进阶(初级篇1）</a>内容中得到处理好后的数据集之后，接着来学习“矫正”数据的三个可选的操作：<span><strong>细胞周期回归矫正，去除双细胞和环境RNA污染</strong></span></p></blockquote></section><p data-tool="mdnice编辑器"><span>前面的<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247527846&amp;idx=1&amp;sn=5f5addd46277460176b485be5ad2e71b&amp;scene=21#wechat_redirect" textvalue="单细胞实战之样本整理，细胞注释和部分图表绘制---从入门到进阶(初级篇1）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞实战之样本整理，细胞注释和部分图表绘制---从入门到进阶(初级篇1）</a>示例数据可以通过网盘下载：</span><span>初级篇1链接: https://pan.baidu.com/s/1wHZBdYAr6f0H-yMxDZZBHw 提取码: t2vb--来自百度网盘超级会员v4的分享，该数据是延续了上一讲的内容~</span></p><p data-tool="mdnice编辑器">此外，可以通过向公众号发送关键词‘单细胞’，直接获取Seurat V5版本的完整代码。</p><p data-tool="mdnice编辑器">关于上一讲内容最后的boxplot代码，补充一下：（值得注意是并不是最好的代码，其实可以每个细胞亚群拆分绘图，还能加上统计学显著性）</p><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'../phe.Rdata'</span>)<br>phe$group = sce$group = ifelse(sce$orig.ident %<span>in</span>% c(<span>"GSM5688706_WGC"</span>,<span>"GSM5688707_JCA"</span>,<span>"GSM5688708_LS-CRC3"</span>),<span>"left"</span>,<span>"right"</span>)<br>head(phe) <br>gplots::balloonplot(<br>  table(phe$celltype,phe$orig.ident)<br>)<br><br>x = phe$orig.ident<br>y = phe$celltype<br>tbl =  table(x,y)<br>df = dcast(as.data.frame(tbl),x~y)<br>ptb = round(<span>100</span>*tbl/rowSums(df[,-<span>1</span>]),<span>2</span>)<br>df = as.data.frame(ptb)<br>colnames(df)=c(<span>'orig.ident'</span>,<span>'celltype'</span>,<span>'Percentage'</span>)<br>head(df)<br>gpinfo=unique(phe[,c(<span>'orig.ident'</span>,<span>'group'</span>)]);gpinfo<br>df=merge(df,gpinfo,by=<span>'orig.ident'</span>)<br>head(df)<br><br>p &lt;- ggplot(df,aes(x=group,y=Percentage))+<br>  geom_boxplot(outlier.alpha=<span>0</span>, aes(fill=celltype))+facet_grid(~celltype,scales = <span>"free"</span>)+<br>  geom_jitter(aes(x = group, y = Percentage,color=celltype))+ <br>  scale_color_npg() +<br>  scale_fill_npg() +<br>  theme_bw()+<br>  theme(axis.text.x = element_text(face = <span>"bold"</span>,angle = <span>45</span>, hjust=<span>1</span>, vjust=<span>0.5</span>,size = <span>14</span>), <br>        legend.position= <span>"none"</span>,<br>        strip.background = element_rect(color=<span>"black"</span>,fill = <span>"steelblue3"</span>, linetype = <span>"solid"</span>),<br>        strip.text = element_text(face = <span>"bold"</span>, color = <span>"black"</span>,hjust = <span>0.5</span>, size = <span>12</span>,),<br>        plot.title=element_text(face=<span>"bold.italic"</span>,size=<span>"20"</span>, color=<span>"brown"</span>,hjust = <span>0.5</span>),<br>        axis.text.y = element_text(face = <span>"bold"</span>,size = <span>14</span>) ,<br>        axis.title = element_text(size = <span>14</span>),<br>        panel.grid.major = element_blank(),<br>        panel.grid.minor = element_blank()) <br>p   <br>pro=<span>'Percentage-of-each--celltype-in-orig.ident-by-group'</span><br>ggsave(paste0(pro,<span>"_boxplot.pdf"</span>),width = <span>12</span>,height = <span>6</span>)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span>三种工具的简单介绍和思考<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>1.细胞周期矫正<span></span></h5><p data-tool="mdnice编辑器">单细胞细胞周期矫正的目的从宽泛的角度来说是因为它可以<strong>消除由于细胞周期阶段不同而导致的基因表达异质性</strong>。在单细胞数据中，不同细胞可能处于不同的细胞周期阶段(如G1、S、G2或M期)，这些阶段会影响细胞的基因表达模式，尤其是那些与细胞周期密切相关的基因。如果不进行细胞周期矫正，这些周期性变化的基因可能会误导后续的数据分析，如聚类和差异表达分析，导致分析结果不能准确反映细胞的生物学状态和异质性。</p><p data-tool="mdnice编辑器">但这个时候问题就来了，<strong>如果可以消除由于细胞周期阶段不同而导致的基因表达异质性，那么换句话来说是不是也就可能消除了本身的生物学差异，而这种差异也许是研究者正是所想要研究的呢？</strong></p><p data-tool="mdnice编辑器"><strong>笔者认为正确也不一定正确，这需要依情况而定。</strong></p><p data-tool="mdnice编辑器">我们在做单细胞分析的时候是需要根据样本的"特征"(这里可以泛指是各种重要的且表达有差异的基因)去对数据做分析。那么<strong>如何更好的去找出这些特征基因且必须把一些表达有差异但其实是没有意义的基因给筛去</strong>？在刚开始的质控环节就已经开始了，比如限制线粒体基因的百分比，nCount和nFeature的值等等。</p><p data-tool="mdnice编辑器">在单细胞时代之下数据的分辨率已经达到了细胞级，不同细胞应看做不同的样本，那么它们之间是存在极大异质性的。<strong>这种异质性从表象上都可归类于生物学差异，但更深层次的，研究者真正想要知道是生物学差异背后的样本之间的功能差异！</strong></p><p data-tool="mdnice编辑器">而细<strong>胞周期既可以看做是生物学上的混杂因素(不同细胞的细胞周期情况在取样的那一瞬间就已经被定格了，而他们的周期情况绝对是不可能完全一样的)<strong>，也可以在控制大部分混杂因素(控制变量这件事要完美是不可能的)后的后续分析中</strong>认为是功能上的差异(不同处理下，细胞周期通路在实验组和对照组之间存在的差异)<strong>。如果说是生物学的差异，我们就</strong>需要在正式分析之前就要进行矫正，尽量减少这种生物学差异导致的影响！</strong></p><p data-tool="mdnice编辑器">但这里还有一个问题，<strong>细胞周期的影响真的那么大吗？是的，在既往的文献中(见参考资料)已经明确提到了细胞周期这个生物学差异会导致很大的异质性</strong>，从笔者的理解来看，<strong>这种异质性可能会掩盖功能学上的差异！(这个掩盖可以解释为由于细胞周期导致的生物学误差过大之后，其他非细胞周期相关的功能学差异反而显得没那么有差异了..)</strong></p><p data-tool="mdnice编辑器">当然，我们还是要依情况而定，<strong>如果研究方向就是跟细胞周期有直接且密切关系的，那就不可以去矫正这个因素了</strong>，比如现在热门—衰老/干细胞(涉及静息态等情况？这块不太懂)等相关的研究。如果是<strong>非直接关系的，应当要去矫正，换个角度去想，如果一个矫正能把"所谓的差异"给矫正没了，那请问这个"差异"到底真有那么大的研究价值吗？</strong></p><h5 data-tool="mdnice编辑器"><span></span>2.去除双胞体<span></span></h5><p data-tool="mdnice编辑器">在单细胞RNA测序过程中，<strong>有时两个或多个细胞可能在制备过程中意外结合成一个单一的"假细胞"，称为双峰细胞或双胞体</strong>。这些细胞可能会扭曲数据分析和解释，因此，需要使用一些方法对它们进行识别和剔除。<img alt="" data-imgfileid="100044200" data-ratio="0.1935096153846154" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbI1Wy8L4Ch9apVAsVH96GaJpz4Fzm0zGQyp9eEP8W4laIhjicD4L77zQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="832" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbI1Wy8L4Ch9apVAsVH96GaJpz4Fzm0zGQyp9eEP8W4laIhjicD4L77zQ/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">其中DoubletFinder是最常用的一个工具，其分析流程可以分为以下四个步骤：</p><ol data-tool="mdnice编辑器"><li><section><strong>从现有的 scRNA-seq 数据中生成人工双胞体</strong>：通过对现有的单细胞 RNA 测序数据进行合成操作，生成具有双胞体特征的人工数据。</section></li><li><section><strong>对合并后的真实数据和人工数据进行预处理</strong>：将真实单细胞数据与生成的人工双胞体数据进行合并，并对合并数据进行标准化和其他必要的预处理步骤。</section></li><li><section><strong>执行主成分分析（PCA），并利用主成分距离矩阵计算每个细胞的人工双胞体最近邻（k nearest neighbors, kNN）比例（pANN）</strong>：基于 PCA 降维后的数据，计算每个细胞在其最近邻细胞中属于人工双胞体的比例。</section></li><li><section>根<strong>据预期双胞体数量对 pANN 值进行排序和阈值筛选</strong>：将计算得到的 pANN 值按照降序排列，并结合预期的双胞体数量确定适当的阈值，以筛选出可能的双胞体。</section></li></ol><p data-tool="mdnice编辑器"><strong>官方对DoubletFinder输入的对象和参数介绍：</strong></p><ol data-tool="mdnice编辑器"><li><section>seu：这是一个完全处理过的 Seurat 对象，即已经完成了数据规范化（NormalizeData）、寻找变异基因（FindVariableGenes）、数据标准化（ScaleData）、主成分分析（RunPCA）和 t-SNE 分析（RunTSNE）。</section></li><li><section>PCs：指定用于分析的统计显著的主成分数量，例如 PCs = 1:10。</section></li><li><section>pN：定义生成的人工双胞体数量，以合并的真实-人工数据比例表示。默认设置为 25%，根据 McGinnis, Murrow 和 Gartner 在 2019 年的 Cell Systems 文章，DoubletFinder 的表现在很大程度上与 pN 参数无关。</section></li><li><section>pK：定义用于计算 pANN 的 PC 邻域大小，同样以合并的真实-人工数据比例表示。没有默认值，因为每个单细胞 RNA 测序数据集都应该调整 pK 值。最优的 pK 值应该使用下面描述的策略来估计。</section></li><li><section>nExp：定义用于做出最终双倍体/单倍体预测的 pANN 阈值。这个值最好从 10X 或 Drop-Seq 设备的细胞加载密度中估计，并根据同源双倍体的预估比例进行调整。</section></li></ol><p data-tool="mdnice编辑器"><span><strong>下面的表格是DoubletRate参数选择的参考文件(10X)，在分析之前参照这个表格上边的细胞数选择DoubletRate值。</strong></span><img alt="" data-imgfileid="100044202" data-ratio="0.906764168190128" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrb8xEV4bcSce4fWrZlj8WtOib9zia2BXbfH1QjibvCaz5LjxnADbeNxTyGg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="547" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrb8xEV4bcSce4fWrZlj8WtOib9zia2BXbfH1QjibvCaz5LjxnADbeNxTyGg/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span>3.去除RNA污染(DecontX)<span></span></h5><p data-tool="mdnice编辑器">DecontX是一种用于单细胞 RNA 测序数据的去除环境污染物（decontamination）的算法，主要用于减少由细胞外RNA造成的污染效应。该算法旨在从测序数据中去除由环境或邻近细胞释放的外源 RNA，改善下游分析的准确性，如细胞类型鉴定和差异表达分析。<img alt="" data-imgfileid="100044203" data-ratio="0.5272727272727272" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbjsBIHI3jrUHSZ1ib63V1oECVqy3BpJC1Y9ksoIZFBeibetpGEwcf6bpw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="770" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbjsBIHI3jrUHSZ1ib63V1oECVqy3BpJC1Y9ksoIZFBeibetpGEwcf6bpw/640?wx_fmt=png&amp;from=appmsg">开发者在20年的文章中已经把这个工具适用的情况说的非常清楚了：简单来说就是尽管基于微流控的单细胞技术会导致环境中的RNA增多，这种环境中的RNA是来自于自受压或经历细胞凋亡的细胞。当环境RNA掺入液滴中并与细胞的天然mRNA一起被标记和扩增时，就会发生交叉污染。<img alt="" data-imgfileid="100044201" data-ratio="1.0334728033472804" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbibJ8w7qiad3AYgrst7Aib8A0CruxOgJsSDr2XSoiawAtzIp5iae4gtV6LtQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="717" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbibJ8w7qiad3AYgrst7Aib8A0CruxOgJsSDr2XSoiawAtzIp5iae4gtV6LtQ/640?wx_fmt=png&amp;from=appmsg">其可以通过贝叶斯统计模型对每个细胞的RNA读数进行推断，将原始数据分解为细胞内真实表达的 RNA 和污染的 RNA。该模型假设污染 RNA 来自于细胞群体的背景分布。进而估计每个细胞中污染RNA的比例，并根据污染的概率对原始表达矩阵进行校正，以生成一个含有去污染的表达矩阵(简单来说是给每个细胞一个污染评分，而使用者可以根据自己的需求调整筛选分值，分值是选择是在0-1之间)。</p><h4 data-tool="mdnice编辑器"><span></span>分析步骤—矫正细胞周期<span></span></h4><h5 data-tool="mdnice编辑器"><span></span>1.导入<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br><span>library</span>(DoubletFinder)<br><span>library</span>(BiocParallel)<br>getwd()<br>dir.create(<span>'4-Corrective-data/'</span>)<br>setwd(<span>'4-Corrective-data/'</span>) <br><br>register(MulticoreParam(workers = <span>4</span>, progressbar = <span>TRUE</span>))<br>sce.all &lt;- readRDS(<span>"../2-harmony/sce.all_int.rds"</span>)<br>sp=<span>'human'</span> <br>load(<span>'../phe.Rdata'</span>) <br>identical(rownames(phe) , colnames(sce.all))<br>sce.all=sce.all[,colnames(sce.all) %<span>in</span>% rownames(phe) ]<br>sce.all@meta.data = phe[match(colnames(sce.all),rownames(phe) ),]<br>sel.clust = <span>"celltype"</span><br>sce.all &lt;- SetIdent(sce.all, value = sel.clust)<br>table(sce.all@active.ident) <br>DimPlot(sce.all) <br>colnames(sce.all@meta.data)<br><br>scRNA &lt;- sce.all<br></code></pre><p data-tool="mdnice编辑器">check一下<img alt="" data-imgfileid="100044199" data-ratio="0.8644628099173554" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbY2WpmSqMo7O9bMjmGqx91VibgolNocCvX5wtN1ibfa9ibUz2avqb74obQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="605" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbY2WpmSqMo7O9bMjmGqx91VibgolNocCvX5wtN1ibfa9ibUz2avqb74obQ/640?wx_fmt=png&amp;from=appmsg"><strong>需要提醒的是，在自行分析的时候请把细胞周期矫正代码嵌入到标准流程(PCA前面)中去。</strong></p><h5 data-tool="mdnice编辑器"><span></span>2.数据预处理<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># Seurat包自带了一组细胞周期标记基因，这些基因来自 Tirosh 等人在 2015 年发表的研究（通常是指用于单细胞 RNA 测序数据中的细胞周期分析）。</span><br><span># 这些基因被用来识别细胞所处的细胞周期阶段，如G1、S、G2/M 期。</span><br>s.genes &lt;- intersect(cc.genes$s.genes,rownames(scRNA))<br>g2m.genes &lt;- intersect(cc.genes$g2m.genes,rownames(scRNA))<br>scRNA &lt;- CellCycleScoring(scRNA,<br>                        s.features = s.genes,<br>                        g2m.features = g2m.genes,<br>                        set.ident = <span>T</span>)<br>colnames(scRNA@meta.data)<br>p1=VlnPlot(scRNA,features =  <span>"S.Score"</span> ,pt.size = <span>0</span>,group.by = <span>'celltype'</span>) +NoLegend()<br>p2=VlnPlot(scRNA,features =  <span>"G2M.Score"</span> ,pt.size = <span>0</span>,group.by = <span>'celltype'</span>)+NoLegend()<br>p1+p2<br>table(scRNA$Phase,scRNA$celltype)<br>  <span>#     B cells endothelial cells epithelial/cancer cells fibroblasts mast cells myeloid cells plasma proliferative cells T/NK cells VSMCs</span><br>  <span># G1     2027               437                    1478         955        468          2763   1832                  68       5855   365</span><br>  <span># G2M     857                56                     637          35         78           336    164                 396       2557    14</span><br>  <span># S       920                56                     306          50         50           357    100                 339       2033    32</span><br></code></pre><p data-tool="mdnice编辑器">在增殖性细胞群中的分值是最高的。<img alt="" data-imgfileid="100044204" data-ratio="0.08705882352941176" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbiaevey6iajm4fAsNSXZYSQia1hW7aXM3qB4qIcwpSrhd5t8Cn0SOXsCHQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="850" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbiaevey6iajm4fAsNSXZYSQia1hW7aXM3qB4qIcwpSrhd5t8Cn0SOXsCHQ/640?wx_fmt=png&amp;from=appmsg">官方教程认为需要去除细胞周期相关基因以及TOP2A,MKI67的高表达的影响(我们这里的proliferative cells其实是高表达了TOP2A和MKI67)。<img alt="" data-imgfileid="100044208" data-ratio="0.4935185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbtR1FKk8uO4CeM33HYWIUfeujUyWHMaFAy8boxiaPqSVn7vfvhoGE7WA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbtR1FKk8uO4CeM33HYWIUfeujUyWHMaFAy8boxiaPqSVn7vfvhoGE7WA/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span>3.ScaleData矫正<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># features = rownames(scRNA)的情况需要前后一致</span><br>scRNA_new &lt;- ScaleData(scRNA,<br>                       vars.to.regress = c(<span>"S.Score"</span>, <span>"G2M.Score"</span>),<br>                       features = rownames(scRNA))<br></code></pre><h6 data-tool="mdnice编辑器"><span></span>3.1 处理和不处理结果对比<span></span></h6><pre data-tool="mdnice编辑器"><span></span><code><span># 查看不进行细胞周期和细胞之后处理之后的数据情况</span><br><span># 分别查看celltype和细胞周期基因标记情况</span><br>p1=DimPlot(scRNA_new,reduction=<span>"pca"</span>,group.by=<span>'celltype'</span>) + DimPlot(scRNA,reduction=<span>"pca"</span>,group.by=<span>'celltype'</span>);p1<br>p2=DimPlot(scRNA_new,reduction=<span>"pca"</span>) + DimPlot(scRNA,reduction=<span>"pca"</span>) +NoLegend();p2<br>p1/p2<br></code></pre><p data-tool="mdnice编辑器">PCA的结果是有差别的<img alt="" data-imgfileid="100044207" data-ratio="0.7032136105860114" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbR0qWOYwkGC4blNVic5CFicX8T4vwUjAHVkU3Y4SLlL02wJn3LKv7icfew/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1058" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbR0qWOYwkGC4blNVic5CFicX8T4vwUjAHVkU3Y4SLlL02wJn3LKv7icfew/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span>4.重新对scRNA和scRNA_new数据进行PCA以及后续流程并进行结果对比<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 在这里我们重新对scRNA和scRNA_new数据进行PCA以及后续流程并进行结果对比</span><br>seurat &lt;- RunPCA(scRNA,<br>                 features = VariableFeatures(object = scRNA),<br>                 verbose = <span>FALSE</span>)<br>seurat &lt;- RunHarmony(seurat,<span>"orig.ident"</span>)<br>seurat &lt;- FindNeighbors(seurat, dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>, <br>                     verbose = <span>FALSE</span>) <br>seurat &lt;- FindClusters(seurat,resolution = <span>0.8</span>, <br>                    verbose = <span>FALSE</span>)<br>seurat &lt;- RunUMAP(seurat,dims=<span>1</span>:<span>15</span>,reduction = <span>"harmony"</span>,<br>                     umap.method = <span>"uwot"</span>, metric = <span>"cosine"</span>)<br>seurat &lt;- DimPlot(seurat,reduction = <span>'umap'</span>,label = <span>T</span>);seurat<br><br><span># scRNA_new</span><br>seuratObj &lt;- RunPCA(scRNA_new,<br>                    features = VariableFeatures(object = scRNA_new),<br>                    verbose = <span>FALSE</span>)<br>seuratObj &lt;- RunHarmony(seuratObj,<span>"orig.ident"</span>)<br>seuratObj &lt;- FindNeighbors(seuratObj, dims = <span>1</span>:<span>15</span>, <br>                     reduction = <span>"harmony"</span>, <br>                     verbose = <span>FALSE</span>) <br>seuratObj &lt;- FindClusters(seuratObj,resolution = <span>0.8</span>, <br>                    verbose = <span>FALSE</span>)<br>seuratObj &lt;- RunUMAP(seuratObj,dims=<span>1</span>:<span>15</span>,reduction = <span>"harmony"</span>,<br>                     umap.method = <span>"uwot"</span>, metric = <span>"cosine"</span>)<br>seuratObj &lt;- DimPlot(seuratObj,reduction = <span>'umap'</span>,label = <span>T</span>);seuratObj<br></code></pre><p data-tool="mdnice编辑器">从图形就可以看出其实还是存在一定差别的<img alt="" data-imgfileid="100044205" data-ratio="0.465564738292011" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrb5NHKaVdTCPwQR5fZuiaicDqQZicbhFyv0tMib1JsFyNhIwLCkYiahfUsl2Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="726" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrb5NHKaVdTCPwQR5fZuiaicDqQZicbhFyv0tMib1JsFyNhIwLCkYiahfUsl2Q/640?wx_fmt=png&amp;from=appmsg"><strong>需要再次提醒的是，是否要用细胞周期，各位还是要根据自己数据结合生物学背景去决定。</strong></p><h4 data-tool="mdnice编辑器"><span></span>分析步骤—去除双胞体+RNA污染<span></span></h4><p data-tool="mdnice编辑器">这里的数据没有进行细胞周期矫正~</p><h6 data-tool="mdnice编辑器"><span></span>1.导入<span></span></h6><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br><span>source</span>(<span>'scRNA_scripts/lib.R'</span>)<br><span>library</span>(DoubletFinder)<br><span>library</span>(BiocParallel)<br>getwd()<br>dir.create(<span>'4-Corrective-data/'</span>)<br>setwd(<span>'4-Corrective-data/'</span>) <br><br>register(MulticoreParam(workers = <span>4</span>, progressbar = <span>TRUE</span>))<br>sce.all &lt;- readRDS(<span>"../2-harmony/sce.all_int.rds"</span>)<br>sp=<span>'human'</span> <br>load(<span>'../phe.Rdata'</span>) <br>identical(rownames(phe) , colnames(sce.all))<br>sce.all=sce.all[,colnames(sce.all) %<span>in</span>% rownames(phe) ]<br>sce.all@meta.data = phe[match(colnames(sce.all),rownames(phe) ),]<br>sel.clust = <span>"celltype"</span><br>sce.all &lt;- SetIdent(sce.all, value = sel.clust)<br>table(sce.all@active.ident) <br>DimPlot(sce.all) <br>colnames(sce.all@meta.data)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span>2.DoubletFinder分析<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code><span># 定义主要参数和函数</span><br>run_doublet_finder &lt;- <span>function</span>(sce_object, doublet_rate, pcs = <span>1</span>:<span>15</span>, sct = <span>FALSE</span>) {<br>  <span># 参数扫描，选择最优 pK 值</span><br>  sweep.res &lt;- paramSweep(sce_object, PCs = pcs, sct = sct)<br>  sweep.stats &lt;- summarizeSweep(sweep.res, GT = <span>FALSE</span>)<br>  bcmvn &lt;- find.pK(sweep.stats)<br>  pK_bcmvn &lt;- bcmvn$pK[which.max(bcmvn$BCmetric)] %&gt;% as.numeric()<br>  <br>  <span># 计算 homotypic doublets 和调整的 doublet 数目</span><br>  homotypic.prop &lt;- modelHomotypic(sce_object$seurat_clusters)<br>  nExp_poi &lt;- round(doublet_rate * ncol(sce_object))<br>  nExp_poi.adj &lt;- round(nExp_poi * (<span>1</span> - homotypic.prop))<br>  <br>  <span># 鉴定 doublets</span><br>  sce_object &lt;- doubletFinder(sce_object, <br>                              PCs = pcs, <br>                              pN = <span>0.25</span>, <br>                              pK = pK_bcmvn, <br>                              nExp = nExp_poi.adj, <br>                              reuse.pANN = <span>FALSE</span>, <br>                              sct = sct)<br>  <span>return</span>(sce_object)<br>}<br><br><span># 运行 DoubletFinder 分析</span><br>sce_list &lt;- SplitObject(scRNA, split.by = <span>"orig.ident"</span>)<br><span># check每个样本的细胞数</span><br>sce_list<br><span># doublet_rate中的值需要根据</span><br>sce_list[[<span>"GSM5688706_WGC"</span>]] &lt;- run_doublet_finder(sce_list[[<span>"GSM5688706_WGC"</span>]], <br>                                                   doublet_rate = <span>0.018</span>)<br></code></pre><p data-tool="mdnice编辑器">由于每个样本的细胞数都不一样，所以每次都需要重新选择样本并且设定doublet比例。</p><pre data-tool="mdnice编辑器"><span></span><code><span># 选择一个可视化一下</span><br>DimPlot(sce_list[[<span>"GSM5688706_WGC"</span>]], <br>        reduction = <span>"umap"</span>, <br>        group.by = <span>"DF.classifications_0.25_24_59"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img alt="" data-imgfileid="100044206" data-ratio="0.8758716875871687" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrb6ALqCkU90AvlUkMgpuDz7lsooL7CyYw5HLxxg1Lh0V6zMcdzKDt4Jw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="717" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrb6ALqCkU90AvlUkMgpuDz7lsooL7CyYw5HLxxg1Lh0V6zMcdzKDt4Jw/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span># 遍历每个子对象，直接修改列名</span><br>sce_list &lt;- lapply(sce_list, <span>function</span>(sce) {<br>  <span># 修改 pANN 列名（匹配以 "pANN_0.25" 开头的列）</span><br>  pANN_col &lt;- grep(<span>"^pANN_0.25"</span>, colnames(sce@meta.data), value = <span>TRUE</span>)<br>  <span>if</span> (length(pANN_col) &gt; <span>0</span>) {<br>    colnames(sce@meta.data)[colnames(sce@meta.data) %<span>in</span>% pANN_col] &lt;- <span>"pANN_0.25"</span><br>  }<br>  <br>  <span># 修改 DF.classifications 列名（匹配以 "DF.classifications_0.25" 开头的列）</span><br>  DF_col &lt;- grep(<span>"^DF\\.classifications_0.25"</span>, colnames(sce@meta.data), value = <span>TRUE</span>)<br>  <span>if</span> (length(DF_col) &gt; <span>0</span>) {<br>    colnames(sce@meta.data)[colnames(sce@meta.data) %<span>in</span>% DF_col] &lt;- <span>"DF.classifications"</span><br>  }<br>  <br>  <span>return</span>(sce)<br>})<br><br>sce.all &lt;- merge(sce_list[[<span>1</span>]], y= sce_list[ -<span>1</span> ]) <span>#add.cell.ids =  samples) </span><br>LayerData(sce.all, assay = <span>"RNA"</span>, layer = <span>"counts"</span>)<br>sce.all &lt;- JoinLayers(sce.all)<br>dim(sce.all[[<span>"RNA"</span>]]$counts )<br>colnames(sce.all@meta.data)<br><br>sce.all &lt;- NormalizeData(sce.all,normalization.method = <span>"LogNormalize"</span>,<br>                         scale.factor = <span>1e4</span>) <br>sce.all &lt;- FindVariableFeatures(sce.all)<br>sce.all &lt;- ScaleData(sce.all)<br>sce.all &lt;- RunPCA(sce.all, features = VariableFeatures(object = sce.all))<br>sce.all &lt;- RunHarmony(sce.all, <span>"orig.ident"</span>)<br>sce.all &lt;- RunUMAP(sce.all,  dims = <span>1</span>:<span>15</span>,reduction = <span>"harmony"</span>)<br>DimPlot(sce.all,group.by = <span>"DF.classifications"</span>)<br><br><span># 如果需要过滤双细胞的话</span><br>sce.all.filtered &lt;- subset(sce.all, subset = DF.classifications == <span>"Singlet"</span>)<br>DimPlot(sce.all.filtered,group.by = <span>"DF.classifications"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img alt="" data-imgfileid="100044213" data-ratio="1.0932642487046633" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbT45nPJetwTzdjffPZxP7kK3SDDY1CHpY5KYsreO0D3BVMcd88tOKSw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="579" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbT45nPJetwTzdjffPZxP7kK3SDDY1CHpY5KYsreO0D3BVMcd88tOKSw/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span>3.decontX去除单细胞数据的环境游离RNA污染<span></span></h5><p data-tool="mdnice编辑器">上一步过滤完双细胞之后，我们接下来在去除环境游离RNA污染</p><pre data-tool="mdnice编辑器"><span></span><code>set.seed(<span>123</span>)<br><span># 得到表达矩阵</span><br>counts &lt;- GetAssayData(object = sce.all.filtered, slot = <span>"counts"</span>)<br>decontX_res &lt;- decontX(counts)<br>sce.all.filtered$contamination &lt;- decontX_res$contamination<br>sce.all.filtered$contamination<br><br><span># 可视化</span><br><span>library</span>(ggplot2)<br>FeaturePlot(sce.all.filtered, <br>            features = <span>'contamination'</span>, <br>            raster=<span>FALSE</span>       <span># 细胞过多时候需要加这个参数</span><br>           ) + <br>  scale_color_viridis_c()+<br>  theme_bw()+<br>  theme(panel.grid = element_blank(),<br>        axis.text = element_blank(),<br>        axis.ticks = element_blank())+<br>  xlab(<span>'UMAP_1'</span>)+<br>  ylab(<span>'UMAP_2'</span>)<br><br><span># contamination值在0-1之间,官方没有给出具体的参考值</span><br><span># 有老师认为0.2可能是一个比较合适的界值</span><br>sce_filt &lt;- sce.all.filtered[,sce.all.filtered$contamination &lt; <span>0.2</span>]<br>DimPlot(sce_filt,label = <span>T</span>)+NoLegend()<br>sce_filt<br><span># An object of class Seurat </span><br><span># 21308 features across 24080 samples within 1 assay </span><br><span># Active assay: RNA (21308 features, 2000 variable features)</span><br><span>#  3 layers present: scale.data, data, counts</span><br><span>#  3 dimensional reductions calculated: pca, harmony, umap</span><br></code></pre><p data-tool="mdnice编辑器">contamination值在0-1之间,官方没有给出具体的参考值，<strong>有老师认为0.2可能是一个比较合适的界值。最终我们的数据从25621个细胞变成了24080个细胞~</strong><img alt="" data-imgfileid="100044212" data-ratio="0.918825561312608" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbiazHOzhgGWjNBvTic58aicEhxXuGWtdqWwHQyiaFgZohicXdnIANnep8nwQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="579" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRKQiamWMy4oTRKlD3guadrbiazHOzhgGWjNBvTic58aicEhxXuGWtdqWwHQyiaFgZohicXdnIANnep8nwQ/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span>4.记得保存数据<span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>qsave(sce_filt,<span>"sce.all.qs"</span>)<br>setwd(<span>".."</span>)<br></code></pre><p data-tool="mdnice编辑器">此时我们所保存的数据是一个去除了双细胞和RNA污染的数据(这部分数据里面没有矫正细胞周期), 后续我们将围绕这个数据再进行分析~</p><h4 data-tool="mdnice编辑器"><span></span>参考资料：<span></span></h4><ol data-tool="mdnice编辑器"><li><section>Seurat ：https://satijalab.org/seurat/articles/cell_cycle_vignette</section></li><li><section>DoubletFinder：https://github.com/chris-mcginnis-ucsf/DoubletFinder</section></li><li><section>decontX ：https://bioconductor.org/packages/release//bioc/manuals/decontX/man/decontX.pdf https://github.com/campbio/decontX</section></li><li><section>A single-cell resolution map of mouse hematopoietic stem and progenitor cell differentiation. Blood. 2016 Aug 25;128(8):e20-31.</section></li><li><section>Complex Analysis of Single-Cell RNA Sequencing Data. Biochemistry (Mosc). 2023 Feb;88(2):231-252.</section></li><li><section>Single-cell RNA-seq reveals changes in cell cycle and differentiation programs upon aging of hematopoietic stem cells. Genome Res. 2015 Dec;25(12):1860-72. doi: 10.1101/gr.192237.115<span es-id-type="DOI" es-id="10.1101/gr.192237.115" es-collect-button-id="0" cslsource="crossref"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"><g><path d="M852.3,135.6l-47.7,48.3c157.6,178.7,157.4,451,0.1,631l48.8,49.5C1035.9,672.1,1035.5,327.2,852.3,135.6z M740.9,248.6l-49.3,49.9c96.1,115.5,96.1,285.8,0.5,402.1l48.8,49.6C863.4,606.1,863.6,391.5,740.9,248.6z M195.4,183.9l-47.7-48.3c-183.2,191.6-183.6,536.5-1.2,728.8l48.8-49.5C37.9,635,37.8,362.6,195.4,183.9z M259.1,248.6C136.4,391.5,136.6,606.1,259,750.3l48.8-49.6c-95.6-116.4-95.6-286.6,0.4-402.1L259.1,248.6z M499.8,340.4c-87.3,0-158.1,71.8-158.1,160.4c0,88.5,70.8,160.4,158.1,160.4c87.3,0,158.1-71.8,158.1-160.4C657.8,412.2,587,340.4,499.8,340.4z"></path></g></svg><span><span value="6.2">IF: 6.2 </span><span value="Q1">Q1 </span><span value="B2">B2</span></span></span></section></li><li><section>Decontamination of ambient RNA in single-cell RNA-seq with DecontX. Genome Biol. 2020 Mar 5;21(1):57. doi: 10.1186/s13059-020-1950-6<span es-id-type="DOI" es-id="10.1186/s13059-020-1950-6" es-collect-button-id="1" cslsource="crossref"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewbox="0 0 1000 1000" enable-background="new 0 0 1000 1000" height="1em"><g><path d="M852.3,135.6l-47.7,48.3c157.6,178.7,157.4,451,0.1,631l48.8,49.5C1035.9,672.1,1035.5,327.2,852.3,135.6z M740.9,248.6l-49.3,49.9c96.1,115.5,96.1,285.8,0.5,402.1l48.8,49.6C863.4,606.1,863.6,391.5,740.9,248.6z M195.4,183.9l-47.7-48.3c-183.2,191.6-183.6,536.5-1.2,728.8l48.8-49.5C37.9,635,37.8,362.6,195.4,183.9z M259.1,248.6C136.4,391.5,136.6,606.1,259,750.3l48.8-49.6c-95.6-116.4-95.6-286.6,0.4-402.1L259.1,248.6z M499.8,340.4c-87.3,0-158.1,71.8-158.1,160.4c0,88.5,70.8,160.4,158.1,160.4c87.3,0,158.1-71.8,158.1-160.4C657.8,412.2,587,340.4,499.8,340.4z"></path></g></svg><span><span value="10.1">IF: 10.1 </span><span value="Q1">Q1 </span><span value="B1">B1</span></span></span></section></li><li><section>生信技能树：https://mp.weixin.qq.com/s/b3b0WeL4c-4gRYY7LRg81w https://mp.weixin.qq.com/s/ndt9Fsgg5dNxIOh9m7j9Bw</section></li><li><section>单细胞天地：https://mp.weixin.qq.com/s/O0U8vlMIG9vUVE3FK08LJg</section></li><li><section>生信菜鸟团：https://mp.weixin.qq.com/s/UiO7AQczrcMdKENCWkLRCQ</section></li><li><section>生信星球：https://mp.weixin.qq.com/s/bJ0tNj4w5p4R1MX5RHG9Ng</section></li></ol><p data-tool="mdnice编辑器"><strong>致谢</strong>：感谢曾老师以及生信技能树团队全体成员。更多精彩内容可关注公众号：<strong>生信技能树，单细胞天地，生信菜鸟团</strong>等公众号。</p><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。</p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/HgTVwfDfE4lzBXJKihlknA",target="_blank" rel="noopener noreferrer">原文链接</a>
