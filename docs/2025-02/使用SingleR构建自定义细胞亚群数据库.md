---
title: "使用SingleR构建自定义细胞亚群数据库"
date: 2025-02-23T10:50:50Z
draft: ["false"]
tags: [
  "fetched",
  "Investigator进修录"
]
categories: ["Acdemic"]
---
使用SingleR构建自定义细胞亚群数据库 by Investigator进修录
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><p>前面的教程：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247496724&amp;idx=1&amp;sn=df88dff2dfe32ae2108fa0ff8399b180&amp;scene=21#wechat_redirect" data-linktype="2">混合到同一个10X样品里面的多个细胞系如何注释</a>，我们提到了可以使用细胞系的表达量矩阵去跟细胞亚群表达量矩阵进行相关性计算，然后就可以判断细胞亚群的生物学意义啦。当然了，我们也给出来了一个比较不错的可视化方法，见：<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247496747&amp;idx=1&amp;sn=6f83611e672dd9c4e93de3596349078e&amp;scene=21#wechat_redirect" data-linktype="2">如果你觉得相关性热图不好看，或者太简陋</a>。</p></blockquote><p data-tool="mdnice编辑器">如何很多朋友留言问，为什么不使用现成的工具呢，比如SingleR就构建自定义细胞亚群数据库。我们当然知道这样的工具很好用，但是我们要分享的是技术细节，如果一切都使用现成的工具，就都被包装起来了，成为了一个黑匣子。</p><p data-tool="mdnice编辑器">而现成工具，其实就在于熟读文档罢了，SingleR构建自定义细胞亚群数据库，我这里也给大家演示一下：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(SingleR)<br><span>library</span>(Seurat)<br><span>library</span>(ggplot2)<br><br><span># 读入scRNA数据 -------</span><br>scRNA &lt;- readRDS(<span>"../step1_聚类/sce_all.Rds"</span>)<br>table(Idents(scRNA) )<br>Idents(scRNA) &lt;- <span>"RNA_snn_res.0.2"</span><br>table(Idents(scRNA) )<br><span># 读入参考数据集 -------</span><br>Ref &lt;- read.csv(<span>"../step2_注释/processed_reference.csv"</span>)<br>Ref &lt;- textshape::column_to_rownames(Ref, loc = <span>1</span>)<br>head(Ref)<br></code></pre><p data-tool="mdnice编辑器">可以看到每个细胞系都有自己的表达量，如下所示的一个矩阵，在R里面就是一个数据框。</p><p><img data-galleryid="" data-ratio="0.5848161328588375" data-s="300,640" data-type="png" data-w="843" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRTL6HTHsccVL1RjmaTX8I8Qj5HibzxRAZbPvPr56rchdfOicu7ZRpXrIEuNs9gEed7aCicpCR6rQJiaQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRTL6HTHsccVL1RjmaTX8I8Qj5HibzxRAZbPvPr56rchdfOicu7ZRpXrIEuNs9gEed7aCicpCR6rQJiaQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>参考细胞系表达量矩阵</figcaption></figure><p data-tool="mdnice编辑器">接下来才是SingleR构建自定义细胞亚群数据库，其实调用的是SingleCellExperiment这个对象构建的模式，主要是scater包需要学习一下，代码如下：</p><pre data-tool="mdnice编辑器"><span></span><code><br>ref_sce=SingleCellExperiment::SingleCellExperiment(assays=list(counts=Ref))<br>ref_sce=scater::logNormCounts(ref_sce)<br><span>library</span>(SingleCellExperiment)<br>logcounts(ref_sce)[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]<br>colData(ref_sce)$Type=colnames(Ref)<br>ref_sce<br><br></code></pre><p data-tool="mdnice编辑器">有了SingleR构建自定义细胞亚群数据库，接下来我们只需要把自己的单细胞矩阵提取出来即可；</p><pre data-tool="mdnice编辑器"><span></span><code><br>testdata &lt;- GetAssayData(scRNA, slot=<span>"data"</span>)<br><br>pred &lt;- SingleR(test=testdata, ref=ref_sce, <br>                labels=ref_sce$Type,<br>                <span>#clusters = scRNA@active.ident</span><br>)<br>table(pred$labels)<br>head(pred) <br></code></pre><p data-tool="mdnice编辑器">可以看到，两个矩阵使用SingleR函数处理一下，就可以拿到了 单细胞的亚群映射关系，如下所示：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; as.data.frame(table(pred<span>$labels</span>))<br>        Var1 Freq<br>1    HEK293T  835<br>2   MCF10A.x   71<br>3   MCF10A.y  396<br>4     MCF7.x   30<br>5     MCF7.y 1177<br>6 MDAMB134VI  478<br>7      SUM44  316<br>8     T47D.x  966<br>9     T47D.y  345<br></code></pre><p data-tool="mdnice编辑器">这个时候的我们也可以把SingleR对细胞系表达量矩阵和我们单细胞矩阵的相关性矩阵提取出来：</p><pre data-tool="mdnice编辑器"><span></span><code>pred@listData[[<span>"scores"</span>]]<br></code></pre><p data-tool="mdnice编辑器">就是前面的  全部的细胞系和全部的具体的每个单细胞的表达相关性矩阵（Pearson correlation coefficient）</p><p><img data-galleryid="" data-ratio="0.3648148148148148" data-s="300,640" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRTL6HTHsccVL1RjmaTX8I80gFOja59NrSGzjlM7n4ib0o21uxFh0KVr73w24s97szPz8b7vBZ4GpQ/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjRTL6HTHsccVL1RjmaTX8I80gFOja59NrSGzjlM7n4ib0o21uxFh0KVr73w24s97szPz8b7vBZ4GpQ/640?wx_fmt=png"></p><figure data-tool="mdnice编辑器"><figcaption>表达相关性矩阵（Pearson correlation coefficient）</figcaption></figure><p data-tool="mdnice编辑器">可以看到，殊路同归！</p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">如果你对单细胞数据分析还没有基础认知，可以看基础10讲：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486076&amp;idx=1&amp;sn=52bb851d7dc23461233a2cf458736151&amp;scene=21#wechat_redirect" data-linktype="2">01. 上游分析流程</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486082&amp;idx=1&amp;sn=03cadceffb2c14ba95d97fe5caf38d94&amp;scene=21#wechat_redirect" data-linktype="2">02.课题多少个样品，测序数据量如何</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486088&amp;idx=1&amp;sn=3a115338ee4937d20caab78627237553&amp;scene=21#wechat_redirect" data-linktype="2">03. 过滤不合格细胞和基因（数据质控很重要）</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486096&amp;idx=1&amp;sn=1a99c4c5800b7e0287db3e8ef369fab8&amp;scene=21#wechat_redirect" data-linktype="2">04. 过滤线粒体核糖体基因</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486098&amp;idx=1&amp;sn=bf9a71df848d74fe665ce7d5e283d5ff&amp;scene=21#wechat_redirect" data-linktype="2">05. 去除细胞效应和基因效应</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486260&amp;idx=1&amp;sn=c6abf658de73594d1d77d8e1ffa7d153&amp;scene=21#wechat_redirect" data-linktype="2">06.单细胞转录组数据的降维聚类分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486271&amp;idx=1&amp;sn=638b434b6deee63206af1c0eeda175ab&amp;scene=21#wechat_redirect" data-linktype="2">07.单细胞转录组数据处理之细胞亚群注释</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486278&amp;idx=1&amp;sn=91250ef733833ff00371818b215dc124&amp;scene=21#wechat_redirect" data-linktype="2">08.把拿到的亚群进行更细致的分群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247486287&amp;idx=1&amp;sn=49627c638ff9c04418282c53518aa7c7&amp;scene=21#wechat_redirect" data-linktype="2">09.单细胞转录组数据处理之细胞亚群比例比较</a></section></li></ul></section><p><br></p><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-type="gif" data-w="119" data-width="100%" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=gif"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247496689&amp;idx=1&amp;sn=c6a6daff2718aa80baca8831bdd1a5ed&amp;chksm=ea1cf573dd6b7c6518836ca55f3f90c50d8ae146a487eb2bbc652ea657bc5a9636db18499ef6&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">一模一样又有何难</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247496689&amp;idx=2&amp;sn=4882b2d46803c6ca59bcdcfda12a811f&amp;chksm=ea1cf573dd6b7c65b9f6f075b998d24ca27f36af02fad5135af67726953ea6d3e2b8b7c140a0&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" hasload="1">我以为我画错了</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247496670&amp;idx=1&amp;sn=db5008d2df90f6911fac44fc125dd829&amp;chksm=ea1cf55cdd6b7c4a65b199b7c5aadce66a30257e3a91823ecb077dc6508ffda9474651536342&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">这算是不一样吗</a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247496589&amp;idx=1&amp;sn=62661e8f6fe1f7ca77116170c367d710&amp;chksm=ea1cf50fdd6b7c19479c2853becde5b55b9887d8abe8c85dc879ad715bbbab2c72379563c4d4&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">OSCA单细胞数据分析笔记13—Multi-sample comparison</a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504010&amp;idx=2&amp;sn=0a82d588dce7e8a24340f5f35d90b372&amp;chksm=9b4b9031ac3c19278a0a7a888cf51ee1bdbaf6d4f3695df4f101731cfd2dc385259613b9a474&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生信入门课-2021第5期</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247504010&amp;idx=1&amp;sn=3839c684dde6f75684cb116984291986&amp;chksm=9b4b9031ac3c19270220e8846f3cd13a159ff4abbcda4ef2dbb9f16c2f6b045723b21f5cc051&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">数据挖掘（GEO,TCGA,单细胞）2021第5期</a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247501667&amp;idx=2&amp;sn=b05cb7181f632a557f0d78c6f31160d3&amp;chksm=9b4b87d8ac3c0ece42e259d2c39948dd6a1227b6c392213cb4564ae6a9926a6735f871da941b&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2" hasload="1">明码标价之共享96线程384G内存服务器</a></p></li></ul><p><img data-ratio="1" data-type="gif" data-w="240" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-type="jpeg" data-w="341" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-type="jpeg" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section><p><br></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/5UGtbF8TMc0od7y3mn4SWA",target="_blank" rel="noopener noreferrer">原文链接</a>
