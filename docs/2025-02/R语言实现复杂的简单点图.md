---
title: "R语言实现复杂的简单点图"
date: 2025-02-16T00:30:59Z
draft: ["false"]
tags: [
  "fetched",
  "R语言生信医学统计与科研"
]
categories: ["Acdemic"]
---
R语言实现复杂的简单点图 by R语言生信医学统计与科研
------
<div><section nodeleaf=""><img data-imgfileid="100003318" data-ratio="0.5570228091236494" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1RCR0bpEnVC1QIiaH52fKz9STdybI2CSOwkRS05FkJceYibXrCH2tloow/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="833" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1RCR0bpEnVC1QIiaH52fKz9STdybI2CSOwkRS05FkJceYibXrCH2tloow/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf=""><img data-imgfileid="100003317" data-ratio="0.4021005251312828" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1Z8uO9akUHP5UZJclr5rCtkHMs9RV9Rkf0RLib65KTwF5nFmicyibyFAHg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1333" type="block" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1Z8uO9akUHP5UZJclr5rCtkHMs9RV9Rkf0RLib65KTwF5nFmicyibyFAHg/640?wx_fmt=png&amp;from=appmsg"></span></section><section><span leaf="">本文作者对果蝇中的海藻糖合成酶（Tps1）进行了突变，然后观察了这种突变对果蝇翅膀的影响。下图2B显示了纯合Tps1突变体与杂合Tps1突变相比三种飞翼属性的百分比变化。数据根据苍蝇的性别分开。</span></section><section><span leaf="">接下来，我们来复现图2B。</span></section><section><span leaf="">一、准备数据</span></section><section><span leaf="">为了重新创建此图，我们首先加载所需的包和数据集。</span></section><section><ul><li><li><li><li><li><li></ul><pre data-lang="powershell"><code><span leaf=""><span>library(dplyr)</span></span></code><code><span leaf=""><span>library(ggplot2)</span></span></code><code><span leaf=""><span>library(ggprism)</span></span></code><code><span leaf=""><span>library(ggbeeswarm)</span></span></code><code><span leaf=""><span>library(rstatix)</span></span></code><code><span leaf=""><span>data</span><span>(</span><span>"wings"</span><span>)</span></span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="xml"><code><span leaf=""><span>head(wings)</span></span></code><code><span leaf=""><span>#&gt; # A tibble: 6 × 4</span></span></code><code><span leaf=""><span>#&gt;   sex   genotype  measure     percent.change</span></span></code><code><span leaf=""><span>#&gt;   </span><span><span>&lt;</span></span><span><span>fct</span></span><span><span>&gt;</span></span><span> </span><span><span>&lt;</span></span><span><span>fct</span></span><span><span>&gt;</span></span><span>     </span><span><span>&lt;</span></span><span><span>fct</span></span><span><span>&gt;</span></span><span>                </span><span><span>&lt;</span></span><span><span>dbl</span></span><span><span>&gt;</span></span></span></code><code><span leaf=""><span>#&gt; 1 male  Tps1MIC/+ wing.size            -2.45</span></span></code><code><span leaf=""><span>#&gt; 2 male  Tps1MIC/+ cell.size             6.33</span></span></code><code><span leaf=""><span>#&gt; 3 male  Tps1MIC/+ cell.number          -8.41</span></span></code><code><span leaf=""><span>#&gt; 4 male  Tps1MIC/+ wing.size            -1.14</span></span></code><code><span leaf=""><span>#&gt; 5 male  Tps1MIC/+ cell.size            -2.53</span></span></code><code><span leaf=""><span>#&gt; 6 male  Tps1MIC/+ cell.number           1.26</span></span></code></pre></section><section><span leaf="">数据已经是“长格式”，所以我们可以直接跳到绘图。但是，我们可以看到 measure 列中的文本不是标题大小写，因此我们需要快速执行一些字符串操作。</span></section><section><ul><li><li><li><li><li></ul><pre data-lang="sql"><code><span leaf=""><span># substitute </span><span>period</span><span> </span><span>with</span><span> space, </span><span>convert</span><span> </span><span>to</span><span> title </span><span>case</span><span>, </span><span>convert</span><span> back </span><span>to</span><span> factor</span></span></code><code><span leaf=""><span>wings$measure </span><span>&lt;-</span><span> wings$measure </span><span>%&gt;%</span><span> </span></span></code><code><span leaf=""><span>  gsub("\\.", " ", .) </span><span>%&gt;%</span><span> </span></span></code><code><span leaf=""><span>  tools::toTitleCase() </span><span>%&gt;%</span><span> </span></span></code><code><span leaf=""><span>  factor(., levels </span><span>=</span><span> c("Wing Size", "Cell Size", "Cell Number"))</span></span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="xml"><code><span leaf=""><span>head(wings)</span></span></code><code><span leaf=""><span>#&gt; # A tibble: 6 × 4</span></span></code><code><span leaf=""><span>#&gt;   sex   genotype  measure     percent.change</span></span></code><code><span leaf=""><span>#&gt;   </span><span><span>&lt;</span></span><span><span>fct</span></span><span><span>&gt;</span></span><span> </span><span><span>&lt;</span></span><span><span>fct</span></span><span><span>&gt;</span></span><span>     </span><span><span>&lt;</span></span><span><span>fct</span></span><span><span>&gt;</span></span><span>                </span><span><span>&lt;</span></span><span><span>dbl</span></span><span><span>&gt;</span></span></span></code><code><span leaf=""><span>#&gt; 1 male  Tps1MIC/+ Wing Size            -2.45</span></span></code><code><span leaf=""><span>#&gt; 2 male  Tps1MIC/+ Cell Size             6.33</span></span></code><code><span leaf=""><span>#&gt; 3 male  Tps1MIC/+ Cell Number          -8.41</span></span></code><code><span leaf=""><span>#&gt; 4 male  Tps1MIC/+ Wing Size            -1.14</span></span></code><code><span leaf=""><span>#&gt; 5 male  Tps1MIC/+ Cell Size            -2.53</span></span></code><code><span leaf=""><span>#&gt; 6 male  Tps1MIC/+ Cell Number           1.26</span></span></code></pre></section><section><span leaf="">二、基础绘图</span></section><section><span leaf="">现在我们只需要给 ggplot() 函数我们的数据。</span></section><section><ul><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># plot the wing measurement vs the percentage change compared to</span></span></code><code><span leaf=""><span># the heterozygous mutants</span></span></code><code><span leaf=""><span>p &lt;- ggplot(wings, aes(x = measure, y = percent.change))</span></span></code></pre></section><section><span leaf="">首先，我们将使用ggbeeswarm包中的geom_beeswarm()绘制具有随机抖动的单个数据点。这些点在这里看起来太分散了，但别担心，在接下来的步骤中，它们会变得更加紧凑。我们还将为这些点着色，并根据基因型调整它们的水平位置。</span></section><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="css"><code><span leaf=""><span># add the data points and fill according </span><span>to</span><span> the genotype</span></span></code><code><span leaf=""><span>p</span><span> &lt;- </span><span>p</span><span> + ggbeeswarm::</span><span>geom_beeswarm</span><span>(</span></span></code><code><span leaf=""><span>  </span><span>aes</span><span>(fill = genotype), </span></span></code><code><span leaf=""><span>  dodge.width = </span><span>0.9</span><span>, </span></span></code><code><span leaf=""><span>  shape = </span><span>21</span><span>,</span></span></code><code><span leaf=""><span>  cex = </span><span>3.5</span></span></code><code><span leaf=""><span>)</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1TubGLznI8Ij69Lg4yFWJMEYKsLOGXrEq5oF0aeTeh3cOqMVvJ6JssA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6153846153846154" data-s="300,640" data-type="png" data-w="702" type="block" data-imgfileid="100003319" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1TubGLznI8Ij69Lg4yFWJMEYKsLOGXrEq5oF0aeTeh3cOqMVvJ6JssA/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">现在我们想按照原始图中的性别来划分这些点。为此，我们可以使用facet_wrap()，然后将面板标题设置为男性和女性的Unicode符号。</span></section><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="cpp"><code><span leaf=""><span># separate data according to fly sex</span></span></code><code><span leaf=""><span>p &lt;- p + facet_wrap(</span></span></code><code><span leaf=""><span>    ~ sex, </span></span></code><code><span leaf=""><span>    scales = </span><span>"free"</span><span>,</span></span></code><code><span leaf=""><span>    labeller = labeller(sex = c(male = </span><span>"\u2642"</span><span>, female = </span><span>"\u2640"</span><span>))</span></span></code><code><span leaf=""><span>  )</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk14upwcNxoeKUhmlVOvqdfCX2CiaEZqicSWDHerl1NjwEJ8gBSwibOqPWrA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6041958041958042" data-s="300,640" data-type="png" data-w="715" type="block" data-imgfileid="100003320" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk14upwcNxoeKUhmlVOvqdfCX2CiaEZqicSWDHerl1NjwEJ8gBSwibOqPWrA/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">在y=0处，一条水平虚线覆盖在原始图中的点上。这是使用geom_hline()添加到我们的ggplot中的。</span></section><section><ul><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># plot a horiztonal line at y = 0 i.e. percentage change = 0</span></span></code><code><span leaf=""><span>p &lt;- p + geom_hline(yintercept = 0, linetype = 2, linewidth = 0.3)</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1h9oRcvS2b3wACOhyFpiaD8fPR3ZtTlqiaApImTHuooSia4xg7zTrOhgzw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6129943502824858" data-s="300,640" data-type="png" data-w="708" type="block" data-imgfileid="100003321" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1h9oRcvS2b3wACOhyFpiaD8fPR3ZtTlqiaApImTHuooSia4xg7zTrOhgzw/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">最上面是红色水平条，显示每组的平均值。这些可以使用具有geom_crossbar()功能的stat_summary()函数中的 geom 参数添加到ggplots中。</span></section><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span leaf=""><span># plot solid red lines at the mean of each group</span></span></code><code><span leaf=""><span>p &lt;- p + stat_summary(</span></span></code><code><span leaf=""><span>    geom = </span><span>"crossbar"</span><span>,</span></span></code><code><span leaf=""><span>    aes(fill = genotype),</span></span></code><code><span leaf=""><span>    </span><span><span>fun</span></span><span><span> = mean,</span></span></span></code><code><span leaf=""><span>    position = </span><span>position_dodge</span><span><span>(</span></span><span><span>0.9</span></span><span><span>)</span></span><span>,</span></span></code><code><span leaf=""><span>    colour = </span><span>"red"</span><span>,</span></span></code><code><span leaf=""><span>    linewidth = </span><span>0.4</span><span>, width = </span><span>0.7</span><span>,</span></span></code><code><span leaf=""><span>    show.legend = FALSE</span></span></code><code><span leaf=""><span>  )</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk18JjWhvEsia4xNROo1H3tP2j0F9Fw8xcBtIv7mXib7agAUAHgKkB8ckew/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6178977272727273" data-s="300,640" data-type="png" data-w="704" type="block" data-imgfileid="100003322" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk18JjWhvEsia4xNROo1H3tP2j0F9Fw8xcBtIv7mXib7agAUAHgKkB8ckew/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">要添加的最后一个与数据相关的元素是p值。为此，我们需要生成一个格式正确的p值表，然后将该表与ggprism的add_palue()函数一起使用。</span></section><section><span leaf="">生成p值表的最简单方法是使用rstatix（您也可以手动完成，但使用rstatix可以确保表的格式正确）。在这种情况下，我们按性别和翅膀测量对翅膀数据进行分组，然后测试翅膀大小/细胞大小/细胞数量的百分比变化是否由苍蝇基因型解释。我们还使用rstatix中的add_x_position()函数来确保括号末端具有正确的x轴位置（特别是xmin和xmax列）。最后，我们手动更改括号标签，使其按我们希望的方式显示。</span></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="css"><code><span leaf=""><span># perform t-tests </span><span>to</span><span> compare the means of the genotypes for each measure</span></span></code><code><span leaf=""><span># and correct the </span><span>p</span><span>-values for multiple testing</span></span></code><code><span leaf=""><span>wings_pvals &lt;- wings %&gt;%</span></span></code><code><span leaf=""><span>  group_by(sex, measure) %&gt;%</span></span></code><code><span leaf=""><span>  rstatix::</span><span>t_test</span><span>(</span></span></code><code><span leaf=""><span>    percent.change ~ genotype, </span></span></code><code><span leaf=""><span>    p.adjust.method = </span><span>"BH"</span><span>, </span></span></code><code><span leaf=""><span>    var.equal = TRUE, </span></span></code><code><span leaf=""><span>    ref.group = </span><span>"Tps1MIC/+"</span></span></code><code><span leaf=""><span>  ) %&gt;%</span></span></code><code><span leaf=""><span>  rstatix::</span><span>add_x_position</span><span>(x = </span><span>"measure"</span><span>, dodge = </span><span>0.9</span><span>) %&gt;% # dodge must match points</span></span></code><code><span leaf=""><span>  </span><span>mutate</span><span>(label = </span><span>c</span><span>(</span><span>"***"</span><span>, </span><span>"*"</span><span>, </span><span>"P = 0.26"</span><span>, </span><span>"***"</span><span>, </span><span>"***"</span><span>, </span><span>"P = 0.65"</span><span>))</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>wings_pvals</span></span></code></pre></section><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="xml"><code><span leaf=""><span>wings_pvals</span></span></code><code><span leaf=""><span>#&gt; # A tibble: 6 × 14</span></span></code><code><span leaf=""><span>#&gt;   sex    measure   .y.   group1 group2    n1    n2 statistic    df       p     x</span></span></code><code><span leaf=""><span>#&gt;   </span><span><span>&lt;</span></span><span><span>fct</span></span><span><span>&gt;</span></span><span>  </span><span><span>&lt;</span></span><span><span>fct</span></span><span><span>&gt;</span></span><span>     </span><span><span>&lt;</span></span><span><span>chr</span></span><span><span>&gt;</span></span><span> </span><span><span>&lt;</span></span><span><span>chr</span></span><span><span>&gt;</span></span><span>  </span><span><span>&lt;</span></span><span><span>chr</span></span><span><span>&gt;</span></span><span>  </span><span><span>&lt;</span></span><span><span>int</span></span><span><span>&gt;</span></span><span> </span><span><span>&lt;</span></span><span><span>int</span></span><span><span>&gt;</span></span><span>     </span><span><span>&lt;</span></span><span><span>dbl</span></span><span><span>&gt;</span></span><span> </span><span><span>&lt;</span></span><span><span>dbl</span></span><span><span>&gt;</span></span><span>   </span><span><span>&lt;</span></span><span><span>dbl</span></span><span><span>&gt;</span></span><span> </span><span><span>&lt;</span></span><span><span>dbl</span></span><span><span>&gt;</span></span></span></code><code><span leaf=""><span>#&gt; 1 male   Wing Size perc… Tps1M… Tps1M…    10    10     4.85     18 1.29e-4     1</span></span></code><code><span leaf=""><span>#&gt; 2 male   Cell Size perc… Tps1M… Tps1M…    10    10     2.65     18 1.61e-2     2</span></span></code><code><span leaf=""><span>#&gt; 3 male   Cell Num… perc… Tps1M… Tps1M…    10    10     1.17     18 2.58e-1     3</span></span></code><code><span leaf=""><span>#&gt; 4 female Wing Size perc… Tps1M… Tps1M…    10    10     7.05     18 1.41e-6     1</span></span></code><code><span leaf=""><span>#&gt; 5 female Cell Size perc… Tps1M… Tps1M…    10    10     4.59     18 2.28e-4     2</span></span></code><code><span leaf=""><span>#&gt; 6 female Cell Num… perc… Tps1M… Tps1M…    10    10     0.463    18 6.49e-1     3</span></span></code><code><span leaf=""><span>#&gt; # ℹ 3 more variables: xmin </span><span><span>&lt;</span></span><span><span>dbl</span></span><span><span>&gt;</span></span><span>, xmax </span><span><span>&lt;</span></span><span><span>dbl</span></span><span><span>&gt;</span></span><span>, label </span><span><span>&lt;</span></span><span><span>chr</span></span><span><span>&gt;</span></span></span></code></pre></section><section><span leaf="">有了这个p值表，我们现在可以添加p值。</span></section><section><ul><li><li><li><li><li><li></ul><pre data-lang="sql"><code><span leaf=""><span># plot the p</span><span>-</span><span>values</span><span> </span><span>with</span><span> brackets </span><span>for</span><span> </span><span>each</span><span> comparison</span></span></code><code><span leaf=""><span>p </span><span>&lt;-</span><span> p </span><span>+</span><span> add_pvalue(</span></span></code><code><span leaf=""><span>    wings_pvals, y </span><span>=</span><span> </span><span>10</span><span>, xmin </span><span>=</span><span> "xmin", xmax </span><span>=</span><span> "xmax", tip.length </span><span>=</span><span> </span><span>0</span><span>, </span></span></code><code><span leaf=""><span>    fontface </span><span>=</span><span> "italic", lineend </span><span>=</span><span> "round", bracket.size </span><span>=</span><span> </span><span>0.5</span></span></code><code><span leaf=""><span>  )</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1GToqUVltqYuNicyRe9yK8IcDI3yfiatmbGUFv3icToKOboFA1zDIX095Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6138613861386139" data-s="300,640" data-type="png" data-w="707" type="block" data-imgfileid="100003323" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1GToqUVltqYuNicyRe9yK8IcDI3yfiatmbGUFv3icToKOboFA1zDIX095Q/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">三、精细调整</span></section><section><span leaf="">有了与数据相关的元素，我们就可以改变整体的绘图主题和外观。首先，我们将应用theme_rism()。默认情况下，主题使用全粗体，因此我们将base_fontface=“plain”设置为所有文本的正常权重。</span></section><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="cpp"><code><span leaf=""><span># apply theme_prism()</span></span></code><code><span leaf=""><span>p &lt;- p + theme_prism(</span></span></code><code><span leaf=""><span>  base_fontface = </span><span>"plain"</span><span>, </span></span></code><code><span leaf=""><span>  base_line_size = 0.7, </span></span></code><code><span leaf=""><span>  base_family = </span><span>"Arial"</span></span></code><code><span leaf=""><span>)</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1OJKxlDqfZa2gictUr55IVKjEiciaDmlqkrAw7YEt7oWVCS2llnloKO2dw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6160458452722063" data-s="300,640" data-type="png" data-w="698" type="block" data-imgfileid="100003324" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1OJKxlDqfZa2gictUr55IVKjEiciaDmlqkrAw7YEt7oWVCS2llnloKO2dw/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">我们需要修复x轴文本，因为标签重叠，轴使用括号而不是直线。我们可以像原始图一样使用换行符来修复标签，还可以将轴参考线设置为guide_prism_brack()。</span></section><section><ul><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># change the x axis to brackets and add line breaks to the axis text</span></span></code><code><span leaf=""><span>p &lt;- p + scale_x_discrete(</span></span></code><code><span leaf=""><span>    guide = guide_prism_bracket(width = 0.15), </span></span></code><code><span leaf=""><span>    labels = scales::wrap_format(5)</span></span></code><code><span leaf=""><span>  )</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1PXNLs8ibzzcPx817XXJHNnGicJTvFn6TAkWI7tsQSr08VkSbnr3JKiaBQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5974754558204769" data-s="300,640" data-type="png" data-w="713" type="block" data-imgfileid="100003325" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1PXNLs8ibzzcPx817XXJHNnGicJTvFn6TAkWI7tsQSr08VkSbnr3JKiaBQ/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">现在我们将固定y轴，使其与原始图2B中的相同。我们还将guide设置为guide_prism_offset()，这样轴线就不会超出最外层的刻度标记。此外，我们将调整y轴标题。</span></section><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># adjust the y axis limits and change the style to 'offset'</span></span></code><code><span leaf=""><span>p &lt;- p + scale_y_continuous(</span></span></code><code><span leaf=""><span>    limits = c(-20, 12),</span></span></code><code><span leaf=""><span>    expand = c(0, 0),</span></span></code><code><span leaf=""><span>    breaks = seq(-20, 10, 5),</span></span></code><code><span leaf=""><span>    guide = "prism_offset"</span></span></code><code><span leaf=""><span>  ) + </span></span></code><code><span leaf=""><span>  labs(y = "% change")</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1AXCguI86XYoVMAE5yRIeR0JbibXs76qHMkWMSNGT9PWG6cyq2uKtgiaw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5748587570621468" data-s="300,640" data-type="png" data-w="708" type="block" data-imgfileid="100003326" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1AXCguI86XYoVMAE5yRIeR0JbibXs76qHMkWMSNGT9PWG6cyq2uKtgiaw/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">情节已经看起来很好了。但目标是尽可能地重现原作，所以我们将继续进行一些细微的调整。</span></section><section><span leaf="">我们需要使用scale_fil_manual()来更改点填充。我们还将在此步骤中修复图例文本的格式。</span></section><section><ul><li><li><li><li><li><li><li></ul><pre data-lang="cpp"><code><span leaf=""><span># change the point fill and adjust the legend text formatting</span></span></code><code><span leaf=""><span>p &lt;- p + scale_fill_manual(</span></span></code><code><span leaf=""><span>    values = c(</span><span>"#026FEE"</span><span>, </span><span>"#87FFFF"</span><span>), </span></span></code><code><span leaf=""><span>    labels = c(expression(</span><span>"Tps"</span><span>*1^italic(</span><span>"MIC"</span><span>)~</span><span>"/ +"</span><span>), </span></span></code><code><span leaf=""><span>               expression(</span><span>"Tps"</span><span>*1^italic(</span><span>"MIC"</span><span>)))</span></span></code><code><span leaf=""><span>  )</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1VaZb8RoxKQrEZib7bVxSeiaNs5LyXZQAIZich6I9x2P2GQGcIDjR2qlqQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.592436974789916" data-s="300,640" data-type="png" data-w="714" type="block" data-imgfileid="100003327" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1VaZb8RoxKQrEZib7bVxSeiaNs5LyXZQAIZich6I9x2P2GQGcIDjR2qlqQ/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">接下来，我们将在theme()函数的一次调用中同时做几件事：</span></section><ul><li><p><span leaf="">将图例移动到绘图下方</span></p></li><li><p><span leaf="">删除x轴标题</span></p></li><li><p><span leaf="">将男性和女性符号放大</span></p></li><li><p><span leaf="">使图例更加紧凑</span></p></li><li><p><span leaf="">减少图例符号和图例文本之间的间距</span></p></li></ul><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="powershell"><code><span leaf=""><span>p &lt;- p + theme(</span></span></code><code><span leaf=""><span>    legend.position = </span><span>"bottom"</span><span>,</span></span></code><code><span leaf=""><span>    axis.title.x = element_blank(),</span></span></code><code><span leaf=""><span>    strip.text = element_text(size = </span><span>14</span><span>),</span></span></code><code><span leaf=""><span>    legend.spacing.x = unit(</span><span>0</span><span>, </span><span>"pt"</span><span>),</span></span></code><code><span leaf=""><span>    legend.text = element_text(margin = margin(</span><span>r</span><span> = </span><span>20</span><span>))</span></span></code><code><span leaf=""><span>  )</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1PaaMpibh4NFsNAxibicGFNGZhwSaP6wibWXibmLXCwdHoBoBcmsPAXxyx9Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5683355886332883" data-s="300,640" data-type="png" data-w="739" type="block" data-imgfileid="100003328" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1PaaMpibh4NFsNAxibicGFNGZhwSaP6wibWXibmLXCwdHoBoBcmsPAXxyx9Q/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">原始图形在绘图区域的右下角还有一个标签，上面有重复次数。这对于分面来说有点棘手，需要创建一个虚拟的data.frame来获得正确的定位。</span></section><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span leaf=""><span># add n = </span><span>10</span><span> </span><span>as</span><span> a text </span><span>annotation</span></span></code><code><span leaf=""><span>p &lt;- p + geom_text(</span></span></code><code><span leaf=""><span>    </span><span>data</span><span> = </span><span>data</span><span>.frame(</span></span></code><code><span leaf=""><span>      sex = factor(</span><span>"female"</span><span>, levels = c(</span><span>"male"</span><span>, </span><span>"female"</span><span>)), </span></span></code><code><span leaf=""><span>      measure = </span><span>"Cell Number"</span><span>, </span></span></code><code><span leaf=""><span>      percent.change = -</span><span>18.5</span><span>, </span></span></code><code><span leaf=""><span>      lab = </span><span>"(n = 10)"</span></span></code><code><span leaf=""><span>    ), </span></span></code><code><span leaf=""><span>    aes(label = lab)</span></span></code><code><span leaf=""><span>  )</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1RtBHn9pCJB0ZBXkia2U3EHWor4wicT9nfL196RxXY5fcJcbtgZzenOxg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5168269230769231" data-s="300,640" data-type="png" data-w="832" type="block" data-imgfileid="100003329" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1RtBHn9pCJB0ZBXkia2U3EHWor4wicT9nfL196RxXY5fcJcbtgZzenOxg/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">最后要做的就是使用guide_legend()中的override.aes参数将图例符号放大一点。</span></section><section><ul><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># make the points larger in the legend only</span></span></code><code><span leaf=""><span>p &lt;- p + guides(fill = guide_legend(override.aes = list(size = 3)))</span></span></code><code><span leaf=""><span>p</span></span></code></pre></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1HCLJXZAT5Dr82eYfuuOe213hkKzz3ibGslm9xjW1l3Y9kdsVGdUo7ibQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5904628330995793" data-s="300,640" data-type="png" data-w="713" type="block" data-imgfileid="100003330" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1HCLJXZAT5Dr82eYfuuOe213hkKzz3ibGslm9xjW1l3Y9kdsVGdUo7ibQ/640?wx_fmt=png&amp;from=appmsg"></section><section><span leaf="">到此，我们基本完成了复刻。</span></section><section><span leaf="">以下是完整代码：</span></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="css"><code><span leaf=""><span>wings_pvals &lt;- wings %&gt;%</span></span></code><code><span leaf=""><span>  group_by(sex, measure) %&gt;%</span></span></code><code><span leaf=""><span>  rstatix::</span><span>t_test</span><span>(</span></span></code><code><span leaf=""><span>    percent.change ~ genotype, </span></span></code><code><span leaf=""><span>    p.adjust.method = </span><span>"BH"</span><span>, </span></span></code><code><span leaf=""><span>    var.equal = TRUE, </span></span></code><code><span leaf=""><span>    ref.group = </span><span>"Tps1MIC/+"</span></span></code><code><span leaf=""><span>  ) %&gt;%</span></span></code><code><span leaf=""><span>  rstatix::</span><span>add_x_position</span><span>(x = </span><span>"measure"</span><span>, dodge = </span><span>0.9</span><span>) %&gt;% # dodge must match points</span></span></code><code><span leaf=""><span>  </span><span>mutate</span><span>(label = </span><span>c</span><span>(</span><span>"***"</span><span>, </span><span>"*"</span><span>, </span><span>"P = 0.26"</span><span>, </span><span>"***"</span><span>, </span><span>"***"</span><span>, </span><span>"P = 0.65"</span><span>))</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>ggplot</span><span>(wings, </span><span>aes</span><span>(x = measure, y = percent.change)) + </span></span></code><code><span leaf=""><span>  ggbeeswarm::</span><span>geom_beeswarm</span><span>(</span><span>aes</span><span>(fill = genotype), dodge.width = </span><span>0.9</span><span>, shape = </span><span>21</span><span>) + </span></span></code><code><span leaf=""><span>  </span><span>facet_wrap</span><span>(~ sex, scales = </span><span>"free"</span><span>,</span></span></code><code><span leaf=""><span>    labeller = </span><span>labeller</span><span>(sex = </span><span>c</span><span>(male = </span><span>"\u2642"</span><span>, female = </span><span>"\u2640"</span><span>))) + </span></span></code><code><span leaf=""><span>  </span><span>geom_hline</span><span>(yintercept = </span><span>0</span><span>, linetype = </span><span>2</span><span>, linewidth = </span><span>0.3</span><span>) + </span></span></code><code><span leaf=""><span>  </span><span>stat_summary</span><span>(geom = </span><span>"crossbar"</span><span>, </span><span>aes</span><span>(fill = genotype),fun = mean,</span></span></code><code><span leaf=""><span>    position = </span><span>position_dodge</span><span>(</span><span>0.9</span><span>), colour = </span><span>"red"</span><span>, linewidth = </span><span>0.4</span><span>, width = </span><span>0.7</span><span>,</span></span></code><code><span leaf=""><span>    show.legend = FALSE) + </span></span></code><code><span leaf=""><span>   </span><span>add_pvalue</span><span>(wings_pvals, y = </span><span>10</span><span>, xmin = </span><span>"xmin"</span><span>, xmax = </span><span>"xmax"</span><span>, </span></span></code><code><span leaf=""><span>              tip.length = </span><span>0</span><span>, fontface = </span><span>"italic"</span><span>, </span></span></code><code><span leaf=""><span>              lineend = </span><span>"round"</span><span>, bracket.size = </span><span>0.5</span><span>) + </span></span></code><code><span leaf=""><span>  </span><span>theme_prism</span><span>(base_fontface = </span><span>"plain"</span><span>, base_line_size = </span><span>0.7</span><span>, </span></span></code><code><span leaf=""><span>              base_family = </span><span>"Arial"</span><span>) + </span></span></code><code><span leaf=""><span>  </span><span>scale_x_discrete</span><span>(guide = </span><span>guide_prism_bracket</span><span>(width = </span><span>0.15</span><span>), </span></span></code><code><span leaf=""><span>                   labels = scales::</span><span>wrap_format</span><span>(</span><span>5</span><span>)) + </span></span></code><code><span leaf=""><span>  </span><span>scale_y_continuous</span><span>(limits = </span><span>c</span><span>(-</span><span>20</span><span>, </span><span>12</span><span>), expand = </span><span>c</span><span>(</span><span>0</span><span>, </span><span>0</span><span>),</span></span></code><code><span leaf=""><span>    breaks = </span><span>seq</span><span>(-</span><span>20</span><span>, </span><span>10</span><span>, </span><span>5</span><span>), guide = </span><span>"prism_offset"</span><span>) + </span></span></code><code><span leaf=""><span>  </span><span>labs</span><span>(y = </span><span>"% change"</span><span>) + </span></span></code><code><span leaf=""><span>  </span><span>scale_fill_manual</span><span>(values = </span><span>c</span><span>(</span><span>"#026FEE"</span><span>, </span><span>"#87FFFF"</span><span>), </span></span></code><code><span leaf=""><span>    labels = </span><span>c</span><span>(</span><span>expression</span><span>(</span><span>"Tps"</span><span>*</span><span>1</span><span>^</span><span>italic</span><span>(</span><span>"MIC"</span><span>)~</span><span>"/ +"</span><span>), </span></span></code><code><span leaf=""><span>               </span><span>expression</span><span>(</span><span>"Tps"</span><span>*</span><span>1</span><span>^</span><span>italic</span><span>(</span><span>"MIC"</span><span>)))) + </span></span></code><code><span leaf=""><span>  </span><span>theme</span><span>(legend.position = </span><span>"bottom"</span><span>,</span></span></code><code><span leaf=""><span>        axis.title.x = </span><span>element_blank</span><span>(),</span></span></code><code><span leaf=""><span>        strip.text = </span><span>element_text</span><span>(size = </span><span>14</span><span>),</span></span></code><code><span leaf=""><span>        legend.spacing.x = </span><span>unit</span><span>(</span><span>0</span><span>, </span><span>"pt"</span><span>),</span></span></code><code><span leaf=""><span>        legend.text = </span><span>element_text</span><span>(margin = </span><span>margin</span><span>(r = </span><span>20</span><span>))) + </span></span></code><code><span leaf=""><span>  </span><span>geom_text</span><span>(data = data.</span><span>frame</span><span>(sex = </span><span>factor</span><span>(</span><span>"female"</span><span>, levels = </span><span>c</span><span>(</span><span>"male"</span><span>, </span><span>"female"</span><span>)), </span></span></code><code><span leaf=""><span>                              measure = </span><span>"Cell Number"</span><span>, </span></span></code><code><span leaf=""><span>                              percent.change = -</span><span>18.5</span><span>, </span></span></code><code><span leaf=""><span>                              lab = </span><span>"(n = 10)"</span><span>), </span></span></code><code><span leaf=""><span>            </span><span>aes</span><span>(label = lab)) + </span></span></code><code><span leaf=""><span>  </span><span>guides</span><span>(fill = </span><span>guide_legend</span><span>(override.aes = </span><span>list</span><span>(size = </span><span>3</span><span>)))</span></span></code></pre></section><section><span leaf="">彩蛋，附加一个图<img data-src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/assets/Expression/Expression_45@2x.png" data-ratio="1" data-w="20" src="https://res.wx.qq.com/t/wx_fed/we-emoji/res/assets/Expression/Expression_45@2x.png">：</span></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1y6HIiaOB6vrkZRLBslPLLPUpj948UWyCpxv8wW015FgeNNWBb1sDzRA/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.3261538461538462" data-s="300,640" data-type="png" data-w="325" type="block" data-imgfileid="100003331" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk1y6HIiaOB6vrkZRLBslPLLPUpj948UWyCpxv8wW015FgeNNWBb1sDzRA/640?wx_fmt=png&amp;from=appmsg"></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="kotlin"><code><span leaf=""><span>library(ggrepel)</span></span></code><code><span leaf=""><span>library(ggprism)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>set</span><span>.seed(</span><span>42</span><span>)</span></span></code><code><span leaf=""><span>d &lt;- </span><span>data</span><span>.frame(</span></span></code><code><span leaf=""><span>  x1 = </span><span>1</span><span>,</span></span></code><code><span leaf=""><span>  y1 = rnorm(</span><span>10</span><span>),</span></span></code><code><span leaf=""><span>  x2 = </span><span>2</span><span>,</span></span></code><code><span leaf=""><span>  y2 = rnorm(</span><span>10</span><span>),</span></span></code><code><span leaf=""><span>  lab = state.name[</span><span>1</span><span>:</span><span>10</span><span>]</span></span></code><code><span leaf=""><span>)</span></span></code><code><span leaf=""><br></span></code><code><span leaf=""><span>ggplot(d, aes(</span><span>as</span><span>.factor(x1), y1, xend = </span><span>as</span><span>.factor(x2), yend = y2, label = lab, col = lab)) +</span></span></code><code><span leaf=""><span>  geom_segment(size = </span><span>1</span><span>) +</span></span></code><code><span leaf=""><span>  guides(color = </span><span>"none"</span><span>) +</span></span></code><code><span leaf=""><span>  geom_text_repel(</span></span></code><code><span leaf=""><span>    aes(x1, y1), nudge_x = -</span><span>0.2</span><span>, direction = </span><span>"y"</span><span>, hjust = </span><span>"right"</span></span></code><code><span leaf=""><span>  ) +</span></span></code><code><span leaf=""><span>  geom_text_repel(</span></span></code><code><span leaf=""><span>    aes(x2, y2), nudge_x = </span><span>0.2</span><span>, direction = </span><span>"y"</span><span>, hjust = </span><span>"left"</span></span></code><code><span leaf=""><span>  ) +</span></span></code><code><span leaf=""><span>  theme_prism() +</span></span></code><code><span leaf=""><span>  theme(</span></span></code><code><span leaf=""><span>    axis.title.x = element_blank(),</span></span></code><code><span leaf=""><span>    axis.title.y = element_blank()</span></span></code><code><span leaf=""><span>  ) +</span></span></code><code><span leaf=""><span>  scale_y_continuous(</span></span></code><code><span leaf=""><span>    guide = </span><span>"prism_offset"</span><span>,</span></span></code><code><span leaf=""><span>    limits = c(-</span><span>4</span><span>, </span><span>4</span><span>),</span></span></code><code><span leaf=""><span>    breaks = seq(-</span><span>3</span><span>, </span><span>3</span><span>, </span><span>1</span><span>)</span></span></code><code><span leaf=""><span>  ) +</span></span></code><code><span leaf=""><span>  scale_x_discrete(</span></span></code><code><span leaf=""><span>    # guide = </span><span>"prism_bracket"</span><span>,</span></span></code><code><span leaf=""><span>    guide = guide_prism_bracket(width = </span><span>0.1</span><span>),</span></span></code><code><span leaf=""><span>    breaks = </span><span>1</span><span>:</span><span>2</span><span>, </span></span></code><code><span leaf=""><span>    labels = c(</span><span>"Dimension 1"</span><span>, </span><span>"Dimension 2"</span><span>),</span></span></code><code><span leaf=""><span>    expand = expansion(mult = </span><span>0.5</span><span>)</span></span></code><code><span leaf=""><span>  ) </span></span></code></pre></section><section><span leaf="">小结图</span></section><section nodeleaf=""><img data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk18P7fZ1XZbPxRxnZV4PuNY9moh1J60icAcnZUKhCDLus5tfManfm7svw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.40233236151603496" data-s="300,640" data-type="png" data-w="1029" type="block" data-imgfileid="100003332" src="https://mmbiz.qpic.cn/sz_mmbiz_png/e4qfpSBibv0D2lRtDf5s7DZubALkVMyk18P7fZ1XZbPxRxnZV4PuNY9moh1J60icAcnZUKhCDLus5tfManfm7svw/640?wx_fmt=png&amp;from=appmsg"></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/r2hhlKdr0MLgSl5sBf5RmA",target="_blank" rel="noopener noreferrer">原文链接</a>
