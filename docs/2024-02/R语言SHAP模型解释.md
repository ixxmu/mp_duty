---
title: "Rè¯­è¨€SHAPæ¨¡å‹è§£é‡Š"
date: 2024-02-28T04:00:48Z
draft: ["false"]
tags: [
  "fetched",
  "åŒ»å­¦å’Œç”Ÿä¿¡ç¬”è®°"
]
categories: ["Acdemic"]
---
Rè¯­è¨€SHAPæ¨¡å‹è§£é‡Š by åŒ»å­¦å’Œç”Ÿä¿¡ç¬”è®°
------
<div><section><span>å…³æ³¨å…¬ä¼—å·ï¼Œå‘é€</span><strong>Rè¯­è¨€</strong><span>æˆ–</span><strong>python</strong><span>ï¼Œå¯è·å–èµ„æ–™</span><span></span></section><section><mp-common-profile data-pluginname="mpprofile" data-id="MzUzOTQzNzU0NA==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R9YDc8IDhqWAHTrZsMuhDpFlw4scqOl1ZVWpeY77cdibaSzPeGALfkEhdVpwHzVibHCRSYZg4csB43g/0?wx_fmt=png" data-nickname="åŒ»å­¦å’Œç”Ÿä¿¡ç¬”è®°" data-alias="yxhsxbj" data-signature="å¤–ç§‘åŒ»ç”ŸğŸ‘¨â€âš•ï¸çš„Rè¯­è¨€å’Œç”Ÿä¿¡å­¦ä¹ ğŸ”–" data-from="2" data-weuitheme="light"></mp-common-profile></section><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer" label="edit by 135editor"><section data-role="paragraph"><section data-role="outer"><section data-role="outer" label="edit by 135editor"><section data-tools="135ç¼–è¾‘å™¨" data-id="28"><p data-brushtype="text" hm_fix="440:185"><span>ğŸ’¡ä¸“æ³¨Rè¯­è¨€åœ¨ğŸ©ºç”Ÿç‰©åŒ»å­¦ä¸­çš„ä½¿ç”¨</span></p></section></section></section></section></section><hr><section data-tool="mdniceç¼–è¾‘å™¨" data-website="https://www.mdnice.com"><p data-tool="mdniceç¼–è¾‘å™¨"><span><span>è®¾ä¸ºâ€œ</span><strong><span>æ˜Ÿæ ‡</span></strong><span>â€ï¼Œç²¾å½©ä¸é”™è¿‡</span></span><br></p><hr><p data-tool="mdniceç¼–è¾‘å™¨"><span><strong></strong></span></p><section data-tool="mdniceç¼–è¾‘å™¨" data-website="https://www.mdnice.com"><p data-tool="mdniceç¼–è¾‘å™¨">åˆ†è§£è§£é‡Šé«˜åº¦ä¾èµ–äºé¢„æµ‹å˜é‡çš„é¡ºåºï¼Œè§£å†³æ–¹æ³•æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯é€šè¿‡æŠŠæœ€é‡è¦çš„å˜é‡æ”¾åœ¨æœ€å‰é¢ï¼Œå¦ä¸€ç§å°±æ˜¯è¯†åˆ«å˜é‡é—´çš„äº¤äº’ä½œç”¨å¹¶ä½¿ç”¨ä¸“é—¨çš„æ–¹æ³•ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">ä½†æ˜¯ä»¥ä¸Šä¸¤ç§æ–¹æ³•éƒ½ä¸æ˜¯å¾ˆå¥½ã€‚æ‰€ä»¥å‡ºç°äº†<strong>SHAP</strong>(SHapley AdditiveexPlanations)ï¼Œä¸­æ–‡ç§°ä¸º<strong>ShaplyåŠ æ€§è§£é‡Š</strong>ã€‚SHapleyåŠ æ€§è§£é‡Šï¼ˆSHAPï¼‰åŸºäºShapleyï¼ˆäººåï¼‰åœ¨åšå¼ˆè®ºä¸­æå‡ºçš„â€œShapleyå€¼ï¼ˆShaply-valuesï¼‰â€ã€‚SHAPæ˜¯ä¸“ä¸ºé¢„æµ‹æ¨¡å‹è®¾è®¡çš„æ–¹æ³•çš„é¦–å­—æ¯ç¼©å†™è¯ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">ç®€å•æ¥è¯´ï¼ŒShaplyåŠ æ€§è§£é‡Šå°±æ˜¯<strong>è®¡ç®—å˜é‡é—´çš„æ‰€æœ‰å¯èƒ½çš„æ’åˆ—</strong>ï¼Œç„¶åè®¡ç®—æ¯ä¸ªå˜é‡çš„å¹³å‡è´¡çŒ®ï¼ˆæˆ–è€…å«å¹³å‡å½’å› ï¼‰ã€‚è¿™ç§æ–¹æ³•å«åšé‡æ’ï¼ˆpermutationï¼‰SHAPæˆ–è€…ç½®æ¢SHAPã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">ä½œä¸ºä¸€ç§ä¸æ¨¡å‹æ— å…³ï¼ˆmodel-agnosticï¼‰çš„è§£é‡Šï¼Œè¿™ç§æ–¹æ³•æ˜¯é€‚ç”¨äºä»»ä½•æ¨¡å‹çš„ï¼Œæœ¬æ–‡æ˜¯ä»¥éšæœºæ£®æ—æ¨¡å‹ä¸ºä¾‹è¿›è¡Œæ¼”ç¤ºçš„ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">å¦‚æœå·²ç»äº†è§£äº†åˆ†è§£è§£é‡Šçš„åŸç†ï¼Œé‚£ä¹ˆè¿™é‡Œçš„é‡æ’SHAPå°±éå¸¸å¥½ç†è§£äº†ã€‚å®ƒçš„è¯¦ç»†å…¬å¼è®¡ç®—è¿‡ç¨‹è¿™é‡Œå°±ä¸å±•ç¤ºäº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±äº†è§£ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">ä»Šå¤©å…ˆä»‹ç»ä¸‹Rä¸­çš„instance-levelçš„SHAPï¼Œä¾ç„¶æ˜¯ä½¿ç”¨<code>DALEX</code>ï¼Œ3è¡Œä»£ç è§£å†³ï¼å…³äºSHAPçš„å†…å®¹å…¶å®è¿˜æœ‰éå¸¸å¤šå“ˆï¼Œä»¥åå†æ…¢æ…¢ä»‹ç»ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">å…¬ä¼—å·åå°å›å¤<strong>shap</strong>å³å¯è·å–SHAPè§£é‡Šåˆé›†ã€‚</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code><span>library</span>(DALEX)<br>data(<span>"titanic_imputed"</span>)<br><br><span>#Â ç»“æœå˜é‡å˜æˆå› å­å‹</span><br>titanic_imputed$survivedÂ &lt;-Â factor(titanic_imputed$survived)<br><br>dim(titanic_imputed)<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>[1] 2207    8<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>str(titanic_imputed)<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>'data.frame':   2207 obs. of  8 variables:<br> $ gender  : Factor w/ 2 levels "female","male": 2 2 2 1 1 2 2 1 2 2 ...<br> $ age     : num  42 13 16 39 16 25 30 28 27 20 ...<br> $ class   : Factor w/ 7 levels "1st","2nd","3rd",..: 3 3 3 3 3 3 2 2 3 3 ...<br> $ embarked: Factor w/ 4 levels "Belfast","Cherbourg",..: 4 4 4 4 4 4 2 2 2 4 ...<br> $ fare    : num  7.11 20.05 20.05 20.05 7.13 ...<br> $ sibsp   : num  0 0 1 1 0 0 1 1 0 0 ...<br> $ parch   : num  0 2 1 1 0 0 0 0 0 0 ...<br> $ survived: Factor w/ 2 levels "0","1": 1 1 1 2 2 2 1 2 2 2 ...<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">å»ºç«‹ä¸€ä¸ªéšæœºæ£®æ—æ¨¡å‹ï¼š</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code><span>library</span>(randomForest)<br><br>set.seed(<span>123</span>)<br>titanic_rfÂ &lt;-Â randomForest(survivedÂ ~Â .,Â dataÂ =Â titanic_imputed)<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">å»ºç«‹è§£é‡Šå™¨ï¼š</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code>explain_rfÂ &lt;-Â DALEX::explain(modelÂ =Â titanic_rf,<br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â dataÂ =Â titanic_imputed[,-<span>8</span>],<br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â yÂ =Â titanic_imputed$survivedÂ ==Â <span>1</span>,<br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â labelÂ =Â <span>"randomforest"</span><br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â )<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>Preparation of a new explainer is initiated<br>  -&gt; model label       :  randomforest <br>  -&gt; data              :  2207  rows  7  cols <br>  -&gt; target variable   :  2207  values <br>  -&gt; predict function  :  yhat.randomForest  will be used (  default  )<br>  -&gt; predicted values  :  No value for predict function target column. (  default  )<br>  -&gt; model_info        :  package randomForest , ver. 4.7.1.1 , task classification (  default  ) <br>  -&gt; model_info        :  Model info detected classification task but 'y' is a logical . Converted to numeric.  (  NOTE  )<br>  -&gt; predicted values  :  numerical, min =  0 , mean =  0.2350131 , max =  1  <br>  -&gt; residual function :  difference between y and yhat (  default  )<br>  -&gt; residuals         :  numerical, min =  -0.886 , mean =  0.08714363 , max =  1  <br>  A new explainer has been created!<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">ä½¿ç”¨<code>predict_parts</code>è§£é‡Šï¼Œæ–¹æ³•é€‰æ‹©SHAPï¼š</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code>shap_rfÂ &lt;-Â predict_parts(explainerÂ =Â explain_rf,<br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â new_observationÂ =Â titanic_imputed[<span>15</span>,-<span>8</span>],<br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â typeÂ =Â <span>"shap"</span>,<br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â BÂ =Â <span>25</span>Â <span>#Â é€‰æ‹©å¤šå°‘ä¸ªæ’åˆ—ç»„åˆ</span><br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â )<br><br>shap_rf<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>                                              min           q1      median<br>randomforest: age = 18               -0.010423199  0.006507476  0.02422882<br>randomforest: class = 3rd            -0.201079293 -0.126367830 -0.06920344<br>randomforest: embarked = Southampton -0.022489352 -0.010681242 -0.01012868<br>randomforest: fare = 9.07            -0.154593566 -0.058991844 -0.02455460<br>randomforest: gender = female         0.293671047  0.384545537  0.43246217<br>randomforest: parch = 1              -0.031936565  0.080251817  0.10775804<br>randomforest: sibsp = 0               0.008140462  0.014347757  0.02413484<br>                                             mean            q3         max<br>randomforest: age = 18                0.067138668  0.1240188038  0.19714907<br>randomforest: class = 3rd            -0.090971092 -0.0672904395 -0.01977254<br>randomforest: embarked = Southampton -0.006165292 -0.0006504304  0.01238423<br>randomforest: fare = 9.07            -0.037531346 -0.0193303126  0.04265791<br>randomforest: gender = female         0.436079928  0.4822868147  0.54142003<br>randomforest: parch = 1               0.092327612  0.1308228364  0.17770367<br>randomforest: sibsp = 0               0.028108382  0.0478994110  0.05099230<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">ç”»å›¾ï¼š</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code>plot(shap_rf)<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100017301" data-ratio="0.7142857142857143" data-type="png" data-w="672" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7ASceOia9QGFUPTXicM4LludNw5NpDMlrEYyd8gKjgOcO3KribIAxlOqPmw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7ASceOia9QGFUPTXicM4LludNw5NpDMlrEYyd8gKjgOcO3KribIAxlOqPmw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdniceç¼–è¾‘å™¨">è¿™ä¸ªå›¾ä¸­çš„ç®±çº¿å›¾è¡¨ç¤ºé¢„æµ‹å˜é‡åœ¨æ‰€æœ‰æ’åˆ—çš„åˆ†å¸ƒæƒ…å†µï¼Œæ¡å½¢å›¾è¡¨ç¤ºå¹³å‡å€¼ï¼Œä¹Ÿå°±æ˜¯shaplyå€¼ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">è¿˜å¯ä»¥ä¸å±•ç¤ºç®±çº¿å›¾ï¼š</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code>plot(shap_rf,Â show_boxplotsÂ =Â <span>F</span>)<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100017302" data-ratio="0.7142857142857143" data-type="png" data-w="672" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7AycobWs2KicVg1fYRO5O8GC5cggQ8pHj4rEOrwkHfCgQJlbsx4MhEFwg/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7AycobWs2KicVg1fYRO5O8GC5cggQ8pHj4rEOrwkHfCgQJlbsx4MhEFwg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdniceç¼–è¾‘å™¨"><code>DALEX</code>ä¸­çš„<code>plot</code>å‡½æ•°å¯¹<code>ggplot2</code>çš„åŒ…è£…ï¼Œæ˜¯å¯ä»¥ç›´æ¥è¿æ¥<code>ggplot2</code>è¯­æ³•çš„ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æå–æ•°æ®è‡ªå·±ç”»å›¾ã€‚</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code><span>library</span>(tidyverse)<br><span>library</span>(ggsci)<br><br>shap_rfÂ %&gt;%Â <br>Â Â as.data.frame()Â %&gt;%Â <br>Â Â mutate(mean_conÂ =Â mean(contribution),Â .byÂ =Â variable)Â %&gt;%Â <br>Â Â mutate(variableÂ =Â fct_reorder(variable,Â abs(mean_con)))Â %&gt;%Â <br>Â Â ggplot()Â +<br>Â Â geom_bar(dataÂ =Â \(x)Â distinct(x,variable,mean_con),<br>Â Â Â Â Â Â Â Â Â Â Â aes(mean_con,Â variable,fill=Â mean_conÂ &gt;Â <span>0</span>),Â alphaÂ =Â <span>0.5</span>,<br>Â Â Â Â Â Â Â Â Â Â Â statÂ =Â <span>"identity"</span>)+<br>Â Â geom_boxplot(aes(contribution,variable,fill=Â mean_conÂ &gt;Â <span>0</span>),Â widthÂ =Â <span>0.4</span>)+<br>Â Â scale_fill_lancet()+<br>Â Â labs(yÂ =Â <span>NULL</span>)+<br>Â Â theme(legend.positionÂ =Â <span>"none"</span>)<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100017303" data-ratio="0.7142857142857143" data-type="png" data-w="672" data-src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7AichpZxuJhNrYHF6EZ6tDLRSd7BicSd48dviajYhFvZTwBbNUlGH0icJ1lA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_png/tpAC6lR84R8WE3ibcwhXvgygSU49iapg7AichpZxuJhNrYHF6EZ6tDLRSd7BicSd48dviajYhFvZTwBbNUlGH0icJ1lA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdniceç¼–è¾‘å™¨">OVERï¼</p><p data-tool="mdniceç¼–è¾‘å™¨">SHAPçš„ä½¿ç”¨ç‡éå¸¸é«˜ï¼Œåœ¨Rè¯­è¨€ä¸­ä¹Ÿæœ‰éå¸¸å¤šå®ç°SHAPçš„åŒ…ï¼Œæˆ‘ä¼šå†™å¤šç¯‡æ¨æ–‡ï¼ŒæŠŠå¸¸ç”¨çš„å…¨éƒ½ä»‹ç»ä¸€éã€‚</p></section><hr><blockquote><p><span><strong>è”ç³»æˆ‘ä»¬ï¼Œå…³æ³¨æˆ‘ä»¬</strong></span></p><ol><li><section>å…è´¹QQäº¤æµç¾¤1ï¼š613637742</section></li><li><section>å…è´¹QQäº¤æµç¾¤2ï¼š608720452</section></li><li><section>å…¬ä¼—å·æ¶ˆæ¯ç•Œé¢å…³äºä½œè€…è·å–è”ç³»æ–¹å¼</section></li><li><section>çŸ¥ä¹ã€CSDNã€ç®€ä¹¦åŒåè´¦å·</section></li><li><section>å“”å“©å“”å“©ï¼šé˜¿è¶Šå°±æ˜¯æˆ‘</section></li></ol></blockquote></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/vibNxgcs3MyduoNacuW7Bw",target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a>
