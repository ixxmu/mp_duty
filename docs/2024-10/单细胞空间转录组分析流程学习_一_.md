---
title: "单细胞空间转录组分析流程学习(一)"
date: 2024-10-17T23:49:55Z
draft: ["false"]
tags: [
  "fetched",
  "生信方舟"
]
categories: ["Acdemic"]
---
单细胞空间转录组分析流程学习(一) by 生信方舟
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">本次采用GSE181300数据集，包含了8个头颈部鳞癌患者的数据<img data-imgfileid="100002468" data-ratio="1.0866666666666667" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQC2SSeVQODNIHnIJTkmdu59ILaiba9eqhNHm6kmAGQ3TsZnMZ0KYPOTLQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQC2SSeVQODNIHnIJTkmdu59ILaiba9eqhNHm6kmAGQ3TsZnMZ0KYPOTLQ/640?wx_fmt=png&amp;from=appmsg">1、CSV（Comma-Separated Values）：</p><p data-tool="mdnice编辑器">常用于存储基因表达矩阵的位置信息或细胞/位置的元数据。例如，tissue_positions_list.csv 文件包含每个条形码的位置坐标、在组织切片上的位置、组织的像素坐标等信息，用于在空间图像上定位每个点。</p><p data-tool="mdnice编辑器">2、H5（Hierarchical Data Format Version 5）：</p><p data-tool="mdnice编辑器">通常包含压缩的基因表达矩阵。filtered_feature_bc_matrix.h5 文件可以包含细胞条形码、基因和对应的表达值。这种格式高效地存储大量数据，便于在 R 和 Python 等程序中快速加载和读取。</p><p data-tool="mdnice编辑器">3、HTML（HyperText Markup Language）：</p><p data-tool="mdnice编辑器">用于存储交互式报告或分析结果。一些空间转录组分析工具会生成 HTML 文件，用于可视化结果、查看细胞类型分布、表达图谱等。通常是报告的一部分，方便研究人员查看结果。</p><p data-tool="mdnice编辑器">4、JSON（JavaScript Object Notation）：</p><p data-tool="mdnice编辑器">常用于存储空间缩放因子等配置信息。scalefactors_json.json 文件包含高分辨率和低分辨率图像的缩放比例，用于将空间坐标映射到图像中的像素坐标。例如，它会定义不同分辨率下组织切片的位置，以保证图像在多分辨率下的准确显示。</p><p data-tool="mdnice编辑器">5、MTX（Matrix Market Format）：一种稀疏矩阵格式，通常用于基因表达矩阵。在空间转录组中，基因表达矩阵可以存储为 .mtx 文件，配合 .barcodes.tsv 和 .genes.tsv 文件，以节省存储空间并快速读取。MTX 文件存储稀疏矩阵的非零元素位置和值。</p><p data-tool="mdnice编辑器">6、PNG（Portable Network Graphics）：</p><p data-tool="mdnice编辑器">常用于存储组织切片的图像。tissue_lowres_image.png 或 tissue_hires_image.png 文件分别包含低分辨率或高分辨率的组织切片图像，用于空间定位和可视化。通常这些图像是空间表达数据的基础，用于将基因表达结果映射到实际组织的结构上。</p><p data-tool="mdnice编辑器">7、TSV（Tab-Separated Values）：</p><p data-tool="mdnice编辑器">用于存储条形码和基因信息。barcodes.tsv 和 genes.tsv 文件分别存储单个位置的条形码以及基因的信息，与 mtx 文件配合使用。这些文件提供了空间转录组中每个位置的标识和相应基因的列表，是空间基因表达数据的重要组成部分。</p><h4 data-tool="mdnice编辑器"><span></span><span>分析步骤</span><span></span></h4><p data-tool="mdnice编辑器">本次主要是涉及数据读取、部分流程探索及报错解决~</p><h5 data-tool="mdnice编辑器"><span></span><span>1.导入</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(Seurat)<br><span>library</span>(tidyverse)<br><span>library</span>(sloop)<br><br><span>## 10x Visium</span><br>sce_s &lt;- Load10X_Spatial(data.dir = <span>"./RawData/"</span>,<br>+                            filename = <span>"GSM5494475_HNSCC201125T04_filtered_feature_bc_matrix.h5"</span>)<br></code></pre><p data-tool="mdnice编辑器">出现了如下的报错，笔者把文件下载之后直接丢到了RawData文件中之后进行了解压。这个报错的原因是路劲和命名出现了问题。<img data-imgfileid="100002464" data-ratio="0.08628659476117104" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCia1kBIAuiaVuUXk7FqOWmhIibgsfBp9NNa0LMU0Eiacg7sfC1rhaP1JxIA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="649" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCia1kBIAuiaVuUXk7FqOWmhIibgsfBp9NNa0LMU0Eiacg7sfC1rhaP1JxIA/640?wx_fmt=png&amp;from=appmsg"><strong>因此重新整理数据，整理格式如下(供参考)：</strong></p><p data-tool="mdnice编辑器">把h5格式的文件放在每一个GSM编号的文件下面，然后把figure/json/position文件放在spatial文件夹下边。这里的spatial文件名称是根据报错的结果而命名的(一般都是这样)。</p><p data-tool="mdnice编辑器">同时需要修改上述三个文件的名称，一般会改成下面图片中的样子。其中图片文件会有高像素和低像素的区分，需要额外注意，这个数据集中只有一种图片文件。<img data-imgfileid="100002467" data-ratio="0.34234234234234234" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCcG7N6hRLPz0lf6qrCbzSibKrXWfU5BfLhGxEVZTv7Su7MUHJIQ0ok1Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1332" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCcG7N6hRLPz0lf6qrCbzSibKrXWfU5BfLhGxEVZTv7Su7MUHJIQ0ok1Q/640?wx_fmt=png&amp;from=appmsg"></p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(Seurat)<br><span>library</span>(tidyverse)<br><span>library</span>(sloop)<br><br><span># 10x Visium</span><br>sce_s &lt;- Load10X_Spatial(data.dir = <span>"./RawData/GSM5494475"</span>,<br>                           filename = <span>"GSM5494475_HNSCC201125T04_filtered_feature_bc_matrix.h5"</span>)<br><span># # 高像素</span><br><span># image &lt;- Read10X_Image(image.dir = "./RawData/GSM5494475/spatial/",</span><br><span>#                        image.name = "tissue_hires_image.png")</span><br><span># sce_s &lt;- Load10X_Spatial(data.dir = "./RawData/GSM5494475", image = image,</span><br><span>#                                  filename = "GSM5494475_HNSCC201125T04_filtered_feature_bc_matrix.h5")</span><br></code></pre><p data-tool="mdnice编辑器">读进来之后可以check一下数据, 发现比一般的数据多一个images内容<img data-imgfileid="100002465" data-ratio="0.5548387096774193" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCeQic97TiaPj6G8ZMg1q5TPRuvibLQPgBjLDwficWGoLP5qEW9k56V9l6lw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="930" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCeQic97TiaPj6G8ZMg1q5TPRuvibLQPgBjLDwficWGoLP5qEW9k56V9l6lw/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>2.check数据</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>class(sce_s[[<span>"slice1"</span>]])<br><span># [1] "VisiumV1" 表示是10X Genomics Visium 空间转录组数据格式</span><br><span># attr(,"package")</span><br><span># [1] "Seurat"</span><br>head(sce_s[[<span>"slice1"</span>]]@coordinates)<br><span># 表示Visium空间转录组数据中每个条形码(spot)的空间坐标信息</span><br><span># @coordinates包含了每个条形码在组织切片图像上的位置</span><br><span>#                    tissue row col imagerow imagecol</span><br><span># AAACACCAATAACTGC-1      1  59  19     1203     3953</span><br><span># AAACAGCTTTCAGAAG-1      1  43   9      862     3030</span><br><span># AAACAGGGTCTATATT-1      1  47  13      997     3260</span><br><span># AAACATGGTGAGAGGA-1      1  62   0      572     4132</span><br><span># AAACCGGGTAGGTACC-1      1  42  28     1494     2966</span><br><span># AAACCTCATGAAGTTG-1      1  37  19     1192     2679</span><br><span># row 和 col：该测序点在空间数据矩阵中的行和列位置。通常用于确定点在原始矩阵中的位置。</span><br><span># imagerow 和 imagecol：该测序点在实际组织切片图像(即PNG图像)中的像素坐标，分别表示在图像中的行坐标和列坐标。这些坐标用于在组织切片图像上定位测序点的位置，从而将基因表达数据与空间位置关联起来。</span><br>class(sce_s[[<span>"slice1"</span>]]@image)<br><span># [1] "array"</span><br>dim(sce_s[[<span>"slice1"</span>]]@image)<br><span># [1] 1972 2000    3</span><br><span># 1972 和 2000：表示图像的高度(1972像素)和宽度(2000像素)。</span><br><span># 3：表示图像的颜色通道数，即RGB(红、绿、蓝)三通道。每个像素位置有三个值，分别对应于红色、绿色和蓝色的强度，用于合成彩色图像。</span><br><br><br>head(GetTissueCoordinates(sce_s))<br><span>#                     imagerow imagecol</span><br><span># AAACACCAATAACTGC-1 134.38838 441.5937</span><br><span># AAACAGCTTTCAGAAG-1  96.29492 338.4845</span><br><span># AAACAGGGTCTATATT-1 111.37591 364.1780</span><br><span># AAACATGGTGAGAGGA-1  63.89871 461.5900</span><br><span># AAACCGGGTAGGTACC-1 166.89629 331.3349</span><br><span># AAACCTCATGAAGTTG-1 133.15956 299.2739</span><br>head(GetTissueCoordinates(sce_s[[<span>"slice1"</span>]]))<br><span>#                     imagerow imagecol</span><br><span># AAACACCAATAACTGC-1 134.38838 441.5937</span><br><span># AAACAGCTTTCAGAAG-1  96.29492 338.4845</span><br><span># AAACAGGGTCTATATT-1 111.37591 364.1780</span><br><span># AAACATGGTGAGAGGA-1  63.89871 461.5900</span><br><span># AAACCGGGTAGGTACC-1 166.89629 331.3349</span><br><span># AAACCTCATGAAGTTG-1 133.15956 299.2739</span><br></code></pre><p data-tool="mdnice编辑器">我们可以对比一下head(sce_s[["slice1"]]@coordinates)和head(GetTissueCoordinates(sce_s))得到的imagerow/imagecol的坐标不一样。这可能是因为这个数据集的缩放信息存在不匹配导致的。</p><h5 data-tool="mdnice编辑器"><span></span><span>3.数据预处理</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>plot1 &lt;- VlnPlot(sce_s, features = <span>"nCount_Spatial"</span>, pt.size = <span>0.2</span>) + <br>  NoLegend()<br>plot2 &lt;- SpatialFeaturePlot(sce_s, features = <span>"nCount_Spatial"</span>,<br>                            pt.size.factor = <span>2</span>) + <br>  theme(legend.position = <span>"right"</span>)<br>wrap_plots(plot1, plot2)<br><br><span># SCTransform归一化</span><br>sce_s &lt;- SCTransform(sce_s, assay = <span>"Spatial"</span>, <br>                     verbose = <span>FALSE</span>)<br><br>SpatialDimPlot(sce_s,alpha = <span>0</span>)<br></code></pre><p data-tool="mdnice编辑器">Plot2中可以看到spot数据在HE切片上的映射，但这里问题来了，为什么看不到HE切片呢？</p><p data-tool="mdnice编辑器">笔者认为是图片和缩放因子的问题，函数提示需要加载低像素的图片，但是由于没有这种低像素的数据，笔者把高像素的替换了进去。本次先不更换数据，先继续做尝试。<img data-imgfileid="100002466" data-ratio="0.7078189300411523" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQC98bDibv0OFH8kgibXm7vNoDmeT3XZENU2aLCFdEatniboKZUhuPG5FibeQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="729" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQC98bDibv0OFH8kgibXm7vNoDmeT3XZENU2aLCFdEatniboKZUhuPG5FibeQ/640?wx_fmt=png&amp;from=appmsg"></p><h5 data-tool="mdnice编辑器"><span></span><span>4.基因表达可视化</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>SpatialFeaturePlot(sce_s, features = c(<span>"TP53"</span>, <span>"CD3E"</span>),<br>                   pt.size.factor = <span>5</span>)<br><br><span>library</span>(ggplot2)<br>plot &lt;- SpatialFeaturePlot(sce_s, features = c(<span>"TP53"</span>), <span># alpha = c(0.1, 1)调整透明度</span><br>                           pt.size.factor = <span>5</span>) + theme(legend.text = element_text(size = <span>0</span>),<br>    legend.title = element_text(size = <span>20</span>), <br>    legend.key.size = unit(<span>1</span>, <span>"cm"</span>));plot<br>ggsave(filename = <span>"./output/images/spatial_tp53.pdf"</span>, <br>       height = <span>9</span>, width = <span>7</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100002473" data-ratio="1.1453333333333333" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCKeOyibUC5GmPh7rDB4shkldfRib692eatoWUL4n6M65ibFuSsiaX5libZbA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="750" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCKeOyibUC5GmPh7rDB4shkldfRib692eatoWUL4n6M65ibFuSsiaX5libZbA/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span><span>5.降维聚类可视化</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>sce_s &lt;- RunPCA(sce_s, assay = <span>"SCT"</span>, verbose = <span>FALSE</span>)<br>sce_s &lt;- FindNeighbors(sce_s, reduction = <span>"pca"</span>, dims = <span>1</span>:<span>30</span>)<br>sce_s &lt;- FindClusters(sce_s, verbose = <span>FALSE</span>)<br>sce_s &lt;- RunUMAP(sce_s, reduction = <span>"pca"</span>, dims = <span>1</span>:<span>30</span>)<br><br>p1 &lt;- DimPlot(sce_s, reduction = <span>"umap"</span>, label = <span>TRUE</span>)<br>p2 &lt;- SpatialDimPlot(sce_s, label = <span>TRUE</span>, label.size = <span>3</span>,<br>                     pt.size.factor = <span>5</span>)<br>p1 + p2<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100002471" data-ratio="0.6304347826086957" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCOKmaJva6NcW5JxAxwqiaRT9fQBufZbXvrQBFY4EdyqibuN9ssBHp4xHA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="736" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCOKmaJva6NcW5JxAxwqiaRT9fQBufZbXvrQBFY4EdyqibuN9ssBHp4xHA/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span><span>6.提取感兴趣的cluster</span><span></span></h5><pre data-tool="mdnice编辑器"><span></span><code>SpatialDimPlot(sce_s, <br>               cells.highlight = CellsByIdentities(object = sce_s,<br>                                                   idents = c(<span>2</span>,<span>1</span>,<span>4</span>,<span>3</span>,<span>5</span>,<span>8</span>)), <br>               facet.highlight = <span>TRUE</span>, pt.size.factor = <span>5</span>,ncol = <span>3</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100002472" data-ratio="0.6760374832663989" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCFZicHkglUZslTyFtLDwhRUibPasOaQQFvJB2Dcr0icicWw1ZuRPSy9DG6Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="747" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQCFZicHkglUZslTyFtLDwhRUibPasOaQQFvJB2Dcr0icicWw1ZuRPSy9DG6Q/640?wx_fmt=png&amp;from=appmsg"></figure><h5 data-tool="mdnice编辑器"><span></span><span>7.交互式绘图</span><span></span></h5><p data-tool="mdnice编辑器">这个就不演示了，笔者目前觉得意义不大</p><pre data-tool="mdnice编辑器"><span></span><code><span># 设置interactive为True</span><br>SpatialDimPlot(sce_s, interactive = <span>TRUE</span>)<br>SpatialFeaturePlot(sce_s, features = <span>"TP53"</span>, interactive = <span>TRUE</span>)<br></code></pre><h5 data-tool="mdnice编辑器"><span></span><span>8.空间高变特征识别</span><span></span></h5><p data-tool="mdnice编辑器">一、根据组织内预先注释的解剖区域进行差异表达,比如上面通过FindClusters找到的不同cluster</p><pre data-tool="mdnice编辑器"><span></span><code><span># 指定比较clust5和6</span><br>de_markers &lt;- FindMarkers(sce_s, ident.1 = <span>5</span>, ident.2 = <span>6</span>)<br><span># 在空间位置上可视化差异表达基因</span><br>SpatialFeaturePlot(object = sce_s, <br>                   features = rownames(de_markers)[<span>1</span>:<span>3</span>], <br>                   alpha = c(<span>0.1</span>, <span>1</span>), pt.size.factor = <span>5</span>,<br>                   ncol = <span>3</span>)<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100002469" data-ratio="0.7078189300411523" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQClQETq9HC3QJHQYcnShib4Ie5IhhEGhE7UjXQAIX1YPvj3PTLFULvQrQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="729" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQClQETq9HC3QJHQYcnShib4Ie5IhhEGhE7UjXQAIX1YPvj3PTLFULvQrQ/640?wx_fmt=png&amp;from=appmsg">二、FindSpatiallyVariables中实现的另一种方法是在没有预注释的情况下搜索表现出空间模式的特征</p><pre data-tool="mdnice编辑器"><span></span><code><span># 默认method = 'markvariogram', 其他有moransi等</span><br><span># 差异基因从高变基因中获取</span><br>sce_s &lt;- FindSpatiallyVariableFeatures(sce_s, <br>                                       assay = <span>"SCT"</span>, <br>                                       features = VariableFeatures(sce_s)[<span>1</span>:<span>1000</span>],<br>                                       selection.method = <span>"moransi"</span>)<br><span># 提取6个差异基因看一看</span><br>top.features &lt;- head(SpatiallyVariableFeatures(sce_s,selection.method = <span>"moransi"</span>),<span>6</span>)<br><br><span># 异基因可视化/笔者这里自定义了</span><br>top.features &lt;- c(<span>"CASQ1"</span>, <span>"AEBP1"</span>, <span>"MME"</span>)<br>SpatialFeaturePlot(sce_s, features = top.features, <br>                   ncol = <span>3</span>, pt.size.factor = <span>5</span>, alpha = c(<span>0.1</span>, <span>1</span>))<br></code></pre><p data-tool="mdnice编辑器"><img data-imgfileid="100002470" data-ratio="0.7078189300411523" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQC9zFdJO3NpBQWCXFa2AVMgXQuaiazJ784pCuQgZj4tD0I5HIa9hsclbw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="729" src="https://mmbiz.qpic.cn/sz_mmbiz_png/0SOG4MpDAyGQuS2PMGDY8XXXy0JdjAQC9zFdJO3NpBQWCXFa2AVMgXQuaiazJ784pCuQgZj4tD0I5HIa9hsclbw/640?wx_fmt=png&amp;from=appmsg">今天暂时探索到这儿，后面的是需要对解剖区域(clusters)子集化，涉及到坐标信息的修整，但笔者这里的SPOT信息都没跟HE图片对应起来hhh，所以需要更换数据集之后再进行探索了~</p><p data-tool="mdnice编辑器">本次内容主要是针对10XVisium数据的读取，此外还有其他类型数据的读取方式等之后再行演示。</p><h4 data-tool="mdnice编辑器"><span></span><span>参考资料：</span><span></span></h4><ol data-tool="mdnice编辑器"><li><section>10XGENOMICS：https://www.10xgenomics.com/cn</section></li><li><section>Seurat空转：https://satijalab.org/seurat/articles/spatial_vignette.html</section></li><li><section>生信技能树：https://mp.weixin.qq.com/s/C57QHpg_uD_YkgrmnvRMPAhttps://mp.weixin.qq.com/s/xVYCwfJI4MUAuka1W99efQ</section></li><li><section>生信随笔：https://mp.weixin.qq.com/s/X8eP58iDEx4j7pSyGbze9Q</section></li></ol><p data-tool="mdnice编辑器"><strong>注</strong>：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。更多内容可关注公众号：<strong>生信方舟</strong></p><span>- END -</span></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/E4WuPokBOxKRbBF6CEB5aA",target="_blank" rel="noopener noreferrer">原文链接</a>
