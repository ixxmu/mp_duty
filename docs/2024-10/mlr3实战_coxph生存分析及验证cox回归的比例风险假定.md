---
title: "mlr3实战:coxph生存分析及验证cox回归的比例风险假定"
date: 2024-10-29T16:26:56Z
draft: ["false"]
tags: [
  "fetched",
  "R 学习践行者"
]
categories: ["Acdemic"]
---
mlr3实战:coxph生存分析及验证cox回归的比例风险假定 by R 学习践行者
------
<div><p>序言 </p><p>         Cox 比例风险模型是生存分析中最经典和常用的模型之一，用于研究协变量（covariates）对生存时间的影响。<span>Cox 比例风险模型（Cox Proportional Hazards Model）是由统计学家 David Cox 提出的，用于分析生存数据中协变量对生存时间的影响。</span><span>该模型基于半参数化方法，不需要对风险函数做出具体的假设，而是利用风险比（Hazard Ratio）来比较不同协变量组之间的风险。</span></p><p><span>该方法的优点：</span><span>1.简单且易于解释：</span><span>Cox模型基于风险比，可以直观地解释不同协变量对生存时间的影响。</span><span>2.适用性广泛：</span><span>Cox模型适用于各种类型的生存数据，不需要对数据分布做出具体假设。</span><span>3.考虑了协变量的影响：</span><span>Cox模型可以同时考虑多个协变量对生存时间的影响，可以用于探索性分析和预测建模。</span></p><p>缺点：1.对数据的分布假设严格：Cox模型假设风险比在时间上是恒定的，对于不符合这一假设的数据可能不适用。2.无法处理时间依赖的协变量：Cox模型无法直接处理协变量随时间变化的情况，需要通过适当的处理方法来解决。</p><p><span>注意事项： </span></p><p><span>1.数据的准备：在使用 Cox 模型之前，需要确保数据符合 Cox模型的假设，例如数据应该是纵向研究设计，具有明确的观测开始和结束时间。</span></p><p><span> 2.对结果的解释：解释 Cox模型的结果时，应该注意风险比的含义和解释，以便正确理解协变量对生存时间的影响。（风险比表示两组个体在任意时刻的风险相对大小。具体地说，假设我们有两组个体，比如治疗组和对照组，风险比可以告诉我们，在给定时刻，治疗组的风险相对于对照组的风险是多少倍。风险比大于1表示治疗组的风险更高，小于1表示治疗组的风险更低）</span><span></span></p><p><span>接下来，让我们构建一个coxph模</span><span>型</span></p><p>1.创建生存任务,采用自带Lung Cancer任务</p><pre><code><span>library</span>(mlr3verse)<br><span>library</span>(mlr3proba)<br><span>library</span>(survival)<br>task =tsk(<span>"gbcs"</span>)<br>task$head()</code></pre><pre><code>     time status age estrg_recp grade hormone menopause nodes prog_recp size<br>  1: 2282      0  38        105     3       1         1     5       141   18<br>  2: 2006      0  52         14     1       1         1     1        78   20<br>  3: 1456      1  47         89     2       1         1     1       422   30<br>  4:  148      0  40         11     1       1         1     3        25   24<br>  5: 1863      0  64          9     2       2         2     1        19   19<br>  6: 1933      0  49         64     1       2         2     3       356   56</code></pre><p>        德国乳腺癌数据集，这个数据集包含了乳腺癌患者的临床特征和相关信息。time：观察时间或生存时间 status：事件状态 age：患者的年龄。estrg_recp：雌激素受体状态 grade：肿瘤分级 hormone：激素治疗情况 menopause：更年期状态 nodes：正性淋巴结的数量 prog_recp：孕激素受体状态 size：肿瘤大小（以毫米为单位）</p><p><br></p><p>2.使用 autoplot 绘制任务会产生 Kaplan-Meier 图</p><pre><code>autoplot(task,type=<span>"target"</span>)<span>#生存曲线</span></code></pre><p><img data-imgfileid="100000470" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoSYziaKqrlHFqO9ELxhpmHq37oD226zFoZtpwiakjyNXrjfGVY0UoXmSw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoSYziaKqrlHFqO9ELxhpmHq37oD226zFoZtpwiakjyNXrjfGVY0UoXmSw/640?wx_fmt=png&amp;from=appmsg"></p><pre><code>autoplot(task,rhs=<span>"grade"</span>)<span>#grade特征的分组生存曲线</span></code></pre><p><img data-imgfileid="100000469" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoI4a16AColRn5K7Y6aia9nYz0CYwBmfsannFW8ro5T0ibND9sV0WKr4zg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoI4a16AColRn5K7Y6aia9nYz0CYwBmfsannFW8ro5T0ibND9sV0WKr4zg/640?wx_fmt=png&amp;from=appmsg"></p><pre><code>autoplot(task,rhs=<span>"hormone"</span>)<span>#hormone特征的分组生存曲线</span></code></pre><p><img data-imgfileid="100000467" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoloVicfxqphmFjTdibeCuj5CjSbm9LukPSxmZbwROhQoqvycYGibnRYe9w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoloVicfxqphmFjTdibeCuj5CjSbm9LukPSxmZbwROhQoqvycYGibnRYe9w/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p>3.构建学习器及训练模型--特征选择</p><pre><code>coxph_learner&lt;-lrn(<span>"surv.coxph"</span>)  <span>#学习器</span><br><br>afs = auto_fselector(<br>  fselector = fs(<span>"exhaustive_search"</span>) ,<span>#详尽搜索，尝试所有可能的特征子集</span><br>  learner = coxph_learner,<br>  resampling = rsmp(<span>"cv"</span>,folds=<span>3</span>),<br>  measure = msr(<span>"surv.cindex"</span>),<br>  terminator = trm(<span>"evals"</span>, n_evals = <span>100</span>)<br>)<span>#特征选择</span><br><br>future::plan(<span>"multisession"</span>)<br>set.seed(<span>1111</span>)<br>rr&lt;-resample(task,afs,rsmp(<span>"cv"</span>,folds=<span>4</span>),store_models = <span>TRUE</span>)</code></pre><pre><code>k&lt;-c(<span>"surv.rcll"</span>,<span>"surv.cindex"</span>,<span>"surv.dcalib"</span>)<br>rr$aggregate(measures = msrs(k)) <span>#平均模型性能</span></code></pre><pre><code>    surv.rcll surv.cindex surv.dcalib <br>     8.302123    0.726359    1.816403</code></pre><p>cindex大于0.7，还可以，rcll和dcalib的结果评估模型性能不好理解，我们可以与surv.kaplan模型（基线模型）进行比较，这样更好的对比模型性能。</p><pre><code>rr$score(measures = msrs(k)) <span>#外层4次迭代的结果</span></code></pre><pre><code>     task_id           learner_id resampling_id iteration surv.rcll surv.cindex<br>  1:    gbcs surv.coxph.fselector            cv         1  7.906853   0.7522684<br>  2:    gbcs surv.coxph.fselector            cv         2  8.338278   0.6766917<br>  3:    gbcs surv.coxph.fselector            cv         3  7.558756   0.7685081<br>  4:    gbcs surv.coxph.fselector            cv         4  9.404605   0.7079678<br>     surv.dcalib<br>  1:    2.331662<br>  2:    1.774117<br>  3:    1.356212<br>  4:    1.803622<br>  Hidden columns: task, learner, resampling, prediction</code></pre><pre><code>as.data.table(extract_inner_fselect_results(rr))[,<span>1</span>:<span>10</span>]<span>#内层每次调参的结果</span></code></pre><pre><code>     iteration   age estrg_recp grade hormone menopause nodes prog_recp  size<br>  1:         1 FALSE       TRUE  TRUE   FALSE     FALSE  TRUE      TRUE FALSE<br>  2:         2 FALSE      FALSE  TRUE   FALSE     FALSE  TRUE      TRUE  TRUE<br>  3:         3 FALSE      FALSE FALSE    TRUE     FALSE  TRUE      TRUE  TRUE<br>  4:         4 FALSE      FALSE FALSE    TRUE     FALSE  TRUE      TRUE  TRUE<br>     surv.cindex<br>  1:   0.7435577<br>  2:   0.7654553<br>  3:   0.7483091<br>  4:   0.7588452</code></pre><p>age、menopause在4次的特征选择中都没有采用；nodes和prog_recp在4次的特征选择中都被采用了。</p><p><br></p><p>4.基准测试，评估模型性能</p><pre><code>learners =c(afs,lrns(<span>"surv.kaplan"</span>)) <span>#与surv.kaplan模型（基线模型）进行比较</span><br><br>future::plan(<span>"multisession"</span>)<br>bmr = benchmark(benchmark_grid(task, learners,<br>  rsmp(<span>"cv"</span>, folds = <span>3</span>)))</code></pre><pre><code>bmr$aggregate(measures =msrs(k))[, c(<span>"learner_id"</span>,<span>"surv.rcll"</span>,<span>"surv.cindex"</span>,<span>"surv.dcalib"</span>)]</code></pre><pre><code>               learner_id surv.rcll surv.cindex surv.dcalib<br>  1: surv.coxph.fselector  8.462603   0.7434555    4.788279<br>  2:          surv.kaplan  8.486052   0.5000000    5.062842</code></pre><p>从性能指标来看，coxph模型性能好于KM生存函数估计</p><p>5.提取模型特征</p><pre><code>set.seed(<span>1112</span>)<br>model&lt;-afs$train(task)$model</code></pre><pre><code>model$features</code></pre><pre><code>  [1] "hormone"   "nodes"     "prog_recp"</code></pre><p>结果提示保留3个特征</p><p><br></p><p>6.简化模型：使用nodes、prog_recp 、hormone 3个变量重新训练模型</p><pre><code>task1&lt;-task$clone()$select(c(<span>"nodes"</span>,<span>"prog_recp"</span>,<span>"hormone"</span>))<br><br>model1&lt;-coxph_learner$train(task1)$model<br><br>summary(model1)</code></pre><pre><code>  Call:<br>  survival::coxph(formula = task$formula(), data = task$data(), <br>      x = TRUE)<br>  <br>    n= 686, number of events= 171 <br>  <br>                 coef exp(coef)  se(coef)      z Pr(&gt;|z|)    <br>  hormone   -0.286859  0.750618  0.163810 -1.751   0.0799 .  <br>  nodes      0.063466  1.065523  0.008461  7.501 6.35e-14 ***<br>  prog_recp -0.006518  0.993504  0.001216 -5.359 8.35e-08 ***<br>  ---<br>  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1<br>  <br>            exp(coef) exp(-coef) lower .95 upper .95<br>  hormone      0.7506     1.3322    0.5445    1.0348<br>  nodes        1.0655     0.9385    1.0480    1.0833<br>  prog_recp    0.9935     1.0065    0.9911    0.9959<br>  <br>  Concordance= 0.749  (se = 0.018 )<br>  Likelihood ratio test= 97.58  on 3 df,   p=&lt;2e-16<br>  Wald test            = 90.55  on 3 df,   p=&lt;2e-16<br>  Score (logrank) test = 96.91  on 3 df,   p=&lt;2e-16</code></pre><p><br></p><p>7.比例风险假定的检验：函数cox.zph()</p><p>由于Cox模型假设风险比在时间上是恒定的，因此需要验证Cox回归的比例风险假定。</p><pre><code><span>#进行PH检验</span><br>zp &lt;- cox.zph(model1)<br>zp</code></pre><pre><code>             chisq df       p<br>  hormone    0.535  1 0.46459<br>  nodes      1.235  1 0.26649<br>  prog_recp 12.631  1 0.00038<br>  GLOBAL    15.244  3 0.00162</code></pre><p>结果表明，prog_recp变量的检验和全局检验的p值&lt;0.05,说明数据违背了比例风险的假定。</p><pre><code>op &lt;- par(mfrow=c(<span>1</span>,<span>3</span>))<br>plot(zp)</code></pre><p><img data-imgfileid="100000468" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJooD3bBxAz7vQle18g50xsNXicvrpmibtibCZA9yRy0o0c6ibNibq0hgyyFtg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJooD3bBxAz7vQle18g50xsNXicvrpmibtibCZA9yRy0o0c6ibNibq0hgyyFtg/640?wx_fmt=png&amp;from=appmsg"></p><p>      这张图反映了prog_recp变量的系数随着时间的改变，prog_recp偏离的比较厉害，系数大概从810天开始增加，趋近于0；1900天又开始下降，所以它的系数是一直在随着时间改变的，不符合比例风险假设。<br></p><p><br></p><p>残差图</p><pre><code><span># Schoenfeld 残差图来检验 Cox 模型的共线性假设是否成立</span><br><span>library</span>(survminer)<br>ggcoxdiagnostics(model1, type = <span>"schoenfeld"</span>)</code></pre><p><img data-imgfileid="100000471" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJofe6XzzbDutia7aGWCKPOQvhl14lHxricUw4k9QjVliazkSOAtMFx1xElQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJofe6XzzbDutia7aGWCKPOQvhl14lHxricUw4k9QjVliazkSOAtMFx1xElQ/640?wx_fmt=png&amp;from=appmsg"></p><p>       如果Cox模型的假设成立，那么残差应该随着时间或事件的发生是随机分布的，不应该有明显的趋势或者模式。而prog_recp变量有点上升的趋势。</p><p><br></p><p>8.观察prog_recp变量的数值：prog_recp是偏态分布的，看看分箱处理能否改善模型</p><pre><code>da&lt;-task1$data()<br>hist(da$prog_recp,breaks = <span>100</span>)</code></pre><p><img data-imgfileid="100000472" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoBNpl6iaqIpSn9TbdbjxBrntO2ZUra5iaX5M7p7Rd5rWIcaEicgQ5MEO5A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoBNpl6iaqIpSn9TbdbjxBrntO2ZUra5iaX5M7p7Rd5rWIcaEicgQ5MEO5A/640?wx_fmt=png&amp;from=appmsg"></p><p>prog_recp数据是偏态分布,也有挺多患者结果为0，那我们使用分位数分箱对该变量进行分箱处理（po(“quantilebin”)）,看看能否解决这个问题;</p><p>对于这种偏态数据分布的特征，具体如何处理应从你对数据的理解和目标考虑。</p><p><br></p><p>9.在学习器前加入特征预处理，构建图学习器</p><p>     prog_recp特征按百分位数分成4份，并进行独热编码，其他特征不变</p><pre><code><span>library</span>(mlr3pipelines)<br>po&lt;-po(<span>"quantilebin"</span>,numsplits=<span>4</span>,affect_columns=selector_name(<span>"prog_recp"</span>))<br><br>task2&lt;- po$train(list(task1))[[<span>1</span>]]<br><br>autoplot(task2,rhs=<span>"prog_recp"</span>)<span>#prog_recp特征的分组生存曲线</span></code></pre><p><img data-imgfileid="100000475" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoX0ichBUvhkAS5S1r42fvbpLBV6Gdaeqnv54Nuic9BqHUf22acJ7RiaicQw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoX0ichBUvhkAS5S1r42fvbpLBV6Gdaeqnv54Nuic9BqHUf22acJ7RiaicQw/640?wx_fmt=png&amp;from=appmsg"></p><p>     可以看到KM曲线存在交叉，意味prog_recp特征可能还是违背风险不变的假设。</p><pre><code>po_encode&lt;- po(<span>"encode"</span>,affect_columns=selector_name(<span>"prog_recp"</span>))<br><br>gran&lt;- po %&gt;&gt;% <br>  po_encode %&gt;&gt;%<br>  coxph_learner<br><br>gran$plot()</code></pre><p><img data-imgfileid="100000473" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoSN7wyAkhicICt2qR4frDianjic8XLXzoaSlveopRwCNnrDTn3MSBdym3w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoSN7wyAkhicICt2qR4frDianjic8XLXzoaSlveopRwCNnrDTn3MSBdym3w/640?wx_fmt=png&amp;from=appmsg"><span>把prog_recp特征，进行分位数分箱分成4分，再进行独热编码，最后连接上学习器</span></p><p><br></p><p>10.使用重抽样，验证经过预处理后的模型性能</p><pre><code>gran_learner&lt;-as_learner(gran)<br><br>gran_km&lt;- po %&gt;&gt;% <br>  po_encode %&gt;&gt;%<br>  lrn( <span>"surv.kaplan"</span>)<br><br>gran_km_learner&lt;-as_learner(gran_km)  <span>#surv.kaplan模型（基线模型）</span><br><br>learners = c(gran_learner,gran_km_learner)<br><br>bmr = benchmark(benchmark_grid(task1, learners,<br>  rsmp(<span>"cv"</span>, folds = <span>4</span>)))</code></pre><pre><code>bmr$aggregate(measures =msrs(k))[, c(<span>"learner_id"</span>,<span>"surv.cindex"</span>,<span>"surv.dcalib"</span>,<span>"surv.rcll"</span> )]</code></pre><pre><code>                         learner_id surv.cindex surv.dcalib surv.rcll<br>  1:  quantilebin.encode.surv.coxph   0.7441972    3.244349  8.383456<br>  2: quantilebin.encode.surv.kaplan   0.5000000    4.400815  8.408477</code></pre><p><br></p><p>11.经过分箱后数据是否符合cox回归的比例风险假定</p><pre><code>model2&lt;-gran_learner$train(task1)$model$surv.coxph$model<br>summary(model2)</code></pre><pre><code>  Call:<br>  survival::coxph(formula = task$formula(), data = task$data(), <br>      x = TRUE)<br>  <br>    n= 686, number of events= 171 <br>  <br>                            coef exp(coef)  se(coef)      z Pr(&gt;|z|)    <br>  prog_recp...Inf.7.    1.799821  6.048563  0.284618  6.324 2.55e-10 ***<br>  prog_recp..7.32.5.    1.532018  4.627508  0.291027  5.264 1.41e-07 ***<br>  prog_recp..32.5.132.  0.541329  1.718289  0.322882  1.677   0.0936 .  <br>  prog_recp..132..Inf.        NA        NA  0.000000     NA       NA    <br>  hormone              -0.356034  0.700449  0.164628 -2.163   0.0306 *  <br>  nodes                 0.066787  1.069068  0.009111  7.330 2.30e-13 ***<br>  ---<br>  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1<br>  <br>                       exp(coef) exp(-coef) lower .95 upper .95<br>  prog_recp...Inf.7.      6.0486     0.1653    3.4625   10.5662<br>  prog_recp..7.32.5.      4.6275     0.2161    2.6159    8.1860<br>  prog_recp..32.5.132.    1.7183     0.5820    0.9126    3.2354<br>  prog_recp..132..Inf.        NA         NA        NA        NA<br>  hormone                 0.7004     1.4277    0.5073    0.9672<br>  nodes                   1.0691     0.9354    1.0501    1.0883<br>  <br>  Concordance= 0.757  (se = 0.017 )<br>  Likelihood ratio test= 120.5  on 5 df,   p=&lt;2e-16<br>  Wald test            = 117.5  on 5 df,   p=&lt;2e-16<br>  Score (logrank) test = 141.2  on 5 df,   p=&lt;2e-16</code></pre><pre><code>zp1&lt;-cox.zph(model2)<br>zp1</code></pre><pre><code>                        chisq df       p<br>  prog_recp...Inf.7.    3.935  1 0.04729<br>  prog_recp..7.32.5.    2.697  1 0.10051<br>  prog_recp..32.5.132. 14.050  1 0.00018<br>  hormone               0.261  1 0.60923<br>  nodes                 0.466  1 0.49482<br>  GLOBAL               19.252  5 0.00173</code></pre><p>       数据还是违背了比例风险的假定,分箱并没有改善风险不变假设。</p><pre><code>plot(zp1)</code></pre><p><img data-imgfileid="100000474" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoibK3rvzQxNsWffQdFFK9pz6c3RFvefnqcdg73wEOvtWcDSSITvAWWdg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoibK3rvzQxNsWffQdFFK9pz6c3RFvefnqcdg73wEOvtWcDSSITvAWWdg/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000476" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoDbhnFsKleWdnmzBPNylibXgTICsrjOzoicyic79sEB0gMLLqzvePpngdA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoDbhnFsKleWdnmzBPNylibXgTICsrjOzoicyic79sEB0gMLLqzvePpngdA/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000477" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoW8Nwy418Z7QnQWIAC6Fz8hIiasGdLHLHQqBlYZccInjkQv6kGb88XyQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoW8Nwy418Z7QnQWIAC6Fz8hIiasGdLHLHQqBlYZccInjkQv6kGb88XyQ/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000479" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoS1ic7VfOxqwZKG6NDhY3bNoRuKtNCLmiaDOtP3mmABtT8SpLxPsjN66g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJoS1ic7VfOxqwZKG6NDhY3bNoRuKtNCLmiaDOtP3mmABtT8SpLxPsjN66g/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100000478" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJo3Wty81FD1urITOYC3RecYhjLPqrh9DIUad4grBia2UjkibQcoiauK6t9Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJo3Wty81FD1urITOYC3RecYhjLPqrh9DIUad4grBia2UjkibQcoiauK6t9Q/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><span># Schoenfeld 残差图来检验 Cox 模型的共线性假设是否成立</span><br><span>library</span>(survminer)<br>ggcoxdiagnostics(model2, type = <span>"schoenfeld"</span>)</code></pre><p><img data-imgfileid="100000481" data-ratio="0.7142857142857143" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJobHrhtK2ZHBMmiaJRiccdwGg7DHCPnBPUapKjQFKa3MSS6JPbcBafQqQg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1344" width="672" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50maoJIaIQWJfxxRDYESwbJobHrhtK2ZHBMmiaJRiccdwGg7DHCPnBPUapKjQFKa3MSS6JPbcBafQqQg/640?wx_fmt=png&amp;from=appmsg"></p><p><span>      在COX回归不满足PH假定的有以下补救方法：</span></p><p><span>1）对时间分层:对时间使用分层函数,根据拐点把时间分成几段</span></p><p><span>2）连续性时依系数变换：prog_recp系数随时间变化的曲线明显不是线性的，可以通过数据变换把它变成类似线性的，比如取log</span></p><p><span> 下一章尝试解决这个问题</span></p><p>参考资料 </p><p>Applied Machine Learning Using mlr3 in R </p><p>R语言医学数据分析实战</p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/GJi30jj75sX1zTheVCFgYQ",target="_blank" rel="noopener noreferrer">原文链接</a>
