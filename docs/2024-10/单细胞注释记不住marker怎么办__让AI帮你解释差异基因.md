---
title: "单细胞注释记不住marker怎么办--让AI帮你解释差异基因"
date: 2024-10-15T07:07:50Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
单细胞注释记不住marker怎么办--让AI帮你解释差异基因 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>众所周知，单细胞数据分析最磨人的环节就是确定不同的单细胞亚群的生物学名字，<strong>而且每个领域都有自己的特殊性，所以我们耗费了大量的时间做了一些亚群及其对应的marker的整理，如下所示</strong>；</p></blockquote><ul data-tool="mdnice编辑器"><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247523757&amp;idx=1&amp;sn=fd04def7e6aab3d2107aacd1961e2cb3&amp;chksm=ea1c9b2fdd6b12399737aae71c08dad99d8d486ead87c78ea0ac642c62d86b6a26090f2e44f0&amp;scene=21#wechat_redirect" data-linktype="2">间充质细胞的细分亚群情况</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247522338&amp;idx=1&amp;sn=b8baf4b8ebfe585aa8132a656dd5ce63&amp;chksm=ea1c9ea0dd6b17b61465f9169ccbc2e9024bcb0c4458c7ffb692437d4b273c8a0deab69d9ce3&amp;scene=21#wechat_redirect" data-linktype="2">软骨相关单细胞亚群的标记基因</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519821&amp;idx=1&amp;sn=f0d12e88cad52018c940f26e8268c0c5&amp;chksm=ea1c88cfdd6b01d978a5dbe9f42bcb46409767d4994acf5e8ad714a5b1e1be9745c9549c32b6&amp;scene=21#wechat_redirect" data-linktype="2">单细胞亚群的关键基因背诵不下来肿么办</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247519488&amp;idx=1&amp;sn=12e4b4947f1902d1d6d7ffdfcc2df6ef&amp;chksm=ea1c8b82dd6b029453002b21cc37ed4788d0d1d59744d3046cc08ef4d4aa40f97560c500c248&amp;scene=21#wechat_redirect" data-linktype="2">内分泌器官胰岛的细分单细胞亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247515453&amp;idx=1&amp;sn=f40ed42113ad6550cfe7569ea01a3965&amp;chksm=ea1cbbbfdd6b32a9931f234fbfb5a2aeb5497af145500c7b96733a546a38603d76dec950d063&amp;scene=21#wechat_redirect" data-linktype="2">NK细胞的单细胞层面细分亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247509142&amp;idx=1&amp;sn=6952d561d511fda2722e13cae4482818&amp;chksm=ea1ca214dd6b2b02a48ceffe60073b8f6d29a161652bb6af8ccec44f64aceb0ac6787bceeee1&amp;scene=21#wechat_redirect" data-linktype="2">呼吸道上皮各个单细胞亚群的层级结构</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247508199&amp;idx=1&amp;sn=692f03da0c5ffd721bc838e4376c8bd9&amp;chksm=ea1ca665dd6b2f73b7472f2dd2844c3077df290aea48501b6546b12d0150657ab71c5c0f7355&amp;scene=21#wechat_redirect" data-linktype="2">内皮细胞细分亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247506971&amp;idx=1&amp;sn=f0242285e2c827d922f938d9858d4ffe&amp;chksm=ea1cda99dd6b538fd0ed7f870f2a5a1dd55724dce280bdce024be41caaa60f668b550765b6bb&amp;scene=21#wechat_redirect" data-linktype="2">髓系免疫细胞细分亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247506948&amp;idx=1&amp;sn=025d7f91abfa1b68d7910c86cf709e43&amp;chksm=ea1cda86dd6b53904b4dabe436f0857204eb7529f6d16c0fbf427a57c25322f6d501abdf034c&amp;scene=21#wechat_redirect" data-linktype="2">B细胞细分亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247502849&amp;idx=1&amp;sn=07ab747e457553e8d9e05fea707a6333&amp;chksm=ea1cca83dd6b4395b10c320f7cb8b03b779e3e6bc40c4da57e72a4af3b55b0d9a51e4d2a9f69&amp;scene=21#wechat_redirect" data-linktype="2">乳腺上皮细胞单细胞亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247502865&amp;idx=1&amp;sn=2863c8d39c6d9dfa5fbf469a64bae99e&amp;chksm=ea1cca93dd6b438579083d48d2621901bf40bc7c780a3e71012d5507723c26e1adcf394cb725&amp;scene=21#wechat_redirect" data-linktype="2">肝上皮细胞单细胞亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247502834&amp;idx=1&amp;sn=d9877dee08fbb9163705563fd2f299b0&amp;chksm=ea1ccd70dd6b44665f0f7de05754ece4159526ad673b28523a74f3c60ca0b7e3a724fba424f4&amp;scene=21#wechat_redirect" data-linktype="2">肺上皮细胞单细胞亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247502811&amp;idx=1&amp;sn=f6fefa1eb82709769764d2166c2cc06e&amp;chksm=ea1ccd59dd6b444fa2432d9cad4231cec9fea31697d6946cc3c1545c22768f34239467b605ec&amp;scene=21#wechat_redirect" data-linktype="2">结直肠上皮细胞单细胞亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247502771&amp;idx=1&amp;sn=deb517f058efe4f7d5f5eb8a37ad9241&amp;chksm=ea1ccd31dd6b4427565b597d169f5d77d8a4c592a2d487d3c604c6443499fc213ac7fff32b12&amp;scene=21#wechat_redirect" data-linktype="2">胃上皮细胞单细胞亚群</a></section></li><li><section><a href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247502753&amp;idx=1&amp;sn=fe2e05e8664a0d86bc8b6c549b4c652d&amp;chksm=ea1ccd23dd6b4435246c5ef134a21e2d8639d16d3e33cd77bdd52d22d848e79d2521a097422b&amp;scene=21#wechat_redirect" data-linktype="2">肾上皮细胞单细胞亚群</a></section></li></ul></section><span></span></h2><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span>不过靠人脑背诵不如靠人工智能大模型</span><span></span></h3></section><p data-tool="mdnice编辑器">当前AI大语言模型逐渐改变我们的科研工作方式，甚至今年两项诺贝尔奖都给AI，<strong>我们从面向搜索引擎（谷歌，百度）工作，到面向AI（chatGPT,kimi）工作。从日常查信息翻译，到科研编程等，都会去问下AI。</strong></p><p data-tool="mdnice编辑器">生信技能树专栏 <a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAxMDkxODM1Ng==&amp;action=getalbum&amp;album_id=3563279141371740170&amp;scene=126" data-linktype="2">人工智能大模型的100个生信案例</a> 提供了许多例子来演示AI在日常科研工作中的使用。</p><p><img data-galleryid="" data-imgfileid="100050800" data-ratio="1.25920245398773" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwOKS9WibhfRGwEIT5HKK749y1vsIFA0GKXJNPQ85licRF0icMsUqznmeIrDkibC04KCDHYglq6yt7tDA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1304" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwOKS9WibhfRGwEIT5HKK749y1vsIFA0GKXJNPQ85licRF0icMsUqznmeIrDkibC04KCDHYglq6yt7tDA/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">而且发在Nature methods上的GPTCelltype向我们阐述人工智能大语言模型在细胞类型注释的潜能 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247529155&amp;idx=1&amp;sn=cb0c642bdb97747235d0d3ec31ff77eb&amp;scene=21#wechat_redirect" data-linktype="2">一行代码就能发生信顶刊的GPTCelltype做单细胞亚群注释</a></p><p data-tool="mdnice编辑器">但显然，细胞类型注释，我们还可以通过大模型得到更多信息，例如:为什么注释到这个细胞类型？哪些gene markers 支持你注释这个细胞类型？因此这里介绍一个我们自己开发的基于Python编程语言的工具GPTBioInsightor辅助我们完成这件事。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100050785" data-ratio="0.2898148148148148" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwOKS9WibhfRGwEIT5HKK749iaFeIPgUcs7tej4OZaphPUoQKz2t16jR5wHW5Pjmu5qWpxGVOZumWlQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwOKS9WibhfRGwEIT5HKK749iaFeIPgUcs7tej4OZaphPUoQKz2t16jR5wHW5Pjmu5qWpxGVOZumWlQ/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>GPTBioInsightor</span><span></span></h2><p data-tool="mdnice编辑器">GPTBioInsightor是基于Python开发的，所以我们这样安装软件：</p><pre data-tool="mdnice编辑器"><span></span><code>pip install gptbioinsightor<br></code></pre><p data-tool="mdnice编辑器">这里也是使用经典的10X Genomics PBMC进行演示，Linux上这里下载数据</p><pre data-tool="mdnice编辑器"><span></span><code>mkdir data<br>wget http://cf.10xgenomics.com/samples/cell-exp/1.1.0/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz -O data/pbmc3k_filtered_gene_bc_matrices.tar.gz<br><span>cd</span> data; tar -xzf pbmc3k_filtered_gene_bc_matrices.tar.gz<br></code></pre><p data-tool="mdnice编辑器">然后在Python环境进行单细胞数据处理, 进行预处理，单细胞降维聚类，然后计算差异基因marker：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 更详细的scanpy数据处理参考 https://scanpy.readthedocs.io/en/stable/tutorials/basics/clustering-2017.html</span><br><br>import scanpy as sc<br><br><span>## 读取数据</span><br>adata = sc.read_10x_mtx(<br>    <span>"data/filtered_gene_bc_matrices/hg19/"</span>,  <span># the directory with the `.mtx` file</span><br>    var_names=<span>"gene_symbols"</span>,  <span># use gene symbols for the variable names (variables-axis index)</span><br>    cache=True,  <span># write a cache file for faster subsequent reading</span><br>)<br><br><span>## 预处理</span><br>adata.var_names_make_unique()  <br><br>sc.pp.filter_cells(adata, min_genes=200)<br>sc.pp.filter_genes(adata, min_cells=3)<br><br><span># annotate the group of mitochondrial genes as "mt"</span><br>adata.var[<span>"mt"</span>] = adata.var_names.str.startswith(<span>"MT-"</span>)<br>sc.pp.calculate_qc_metrics(<br>    adata, qc_vars=[<span>"mt"</span>], percent_top=None, log1p=False, inplace=True<br>)<br><br>adata = adata[adata.obs.n_genes_by_counts &lt; 2500, :]<br>adata = adata[adata.obs.pct_counts_mt &lt; 5, :].copy()<br><br>sc.pp.normalize_total(adata, target_sum=1e4)<br><br>sc.pp.log1p(adata)<br><br>sc.pp.highly_variable_genes(adata, min_mean=0.0125, max_mean=3, min_disp=0.5)<br>adata.raw = adata<br>adata = adata[:, adata.var.highly_variable]<br><br>sc.pp.regress_out(adata, [<span>"total_counts"</span>, <span>"pct_counts_mt"</span>])<br><br>sc.pp.scale(adata, max_value=10)<br>sc.tl.pca(adata, svd_solver=<span>"arpack"</span>)<br>sc.pp.neighbors(adata, n_neighbors=10, n_pcs=40)<br><br><span>## 聚类</span><br>sc.tl.leiden(<br>    adata,<br>    resolution=0.9,<br>    random_state=0,<br>    flavor=<span>"igraph"</span>,<br>    n_iterations=2,<br>    directed=False,<br>)<br>sc.tl.umap(adata)<br><br><span>## 计算差异基因marker</span><br>sc.tl.rank_genes_groups(adata, <span>"leiden"</span>, key_added=<span>"logreg_deg"</span>, method=<span>"logreg"</span>)<br></code></pre><p data-tool="mdnice编辑器">计算完差异基因后，就可以使用GPTBioinsightor进行细胞类型注解，这里GPTBioinsightor可以选择不同的大模型，<span><strong>但需要你去申请API KEY，下面的大模型都可以试试看 :</strong></span></p><ul data-tool="mdnice编辑器"><li><section>openai</section></li><li><section>anthropic</section></li><li><section>groq</section></li><li><section>aliyun</section></li><li><section>zhipuai</section></li><li><section>siliconflow</section></li><li><section>deepseek</section></li></ul><p data-tool="mdnice编辑器">其中咱们国内的友友们应该是用不了openai和anthropic，如果想要体验一下，考虑一下第三方中转服务，例如：https://flybirdsci.com/</p><p data-tool="mdnice编辑器">在这个教程，我们使用阿里云的通义千文，<span><strong>API_KEY教程申请：https://help.aliyun.com/zh/model-studio/developer-reference/get-api-key</strong></span></p><pre data-tool="mdnice编辑器"><span></span><code><span>### 设置大语言模型的 API KEY</span><br>import os<br><span># https://gptbioinsightor.readthedocs.io/zh-cn/latest/models.html</span><br><span>## 特定aliyun API KEY</span><br>os.environ[<span>'ALIYUN_API_KEY'</span>] = <span>"sk-***"</span><br><span># os.environ['API_KEY'] = "sk-***"</span></code><code><span><i># 每个人自己的api的key都不一样哦 <br></i></span><span><br>import gptbioinsightor as gbi<br></span><span># 设置数据的背景信息</span><span><br>background = </span><span>"Cells are PBMCs from a Healthy Donor"</span><span> <br><br></span><span># 使用阿里的通义千问qwen-max-latest</span><span><br></span><span># 也可以设置成其他模型</span><span><br>res = gbi.get_celltype(adata, background=background, <br>                       out=</span><span>"gbi.qwen.celltype.md"</span><span>, key=</span><span>"logreg_deg"</span><span>, <br>                       topnumber=15,provider=</span><span>"aliyun"</span><span>, <br>                       n_jobs=4,model=</span><span>"qwen-max-latest"</span><span>)<br>res<br></span><span># {'0': 'CD4+ T Helper Cells',</span><span><br></span><span>#  '1': 'B Cells',</span><span><br></span><span>#  '2': 'Monocytes/Macrophages',</span><span><br></span><span>#  '3': 'Natural Killer (NK) cells',</span><span><br></span><span>#  '4': 'Cytotoxic T Cells (CD8+)',</span><span><br></span><span>#  '5': 'Monocytes/Macrophages',</span><span><br></span><span>#  '6': 'Dendritic Cells',</span><span><br></span><span>#  '7': 'Platelets'}</span><span><br></span></code></pre><p data-tool="mdnice编辑器">输出的markdown内容如下(这里只展示了一群的细胞类型)：主要包括：</p><ul data-tool="mdnice编辑器"><li><section>关键marker: Cell-specific, Context-specific:</section></li><li><section>注释原因</section></li><li><section>备用细胞类型考虑</section></li><li><section>其他一些输出信息辅助判断</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span># CellType Analysis</span><br><span>## cluster geneset 0</span><br><br><span>### Gene List</span><br><span>''</span><span>'<br>LDHB, LTB, RGCC, IL32, NOSIP, CD3D, CD3E, TMEM123, VIM, TMEM66, FYB, JUNB, CCR7, CD27, MYL12A<br>'</span><span>''</span><br><br><span>### Celltype Prediction</span><br><span>#### Optimal Celltype: T Cells (likely CD4+ T cells)</span><br>**Key Markers**:<br>- Cell-specific: CD3D, CD3E, CCR7, CD27, FYB<br>- Context-specific: LTB, JUNB, VIM<br><br>**Evidence and Reasoning**<br>- **PRIMARY EVIDENCE**: The presence of CD3D and CD3E, <span>which</span> are essential components of the T cell receptor complex, strongly indicates a T cell population. These markers are highly specific to T cells.<br>- **SECONDARY EVIDENCE**: CCR7 is a chemokine receptor that is typically expressed on naïve and central memory T cells, suggesting that these cells may be <span>in</span> a non-activated or memory state.<br>- **ADDITIONAL EVIDENCE**: CD27 and FYB are also known to be expressed <span>in</span> T cells, particularly <span>in</span> activated T cells. LTB (lymphotoxin beta) and JUNB (a transcription factor) are involved <span>in</span> T cell activation and <span>function</span>.<br><br>**Validation**: Other gold standard markers <span>for</span> T cells (not <span>in</span> Geneset 0) include CD4, CD8, and TCRα/β. For CD4+ T cells, additional markers like CD45RA and CD45RO can be used to distinguish between naïve and memory T cells.<br><br><span>#### Alternative Considerations</span><br>- **Alternative celltype1: NK cells**<br>    - **WHY Alternative? Key MARKERS, Evidence and Reasoning**: NK cells can express some of the markers found <span>in</span> this geneset, such as CCR7 and CD27, but the presence of CD3D and CD3E, <span>which</span> are not expressed <span>in</span> NK cells, makes this less likely.<br>    - **OTHER Gold Standard MARKERS(NOT IN Geneset 0) TO VALIDATE THE Alternative celltype1**: NK cells would typically express NKp46, KIRs, and NKG2D, <span>which</span> are not present <span>in</span> this geneset.<br><br>- **Alternative celltype2: B cells**<br>    - **WHY Alternative? Key MARKERS, Evidence and Reasoning**: B cells <span>do</span> not typically express CD3D and CD3E, <span>which</span> are strong T cell markers. However, some B cell markers like CD27 and CCR7 are present, <span>which</span> might lead to confusion. The absence of B cell-specific markers like CD19 and CD20 makes this alternative less likely.<br>    - **OTHER Gold Standard MARKERS(NOT IN Geneset 0) TO VALIDATE THE Alternative celltype2**: B cells would typically express CD19, CD20, and surface IgM, <span>which</span> are not present <span>in</span> this geneset.<br><br><span>### Novel Insights</span><br>- **NOTEWORTHY PATTERNS**: The co-expression of CCR7 and CD27 suggests a population of T cells that are either naïve or central memory T cells.<br>- **CELL STATE**: The expression of JUNB and LTB, along with other activation-related genes, suggests that these T cells may be <span>in</span> an activated or recently activated state.<br>- **POTENTIAL NEW FINDINGS**: The presence of VIM (vimentin), a marker often associated with mesenchymal cells, <span>in</span> T cells is intriguing and could indicate a unique subset of T cells or a state of T cells that have undergone some form of stress or activation leading to the upregulation of vimentin.<br></code></pre><p data-tool="mdnice编辑器">和基于已知gene marker的手动注释的结果进行比较</p><pre data-tool="mdnice编辑器"><span></span><code>cell_type_name = {<br>    <span>"0"</span>: <span>"CD4 T"</span>,<br>    <span>"1"</span>: <span>"B"</span>,<br>    <span>"2"</span>: <span>"FCGR3A+ Monocytes"</span>,<br>    <span>"3"</span>: <span>"NK"</span>,<br>    <span>"4"</span>: <span>"CD8 T"</span>,<br>    <span>"5"</span>: <span>"CD14+ Monocytes"</span>,<br>    <span>"6"</span>: <span>"Dendritic"</span>,<br>    <span>"7"</span>: <span>"Platelet"</span>,<br>}<br><br>adata.obs[<span>"celltype_manual"</span>] = adata.obs[<span>"leiden"</span>].map(<br>    cell_type_name<br>)<br>adata.obs[<span>"celltypes_gbi"</span>] = adata.obs[<span>"leiden"</span>].map(<br>    res<br>)<br>sc.pl.umap(adata, color=[<span>"leiden"</span>, <span>"celltype_manual"</span>, <span>"celltypes_gbi"</span>], legend_loc=<span>"on data"</span>, frameon=False)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050786" data-ratio="0.27314814814814814" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwOKS9WibhfRGwEIT5HKK749hy74u7REXfPEgboZPz6jYoYfdpBOmvlFgeUf2bLf2Z8CvS2V0sATXQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwOKS9WibhfRGwEIT5HKK749hy74u7REXfPEgboZPz6jYoYfdpBOmvlFgeUf2bLf2Z8CvS2V0sATXQ/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>Seurat 用法</span><span></span></h2><p data-tool="mdnice编辑器">当前GPTBioinsightor 并没有R版本，<strong>如果你是Seurat用户，仍然可以较方便的使用GPTBioinsightor下载数据：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>mkdir data<br>wget http://cf.10xgenomics.com/samples/cell-exp/1.1.0/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz -O data/pbmc3k_filtered_gene_bc_matrices.tar.gz<br><span>cd</span> data; tar -xzf pbmc3k_filtered_gene_bc_matrices.tar.gz<br></code></pre><p data-tool="mdnice编辑器">然后在R里采用Seurat进行数据分析：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 更详细的Seurat数据处理参考 https://satijalab.org/seurat/articles/pbmc3k_tutorial.html</span><br>library(dplyr)<br>library(Seurat)<br>library(patchwork)<br><br><span># Load the PBMC dataset</span><br>pbmc.data &lt;- Read10X(data.dir = <span>"data/filtered_gene_bc_matrices/hg19/"</span>)<br><span># Initialize the Seurat object with the raw (non-normalized data).</span><br>pbmc &lt;- CreateSeuratObject(counts = pbmc.data, project = <span>"pbmc3k"</span>, min.cells = 3, min.features = 200)<br>pbmc<br><br>pbmc[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(pbmc, pattern = <span>"^MT-"</span>)<br>pbmc &lt;- subset(pbmc, subset = nFeature_RNA &gt; 200 &amp; nFeature_RNA &lt; 2500 &amp; percent.mt &lt; 5)<br>pbmc &lt;- NormalizeData(pbmc)<br>pbmc &lt;- FindVariableFeatures(pbmc, selection.method = <span>"vst"</span>, nfeatures = 2000)<br>all.genes &lt;- rownames(pbmc)<br>pbmc &lt;- ScaleData(pbmc, features = all.genes)<br>pbmc &lt;- RunPCA(pbmc, features = VariableFeatures(object = pbmc))<br><br>pbmc &lt;- FindNeighbors(pbmc, dims = 1:10)<br>pbmc &lt;- FindClusters(pbmc, resolution = 0.5)<br><br>pbmc &lt;- RunUMAP(pbmc, dims = 1:10)<br><br>pbmc.markers &lt;- FindAllMarkers(pbmc, only.pos = TRUE)<br>pbmc.markers.fil &lt;- pbmc.markers %&gt;%<br>    group_by(cluster) %&gt;%<br>    dplyr::filter(avg_log2FC &gt; 1 &amp; p_val_adj &lt; 0.01)<br><br><span>## 保存差异基因到一个CSV文件里</span><br>write.csv(pbmc.markers.fil, <span>"data/pbmc.markers.fil.csv"</span>)<br></code></pre><p data-tool="mdnice编辑器">上面导出来了每个亚群的基因列表csv文件，接下来就可以去Python环境中使用GPTBioinsightor来读上面的基因列表csv文件进行细胞类型注解</p><pre data-tool="mdnice编辑器"><span></span><code><span>### 设置大语言模型的 API KEY</span><br>import os<br>os.environ[<span>'API_KEY'</span>] = <span>"sk-***"</span><br><br>import gptbioinsightor as gbi<br><br>result_dict = gbi.get_marker_from_seurat(<span>"data/pbmc.markers.fil.csv"</span>)<br><br><span># 设置数据的背景信息</span><br>background = <span>"Cells are PBMCs from a Healthy Donor"</span> <br><br><span># 使用阿里的通义千问qwen2-72b-instruct</span><br><span># 也可以设置成openai 的模型</span><br>res = gbi.get_celltype(result_dict, background=background,<br>                       out=<span>"Seurat.qwen.celltype.md"</span>, n_jobs=4,<br>                       topnumber=15, provider=<span>"aliyun"</span>, model=<span>"qwen-max-latest"</span>)<br>res<br><br><span>#{0: ' T Cells',</span><br><span># 1: ' Monocytes',</span><br><span># 2: ' T Helper Cells',</span><br><span># 3: ' B cells',</span><br><span># 4: ' Cytotoxic T Cells',</span><br><span># 5: ' Monocytes',</span><br><span># 6: ' NK Cells',</span><br><span># 7: ' Plasmacytoid Dendritic Cells (pDCs)',</span><br><span># 8: ' Platelets'}</span><br></code></pre><p data-tool="mdnice编辑器">欢迎大家使用提出意见，<span><strong>AI只是辅助，需要小心求证</strong></span>。更多软件文档参见：https://gptbioinsightor.readthedocs.io/zh-cn/latest/index.html</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span>如果没有人工智能大模型</span><span></span></h3><p data-tool="mdnice编辑器">也可以<span>使用一些网页工具，比如哈医大的一个在线工具：</span></p><ul data-tool="mdnice编辑器"><li><section>链接：https://genomemedicine.biomedcentral.com/articles/10.1186/s13073-023-01249-5</section></li><li><section>文章标题：《Annotation of cell types (ACT): a convenient web server for cell type annotation》</section></li><li><section>网页工具链接：</section></li><ul><li><section>http://xteam.xbio.top/ACT/</section></li><li><section>http://biocc.hrbmu.edu.cn/ACT/</section></li></ul></ul><p data-tool="mdnice编辑器">很简单的就给出来了如下所示的亚群名字：</p><p><img data-galleryid="" data-imgfileid="100050802" data-ratio="0.2740740740740741" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTaliceQdDzzLIb2ibcWJYXoWYVH0hezz5jnckwJy8HkndNicr0fdbjRQAE4VCiax58fkXFWjBceEqIGw/640?wx_fmt=png&amp;from=appmsg&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTaliceQdDzzLIb2ibcWJYXoWYVH0hezz5jnckwJy8HkndNicr0fdbjRQAE4VCiax58fkXFWjBceEqIGw/640?wx_fmt=png&amp;from=appmsg&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><figure data-tool="mdnice编辑器"><figcaption>亚群名字</figcaption></figure><p data-tool="mdnice编辑器">只需要在网页工具的主页输入我们的亚群7 的基因列表而已，按照网页工具要求的格式哦，如下所示：<code>cluster1:TUBB1 ,GP9 ,PPBP</code></p><p><img data-galleryid="" data-imgfileid="100050803" data-ratio="0.7555555555555555" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTaliceQdDzzLIb2ibcWJYXoWGG8nMibqf0LAjtamaDNfqSSonFrvap5MM9efSs3AhIic0CWYarwzF0wQ/640?wx_fmt=png&amp;from=appmsg&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTaliceQdDzzLIb2ibcWJYXoWGG8nMibqf0LAjtamaDNfqSSonFrvap5MM9efSs3AhIic0CWYarwzF0wQ/640?wx_fmt=png&amp;from=appmsg&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><figure data-tool="mdnice编辑器"><figcaption>照网页工具要求的格式</figcaption></figure><p data-tool="mdnice编辑器">当然了，我们可以很轻松的针对全部的亚群都输出top的高表达量的基因列表，并且符合网页工具的输入格式，即可一次性全部的自动化注释单细胞亚群的生物学名字啦！</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/47CicbLQOxtUymt6MRygkC0Sgwq6HtJqUudviclqznYST0yYIRNLfT0J18hq9ibmhJgNakCateGJ8NlDl5d1Szjr5FiapZ2sVYxh/640?wx_fmt=svg&amp;from=appmsg" data-fail="0"></span><code>load(file =  <span>'check-by-0.5/qc-_marker_cosg.Rdata'</span>)<br>head(marker_cosg)<br><span>## Top10 genes</span><br><span>library</span>(dplyr)  <br>cat(paste0(<span>'cluster'</span>,<span>0</span>:<span>18</span>,<span>':'</span>,<br>           unlist(apply(marker_cosg$names,<span>2</span>,<span>function</span>(x){<br>             paste(head(x),collapse=<span>','</span>)<br>           })),<span>'\n'</span>))<br></code></pre><p data-tool="mdnice编辑器">得到如下所示的各个亚群以及其配套的top6的基因列表：</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/47CicbLQOxtUymt6MRygkC0Sgwq6HtJqUudviclqznYST0yYIRNLfT0J18hq9ibmhJgNakCateGJ8NlDl5d1Szjr5FiapZ2sVYxh/640?wx_fmt=svg&amp;from=appmsg" data-fail="0"></span><code>cluster0:CD14,LGALS2,TMEM176B,CPVL,BLVRB,TMEM176A<br> cluster1:VCAN,S100A8,LYZ,MNDA,S100A12,S100A9<br> cluster2:S100A8,NEAT1,RGS2,CSF3R,VCAN,HBB<br> cluster3:LEF1,MAL,CCR7,TCF7,IL7R,LTB<br> cluster4:GNLY,KLRF1,SPON2,FGFBP2,KLRD1,HOPX<br> cluster5:CDKN1C,HES4,LYPD2,C1QA,CKB,TCF7L2<br> cluster6:GZMK,CD8A,CXCR6,CD8B,LAG3,KLRG1<br> cluster7:GP9,TUBB1,CMTM5,C6orf25,SDPR,GNG11<br> cluster8:PPBP,NRGN,CLU,PF4,PRKAR2B,F13A1<br> cluster9:IFITM1,IL32,NKG7,PTPRCAP,CALM1,GIMAP7<br> cluster10:FCER1A,ENHO,CD1C,CLEC10A,PKIB,CLIC2<br> cluster11:ANK3,PARP15,SYNE2,ITK,RORA,SLFN12L<br> cluster12:MS4A1,LINC00926,CD79A,VPREB3,FCER2,RP11-693J15.5<br> cluster13:TNFRSF17,TXNDC5,IGLL5,IGF1,POU2AF1,IGJ<br> cluster14:MMP8,MMP9,LTF,LCN2,PGLYRP1,ANXA3<br> cluster15:RETN,SLC39A8,CENPF,MKI67,IL1R2,C19orf59<br> cluster16:LILRA4,CLEC4C,LRRC26,SERPINF1,SCT,PTPRS<br> cluster17:CD34,C19orf77,EMID1,AP001171.1,PRSS57,NPR3<br> cluster18:LINC00278,KCNQ1OT1,RP11-362F19.1,CCRN4L,HCAR3,SPRED1<br></code></pre><p data-tool="mdnice编辑器">这个时候输入这么多信息到网页工具，就会很慢哦！成功了之后会有如下所示的单细胞亚群注释信息：</p><p><img data-galleryid="" data-imgfileid="100050805" data-ratio="0.39351851851851855" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTaliceQdDzzLIb2ibcWJYXoW5roqjKgSPfiabJFc3kPPuyIBYeUzWMAQ2r9LL6tmMVGkfAyxgf6mslQ/640?wx_fmt=png&amp;from=appmsg&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjTaliceQdDzzLIb2ibcWJYXoW5roqjKgSPfiabJFc3kPPuyIBYeUzWMAQ2r9LL6tmMVGkfAyxgf6mslQ/640?wx_fmt=png&amp;from=appmsg&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><figure data-tool="mdnice编辑器"><figcaption>单细胞亚群注释信息</figcaption></figure><p data-tool="mdnice编辑器">基本上跟我们自己的手动的亚群命名大差不差啦：</p><pre data-tool="mdnice编辑器"><span data-lazy-bgimg="https://mmbiz.qpic.cn/mmbiz_svg/47CicbLQOxtUymt6MRygkC0Sgwq6HtJqUudviclqznYST0yYIRNLfT0J18hq9ibmhJgNakCateGJ8NlDl5d1Szjr5FiapZ2sVYxh/640?wx_fmt=svg&amp;from=appmsg" data-fail="0"></span><code>celltype[celltype$ClusterID %<span>in</span>% c( <span>0</span>,<span>1</span>,<span>2</span>,<span>14</span>,<span>15</span> ),<span>2</span>]=<span>'cd14-mono'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>5</span>,<span>18</span>),<span>2</span>]=<span>'cd16-mono'</span>  <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>10</span> ),<span>2</span>]=<span>'cDC'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>16</span> ),<span>2</span>]=<span>'pDC'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>3</span> ),<span>2</span>]=<span>'CD4'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>4</span> ),<span>2</span>]=<span>'NK'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>6</span>,<span>9</span>,<span>11</span> ),<span>2</span>]=<span>'CD8'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>12</span> ),<span>2</span>]=<span>'Bcells'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c( <span>13</span> ),<span>2</span>]=<span>'plasma'</span><br>celltype[celltype$ClusterID %<span>in</span>% c( <span>7</span>,<span>8</span> ),<span>2</span>]=<span>'megakaryocyte'</span></code></pre></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span>单细胞+人工智能大模型交流群</span><span></span></h3><p data-tool="mdnice编辑器">恭喜你看到了文末，有惊喜，我们作为开发者非常希望看到大家对于工具的反馈，所以组建交流群欢迎大家踊跃参与讨论单细胞+人工智能大模型！</p></section><p><img data-galleryid="" data-imgfileid="100050807" data-ratio="1.1971830985915493" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwOKS9WibhfRGwEIT5HKK749FibbFsTt3Cf9k25AVHyxia0wkgr3d5licJzWponiaGf1icLymQreWy71FwQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="284" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwOKS9WibhfRGwEIT5HKK749FibbFsTt3Cf9k25AVHyxia0wkgr3d5licJzWponiaGf1icLymQreWy71FwQ/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器"><br></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/HqYE2jyRWYF4FpoBHdDR-w",target="_blank" rel="noopener noreferrer">原文链接</a>
