---
title: "多个单细胞亚群合并"
date: 2024-10-23T05:32:02Z
draft: ["false"]
tags: [
  "fetched",
  "Investigator进修录"
]
categories: ["Acdemic"]
---
多个单细胞亚群合并 by Investigator进修录
------
<div><section data-style-type="5" data-tools="新媒体排版" data-id="2430070"><section data-style-type="5" data-tools="新媒体排版" data-id="2390348"><section><section powered-by="xiumi.us"><section><section><section powered-by="xiumi.us"><section><section><br></section><section><section><section><section><p>分享是一种态度</p></section></section></section></section></section></section></section><section><section powered-by="xiumi.us"><section><section><img data-ratio="0.8738095238095238" data-type="gif" data-w="420" width="100%" data-src="https://mmbiz.qpic.cn/mmbiz_gif/siaia0BDGJdjSnnb9ibXpFagGPWQ0JjSSTNVBZthROEhicfINuLcxX2Ro3Zb600LJhrzeYIb120tLjSVXEtLn14DwA/640?wx_fmt=gif" src="https://mmbiz.qpic.cn/mmbiz_gif/siaia0BDGJdjSnnb9ibXpFagGPWQ0JjSSTNVBZthROEhicfINuLcxX2Ro3Zb600LJhrzeYIb120tLjSVXEtLn14DwA/640?wx_fmt=gif"></section></section></section></section></section></section></section></section></section><section data-width="100%"><section><br></section></section><p><br></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">很多时候，我们都没办法很快判断seurat默认聚类分群后的每个亚群的生物学命名，会短暂的把大家先归纳为一个大类，比如肿瘤单细胞数据第一次分群通用规则，按照 ：</p><ul data-tool="mdnice编辑器"><li><section>immune (CD45+,PTPRC),</section></li><li><section>epithelial/cancer (EpCAM+,EPCAM),</section></li><li><section>stromal (CD10+,MME,fibo or CD31+,PECAM1,endo)</section></li></ul><p data-tool="mdnice编辑器">这3大亚群都有自己的标记基因，它们其实都是涵盖了非常多的亚群，这个时候就需要一定程度的代码进行合并它们多个单细胞亚群。</p><p data-tool="mdnice编辑器">下面我们以 seurat 官方教程为例：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<br><span>library</span>(Seurat)<br><span># devtools::install_github('satijalab/seurat-data')</span><br><span>library</span>(SeuratData)<br><span>library</span>(ggplot2)<br><span>library</span>(patchwork)<br><span>library</span>(dplyr)<br>load(file = <span>'basic.sce.pbmc.Rdata'</span>)<br><br>DimPlot(pbmc, reduction = <span>'umap'</span>, <br>        label = <span>TRUE</span>, pt.size = <span>0.5</span>) + NoLegend()<br><br>sce=pbmc<br></code></pre><p data-tool="mdnice编辑器">如果你不知道 <strong>basic.sce.pbmc.Rdata</strong>这个文件如何得到的，麻烦自己去跑一下 <a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247500816&amp;idx=1&amp;sn=25568540a54d63225def0804c05025f8&amp;scene=21#wechat_redirect" data-linktype="2">可视化单细胞亚群的标记基因的5个方法</a>，自己 save(pbmc,file = 'basic.sce.pbmc.Rdata') ，我们后面的教程都是依赖于这个 文件哦！</p><h2 data-tool="mdnice编辑器"><span></span><span>首先查看标记基因</span></h2><p data-tool="mdnice编辑器">其实缺一个高质量非冗余单细胞亚群标记基因数据库，假如我们的生物学认知不够，就不需要把T细胞分成  "Naive CD4 T" ,  "Memory CD4 T" , "CD8 T", "NK" 这些亚群，可以合并为T细胞这个大的亚群：</p><pre data-tool="mdnice编辑器"><span></span><code><span># 参考；https://mp.weixin.qq.com/s/9d4X3U38VuDvKmshF2OjHA </span><br>genes_to_check = c(<span>'PTPRC'</span>, <span>'CD3D'</span>, <span>'CD3E'</span>,  <span>'PRF1'</span> , <span>'NKG7'</span>,<br>            <span>'CD19'</span>, <span>'CD79A'</span>, <span>'MS4A1'</span> ,<br>            <span>'CD68'</span>, <span>'CD163'</span>, <span>'CD14'</span>,<br>            <span>"FCER1A"</span>, <span>"PPBP"</span>)<br>DotPlot(sce, group.by = <span>'seurat_clusters'</span>,<br>        features = unique(genes_to_check)) + RotatedAxis()<br></code></pre><p data-tool="mdnice编辑器">如果生物学背景知识不够，也可以勉强把细胞亚群进行生物学命名：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.5583333333333333" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSiaiaXCvHov9AY8oibDSyhfMGHbEiaSeDKOuP7tGAxY1LJEnaegdO0iaKqclGVzf5tucOMXm6B0Jh4X9g/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSiaiaXCvHov9AY8oibDSyhfMGHbEiaSeDKOuP7tGAxY1LJEnaegdO0iaKqclGVzf5tucOMXm6B0Jh4X9g/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">我们这里假装自己的生物学背景很弱，所以只能是区分 B、DC、Mono、Platelet、T 这5个细胞亚群。</p><h3 data-tool="mdnice编辑器"><span></span><span>方法一：使用 RenameIdents 函数</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>Idents(sce)<br>levels(sce)<br>head(sce@meta.data)<br><span>#  method : 1 </span><br>new.cluster.ids &lt;- c(<span>"T"</span>, <span>"Mono"</span>, <span>"T"</span>, <br>                     <span>"B"</span>, <span>"T"</span>, <span>"Mono"</span>,<br>                     <span>"T"</span>, <span>"DC"</span>, <span>"Platelet"</span>)<br>names(new.cluster.ids) &lt;- levels(sce)<br>sce &lt;- RenameIdents(sce, new.cluster.ids)<br>DimPlot(sce, reduction = <span>'umap'</span>, <br>        label = <span>TRUE</span>, pt.size = <span>0.5</span>) + NoLegend()<br><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>方法二：使用unname函数配合向量：</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>cluster2celltype &lt;- c(<span>"0"</span>=<span>"T"</span>,<br>                  <span>"1"</span>=<span>"Mono"</span>, <br>                  <span>"2"</span>=<span>"T"</span>, <br>                  <span>"3"</span>= <span>"B"</span>, <br>                  <span>"4"</span>= <span>"T"</span>, <br>                  <span>"5"</span>= <span>"Mono"</span>,<br>                  <span>"6"</span>= <span>"T"</span>, <br>                  <span>"7"</span>= <span>"DC"</span>, <br>                  <span>"8"</span>= <span>"Platelet"</span>)<br>sce[[<span>'cell_type'</span>]] = unname(cluster2celltype[sce@meta.data$seurat_clusters])<br>DimPlot(sce, reduction = <span>'umap'</span>, group.by = <span>'cell_type'</span>,<br>        label = <span>TRUE</span>, pt.size = <span>0.5</span>) + NoLegend()<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>方法三：使用数据框</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span># 一个数据框 </span><br>(n=length(unique(sce@meta.data$seurat_clusters)))<br>celltype=data.frame(ClusterID=<span>0</span>:(n-<span>1</span>),<br>                    celltype=<span>'unkown'</span>)<br>celltype[celltype$ClusterID %<span>in</span>% c(<span>0</span>,<span>2</span>,<span>4</span>,<span>6</span>),<span>2</span>]=<span>'T'</span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>3</span>),<span>2</span>]=<span>'B'</span><br>celltype[celltype$ClusterID %<span>in</span>% c(<span>1</span>,<span>5</span>),<span>2</span>]=<span>'Mono'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c(<span>7</span>),<span>2</span>]=<span>'DC'</span> <br>celltype[celltype$ClusterID %<span>in</span>% c(<span>8</span>),<span>2</span>]=<span>'Platelet'</span><br>sce@meta.data$celltype = <span>"NA"</span><br><span>for</span>(i <span>in</span> <span>1</span>:nrow(celltype)){<br>  sce@meta.data[which(sce@meta.data$seurat_clusters == celltype$ClusterID[i]),<span>'celltype'</span>] &lt;- celltype$celltype[i]}<br>table(sce@meta.data$celltype)<br>DimPlot(sce, reduction = <span>'umap'</span>, group.by = <span>'celltype'</span>,<br>        label = <span>TRUE</span>, pt.size = <span>0.5</span>) + NoLegend()<br><br>head(sce@meta.data)<br>table(sce@meta.data$cell_type,<br>      sce@meta.data$celltype)<br></code></pre><p data-tool="mdnice编辑器">可以看到多种方法都是一样的效果：</p><pre data-tool="mdnice编辑器"><span></span><code>             B   DC Mono Platelet    T<br>  B         342    0    0        0    0<br>  DC          0   32    0        0    0<br>  Mono        0    0  642        0    0<br>  Platelet    0    0    0       14    0<br>  T           0    0    0        0 1608<br></code></pre><p data-tool="mdnice编辑器">得到了如下所示的粗糙分群：</p><figure data-tool="mdnice编辑器"><img data-ratio="0.3814814814814815" data-type="png" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSiaiaXCvHov9AY8oibDSyhfMGoUwKDaw8tianG7HBtaWUXlqiaWictofaqFV28iahvmwopEHpEulUKKNUtA/640?wx_fmt=png" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSiaiaXCvHov9AY8oibDSyhfMGoUwKDaw8tianG7HBtaWUXlqiaWictofaqFV28iahvmwopEHpEulUKKNUtA/640?wx_fmt=png"></figure><p data-tool="mdnice编辑器">绘图代码如下：</p><pre data-tool="mdnice编辑器"><span></span><code>p1=DimPlot(sce, reduction = <span>'umap'</span>, group.by = <span>'celltype'</span>,<br>           label = <span>TRUE</span>, pt.size = <span>0.5</span>) + NoLegend()<br>p2=DotPlot(sce, group.by = <span>'celltype'</span>,<br>           features = unique(genes_to_check)) + RotatedAxis()<br><span>library</span>(patchwork)<br>p1+p2<br></code></pre><hr data-tool="mdnice编辑器"><blockquote data-tool="mdnice编辑器"><p>注：如果想要获取文中代码。后台回复<strong>单细胞亚群</strong>即可！</p></blockquote></section><section><p><br></p><section data-style-type="5" data-tools="新媒体排版" data-id="2440476"><section><section><section><section><img data-ratio="0.9495798319327731" data-type="other" data-w="119" data-width="100%" data-src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=other" src="https://mmbiz.qpic.cn/mmbiz_gif/09gp6SvPE04j3m2v7Hr889icHUyibTOHs8YuUibicl7ibRD0ZwG5pDTjBluRreZvuib1o3BibvLkicYhnA4YW7dQsjn0cA/640?wx_fmt=other"></section><section data-brushtype="text">往期回顾</section><section><br></section></section></section></section><section><section data-autoskip="1"><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247494544&amp;idx=2&amp;sn=dba674537558dbb928aa8d87d83e7b30&amp;chksm=ea1ced12dd6b6404b724a88693387f362c2bb06bf032c0a094f181efea71c9de87d3ce6fae25&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>细胞亚群为什么一定要有清晰可见的界限</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247494542&amp;idx=1&amp;sn=d0bec660b2f803cfbce24b9a3ca9aa8e&amp;chksm=ea1ced0cdd6b641a3bc9ecea512d06c8e8b87262fa17273a9bf1a4008d332ace90ab792284b3&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>公开课-单细胞数据基础分析</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247494540&amp;idx=1&amp;sn=b892582468bda46c672c9ef1ced0de6e&amp;chksm=ea1ced0edd6b64183a5e74f998c8594d555e2dd5af7a2c293d3d1dd56c7bafbc1086bac71975&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>OSCA单细胞数据分析笔记7—Feature selection</span></a><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247494485&amp;idx=1&amp;sn=9c12a2dc613220ba0a63568a8bc2d36b&amp;chksm=ea1cedd7dd6b64c1a65020b944894543c0637757452afb700819f98069f89899168dd412b191&amp;scene=21#wechat_redirect" data-itemshowtype="0" tab="innerlink" data-linktype="2"><span>单细胞新药研发导论|| 数据之美</span></a><br></p></section></section><hr><p><br></p></section><section data-style-type="5" data-tools="新媒体排版" data-id="2440475"><hr><p><br></p><hr><section><p>如果你对单细胞转录组研究感兴趣，但又不知道如何入门，也许你可以关注一下下面的课程<span></span></p><p><br></p><ul><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247501633&amp;idx=3&amp;sn=85a34d84f29434f9ae8833cc2d7a0880&amp;chksm=9b4b87faac3c0eecf3333f80fb60b685bdeed6dd85f06ba929a55f1d760b846be21784dfd0a0&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>生信爆款入门-2021第3期</span></a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247494544&amp;idx=1&amp;sn=d41f9d4306feb1f90179d3c54e518bee&amp;chksm=ea1ced12dd6b64041aeb428a0dfce167cb5aaba36351cb8df3c47e08c2fbc76924ca646777e7&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>数据挖掘线下重启(成都站)(五月15和16的周六日)</span></a></p></li><li><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247501667&amp;idx=2&amp;sn=b05cb7181f632a557f0d78c6f31160d3&amp;chksm=9b4b87d8ac3c0ece42e259d2c39948dd6a1227b6c392213cb4564ae6a9926a6735f871da941b&amp;scene=21#wechat_redirect" data-itemshowtype="11" tab="innerlink" data-linktype="2"><span>明码标价之共享96线程384G内存服务器</span></a><br></p></li></ul><p><img data-ratio="1" data-type="gif" data-w="240" data-src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif" src="https://mmbiz.qpic.cn/mmbiz_gif/4TKeL1ZejtlKxOib5kmKX6ic6eX0w0WK5jvhtz9yBRsO3OI4yr6S5iaLNM7AbAeuPDHXMvDdur2DRz9wyiax4lEviag/640?wx_fmt=gif"><br></p><p><img data-ratio="0.05278592375366569" data-type="jpeg" data-w="341" data-src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz/4TKeL1Zejtlq03ZOSZiaTlic1MxgdKiaxTbOZ7ZSe0Xx1Ca8xF3L6Nyj1FYUajtYrSmRIHyZVSsAve0EAvEicZONpg/640?wx_fmt=jpeg"></p><p><strong><span>看完记得顺手点个</span></strong><span><strong><span>“在看”</span></strong></span><strong><span>哦！</span></strong></p></section><section><section data-tools="135编辑器" data-id="93668"><section><section data-width="95%"><section><section data-width="61.8%"><section><section><section><p><br></p><span><strong data-burshtype="text"><img data-copyright="0" data-cropselx1="0" data-cropselx2="109" data-cropsely1="0" data-cropsely2="109" data-ratio="1" data-type="jpeg" data-w="258" title="qrcode_for_gh_5a3c482ed99f_1280.jpg" data-src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg" src="https://mmbiz.qpic.cn/mmbiz/siaia0BDGJdjRMGrkqo64BGKecYk4akuHpGHVQs7FeOpY7eWbIPGC1tRw5Tw0oEPmx053mR9FTVerWvhuZchIpZw/640?wx_fmt=jpeg"><strong data-burshtype="text">生物</strong><strong data-burshtype="text"> | 单细胞 | 转录组丨资料</strong></strong></span></section><section><span><strong data-burshtype="text">每天都精彩</strong></span></section></section></section><section><section><section><section><p><span>长按扫码可关注</span></p></section></section></section></section></section></section></section></section></section></section></section></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/5a5FN1izegOAf-ojjrXwiA",target="_blank" rel="noopener noreferrer">原文链接</a>
