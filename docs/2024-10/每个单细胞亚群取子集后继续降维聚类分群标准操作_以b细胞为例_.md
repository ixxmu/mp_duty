---
title: "每个单细胞亚群取子集后继续降维聚类分群标准操作（以b细胞为例）"
date: 2024-10-12T05:11:56Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
每个单细胞亚群取子集后继续降维聚类分群标准操作（以b细胞为例） by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>针对这个这个胃癌单细胞数据集GSE163558，我做了解读，详见 ：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533053&amp;idx=1&amp;sn=bd155638b280e875dcae14622198b65b&amp;scene=21#wechat_redirect" data-linktype="2">单细胞转录组降维聚类分群过滤基因和过滤细胞的区别</a> 。而且前面已经是完成了降维聚类分群，在<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533061&amp;idx=1&amp;sn=de67737df31c0302667d9c7a75214415&amp;scene=21#wechat_redirect" data-linktype="2">学习单细胞亚群命名的层次结构</a> 演示了一个降维聚类分群结果，就有了  2-harmony/sce.all_int.rds 文件，以及对应的 phe.Rdata 注释信息。</p></blockquote><p data-tool="mdnice编辑器">值得注意是，我把文献里面的髓系免疫细胞区分成为巨噬细胞和中性粒细胞，还有mast细胞。然后就是把b细胞是可以区分成为浆细胞和普通b细胞。在文献里面的单细胞亚群以及其对应的基因和细胞数量分别是：</p><pre data-tool="mdnice编辑器"><span></span><code>&gt; <span>print</span>(cell_groups)<br>          Group Count               Genes<br>1    Epithelial  1743 EPCAM, KRT19, CLDN4<br>2       Stromal  1288 PECAM1, CLO1A2, VWF<br>3 Proliferative  1089  MKI67, STMN1, PCNA<br>4             T 24448     CD3D, CD3E, CD2<br>5             B  7708 CD79A, IGHG1, MS4A1<br>6            NK  1173  KLRD1, GNLY, KLRF1<br>7       Myeloid  5519  CSF1R, CSF3R, CD68<br></code></pre><p data-tool="mdnice编辑器">可以看到文献给出来的b细胞是7708个，然后我给出来的是6309个b细胞以及1245个浆细胞，数量上是差不多的！</p><p data-tool="mdnice编辑器">我给出来的第一层次降维聚类分群后的单细胞亚群命名后在各个样品的数量分布如下所示：</p><p><img data-galleryid="" data-imgfileid="100050039" data-ratio="0.987037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP7J2sDHdTsib6Eyic763PSpq83lj1Qa3HBYUCsGobNE1eztdgtjFRAlSHQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP7J2sDHdTsib6Eyic763PSpq83lj1Qa3HBYUCsGobNE1eztdgtjFRAlSHQ/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>单细胞亚群命名后在各个样品的数量分布</figcaption></figure><p data-tool="mdnice编辑器">这个时候b细胞和浆细胞因为在我们的第一层次降维聚类分群的umap图里面确实是泾渭分明，所以我就把它们拆开命名了。</p><h3 data-tool="mdnice编辑器"><span></span><span>以b细胞为例举例说明取子集后继续降维聚类分群标准操作</span><span></span></h3><p data-tool="mdnice编辑器">通常我们拿到了肿瘤相关的单细胞转录组的表达量矩阵后的第一层次降维聚类分群通常是：</p><ul data-tool="mdnice编辑器"><li><section>immune (CD45+,PTPRC),</section></li><li><section>epithelial/cancer (EpCAM+,EPCAM),</section></li><li><section>stromal (CD10+,MME,fibro or CD31+,PECAM1,endo)</section></li></ul><p data-tool="mdnice编辑器">参考我前面介绍过 <a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247488940&amp;idx=1&amp;sn=1cc8a8a74715087939b9721c0881775d&amp;scene=21#wechat_redirect" data-linktype="2">CNS图表复现08—肿瘤单细胞数据第一次分群通用规则</a>，这3大单细胞亚群构成了肿瘤免疫微环境的复杂。绝大部分文章都是抓住免疫细胞亚群进行细分，包括淋巴系（T,B,NK细胞）和髓系（单核，树突，巨噬，粒细胞）的两大类作为第二次细分亚群。但是也有不少文章是抓住stromal 里面的 fibro 和endo进行细分，并且编造生物学故事的。</p><p data-tool="mdnice编辑器">前面我们已经介绍了心肝脾肺肾等多个器官的上皮细胞的细分亚群， 以及免疫细胞里面的髓系和B细胞细分亚群：</p><ul data-tool="mdnice编辑器"><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247506948&amp;idx=1&amp;sn=025d7f91abfa1b68d7910c86cf709e43&amp;scene=21#wechat_redirect" data-linktype="2">B细胞细分亚群</a></section></li><li><section><a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247506971&amp;idx=1&amp;sn=f0242285e2c827d922f938d9858d4ffe&amp;scene=21#wechat_redirect" data-linktype="2">髓系免疫细胞细分亚群</a></section></li></ul><p data-tool="mdnice编辑器">既然是前面的第一层次降维聚类分群后有   2-harmony/sce.all_int.rds 文件，以及对应的 phe.Rdata 注释信息。工作文件夹里面新建了  sub-cluster/sub-epi-inferCNV 这样的文件夹结构，然后重新开始新的r项目，所以需要如下所示的代码提取b细胞：</p><pre data-tool="mdnice编辑器"><span></span><code>rm(list=ls())<br>options(stringsAsFactors = <span>F</span>) <br><span>source</span>(<span>'../../scRNA_scripts/lib.R'</span>)<br>set.seed(<span>123456789</span>) <br><span>###### step1:导入数据 ######    </span><br>sce.all.int = readRDS(<span>'../../2-harmony/sce.all_int.rds'</span>)<br>colnames(sce.all.int@meta.data) <br>load(<span>'../../phe.Rdata'</span>)<br>table(phe$celltype) <br><span># 因为前面的b细胞和浆细胞被我拆开命名，所以这个时候细分子集需要把两个都提取到</span><br>choose_cellIds=rownames(phe)[phe$celltype %<span>in</span>% c(<span>'Bcells'</span>,<span>'plasma'</span>) ]<br>sce.all=sce.all.int[,choose_cellIds]<br>sce.all=CreateSeuratObject(<br>  counts = sce.all@assays$RNA$counts,<br>  meta.data = sce.all@meta.data<br>) <br></code></pre><p data-tool="mdnice编辑器">然后是仍然使用第一层次降维聚类分群的标准代码即可；</p><pre data-tool="mdnice编辑器"><span></span><code><span>###### step2:QC质控 ######</span><br>dir.create(<span>"./1-QC"</span>)<br>setwd(<span>"./1-QC"</span>)<br><span># 如果过滤的太狠，就需要去修改这个过滤代码</span><br><span>source</span>(<span>'../../../scRNA_scripts/qc.R'</span>)<br>sce.all.filt = basic_qc(sce.all)<br>print(dim(sce.all))<br>print(dim(sce.all.filt))<br>setwd(<span>'../'</span>)<br>getwd()<br><br>sp=<span>'human'</span> <br><span>###### step3: harmony整合多个单细胞样品 ######</span><br><br><span>if</span>(<span>T</span>){<br>  dir.create(<span>"2-harmony"</span>)<br>  getwd()<br>  setwd(<span>"2-harmony"</span>)<br>  <span>source</span>(<span>'../../../scRNA_scripts/harmony.R'</span>)<br>  <span># 默认 ScaleData 没有添加"nCount_RNA", "nFeature_RNA"</span><br>  <span># 默认的</span><br>  sce.all.int = run_harmony(sce.all.filt)<br>  setwd(<span>'../'</span>)<br>  <br>}<br> <br><span>###### step4:  看标记基因库 ######</span><br><span># 原则上分辨率是需要自己肉眼判断，取决于个人经验</span><br><span># 为了省力，我们直接看  0.1和0.8即可</span><br><br>table(Idents(sce.all.int))<br>table(sce.all.int$seurat_clusters)<br>table(sce.all.int$RNA_snn_res.0.1) <br>table(sce.all.int$RNA_snn_res.0.8) <br><br>getwd()<br>dir.create(<span>'check-by-0.1'</span>)<br>setwd(<span>'check-by-0.1'</span>)<br>sel.clust = <span>"RNA_snn_res.0.1"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><br><span>source</span>(<span>'../../../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>dir.create(<span>'check-by-0.5'</span>)<br>setwd(<span>'check-by-0.5'</span>)<br>sel.clust = <span>"RNA_snn_res.0.5"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../../../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd()<br><br>dir.create(<span>'check-by-0.8'</span>)<br>setwd(<span>'check-by-0.8'</span>)<br>sel.clust = <span>"RNA_snn_res.0.8"</span><br>sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)<br>table(sce.all.int@active.ident) <br><span>source</span>(<span>'../../../scRNA_scripts/check-all-markers.R'</span>)<br>setwd(<span>'../'</span>) <br>getwd() <br></code></pre><p data-tool="mdnice编辑器">可以看到，这个时候取了子集后的单细胞转录组数据对象，仍然是进行了harmony整合哦。因为harmony操作针对的是pca分析结果，而我们取子集后相当于是一个从零开始的表达量矩阵了没有做过pca也没有任何降维聚类分群操作。也就是说，harmony操作并不会改变表达量矩阵本身。</p><p data-tool="mdnice编辑器">最后仍然是手动命名，前面我们提到了：<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533528&amp;idx=1&amp;sn=c731c51a3478151b7eaa040b4ad19e44&amp;scene=21#wechat_redirect" data-linktype="2">上皮细胞里面混入了淋巴系和髓系免疫细胞呢</a>，其实做每个单细胞亚群的子集同样的操作都会有其它干扰亚群的混入。大家可以详细的阅读 这个胃癌单细胞数据集GSE163558对应的文献“Revealing the transcriptional heterogeneity of organ-specific metastasis in human gastric cancer using single-cell RNA Sequencing”，就可以看到b细胞里面其实是有t细胞的混入 ：</p><p><img data-galleryid="" data-imgfileid="100050041" data-ratio="0.4759259259259259" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP74QLJQNNqdibcAuYRRIRXUf7AdMjUJM0SxniatehmpMq5JCNj125tibO6A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP74QLJQNNqdibcAuYRRIRXUf7AdMjUJM0SxniatehmpMq5JCNj125tibO6A/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>b细胞里面其实是有t细胞的混入</figcaption></figure><p data-tool="mdnice编辑器">大家处理这个数据集，也可以很容易的复现出来b细胞里面其实是有t细胞的混入，而且甚至是有髓系哦 ：</p><p><img data-galleryid="" data-imgfileid="100050040" data-ratio="0.5879629629629629" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP76icq8E4JtBjI0wIGr41FVDpWWEQ55euSh92jF9wVibibSD20ArZKvVv9A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP76icq8E4JtBjI0wIGr41FVDpWWEQ55euSh92jF9wVibibSD20ArZKvVv9A/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>甚至是有髓系哦</figcaption></figure><p data-tool="mdnice编辑器">这个时候还需要<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247506948&amp;idx=1&amp;sn=025d7f91abfa1b68d7910c86cf709e43&amp;scene=21#wechat_redirect" data-linktype="2">B细胞细分亚群</a>里面的基因列表来区分naive和memory这两种b细胞哦，在免疫学中，B细胞是适应性免疫系统的关键组成部分，负责产生抗体来识别和中和外来病原体。以下是关于B细胞的几个不同阶段和类型的描述，以及它们的区别：</p><ol data-tool="mdnice编辑器"><li><section><strong>Naive B细胞（未经激活的B细胞）</strong>：</section></li></ol><ul><li><section>这些是尚未遇到其特定抗原的B细胞。它们在骨髓中成熟，并在没有遇到病原体的情况下循环于血液中。</section></li></ul><li><section><strong>Memory B细胞（记忆B细胞）</strong>：</section></li><ul><li><section>记忆B细胞是在先前的免疫反应中遇到特定抗原后形成的。它们具有长期存活的能力，并能够快速响应再次出现的相同抗原，提供更快速和有效的免疫反应。</section></li></ul><li><section><strong>Germinal Center (GC) B细胞</strong>：</section></li><ul><li><section>GC B细胞是在淋巴器官的生发中心经历快速增殖和突变的B细胞。它们参与体细胞高频突变（somatic hypermutation, SHM）和抗体类别转换（class-switch recombination, CSR），以产生更高亲和力的抗体。</section></li></ul><li><section><strong>Plasma Cells（浆细胞）</strong>：</section></li><ul><li><section>浆细胞是B细胞激活和分化的最终阶段，主要功能是大量产生和分泌抗体。它们可以在骨髓中长期存活，并作为长期的抗体来源。</section></li></ul><p data-tool="mdnice编辑器"><strong>区别</strong>：</p><ul data-tool="mdnice编辑器"><li><section><strong>成熟阶段</strong>：Naive B细胞是成熟的早期阶段，而GC B细胞和记忆B细胞是成熟过程中的更晚阶段。</section></li><li><section><strong>功能</strong>：Naive B细胞尚未发挥功能，GC B细胞参与抗体的亲和力成熟，记忆B细胞提供长期免疫记忆，浆细胞负责抗体的产生。</section></li><li><section><strong>持久性</strong>：记忆B细胞和浆细胞在体内有较长的寿命，而Naive B细胞和GC B细胞的寿命相对较短。</section></li><li><section><strong>分布</strong>：Naive B细胞主要在血液和脾脏中循环，GC B细胞主要在淋巴结的生发中心，记忆B细胞和浆细胞可以在骨髓、脾脏和其他组织中找到。</section></li><li><section><strong>抗原经验</strong>：Naive B细胞没有遇到抗原的经验，而记忆B细胞和浆细胞是由先前接触过抗原的B细胞发展而来。</section></li></ul><p data-tool="mdnice编辑器">了解这些B细胞类型的区别对于研究免疫反应、疫苗开发和某些免疫相关疾病的治疗非常重要。</p><p data-tool="mdnice编辑器">根据<strong>文献积累</strong>，我们大概有下面的这些基因来区分不同的b细胞，如下所示：</p><p><img data-galleryid="" data-imgfileid="100050042" data-ratio="0.7277777777777777" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP7ryP8CyqYlqvxQmF4CVXEKeYaxnlf3IfxuEckk4M0V9k4cczNASRcNA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP7ryP8CyqYlqvxQmF4CVXEKeYaxnlf3IfxuEckk4M0V9k4cczNASRcNA/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>区分naive和memory这两种b细胞</figcaption></figure><p data-tool="mdnice编辑器">我给出来了对应关系，然后就做出来了比较合理的单细胞亚群注释 ；</p><pre data-tool="mdnice编辑器"><span></span><code>  celltype[celltype<span>$ClusterID</span> %<span>in</span>% c( 1 ),2]=<span>'navie'</span><br>  celltype[celltype<span>$ClusterID</span> %<span>in</span>% c( 0 ),2]=<span>'memory'</span><br>  celltype[celltype<span>$ClusterID</span> %<span>in</span>% c(2),2]=<span>'plasma'</span>  <br>  celltype[celltype<span>$ClusterID</span> %<span>in</span>% c(4),2]=<span>'GC'</span>   <br>  celltype[celltype<span>$ClusterID</span> %<span>in</span>% c(3),2]=<span>'Tcells'</span>      <br>  celltype[celltype<span>$ClusterID</span> %<span>in</span>% c(5),2]=<span>'myeloids'</span>  <br></code></pre><p><img data-galleryid="" data-imgfileid="100050043" data-ratio="0.5342592592592592" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP7OzicOwib7GR1p6icXa7mjA5pF2dKuKqsZ9jFxuO2r5auo9FW8U0zxfGIw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wzDplCbKym88VlAVmmTOibP7OzicOwib7GR1p6icXa7mjA5pF2dKuKqsZ9jFxuO2r5auo9FW8U0zxfGIw/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><figcaption>比较合理的单细胞亚群注释</figcaption></figure><p data-tool="mdnice编辑器">同样的每个单细胞亚群都可以找到自己的高表达量基因：</p><pre data-tool="mdnice编辑器"><span></span><code>clustermemory:TNFRSF13B,LINC01781,ZBTB20,TNFSF9,IER5,WSB1<br> clustermyeloids:FCGR3B,S100A9,S100A8,CXCL8,CMTM2,G0S2<br> clusterplasma:MZB1,FKBP11,DERL3,PRDX4,SLAMF7,FNDC3B<br> clusterTcells:IL32,CD3E,CD3D,CD2,CD3G,IL7R<br> clusternavie:YBX3,IGHD,TCL1A,FCER2,ZBTB16,CLEC2B<br> clusterGC:LMO2,SUGCT,SERPINA9,RAPGEF5,MYBL1,AC023590.1 <br></code></pre><p data-tool="mdnice编辑器">这些基因就可以去做go和kegg数据库的注释；</p><pre data-tool="mdnice编辑器"><span></span><code>load(<span>'../check-by-celltype/qc-_marker_cosg.Rdata'</span>) <br>head(marker_cosg)<br> symbols_list &lt;-  as.list(as.data.frame(apply(marker_cosg$names,<span>2</span>,head,<span>100</span>)))<br> symbols_list<br> <span>source</span>(<span>'../../com_go_kegg_ReactomePA_human.R'</span>)<br><span>#source('../com_go_kegg_ReactomePA_mice.R')</span><br>com_go_kegg_ReactomePA_human(symbols_list, pro=<span>'b'</span> )<br>setwd(<span>'../'</span>)<br><br></code></pre><p data-tool="mdnice编辑器">同理，接下来就可以看不同亚群的比例，<strong>针对这个细分后的结果进行拟时序分析，转录因子分析等等。这些分析都是在任意单细胞亚群是通用的代码。</strong></p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span>写在文末</span></h3></section><p>如果你也想做单细胞转录组数据分析，<span>最好是有自己的计算机资源哦，比如我们的</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533037&amp;idx=2&amp;sn=e6dd07e9339a84c8cbad2a9d6b42c8ca&amp;chksm=9b4b0156ac3c88403c55822722f6a93cde401fbb7b7cdbaee2a07211347e751ce414b7a47ec7&amp;scene=21#wechat_redirect" textvalue="2024的共享服务器交个朋友福利价仍然‍是800" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">2024的共享服务器交个朋友福利价仍然是800</a><span>，而且还需要有基本的生物信息学基础，也可以看看我们的</span><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247531929&amp;idx=1&amp;sn=f6f16b7bf6b907360d6d0052e3d10cf6&amp;chksm=9b4b3d22ac3cb434b6aa7753a4cf0f266578147ccf10b49cc834e46af578ee6de99be0accb30&amp;scene=21#wechat_redirect" textvalue="生物信息学马拉‍松授课（买一得五）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">生物信息学马拉松授课（买一得五）</a><span> ，你的生物信息学入门课。而且下周六日我们在广州线上授课哦：<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533462&amp;idx=1&amp;sn=db7335a759233b4cea8b56c394e4171e&amp;chksm=9b4b032dac3c8a3b3cec594bf475a12f6feec734d27c216a59d06f48164eaf04ea26e6e6746e&amp;scene=21#wechat_redirect" textvalue="千呼万唤，让我们广州线下约起" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">千呼万唤，让我们广州线下约起</a></span></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/avHS4ojBOkNDMwGFX0jdqQ",target="_blank" rel="noopener noreferrer">原文链接</a>
