---
title: "RNA-seq差异分析结果gseKEGG可视化"
date: 2024-10-10T23:39:24Z
draft: ["false"]
tags: [
  "fetched",
  "seqyuan"
]
categories: ["Acdemic"]
---
RNA-seq差异分析结果gseKEGG可视化 by seqyuan
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">这些文字用于记录RNA-seq 差异表达分析之后所有基因按照FoldChange排序gseKEGG富集结果的发表级画图代码，后续会整理成R包方便调用。</p><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(clusterProfiler)<br><span>library</span>(ggplot2)<br>Sys.setenv(LANGUAGE = <span>"en"</span>) <span>#显示英文报错信息</span><br>options(stringsAsFactors = <span>FALSE</span>) <span>#禁止chr转成factor</span><br><span>#library(org.Hs.eg.db)</span><br></code></pre><p data-tool="mdnice编辑器">下面是可视化核心优化代码，全网首发，好东西赶紧用起来</p><pre data-tool="mdnice编辑器"><span></span><code>do_gseKEGG &lt;- <span>function</span>(data, <br>                          gene_col=<span>"Gene"</span>, <br>                          value_col=<span>"Log2FoldChange"</span>, <br>                          OrgDb=<span>"org.Hs.eg.db"</span>,<br>                          organism=<span>"hsa"</span>, <br>                          pvalueCutoff=<span>1</span>,<br>                          pAdjustMethod=<span>"BH"</span><br>                         ){<br>    data &lt;- data[,c(gene_col, value_col)]<br>    data &lt;- data[order(data[[value_col]], decreasing=<span>TRUE</span>),]<br>    colnames(data) &lt;- c(<span>"SYMBOL"</span>, <span>"logFC"</span>)<br>    <br>    gsym.id &lt;- bitr(data$SYMBOL, fromType=<span>"SYMBOL"</span>, toType=<span>"ENTREZID"</span>, OrgDb=OrgDb)<br>    gsym.fc.id &lt;- merge(data, gsym.id, by=<span>"SYMBOL"</span>, all=<span>F</span>)<br><br>    <span>#按照foldchange排序</span><br>    gsym.fc.id.sorted &lt;- gsym.fc.id[order(gsym.fc.id$logFC, decreasing = <span>T</span>),]<br><br>    <span>#获得ENTREZID、foldchange列表，做为GSEA的输入</span><br>    id.fc &lt;- gsym.fc.id.sorted$logFC<br>    names(id.fc) &lt;- gsym.fc.id.sorted$ENTREZID<br>    <br>    res &lt;- gseKEGG(<br>      id.fc,    <span># 根据logFC排序的基因集</span><br>      organism = organism,    <span># 人的拉丁名缩写</span><br>      pvalueCutoff = pvalueCutoff,<br>      pAdjustMethod = pAdjustMethod<br>    )<br>    <br>    <span>#把ENTREZ ID转为gene symbol，便于查看通路里的基因</span><br>    kk.gsym &lt;- setReadable(res, OrgDb, <span>#物种</span><br>                           <span>'ENTREZID'</span>)<br>    <span>#按照enrichment score从高到低排序，便于查看富集的通路</span><br>    <span>#kk.gsym &lt;- kk.gsym[order(kk.gsym$NES, decreasing = F),]</span><br>    <span>#sortkk &lt;- kk.gsym[reorder(kk.gsym$p.adjust, decreasing = TRUE),]</span><br><br>    <span>return</span>(kk.gsym)<br>}<br><br>gseplot1 &lt;- <span>function</span>(data, xlabel=<span>"NES of Treat/Control gseKEGG"</span>){<br>    p &lt;- ggplot(data, aes(x = NES, y = reorder(Description, NES, decreasing = <span>FALSE</span>), color = p.adjust)) +<br>      geom_segment(aes(x = <span>0</span>, xend = NES, y = reorder(Description, NES, decreasing = <span>FALSE</span>), yend = Description), size = <span>1</span>) +<br>      geom_point(size = <span>7</span>, shape = <span>16</span>, aes(color = p.adjust)) +<br>      geom_text(aes(x = <span>0</span>, y = reorder(Description, NES, decreasing = <span>FALSE</span>), label = Description), <br>                size = <span>5</span>, <br>                hjust = <span>0.5</span>,  <span># Updated hjust</span><br>                vjust = -<span>0.6</span>, <br>                size = <span>3</span>,<br>               )+<br>      <span>#geom_text_repel(data=df_label, aes(NES, Description, label=label)) +</span><br>      scale_colour_gradientn(colours = c(<span>"dodgerblue1"</span>,<span>"#44c1f0"</span>, <span>"lightgoldenrod"</span>,<span>"#e20612"</span>,<span>'#cc340c'</span>), trans = <span>"reverse"</span>)+<br>      <span>#scale_color_viridis_c(trans = "reverse") +</span><br>      theme_minimal() +<br><br>      labs(x = xlabel, y = <span>""</span>, color = <span>"p.adjust"</span>) +<br>      theme(axis.text.x = element_text(size = <span>13</span>),<br>            axis.text.y = element_blank(),  <span># 去掉 y 轴标签</span><br>            plot.margin = margin(<span>1</span>, <span>1</span>, <span>1</span>, <span>1</span>, <span>"cm"</span>))  <span># 调整图形的左边距</span><br>    <br>    <br>    <span>return</span>(p)<br>}<br><br>gseplot2 &lt;- <span>function</span>(data, xlabel=<span>"NES of Treat/Control gseKEGG"</span>){<br>    p &lt;- ggplot(data, aes(x = NES, y = reorder(Description, NES, decreasing = <span>FALSE</span>), color = p.adjust)) +<br>      geom_segment(aes(x = <span>0</span>, xend = NES, y = reorder(Description, NES, decreasing = <span>FALSE</span>), yend = Description), size = <span>1</span>) +<br>      geom_point(size = <span>7</span>, shape = <span>16</span>, aes(color = p.adjust)) +<br>      geom_text(aes(x = <span>0</span>, y = reorder(Description, NES, decreasing = <span>FALSE</span>), label = Description), <br>                size=<span>5</span>, hjust = ifelse(data$NES &lt;= <span>0</span>, <span>0</span>, <span>1</span>), vjust = <span>0.5</span>, <br>                <span>#angle = ifelse(df$NES &lt;= 0, 0, 180)</span><br>               ) +<br>      <span>#geom_text_repel(data=df_label, aes(NES, Description, label=label)) +</span><br>      scale_colour_gradientn(colours = c(<span>"dodgerblue1"</span>,<span>"#44c1f0"</span>, <span>"lightgoldenrod"</span>,<span>"#e20612"</span>,<span>'#cc340c'</span>), trans = <span>"reverse"</span>)+<br>      <span>#scale_color_viridis_c(trans = "reverse") +</span><br>      theme_minimal() +<br>      labs(x = xlabel, y = <span>""</span>, color = <span>"p.adjust"</span>, size=<span>10</span>) +<br>      theme(axis.text.x = element_text(size = <span>15</span>),<br>            axis.text.y = element_blank(),  <span># 去掉 y 轴标签</span><br>            plot.margin = margin(<span>1</span>, <span>1</span>, <span>1</span>, <span>1</span>, <span>"cm"</span>))  <span># 调整图形的左边距</span><br>    <br>    <span>return</span>(p)<br>}<br></code></pre><p data-tool="mdnice编辑器">下面是几行功能是：</p><ol data-tool="mdnice编辑器"><li><section>读取RNA-seq差异表达数据</section></li><li><section>做gseKEGG富集</section></li><li><section>可视化</section></li></ol><pre data-tool="mdnice编辑器"><span></span><code>df &lt;- read.csv(<span>"treat_control.DE.xls"</span>, header=<span>TRUE</span>, sep=<span>"\t"</span>)<br>gse_kk &lt;- do_gseKEGG(df)<br><br><span># 按照NES排序</span><br>kk.gsym_sort &lt;- gse_kk[order(gse_kk$NES, decreasing = <span>F</span>),]<br><span># 获取排名前6的观测值</span><br>top_6 &lt;- kk.gsym_sort[<span>1</span>:<span>6</span>, ]<br><span># 获取排名末尾6的观测值</span><br>bottom_6 &lt;- kk.gsym_sort[(nrow(kk.gsym_sort) - <span>5</span>):nrow(kk.gsym_sort), ]<br>df_top &lt;- rbind(top_6, bottom_6)<br><span># write.table(gse_kk, "all.gseKEGG.tsv", sep="\t")</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>p &lt;- gseplot1(df_top)<br>options(repr.plot.width=<span>9</span>, repr.plot.height=<span>6</span>)<br>p<br><span># ggsave("abs_top6.allGeneFC.gseKEGG.pdf", p, w=9, h=6)</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000817" data-ratio="0.6761363636363636" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDyn9zayF2L9icNsVW9Y6h8I20Cc5iboibDMk7icARc7W3CFnh5DEC5hEZMC4VRlnAFiamgIXt8jEGrQVfg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="704" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDyn9zayF2L9icNsVW9Y6h8I20Cc5iboibDMk7icARc7W3CFnh5DEC5hEZMC4VRlnAFiamgIXt8jEGrQVfg/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>p &lt;- gseplot2(df_top)<br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000816" data-ratio="0.6780684104627767" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDyn9zayF2L9icNsVW9Y6h8I2jwiaWibILFBZcsqYP8OQs6j0j5PRHuFrYqAuiaib6bhKvWx92lxqYOv3LQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="497" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDyn9zayF2L9icNsVW9Y6h8I2jwiaWibILFBZcsqYP8OQs6j0j5PRHuFrYqAuiaib6bhKvWx92lxqYOv3LQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">对单个KEGG通路的基因富集做可视化</p><pre data-tool="mdnice编辑器"><span></span><code><span># devtools::install_github('junjunlab/GseaVis')</span><br><span>library</span>(GseaVis)<br><br>p &lt;- gseaNb(object = gse_kk,<br>       geneSetID = <span>'hsa04978'</span>,<br>       markTopgene = <span>TRUE</span>,<br>       kegg=<span>T</span>,<br>       addGene=c(<span>"ATP1A2"</span>, <span>"SLC9A3"</span>),<br>       addPval = <span>T</span>,<br>       pvalX = <span>0.55</span>, pvalY = <span>0.8</span>,<br>       pCol = <span>'black'</span>,<br>       pHjust = <span>0</span>, subPlot = <span>2</span>)<br><br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100000815" data-ratio="0.8138888888888889" data-src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDyn9zayF2L9icNsVW9Y6h8I2BryBp4s0VIMdNL24sLfnqlmA0bKnMTLhxJCpWO4TIpdsASeCch2SJw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="360" src="https://mmbiz.qpic.cn/mmbiz_png/SiacuSjV1nDyn9zayF2L9icNsVW9Y6h8I2BryBp4s0VIMdNL24sLfnqlmA0bKnMTLhxJCpWO4TIpdsASeCch2SJw/640?wx_fmt=png&amp;from=appmsg"></figure></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/k_kbGYWSlDSo0d9J9nb5Ig",target="_blank" rel="noopener noreferrer">原文链接</a>
