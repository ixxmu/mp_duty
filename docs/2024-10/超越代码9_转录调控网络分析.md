---
title: "超越代码9：转录调控网络分析"
date: 2024-10-17T00:52:02Z
draft: ["false"]
tags: [
  "fetched",
  "生信会客厅"
]
categories: ["Acdemic"]
---
超越代码9：转录调控网络分析 by 生信会客厅
------
<div><section><em>本次分享的教程源自我多年优化的实战代码，其中有很多提高效率和优化结果的自定义函数封装于scPRIT包。由于scPRIT包依赖特定的R和Python环境，我特意将它集成在docker镜像kinesin/rstudio:2.0.0中。为了确保教程代码的顺畅运行，推荐使用该docker镜像提供的分析环境。</em></section><p><em><br></em></p><section>组织内细胞异质性的基础是细胞转录状态的差异，转录状态的特异性又是由转录因子主导的基因调控网络（GRNs）决定并维持稳定的。因此分析单细胞的GRNs有助于深入挖掘细胞异质性背后的生物学意义，并为疾病的诊断、治疗以及发育分化的研究提供有价值的线索。然而单细胞转录组数据具有背景噪音高、基因检出率低和表达矩阵稀疏性的特点，给传统统计学和生物信息学方法推断高质量的GRNs带来了挑战。pySCENIC是一种专为单细胞数据开发的GRNs算法，它的创新之处在于引入了转录因子motif序列验证统计学方法推断的基因共表达网络，从而识别高可靠性的由转录因子主导的GRNs。</section><section><br></section><p><em></em></p><p><span><strong>pySCENIC基础分析</strong></span></p><section>使用scPRIT包的runSCENIC函数可以轻松完成基础分析，它会准备好表达矩阵，然后调用pySCENIC完成官方教程的4步分析：</section><ul><li><h3>STEP 1: Gene regulatory network inference, and generation of co-expression modules</h3></li><li><h3>STEP 2-3: Regulon prediction aka cisTarget</h3></li><li><h3>STEP 4: Cellular enrichment (aka AUCell)</h3></li></ul><p>数据库使用的是镜像内置的v10版</p><section><ul><li><li></ul><pre data-lang="nginx"><code><span><span>scRNA</span> &lt;- readRDS(<span>"~/project/BeyondCode/Data/sco.hny_anno_clean.rds"</span>)</span></code><code><span>runSCENIC(scRNA, species = <span>"human"</span>, output = <span>"BasicRes"</span>, ncore = <span>60</span>)</span></code></pre></section><p>运行结果保存在我们指定的BasicRes目录下，共有三个文件：<br></p><ul><li><p>adjacencies.csv：GRNBoost2算法的运行结果，记录了每个转录因子与每个基因的调控关系重要性评分。该算法基于机器学习来预测基因之间的调控关系，它的计算过程依赖于大量决策树的构建和优化，因此需要较多的计算资源和时间来完成。</p></li><li><p>motifs.csv：cisTarget的分析结果，记录了经过数据库验证的转录调控关系。<span>GRNBoost2的分析结果仅仅提供了理论上可能存在的基因调控关系。</span><span>cisTarget</span><span>通过比对基因组序列与已知的转录因子结合位点数据库，识别出潜在的顺式调控元件及其对应的转录因子结合位点，从而提供了一种基于实验证据的转录调控关系</span><span>。</span>根据cisTarget提供的评分，可以进一步过滤并定义regulons。</p></li><li><p>auc_mtx.csv：AUCell的评分矩阵，记录了regulons在每个细胞的活性评分。Regulons 是指转录因子（TFs）及其直接调控的一组靶基因组成的基因集。</p></li></ul><p><br></p><p><br></p><p><span><strong>pySCENIC拓展分析</strong></span><br></p><p><span><strong>提取regulon基因集</strong></span></p><section><span>motifs.csv虽然记录了TF结合的motif，以及对应的靶基因，但是它的格式不利于后续利用regulons开展进一步的分析。</span></section><p><img data-galleryid="" data-imgfileid="100002722" data-ratio="0.413760603204524" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxibW4ia6Yx8ph3Iicl64jqch0ys1OpIkjL6bZyiaSySNYK6cSd7egLd8OBQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1061" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxibW4ia6Yx8ph3Iicl64jqch0ys1OpIkjL6bZyiaSySNYK6cSd7egLd8OBQ/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li></ul><pre data-lang="javascript"><code><span>grn.getRegulons(<span>"BasicRes/motifs.csv"</span>)</span></code></pre></section><p><span>‍</span><br></p><p><span><strong>整合RAS矩阵</strong></span></p><p>将RAS (regulon activity scores) 矩阵整合入seurat对象可以更方便地开展下游分析和可视化。</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="nginx"><code><span><span># 读取ras矩阵并进行活性二进制转化</span></span></code><code><span><span>ras</span> &lt;- grn.getRAS(<span>"BasicRes/auc_mtx.csv"</span>)</span></code><code><span>saveRDS(ras, file = <span>"rasMat.rds"</span>)</span></code><code><span>bin.ras &lt;- grn.binRAS(rasMat = ras, ncores = <span>40</span>)</span></code><code><span>saveRDS(bin.ras, file = <span>"binRas.rds"</span>)</span></code><code><span><br></span></code><code><span><span># 结果导入seurat</span></span></code><code><span>scRNA[[<span>"Regulon"</span>]] &lt;- CreateAssayObject(counts = ras[,colnames(scRNA)])</span></code><code><span>scRNA[[<span>"binRegulon"</span>]] &lt;- CreateAssayObject(counts = bin.ras[,colnames(scRNA)])</span></code><code><span><br></span></code><code><span><span># 展示regulon活性评分</span></span></code><code><span>DefaultAssay(scRNA) &lt;- <span>"Regulon"</span></span></code><code><span>p1 &lt;- FeaturePlot(scRNA, features = <span>"HOXD1(+)"</span>) + ggtitle(<span>"HOXD1(+) RAS"</span>)</span></code><code><span>DefaultAssay(scRNA) &lt;- <span>"binRegulon"</span></span></code><code><span>p2 &lt;- FeaturePlot(scRNA, features = <span>"HOXD1(+)"</span>) + ggtitle(<span>"HOXD1(+) RAS binary"</span>)</span></code><code><span>p &lt;- p1|p2</span></code><code><span>ggsave(<span>"HOXD1_regulon_activity_score.pdf"</span>, p, width = <span>15</span>, height = <span>6</span>.<span>5</span>)</span></code><code><span><br></span></code><code><span><span># 保存</span></span></code><code><span>saveRDS(scRNA, file = <span>"sco.hny_anno_grn.rds"</span>)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002723" data-ratio="0.4287037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxJEmiaRTcu3KKGj9xnA2jhJZlrFNYTahpGgHTucKGHrnTNJRDMyxJh9A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxJEmiaRTcu3KKGj9xnA2jhJZlrFNYTahpGgHTucKGHrnTNJRDMyxJh9A/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><span><strong>Regulon特异性评分</strong></span></p><section>RSS(regulon specificity score)分析可以让我们快速找到细胞类型或分组特异性的regulons</section><section><ul><li><li><li><li></ul><pre data-lang="nginx"><code><span><span>group</span> &lt;- data.frame(celltype=scRNA<span>$CellType</span>)</span></code><code><span>rss.celltype &lt;- grn.getRSS(ras, group = group, ncol = <span>4</span>)</span></code><code><span>saveRDS(rss.celltype<span>$data</span>, file = <span>"RSS_CellType.rds"</span>)</span></code><code><span>ggsave(<span>"RSS_CellType.pdf"</span>, rss.celltype<span>$plot</span>, width = <span>12</span>, height = <span>12</span>)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002724" data-ratio="0.7555555555555555" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxBApej4Mha6WEib4szLp2rpnyqswklN3cmumtiaxh3xGx7XNvPIoiaR8cw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxBApej4Mha6WEib4szLp2rpnyqswklN3cmumtiaxh3xGx7XNvPIoiaR8cw/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><strong>RAS热图</strong><br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="cs"><code><span><span># 整理数据</span></span></code><code><span>rasMat &lt;- readRDS(<span>"rasMat.rds"</span>)</span></code><code><span>rssMat &lt;- readRDS(<span>"RSS_CellType.rds"</span>)</span></code><code><span>ctrank &lt;- c(<span>"T cell"</span>, <span>"NK"</span>, <span>"B cell"</span>, <span>"DC"</span>, <span>"Monocyte"</span>, <span>"Macrophage"</span>, <span>"Mast cell"</span>,</span></code><code><span>            <span>"Alveolar cell"</span>, <span>"Ciliated cell"</span>, <span>"Mesothelial cell"</span>,</span></code><code><span>            <span>"Vascular EC"</span>, <span>"Lymphatic EC"</span>, <span>"Stromal cell"</span>)</span></code><code><span><span>group</span> &lt;- data.frame(celltype = scRNA$CellType)</span></code><code><span>tmp &lt;- lapply(ctrank, function(x) subset(<span>group</span>, celltype==x))</span></code><code><span><span>group</span> &lt;- <span>do</span>.call(rbind, tmp)</span></code><code><span><span>group</span>$celltype &lt;- factor(<span>group</span>$celltype, levels = ctrank)</span></code><code><span>rssMat &lt;- rssMat[,ctrank]</span></code><code><span>rasMat &lt;- rasMat[,rownames(<span>group</span>)]</span></code><code><span><span># 提取top regulons</span></span></code><code><span>regs &lt;- rownames(rssMat)</span></code><code><span>topRegs &lt;- c(apply(rssMat, <span>2</span>, function(x) regs[order(x, decreasing = T)[<span>1</span>:<span>6</span>]]))</span></code><code><span>topRegs &lt;- unique(topRegs)</span></code><code><span><span># 单细胞水平热图</span></span></code><code><span>grn.rasHeatmap(rasMat[topRegs, ], <span>group</span> = <span>group</span>, useAverage = F, width = <span>9</span>, cluster_cols = F,</span></code><code><span>               cluster_rows = F, height = <span>6.5</span>, filename = <span>"Ras_scHeatmap.pdf"</span>)</span></code><code><span><span># 均值热图</span></span></code><code><span>grn.rasHeatmap(rasMat[topRegs, ], <span>group</span> = <span>group</span>, useAverage = T, width = <span>9</span>, cluster_rows = F, </span></code><code><span>               cluster_cols = F, height = <span>7</span>, filename = <span>"Ras_avgHeatmap.pdf"</span>)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002725" data-ratio="0.7228070175438597" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxgAP3iazwIRI1GdicSYib07t8R8H5RmelWNdH9Vehk7MhJVUNfpbddMVKw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="855" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxgAP3iazwIRI1GdicSYib07t8R8H5RmelWNdH9Vehk7MhJVUNfpbddMVKw/640?wx_fmt=png&amp;from=appmsg"></p><p><span>单细胞水平RAS热图</span><br></p><p><br></p><p><img data-galleryid="" data-imgfileid="100002726" data-ratio="0.7755813953488372" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxTW27uC61fLefjU7CG6O8AyRicwpmFeK1oEJCFAoqJrYnNODOYqkMNUA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="860" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxTW27uC61fLefjU7CG6O8AyRicwpmFeK1oEJCFAoqJrYnNODOYqkMNUA/640?wx_fmt=png&amp;from=appmsg"></p><p><span>RAS均值热图</span><br></p><p><br></p><p><strong>Regulon模块分析</strong></p><p>基于regulon连接特异性指数 (CSI, connection specificity index) 矩阵分析regulon模块经常出现在高分文献中，scPRIT包同样可以轻松实现。</p><section><ul><li><li><li></ul><pre data-lang="properties"><code><span><span># regulon模块</span></span></code><code><span><span>rasMat</span> <span>&lt;- readRDS("rasMat.rds")</span></span></code><code><span><span>grn.regulonMoudle(rasMat, k</span>=<span>13, width = 9, height = 8.5)</span></span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002729" data-ratio="0.9439906651108518" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szx1r4xmKuPfv7SqMWQliaXmS2bceCk0LHrZ6wrNGd47W2QmnF4a37Rl8A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="857" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szx1r4xmKuPfv7SqMWQliaXmS2bceCk0LHrZ6wrNGd47W2QmnF4a37Rl8A/640?wx_fmt=png&amp;from=appmsg"></p><section><ul><li><li><li><li><li><li></ul><pre data-lang="objectivec"><code><span><span># 子模块</span></span></code><code><span>Regulon_modules &lt;- readRDS(<span>"Regulon_modules.rds"</span>)</span></code><code><span>mymodules &lt;- Regulon_modules[<span>1</span>:<span>3</span>]</span></code><code><span>myregulons &lt;- <span>do</span>.call(c, mymodules)</span></code><code><span>grn.regulonMoudle(rasMat[myregulons, ], show_row_names = T, k=<span>7</span>, width = <span>7.5</span>, height = <span>6.5</span>,</span></code><code><span>                  vmin=<span>0.6</span>, <span>id</span>=<span>"Sub_modules"</span>, row_names_gp = gpar(fontsize = <span>8.5</span>))</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002730" data-ratio="0.8651685393258427" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxaWZ658S8Jy9A6OG81VZWtfVLkOxqmVhPEm0xBjITk7ASaqVtibyeeQw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="712" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxaWZ658S8Jy9A6OG81VZWtfVLkOxqmVhPEm0xBjITk7ASaqVtibyeeQw/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p>如果要实现文献中的效果（如下图），还需要手工添加热图右边的motif图标和其他文字注释信息。</p><p><img data-imgfileid="100002728" data-ratio="0.8467908902691511" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxTLduZGekHCIpTR3Poe9L0jNYpThPmiaZiaEOyWUNHEcQh29Ik1OmDOIw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="966" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/VTXDic6Eia0AHO7xJXD8Yxd57meoGr8szxTLduZGekHCIpTR3Poe9L0jNYpThPmiaZiaEOyWUNHEcQh29Ik1OmDOIw/640?wx_fmt=other&amp;from=appmsg"></p><p><br></p><p><br></p><section><strong><span>数据与资源</span></strong></section><section>本节分析数据与结果百度云下载链接<span>https://pan.baidu.com/s/1SJbInpGFKW-6adZvaRbAgg?pwd=tcq1</span></section><p>提取码：tcq1</p><p><br></p><p><span>kinesin/rstudio:2.0.0</span><span>镜像</span><span>和scPRIT包的开发、测试非常耗费时间和精力，后续我希望可以持续提供维护和更新服务，因此计划采用收费授权的模式，具体标准如下：</span></p><ul><li><p>200元，授权使用90天</p></li><li><p>600元，授权使用一年</p></li></ul><p>授权期内如有更新免费升级，有意者添加Kinesin微信购买。</p><p><br></p><p><span><strong><span>超越代码实战训练班</span></strong></span></p><p>很多第一次分析单细胞数据的朋友，会把70%的时间耗费在代码和生信基础问题上，真正用来思考生物学问题的时间非常有限，因此产出高水平的文章相对比较困难。<span>近几年，我深度参与了几十个单细胞、空转项目的分析，目前已有十几篇合作的署名/致谢文章发表。<span>如果有我这么一个过来人提供分析环境和实战流程，并参与您的项目讨论，或许可以起到事半功倍的效果。如果您对此有兴趣，请阅读《<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyMzMwNDQ2MA==&amp;mid=2247486184&amp;idx=1&amp;sn=413328830d29341abafdb7906524f4f7&amp;chksm=e821048bdf568d9d356c855b38f7cb65d0e3fdb88293c0f5a6bcf320385a57a31f457e8cf932&amp;scene=21#wechat_redirect" textvalue="超越代码" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">超越代码</a>》和《<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyMzMwNDQ2MA==&amp;mid=2247486190&amp;idx=1&amp;sn=c5af0dd634837e61d5dea4744b8765cb&amp;chksm=e821048ddf568d9b3a734f53471d03d2b7009aeaa3c982fa3addb6c07aa0ef1a48e2e4325cac&amp;scene=21#wechat_redirect" textvalue="单细胞分析实战训练班的课程规划" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞分析实战训练班的课程规划</a>》了解详情！</span></span></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/WDYMppWKvR3schwBL4e7mA",target="_blank" rel="noopener noreferrer">原文链接</a>
