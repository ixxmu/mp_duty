---
title: "总有一款配对散点图是你想要的"
date: 2024-10-22T13:01:47Z
draft: ["false"]
tags: [
  "fetched",
  "生信杂货铺"
]
categories: ["Acdemic"]
---
总有一款配对散点图是你想要的 by 生信杂货铺
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>前期准备</span><span></span></h2><h3 data-tool="mdnice编辑器"><span></span><span>导入模块</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: load-packages</span><br><span>#| message: false</span><br><br><span>library</span>(tidyverse)<br><span>library</span>(ggsignif)<br><span>library</span>(ggforce)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>处理数据</span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span>TCGA-LIHC 表达数据</span><span></span></h4><p data-tool="mdnice编辑器">使用 <code>UCSC Xena</code> 数据库中下载的 <code>GDC TCGA</code> 肝癌（<code>LIHC</code>）的表达数据及其对应的注释文件。</p><ul data-tool="mdnice编辑器"><li><section>TCGA-LIHC.star_fpkm.tsv</section></li><li><section>gencode.v36.annotation.gtf.gene.probemap</section></li></ul><p data-tool="mdnice编辑器">可以直接从链接中读取数据，最好还是将数据下载到本地再进行读取。例如</p><pre data-tool="mdnice编辑器"><span></span><code>probemap &lt;- read_delim(<span>"data/gencode.v36.annotation.gtf.gene.probemap"</span>, <br>                       delim = <span>"\t"</span>, show_col_types = <span>FALSE</span>) %&gt;%<br>    tibble::column_to_rownames(<span>"id"</span>)<br>lihc &lt;- read_tsv(<span>"data/TCGA-LIHC.star_fpkm.tsv.gz"</span>, <br>                 show_col_types = <span>FALSE</span>) %&gt;%<br>    mutate(symbol = probemap[Ensembl_ID,]$gene) %&gt;%<br>    dplyr::select(-Ensembl_ID) %&gt;%<br>    group_by(symbol) %&gt;%<br>    summarise_all(mean) %&gt;%<br>    tibble::column_to_rownames(<span>"symbol"</span>)<br></code></pre><p data-tool="mdnice编辑器">拆分原位癌和癌旁正常样本</p><pre data-tool="mdnice编辑器"><span></span><code><span># 01 -&gt; promary solid tumor</span><br>lihc.tumor &lt;- lihc[,substr(colnames(lihc), <span>14</span>, <span>15</span>) == <span>'01'</span>] %&gt;% t() %&gt;% as.data.frame()<br>rownames(lihc.tumor) &lt;- substr(rownames(lihc.tumor), <span>1</span>, <span>12</span>)<br><span># 11 -&gt; solid tissue normal</span><br>lihc.normal &lt;- lihc[,substr(colnames(lihc), <span>14</span>, <span>15</span>) == <span>'11'</span>,] %&gt;% t() %&gt;% as.data.frame()<br>rownames(lihc.normal) &lt;- substr(rownames(lihc.normal), <span>1</span>, <span>12</span>)<br></code></pre><p data-tool="mdnice编辑器">配对样本</p><pre data-tool="mdnice编辑器"><span></span><code>common &lt;- intersect(rownames(lihc.tumor), rownames(lihc.normal))<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>药物敏感性数据</span><span></span></h4><p data-tool="mdnice编辑器">使用场景可以是多种药物处理某一癌种的细胞系，对比细胞系在不同药物处理条件下的敏感性变化。从 <code>DepMap</code> 数据库中下载所有细胞系信息。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| warning: false</span><br><br>crc_cellline &lt;- read_csv(<span>"data/Model.csv"</span>, show_col_types = <span>FALSE</span>) %&gt;%<br>    dplyr::select(ModelID, OncotreePrimaryDisease) %&gt;%<br>    dplyr::filter(OncotreePrimaryDisease == <span>"Colorectal Adenocarcinoma"</span>)<br></code></pre><p data-tool="mdnice编辑器">读取预处理好的几种铁死亡药物在所有细胞系中的敏感性。这里只选择了三种药物在结直肠癌细胞系中的敏感性，并去除没有同时检测三种药物的细胞系。</p><pre data-tool="mdnice编辑器"><span></span><code>auc &lt;- read_delim(<span>"data/use_auc.txt"</span>, delim = <span>"\t"</span>, <br>                  show_col_types = <span>FALSE</span>) %&gt;%<br>    dplyr::filter(cell_line %<span>in</span>% crc_cellline$ModelID) %&gt;%<br>    dplyr::select(-c(CIL56, ML210)) %&gt;%<br>    dplyr::filter(if_all(everything(), ~ !is.na(.))) %&gt;%<br>    pivot_longer(-cell_line)<br></code></pre><p data-tool="mdnice编辑器">自定义样式</p><pre data-tool="mdnice编辑器"><span></span><code>my_palette &lt;- c(<span>"#42b7b9"</span>, <span>"#c75dab"</span>)<br>my_theme &lt;- theme_bw() +<br>    theme(<br>        strip.background = element_blank(),<br>        strip.text = element_text(size = <span>12</span>),<br>        strip.placement = <span>"outside"</span>,<br>        panel.grid = element_blank(),<br>        axis.text = element_text(size = <span>14</span>),<br>        axis.title = element_text(size = <span>16</span>)<br>    )<br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>两组配对</span><span></span></h2><p data-tool="mdnice编辑器">使用场景一般是配对的癌症与正常样本中基因的差异表达</p><h3 data-tool="mdnice编辑器"><span></span><span>单基因</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>gene &lt;- <span>"ATF3"</span><br>data &lt;- lihc.tumor[common, c(gene), drop = <span>FALSE</span>] %&gt;%  <span># drop 防止向量化</span><br>    mutate(type = <span>"Tumor"</span>) %&gt;%<br>    tibble::rownames_to_column(<span>'sample'</span>) %&gt;%<br>    rbind(<br>        lihc.normal[common, gene, drop = <span>FALSE</span>] %&gt;%<br>        mutate(type = <span>"Normal"</span>) %&gt;%<br>            tibble::rownames_to_column(<span>'sample'</span>))<br>head(data)<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>普通的重叠点</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># !!sym() 将变量转化为向量语法</span><br>ggplot(data, aes(type, !!sym(gene), group = sample)) +  <br>    geom_line(colour = <span>"#caccd1"</span>) +<br>    geom_point(aes(fill = type), shape = <span>21</span>, size = <span>5</span>, show.legend = <span>FALSE</span>,<br>               stroke = <span>0.8</span>, alpha = <span>0.9</span>) +<br>    scale_fill_manual(values = my_palette) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015647" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBlVd3QRoUZUNiaFPWNCYw6slcia4Fpof9RIVeUrkH0XSycFsa0BQR0v8A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBlVd3QRoUZUNiaFPWNCYw6slcia4Fpof9RIVeUrkH0XSycFsa0BQR0v8A/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>抖动的点图</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span># line 和 point 的 position 需要设置为一样的</span><br>ggplot(data, aes(type, !!sym(gene), group = sample)) +<br>    geom_line(colour = <span>"#caccd1"</span>, position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_point(aes(fill = type), shape = <span>21</span>, size = <span>5</span>, show.legend = <span>FALSE</span>,<br>               position = position_dodge2(width = <span>0.2</span>), stroke = <span>0.8</span>, <br>               alpha = <span>0.9</span>) +<br>    scale_fill_manual(values = my_palette) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015648" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBNYj7Xvm4eqChFhcYLCaOEEN0Sh9lHTmn6F7tVaTyRFIP2t9ojIqDrg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBNYj7Xvm4eqChFhcYLCaOEEN0Sh9lHTmn6F7tVaTyRFIP2t9ojIqDrg/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>贝塞尔曲线</span><span></span></h4><p data-tool="mdnice编辑器">构建贝塞尔曲线数据</p><pre data-tool="mdnice编辑器"><span></span><code><span># 先绘制图形</span><br>p &lt;- ggplot(data, aes(type, !!sym(gene))) +<br>    geom_point(aes(fill = type), shape = <span>21</span>, size = <span>5</span>, show.legend = <span>FALSE</span>,<br>               position = position_dodge2(width = <span>0.2</span>))<br><span># 然后从图形中获取点的位置</span><br>line.data &lt;- ggplot_build(p)$data[[<span>1</span>]] %&gt;%<br>    dplyr::select(c(<span>"x"</span>, <span>"y"</span>, <span>"group"</span>)) %&gt;%<br>    mutate(index = rep(<span>1</span>:sum(group == <span>1</span>), length(unique(group)))) %&gt;%<br>    group_by(index) %&gt;% <span># 将数据点分组，然后根据每个分组的点创建数据</span><br>    group_modify(<span>function</span> (data, group) {<br>        <span># bezier 需要 3-4 个点，我们统一设置为 4 个点，±0.3 可以自己调整曲率</span><br>        data.frame(<br>            x = c(data$x[<span>1</span>], data$x[<span>1</span>] + <span>0.3</span>, data$x[<span>2</span>] - <span>0.3</span>, data$x[<span>2</span>]),<br>            y = c(data$y[<span>1</span>], data$y[<span>1</span>], data$y[<span>2</span>], data$y[<span>2</span>])<br>        )<br>    })<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code><span># 因为要先画线再画点，但是线的 x 轴数据是连续值而点的 x 轴数据是字符值，</span><br><span># 所以要将点的字符值转换为数值，然后调整 x 轴的标签和 tick</span><br>ggplot() +<br>    geom_bezier(aes(x, y, group = index), data = line.data, <br>                colour = <span>"#caccd1"</span>) +<br>    geom_point(aes(as.numeric(factor(type)), !!sym(gene), fill = type), <br>               data = data, shape = <span>21</span>, stroke = <span>0.8</span>, alpha = <span>0.9</span>,<br>               size = <span>5</span>, show.legend = <span>FALSE</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    scale_fill_manual(values = my_palette) +<br>    scale_x_continuous(breaks = c(<span>1</span>, <span>2</span>), labels = c(<span>"Normal"</span>, <span>"Tumor"</span>),<br>                       expand = expansion(mult = c(<span>0.4</span>, <span>0.4</span>))) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015646" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBLVPiceWt5Cu73WDfEptvFTibupYxgaCNkL6uhljYox21tBsDbriaBZndQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBLVPiceWt5Cu73WDfEptvFTibupYxgaCNkL6uhljYox21tBsDbriaBZndQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>添加箱线图</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>ggplot(data, aes(type, !!sym(gene))) +<br>    geom_boxplot(aes(colour = type), show.legend = <span>FALSE</span>, <br>                 outliers = <span>FALSE</span>, notch = <span>TRUE</span>, linewidth = <span>0.8</span>) +<br>    geom_bezier(aes(x, y, group = index), data = line.data, <br>                colour = <span>"#caccd1"</span>, alpha = <span>0.7</span>) +<br>    geom_point(aes(fill = type), data = data, shape = <span>21</span>, alpha = <span>0.9</span>,<br>               size = <span>5</span>, show.legend = <span>FALSE</span>, stroke = <span>0.8</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    scale_fill_manual(values = my_palette) +<br>    scale_colour_manual(values = my_palette) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015649" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBB3pvvzunrR60vrGWYUVPI6aDHQhr0Y3xlKI57y88CvGSfvcRFNPEiaw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBB3pvvzunrR60vrGWYUVPI6aDHQhr0Y3xlKI57y88CvGSfvcRFNPEiaw/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>添加小提琴图</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>ggplot(data, aes(type, !!sym(gene))) +<br>    geom_violin(aes(colour = type), show.legend = <span>FALSE</span>, linewidth = <span>0.8</span>) +<br>    geom_bezier(aes(x, y, group = index), data = line.data, <br>                colour = <span>"#caccd1"</span>, alpha = <span>0.7</span>) +<br>    geom_point(aes(fill = type), data = data, shape = <span>21</span>, alpha = <span>0.9</span>,<br>               size = <span>5</span>, show.legend = <span>FALSE</span>, stroke = <span>0.8</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    scale_fill_manual(values = my_palette) +<br>    scale_colour_manual(values = my_palette) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015650" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBBlEvz4dUibJglVGm0OSyiaYpQYLuY0frWSxNUjjYfc7QL8VNtblj09CA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBBlEvz4dUibJglVGm0OSyiaYpQYLuY0frWSxNUjjYfc7QL8VNtblj09CA/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>添加显著性</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>ggplot(data, aes(type, !!sym(gene))) +<br>    geom_violin(aes(colour = type), show.legend = <span>FALSE</span>, linewidth = <span>0.8</span>) +<br>    geom_bezier(aes(x, y, group = index), data = line.data, <br>                colour = <span>"#caccd1"</span>, alpha = <span>0.7</span>) +<br>    geom_point(aes(fill = type), shape = <span>21</span>, alpha = <span>0.9</span>,<br>               size = <span>5</span>, show.legend = <span>FALSE</span>, stroke = <span>0.8</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_signif(<br>        comparisons = list(c(<span>"Normal"</span>, <span>"Tumor"</span>)), test = t.test,<br>        test.args = list(paired = <span>TRUE</span>), margin_top = <span>0.1</span>,<br>        <span># 显示 p 值格式</span><br>        map_signif_level = <span>function</span>(p) sprintf(<span>"pvalue = %.2g"</span>, p), <br>        color = <span>"black"</span>, textsize = <span>6</span>, vjust = -<span>0.2</span><br>    ) +<br>    scale_fill_manual(values = my_palette) +<br>    scale_colour_manual(values = my_palette) +<br>    scale_y_continuous(expand = expansion(mult = c(<span>0.1</span>, <span>0.1</span>))) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015654" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBWefibchDbUPaY5y8yic5LXdd4P1klxJHOEQ7D1ze3SvkuLq8ianwbRdvQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBWefibchDbUPaY5y8yic5LXdd4P1klxJHOEQ7D1ze3SvkuLq8ianwbRdvQ/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>多基因</span><span></span></h3><p data-tool="mdnice编辑器">一组基因在配对的癌症与正常样本中的差异表达</p><pre data-tool="mdnice编辑器"><span></span><code>genes &lt;- c(<span>"ATF3"</span>, <span>"TP53"</span>)<br>longer_data &lt;- lihc.tumor[common, genes] %&gt;%<br>    mutate(type = <span>"Tumor"</span>) %&gt;%<br>    tibble::rownames_to_column(<span>'sample'</span>) %&gt;%<br>    rbind(<br>        lihc.normal[common, genes] %&gt;%<br>        mutate(type = <span>"Normal"</span>) %&gt;%<br>            tibble::rownames_to_column(<span>'sample'</span>)) %&gt;%<br>    pivot_longer(-c(<span>"sample"</span>, <span>"type"</span>))<br></code></pre><h4 data-tool="mdnice编辑器"><span></span><span>直线样式</span><span></span></h4><p data-tool="mdnice编辑器">直接使用直线可能会出现问题，线段没有指向到点的中心。例如</p><pre data-tool="mdnice编辑器"><span></span><code>ggplot(longer_data, aes(type, value)) +<br>    geom_violin(aes(colour = type), show.legend = <span>FALSE</span>, linewidth = <span>0.8</span>) +<br>    geom_line(aes(group = sample), colour = <span>"#caccd1"</span>, alpha = <span>0.7</span>,<br>              position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_point(aes(fill = type), shape = <span>21</span>, alpha = <span>0.9</span>,<br>               size = <span>5</span>, show.legend = <span>FALSE</span>, stroke = <span>0.8</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_signif(<br>        comparisons = list(c(<span>"Normal"</span>, <span>"Tumor"</span>)), test = t.test,<br>        test.args = list(paired = <span>TRUE</span>), <br>        margin_top = <span>0.1</span>,<br>        map_signif_level = <span>function</span>(p) sprintf(<span>"pvalue = %.2g"</span>, p),<br>        color = <span>"black"</span>, textsize = <span>5</span>, vjust = -<span>0.2</span><br>    ) +<br>    scale_fill_manual(values = my_palette) +<br>    scale_colour_manual(values = my_palette) +<br>    scale_y_continuous(expand = expansion(mult = c(<span>0.1</span>, <span>0.1</span>))) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    facet_wrap(vars(name), scales = <span>"free"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015652" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBSM74UU6qylwLg6TNWbicljR7gmicQMj4icqqA5UDPTicaRdOEHseDPwFkA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBSM74UU6qylwLg6TNWbicljR7gmicQMj4icqqA5UDPTicaRdOEHseDPwFkA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">可以使用类似构造贝塞尔曲线的方法。注意，由于点是分组的，所以线条也需要进行分组，从 PANEL 列获取不同的分组，然后传递到构造线条的过程中</p><pre data-tool="mdnice编辑器"><span></span><code>p &lt;- ggplot(longer_data, aes(type, value)) +<br>    geom_point(aes(fill = type), shape = <span>21</span>, size = <span>5</span>, show.legend = <span>FALSE</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    facet_wrap(vars(name))  <span># 需要获取分面信息，用于对数据进行分组</span><br><br>line.longer &lt;- ggplot_build(p)$data[[<span>1</span>]] %&gt;%<br>    dplyr::select(c(<span>"x"</span>, <span>"y"</span>, <span>"group"</span>, <span>"PANEL"</span>)) %&gt;%<br>    group_by(PANEL) %&gt;%  <span># 根据分面进行分组</span><br>    mutate(index = rep(<span>1</span>:sum(group == <span>1</span>), length(unique(group)))) %&gt;%<br>    group_by(PANEL, index) %&gt;%<br>    group_modify(<span>function</span> (data, group) {<br>        data.frame(<br>            x = data$x[<span>1</span>], y = data$y[<span>1</span>],<br>            xend = data$x[<span>2</span>], yend = data$y[<span>2</span>]<br>        )<br>    }) %&gt;%<br>    mutate(name = unique(longer_data$name)[PANEL]) <span># 将分面对应到名称</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ggplot(longer_data, aes(type, value)) +<br>    geom_violin(aes(colour = type), show.legend = <span>FALSE</span>, linewidth = <span>0.8</span>) +<br>    geom_segment(aes(x = x, y = y, xend = xend, yend = yend),<br>                 data = line.longer, colour = <span>"#caccd1"</span>, alpha = <span>0.7</span>) +<br>    geom_point(aes(fill = type), shape = <span>21</span>, alpha = <span>0.9</span>,<br>               size = <span>5</span>, show.legend = <span>FALSE</span>, stroke = <span>0.8</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_signif(<br>        comparisons = list(c(<span>"Normal"</span>, <span>"Tumor"</span>)), test = t.test,<br>        test.args = list(paired = <span>TRUE</span>), <br>        margin_top = <span>0.1</span>,<br>        map_signif_level = <span>function</span>(p) sprintf(<span>"pvalue = %.2g"</span>, p),<br>        color = <span>"black"</span>, textsize = <span>5</span>, vjust = -<span>0.2</span><br>    ) +<br>    scale_fill_manual(values = my_palette) +<br>    scale_colour_manual(values = my_palette) +<br>    scale_y_continuous(expand = expansion(mult = c(<span>0.1</span>, <span>0.1</span>))) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    facet_wrap(vars(name), scales = <span>"free"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015653" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBpr0DH8ltSSlp0UFpI92t6s3hURXT3HibaYeuichR9M9Z9Y1VTFNmAAcQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBpr0DH8ltSSlp0UFpI92t6s3hURXT3HibaYeuichR9M9Z9Y1VTFNmAAcQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>贝塞尔曲线</span><span></span></h4><p data-tool="mdnice编辑器">构建贝塞尔曲线所需数据。</p><pre data-tool="mdnice编辑器"><span></span><code>bezier.longer &lt;- ggplot_build(p)$data[[<span>1</span>]] %&gt;%<br>    dplyr::select(c(<span>"x"</span>, <span>"y"</span>, <span>"group"</span>, <span>"PANEL"</span>)) %&gt;%<br>    group_by(PANEL) %&gt;%<br>    mutate(index = rep(<span>1</span>:sum(group == <span>1</span>), length(unique(group)))) %&gt;%<br>    group_by(PANEL, index) %&gt;%<br>    group_modify(<span>function</span> (data, group) {<br>        data.frame(<br>            x = c(data$x[<span>1</span>], data$x[<span>1</span>] + <span>0.3</span>, data$x[<span>2</span>] - <span>0.3</span>, data$x[<span>2</span>]),<br>            y = c(data$y[<span>1</span>], data$y[<span>1</span>], data$y[<span>2</span>], data$y[<span>2</span>])<br>        )<br>    }) %&gt;%<br>    mutate(name = unique(longer_data$name)[PANEL])<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ggplot(longer_data, aes(type, value)) +<br>    geom_violin(aes(colour = type), show.legend = <span>FALSE</span>, linewidth = <span>0.8</span>) +<br>    geom_bezier(aes(x, y, group = index), data = bezier.longer, <br>                colour = <span>"#caccd1"</span>, alpha = <span>0.7</span>) +<br>    geom_point(aes(fill = type), shape = <span>21</span>, alpha = <span>0.9</span>,<br>               size = <span>5</span>, show.legend = <span>FALSE</span>, stroke = <span>0.8</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_signif(<br>        comparisons = list(c(<span>"Normal"</span>, <span>"Tumor"</span>)), test = t.test,<br>        test.args = list(paired = <span>TRUE</span>), <br>        margin_top = <span>0.1</span>,<br>        map_signif_level = <span>function</span>(p) sprintf(<span>"pvalue = %.2g"</span>, p),<br>        color = <span>"black"</span>, textsize = <span>5</span>, vjust = -<span>0.2</span><br>    ) +<br>    scale_fill_manual(values = my_palette) +<br>    scale_colour_manual(values = my_palette) +<br>    scale_y_continuous(expand = expansion(mult = c(<span>0.1</span>, <span>0.1</span>))) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    facet_wrap(vars(name), scales = <span>"free"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015655" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBMe8sqELW0GGCRBkknDosxibSibWYnFYfkQ7YZ25j8xJVvYtvOia6Ttl4A/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBMe8sqELW0GGCRBkknDosxibSibWYnFYfkQ7YZ25j8xJVvYtvOia6Ttl4A/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>多组配对</span><span></span></h2><h3 data-tool="mdnice编辑器"><span></span><span>常规样式</span><span></span></h3><p data-tool="mdnice编辑器">直接使用 line + point 可以很容易的实现多组配对。</p><pre data-tool="mdnice编辑器"><span></span><code>ggplot(auc, aes(name, value)) +<br>    geom_boxplot(aes(colour = name), show.legend = <span>FALSE</span>, linewidth = <span>0.8</span>) +<br>    geom_line(aes(group = cell_line),colour = <span>"#caccd1"</span>, alpha = <span>0.7</span>,<br>              position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_point(aes(fill = name), shape = <span>21</span>, size = <span>5</span>, show.legend = <span>FALSE</span>,<br>               stroke = <span>0.8</span>, alpha = <span>0.9</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_signif(<br>        comparisons = list(<br>            c(<span>"1S,3R-RSL-3"</span>, <span>"erastin"</span>), c(<span>"erastin"</span>, <span>"ML162"</span>),<br>            c(<span>"1S,3R-RSL-3"</span>, <span>"ML162"</span>)), <br>        test = t.test, test.args = list(paired = <span>TRUE</span>), <br>        margin_top = <span>0.1</span>, step_increase = <span>0.15</span>,<br>        map_signif_level = <span>function</span>(p) sprintf(<span>"pvalue = %.2g"</span>, p),<br>        color = <span>"black"</span>, textsize = <span>5</span>, vjust = -<span>0.2</span><br>    ) +<br>    scale_fill_manual(values = c(<span>"#037ef3"</span>, <span>"#f85a40"</span>, <span>"#30c39e"</span>)) +<br>    scale_colour_manual(values = c(<span>"#037ef3"</span>, <span>"#f85a40"</span>, <span>"#30c39e"</span>)) +<br>    scale_y_continuous(expand = expansion(mult = c(<span>0.1</span>, <span>0.1</span>))) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015651" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicB9mY2ScrevW2Pfg0g9DkiajDXcrVU4iaJ6PP6Ms4YNVDdjGDS1QGdwLQQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicB9mY2ScrevW2Pfg0g9DkiajDXcrVU4iaJ6PP6Ms4YNVDdjGDS1QGdwLQQ/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>贝塞尔曲线样式</span><span></span></h3><p data-tool="mdnice编辑器">计算贝塞尔曲线数据，由于是多分组，需要调整内部数据构造方式，按照分组顺序依次连接两个相邻的分组</p><pre data-tool="mdnice编辑器"><span></span><code>p &lt;- ggplot(auc, aes(name, value)) +<br>    geom_point(aes(fill = name), shape = <span>21</span>, size = <span>5</span>, show.legend = <span>FALSE</span>,<br>               position = position_dodge2(width = <span>0.2</span>))<br><br>multi_bezier &lt;- ggplot_build(p)$data[[<span>1</span>]] %&gt;%<br>    dplyr::select(c(<span>"x"</span>, <span>"y"</span>, <span>"group"</span>)) %&gt;%<br>    mutate(index = rep(<span>1</span>:sum(group == <span>1</span>), length(unique(group)))) %&gt;%<br>    group_by(index) %&gt;%<br>    group_modify(<span>function</span> (data, group) {<br>        <span># 多个分组，根据顺序依次计算相邻分组之间的 bezier 数据，还要添加分组</span><br>        Reduce(rbind, lapply(<span>1</span>:(dim(data)[<span>1</span>] - <span>1</span>), <span>function</span>(i) {<br>            data.frame(<br>                x = c(data$x[i], data$x[i] + <span>0.3</span>, <br>                      data$x[i+<span>1</span>] - <span>0.3</span>, data$x[i+<span>1</span>]),<br>                y = c(data$y[i], data$y[i], <br>                      data$y[i+<span>1</span>], data$y[i+<span>1</span>]),<br>                group = i<br>            )<br>        }))<br>    }) %&gt;%<br>    mutate(group = paste0(index, group))  <span># 整合两个分组信息</span><br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>ggplot(auc, aes(name, value)) +<br>    geom_violin(aes(colour = name), show.legend = <span>FALSE</span>, linewidth = <span>0.8</span>) +<br>    geom_bezier(aes(x, y, group = group), data = multi_bezier, <br>                colour = <span>"#caccd1"</span>, alpha = <span>0.7</span>) +<br>    geom_point(aes(fill = name), shape = <span>21</span>, size = <span>5</span>, show.legend = <span>FALSE</span>,<br>               stroke = <span>0.8</span>, alpha = <span>0.9</span>,<br>               position = position_dodge2(width = <span>0.2</span>)) +<br>    geom_signif(<br>        comparisons = list(<br>            c(<span>"1S,3R-RSL-3"</span>, <span>"erastin"</span>), c(<span>"erastin"</span>, <span>"ML162"</span>),<br>            c(<span>"1S,3R-RSL-3"</span>, <span>"ML162"</span>)), <br>        test = t.test, test.args = list(paired = <span>TRUE</span>), <br>        margin_top = <span>0.1</span>, step_increase = <span>0.15</span>,<br>        map_signif_level = <span>function</span>(p) sprintf(<span>"pvalue = %.2g"</span>, p),<br>        color = <span>"black"</span>, textsize = <span>5</span>, vjust = -<span>0.2</span><br>    ) +<br>    scale_fill_manual(values = c(<span>"#037ef3"</span>, <span>"#f85a40"</span>, <span>"#30c39e"</span>)) +<br>    scale_colour_manual(values = c(<span>"#037ef3"</span>, <span>"#f85a40"</span>, <span>"#30c39e"</span>)) +<br>    scale_y_continuous(expand = expansion(mult = c(<span>0.1</span>, <span>0.1</span>))) +<br>    labs(x = <span>NULL</span>, y = <span>"Gene expression level"</span>) +<br>    my_theme<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100015661" data-ratio="0.7138888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBBouqLHtoiaSxic65qu9wBrRsJbndXk8SqqUN2OJnnicbuNX6jVAq3aThQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicBBouqLHtoiaSxic65qu9wBrRsJbndXk8SqqUN2OJnnicbuNX6jVAq3aThQ/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span><br></span><span><br></span><span><br></span><span><br></span></h2><section><mp-common-cpsad data-pluginname="mpcps" data-templateid="list" data-traceid="155e9d4b-ae85-4b03-a220-84d463f26cb1wx8757ef159946d678" data-appid="wx8757ef159946d678" data-adtype="mini-game" data-goodssouce="1" data-cpsversion="v112" data-playcpstype="1"></mp-common-cpsad></section><h2 data-tool="mdnice编辑器"><span>结尾</span><span></span></h2><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">所有文件、代码以及原始文档都上传到了知识星球，任何代码的问题都可以提问，自愿加入。<img data-imgfileid="100015660" data-ratio="1.5824074074074075" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicB6ZTqREQdFs2rnjicIzgnX3ITKkmAMxUzhaVAOgtrX3ca1KhGsEao12g/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWJ4WiaAiaCtZLfiacrAl3ib7AicB6ZTqREQdFs2rnjicIzgnX3ITKkmAMxUzhaVAOgtrX3ca1KhGsEao12g/640?wx_fmt=jpeg&amp;from=appmsg"></p></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/NdqtDvMBppr_w4zfutwwkA",target="_blank" rel="noopener noreferrer">原文链接</a>
