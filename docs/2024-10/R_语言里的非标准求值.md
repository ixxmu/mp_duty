---
title: "R 语言里的非标准求值"
date: 2024-10-17T23:56:53Z
draft: ["false"]
tags: [
  "fetched",
  "老俊俊的生信笔记"
]
categories: ["Acdemic"]
---
R 语言里的非标准求值 by 老俊俊的生信笔记
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-mpa-powered-by="yiban.io"><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkyMTI1MTYxNA==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usezgsqIGqjITSMggCTSoViaYeoKe2xoZr1IIvNJoztibQxibYHLDDoiabwAc6Ggws3Tvdo8EPss2nLgaVQ/0?wx_fmt=png" data-nickname="老俊俊的生信笔记" data-alias="JunJunLab" data-signature="老俊俊的生信技能和知识分享,我不是巨人,但你可以站在我的肩膀上更进一步!" data-from="0" data-is_biz_ban="0"></mp-common-profile></section></section><section><mp-common-clmusic data-pluginname="insertaudio" type="1" music_name="%E6%83%B3%E8%B1%A1%E4%B9%8B%E4%B8%AD" albumurl="http://wx.y.gtimg.cn/music/photo_new/T002R500x500M0000048UsY21HmoMU_2.jpg" singer="许嵩" duration="249000" username="" music_source="1" is_vip="1" listenid="78221633885291168"></mp-common-clmusic></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>引言</span><span></span></h2><blockquote data-tool="mdnice编辑器"><span>❝</span><p><strong>非标准求值 （Non-Standard Evaluation，NSE）</strong> 是 R 语言的一个强大且独特的特性，它允许表达式在函数或某个上下文中被捕捉并延迟评估，而不是像通常的标准计算<strong>（SE, Standard Evaluation）</strong> 那样直接计算。大部分编程语言中，函数在被调用时会立即评估传入的参数，但在 R 中，使用 NSE 可以捕获参数并延迟进行求值。这种特性在 <strong>dplyr、ggplot2</strong> 等 R 包中广泛应用。</p></blockquote><p data-tool="mdnice编辑器"><strong>NSE 的应用场景主要有：</strong></p><ul data-tool="mdnice编辑器"><li><section>捕捉未求值的表达式 并延迟对其求值。</section></li><li><section>方便基于列名 （比如数据框的列名）进行操作，而无需把列名硬编码成字符串。</section></li></ul><blockquote data-tool="mdnice编辑器"><span>❝</span><p>有时候我们需要包装 dplyr 或者 ggplot 这种类似的函数的时候，<strong>非标准求值</strong> 可以很大帮助我们简化代码。下面两个链接可以帮助我们了解，此外 <strong>rlang</strong> 包也可以好好学习一下里面的函数。</p></blockquote><ul data-tool="mdnice编辑器"><li><section><strong>https://adv-r.hadley.nz/evaluation.html</strong></section></li><li><section><strong>https://dplyr.tidyverse.org/articles/programming.html</strong></section></li></ul><h2 data-tool="mdnice编辑器"><span></span><span>示例</span><span></span></h2><blockquote data-tool="mdnice编辑器"><span>❝</span><p>这里我们举几个例子，我们自己尝试模仿编写<strong>dplyr</strong>中的 <strong>select</strong>，<strong>filter</strong> 和 <strong>mutate</strong> 函数。</p></blockquote><h3 data-tool="mdnice编辑器"><span></span><span>my_select</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(rlang)<br><span>library</span>(dplyr)<br><br>my_select &lt;- <span>function</span>(data,<span>...</span>){<br>  cls &lt;- enquos(<span>...</span>)<br>  data[,sapply(cls,as_name)]<br>}<br><br>my_select(mtcars,mpg,cyl) |&gt; head()<br><span>#                    mpg cyl</span><br><span># Mazda RX4         21.0   6</span><br><span># Mazda RX4 Wag     21.0   6</span><br><span># Datsun 710        22.8   4</span><br><span># Hornet 4 Drive    21.4   6</span><br><span># Hornet Sportabout 18.7   8</span><br><span># Valiant           18.1   6</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>my_filter</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>my_filter &lt;- <span>function</span>(data, <span>...</span>) {<br>  condition &lt;- enquos(<span>...</span>)<br><br>  <span>for</span> (i <span>in</span> seq_along(condition)) {<br>    ftdata &lt;- data[eval_tidy(condition[[i]], data), ]<br><br>  }<br><br>  ftdata<br>}<br><br><br>my_filter(mtcars,mpg &gt; <span>30</span>)<br><span>#                 mpg cyl disp  hp drat    wt  qsec vs am gear carb</span><br><span># Fiat 128       32.4   4 78.7  66 4.08 2.200 19.47  1  1    4    1</span><br><span># Honda Civic    30.4   4 75.7  52 4.93 1.615 18.52  1  1    4    2</span><br><span># Toyota Corolla 33.9   4 71.1  65 4.22 1.835 19.90  1  1    4    1</span><br><span># Lotus Europa   30.4   4 95.1 113 3.77 1.513 16.90  1  1    5    2</span><br><br>my_filter(mtcars,mpg &gt; <span>30</span>  &amp; gear == <span>4</span>)<br><span>#                 mpg cyl disp hp drat    wt  qsec vs am gear carb</span><br><span># Fiat 128       32.4   4 78.7 66 4.08 2.200 19.47  1  1    4    1</span><br><span># Honda Civic    30.4   4 75.7 52 4.93 1.615 18.52  1  1    4    2</span><br><span># Toyota Corolla 33.9   4 71.1 65 4.22 1.835 19.90  1  1    4    1</span><br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span>my_mutate</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>my_mutate &lt;- <span>function</span>(data, <span>...</span>) {<br>  new_columns &lt;- enquos(<span>...</span>)<br><br>  new_column_names &lt;- names(new_columns)<br><br>  <span>for</span> (i <span>in</span> seq_along(new_columns)) {<br>    col_name &lt;- new_column_names[i]<br>    data[[col_name]] &lt;- eval_tidy(new_columns[[i]], data)<br>  }<br><br>  <span>return</span>(data)<br>}<br><br>mtcars |&gt; my_mutate(new = mpg + disp) |&gt; head()<br><span>#                    mpg cyl disp  hp drat    wt  qsec vs am gear carb   new</span><br><span># Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 181.0</span><br><span># Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 181.0</span><br><span># Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 130.8</span><br><span># Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 279.4</span><br><span># Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 378.7</span><br><span># Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 243.1</span><br></code></pre><h2 data-tool="mdnice编辑器"><span></span><span>结尾</span><span></span></h2><blockquote data-tool="mdnice编辑器"><span>❝</span><p><strong>路漫漫其修远兮,吾将上下而求索。</strong></p></blockquote><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">欢迎加入生信交流群。加我微信我也拉你进 <strong>微信群聊</strong> <strong>老俊俊生信交流群</strong> <strong>(微信交流群需收取 20 元入群费用,一旦交费,拒不退还!(防止骗子和便于管理))</strong> 。</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100031669" data-ratio="0.6083707025411061" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewpTNaMic6XuiaWMsAX7kr4FfjoekLBjPL6qTLxUk3ic1yyicnKz7u0kyrvY7CL1Juia5VxBlZvoJFBiaAA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="669" src="https://mmbiz.qpic.cn/sz_mmbiz_png/G5jjcE4usewpTNaMic6XuiaWMsAX7kr4FfjoekLBjPL6qTLxUk3ic1yyicnKz7u0kyrvY7CL1Juia5VxBlZvoJFBiaAA/640?wx_fmt=png&amp;from=appmsg"></figure><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器"><strong></strong></p><center data-tool="mdnice编辑器"><strong> 往期回顾目录</strong></center><blockquote data-tool="mdnice编辑器"><span>❝</span><p><strong></strong></p><center><strong><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247515312&amp;idx=1&amp;sn=82b8aa5ca4f9e0621d3afb20a7dbaf69&amp;chksm=c18486c1f6f30fd70062ee76e62a9ae724cb9ad4aa5ac255cdf932b691abd71d1433f2c7108f&amp;token=1460764668&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">fastplyr 加速 dplyr？</a></strong></center><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247515280&amp;idx=1&amp;sn=defc9a1c16991378192d39cd07f8ab2b&amp;chksm=c18486e1f6f30ff714bb06fc51b6ac30640f4e8fc12e33675e23e11321501ddd0338c15e8f73&amp;token=289129565&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">离散傅里叶计算 riboseq 的 3nt 周期性</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247515259&amp;idx=1&amp;sn=b19dca820116f79399ce38141c6bd9e5&amp;chksm=c184860af6f30f1caac47d51f32d5bd8507e8b38ddafb7faff22aed751f63f5fdcbd8ea4163c&amp;token=1715275324&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">Nature 文章的数据也如此奇妙</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247515217&amp;idx=1&amp;sn=0f6aa07f021f19dd8c29bc182b1c4973&amp;chksm=c1848620f6f30f362a55caa9aa1b1fba6e24f871545c78927ef5f6c73f99debd8164b7c8644c&amp;token=1715275324&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">bam/sam 文件里的 flag16 的序列可能和你想的不一样</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247515196&amp;idx=1&amp;sn=827ad75ace9c9f9d71e89ca35ea37035&amp;chksm=c184864df6f30f5b1456a60f32b1d9884daa6a0060dd8596c3283e69af8d600778e8d92ac1c9&amp;token=2067075838&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">IGV 也能查看 ribo-seq 的 E/P/A density</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247515167&amp;idx=1&amp;sn=bd4107378e08a3ce1d2a122a74c5ec1c&amp;chksm=c184866ef6f30f78ed84a51bad9ff1cf34f64387fdeffbfc79ff896b26fb355aa49c22c77987&amp;token=2067075838&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">Open Science Framework (OSF) 数据下载</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247515150&amp;idx=1&amp;sn=c6c94a60dca571df58cedf8d0c76e38e&amp;chksm=c184867ff6f30f69f2160c92443c53c3d5dc855b8da2411741047d8bdc2310544ea853830b6d&amp;token=717997874&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">Cell Reports Hel2 核糖体碰撞感受器文献结果复现</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247515060&amp;idx=1&amp;sn=49d17b3c06bbdeadba0df3eaefd54dd0&amp;chksm=c18481c5f6f308d3d2688b75b742fc2043cd3da0a7c6e1e99560d157a6bae39d89209d098882&amp;token=740560987&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">Science 核糖体翻译共组装结果复现</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247514974&amp;idx=1&amp;sn=63fbe0852212a133b859eef891951352&amp;chksm=c184812ff6f3083967b9d2c65dd144c87b68c0ce03d5156f96517fa4f015994bae834a3b6602&amp;token=2005494294&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">Cell Reports 文献结果复现</a></center></strong><strong><center><a href="https://mp.weixin.qq.com/s?__biz=MzkyMTI1MTYxNA==&amp;mid=2247514724&amp;idx=1&amp;sn=ffa1b198b257bbf52bc489b5dd42f1ea&amp;chksm=c1848015f6f309037000d72fed4718195be97c6e6e7b45e0d1b8c06690465b4c90ba3c90c890&amp;token=1671225249&amp;lang=zh_CN&amp;scene=21#wechat_redirect" data-linktype="2">Ribo-SEQ 数据质量评估</a></center></strong><p><br></p></blockquote></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/k66BV6gDJ0eIeLVZmMvohw",target="_blank" rel="noopener noreferrer">原文链接</a>
