---
title: "图片复现 | 富集分析条形图-调整分面标记的位置"
date: 2024-10-18T00:47:26Z
draft: ["false"]
tags: [
  "fetched",
  "被炸熟的虾"
]
categories: ["Acdemic"]
---
图片复现 | 富集分析条形图-调整分面标记的位置 by 被炸熟的虾
------
<div><p><span>偶然看到一张富集分析的展示结果，不同的通路类别分别展示，加了一个</span><span>label</span><span>以示区分。</span><br></p><p><span></span></p><p><img data-croporisrc="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vhh2ZRHYB0ib8x8pOjlJtzBRlZfVEhQfFJvKPg91AJibjWWS4gHHKHQ7Q/0?wx_fmt=png&amp;from=appmsg" data-cropx1="0" data-cropx2="747" data-cropy1="42.64878892733564" data-cropy2="631.977508650519" data-galleryid="" data-imgfileid="100004749" data-ratio="0.7884872824631861" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vx0ibiaFp6P1nVtJGboE6Mdz7AmvYiaOYKFlwibibKqLQPSLcMgeyFJw5zoA/640?wx_fmt=jpeg" data-type="jpeg" data-w="747" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vx0ibiaFp6P1nVtJGboE6Mdz7AmvYiaOYKFlwibibKqLQPSLcMgeyFJw5zoA/640?wx_fmt=jpeg"></p><section><span>Multi-omics and pharmacological characterization of patient-derived glioma cell lines. Nat Commun. 2024 Aug 8.  PMID: 39112531.</span></section><section><span></span></section><p><code><span>ggplot2</span></code><span>本身自带了分面函数，大家应该都很熟悉，</span><span>GO</span><span>富集分析结果也常常按照</span><span>BP</span><span>、</span><span><span>CC</span></span><span>与</span><span>MF</span><span>分别展示：</span></p><p><img data-galleryid="" data-imgfileid="100004751" data-ratio="0.7953703703703704" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vynhZeOewbqiaHL90AFWHlOYDfFONAiaic0quNJlxaISUbGEy99Cw73ziag/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vynhZeOewbqiaHL90AFWHlOYDfFONAiaic0quNJlxaISUbGEy99Cw73ziag/640?wx_fmt=png&amp;from=appmsg"></p><p><span>仔细观察可以发现，原图<strong>将分面标注方向换到了对面</strong>。这样辅以通路标准到柱子上，空间节省了</span><span>1/3</span><span>。</span></p><h2><span>Step1：数据整理</span></h2><pre><code><span>library</span>(readxl)<br>exprSet &lt;- as.data.frame(read_excel(<span>"./41467_2024_51214_MOESM5_ESM.xlsx"</span>,sheet = <span>"Fig. 1D,E,F"</span>))<br>head(exprSet)<br>                                                                      <span># Pathway    p.adj      NES Subtype</span><br><span># 1                                            VERHAAK_GLIOBLASTOMA_MESENCHYMAL 4.65e-09 2.973980     MES</span><br><span># 2                                  HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION 4.65e-09 2.723111     MES</span><br><span># 3                                          HALLMARK_INTERFERON_GAMMA_RESPONSE 4.65e-09 2.534963     MES</span><br><span># 4                                              HALLMARK_INFLAMMATORY_RESPONSE 4.65e-09 2.476059     MES</span><br><span># 5                                                  GOBP_GRANULOCYTE_MIGRATION 4.65e-09 2.423561     MES</span><br><span># 6 GOBP_POSITIVE_REGULATION_OF_CYTOKINE_PRODUCTION_INVOLVED_IN_IMMUNE_RESPONSE 4.81e-08 2.382693     MES</span><br>exprSet$Pathway &lt;- gsub(<span>"VERHAAK_"</span>,<span>""</span>,exprSet$Pathway)<br>exprSet$Pathway &lt;- gsub(<span>"HALLMARK_"</span>,<span>""</span>,exprSet$Pathway)<br>exprSet$Pathway &lt;- gsub(<span>"GOBP_"</span>,<span>""</span>,exprSet$Pathway)<br>exprSet$Pathway &lt;- gsub(<span>"GOMF_"</span>,<span>""</span>,exprSet$Pathway)<br>exprSet$Pathway &lt;- gsub(<span>"GOCC_"</span>,<span>""</span>,exprSet$Pathway)<br>exprSet$Pathway &lt;- gsub(<span>"GOCC_"</span>,<span>""</span>,exprSet$Pathway)<br>exprSet$Pathway &lt;- gsub(<span>"GOCC_"</span>,<span>""</span>,exprSet$Pathway)<br><span>##首字母大写</span><br>exprSet$Pathway &lt;- Hmisc::capitalize(tolower(exprSet$Pathway))<br></code></pre><p><span>选择为</span><span>OXPHOS</span><span>示例：</span></p><pre><code>exprSet0 &lt;- exprSet[exprSet$Subtype == <span>"OXPHOS"</span>,]<br>exprSet0$Group &lt;- <span>"OXPHOS-enriched pathways"</span><br>exprSet0$Pathway &lt;- factor(exprSet0$Pathway,levels = rev(exprSet0$Pathway))<br>exprSet0[,c(<span>1</span>,<span>3</span>,<span>5</span>)]<br><span>#                                                              Pathway      NES                    Group</span><br><span>#21                                 Structural_constituent_of_ribosome 3.849841 OXPHOS-enriched pathways</span><br><span>#22                                                  Ribosomal_subunit 3.807352 OXPHOS-enriched pathways</span><br><span>#23                           Mitochondrial_protein_containing_complex 3.447491 OXPHOS-enriched pathways</span><br><span>#24                      Cotranslational_protein_targeting_to_membrane 3.421529 OXPHOS-enriched pathways</span><br><span>#25 Nuclear_transcribed_mrna_catabolic_process_nonsense_mediated_decay 3.338597 OXPHOS-enriched pathways</span><br><span>#26                       Inner_mitochondrial_membrane_protein_complex 3.291726 OXPHOS-enriched pathways</span><br><span>#27                                          Oxidative_phosphorylation 3.286751 OXPHOS-enriched pathways</span><br><span>#28     Establishment_of_protein_localization_to_endoplasmic_reticulum 3.267272 OXPHOS-enriched pathways</span><br><span>#29                                                     Myc_targets_v1 3.205170 OXPHOS-enriched pathways</span><br><span>#30                                          Respiratory_chain_complex 3.199812 OXPHOS-enriched pathways</span><br></code></pre><p><span>设置主题：这里</span><strong><span>隐去了</span><span>Y</span><span>轴的坐标标签、刻度线</span></strong><span></span></p><pre><code><span>library</span>(ggplot2)<br>mytheme &lt;- theme(axis.text.x = element_text(hjust = <span>0.5</span>,size = <span>20</span>), <br>                 <span>## 删去y轴label</span><br>                 axis.text.y = element_blank(),<br>                 <span>## 删去y轴刻度线</span><br>                 axis.ticks.y = element_blank(), <br>                 <span>## 删去x\y轴标题</span><br>                 axis.title.x = element_blank(), <br>                 axis.title.y = element_blank(), <br>                 plot.title = element_text(hjust = <span>0.5</span>,size =  <span>22</span>),<br>                 legend.position = <span>"none"</span>)<br></code></pre><p><strong><span>分面主题</span></strong><span>：不仅可以设置字体颜色、大小，也可以<strong>调整背景填充颜色</strong></span></p><pre><code>mytheme_strip &lt;- theme(<span>## 分面背景更改为红色</span><br>                       strip.background = element_rect(fill = c(<span>"#2b3990"</span>)),<br>                       <span>## 分面字体更改为白色</span><br>                       strip.text = element_text(size = <span>20</span>,colour = <span>"white"</span>))<br></code></pre><h2><span>Step2：绘图</span></h2><p><span>相比于常规条形图，使用</span><code><span>geom_text</span></code><span>函数将需要标注的文字写在柱子上，再加一个</span><code><span>facet_grid</span></code><span>即可，详细的分面函数下一节总结吧。</span></p><pre><code>p1 &lt;- ggplot(data = exprSet0, aes(x = Pathway, y = NES)) +<br>      geom_bar(stat = <span>"identity"</span>, width = <span>0.8</span>, fill = <span>"#a6b3d7"</span>,alpha = <span>0.9</span>) + <span>#绘制条形图</span><br>      geom_text(aes(y = <span>0</span>, <span>#控制文本标签起始位置</span><br>                    label = Pathway),<br>                    size = <span>6</span>,hjust = <span>0</span>) + <span>#hjust = 0左对齐</span><br>      scale_y_continuous(expand = c(<span>0</span>,<span>0.05</span>),limits = c(<span>0</span>,<span>4.2</span>)) +<br>      facet_grid(Group~.) +<br>      labs(x = <span>NULL</span>, y = <span>"NES"</span>, title = <span>NULL</span>) +  <br>      coord_flip() + theme_bw() + mytheme + mytheme_strip<br></code></pre><section><img data-galleryid="" data-imgfileid="100004752" data-ratio="0.5296296296296297" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vF3Aic9nFQkiao3qkjN1mrujIUk0EyoV5BacK1g2N91E9G1Zuej4WticPQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vF3Aic9nFQkiao3qkjN1mrujIUk0EyoV5BacK1g2N91E9G1Zuej4WticPQ/640?wx_fmt=png&amp;from=appmsg"></section><p><span>默认情况下，标签显示在图表的顶部</span><code><span>facet_grid(.~Group)</span></code><span>和右侧</span><code><span>facet_grid(Group~.)</span></code><span>。<span>为了将分面标签放置在左侧，需要添加参数</span><code><span>switch = "y"</span></code><span>。</span></span></p><ul><li><section><span>如果设置为</span><code><span>switch = "x"</span></code><span>，则顶部标签将显示在底部。</span></section></li><li><section><span>如果设置为</span><code><span>switch = "y"</span></code><span>，则右侧标签将显示在左侧。也可以设置为</span><code><span>"both"</span></code><span>。</span></section></li></ul><pre><code>p3 &lt;- ggplot(data = exprSet0, aes(x = Pathway, y = NES)) +<br>      geom_bar(stat = <span>"identity"</span>, width = <span>0.8</span>, fill = <span>"#a6b3d7"</span>,alpha = <span>0.9</span>) + <span>#绘制条形图</span><br>      geom_text(aes(y = <span>0</span>, <span>#控制文本标签起始位置</span><br>                    label = Pathway),<br>                    size = <span>6</span>,hjust = <span>0</span>) + <span>#hjust = 0左对齐</span><br>      scale_y_continuous(expand = c(<span>0</span>,<span>0.05</span>),limits = c(<span>0</span>,<span>4.2</span>)) +<br>      facet_grid(Group~.,<span>switch</span> = <span>"y"</span>) +<br>      labs(x = <span>NULL</span>, y = <span>NULL</span>, title = <span>NULL</span>) +  <br>      coord_flip() + theme_bw() + mytheme + mytheme_strip<br></code></pre><p><img data-galleryid="" data-imgfileid="100004753" data-ratio="0.5296296296296297" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vdcSwNDWqicDcgKd3icIVQLDhGBDWgq55iceZLibPZqViacsDia3RFmtOfq8w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vdcSwNDWqicDcgKd3icIVQLDhGBDWgq55iceZLibPZqViacsDia3RFmtOfq8w/640?wx_fmt=png&amp;from=appmsg"></p><p><span>调整颜色分别绘制三张图拼接：</span></p><pre><code><span>library</span>(patchwork)<br>p1/p2/p3 + plot_layout(heights = c(<span>1</span>,<span>1</span>,<span>1</span>))<br></code></pre><p><img data-galleryid="" data-imgfileid="100004754" data-ratio="1.5555555555555556" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vgcsFJL6MAYk7Tkyb7IreAmGd6RCuoMWd9jaNG1ibfjkNRxazCXou7ibw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3LXK8WZzFle3E9kPYuviaJ5vgcsFJL6MAYk7Tkyb7IreAmGd6RCuoMWd9jaNG1ibfjkNRxazCXou7ibw/640?wx_fmt=png&amp;from=appmsg"></p><h3><span></span></h3><section><span></span></section><section><img data-imgfileid="100003752" data-ratio="0.05278592375366569" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" data-type="png" data-w="341" src="https://mmbiz.qpic.cn/sz_mmbiz_png/1LTeQhNfr8sUH75oYsoDaqjPCTiaukEmS8tWricW7LnLKKfIE9jKBexibqamsrlibaaXmuc2nicaYibfDFBNCmqX5mBw/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></section><section data-tools="135编辑器" data-id="116886" draggable="true"><section><section><section><section><strong data-brushtype="text">被炸熟的虾</strong></section></section></section><section><section><section data-width="35%"><section><img data-cropselx1="0" data-cropselx2="115" data-cropsely1="0" data-cropsely2="115" data-imgfileid="100003750" data-ratio="1" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3JjDfj2H8p6gg3CB25AGthbwzrotao4ev5tIe0utthbZRK8yOoDOuTzOSoTSnPWn61IdDCnXsnaiag/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" data-type="jpeg" data-w="258" data-width="100%" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/dRYYdqiaan3JjDfj2H8p6gg3CB25AGthbwzrotao4ev5tIe0utthbZRK8yOoDOuTzOSoTSnPWn61IdDCnXsnaiag/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></section></section><section data-width="63%"><section><section><strong>自己的摸索，发现问题麻烦告诉作者，光速回来改正</strong><strong><img data-imgfileid="100003751" data-ratio="1" data-type="png" data-w="64" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KLQGNxibvI4SdtUfxjINkz2DO8cGEPTgbcMJ357RvXJ7IvWU2p7anljpePpakI9oKu3icJxobBDp5w/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp" src="https://mmbiz.qpic.cn/sz_mmbiz_png/dRYYdqiaan3KLQGNxibvI4SdtUfxjINkz2DO8cGEPTgbcMJ357RvXJ7IvWU2p7anljpePpakI9oKu3icJxobBDp5w/640?wx_fmt=other&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1&amp;tp=webp"></strong></section></section></section></section></section></section></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/1M_oTcH98zXmNTewfC8VcA",target="_blank" rel="noopener noreferrer">原文链接</a>
