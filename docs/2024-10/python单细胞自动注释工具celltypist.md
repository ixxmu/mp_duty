---
title: "python单细胞自动注释工具celltypist"
date: 2024-10-16T14:11:19Z
draft: ["false"]
tags: [
  "fetched",
  "生信星球"
]
categories: ["Acdemic"]
---
python单细胞自动注释工具celltypist by 生信星球
------
<div><p><img data-imgfileid="100012345" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100012344" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span> 今天是生信星球陪你的<span><strong>第1009天</strong></span></span><img data-imgfileid="100012343" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></p><hr><p><span><span>   </span></span></p><section><blockquote><p><span>公众号里的文章大多数需要编程基础，如果因为代码看不懂，而跟不上正文的节奏，可以来找我学习，相当于给自己一个新手保护期。</span><span>我的课程都是循环开课，</span><span>点进去咨询微信↓</span><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247496032&amp;idx=1&amp;sn=e84ffce4f05b6f4318b95f170642d702&amp;chksm=fdfbb922ca8c30344c47b39529a16280bacb23c83e35a18f63e158f4e664ef94b5eee0e3fff8&amp;scene=21#wechat_redirect" textvalue="‍生信分析直播课程‍" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">生信分析直播课程</a>(每月初开一期，春节休一个月)</p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494919&amp;idx=2&amp;sn=967d8dcf0f9a22047ae0bd442b9d4ee6&amp;chksm=fdfba545ca8c2c5396c3fb5caa93a5d30336626533fcac074abd7683e8d536cb2dcae31d6e7a&amp;scene=21#wechat_redirect" textvalue="生信新手保护‍学习‍小组" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">生信新手保护学习小组</a>（每月两期）</p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247495036&amp;idx=1&amp;sn=fe8bab2c3d21e7b0a919ad4f1641ca9c&amp;chksm=fdfba53eca8c2c286522b2accc0d4cb9dda7cd9a5b36695e66d393abb5bff396d6bcaa4c9cb8&amp;scene=21#wechat_redirect" textvalue="单细胞陪伴学习小组内测完成，长期招生中" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">单细胞陪伴学习小组</a>（每月两期)</p></blockquote></section><pre data-tool="mdnice编辑器"><section data-tool="markdown2wechat编辑器" data-website="https://aizhuanqian.com"><ul><li><p>1.R包和数据准备</p></li><li><p>2.质控</p></li><li><p>3.注释</p></li><li><p>4.搞个漂亮点的图</p></li></ul><h3 data-tool="mdnice编辑器"><span></span><span>1.R包和数据准备</span><span></span></h3><pre data-tool="mdnice编辑器"><code><span>import</span> pandas <span>as</span> pd<br><span>import</span> numpy <span>as</span> np<br><span>import</span> scanpy <span>as</span> sc<br><span>import</span> matplotlib.pyplot <span>as</span> plt<br></code></pre><p data-tool="mdnice编辑器">GSM6736629_10x-PBMC-1_ds0.1974_CountMatrix.tsv.gz文件在GEO直接搜索编号即可下载。</p><pre data-tool="mdnice编辑器"><code><span>### step1：读入表达量矩阵，构建单细胞对象 ------</span><br>path =<span>'GSM6736629_10x-PBMC-1_ds0.1974_CountMatrix.tsv.gz'</span><br>adata=sc.read_text(path).T <span>#.T是转置</span><br>adata.shape<br></code></pre><pre data-tool="mdnice编辑器"><code>(4557, 33104)<br></code></pre><pre data-tool="mdnice编辑器"><code>adata.var_names = adata.var_names.str.split(<span>':'</span>).str[<span>0</span>]<span>#行名不规范，只想留下前半段</span><br>adata.var_names_make_unique()<br>adata.var.head()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012639" data-ratio="1.8275862068965518" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSBN20BeNCibFGrglPiagLs331la4SxCZxTfUsIgBRNILzmhRXQdeWVFcg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="116" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSBN20BeNCibFGrglPiagLs331la4SxCZxTfUsIgBRNILzmhRXQdeWVFcg/640?wx_fmt=other&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>2.质控</span><span></span></h3><pre data-tool="mdnice编辑器"><code>sc.pp.filter_cells(adata,min_genes=<span>200</span>)<br>sc.pp.filter_genes(adata,min_cells=<span>3</span>)<br>adata.var[<span>'mt'</span>]=adata.var_names.str.startswith(<span>'MT-'</span>)<br>adata.var.mt.value_counts()<br></code></pre><pre data-tool="mdnice编辑器"><code>mt<br>False    25965<br>True        30<br>Name: count, dtype: int64<br></code></pre><pre data-tool="mdnice编辑器"><code>sc.pp.calculate_qc_metrics(adata,qc_vars=[<span>'mt'</span>],log1p=<span>False</span>,percent_top=<span>None</span>,inplace=<span>True</span>)<br>sc.pl.violin(adata,[<span>"n_genes_by_counts"</span>, <span>"total_counts"</span>, <span>"pct_counts_mt"</span>],jitter=<span>0.4</span>, multi_panel=<span>True</span>) <span>#mt是0</span><br><span>#sc.pl.violin(adata,["n_genes_by_counts", "total_counts"],jitter=0.4, multi_panel=True)</span><br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012643" data-ratio="0.325" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSY2bde2yonc0KZLPgqRZH8AcAiamibqibndAz9icssUzicNWAp1ia3zia6XVfw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSY2bde2yonc0KZLPgqRZH8AcAiamibqibndAz9icssUzicNWAp1ia3zia6XVfw/640?wx_fmt=other&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><code>adata=adata[adata.obs.n_genes_by_counts&gt;<span>200</span>]<br>adata=adata[adata.obs.n_genes_by_counts&lt;<span>4000</span>]<br>adata=adata[adata.obs.pct_counts_mt&lt;<span>10</span>]<br>adata.shape<br>sc.pp.normalize_total(adata,target_sum=<span>1e4</span>)<br>sc.pp.log1p(adata)<br>adata.lognorm=adata.copy()<br></code></pre><p data-tool="mdnice编辑器">celltypist包需要的数据是log normlize之后的数据，不需要进行标准流程后续的降维聚类，都被这个包包进去了。</p><h3 data-tool="mdnice编辑器"><span></span><span>3.注释</span><span></span></h3><p data-tool="mdnice编辑器">celltypist包提供了大量的参考数据，目前是52个，还挺丰富的。https://www.celltypist.org/models</p><p data-tool="mdnice编辑器">根据自己的数据的物种、组织等背景知识选择合适的。</p><pre data-tool="mdnice编辑器"><code><span>import</span> celltypist<br><span>from</span> celltypist <span>import</span> models<br>model = models.Model.load(model=<span>'Immune_All_High.pkl'</span>) <span>#https://www.celltypist.org/models</span><br>model<br>predictions = celltypist.annotate(adata.lognorm, model = model, majority_voting = <span>True</span>)<br>predictions.predicted_labels<br></code></pre><pre data-tool="mdnice编辑器"><code>🔬 Input data has 4321 cells and 25995 genes<br>🔗 Matching reference genes in the model<br>🧬 5601 features used for prediction<br>⚖️ Scaling input data<br>🖋️ Predicting labels<br>✅ Prediction done!<br>👀 Detected a neighborhood graph in the input object, will run over-clustering on the basis of it<br>⛓️ Over-clustering input data with resolution set to 5<br>🗳️ Majority voting the predictions<br>✅ Majority voting done!<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012641" data-ratio="0.76" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSwnV90ibvnEL6pz36C84zc5xPEY3ED2qJvwc5icwYJc2RFyia4pHFDDHBg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="650" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSwnV90ibvnEL6pz36C84zc5xPEY3ED2qJvwc5icwYJc2RFyia4pHFDDHBg/640?wx_fmt=other&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><code>adata2 = predictions.to_adata()<br>adata2.obs<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012642" data-ratio="0.3175925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSicaTfSuqESk9TRUnWBImQ4UPHJCJT0khHOvNFSibT2voibhzuzLw4Vvxg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSicaTfSuqESk9TRUnWBImQ4UPHJCJT0khHOvNFSibT2voibhzuzLw4Vvxg/640?wx_fmt=other&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">可以看到预测结果中已经有了注释的结果，其中majority_voting是多数投票的结果，就用它。</p><pre data-tool="mdnice编辑器"><code>adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(<span>' cells'</span>, <span>''</span>, regex=<span>False</span>)<br>adata2.obs.majority_voting = adata2.obs.majority_voting.str.replace(<span>' monocytes'</span>, <span>' Mono'</span>, regex=<span>False</span>)<br>adata2.obs.majority_voting<br></code></pre><pre data-tool="mdnice编辑器"><code>AAACCCAAGTAGGGTC    Monocytes<br>AAACCCACACCATTCC            B<br>AAACCCATCTACACTT            T<br>AAACGAAAGCACGTCC            T<br>AAACGAAGTTCAAACC          ILC<br>                      ...    <br>TTTGGTTAGGTCATAA            T<br>TTTGTTGAGAGGGTAA          ILC<br>TTTGTTGCAGGATGAC            T<br>TTTGTTGCATCGCTCT            B<br>TTTGTTGTCTGGGATT            T<br>Name: majority_voting, Length: 4321, dtype: object<br></code></pre><pre data-tool="mdnice编辑器"><code>sc.tl.umap(adata2)<br>sc.pl.umap(adata2, color = <span>'majority_voting'</span>,legend_loc=<span>"on data"</span>)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012640" data-ratio="0.8037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lS6RHJmY5Y7RcdO0nAUKWQx1P7ZChicCt2zSwibM6hMGyLcTZfQnmDIgoA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="540" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lS6RHJmY5Y7RcdO0nAUKWQx1P7ZChicCt2zSwibM6hMGyLcTZfQnmDIgoA/640?wx_fmt=other&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>4.搞个漂亮点的图</span><span></span></h3><pre data-tool="mdnice编辑器"><code><span>import</span> pandas <span>as</span> pd<br>umap_coords = adata2.obsm[<span>'X_umap'</span>]<br>labels = adata2.obs[<span>'majority_voting'</span>]<br>plt.figure(figsize=(<span>6</span>,<span>5</span>))<br>unique_labels = labels.unique()<br>colors = plt.cm.get_cmap(<span>'Accent'</span>, len(unique_labels))  <br><span>for</span> i, label <span>in</span> enumerate(unique_labels):<br>    plt.scatter(umap_coords[labels == label, <span>0</span>], umap_coords[labels == label, <span>1</span>], <br>                color=colors(i),s=<span>1</span>,alpha = <span>0.4</span>)<br><span>for</span> label <span>in</span> unique_labels:<br>    label_coords = umap_coords[labels == label]<br>    center_x = label_coords[:, <span>0</span>].mean()<br>    center_y = label_coords[:, <span>1</span>].mean()<br>    plt.text(center_x, center_y, label, fontsize=<span>10</span>, ha=<span>'center'</span>, va=<span>'center'</span>)<br>plt.grid(<span>False</span>)<br>plt.title(<span>'majority_voting'</span>, fontsize=<span>14</span>)<br>plt.xlabel(<span>'UMAP 1'</span>, fontsize=<span>12</span>)<br>plt.ylabel(<span>'UMAP 2'</span>, fontsize=<span>12</span>)<br>plt.show()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100012644" data-ratio="0.8628884826325411" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSXSbJNWyLnjE4eHgbvLpr4FfZxJYAgx2ibonQN8qr3sE5xdzCMCbwhrw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="547" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSXSbJNWyLnjE4eHgbvLpr4FfZxJYAgx2ibonQN8qr3sE5xdzCMCbwhrw/640?wx_fmt=other&amp;from=appmsg"></figure></section><section><br></section></pre><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/SocZj9ybSjuFOstcTlsb1A",target="_blank" rel="noopener noreferrer">原文链接</a>
