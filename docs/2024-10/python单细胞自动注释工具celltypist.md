---
title: "pythonå•ç»†èƒè‡ªåŠ¨æ³¨é‡Šå·¥å…·celltypist"
date: 2024-10-16T14:11:19Z
draft: ["false"]
tags: [
  "fetched",
  "ç”Ÿä¿¡æ˜Ÿçƒ"
]
categories: ["Acdemic"]
---
pythonå•ç»†èƒè‡ªåŠ¨æ³¨é‡Šå·¥å…·celltypist by ç”Ÿä¿¡æ˜Ÿçƒ
------
<div><p><img data-imgfileid="100012345" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"><img data-imgfileid="100012344" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLPukRHCbicy4pNKeEv9qd7aWSfsx7roib2od3xPrRPicw3a0kbn0uQ6JmQ/640?wx_fmt=png"><span>Â ä»Šå¤©æ˜¯ç”Ÿä¿¡æ˜Ÿçƒé™ªä½ çš„<span><strong>ç¬¬1009å¤©</strong></span></span><img data-imgfileid="100012343" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png" data-type="png" data-w="64" width="20px" src="https://mmbiz.qpic.cn/mmbiz_png/8oKPbJgbBHrDic8XGmJ0b7oibVJajb0emLBHSvuibGG49ooBgtaAibE3TNJ00iaHviaMtdIKQJfCwtUfuHicDImtSfIxg/640?wx_fmt=png"></p><hr><p><span><span>Â  Â </span></span></p><section><blockquote><p><span>å…¬ä¼—å·é‡Œçš„æ–‡ç« å¤§å¤šæ•°éœ€è¦ç¼–ç¨‹åŸºç¡€ï¼Œå¦‚æœå› ä¸ºä»£ç çœ‹ä¸æ‡‚ï¼Œè€Œè·Ÿä¸ä¸Šæ­£æ–‡çš„èŠ‚å¥ï¼Œå¯ä»¥æ¥æ‰¾æˆ‘å­¦ä¹ ï¼Œç›¸å½“äºç»™è‡ªå·±ä¸€ä¸ªæ–°æ‰‹ä¿æŠ¤æœŸã€‚</span><span>æˆ‘çš„è¯¾ç¨‹éƒ½æ˜¯å¾ªç¯å¼€è¯¾ï¼Œ</span><span>ç‚¹è¿›å»å’¨è¯¢å¾®ä¿¡â†“</span><br></p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247496032&amp;idx=1&amp;sn=e84ffce4f05b6f4318b95f170642d702&amp;chksm=fdfbb922ca8c30344c47b39529a16280bacb23c83e35a18f63e158f4e664ef94b5eee0e3fff8&amp;scene=21#wechat_redirect" textvalue="â€ç”Ÿä¿¡åˆ†æç›´æ’­è¯¾ç¨‹â€" linktype="text" imgurl="" imgdata="null" data-itemshowtype="11" tab="innerlink" data-linktype="2">ç”Ÿä¿¡åˆ†æç›´æ’­è¯¾ç¨‹</a>(æ¯æœˆåˆå¼€ä¸€æœŸï¼Œæ˜¥èŠ‚ä¼‘ä¸€ä¸ªæœˆ)</p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247494919&amp;idx=2&amp;sn=967d8dcf0f9a22047ae0bd442b9d4ee6&amp;chksm=fdfba545ca8c2c5396c3fb5caa93a5d30336626533fcac074abd7683e8d536cb2dcae31d6e7a&amp;scene=21#wechat_redirect" textvalue="ç”Ÿä¿¡æ–°æ‰‹ä¿æŠ¤â€å­¦ä¹ â€å°ç»„" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">ç”Ÿä¿¡æ–°æ‰‹ä¿æŠ¤å­¦ä¹ å°ç»„</a>ï¼ˆæ¯æœˆä¸¤æœŸï¼‰</p><p><a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247495036&amp;idx=1&amp;sn=fe8bab2c3d21e7b0a919ad4f1641ca9c&amp;chksm=fdfba53eca8c2c286522b2accc0d4cb9dda7cd9a5b36695e66d393abb5bff396d6bcaa4c9cb8&amp;scene=21#wechat_redirect" textvalue="å•ç»†èƒé™ªä¼´å­¦ä¹ å°ç»„å†…æµ‹å®Œæˆï¼Œé•¿æœŸæ‹›ç”Ÿä¸­" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">å•ç»†èƒé™ªä¼´å­¦ä¹ å°ç»„</a>ï¼ˆæ¯æœˆä¸¤æœŸ)</p></blockquote></section><pre data-tool="mdniceç¼–è¾‘å™¨"><section data-tool="markdown2wechatç¼–è¾‘å™¨" data-website="https://aizhuanqian.com"><ul><li><p>1.RåŒ…å’Œæ•°æ®å‡†å¤‡</p></li><li><p>2.è´¨æ§</p></li><li><p>3.æ³¨é‡Š</p></li><li><p>4.æä¸ªæ¼‚äº®ç‚¹çš„å›¾</p></li></ul><h3 data-tool="mdniceç¼–è¾‘å™¨"><span></span><span>1.RåŒ…å’Œæ•°æ®å‡†å¤‡</span><span></span></h3><pre data-tool="mdniceç¼–è¾‘å™¨"><code><span>import</span>Â pandasÂ <span>as</span>Â pd<br><span>import</span>Â numpyÂ <span>as</span>Â np<br><span>import</span>Â scanpyÂ <span>as</span>Â sc<br><span>import</span>Â matplotlib.pyplotÂ <span>as</span>Â plt<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">GSM6736629_10x-PBMC-1_ds0.1974_CountMatrix.tsv.gzæ–‡ä»¶åœ¨GEOç›´æ¥æœç´¢ç¼–å·å³å¯ä¸‹è½½ã€‚</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code><span>###Â step1ï¼šè¯»å…¥è¡¨è¾¾é‡çŸ©é˜µï¼Œæ„å»ºå•ç»†èƒå¯¹è±¡Â ------</span><br>pathÂ =<span>'GSM6736629_10x-PBMC-1_ds0.1974_CountMatrix.tsv.gz'</span><br>adata=sc.read_text(path).TÂ <span>#.Tæ˜¯è½¬ç½®</span><br>adata.shape<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>(4557, 33104)<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>adata.var_namesÂ =Â adata.var_names.str.split(<span>':'</span>).str[<span>0</span>]<span>#è¡Œåä¸è§„èŒƒï¼Œåªæƒ³ç•™ä¸‹å‰åŠæ®µ</span><br>adata.var_names_make_unique()<br>adata.var.head()<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100012639" data-ratio="1.8275862068965518" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSBN20BeNCibFGrglPiagLs331la4SxCZxTfUsIgBRNILzmhRXQdeWVFcg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="116" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSBN20BeNCibFGrglPiagLs331la4SxCZxTfUsIgBRNILzmhRXQdeWVFcg/640?wx_fmt=other&amp;from=appmsg"></figure><h3 data-tool="mdniceç¼–è¾‘å™¨"><span></span><span>2.è´¨æ§</span><span></span></h3><pre data-tool="mdniceç¼–è¾‘å™¨"><code>sc.pp.filter_cells(adata,min_genes=<span>200</span>)<br>sc.pp.filter_genes(adata,min_cells=<span>3</span>)<br>adata.var[<span>'mt'</span>]=adata.var_names.str.startswith(<span>'MT-'</span>)<br>adata.var.mt.value_counts()<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>mt<br>False    25965<br>True        30<br>Name: count, dtype: int64<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>sc.pp.calculate_qc_metrics(adata,qc_vars=[<span>'mt'</span>],log1p=<span>False</span>,percent_top=<span>None</span>,inplace=<span>True</span>)<br>sc.pl.violin(adata,[<span>"n_genes_by_counts"</span>,Â <span>"total_counts"</span>,Â <span>"pct_counts_mt"</span>],jitter=<span>0.4</span>,Â multi_panel=<span>True</span>)Â <span>#mtæ˜¯0</span><br><span>#sc.pl.violin(adata,["n_genes_by_counts",Â "total_counts"],jitter=0.4,Â multi_panel=True)</span><br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100012643" data-ratio="0.325" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSY2bde2yonc0KZLPgqRZH8AcAiamibqibndAz9icssUzicNWAp1ia3zia6XVfw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSY2bde2yonc0KZLPgqRZH8AcAiamibqibndAz9icssUzicNWAp1ia3zia6XVfw/640?wx_fmt=other&amp;from=appmsg"></figure><pre data-tool="mdniceç¼–è¾‘å™¨"><code>adata=adata[adata.obs.n_genes_by_counts&gt;<span>200</span>]<br>adata=adata[adata.obs.n_genes_by_counts&lt;<span>4000</span>]<br>adata=adata[adata.obs.pct_counts_mt&lt;<span>10</span>]<br>adata.shape<br>sc.pp.normalize_total(adata,target_sum=<span>1e4</span>)<br>sc.pp.log1p(adata)<br>adata.lognorm=adata.copy()<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">celltypiståŒ…éœ€è¦çš„æ•°æ®æ˜¯log normlizeä¹‹åçš„æ•°æ®ï¼Œä¸éœ€è¦è¿›è¡Œæ ‡å‡†æµç¨‹åç»­çš„é™ç»´èšç±»ï¼Œéƒ½è¢«è¿™ä¸ªåŒ…åŒ…è¿›å»äº†ã€‚</p><h3 data-tool="mdniceç¼–è¾‘å™¨"><span></span><span>3.æ³¨é‡Š</span><span></span></h3><p data-tool="mdniceç¼–è¾‘å™¨">celltypiståŒ…æä¾›äº†å¤§é‡çš„å‚è€ƒæ•°æ®ï¼Œç›®å‰æ˜¯52ä¸ªï¼Œè¿˜æŒºä¸°å¯Œçš„ã€‚https://www.celltypist.org/models</p><p data-tool="mdniceç¼–è¾‘å™¨">æ ¹æ®è‡ªå·±çš„æ•°æ®çš„ç‰©ç§ã€ç»„ç»‡ç­‰èƒŒæ™¯çŸ¥è¯†é€‰æ‹©åˆé€‚çš„ã€‚</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code><span>import</span>Â celltypist<br><span>from</span>Â celltypistÂ <span>import</span>Â models<br>modelÂ =Â models.Model.load(model=<span>'Immune_All_High.pkl'</span>)Â <span>#https://www.celltypist.org/models</span><br>model<br>predictionsÂ =Â celltypist.annotate(adata.lognorm,Â modelÂ =Â model,Â majority_votingÂ =Â <span>True</span>)<br>predictions.predicted_labels<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>ğŸ”¬ Input data has 4321 cells and 25995 genes<br>ğŸ”— Matching reference genes in the model<br>ğŸ§¬ 5601 features used for prediction<br>âš–ï¸ Scaling input data<br>ğŸ–‹ï¸ Predicting labels<br>âœ… Prediction done!<br>ğŸ‘€ Detected a neighborhood graph in the input object, will run over-clustering on the basis of it<br>â›“ï¸ Over-clustering input data with resolution set to 5<br>ğŸ—³ï¸ Majority voting the predictions<br>âœ… Majority voting done!<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100012641" data-ratio="0.76" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSwnV90ibvnEL6pz36C84zc5xPEY3ED2qJvwc5icwYJc2RFyia4pHFDDHBg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="650" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSwnV90ibvnEL6pz36C84zc5xPEY3ED2qJvwc5icwYJc2RFyia4pHFDDHBg/640?wx_fmt=other&amp;from=appmsg"></figure><pre data-tool="mdniceç¼–è¾‘å™¨"><code>adata2Â =Â predictions.to_adata()<br>adata2.obs<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100012642" data-ratio="0.3175925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSicaTfSuqESk9TRUnWBImQ4UPHJCJT0khHOvNFSibT2voibhzuzLw4Vvxg/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSicaTfSuqESk9TRUnWBImQ4UPHJCJT0khHOvNFSibT2voibhzuzLw4Vvxg/640?wx_fmt=other&amp;from=appmsg"></figure><p data-tool="mdniceç¼–è¾‘å™¨">å¯ä»¥çœ‹åˆ°é¢„æµ‹ç»“æœä¸­å·²ç»æœ‰äº†æ³¨é‡Šçš„ç»“æœï¼Œå…¶ä¸­majority_votingæ˜¯å¤šæ•°æŠ•ç¥¨çš„ç»“æœï¼Œå°±ç”¨å®ƒã€‚</p><pre data-tool="mdniceç¼–è¾‘å™¨"><code>adata2.obs.majority_votingÂ =Â adata2.obs.majority_voting.str.replace(<span>'Â cells'</span>,Â <span>''</span>,Â regex=<span>False</span>)<br>adata2.obs.majority_votingÂ =Â adata2.obs.majority_voting.str.replace(<span>'Â monocytes'</span>,Â <span>'Â Mono'</span>,Â regex=<span>False</span>)<br>adata2.obs.majority_voting<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>AAACCCAAGTAGGGTC    Monocytes<br>AAACCCACACCATTCC            B<br>AAACCCATCTACACTT            T<br>AAACGAAAGCACGTCC            T<br>AAACGAAGTTCAAACC          ILC<br>                      ...    <br>TTTGGTTAGGTCATAA            T<br>TTTGTTGAGAGGGTAA          ILC<br>TTTGTTGCAGGATGAC            T<br>TTTGTTGCATCGCTCT            B<br>TTTGTTGTCTGGGATT            T<br>Name: majority_voting, Length: 4321, dtype: object<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><code>sc.tl.umap(adata2)<br>sc.pl.umap(adata2,Â colorÂ =Â <span>'majority_voting'</span>,legend_loc=<span>"onÂ data"</span>)<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100012640" data-ratio="0.8037037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lS6RHJmY5Y7RcdO0nAUKWQx1P7ZChicCt2zSwibM6hMGyLcTZfQnmDIgoA/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="540" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lS6RHJmY5Y7RcdO0nAUKWQx1P7ZChicCt2zSwibM6hMGyLcTZfQnmDIgoA/640?wx_fmt=other&amp;from=appmsg"></figure><h3 data-tool="mdniceç¼–è¾‘å™¨"><span></span><span>4.æä¸ªæ¼‚äº®ç‚¹çš„å›¾</span><span></span></h3><pre data-tool="mdniceç¼–è¾‘å™¨"><code><span>import</span>Â pandasÂ <span>as</span>Â pd<br>umap_coordsÂ =Â adata2.obsm[<span>'X_umap'</span>]<br>labelsÂ =Â adata2.obs[<span>'majority_voting'</span>]<br>plt.figure(figsize=(<span>6</span>,<span>5</span>))<br>unique_labelsÂ =Â labels.unique()<br>colorsÂ =Â plt.cm.get_cmap(<span>'Accent'</span>,Â len(unique_labels))Â Â <br><span>for</span>Â i,Â labelÂ <span>in</span>Â enumerate(unique_labels):<br>Â Â Â Â plt.scatter(umap_coords[labelsÂ ==Â label,Â <span>0</span>],Â umap_coords[labelsÂ ==Â label,Â <span>1</span>],Â <br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â color=colors(i),s=<span>1</span>,alphaÂ =Â <span>0.4</span>)<br><span>for</span>Â labelÂ <span>in</span>Â unique_labels:<br>Â Â Â Â label_coordsÂ =Â umap_coords[labelsÂ ==Â label]<br>Â Â Â Â center_xÂ =Â label_coords[:,Â <span>0</span>].mean()<br>Â Â Â Â center_yÂ =Â label_coords[:,Â <span>1</span>].mean()<br>Â Â Â Â plt.text(center_x,Â center_y,Â label,Â fontsize=<span>10</span>,Â ha=<span>'center'</span>,Â va=<span>'center'</span>)<br>plt.grid(<span>False</span>)<br>plt.title(<span>'majority_voting'</span>,Â fontsize=<span>14</span>)<br>plt.xlabel(<span>'UMAPÂ 1'</span>,Â fontsize=<span>12</span>)<br>plt.ylabel(<span>'UMAPÂ 2'</span>,Â fontsize=<span>12</span>)<br>plt.show()<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-imgfileid="100012644" data-ratio="0.8628884826325411" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSXSbJNWyLnjE4eHgbvLpr4FfZxJYAgx2ibonQN8qr3sE5xdzCMCbwhrw/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="547" src="https://mmbiz.qpic.cn/mmbiz_jpg/8oKPbJgbBHqtYlY15bBicBvEmOunuP9lSXSbJNWyLnjE4eHgbvLpr4FfZxJYAgx2ibonQN8qr3sE5xdzCMCbwhrw/640?wx_fmt=other&amp;from=appmsg"></figure></section><section><br></section></pre><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/SocZj9ybSjuFOstcTlsb1A",target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a>
