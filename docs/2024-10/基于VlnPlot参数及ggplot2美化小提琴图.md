---
title: "基于VlnPlot参数及ggplot2美化小提琴图"
date: 2024-10-10T01:45:11Z
draft: ["false"]
tags: [
  "fetched",
  "生信漫漫学"
]
categories: ["Acdemic"]
---
基于VlnPlot参数及ggplot2美化小提琴图 by 生信漫漫学
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"><span></span><span></span><span>前情提要</span><span></span></h3><p data-tool="mdnice编辑器">上期的推文<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247525623&amp;idx=1&amp;sn=cfb7764955e18b4bcf7f936dc104bcc5&amp;scene=21#wechat_redirect" data-linktype="2">VlnPlot结果及常用参数浅析</a>整理介绍了一下小提琴图可视化marker基因，在结尾简单介绍了一下<strong>可用于美化可视化结果的参数。</strong></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100042043" data-ratio="0.6785009861932939" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOdmia2vJn7fsW3Qf3vvtc80lvhhMZUAorUkIHuUZbcamWOeMBXOeSOzA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1014" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOdmia2vJn7fsW3Qf3vvtc80lvhhMZUAorUkIHuUZbcamWOeMBXOeSOzA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">这期我们就一起来<strong>使用一下这些参数，绘制更好看的小提琴图叭！</strong></p><h3 data-tool="mdnice编辑器"><span></span><span></span><span>分析数据简介</span><span></span></h3><p data-tool="mdnice编辑器">因为分析中需要用到分组信息，而pbmc3k的数据集是单个样品，没有包含分组信息。所以<strong>这期的示例数据换为<code>ifnb.SeuratData</code>的数据集</strong></p><p data-tool="mdnice编辑器"><strong>ifnb.SeuratData数据降维聚类分群的内容见推文——<a href="https://mp.weixin.qq.com/s?__biz=MzkxOTI0Mjc3Mw==&amp;mid=2247489973&amp;idx=1&amp;sn=fa402ec5f9505ac297913553a8787cac&amp;scene=21#wechat_redirect" data-linktype="2">ifnb数据集分析及注释对比</a></strong></p><p data-tool="mdnice编辑器">最后的<strong>手动分群情况</strong>：</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100042047" data-ratio="0.8023255813953488" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOR4XfGm86GlIkKbfuRg8yhuPDHTSgYMcsbXRM5QejgTO54pTV78Izhg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1032" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOR4XfGm86GlIkKbfuRg8yhuPDHTSgYMcsbXRM5QejgTO54pTV78Izhg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>获取top3的Marker基因：</strong></p><pre data-tool="mdnice编辑器"><span></span><code>markers &lt;- FindAllMarkers(sce.all.int, only.pos = TRUE, min.pct = 0.25,  logfc.threshold = 0.25, verbose = FALSE)<br><br>top3 = markers %&gt;% group_by(cluster) %&gt;% top_n(n = 3, wt = avg_log2FC)<br>g2 = unique(top3<span>$gene</span>)<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span></span><span>基于VlnPlot参数美化小提琴图</span><span></span></h3><h4 data-tool="mdnice编辑器"><span></span><span>1. 直接可视化</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code>VlnPlot(sce.all.int, features = g2[1:6])<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100042046" data-ratio="0.9527777777777777" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOX5R8KYVWz2MWmqE2s2WQWVNib1GibKkQjGXl4kPGMl6IFSicJm48dfmtw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOX5R8KYVWz2MWmqE2s2WQWVNib1GibKkQjGXl4kPGMl6IFSicJm48dfmtw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>如果直接使用VlnPlot可视化，不设置参数，会得到每个基因单独展示的结果，不太易读</strong>。</p><p data-tool="mdnice编辑器">如果想将marker一起展示，就需要使用<strong>stack参数</strong>绘制堆叠小提琴图</p><h4 data-tool="mdnice编辑器"><span></span><span>2. 堆叠小提琴图</span><span></span></h4><pre data-tool="mdnice编辑器"><span></span><code><span>#使用paletteer包来调用awtools包中的调色板函数</span><br>library(paletteer)<br><br>color &lt;- c(paletteer_d(<span>"awtools::bpalette"</span>),<br>           paletteer_d(<span>"awtools::a_palette"</span>),<br>           paletteer_d(<span>"awtools::mpalette"</span>))<br><br><span>#stack=T绘制堆叠小提琴图</span><br>p1 &lt;- VlnPlot(sce.all.int,features=g2,<br>              group.by=<span>"celltype"</span>,<br>              stack=T,cols=color<br>)<br><br><span>#去掉标签注释</span><br>p1+NoLegend()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100042045" data-ratio="0.9268518518518518" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOwutyPePybAMrDqVGkeBia4Zlsibfcr6GicFklickFhzcw5Lc0icR5ARfLfg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOwutyPePybAMrDqVGkeBia4Zlsibfcr6GicFklickFhzcw5Lc0icR5ARfLfg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">可以使用<strong>flip参数</strong>进行翻转，使得结果更加易读</p><pre data-tool="mdnice编辑器"><span></span><code>p1 &lt;- VlnPlot(sce.all.int,features=g2,<br>              group.by=<span>"celltype"</span>,<br>              flip=T,stack=T,cols=color<br>)<br><br>p1+NoLegend()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100042044" data-ratio="0.899074074074074" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOWeOpov43BNl0YiaG0aDIIGSHCk6FbP8c74SoaXjicPVqbVX0tC6kfkBg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOWeOpov43BNl0YiaG0aDIIGSHCk6FbP8c74SoaXjicPVqbVX0tC6kfkBg/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>3. 分组小提琴图</span><span></span></h4><p data-tool="mdnice编辑器"><strong>分组小提琴图是一种用于展示不同组别中数据分布情况的可视化图表，当有两个组别时可以很好的展示基因在两个组间的差异</strong></p><p data-tool="mdnice编辑器">使用<code>split.by</code>参数可选择按照某一分组变量（这里是 'stim'）来分割数据</p><pre data-tool="mdnice编辑器"><span></span><code>p2 &lt;- VlnPlot(sce.all.int, g2, stack = TRUE,<br>              split.by = <span>'stim'</span>,flip=T, add.noise = T,<br>              cols = c(<span>"#78C2C4"</span>,<span>"#C73E3A"</span>),) ;p2<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100042052" data-ratio="0.8407407407407408" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOa7YwiamS3615b30Eh87uPR3f7XpobOicOFcCCd4EkJyIvGXZiaLcLaZPQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOa7YwiamS3615b30Eh87uPR3f7XpobOicOFcCCd4EkJyIvGXZiaLcLaZPQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><strong>从图中可以看到pDC相关基因主要在STIM组高表达，有些基因仅在STIM或者只在CTRL组表达</strong></p><h4 data-tool="mdnice编辑器"><span></span><span>4. 分组分半小提琴图</span><span></span></h4><p data-tool="mdnice编辑器">也可以<strong>在同一个图形中绘制多个分组的分布</strong>，可以直观地比较不同组之间的数据分布情况，以便进行统计分析和推断。</p><p data-tool="mdnice编辑器">使用<code>split.plot = T</code>生成每个分组的单独小提琴图</p><pre data-tool="mdnice编辑器"><span></span><code>p&lt;-VlnPlot(sce.all.int, features = g2,stack=T,<br>           pt.size=0,flip = T,add.noise = T,<br>           split.by = <span>'stim'</span>,<br>           group.by = <span>"celltype"</span>,<br>           cols = c(<span>"#78C2C4"</span>,<span>"#C73E3A"</span>),<br>           split.plot = T)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100042049" data-ratio="0.8111111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOYcYyCicvENNGez1NTib4YTuibnCfxoskRyQX7DEXWFtg1lj0sK6icY8Zjg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOYcYyCicvENNGez1NTib4YTuibnCfxoskRyQX7DEXWFtg1lj0sK6icY8Zjg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">将分组以及分组且分半小提琴图拼图，可以更加直观的看到两个分组之间基因表达的差异</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100042048" data-ratio="0.7027777777777777" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOlufJkF20Rqic4vx2LNJYD0ek10Q2tzCElSu8PcllJnicAOibe3a953uwg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOlufJkF20Rqic4vx2LNJYD0ek10Q2tzCElSu8PcllJnicAOibe3a953uwg/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span></span><span>使用ggplot2进行美化</span><span></span></h3><p data-tool="mdnice编辑器">因为<strong>VlnPlot是一个ggplot的对象，所以可以基于ggplot2进行美化</strong>。或者<strong>提取需要的数据，使用ggplot2直接绘制小提琴图</strong></p><h4 data-tool="mdnice编辑器"><span></span><span>1. 美化VlnPlot结果</span><span></span></h4><p data-tool="mdnice编辑器"><strong>可以基于ggplot2的theme函数去调整坐标轴，设置文本颜色和大小、添加边框、调整间距等</strong></p><pre data-tool="mdnice编辑器"><span></span><code>p1 + theme_bw()+<br>  theme(<br>    axis.text.x.bottom = element_text(angle = 45,hjust = 1,vjust = 1),<br>    panel.grid.major = element_blank(),<br>    panel.grid.minor = element_blank(),<br>    legend.position = <span>"none"</span>,<br>    axis.text.x = element_text(color = <span>'black'</span>,size = 11),<br>    axis.text.y = element_blank(),<br>    axis.title.x = element_text(color = <span>'black'</span>, size = 15),<br>    axis.ticks.x = element_line(color = <span>'black'</span>),<br>    axis.ticks.y = element_blank(),<br>  )<br></code></pre><ul data-tool="mdnice编辑器"><li><section>旋转并对齐 x 轴标签，设置其样式；</section></li><li><section>取消 x 轴的次要网格线与 y 轴的刻度标签；</section></li><li><section>隐藏图例；</section></li><li><section>设置 x 轴标题和刻度线的颜色和大小；</section></li><li><section>完全取消 y 轴的刻度和网格线，以简化图形展示。</section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100042051" data-ratio="0.8287037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOs8ZzvNek9fFh9rOqag2y6yicQyPwUYAoGmib6Avf20KX5UuTxDUjHIPw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOs8ZzvNek9fFh9rOqag2y6yicQyPwUYAoGmib6Avf20KX5UuTxDUjHIPw/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>p1+theme_minimal()+<br>  theme(axis.text.x = element_text(angle = 45, hjust = 1),<br>        axis.text.y = element_blank(),<br>        axis.title = element_text(size = 12),<br>        legend.position = <span>'none'</span>)+<br>  scale_fill_manual(values = color)+<br>  labs(title = <span>'Top 3 markers for each cluster'</span>,<br>       x = <span>'Cluster'</span>,<br>       y = <span>'Expression'</span>)<br></code></pre><p data-tool="mdnice编辑器">通过<code>theme_minimal()</code>和<code>theme()</code>函数对图形的样式进行美化：</p><ul data-tool="mdnice编辑器"><li><section>将 x 轴标签旋转 45 度并右对齐；</section></li><li><section>隐藏 y 轴的刻度标签；</section></li><li><section>设定轴标题的字体大小；</section></li><li><section>移除图例；</section></li><li><section>自定义填充颜色；</section></li><li><section>添加标题和轴标签。</section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100042050" data-ratio="0.7861111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOQ2cvmIA3FUHBEjoAawoVDLpy65EqiaEOgTDO1eG1Rkibvy4N5BZwIvJQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjS6MWiaf7GtOOayWkKCWj2jOQ2cvmIA3FUHBEjoAawoVDLpy65EqiaEOgTDO1eG1Rkibvy4N5BZwIvJQ/640?wx_fmt=png&amp;from=appmsg"></figure><h4 data-tool="mdnice编辑器"><span></span><span>2. 提取数据使用ggplot2进行美化</span><span></span></h4><p data-tool="mdnice编辑器">小谢私认为基于ggplot2的theme函数美化VlnPlot结果已经比较好看了，但由于是VlnPlot结果的框架下，可能还是会有些限制</p><p data-tool="mdnice编辑器"><strong>如果需要高度定制化小提琴的图的结果，也可以提取需要的数据，使用ggplot2从绘图到美化</strong>。</p><p data-tool="mdnice编辑器">之前的前辈们已经整理好了<strong>提取数据进行可视化的方法：</strong></p><ul data-tool="mdnice编辑器"><li><section>比如<strong>生信菜鸟团</strong>的<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247513053&amp;idx=1&amp;sn=319a7fe5ca9a50a1aefa42408dcf5c36&amp;scene=21#wechat_redirect" data-linktype="2">Violin plot 美化</a></section></li><li><section><strong>生信星球的</strong><a href="https://mp.weixin.qq.com/s?__biz=MzU4NjU4ODQ2MQ==&amp;mid=2247493374&amp;idx=1&amp;sn=cd3a7dc55faaef1919fb4b667dedb26d&amp;scene=21#wechat_redirect" data-linktype="2">大漂亮版本的单细胞小提琴图</a></section></li><li><section>以及<strong>生信补给站</strong>的<a href="https://mp.weixin.qq.com/s?__biz=MzIyNDI1MzgzOQ==&amp;mid=2650401031&amp;idx=1&amp;sn=e0a826476b1054b439831e321cbf88f8&amp;scene=21#wechat_redirect" data-linktype="2">scRNA分析| Seurat堆叠小提琴图不满足？那就ggplot2 堆叠 各种元素</a></section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span></span><span>小结</span><span></span></h3><p data-tool="mdnice编辑器">这期<strong>使用VlnPlot函数的相关参数，绘制堆叠小提琴图，以及对小提琴图进行了分组分半的展示</strong></p><p data-tool="mdnice编辑器"><strong>基于ggplot2在VlnPlot结果的基础上进行调整</strong>，如果<strong>想提取需要的数据，使用ggplot2从绘图到美化，可以参考前辈们整理的推文！</strong></p><p data-tool="mdnice编辑器"><strong>如果你也想做单细胞转录组数据分析，最好是有自己的计算机资源哦，比如我们的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247528363&amp;idx=1&amp;sn=5e02f3e9b2e148191e23ebc2c0d780e7&amp;scene=21#wechat_redirect" data-linktype="2">2024的共享服务器交个朋友福利价仍然是800</a>，而且还需要有基本的<a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247533791&amp;idx=1&amp;sn=ff5e109daa321a13ba17f7ce1fabc799&amp;scene=21#wechat_redirect" textvalue="生物信‍息学基础" linktype="text" imgurl="" imgdata="null" tab="innerlink" data-linktype="2">生物信息学基础</a>，也可以看看我们的生物信息学马拉松授课，你的生物信息学入门课。</strong></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/G9-57qokEalEmG4CP_1XzA",target="_blank" rel="noopener noreferrer">原文链接</a>
