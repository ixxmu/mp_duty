---
title: "超越代码6：肿瘤细胞CNV分析"
date: 2024-10-13T00:29:46Z
draft: ["false"]
tags: [
  "fetched",
  "生信会客厅"
]
categories: ["Acdemic"]
---
超越代码6：肿瘤细胞CNV分析 by 生信会客厅
------
<div><section><em>这次分享的教程源自我多年优化的实战代码，其中有很多提高效率和优化结果的自定义函数封装于scPRIT包。由于scPRIT包依赖特定的R和Python环境，我特意将它集成在docker镜像kinesin/rstudio:2.0.0中。为了确保教程代码的顺畅运行，推荐使用该docker镜像提供的分析环境。</em></section><section><br></section><p>通过比较肿瘤来源细胞与正常参考细胞的单细胞转录组变化，从而推断基因组层面的CNV情况，进而判断<span>肿瘤</span><span>来</span><span>源细胞中的恶性细胞和正常细胞，以及恶性细胞的克隆型</span>是单细胞转录组分析的常见需求。本节介绍两种广泛使用cnv分析工具，CopyKat和inferCNV的用法。</p><section><br></section><section><strong><span>CopyKat</span></strong></section><section>基础分析<br></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>library(Seurat)</span></code><code><span>library(scPRIT)</span></code><code><span>library(copykat)</span></code><code><span>library(ComplexHeatmap)</span></code><code><span>options(scprithost = <span>"xxx.xxx.xxx.xxx"</span>, authcode = <span>"xxxxxxxxxxxx"</span>)options(future.globals.maxSize = <span>30</span> * <span>1024</span>^<span>3</span>)</span></code><code><span>setwd(<span>"~/project/BeyondCode/CopyKAT"</span>)</span></code><code><span><br></span></code><code><span><span># copykat分析</span></span></code><code><span>scRNA &lt;- readRDS(<span>"~/project/BeyondCode/Data/sco.hny_anno.rds"</span>)</span></code><code><span>scRNA &lt;- subset(scRNA, CellType != <span>"Doublets"</span>)</span></code><code><span>scRNA$CellType &lt;- <span>as</span>.character(scRNA$CellType)</span></code><code><span>inputdata &lt;- copykat.Prepare(scRNA, celltype.key = <span>"CellType"</span>, nRefcell = <span>10000</span>, tumorOrigin = <span>"Alveolar cell"</span>)</span></code><code><span>copykat.test &lt;- copykat(rawmat=inputdata[[<span>"counts"</span>]], norm.cell.names=inputdata[[<span>"refcell"</span>]], </span></code><code><span>                        sam.name=<span>"LUAD"</span>, distance=<span>"euclidean"</span>, output.seg=<span>"FALSE"</span>,</span></code><code><span>                        plot.genes=<span>"FALSE"</span>, genome=<span>"hg20"</span>, n.cores=<span>60</span>)</span></code><code><span><br></span></code><code><span>saveRDS(copykat.test, <span>"copykat.res.rds"</span>)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002669" data-ratio="0.8603603603603603" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy24chnH1zTha1jY7FcIh43ibhRZkPciaSuTWW5AJp3ejd0nIdGmEognz6w/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="888" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy24chnH1zTha1jY7FcIh43ibhRZkPciaSuTWW5AJp3ejd0nIdGmEognz6w/640?wx_fmt=png&amp;from=appmsg"></p><section><br></section><section>CNV评分与分组</section><section><ul><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="cs"><code><span>copykat.res &lt;- readRDS(<span>"copykat.res.rds"</span>)</span></code><code><span>cnv.meta &lt;- copykat.tidyres(copykat.res, n.cnvgroup = <span>6</span>)</span></code><code><span>saveRDS(cnv.meta, <span>"cnv.meta.rds"</span>)</span></code><code><span><br></span></code><code><span>scRNA &lt;- AddMetaData(scRNA, metadata = cnv.meta)</span></code><code><span>p1 &lt;- DimPlot(scRNA, <span>group</span>.<span>by</span> = <span>"copykat.pred"</span>)</span></code><code><span>p2 &lt;- DimPlot(scRNA, <span>group</span>.<span>by</span> = <span>"cnaGroup"</span>)</span></code><code><span>p3 &lt;- DimPlot(scRNA, <span>group</span>.<span>by</span> = <span>"SampleID"</span>)</span></code><code><span>p4 &lt;- FeaturePlot(scRNA, features = <span>"cnaScore"</span>)</span></code><code><span>p &lt;- (p1|p2)/(p3|p4)</span></code><code><span>ggsave(<span>"copykat_results.pdf"</span>, p, width = <span>12</span>, height = <span>9</span>)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002670" data-ratio="0.7481481481481481" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy2zg16m4dqRdyw1yoy69ssUTJmgkmqRqlocEDveZytowUKRgX8DroGRQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy2zg16m4dqRdyw1yoy69ssUTJmgkmqRqlocEDveZytowUKRgX8DroGRQ/640?wx_fmt=png&amp;from=appmsg"></p><section><br></section><section>肿瘤亚克隆热图</section><section><ul><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>mycols &lt;- <span>list</span>(</span></code><code><span>  cnaGroup = setNames(RColorBrewer::brewer.pal(<span>6</span>, <span>"Set1"</span>), <span>1</span>:<span>6</span>),</span></code><code><span>  SampleID = setNames(RColorBrewer::brewer.pal(<span>10</span>, <span>"Paired"</span>), c(paste0(<span>"LUAD"</span>, <span>1</span>:<span>5</span>), paste0(<span>"N"</span>, <span>1</span>:<span>5</span>)))</span></code><code><span>)</span></code><code><span>ht &lt;- copykat.Heatmap(scRNA, copykat.res, anno.key = c(<span>"cnaGroup"</span>,<span>"SampleID"</span>), </span></code><code><span>                      cnvGroup.key = <span>"cnaGroup"</span>, anno.cols = mycols)</span></code><code><span>pdf(<span>"subclone_heatmap.pdf"</span>, width = <span>10</span>, height = <span>6.5</span>)</span></code><code><span>plot(ht)</span></code><code><span>dev.off()</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002671" data-ratio="0.6496350364963503" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy2b7ef7Fpiay8DgAl7vbT78ftujS5bkoP7SeGoScQHY45nHo6pibiaXJicfg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="959" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy2b7ef7Fpiay8DgAl7vbT78ftujS5bkoP7SeGoScQHY45nHo6pibiaXJicfg/640?wx_fmt=png&amp;from=appmsg"></p><section><br></section><section><br></section><section><strong><span>inferCNV</span></strong></section><section>基础分析</section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="php"><code><span>library(Seurat)</span></code><code><span>library(infercnv)</span></code><code><span>library(scPRIT)</span></code><code><span>options(scprithost = <span>"xxx.xxx.xxx.xxx"</span>, authcode = <span>"xxxxxxxxxxxx"</span>)options(future.globals.maxSize = <span>30</span> * <span>1024</span>^<span>3</span>)</span></code><code><span>setwd(<span>"~/project/BeyondCode/inferCNV"</span>)</span></code><code><span><br></span></code><code><span><span># 基础分析</span></span></code><code><span>scRNA &lt;- readRDS(<span>"~/project/BeyondCode/Data/sco.hny_anno_cnv.rds"</span>)</span></code><code><span>ppdata &lt;- infercnv.Prepare(scRNA, celltype.key = <span>"CellType"</span>, samleid.key = <span>"SampleID"</span>, </span></code><code><span>                           tumorOrigin = <span>"Alveolar cell"</span>, nRefcell = <span>10000</span>)</span></code><code><span>gene.pos &lt;- read.table(<span>"~/project/BeyondCode/Resource/inferCNV/hg38_gencode_v27.txt"</span>, header = F, row.names = <span>1</span>)</span></code><code><span>infercnv_obj = CreateInfercnvObject(raw_counts_matrix = ppdata[[<span>"counts"</span>]],</span></code><code><span>                                    annotations_file = ppdata[[<span>"annodata"</span>]],</span></code><code><span>                                    gene_order_file = gene.pos,</span></code><code><span>                                    ref_group_names = ppdata[[<span>"refnames"</span>]]) </span></code><code><span>saveRDS(infercnv_obj, <span>"infercnv_pp.rds"</span>)</span></code><code><span><br></span></code><code><span>infercnv_obj &lt;- readRDS(<span>"infercnv_pp.rds"</span>)</span></code><code><span>cnv.res &lt;- infercnv::run(infercnv_obj,</span></code><code><span>                         cutoff=<span>0.1</span>,  <span># Smart-seq2用1, 10x Genomics用0.1</span></span></code><code><span>                         out_dir=<span>"infercnv_out"</span>, </span></code><code><span>                         cluster_by_groups=<span>TRUE</span>, </span></code><code><span>                         denoise=<span>TRUE</span>,</span></code><code><span>                         num_threads = <span>10</span>,</span></code><code><span>                         HMM=<span>FALSE</span>)</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002676" data-ratio="0.9607438016528925" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy2RNndfDvYC4rwuHddC6ibhO0cBU5fuyKK3hbDiaHJCsBr6gP2s6QK9SGw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="968" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy2RNndfDvYC4rwuHddC6ibhO0cBU5fuyKK3hbDiaHJCsBr6gP2s6QK9SGw/640?wx_fmt=png&amp;from=appmsg"></p><section><br></section><section><span>CNV评分与分组</span></section><section><ul><li><li></ul><pre data-lang="javascript"><code><span>infercnv.res &lt;- readRDS(<span>"infercnv_out/run.final.infercnv_obj"</span>)</span></code><code><span>cnv.info &lt;- infercnv.tidyres(infercnv.res, n.cnvgroup = <span>7</span>)</span></code></pre></section><section><span></span></section><p><img data-galleryid="" data-imgfileid="100002672" data-ratio="0.43148148148148147" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy291mvOgywiceDyCcibGpBFOAKezibapRECeucj7XiadKwbzBKyRdmticXQicg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy291mvOgywiceDyCcibGpBFOAKezibapRECeucj7XiadKwbzBKyRdmticXQicg/640?wx_fmt=png&amp;from=appmsg"></p><section><br></section><section>恶性细胞热图</section><section><ul><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="css"><code><span><span>malign</span><span>.cells</span> &lt;<span>-</span> <span>colnames</span>(<span>infercnv</span><span>.res</span>@<span>expr</span>.<span>data</span>)[<span>do</span>.<span>call</span>(<span>c</span>, infercnv.res@observation_grouped_cell_indices[<span>1</span>:<span>5</span>])]</span></code><code><span>mycols &lt;- list(</span></code><code><span>  cnvGroup = setNames(RColorBrewer::brewer.pal(<span>7</span>, <span>"Set1"</span>), <span>1</span>:<span>7</span>),</span></code><code><span>  SampleID = setNames(RColorBrewer::brewer.pal(<span>5</span>, <span>"Paired"</span>), paste0(<span>"LUAD"</span>, <span>1</span>:<span>5</span>))</span></code><code><span>)</span></code><code><span>ht &lt;- infercnv.Heatmap(scRNA, infercnv.res, cells = malign.cells, cnvGroup.key = <span>"cnvGroup"</span>,</span></code><code><span>                       anno.key = c(<span>"cnvGroup"</span>, <span>"SampleID"</span>), anno.cols = mycols)</span></code><code><span>pdf(<span>"cnvgroup_heatmap.pdf"</span>, width = <span>12</span>, height = <span>7.5</span>)</span></code><code><span>plot(ht)</span></code><code><span>dev.off()</span></code></pre></section><p><img data-galleryid="" data-imgfileid="100002673" data-ratio="0.6231481481481481" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy2oQuPalulvjA4M8k9KTxYicA94gCdZIbmV0OnQueXzscQTI9zOaBzJibQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/VTXDic6Eia0AGpyVmAtWkremugdkWJhjy2oQuPalulvjA4M8k9KTxYicA94gCdZIbmV0OnQueXzscQTI9zOaBzJibQ/640?wx_fmt=png&amp;from=appmsg"></p><section><br></section><section><br></section><section><strong><span>数据与资源</span></strong></section><section>本节分析数据与结果百度云下载链接<span></span></section><p><span></span><span>https://pan.baidu.com/s/1QYPXD2iU0uqUiPh3VgrQYg?pwd=8rkk</span></p><p>提取码：8rkk</p><p><br></p><p><span>kinesin/rstudio:2.0.0</span><span>镜像</span><span>和scPRIT包的开发、测试非常耗费时间和精力，后续我希望可以持续提供维护和更新服务，因此计划采用收费授权的模式，具体标准如下：</span></p><ul><li><p>200元，授权使用90天</p></li><li><p>600元，授权使用一年</p></li></ul><p>授权期内如有更新免费升级，有意者添加Kinesin微信购买。</p><p><br></p><p><span><strong><span>超越代码实战训练班</span></strong></span></p><p>很多第一次分析单细胞数据的朋友，会把70%的时间耗费在代码和生信基础问题上，真正用来思考生物学问题的时间非常有限，因此产出高水平的文章相对比较困难。<span>近几年，我深度参与了几十个单细胞、空转项目的分析，目前已有十几篇合作的署名/致谢文章发表。<span>如果有我这么一个过来人提供分析环境和实战流程，并参与您的项目讨论，或许可以起到事半功倍的效果。如果您对此有兴趣，请阅读《<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyMzMwNDQ2MA==&amp;mid=2247486184&amp;idx=1&amp;sn=413328830d29341abafdb7906524f4f7&amp;chksm=e821048bdf568d9d356c855b38f7cb65d0e3fdb88293c0f5a6bcf320385a57a31f457e8cf932&amp;scene=21#wechat_redirect" textvalue="超越代码" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">超越代码</a>》和《<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzIyMzMwNDQ2MA==&amp;mid=2247486190&amp;idx=1&amp;sn=c5af0dd634837e61d5dea4744b8765cb&amp;chksm=e821048ddf568d9b3a734f53471d03d2b7009aeaa3c982fa3addb6c07aa0ef1a48e2e4325cac&amp;scene=21#wechat_redirect" textvalue="单细胞分析实战训练班的课程规划" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2" hasload="1">单细胞分析实战训练班的课程规划</a>》了解详情！</span></span></p><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/tXLIqPcJFqGfz_Xv_9V3ag",target="_blank" rel="noopener noreferrer">原文链接</a>
