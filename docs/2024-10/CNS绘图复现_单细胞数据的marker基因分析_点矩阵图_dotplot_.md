---
title: "CNS绘图复现：单细胞数据的marker基因分析（点矩阵图-dotplot）"
date: 2024-10-31T07:43:02Z
draft: ["false"]
tags: [
  "fetched",
  "R语言生信医学统计与科研"
]
categories: ["Acdemic"]
---
CNS绘图复现：单细胞数据的marker基因分析（点矩阵图-dotplot） by R语言生信医学统计与科研
------
<div><p>一、引言<br></p><p>在前面几个章节中，我们介绍了单细胞数据分析的各种技术文档，既有单细胞数据分析的常规流程，也有部分的高级分析。现在我们来讨论一下，除了基本的绘图之外，那些比较高级的CNS绘图。</p><p>比如：2022年发表于Nature中的marker基因分析</p><p><img data-galleryid="" data-ratio="0.5264900662251656" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/e4qfpSBibv0APtJjUEoTA9iaacqEAwVFVaBP9hTzSVDZqX0KeSDn54bfqzZ0r1nrqKwE54Jes03BJW8ANIa8CvMA/640?wx_fmt=png" data-type="png" data-w="906" src="https://mmbiz.qpic.cn/mmbiz_png/e4qfpSBibv0APtJjUEoTA9iaacqEAwVFVaBP9hTzSVDZqX0KeSDn54bfqzZ0r1nrqKwE54Jes03BJW8ANIa8CvMA/640?wx_fmt=png"></p><p><img data-galleryid="" data-ratio="0.4232558139534884" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/e4qfpSBibv0APtJjUEoTA9iaacqEAwVFVa0HBBW0oYhaTvmAmPGRYI3BG122OBIqJlgfCB2ImrG38LsalKGibLZfA/640?wx_fmt=png" data-type="png" data-w="645" src="https://mmbiz.qpic.cn/mmbiz_png/e4qfpSBibv0APtJjUEoTA9iaacqEAwVFVa0HBBW0oYhaTvmAmPGRYI3BG122OBIqJlgfCB2ImrG38LsalKGibLZfA/640?wx_fmt=png"></p><p>二、实操</p><p>2.1 安装高级分析的软件</p><section><ul><li><li></ul><pre data-lang="cpp"><code><span><span># install.packages(<span>"devtools"</span>)</span></span></code><code><span>devtools::install_github(<span>"junjunlab/jjAnno"</span>)</span></code></pre></section><p><br></p><p>2.2 加载数据</p><p>本案例主要是基于单细胞数据的marker基因，绘制CNS级别的表达情况。<br></p><section><ul><li><li><li></ul><pre data-lang="ruby"><code><span><span># load data</span></span></code><code><span>dot_data &lt;- read.delim(<span>'marker-genes.txt'</span>,header = T) %&gt;%</span></code><code><span>  arrange(<span><span>class</span>)</span></span></code></pre></section><section><ul><li><li><li><li><li><li><li><li></ul><pre data-lang="ruby"><code><span>&gt; head(dot_data,<span>3</span>)</span></code><code><span>              cell  gene            <span><span>class</span> <span>mean</span>.<span>expression</span> <span>percentage</span></span></span></code><code><span><span>1</span> <span>1</span>b CoelEpi GATA4 DMRT1 Early supporting       <span>0</span>.<span>3749122</span>   <span>36.03614</span></span></code><code><span><span>2</span> <span>1</span>b CoelEpi GATA4  CPA2 Early supporting       <span>0</span>.<span>7495705</span>   <span>95.82235</span></span></code><code><span><span>3</span> <span>1</span>b CoelEpi GATA4 GPR37 Early supporting       <span>0</span>.<span>1604790</span>   <span>95.79420</span></span></code><code><span>&gt; unique(dot_data$cell)</span></code><code><span>[<span>1</span>] <span>"1b CoelEpi GATA4"</span> <span>"2a Early somatic"</span> <span>"2b ESGC male"</span>     <span>"2b ESGC female"</span>   <span>"2c PreGC-I"</span>      </span></code><code><span>[<span>6</span>] <span>"2d Sertoil"</span>       <span>"3a Early sPAX8"</span>   <span>"3b Gi"</span> </span></code></pre></section><section><ul><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><span># add cell group</span></span></code><code><span>dot_data<span>$cellGroup</span> &lt;- case_when(</span></code><code><span>  dot_data<span>$cell</span> %<span>in</span>% c(<span>"1b CoelEpi GATA4"</span>, <span>"2a Early somatic"</span>, <span>"2b ESGC male"</span>) ~ <span>"cell type1"</span>,</span></code><code><span>  dot_data<span>$cell</span> %<span>in</span>% c(<span>"2b ESGC female"</span>, <span>"2c PreGC-I"</span>, <span>"2d Sertoil"</span>)  ~ <span>"cell type2"</span>,</span></code><code><span>  dot_data<span>$cell</span> %<span>in</span>% c(<span>"3a Early sPAX8"</span>, <span>"3b Gi"</span>)  ~ <span>"cell type3"</span></span></code><code><span>)</span></code></pre></section><section><ul><li><li><li><li><li></ul><pre data-lang="css"><code><span>&gt; <span>head</span>(<span>dot_data</span>, 3)</span></code><code><span>              <span>cell</span>  <span>gene</span>            <span>class</span> <span>mean</span><span>.expression</span> <span>percentage</span>  <span>cellGroup</span></span></code><code><span>1 1<span>b</span> <span>CoelEpi</span> <span>GATA4</span> <span>DMRT1</span> <span>Early</span> <span>supporting</span>       0<span>.3749122</span>   36<span>.03614</span> <span>cell</span> <span>type1</span></span></code><code><span>2 1<span>b</span> <span>CoelEpi</span> <span>GATA4</span>  <span>CPA2</span> <span>Early</span> <span>supporting</span>       0<span>.7495705</span>   95<span>.82235</span> <span>cell</span> <span>type1</span></span></code><code><span>3 1<span>b</span> <span>CoelEpi</span> <span>GATA4</span> <span>GPR37</span> <span>Early</span> <span>supporting</span>       0<span>.1604790</span>   95<span>.79420</span> <span>cell</span> <span>type1</span></span></code></pre></section><p><br></p><p>2.3 基础绘图</p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span><span># 将基因按照细胞类型进行排序</span></span></code><code><span>dot_data<span>$gene</span> &lt;- factor(dot_data<span>$gene</span>,levels = unique(dot_data<span>$gene</span>))</span></code><code><span><span># plot</span></span></code><code><span>pdot &lt;-</span></code><code><span>  ggplot(dot_data,aes(x = gene,y = cell)) +</span></code><code><span>  geom_point(aes(fill = mean.expression,size = percentage),</span></code><code><span>             color = <span>'black'</span>,</span></code><code><span>             shape = 21) +</span></code><code><span>  theme_bw(base_size = 14) +</span></code><code><span>  xlab(<span>''</span>) + ylab(<span>''</span>) +</span></code><code><span>  scale_fill_gradient2(low = <span>'white'</span>,mid = <span>'#EB1D36'</span>,high = <span>'#990000'</span>,</span></code><code><span>                       midpoint = 0.5,</span></code><code><span>                       limits = c(0,1),</span></code><code><span>                       breaks = seq(0,1,0.5),</span></code><code><span>                       labels = seq(0,1, 0.5),</span></code><code><span>                       name = <span>'Mean expression'</span>) +</span></code><code><span>  scale_size(range = c(1,6), </span></code><code><span>             limits = c(0, 100),</span></code><code><span>             breaks = seq(20,100,20), </span></code><code><span>             labels = seq(20,100,20)</span></code><code><span>  ) +</span></code><code><span>  theme(panel.grid = element_blank(),</span></code><code><span>        axis.text = element_text(color = <span>'black'</span>),</span></code><code><span>        aspect.ratio = 0.5,</span></code><code><span>        plot.margin = margin(t = 1,r = 1,b = 1,l = 1,unit = <span>'cm'</span>),</span></code><code><span>        axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5,</span></code><code><span>                                   face = <span>'italic'</span>)，</span></code><code><span>                                   axis.text.y = element_text(color = 1:8)</span></code><code><span>  ) +</span></code><code><span>  coord_cartesian(clip = <span>'off'</span>) +</span></code><code><span>  guides(</span></code><code><span>    fill = guide_colorbar(</span></code><code><span>      direction = <span>"horizontal"</span>,</span></code><code><span>      title.position = <span>"top"</span>,</span></code><code><span>      barwidth = unit(5, <span>"cm"</span>)</span></code><code><span>    ),</span></code><code><span>    size = guide_legend(</span></code><code><span>      title = <span>"Percent of cells"</span>,</span></code><code><span>      direction = <span>"horizontal"</span>,</span></code><code><span>      title.position = <span>"top"</span>,</span></code><code><span>      label.position = <span>"bottom"</span>,</span></code><code><span>      override.aes = list(</span></code><code><span>        color = <span>"black"</span>,</span></code><code><span>        fill = <span>"grey"</span></span></code><code><span>      )</span></code><code><span>    )</span></code><code><span>  )</span></code><code><span><br></span></code><code><span>pdot</span></code><code><span><br></span></code></pre></section><p><img data-galleryid="" data-ratio="0.3854818523153942" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/e4qfpSBibv0APtJjUEoTA9iaacqEAwVFVaDxv73fnlWkpOs5rhsnDU8acooe4ReiaDZqVQM11zAtTucvoJPlticK6g/640?wx_fmt=png" data-type="png" data-w="799" src="https://mmbiz.qpic.cn/mmbiz_png/e4qfpSBibv0APtJjUEoTA9iaacqEAwVFVaDxv73fnlWkpOs5rhsnDU8acooe4ReiaDZqVQM11zAtTucvoJPlticK6g/640?wx_fmt=png"></p><p>2.4 个性化设置<br></p><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="properties"><code><span><span># add segment</span></span></code><code><span><span>P1</span> <span>&lt;- annoSegment(object = pdot,</span></span></code><code><span>                  <span>annoPos</span> = <span>'top', # 将注释条，添加到顶部</span></span></code><code><span>                  <span>xPosition</span> = <span>c(1:21), # 注释条的x轴的位置</span></span></code><code><span>                  <span>yPosition</span> = <span>8.8, # 注释条的y轴位置，需要多次个性化调整</span></span></code><code><span>                  <span>segWidth</span> = <span>0.7, # 注释条的宽度，需要多次个性化调整</span></span></code><code><span>                  <span>pCol</span> = <span>c(useMyCol('stallion',20),'orange') # 注释条的颜色</span></span></code><code><span>                  <span>)</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># add rect1</span></span></code><code><span><span>P2</span> <span>&lt;- annoRect(object = P1,</span></span></code><code><span>               <span>annoPos</span> = <span>'left', # 添加方框的位置</span></span></code><code><span>               <span>annoManual</span> = <span>T, # 可以手动设置</span></span></code><code><span><span>               # 设置方框的位置，由于刻度是整数，从下往上依次是1，2，3，4</span></span></code><code><span><span>               # 所以设置方框的位置是0.5，1.5，等，上下包含要框的内容</span></span></code><code><span><span>               # list 表示添加控件的个数，比如下面表示添加 [0.5,4.5]和[4.5,8.5]</span></span></code><code><span>               <span>yPosition</span> = <span>list(c(0.5,4.5),</span></span></code><code><span>                                <span>c(4.5,8.5)),</span> <span></span></span></code><code><span><span>               # 个性化多次调整，多尝试，找一个合适的数据值</span></span></code><code><span>               <span>xPosition</span> = <span>c(-6.5,0.3),</span></span></code><code><span>               <span>pCol</span> = <span>rep('white',2), # 边框颜色</span></span></code><code><span>               <span>pFill</span> = <span>useMyCol('calm',2), # 填充颜色</span></span></code><code><span>               <span>alpha</span> = <span>0.5 # 填充颜色透明度</span></span></code><code><span>               <span>)</span></span></code><code><span><br></span></code><code><span><span># add rect2</span></span></code><code><span><span>P3</span> <span>&lt;- annoRect(object = P2,</span></span></code><code><span>               <span>annoPos</span> = <span>'left',</span></span></code><code><span>               <span>annoManual</span> = <span>T,</span></span></code><code><span>               <span>yPosition</span> = <span>c(2.5,6.5),</span></span></code><code><span>               <span>xPosition</span> = <span>c(-6.5,16.5),</span></span></code><code><span>               <span>pCol</span> = <span>'black',</span></span></code><code><span>               <span>pFill</span> = <span>'transparent',</span></span></code><code><span>               <span>lty</span> = <span>'dashed',</span></span></code><code><span>               <span>lwd</span> = <span>3)</span></span></code><code><span><br></span></code><code><span><br></span></code><code><span><span># add rect4</span></span></code><code><span><span>P4</span> <span>&lt;- annoRect(object = P3,</span></span></code><code><span>               <span>annoPos</span> = <span>'left',</span></span></code><code><span>               <span>annoManual</span> = <span>T,</span></span></code><code><span>               <span>yPosition</span> = <span>c(3.5, 4.5),</span></span></code><code><span>               <span>xPosition</span> = <span>c(6.5,7.5),</span></span></code><code><span>               <span>pCol</span> = <span>'blue',</span></span></code><code><span>               <span>pFill</span> = <span>'transparent',</span></span></code><code><span>               <span>lty</span> = <span>1,</span></span></code><code><span>               <span>lwd</span> = <span>3)</span></span></code><code><span><br></span></code><code><span><span># add branch</span></span></code><code><span><span>P5</span> <span>&lt;- annoSegment(object = P4,</span></span></code><code><span>                  <span>annoPos</span> = <span>'top',</span></span></code><code><span><span>                  # 表示自动映射，这是一种比较友好的方式，</span></span></code><code><span><span>                  # 否则需要人为核查，还容易出现错误</span></span></code><code><span>                  <span>aesGroup</span> = <span>T, </span></span></code><code><span><span>                  # 自动映射的分组信息列</span></span></code><code><span>                  <span>aesGroName</span> = <span>'class',</span></span></code><code><span>                  <span>yPosition</span> = <span>9.2,</span></span></code><code><span>                  <span>segWidth</span> = <span>0.5,</span></span></code><code><span>                  <span>addBranch</span> = <span>T, # 添加树状分支</span></span></code><code><span>                  <span>addText</span> = <span>T,</span></span></code><code><span>                  <span>textRot</span> = <span>45,</span></span></code><code><span><span>                  # 字体颜色，可以更具图片的顺序，调整颜色</span></span></code><code><span>                  <span>textCol</span> = <span>c(rep("black", 3),"blue", rep("black", 7)),</span></span></code><code><span><span>                  # 字体的对其方式</span></span></code><code><span>                  <span>hjust</span> = <span>0,</span></span></code><code><span>                  <span>vjust</span> = <span>0,</span></span></code><code><span><span>                  lwd </span>=<span> 2, # 分支的线型</span></span></code><code><span>                  <span>branDirection</span> = <span>-1, # 分支向下</span></span></code><code><span><span>                  pCol </span>=<span> rep('black',11)) # 分支颜色</span></span></code></pre></section><p><br></p><p><img data-galleryid="" data-ratio="0.48957055214723927" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/e4qfpSBibv0APtJjUEoTA9iaacqEAwVFVa9D9AyeWfw6omL9tdibicvdD0JWUUR2Iqpc2cqTAbbaPpnhqdUJwHpq3A/640?wx_fmt=png" data-type="png" data-w="815" src="https://mmbiz.qpic.cn/mmbiz_png/e4qfpSBibv0APtJjUEoTA9iaacqEAwVFVa9D9AyeWfw6omL9tdibicvdD0JWUUR2Iqpc2cqTAbbaPpnhqdUJwHpq3A/640?wx_fmt=png"></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/iYesDF_ZkNkqUIKBJanLSA",target="_blank" rel="noopener noreferrer">原文链接</a>
