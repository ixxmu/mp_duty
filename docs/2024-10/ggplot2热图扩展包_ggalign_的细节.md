---
title: "ggplot2热图扩展包（ggalign）的细节"
date: 2024-10-16T02:08:21Z
draft: ["false"]
tags: [
  "fetched",
  "生信技能树"
]
categories: ["Acdemic"]
---
ggplot2热图扩展包（ggalign）的细节 by 生信技能树
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><blockquote data-tool="mdnice编辑器"><span></span><p>前面我们在<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247534097&amp;idx=1&amp;sn=dc70a25c4bf9d00eebfe570a9d93106b&amp;chksm=9b4b06aaac3c8fbcebfb5a3ef940533ae5d7f02e82dd2edb99244e715b9a843b59758192670b&amp;scene=21#wechat_redirect" textvalue="人工智能大模型不会告诉你的热图绘制技巧" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">人工智能大模型不会告诉你的热图绘制技巧</a> 演示了如何使用ggplot2热图扩展包（ggalign），可以快速替代之前的 pheatmap：</p></blockquote></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器"><strong>比如我们可以先去geo数据库里面下载 GSE104171_NormalizedMatrix.txt.gz 这个文件，</strong>然后提取里面的指定的基因的表达量矩阵：</p></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code>rm(list = ls())<span>#清空当前的工作环境</span><br>options(stringsAsFactors = F)<span>#不以因子变量读取</span><br>options(scipen = 20)<span>#不以科学计数法显示</span><br>library(data.table)<br>library(tinyarray) <br>data&lt;-data.table::fread(<span>"GSE104171_NormalizedMatrix.txt.gz"</span>,<br>                        data.table = F) <br>data=data[!duplicated(data<span>$V1</span>),]<br>mat&lt;-data[,c( 2:ncol(data))]<br>rownames(mat)=data[,1]<br>mat[1:4,1:4]<br>keep_feature &lt;- rowSums (mat &gt; 1) &gt; 1 ;table(keep_feature)<br>ensembl_matrix &lt;- mat[keep_feature, ]  <br>rownames(ensembl_matrix)=rownames(mat)[keep_feature]<br>ensembl_matrix[1:4,1:4] <br>symbol_matrix=ensembl_matrix<br>symbol_matrix[1:4,1:4] <br>colnames(symbol_matrix)<br><br>library(AnnoProbe)<br>head(rownames(symbol_matrix))<br>ids=annoGene(rownames(symbol_matrix),<span>'SYMBOL'</span>,<span>'human'</span>)<br>head(ids)<br>tail(sort(table(ids<span>$biotypes</span>)))<br>ids=ids[ids<span>$biotypes</span>==<span>'protein_coding'</span>,]<br>symbol_matrix=symbol_matrix[rownames(symbol_matrix) %<span>in</span>% ids<span>$SYMBOL</span>,]<br>colnames(symbol_matrix) <br>boxplot(symbol_matrix[,1:4])<br>cor_gene&lt;-c(<span>'CD2'</span>,<span>'CD3E'</span>,<span>'CD3D'</span>,<span>'TBX21'</span>,<span>'CD8B'</span>,<span>'PRF1'</span>,<br>            <span>'GZMA'</span>,<span>'GZMB'</span>,<span>'ITGAM'</span>,<span>'ARG1'</span>,<span>'CYBB'</span>,<span>'OLR1'</span>,<br>            <span>'FUT4'</span>,<span>'CEACAM8'</span>,<span>'S100A8'</span>,<span>'S100A9'</span>)<br>exprSet=symbol_matrix[cor_gene,]<br></code></pre></section><p>可以看到，是16个基因在74个样品的表达量矩阵：</p><p><img data-galleryid="" data-imgfileid="100050674" data-ratio="0.8277777777777777" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxYf5r7SZ4E48OVbkTUQzyFZxWibj8WZ3uyAibm69f3yrCBCBLYxhCz1ItZVe11yl5j21KZic7ZqHGzg/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxYf5r7SZ4E48OVbkTUQzyFZxWibj8WZ3uyAibm69f3yrCBCBLYxhCz1ItZVe11yl5j21KZic7ZqHGzg/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>我们首先呢，使用pheatmap绘图 ：</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code><br>p1=pheatmap::pheatmap(cor(t(exprSet)))<br>matrix_chosen&lt;-t(scale(t(exprSet)))<br>tmp&lt;-colnames(matrix_chosen)<br>tmp&lt;-rep(<span>''</span>,ncol(matrix_chosen))<br>p2=pheatmap::pheatmap(matrix_chosen,labels_col=tmp,<br>                   legend_breaks=seq(-3,3,1))<br>hc=cutree(p2<span>$tree_col</span>,2)<br><span># MN-MDSC signature genes (ITGAM, ARG1, CYBB, OLR1, FUT4, CEACAM8, S100A8, and S100A9) </span><br><span># cytotoxic lymphocyte signature genes (CD2, CD3E, CD3D, TBX21, CD8B, PRF1, GZMA, and GZMB) </span><br>ac=as.data.frame(as.character(hc))<br>rownames(ac)=colnames(matrix_chosen)<br>p3=pheatmap::pheatmap(matrix_chosen,labels_col=tmp,<br>                   annotation_col = ac,<br>                   legend_breaks=seq(-3,3,1))<br>library(cowplot)<br>require(ggplotify)<br>cowplot::plot_grid(as.ggplot(p1) , as.ggplot(p3), ncol=2)<br></code></pre></section><p>可以看到，比较麻烦的把样品分成了两组：</p><p><img data-galleryid="" data-imgfileid="100050671" data-ratio="0.3925925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxYf5r7SZ4E48OVbkTUQzyFJouyuwA8w4SDZdbARicia0BDZd4BxmsDZ4T2ldDGeyOOWbI0UC5Q2t7g/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxYf5r7SZ4E48OVbkTUQzyFJouyuwA8w4SDZdbARicia0BDZd4BxmsDZ4T2ldDGeyOOWbI0UC5Q2t7g/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p>如果是ggalign就一句话 ：</p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><pre data-tool="mdnice编辑器"><span></span><code><br>library(ggalign)<br>ggheatmap(matrix_chosen) +<br>  scale_fill_viridis_c() +<br>  hmanno(<span>"t"</span>) +<br>  align_dendro(aes(color = branch), k = 2) +<br>  geom_point(aes(color = branch, y = y)) +<br>  scale_color_brewer(palette = <span>"Dark2"</span>)<br><br></code></pre></section><p>同样的可以把样品分成两组:</p><p><img data-galleryid="" data-imgfileid="100050675" data-ratio="0.600925925925926" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxYf5r7SZ4E48OVbkTUQzyFILoy1lod9PiaeqaFAP9Lm7iaPgFTBSKlS7lNZwOKRAGGrSvP9WicBf2ng/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxYf5r7SZ4E48OVbkTUQzyFILoy1lod9PiaeqaFAP9Lm7iaPgFTBSKlS7lNZwOKRAGGrSvP9WicBf2ng/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h3 data-tool="mdnice编辑器"></h3></section><p data-tool="mdnice编辑器"><code>ggalign</code>通过对齐多个<code>ggplot2</code>图表的观测来组织图表布局。它使你能够使用熟悉的 ggplot2 语法创建复杂热图。</p><h2 data-tool="mdnice编辑器"><span>安装</span></h2><p data-tool="mdnice编辑器">你可以使用以下命令从 <code>CRAN</code> 安装 <code>ggalign</code>：</p><pre data-tool="mdnice编辑器"><span></span><code>install.packages("ggalign")<br></code></pre><p data-tool="mdnice编辑器">或者，从 GitHub 安装开发版本（目前开发版本添加了大量新功能，因为CRAN通常需要1-2个月的更新间隔，暂不能推送到CRAN）：</p><pre data-tool="mdnice编辑器"><span></span><code># install.packages("remotes")<br>remotes::install_github("Yunuuuu/ggalign")<br></code></pre><h2 data-tool="mdnice编辑器"><span>基本流程</span></h2><p data-tool="mdnice编辑器">如果你熟悉 <code>ggplot2</code> 语法，<code>ggalign</code> 的使用很简单，典型的工作流程如下：</p><ul data-tool="mdnice编辑器"><li><section>使用 <code>ggheatmap()</code> 或 <code>ggstack()</code> 初始化布局。</section></li><li><section>使用以下自定义布局：</section></li><ul><li><section><code>align_group()</code>：将布局轴分组到具有组变量的面板中。</section></li><li><section><code>align_kmeans()</code>：通过 kmeans 将布局轴分组到面板中。</section></li><li><section><code>align_order()</code>：根据统计权重重新排序布局观察结果，或手动指定观察索引。</section></li><li><section><code>align_dendro()</code>：根据层次聚类重新排序或分组布局。</section></li></ul><li><section>使用 <code>ggalign()</code> 或 <code>ggpanel()</code> 添加图表，然后叠加额外的 ggplot2 元素，如 geoms、stats 或 scales。</section></li></ul><h2 data-tool="mdnice编辑器"><span>基本示例</span></h2><p data-tool="mdnice编辑器">下面，我们将通过一个基本示例，展示如何使用 <code>ggalign</code> 创建带有 <code>dendrogram</code> 的热图。</p><pre data-tool="mdnice编辑器"><span></span><code>library(ggalign)<br>set.seed(123)<br>small_mat &lt;- matrix(rnorm(81), nrow = 9)<br>rownames(small_mat) &lt;- paste0("row", seq_len(nrow(small_mat)))<br>colnames(small_mat) &lt;- paste0("column", seq_len(ncol(small_mat)))<br><br># 初始化热图布局，我们可以将其视为一个普通的 ggplot 对象<br>ggheatmap(small_mat) + <br>    # 我们可以直接修改 geoms、scales 和其他 ggplot2 组件<br>    scale_fill_viridis_c() +<br>    # 在顶部添加注释<br>    hmanno("top") +<br>    # 在顶部注释中，我们添加了一个树状图，并将观察结果分成 3 组<br>    align_dendro(aes(color = branch), k = 3) +<br>    # 在树状图中添加点 geom<br>    geom_point(aes(color = branch, y = y)) +<br>    # 更改树状图的颜色映射<br>    scale_color_brewer(palette = "Dark2")<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050680" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX6JdgaDoW70xeFTmuOxbNpwILFBIJgpjImUefDhCK5GhW6xU8hpBWibA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX6JdgaDoW70xeFTmuOxbNpwILFBIJgpjImUefDhCK5GhW6xU8hpBWibA/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span>与其他 ggplot2 热图扩展比较</span></h2><p data-tool="mdnice编辑器"><code>ggalign</code> 相对于其他扩展如 ggheatmap 的主要优势在于其与 ggplot2 语法的完全兼容性。你可以无缝使用任何 ggplot2 geoms、stats 和 scales 来构建复杂布局，包括垂直或水平排列的多个热图。</p><h2 data-tool="mdnice编辑器"><span>与 ComplexHeatmap 比较</span></h2><h3 data-tool="mdnice编辑器"><span>优点</span></h3><ul data-tool="mdnice编辑器"><li><section>与 <code>ggplot2</code> 生态系统完全集成。</section></li><li><section>热图注释轴和图例自动生成。</section></li><li><section>树状图可以轻松自定义和着色。</section></li><li><section>对图表大小和间距有灵活的控制。</section></li><li><section>可以通过面板区域轻松与其他 <code>ggplot2</code> 图表对齐。</section></li><li><section>可以轻松扩展用于其他聚类算法或注释图表。</section></li></ul><h3 data-tool="mdnice编辑器"><span>缺点</span></h3><p data-tool="mdnice编辑器">内置注释较少：与 ComplexHeatmap 中广泛的内置注释函数相比，可能需要额外编写更多代码以实现特定图形。</p><h2 data-tool="mdnice编辑器"><span>更复杂的示例</span></h2><p data-tool="mdnice编辑器">以下是使用 <code>ggalign</code> 进行的一些更高级的可视化示例：<img data-imgfileid="100050681" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXppuWhmS05RUaETHc3g1rzgzicRXArMERC9qTXEB6qgjveyG7bVSkCqg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2304" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXppuWhmS05RUaETHc3g1rzgzicRXArMERC9qTXEB6qgjveyG7bVSkCqg/640?wx_fmt=png&amp;from=appmsg"><img data-imgfileid="100050682" data-ratio="0.8335" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXNOUZ1KCnajibqpvXQ3bOKbFJhNvy7386kfPRXicRbPXB3w5LX4gAT3Qg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXNOUZ1KCnajibqpvXQ3bOKbFJhNvy7386kfPRXicRbPXB3w5LX4gAT3Qg/640?wx_fmt=png&amp;from=appmsg"></p><h1 data-tool="mdnice编辑器"><span>热图-布局控制</span></h1><p data-tool="mdnice编辑器"><code>heatmap_layout()</code>/<code>ggheatmap</code>函数用来初始化热图布局</p><h1 data-tool="mdnice编辑器"><span>输入数据</span></h1><p data-tool="mdnice编辑器">数据输入可以是数值或字符向量、数据框，以及任何可以转换为矩阵的数据。</p><pre data-tool="mdnice编辑器"><span></span><code>set.seed(123)<br>small_mat &lt;- matrix(rnorm(81), nrow = 9)<br>rownames(small_mat) &lt;- paste0(<span>"row"</span>, seq_len(nrow(small_mat)))<br>colnames(small_mat) &lt;- paste0(<span>"column"</span>, seq_len(ncol(small_mat)))<br></code></pre><pre data-tool="mdnice编辑器"><span></span><code>library(ggalign)<br>ggheatmap(small_mat)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050687" data-ratio="0.7145" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX4BJ6H6gzSRN3xuEMJLgMDw9FIuz4pon9SyAB47dq3bDcrmTZb8iaVxw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX4BJ6H6gzSRN3xuEMJLgMDw9FIuz4pon9SyAB47dq3bDcrmTZb8iaVxw/640?wx_fmt=png&amp;from=appmsg"></figure><h1 data-tool="mdnice编辑器"><span>热图</span></h1><p data-tool="mdnice编辑器">对于 <code>ggplot2</code>，矩阵在绘制时会被转换为长格式的数据框。默认的映射将使用 <code>aes(.data$.x, .data$.y)</code>，但可以通过 <code>mapping</code> 参数进行控制。<code>ggplot2</code> 对象的数据包含以下列：</p><ul data-tool="mdnice编辑器"><li><section><code>.xpanel</code> 和 <code>.ypanel</code>: 列和行的panel groups</section></li><li><section><code>.x</code> 和 <code>.y</code>: x 和 y 坐标</section></li><li><section><code>.row_names</code> 和 <code>.column_names</code>: 原始矩阵的行和列名（仅在名称存在时出现）</section></li><li><section><code>.row_index</code> 和 <code>.column_index</code>: 原始矩阵的行和列索引。</section></li><li><section><code>value</code>: 实际的矩阵值。</section></li></ul><p data-tool="mdnice编辑器">我们可以像处理普通的 ggplot2 对象一样处理 <code>ggheatmap()</code> 对象，例如添加 ggplot2 geoms, stats, scales以及theme。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) + geom_point() + scale_fill_viridis_c()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050685" data-ratio="0.7145" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXE4Viaiab6icO55UgwsbLa1HiaialtkWerFsL5uRw0Bp5zjZ1Jp3XnlicSibaQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXE4Viaiab6icO55UgwsbLa1HiaialtkWerFsL5uRw0Bp5zjZ1Jp3XnlicSibaQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">默认情况下，我们会添加热图层。如果设置 <code>filling = FALSE</code>，则会绘制一个空白的热图。你可以自定义热图图层，对于大数据集，你可以将图层像素化从而提高渲染速度，这里我们使用<code>ggrastr</code>来像素化图层。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat, filling = FALSE) +<br>  ggrastr::rasterize(geom_tile(aes(fill = value)))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050683" data-ratio="0.7145" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX2tltibCh3Qk1dt8oMBCcIxAFYN8XcXRVu7mRnsQKpTxpHCwQVY2nP7Q/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX2tltibCh3Qk1dt8oMBCcIxAFYN8XcXRVu7mRnsQKpTxpHCwQVY2nP7Q/640?wx_fmt=png&amp;from=appmsg"></figure><h1 data-tool="mdnice编辑器"><span>热图注释</span></h1><p data-tool="mdnice编辑器">热图注释可为热图的行或列提供额外信息，可以放置在热图四周。<code>ggheatmap()</code>使用<code>活动上下文</code>来控制注释信息的位置。默认情况下，<code>ggheatmap()</code>不会初始化<code>活动上下文</code>，因此所有添加的内容(包括ggplot2元件)都将直接添加进热图主体。您可以使用 <code>hmanno()</code> 来设置<code>活动上下文</code>。</p><p data-tool="mdnice编辑器">除了<code>ggplot2元件</code>外，我们还可以在注释中添加任何<code>align_*()</code>函数，<code>align_*()</code>函数可以添加图表，也可以自定义布局，例如排序，聚类，分组等。目前，有四个 <code>align_*</code> 函数可用于图表布局控制：</p><ul data-tool="mdnice编辑器"><li><section><code>align_group</code>：根据分类因子对图表进行分组和对齐。</section></li><li><section><code>align_order</code>：根据统计权重重新排序布局观察值，或允许根据用户定义的标准手动重新排序。</section></li><li><section><code>align_kmeans</code>：根据 k-means 聚类结果排列图表。</section></li><li><section><code>align_dendro</code>：根据层次聚类或树状图对图表进行对齐。</section></li></ul><h2 data-tool="mdnice编辑器"><span><code>align_group</code></span></h2><p data-tool="mdnice编辑器"><code>align_group()</code> 函数将行/列进行分组。它不会添加任何绘图区域。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_group(sample(letters[1:4], ncol(small_mat), replace = TRUE))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050684" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXheO6IvP272xDba18tIIH1icIlmQYqjRvj9bECJW2TsT86cbicck94Mcw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXheO6IvP272xDba18tIIH1icIlmQYqjRvj9bECJW2TsT86cbicck94Mcw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">默认情况下，ggplot2面板标题会被移除。您可以使用 <code>theme(strip.text = element_text())</code> 来选择在那个绘图区域添加facet标题。由于 <code>align_group()</code> 不创建新图表，因此面板标题只能添加到热图中。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    theme(strip.text = element_text()) +<br>    hmanno("l") +<br>    align_group(sample(letters[1:4], nrow(small_mat), replace = TRUE))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050686" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXnhDoRQsuWEJaG1azrgICXia0Lm6y4ToBr16sg4yrZnBK10lWB6SVkgA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXnhDoRQsuWEJaG1azrgICXia0Lm6y4ToBr16sg4yrZnBK10lWB6SVkgA/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span><code>align_order</code></span></h2><p data-tool="mdnice编辑器"><code>align_order()</code> 函数可对行/列进行排序。像 <code>align_group()</code> 一样，它不会增加绘图区域。</p><p data-tool="mdnice编辑器">在这里，我们根据均值重新排序行。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("l") +<br>    align_order(rowMeans)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050692" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXoNKEYJgWxN1VAvOytLcII6VgdBLv038lzH526HvP0m1z21mAqLBjWg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXoNKEYJgWxN1VAvOytLcII6VgdBLv038lzH526HvP0m1z21mAqLBjWg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">此外，我们可以直接提供排序的索引(数值/字符)。</p><pre data-tool="mdnice编辑器"><span></span><code>my_order &lt;- sample(nrow(small_mat))<br>print(rownames(small_mat)[my_order])<br>#&gt; [1] "row3" "row1" "row7" "row6" "row2" "row8" "row9" "row5" "row4"<br>ggheatmap(small_mat) +<br>    hmanno("l") +<br>    align_order(my_order)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050688" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXNSfSkEqJVsicXwTWfUibE9MTYDfbriazm9wuPU7RUe8go8PEyvibEliabibA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXNSfSkEqJVsicXwTWfUibE9MTYDfbriazm9wuPU7RUe8go8PEyvibEliabibA/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("l") +<br>    align_order(rownames(small_mat)[my_order])<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050691" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXNSfSkEqJVsicXwTWfUibE9MTYDfbriazm9wuPU7RUe8go8PEyvibEliabibA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXNSfSkEqJVsicXwTWfUibE9MTYDfbriazm9wuPU7RUe8go8PEyvibEliabibA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">默认情况下，<code>align_order()</code> 会根据函数的输出结果（对于行，从底部到顶部；对于列，从左到右）按升序重新排序行或列。可以通过 <code>reverse = TRUE</code>反转顺序：</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("l") +<br>    align_order(rowMeans, reverse = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050689" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXPtQNbqbsPAVias3X1ECSOYJywL2gw4kCMpBy9ic7GKewicAicTY2sMSjEQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXPtQNbqbsPAVias3X1ECSOYJywL2gw4kCMpBy9ic7GKewicAicTY2sMSjEQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">一些 <code>align_*</code> 函数接受 <code>data</code> 参数。如果 <code>data</code> 参数为 <code>NULL</code>，函数将使用布局的默认数据，如前例所示。<code>data</code> 参数还可以接受一个函数（支持 lambda 语法），该函数将应用于布局数据。</p><p data-tool="mdnice编辑器">需要注意的是，所有 <code>align_*</code> 函数都将行视为观测。这意味着 <code>NROW(data)</code> 必须与特定的 <code>layout</code> 轴返回相同的观测数。</p><p data-tool="mdnice编辑器"><code>heatmap_layout()</code>/<code>ggheatmap()</code>：对于列注释，<code>layout</code> 数据将在使用转置<code>t</code>（如果数据是 <code>function</code>，它将应用于转置后的矩阵）。因为列注释使用热图列作为观察值，但我们需要行。</p><p data-tool="mdnice编辑器">因此，即使是顶部和底部注释，我们也可以使用 <code>rowMeans()</code> 计算所有列的平均值。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_order(rowMeans)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050690" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXkEY5sX44U8AsBQPoqXIkP4zCEbhxicugf2mGcrod14oy47vAINN3B1g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXkEY5sX44U8AsBQPoqXIkP4zCEbhxicugf2mGcrod14oy47vAINN3B1g/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span><code>align_kmeans</code></span></h2><p data-tool="mdnice编辑器"><code>align_kmeans()</code> 函数根据 k-means 聚类对热图行或列分组，它也不会增加绘图区域。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_kmeans(3L)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050693" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXpKK41oibicxFKjjemIxRGtfQjaibrPBhYT3ibTLZ5bf6tE94HOM4pR7yzg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXpKK41oibicxFKjjemIxRGtfQjaibrPBhYT3ibTLZ5bf6tE94HOM4pR7yzg/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span><code>align_dendro</code></span></h2><p data-tool="mdnice编辑器"><code>align_dendro()</code> 函数可以根据层次聚类重新排序或分割布局，同时它也可添加树状图。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_dendro()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050694" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXHxbWjl6ib3F9vBbPNthyXr8rsdXeskW6ShM88JrIfZR2loQNgf9HX4g/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXHxbWjl6ib3F9vBbPNthyXr8rsdXeskW6ShM88JrIfZR2loQNgf9HX4g/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">树状图也可以用来将列/行切割成组。您可以指定 <code>k</code> 或 <code>h</code>，其工作原理等同于于 <code>cutree()</code>：</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_dendro(k = 3L)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050697" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXeoX91dYg2qTI6rGHEy7FXQ9dxiaypMLtjHDMHleMjwibTO6SVicMXOGDA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXeoX91dYg2qTI6rGHEy7FXQ9dxiaypMLtjHDMHleMjwibTO6SVicMXOGDA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">与 <code>align_group()</code>、<code>align_kmeans()</code> 和 <code>align_order()</code> 不同，<code>align_dendro()</code> 可添加绘制图区域，我们可对其添加其他图层。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_dendro() +<br>    geom_point(aes(y = y))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050696" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXYTenVWyKFQW7YRPBUKF4klw2MmY2JC1bOl65BP3iaREbchCU1xEOCicg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXYTenVWyKFQW7YRPBUKF4klw2MmY2JC1bOl65BP3iaREbchCU1xEOCicg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><code>align_dendro()</code> 函数为 ggplot 创建了默认的 <code>node</code> 数据。有关详细信息，请参见 <code>?align_dendro</code> 中的 <code>ggplot2 specification</code>。此外，<code>edge</code> 数据直接添加到 <code>ggplote::geom_segment()</code>图层中，用于绘制树状图。<code>node</code> 和 <code>edge</code> 数据中的有一个<code>branch</code> 列，对应于 <code>cutree</code> 结果：</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_dendro(aes(color = branch), k = 3) +<br>    geom_point(aes(color = branch, y = y))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050695" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXGG5AMZTSGTg0AUUscSjibiag8F5GPXQU24g6hRVLxiaMUtEHrL0ucShRw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXGG5AMZTSGTg0AUUscSjibiag8F5GPXQU24g6hRVLxiaMUtEHrL0ucShRw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">通过设置<code>reorder_dendrogram</code>参数<code>align_dendro()</code>可以根据观测均值对聚类树进行重排，</p><pre data-tool="mdnice编辑器"><span></span><code>h1 &lt;- ggheatmap(small_mat) +<br>    hmanno(<span>"t"</span>) +<br>    align_dendro(aes(color = branch), k = <span>3</span>, reorder_dendrogram = <span>TRUE</span>) +<br>    ggtitle(<span>"reorder_dendrogram = TRUE"</span>)<br>h2 &lt;- ggheatmap(small_mat) +<br>    hmanno(<span>"t"</span>) +<br>    align_dendro(aes(color = branch), k = <span>3</span>) +<br>    ggtitle(<span>"reorder_dendrogram = FALSE"</span>)<br>align_plots(h1, h2)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050699" data-ratio="0.4505" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX6c4ytE7jWhqF97ORUcyicJ4SqkGxImcAnD8XuxrU9PA3EFaYppeqOmA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX6c4ytE7jWhqF97ORUcyicJ4SqkGxImcAnD8XuxrU9PA3EFaYppeqOmA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><code>align_dendro()</code> 函数还可以在组内进行聚类，这意味着即使在布局中存在现有的组，也可以使用它：</p><pre data-tool="mdnice编辑器"><span></span><code>column_groups &lt;- sample(letters[1:3], ncol(small_mat), replace = TRUE)<br>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_group(column_groups) +<br>    align_dendro(aes(color = branch))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050702" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXA1PpwEkWFsBYNKUaCDpgCQZN7wcQ538rkLj6ToibSibUZfo1JU2O3CuA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXA1PpwEkWFsBYNKUaCDpgCQZN7wcQ538rkLj6ToibSibUZfo1JU2O3CuA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">您可以通过设置 <code>reorder_group = TRUE</code> 对组进行重新排序。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_group(column_groups) +<br>    align_dendro(aes(color = branch), reorder_group = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050700" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXA1PpwEkWFsBYNKUaCDpgCQZN7wcQ538rkLj6ToibSibUZfo1JU2O3CuA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXA1PpwEkWFsBYNKUaCDpgCQZN7wcQ538rkLj6ToibSibUZfo1JU2O3CuA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">您可以通过设置 <code>merge_dendrogram = TRUE</code> 合并每个组中的子树。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_group(column_groups) +<br>    align_dendro(aes(color = branch), merge_dendrogram = TRUE)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050701" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX83GibHicEX7UKrNywY1JFtZMUl5dnhpTG46M5ibmB2N3lyV6QlibKcLAZw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKX83GibHicEX7UKrNywY1JFtZMUl5dnhpTG46M5ibmB2N3lyV6QlibKcLAZw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">您可以同时排序以及合并树状图。</p><pre data-tool="mdnice编辑器"><span></span><code>ggheatmap(small_mat) +<br>    hmanno("t") +<br>    align_group(column_groups) +<br>    align_dendro(aes(color = branch),<br>        reorder_group = TRUE,<br>        merge_dendrogram = TRUE<br>    ) +<br>    hmanno("b") +<br>    align_dendro(aes(color = branch),<br>        reorder_group = FALSE,<br>        merge_dendrogram = TRUE<br>    )<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100050698" data-ratio="0.618" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXMUdZKwBFY93ibtxqz7tto4Uc3CHI1072SqkgynNw1ZeWlWb9jUUYkGw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="2000" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wwPpMMphQicgSliarZMQKiagKXMUdZKwBFY93ibtxqz7tto4Uc3CHI1072SqkgynNw1ZeWlWb9jUUYkGw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"> 感兴趣更多细节的小伙伴务必去看看：https://yunuuuu.github.io/ggalign/ </p><p><img data-galleryid="" data-imgfileid="100050726" data-ratio="0.687037037037037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxYf5r7SZ4E48OVbkTUQzyFZfyM8tePYdZJyea5IIXMqqE3tCTQgrrbzvZmnyTF3jdUNicPic0t5YDA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/cZNhZQ6j4wxYf5r7SZ4E48OVbkTUQzyFZfyM8tePYdZJyea5IIXMqqE3tCTQgrrbzvZmnyTF3jdUNicPic0t5YDA/640?wx_fmt=other&amp;from=appmsg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/mhkN-n9rnKIXHgPjc4XIFg",target="_blank" rel="noopener noreferrer">原文链接</a>
