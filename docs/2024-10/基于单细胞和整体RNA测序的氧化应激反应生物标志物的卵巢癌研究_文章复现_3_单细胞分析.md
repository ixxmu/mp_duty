---
title: "基于单细胞和整体RNA测序的氧化应激反应生物标志物的卵巢癌研究（文章复现）3.单细胞分析"
date: 2024-10-29T16:17:47Z
draft: ["false"]
tags: [
  "fetched",
  "R 学习践行者"
]
categories: ["Acdemic"]
---
基于单细胞和整体RNA测序的氧化应激反应生物标志物的卵巢癌研究（文章复现）3.单细胞分析 by R 学习践行者
------
<div><pre><code><span>单细胞RNA测序数据集GSE146026的表达矩阵和元数据信息文件从（https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE146026）数据库中获得。下载好数据放置在工作目录上。</span></code></pre><p><img data-imgfileid="100002575" data-ratio="0.9181614349775785" data-type="png" data-w="892" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNz0I1SdDsabATliaqxmzjP46qjtyB55d2qJZ19oiazjdibgp3iak4zwZhUfA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNz0I1SdDsabATliaqxmzjP46qjtyB55d2qJZ19oiazjdibgp3iak4zwZhUfA/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><span>单细胞测序数据分析流程：</span></p><p><img data-imgfileid="100002574" data-ratio="0.5470249520153551" data-type="png" data-w="1042" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzumY3lQAtfETkglyfhS502XUToh0qgiasL3bdyfkp5OlcSlHRSA4yibZA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzumY3lQAtfETkglyfhS502XUToh0qgiasL3bdyfkp5OlcSlHRSA4yibZA/640?wx_fmt=png&amp;from=appmsg"></p><p><span>      使用“Seurat” R 包对单细胞测序数据进行了分析。</span><span>分析主要包括以下步骤：</span><span>构建对象、数据标准化、数据降维聚类和识别标记基因。</span><span>使用CreateSeuratObject构建Seurat对象。</span><span>将最小细胞数设为3，最小特征数设为200，并首次对基因和细胞进行过滤。</span><span>以下阈值用于再次过滤细胞：</span><span>特征数为（200，6000），计数数为（300，40000），过表达double_cutoff值为0.15，线粒体基因比例&lt; 30%，红细胞读取比例&lt; 20%。</span><span>选择前2000个高变基因作为主成分分析（PCA）的输入。</span><span>通过ElbowPlot函数确定前15个主成分（PCs）为后续分析的重要主成分。</span></p><p><span>       由于单细胞测序数据来自多个数据集，因此使用“harmony” R 包进行批次校正，以消除干扰下游分析的批次效应。</span><span>调试后并参考原始贡献中的聚类结果，使用FindClusters算法以分辨率0.5识别肿瘤细胞子集。</span></p><p><span>      统一流形近似与投影（UMAP）是一种基于黎曼几何生成数据理论框架的降维流行学习技术。</span><span>UMAP在处理高通量和高维数据（如单细胞测序）时保留了更多的全局结构，性能优越，扩展性更好。</span><span>使用UMAP对PCA获得的数据进一步降维。</span><span>使用DimPlot函数将细胞类型划分为低维空间并进行可视化。</span><span>使用FeaturePlot、DotPlot、DoHeatmap和VlnPlot函数可视化肿瘤细胞的表达、分布景观和特征基因。</span><span>使用DotPlot函数可视化每个细胞亚群中与特定氧化应激反应相关的标记基因。</span><span>选择|avg_log2FC| &gt; 3的簇标记基因和氧化应激反应因子的交集基因中的顶级基因进行映射显示。</span></p><p><span><br></span></p><p><span>1.创建Seurat对象</span></p><pre><code><span>library</span>(tidyverse)<br>a0 = data.table::fread(<span>"GSE146026_Izar_HGSOC_ascites_10x_log.tsv.gz"</span>,<br>                      data.table = <span>F</span>) <span>#读取数据</span><br><br>a = column_to_rownames(a0,var = <span>"Cell_ID"</span>) <span>#列变成行名</span><br>a[<span>1</span>:<span>10</span>,<span>1</span>:<span>2</span>]</code></pre><pre><code>##                                    10x_1                        10x_2<br>## 10x_barcode 10x_3288_t1_AAACATACCTTCCG-1 10x_3288_t1_AAACATACTCCTAT-1<br>## patient                                5                            5<br>## time                                   1                            1<br>## sample_ID                         3288.1                       3288.1<br>## clst                                   1                            1<br>## TSNE_x                      4.533631e+01                 3.507609e+01<br>## TSNE_y                      4.693348e+01                -2.010105e+01<br>## AL627309.1                      0.000000                     0.000000<br>## LINC00115                       0.000000                     0.000000<br>## SAMD11                         0.0000000                    0.0000000</code></pre><p>前7行是基本信息，不是表达数据，所以需要整理一下。</p><pre><code>exp0=a[-(<span>1</span>:<span>7</span>),]<br>exp0 = apply(exp0,<span>2</span>,as.numeric)<br>rownames(exp0) = rownames(a)[-(<span>1</span>:<span>7</span>)] <br>exp0[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>##            10x_1 10x_2 10x_3    10x_4<br>## AL627309.1     0     0     0 0.000000<br>## LINC00115      0     0     0 0.000000<br>## SAMD11         0     0     0 0.000000<br>## NOC2L          0     0     0 3.598553</code></pre><pre><code><span>#获取元数据的信息，比如细胞类型或样本来源</span><br>meta = as.data.frame(t(a[<span>1</span>:<span>7</span>,]))</code></pre><pre><code><span>library</span>(Seurat)<br>sce.all &lt;- CreateSeuratObject(<br>  counts = exp0,  <span>#创建Seurat对象</span><br>  project = <span>"ROS"</span>, <br>  meta.data = meta,<br>  min.cells = <span>3</span>,  <span>#至少有3个细胞表达某个基因，才能保留这个基因</span><br>  min.features = <span>200</span>) <span>#每个细胞至少表达200个基因，才能保留这个细胞</span><br><br><span>#从Seurat对象中提取RNA计数矩阵</span><br>exp = sce.all[[<span>"RNA"</span>]]@layers$counts<br>dim(exp)</code></pre><pre><code>## [1] 11548  9609</code></pre><pre><code>exp[<span>1</span>:<span>4</span>,<span>1</span>:<span>4</span>]</code></pre><pre><code>## 4 x 4 sparse Matrix of class "dgCMatrix"<br>##                    <br>## [1,] . . . .       <br>## [2,] . . . .       <br>## [3,] . . . .       <br>## [4,] . . . 3.598553</code></pre><pre><code>sce.all@meta.data[<span>1</span>,] <span>#元数据的信息</span></code></pre><pre><code>##       orig.ident nCount_RNA nFeature_RNA                  10x_barcode patient<br>## 10x_1        10x   4677.995          839 10x_3288_t1_AAACATACCTTCCG-1       5<br>##       time sample_ID clst       TSNE_x       TSNE_y<br>## 10x_1    1    3288.1    1 4.533631e+01 4.693348e+01</code></pre><pre><code><span>#将患者信息赋给orig.ident</span><br>sce.all$orig.ident = sce.all$patient<br>table(sce.all$orig.ident) <span>#查看每个患者的细胞数量分布</span></code></pre><pre><code>## <br>##    1    2    3    4    5    6 <br>##  354  573  821  671 5998 1192</code></pre><p><span></span><span>2.</span><span>质控</span></p><pre><code>sce.all[[<span>"percent.mt"</span>]] &lt;- PercentageFeatureSet(sce.all, <br>                                                pattern = <span>"^MT-"</span>) <span>#计算线粒体基因的百分比</span><br>sce.all[[<span>"percent.rp"</span>]] &lt;- PercentageFeatureSet(sce.all, <br>                                                pattern = <span>"^RP[SL]"</span>) <span>#计算核糖体蛋白基因的百分比</span><br>sce.all[[<span>"percent.hb"</span>]] &lt;- PercentageFeatureSet(sce.all, <br>                                                pattern = <span>"^HB[^(P)]"</span>) <span>#计算血红蛋白基因的百分比</span><br><br>head(sce.all@meta.data, <span>1</span>) <span>#元信息表会添加计算出来的百分数</span></code></pre><pre><code>##       orig.ident nCount_RNA nFeature_RNA                  10x_barcode patient<br>## 10x_1          5   4677.995          839 10x_3288_t1_AAACATACCTTCCG-1       5<br>##       time sample_ID clst       TSNE_x       TSNE_y percent.mt percent.rp<br>## 10x_1    1    3288.1    1 4.533631e+01 4.693348e+01   1.820066   7.208477<br>##       percent.hb<br>## 10x_1          0</code></pre><pre><code>使用VlnPlot函数绘制小提琴图，以可视化每个细胞样本的基因特征（nFeature_RNA）、RNA计数（nCount_RNA）、线粒体基因百分比（percent.mt）、核糖体蛋白基因百分比（percent.rp）和血红蛋白基因百分比（percent.hb）。</code></pre><pre><code>VlnPlot(sce.all, <br>        features = c(<span>"nFeature_RNA"</span>,<br>                     <span>"nCount_RNA"</span>, <br>                     <span>"percent.mt"</span>,<br>                     <span>"percent.rp"</span>,<br>                     <span>"percent.hb"</span>), <br>        ncol = <span>3</span>, <span>#3列</span><br>        pt.size = <span>0</span>,  <span>#数据点大小</span><br>        group.by = <span>"orig.ident"</span>) <span>#按orig.ident分组</span></code></pre><p><img data-imgfileid="100002578" data-ratio="0.5" data-type="png" data-w="1080" width="960" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzSpayuyjXc4ibxZNIPMosaFtpzThV7TUJTB4ibodULpbtPHCxXwEhzBvA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzSpayuyjXc4ibxZNIPMosaFtpzThV7TUJTB4ibodULpbtPHCxXwEhzBvA/640?wx_fmt=png&amp;from=appmsg"></p><pre><code><span>#对单细胞RNA测序数据进行过滤，以保留符合特定条件的细胞</span><br>sce.all = subset(sce.all,<br>                percent.mt &lt; <span>5</span> &amp;<br>                nFeature_RNA &lt; <span>6200</span> &amp;<br>                nCount_RNA &lt; <span>18000</span> &amp;<br>                percent.rp &lt;<span>15</span> &amp;<br>                percent.hb &lt;<span>1</span>)</code></pre><p>1）筛选线粒体基因百分比（percent.mt &lt; 5）：</p><pre><code>只保留线粒体基因表达百分比低于5%的细胞。高线粒体基因百分比通常表示细胞质量较低，可能是因为细胞正在经历应激或死亡。</code></pre><p>2）筛选基因特征数（nFeature_RNA &lt; 6200）：</p><pre><code> 只保留基因特征数少于6200的细胞。基因特征数过高可能表示双重细胞（doublets）或其他技术噪音。</code></pre><p>3）筛选RNA计数（nCount_RNA &lt; 18000）：</p><pre><code> 只保留RNA计数少于18000的细胞。RNA计数过高可能也表示双重细胞或技术噪音。</code></pre><p>4）筛选核糖体蛋白基因百分比（percent.rp &lt; 15）：</p><pre><code> 只保留核糖体蛋白基因表达百分比低于15%的细胞。核糖体蛋白基因的高表达可能会影响下游分析的结果。</code></pre><p>5）筛选血红蛋白基因百分比（percent.hb &lt; 1）：</p><pre><code> 只保留血红蛋白基因表达百分比低于1%的细胞。血红蛋白基因的高表达可能表示红细胞污染，这可能不相关于所研究的细胞类型。</code></pre><pre><code>dim(sce.all)</code></pre><pre><code>## [1] 11548  9580</code></pre><pre><code>table(sce.all$orig.ident)</code></pre><pre><code>## <br>##    1    2    3    4    5    6 <br>##  350  560  812  671 5995 1192</code></pre><pre><code> 3.降维聚类分群<br> <br>   使用Seurat包和harmony包对单细胞RNA测序数据进行标准化、降维、批次校正和聚类分析，下面这段代码意思是：识别可变基因并进行数据标准化；使用PCA对数据进行初步降维；使用Harmony方法进行批次校正；在经过校正后的降维空间中进行聚类分析；使用UMAP和t-SNE两种非线性降维技术进行可视化。<br></code></pre><pre><code>f = <span>"obj1.Rdata"</span><br><span>library</span>(harmony)<br><br><span>if</span>(!file.exists(f)){<br>  sce.all = sce.all %&gt;% <br>  NormalizeData() %&gt;%  <span>#数据标准化</span><br>  ScaleData() %&gt;%   <span>#数据缩放</span><br>  FindVariableFeatures(selection.method = <span>"vst"</span>, nfeatures = <span>3000</span>) %&gt;%   <span>#寻找可变特征</span><br>  RunPCA(pc.genes = sce.all@var.genes)  %&gt;%  <span>#主成分分析（PCA）</span><br>  RunHarmony(<span>"orig.ident"</span>) %&gt;%  <span>#批次校正</span><br>  FindNeighbors(dims = <span>1</span>:<span>15</span>, reduction = <span>"harmony"</span>) %&gt;%  <span>#找到每个细胞的邻居细胞</span><br>  FindClusters(resolution = <span>1</span>) %&gt;%  <span>#聚类分析</span><br>  RunUMAP(dims = <span>1</span>:<span>15</span>,reduction = <span>"harmony"</span>) %&gt;%  <span>#使用经过Harmony校正后的前15个主成分进行UMAP降维</span><br>  RunTSNE(dims = <span>1</span>:<span>15</span>,reduction = <span>"harmony"</span>)<br>  save(sce.all,file = f)<br>}<br>load(f)<br><br>ElbowPlot(sce.all)</code></pre><p><img data-imgfileid="100002577" data-ratio="0.5" data-type="png" data-w="1080" width="960" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzFIOyUFAwQKMiaPeeed701sPLEKnD5a6qAOEcGclus8VU5T13seeQbxw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzFIOyUFAwQKMiaPeeed701sPLEKnD5a6qAOEcGclus8VU5T13seeQbxw/640?wx_fmt=png&amp;from=appmsg">     <span>ElbowPlot函数绘制主成分分析（PCA）中的“肘部图”。</span><span>肘部图用于确定在降维分析中选择多少个主成分是合适的。</span></p><p><span>     在肘部图中，x轴表示主成分的数量，y轴表示每个主成分的标准差。</span><span>通常，我们选择曲线开始变得平坦的点作为主成分的数量，即“肘部”位置。</span><span>这个位置显示了添加更多主成分对解释数据变异的重要性开始减弱的点。</span></p><pre><code><span>#可视化降维后的数据，通常用于展示聚类结果</span><br>p1 &lt;- DimPlot(sce.all, reduction = <span>"umap"</span>,label = <span>T</span>)+NoLegend();p1</code></pre><p><img data-imgfileid="100002576" data-ratio="0.5" data-type="png" data-w="1080" width="960" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzFNrhajQzsz04lDEwvrXQsbMQorK1JjFW2CkbTFl7fFH2sqpaJvwjXw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzFNrhajQzsz04lDEwvrXQsbMQorK1JjFW2CkbTFl7fFH2sqpaJvwjXw/640?wx_fmt=png&amp;from=appmsg"><span>4.计算marker基因</span></p><p><span>    下面这段代码用来寻找并保存所有簇（cluster）的标志基因，并从中挑选出每个簇中表达水平最高的两个基因。</span></p><pre><code>f = <span>"markers.Rdata"</span><br><span>if</span>(!file.exists(f)){<br>  allmarkers &lt;- FindAllMarkers(sce.all,  <span>#寻找所有簇的标志基因</span><br>                               only.pos = <span>TRUE</span>, <span>#仅返回正向标志基因（即在簇中上调的基因）</span><br>                               min.pct = <span>0.25</span>, <span>#基因在至少25%的细胞中表达</span><br>                               logfc.threshold = <span>0.25</span>) <span>#对数fold变化阈值为0.25，筛选出表达水平显著上调的基因</span><br>  save(allmarkers,file = f)<br>}<br>load(f)<br><br>mks = allmarkers %&gt;% group_by(cluster) %&gt;% top_n(n = <span>2</span>, wt = avg_log2FC)<br>g = mks$gene<br>g</code></pre><pre><code>##  [1] "CCL18"        "SDC3"         "LINC00842"    "TMEM151A"     "LIPA"        <br>##  [6] "IGSF6"        "PILRA"        "CD86"         "FABP5"        "RPS26"       <br>## [11] "CXCL3"        "IL8"          "S100A12"      "C19orf59"     "CLDN9"       <br>## [16] "CXCL17"       "SRPX"         "GRIA3"        "CD3E"         "XCL1"        <br>## [21] "HS3ST1"       "FABP4"        "RP11-16E12.2" "IGLL1"        "KIF20A"      <br>## [26] "ANLN"         "LYPD6B"       "FOXJ1"        "BFSP2"        "TNFRSF13B"   <br>## [31] "PLD4"         "CD1E"         "KIAA0101"     "CDK1"         "CCL19"       <br>## [36] "BCL2L14"      "SPINK2"       "CDCA7"</code></pre><p><span>5.注释亚群 </span></p><p><span>    手动注释</span></p><pre><code><span>#定义标志基因列表</span><br>markers = list(epithelial = <span>"EPCAM"</span>,<br>               macrophages = c(<span>"CD14"</span>,<span>"AIF1"</span>,<span>"CSF1R"</span>,<span>"CD163"</span>),<br>               CAFs = c(<span>"PDPN"</span>,<span>"DCN"</span>,<span>"THY1"</span>),<br>               DC = c(<span>"CD1C"</span>,<span>"CD1E"</span>,<span>"CCR7"</span>,<span>"CD83"</span>),<br>               Bcells = c(<span>"CD19"</span>,<span>"CD79A"</span>,<span>"CD79B"</span>),<br>               Tcells = c(<span>"CD2"</span>,<span>"CD3D"</span>,<span>"CD3E"</span>,<span>"CD3G"</span>),<br>               erythrocytes = <span>"GATA1"</span>)<br><br><span>#DotPlot函数用于绘制标志基因在单细胞数据中的表达情况。每个点的大小表示该基因在某个簇中的表达比例，颜色表示表达水平</span><br><br>DotPlot(sce.all,features = markers)+<br>  RotatedAxis() <span>#将x轴标签旋转</span></code></pre><p><img data-imgfileid="100002579" data-ratio="0.625" data-type="png" data-w="1080" width="768" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzAPKTDvxl9bJz6jzOIuYHVu6iaH0lqr4dtV9CZOBN02gj7fdx512U54w/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzAPKTDvxl9bJz6jzOIuYHVu6iaH0lqr4dtV9CZOBN02gj7fdx512U54w/640?wx_fmt=png&amp;from=appmsg"></p><pre><code>celltype = read.table(<span>"celltype.txt"</span>) <span>#根据DotPlot图手动填写，以标识每个细胞簇对应的细胞类型</span><br>celltype</code></pre><pre><code>##    V1          V2<br>## 1   0 macrophages<br>## 2   1        CAFs<br>## 3   2 macrophages<br>## 4   3 macrophages<br>## 5   4 macrophages<br>## 6   5 macrophages<br>## 7   6 macrophages<br>## 8   7  epithelial<br>## 9   8        CAFS<br>## 10  9           T<br>## 11 10 macrophages<br>## 12 11           B<br>## 13 12        CAFs<br>## 14 13  epithelial<br>## 15 14           B<br>## 16 15 macrophages<br>## 17 16 macrophages<br>## 18 17          DC<br>## 19 18           T</code></pre><pre><code> 将注释的细胞类型画到图上去</code></pre><pre><code>new.cluster.ids &lt;- celltype$V2<br>names(new.cluster.ids) &lt;- levels(sce.all)<br>new.cluster.ids</code></pre><pre><code>##             0             1             2             3             4 <br>## "macrophages"        "CAFs" "macrophages" "macrophages" "macrophages" <br>##             5             6             7             8             9 <br>## "macrophages" "macrophages"  "epithelial"        "CAFS"           "T" <br>##            10            11            12            13            14 <br>## "macrophages"           "B"        "CAFs"  "epithelial"           "B" <br>##            15            16            17            18 <br>## "macrophages" "macrophages"          "DC"           "T"</code></pre><pre><code><span>#RenameIdents函数用于重命名Seurat对象seu.obj中的簇标识符</span><br>seu.obj &lt;- RenameIdents(sce.all, new.cluster.ids)<br>save(seu.obj,file = <span>"seu.obj.Rdata"</span>)<br><br><span>#绘制UMAP降维图</span><br>p1 &lt;- DimPlot(seu.obj, <br>        reduction = <span>"umap"</span>, <br>        label = <span>TRUE</span>,  <span>#在图中标注每个簇的标签</span><br>        pt.size = <span>0.5</span>) + NoLegend() <span>#移除图例</span><br>p1</code></pre><p><img data-imgfileid="100002581" data-ratio="0.5" data-type="png" data-w="1080" width="960" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNz9akdtAibakCOXaYVJeDoTzN1exUOmG0UQddS5euNgTuGnhT4MbpS6FA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNz9akdtAibakCOXaYVJeDoTzN1exUOmG0UQddS5euNgTuGnhT4MbpS6FA/640?wx_fmt=png&amp;from=appmsg"><span>也可以自己提取数据，用ggplot2画</span></p><pre><code>dat = as.data.frame(seu.obj@reductions$umap@cell.embeddings)<br>dat$seurat_annotation = seu.obj@active.ident<br><br>ggplot(dat,aes(umap_1,umap_2))+<br>  geom_point(aes(color = seurat_annotation),size = <span>0.5</span>)+<br>  scale_color_brewer(palette = <span>"Set1"</span>)+<br>  theme_classic()</code></pre><p><img data-imgfileid="100002580" data-ratio="0.5" data-type="png" data-w="1080" width="960" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzaHicrpI3KAtgQ4UAx9zKaqkw6ZfX8zzQcFloGtWr4lPBZia3E8icjQWrA/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNzaHicrpI3KAtgQ4UAx9zKaqkw6ZfX8zzQcFloGtWr4lPBZia3E8icjQWrA/640?wx_fmt=png&amp;from=appmsg"><span>6.样本细胞比例条形图</span></p><pre><code>seu.obj$seurat_annotation = seu.obj@active.ident<br><br>ggplot(seu.obj@meta.data,aes(patient,<br>                             fill = seurat_annotation))+<br>  geom_bar(position = <span>"fill"</span>, alpha = <span>0.9</span>)+<br>  scale_fill_brewer(palette = <span>"Set1"</span>)+<br>  theme_classic()</code></pre><p><img data-imgfileid="100002582" data-ratio="0.5" data-type="png" data-w="1080" width="960" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNz2l1YTzhQ7kmGBibCUs5p3OW4Xib7j53PmGX0DiaqdATEfxSDXFvl8gMBw/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNz2l1YTzhQ7kmGBibCUs5p3OW4Xib7j53PmGX0DiaqdATEfxSDXFvl8gMBw/640?wx_fmt=png&amp;from=appmsg"><span>7.小提琴图-展示marker基因</span></p><p><span>    7.1 marker基因</span></p><pre><code>g = unique(g) <span>#标志基因去重</span><br><br>vln.df &lt;- seu.obj@assays$RNA$scale.data %&gt;%<br>  t() %&gt;%<br>  as.data.frame()%&gt;%<br>  select(g) %&gt;% <br>  rownames_to_column(<span>"CB"</span>) %&gt;% <br>  mutate(cluster = seu.obj$RNA_snn_res.1)%&gt;%<br>  pivot_longer(cols = <span>2</span>:(ncol(.)-<span>1</span>),<br>               names_to = <span>"gene"</span>,<br>               values_to = <span>"exp"</span>) %&gt;% <br>  mutate(gene = factor(gene,levels = g))<br><br>head(vln.df)</code></pre><pre><code>## # A tibble: 6 × 4<br>##   CB    cluster gene         exp<br>##   &lt;chr&gt; &lt;fct&gt;   &lt;fct&gt;      &lt;dbl&gt;<br>## 1 10x_1 0       CCL18      1.75 <br>## 2 10x_1 0       SDC3       2.16 <br>## 3 10x_1 0       LINC00842 -0.254<br>## 4 10x_1 0       TMEM151A  -0.249<br>## 5 10x_1 0       LIPA      -0.864<br>## 6 10x_1 0       IGSF6     -0.468</code></pre><pre><code><span># 自定义颜色</span><br><span>library</span>(paletteer)<br>my_color = paletteer_d(`"ggsci::default_nejm"`)<br>my_color = colorRampPalette(my_color)(length(unique(vln.df$cluster)))<br><br><span># 画图</span><br>p1 &lt;- ggplot(vln.df,aes(cluster,exp),color=factor(cluster))+<br>  geom_violin(aes(fill=cluster),scale = <span>"width"</span>)+<br>  scale_fill_manual(values = my_color)+<br>  facet_grid(gene~.,scales = <span>"free_y"</span>)+<br>  scale_y_continuous(expand = c(<span>0</span>,<span>0</span>))+<br>  theme_bw()+<br>  theme(<br>    panel.grid = element_blank(),<br>    axis.title.x.bottom = element_blank(),<br>    axis.ticks.x.bottom = element_blank(),<br>    axis.text.x.bottom = element_text(hjust = <span>1</span>,vjust = <span>NULL</span>,color = <span>"black"</span>,size = <span>14</span>),<br>    axis.title.y.left = element_blank(),<br>    axis.ticks.y.left = element_blank(),<br>    axis.text.y.left = element_blank(),<br>    legend.position = <span>"none"</span>,<br>    panel.spacing.y = unit(<span>0</span>, <span>"cm"</span>),<br>    strip.text.y = element_text(angle=<span>0</span>,size = <span>14</span>,hjust = <span>0</span>),<br>    strip.background.y = element_blank()<br>  )<br><br>p1</code></pre><p><img data-imgfileid="100002583" data-ratio="1" data-type="png" data-w="1080" width="1152" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNz0zMZASLicbOUsNw3XrZ82xIpAFsWQ0he6G7RHMC2eeNbYUKlZmxhB8w/640?wx_fmt=png&amp;from=appmsg" src="https://mmbiz.qpic.cn/sz_mmbiz_png/IGjxEGEQ50n21enpnowjlra0e4zLytNz0zMZASLicbOUsNw3XrZ82xIpAFsWQ0he6G7RHMC2eeNbYUKlZmxhB8w/640?wx_fmt=png&amp;from=appmsg"></p><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/oi4M6UetEjepu83ux8jR9A",target="_blank" rel="noopener noreferrer">原文链接</a>
