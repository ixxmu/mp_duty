---
title: "学习笔记：slurm作业调度系统"
date: 2024-10-19T22:17:38Z
draft: ["false"]
tags: [
  "fetched",
  "生信菜鸟团"
]
categories: ["Acdemic"]
---
学习笔记：slurm作业调度系统 by 生信菜鸟团
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">博士期间我一直用的是生信技能树的服务器【<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247525661&amp;idx=2&amp;sn=a0662fa3a9ebc7c840d45049eaca2c8c&amp;scene=21#wechat_redirect" data-linktype="2">搭配GPU服务再升级—256线程2Tb内存服务器共享一年仍然是仅需800</a>】，这个价格非常适合学生党，可以帮助我们低成本快速练习Linux技能，美中不足的是技能树的服务器没有作业调度系统。由于我过去四年没有这方面的使用背景，我完全不适应新单位的集群系统。实际上，大规模以及长期运行的数据需要提交任务至分配节点，如果在登录节点运行较大资源的话，会导致整个服务器卡顿（还可能会被别的用户吐槽，甚至被管理员处罚...）。在这里，我分享一下关于Slurm学习笔记。</p><p data-tool="mdnice编辑器">Slurm（Simple Linux Utility for Resource Management）是一个常用的作业调度系统，已被全世界的国家超级计算机中心广泛采用，它可以管理计算集群上的资源，并调度和执行作业（例如脚本或分析任务），帮助用户高效地在多个计算节点上运行任务。</p><h3 data-tool="mdnice编辑器"><span></span><span>Slurm 的基本概念</span><span></span></h3><p data-tool="mdnice编辑器"><strong>作业 (Job)</strong>: 用户提交给集群去执行的任务，例如运行一个脚本。</p><ul data-tool="mdnice编辑器"><li><section><p><strong>节点 (Node)</strong>: 集群中的一台计算机，负责执行作业。</p></section></li><ul><li><section><span><strong>登录节点 (Login Node)</strong>: 用户通过 SSH 进入集群后最初登录的节点。它用于准备作业、编写脚本和提交作业，但不是作业执行的地方。</span></section></li><li><section><span><strong>分配节点 (Allocated Node)</strong>: 当你提交作业并成功分配资源时，作业将在这些节点上运行，它们由 Slurm 根据你的资源需求来选择。</span></section></li></ul><li><section><p><strong>分区 (Partition)</strong>: 一组节点的集合（也可以叫做“队列”），不同分区可能有不同的资源配置或策略。</p></section></li><li><section><p><strong>调度器 (Scheduler)</strong>: Slurm 根据资源可用性和作业的优先级，决定作业何时、在哪些节点上执行。</p></section></li></ul><h3 data-tool="mdnice编辑器"><span></span><span>基本工作流程</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><p><strong>提交作业</strong>: 用户通过<code>sbatch</code>命令提交编写好的作业脚本，描述作业的资源需求（如节点数、CPU数、内存等）和执行命令，或者使用 <code>srun</code> 运行交互式作业。</p></section></li><li><section><p><strong>资源分配：</strong>Slurm的调度器根据当前的资源可用情况和作业队列中的优先级，分配资源给新提交的作业。</p></section></li><li><section><p><strong>监控作业</strong>: 使用 <code>squeue</code> 查看作业的状态（例如，正在运行或等待中）。</p></section></li><li><section><p><strong>作业输出</strong>: 作业完成后，输出通常会保存在用户指定的文件中。</p></section></li></ul><figure data-tool="mdnice编辑器"><img data-imgfileid="100044672" data-ratio="0.37452107279693486" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibUtBKibs6jryhXj80WD3ictPZdx8udkcNEwSurjZQtDgoqicgNibwQpOJ7eyyeX3BuYxLbOl8GDXf5ng/640?wx_fmt=other&amp;from=appmsg" data-type="other" data-w="1044" src="https://mmbiz.qpic.cn/mmbiz_jpg/iaRJcrq2LosibUtBKibs6jryhXj80WD3ictPZdx8udkcNEwSurjZQtDgoqicgNibwQpOJ7eyyeX3BuYxLbOl8GDXf5ng/640?wx_fmt=other&amp;from=appmsg"><figcaption>image-20241018215519860</figcaption></figure><h3 data-tool="mdnice编辑器"><span></span><span>Slurm 概览</span><span></span></h3><section data-tool="mdnice编辑器"><table><thead><tr><th>Slurm</th><th>功能</th></tr></thead><tbody><tr><td>sinfo</td><td>集群状态</td></tr><tr><td>srun</td><td>启动交互式作业</td></tr><tr><td>squeue</td><td>排队作业状态，当前作业状态监控</td></tr><tr><td>sbatch</td><td>作业/脚本提交</td></tr><tr><td>scontrol</td><td>查看和修改作业参数</td></tr><tr><td>sacct</td><td>显示用户的作业历史，默认情况下，sacct显示过去 <strong>24小时</strong> 的账号作业信息。</td></tr><tr><td>scancel</td><td>删除作业</td></tr><tr><td>sreport</td><td>生成使用报告</td></tr></tbody></table></section><h3 data-tool="mdnice编辑器"><span></span><span><code>sinfo</code> 查看集群状态和信息</span><span></span></h3><section data-tool="mdnice编辑器"><table><thead><tr><th>Slurm</th><th>功能</th></tr></thead><tbody><tr><td>sinfo -s</td><td>简要格式输出</td></tr><tr><td>sinfo -N</td><td>查看节点级信息</td></tr><tr><td>sinfo -N --states=idle</td><td>查看可用节点信息</td></tr><tr><td>sinfo --partition=cpu</td><td>查看队列信息</td></tr><tr><td>sinfo --help</td><td>查看所有选项</td></tr></tbody></table></section><p data-tool="mdnice编辑器"><strong>输出字段</strong>:</p><ul data-tool="mdnice编辑器"><li><section><span><strong>PARTITION</strong>: 分区名称</span></section></li><li><section><span><strong>AVAIL</strong>: 节点可用性状态（up/down）</span></section></li><li><section><span><strong>TIMELIMIT</strong>: 分区的时间限制</span></section></li><li><section><span><strong>NODES</strong>: 分区中的节点数量</span></section></li><li><section><span><strong>STATE</strong>: 节点状态：</span><code><span>drain</span></code><span>(节点故障)，</span><code><span>alloc</span></code><span>(节点在用)，</span><code><span>idle</span></code><span>(节点可用)，</span><code><span>down</span></code><span>(节点下线)，</span><code><span>mix</span></code><span>（节点被占用，但仍有剩余资源）</span></section></li><li><section><span><strong>NODELIST</strong>: 节点名称列表</span></section></li></ul><p data-tool="mdnice编辑器">查看总体资源信息：</p><pre data-tool="mdnice编辑器"><span></span><code>sinfo<br><span>#PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST</span><br><span>#cpu         up  7-00:00:0    656   idle cas[001-656]</span><br><span>#dgx2        up  7-00:00:0      8   idle vol[01-08]</span><br></code></pre><p data-tool="mdnice编辑器">查看某个特定节点的信息：</p><pre data-tool="mdnice编辑器"><span></span><code>sinfo -n &lt;节点名称&gt;<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><code>sacct</code>显示用户作业历史</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><p><span><strong>用途</strong>: 查询作业历史记录，显示已完成和正在进行的作业信息，默认情况下，sacct显示过去 <strong>24小时</strong> 的账号作业信息。</span></p></section></li><li><section><p><span><strong>参数</strong>:</span></p></section></li><ul><li><section><code><span>-j &lt;jobid&gt;</span></code><span> 查询特定作业</span></section></li><li><section><code><span>-S &lt;YYYY-MM-DD&gt;</span></code><span> 查询指定开始日期的作业</span></section></li><li><section><code><span>-u &lt;username&gt;</span></code><span> 查询特定用户的作业</span></section></li></ul><li><section><p><span><strong>输出字段</strong>:</span></p></section></li><ul><li><section><p><span><strong>JobID</strong>: 作业ID</span></p></section></li><li><section><p><span><strong>JobName</strong>: 作业名称</span></p></section></li><li><section><p><span><strong>Partition</strong>: 分区名称</span></p></section></li><li><section><p><span><strong>Account</strong>: 用户账户</span></p></section></li><li><section><p><span><strong>State</strong>: 作业状态（COMPLETED、FAILED、CANCELLED等）</span></p></section></li><li><section><p><span><strong>Elapsed</strong>: 作业运行时间</span></p></section></li></ul></ul><h3 data-tool="mdnice编辑器"><span></span><span><code>squeue</code> 查看作业信息</span><span></span></h3><section data-tool="mdnice编辑器"><table><thead><tr><th>Slurm</th><th>功能</th></tr></thead><tbody><tr><td>squeue -j &lt;作业的jobid&gt;</td><td>查看作业信息</td></tr><tr><td>squeue -l</td><td>查看细节信息</td></tr><tr><td>squeue --nodelist=&lt;节点名称&gt;</td><td>查看特定节点作业信息</td></tr><tr><td>squeue</td><td>查看USER_LIST的作业</td></tr><tr><td>squeue --state=R</td><td>查看特定状态的作业</td></tr><tr><td>squeue --help</td><td>查看所有的选项</td></tr></tbody></table></section><p data-tool="mdnice编辑器"><strong>输出字段</strong>:</p><ul data-tool="mdnice编辑器"><li><section><strong>JOBID</strong>: 作业ID</section></li><li><section><strong>PARTITION</strong>: 分区名称</section></li><li><section><strong>NAME</strong>: 作业名称</section></li><li><section><strong>USER</strong>: 用户名</section></li><li><section><strong>ST</strong>: 作业状态包括<code>R</code>(正在运行)，<code>PD</code>(正在排队)，<code>CG</code>(即将完成)，<code>CD</code>(已完成)</section></li><li><section><strong>TIME</strong>: 作业运行时间</section></li><li><section><strong>NODES</strong>: 作业使用的节点数量</section></li><li><section><strong>NODELIST(REASON)</strong>: 作业所在节点或排队原因</section></li></ul><p data-tool="mdnice编辑器">默认情况下，<code>squeue</code>只会展示在排队或在运行的作业。</p><pre data-tool="mdnice编辑器"><span></span><code>$ squeue<br>JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)<br>18046      dgx2   ZXLing     eenl  R    1:35:53      1 vol04<br>17796      dgx2   python    eexdl  R 3-00:22:04      1 vol02<br></code></pre><p data-tool="mdnice编辑器">显示您自己账户下的作业：</p><pre data-tool="mdnice编辑器"><span></span><code>squeue -u &lt;用户名&gt;<br>JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)<br>17923      dgx2     bash    hpcwj  R 1-12:59:05      1 vol05<br></code></pre><p data-tool="mdnice编辑器"><code>-l</code>选项可以显示更细节的信息。</p><pre data-tool="mdnice编辑器"><span></span><code>squeue -u &lt;用户名&gt; -l<br>JOBID PARTITION     NAME     USER    STATE       TIME TIME_LIMI  NODES NODELIST(REASON)<br>17923      dgx2     bash    hpcwj  RUNNING 1-13:00:53 30-00:00:00    1 vol05<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><code>srun</code> 启动交互式作业</span><span></span></h3><pre data-tool="mdnice编辑器"><span></span><code>srun --partition=&lt;分区&gt; --nodes=&lt;节点数&gt; --ntasks=&lt;任务数&gt; --t=&lt;时长&gt; --mem=&lt;内存&gt; --c=&lt;调用的CPU数量&gt; --pty bash<br></code></pre><p data-tool="mdnice编辑器">运行此命令后，你会获得一个交互式的 shell，能够在该节点上直接执行命令。但是srun的缺点是一旦断线就无法重新连接回去，因此推荐使用Linux终端复用神器tmux/screen+srun配合运行，关于tmux，详见我之前写的推文【<a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247487322&amp;idx=1&amp;sn=f2a60813d19fc067378713a58cef0a11&amp;scene=21#wechat_redirect" data-linktype="2">Tmux：Linux终端复用神器，包好用</a>】</p><h3 data-tool="mdnice编辑器"><span></span><span><code>sbatch</code>作业提交</span><span></span></h3><p data-tool="mdnice编辑器">准备作业脚本然后通过<code>sbatch</code>提交是 Slurm 的最常见用法。为了将作业脚本提交给作业系统，Slurm 使用</p><pre data-tool="mdnice编辑器"><span></span><code>sbatch my_job_script.sh<br></code></pre><p data-tool="mdnice编辑器">Slurm 具有丰富的参数集。以下最常用的。</p><section data-tool="mdnice编辑器"><table><thead><tr><th>Slurm</th><th>含义</th></tr></thead><tbody><tr><td><code>-n [count]</code></td><td>总进程数</td></tr><tr><td><code>--ntasks-per-node=[count]</code></td><td>每台节点上的进程数</td></tr><tr><td><code>-p [partition]</code></td><td>作业队列</td></tr><tr><td><code>--job-name=[name]</code></td><td>作业名</td></tr><tr><td><code>--output=[file_name]</code></td><td>标准输出文件</td></tr><tr><td><code>--error=[file_name]</code></td><td>标准错误文件</td></tr><tr><td><code>--time=[dd-hh:mm:ss]</code></td><td>作业最大运行时长</td></tr><tr><td><code>--exclusive</code></td><td>独占节点</td></tr><tr><td><code>--mail-type=[type]</code></td><td>通知类型，可选 all, fail, end，分别对应全通知、故障通知、结束通知</td></tr><tr><td><code>--mail-user=[mail_address]</code></td><td>通知邮箱</td></tr><tr><td><code>--nodelist=[nodes]</code></td><td>偏好的作业节点</td></tr><tr><td><code>--exclude=[nodes]</code></td><td>避免的作业节点</td></tr><tr><td><code>--depend=[state:job_id]</code></td><td>作业依赖</td></tr><tr><td><code>--array=[array_spec]</code></td><td>序列作业</td></tr></tbody></table></section><p data-tool="mdnice编辑器">这是一个名为<code>cpu.slurm</code>的作业脚本，该脚本向cpu队列申请1个节点40核，并在作业完成时通知。在此作业中执行的命令是<code>/bin/hostname</code>。</p><ul data-tool="mdnice编辑器"><li><section><code>#SBATCH --job-name</code> 作业名称</section></li><li><section><code>#SBATCH --output</code> 标准输出文件：如/share/home/pengchen/work/%x_%A_%a.out</section></li><li><section><code>#SBATCH --error</code> ERROR输出文件：如/share/home/pengchen/work/%x_%A_%a.err</section></li><li><section><code>#SBATCH --partition</code> 工作分区，我们用cpu之类的</section></li><li><section><code>#SBATCH --nodelist</code> 可以制定在哪个节点运行任务</section></li><li><section><code>#SBATCH --exclude</code> 可以设置不放在某个节点跑任务</section></li><li><section><code>#SBATCH --nodes</code> 使用nodes数量</section></li><li><section><code>#SBATCH --ntasks</code> tasks数量，可能分配给不同node</section></li><li><section><code>#SBATCH --ntasks-per-node</code> 每个节点的tasks数量，由于我们只有1 node，所以ntasks和ntasks-per-node是相同的</section></li><li><section><code>#SBATCH --cpus-per-task</code> 每个task使用的core的数量（默认 1 core per task），同一个task会在同一个node</section></li><li><section><code>#SBATCH --mem</code> 这个作业要求的内存 (Specified in MB，GB)</section></li><li><section><code>#SBATCH --mem-per-cpu</code> 每个core要求的内存 (Specified in MB，GB)</section></li></ul><pre data-tool="mdnice编辑器"><span></span><code><span>#!/bin/bash<br></span><br><span>#SBATCH --job-name=hostname</span><br><span>#SBATCH --partition=cpu</span><br><span>#SBATCH -N 1</span><br><span>#SBATCH --mail-type=end</span><br><span>#SBATCH --mail-user=YOU@EMAIL.COM</span><br><span>#SBATCH --output=%j.out</span><br><span>#SBATCH --error=%j.err</span><br><br>/bin/hostname<br></code></pre><p data-tool="mdnice编辑器">用以下方式提交作业：</p><pre data-tool="mdnice编辑器"><span></span><code>sbatch cpu.slurm<br></code></pre><p data-tool="mdnice编辑器"><code>squeue</code>可用于检查作业状态。用户可以在作业执行期间通过SSH登录到计算节点。输出将实时更新到文件[jobid] .out和[jobid] .err。</p><p data-tool="mdnice编辑器">这里展示一个更复杂的作业要求，其中将启动80个进程，每台主机40个进程。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#!/bin/bash<br></span><br><span>#SBATCH --job-name=LINPACK</span><br><span>#SBATCH --partition=cpu</span><br><span>#SBATCH -n 80</span><br><span>#SBATCH --ntasks-per-node=40</span><br><span>#SBATCH --mail-type=end</span><br><span>#SBATCH --mail-user=YOU@EMAIL.COM</span><br><span>#SBATCH --output=%j.out</span><br><span>#SBATCH --error=%j.err</span><br></code></pre><p data-tool="mdnice编辑器">以下作业请求4张GPU卡，其中1个CPU进程管理1张GPU卡。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#!/bin/bash<br></span><br><span>#SBATCH --job-name=GPU_HPL</span><br><span>#SBATCH --partition=dgx2</span><br><span>#SBATCH -n 4</span><br><span>#SBATCH --ntasks-per-node=4</span><br><span>#SBATCH --gres=gpu:4</span><br><span>#SBATCH --mail-type=end</span><br><span>#SBATCH --mail-user=YOU@MAIL.COM</span><br><span>#SBATCH --output=%j.out</span><br><span>#SBATCH --error=%j.err</span><br></code></pre><p data-tool="mdnice编辑器">以下作业启动一个3任务序列（从0到2），每个任务需要1个CPU内核。</p><pre data-tool="mdnice编辑器"><span></span><code><span>#!/bin/bash<br></span><br><span>#SBATCH --job-name=python_array</span><br><span>#SBATCH --mail-user=YOU@MAIL.COM</span><br><span>#SBATCH --mail-type=ALL</span><br><span>#SBATCH --ntasks=1</span><br><span>#SBATCH --time=00:30:00</span><br><span>#SBATCH --array=0-2</span><br><span>#SBATCH --output=python_array_%A_%a.out</span><br><span>#SBATCH --output=python_array_%A_%a.err</span><br><br>module load miniconda2/4.6.14-gcc-4.8.5<br><br><span>source</span> activate YOUR_ENV_NAME<br><br><span>echo</span> <span>"SLURM_JOBID: "</span> <span>$SLURM_JOBID</span><br><span>echo</span> <span>"SLURM_ARRAY_TASK_ID: "</span> <span>$SLURM_ARRAY_TASK_ID</span><br><span>echo</span> <span>"SLURM_ARRAY_JOB_ID: "</span> <span>$SLURM_ARRAY_JOB_ID</span><br><br>python &lt; vec_<span>${SLURM_ARRAY_TASK_ID}</span>.py<br></code></pre><p data-tool="mdnice编辑器">在提交到SLURM的作业脚本中，可以激活Conda环境以确保作业在正确的软件环境中运行。以下是一个示例SLURM作业脚本：</p><pre data-tool="mdnice编辑器"><span></span><code><span>#!/bin/bash</span><br><span>#SBATCH --job-name=myjob            # 作业名称</span><br><span>#SBATCH --output=myjob.out          # 标准输出和错误日志</span><br><span>#SBATCH --error=myjob.err           # 错误日志文件</span><br><span>#SBATCH --ntasks=1                  # 运行的任务数</span><br><span>#SBATCH --time=01:00:00             # 运行时间</span><br><span>#SBATCH --partition=compute         # 作业提交的分区</span><br><br><span># 加载Conda</span><br><span>source</span> ~/miniconda3/etc/profile.d/conda.sh<br><br><span># 激活环境</span><br>conda activate myenv<br><br><span># 运行命令</span><br>python my_script.py<br></code></pre><h3 data-tool="mdnice编辑器"><span></span><span><code>scancel</code>取消指定作业</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><p><strong>用途</strong>: 取消一个或多个作业。</p></section></li><li><section><p><strong>示例</strong>:</p><pre><span></span><code>scancel 12345<br></code></pre></section></li><li><section><p><strong>参数</strong>:</p></section></li><ul><li><section><p><code>-u &lt;username&gt;</code> 取消特定用户的所有作业</p></section></li><li><section><p><code>-p &lt;partition&gt;</code> 取消特定分区中的作业</p></section></li></ul></ul><h3 data-tool="mdnice编辑器"><span></span><span>Slurm环境变量</span><span></span></h3><section data-tool="mdnice编辑器"><table><thead><tr><th>Slurm</th><th>功能</th></tr></thead><tbody><tr><td>$SLURM_JOB_ID</td><td>作业ID</td></tr><tr><td>$SLURM_JOB_NAME</td><td>作业名</td></tr><tr><td>$SLURM_JOB_PARTITION</td><td>队列的名称</td></tr><tr><td>$SLURM_NTASKS</td><td>进程总数</td></tr><tr><td>$SLURM_NTASKS_PER_NODE</td><td>每个节点请求的任务数</td></tr><tr><td>$SLURM_JOB_NUM_NODES</td><td>节点数</td></tr><tr><td>$SLURM_JOB_NODELIST</td><td>节点列表</td></tr><tr><td>$SLURM_LOCALID</td><td>作业中流程的节点本地任务ID</td></tr><tr><td>$SLURM_ARRAY_TASK_ID</td><td>作业序列中的任务ID</td></tr><tr><td>$SLURM_SUBMIT_DIR</td><td>工作目录</td></tr><tr><td>$SLURM_SUBMIT_HOST</td><td>提交作业的主机名</td></tr></tbody></table></section><h3 data-tool="mdnice编辑器"><span></span><span>参考资料</span><span></span></h3><ul data-tool="mdnice编辑器"><li><section><p><a href="https://mp.weixin.qq.com/s?__biz=MzkwMjQxODQ5MA==&amp;mid=2247486092&amp;idx=2&amp;sn=1eb0b7d9efad0d8b50a468069ebd657c&amp;scene=21#wechat_redirect" data-linktype="2">Slurm集群使用基础</a></p></section></li><li><section><p>上交大的超算平台的手册（https://docs.hpc.sjtu.edu.cn/job/slurm.html）</p></section></li></ul></section><p><mp-style-type data-value="10000"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/Y3oVWEhgG_aNlOl_Z4KIhg",target="_blank" rel="noopener noreferrer">原文链接</a>
