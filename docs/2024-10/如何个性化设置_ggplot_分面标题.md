---
title: "如何个性化设置 ggplot 分面标题"
date: 2024-10-31T13:47:00Z
draft: ["false"]
tags: [
  "fetched",
  "生信杂货铺"
]
categories: ["Acdemic"]
---
如何个性化设置 ggplot 分面标题 by 生信杂货铺
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><h2 data-tool="mdnice编辑器"><span></span><span>分面标题设置</span><span></span></h2><pre data-tool="mdnice编辑器"><span></span><code><span>library</span>(tidyverse)<br></code></pre><p data-tool="mdnice编辑器">绘制分面图形</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: facet_wrap</span><br><br>p &lt;- ggplot(mpg, aes(displ, hwy)) + <br>    geom_point(aes(colour = factor(cyl))) +<br>    facet_wrap(vars(cyl)) +<br>    theme_bw()<br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016165" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJiagQDR1gbb4dVyougxMqHkYHu3oI0WMM2YF6Y2pcPPgbTCE4n2NoCOA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJiagQDR1gbb4dVyougxMqHkYHu3oI0WMM2YF6Y2pcPPgbTCE4n2NoCOA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">分面标题主要是由矩形对象和文本对象，主要设置的也是文字大小和背景填充色的形状。</p><p data-tool="mdnice编辑器">要给标题加上背景色以及修改文本格式，只能通过 <code>theme</code> 中设置 <code>strip</code> 相关属性值。例如</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: facet_wrap_color</span><br><br>p + theme(strip.background = element_rect(fill = <span>'lightblue'</span>),<br>          strip.text = element_text(size = <span>12</span>))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016164" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJypEnOqayt40a7HiaBbtjZMKd4fia9lte9MNTd3QnqKia0XKIGALzia7sCg/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJypEnOqayt40a7HiaBbtjZMKd4fia9lte9MNTd3QnqKia0XKIGALzia7sCg/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">只能修改为统一的格式。那能不能通过传递值向量来设置不同颜色呢</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: facet_wrap_multi_color</span><br><br><span># 定义颜色</span><br>new_colors &lt;- c(<span>"#5bc0de"</span>, <span>"#5cb85c"</span>, <span>"#f0ad4e"</span>, <span>'#d9534f'</span>)<br>p + theme(strip.background = element_rect(fill = new_colors),<br>          strip.text = element_text(size = 12))<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016166" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJw5LL4E6N0CoD32icf0icWzScJtXbbBjHQmLddCbFj5LVmvXibJpEOhaUw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJw5LL4E6N0CoD32icf0icWzScJtXbbBjHQmLddCbFj5LVmvXibJpEOhaUw/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">行不通，只用了第一个颜色。</p><p data-tool="mdnice编辑器">难道没办法了吗？可以有两种方法解决这一问题</p><h3 data-tool="mdnice编辑器"><span></span><span>暴力破解法</span><span></span></h3><p data-tool="mdnice编辑器">暴力方法是通过将 <code>ggplot</code> 图形对象转换成 <code>gtable</code> 结构，通过数据结构访问到标题属性，然后设置对应的属性值</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: facet_wrap_gtable</span><br><br><span># 转换成 gtable 对象</span><br>g &lt;- ggplotGrob(p)<br><span># 获取</span><br>strip_index &lt;- which(grepl(<span>"strip-t"</span>, g$layout$name))<br><span># 修改 strip 背景颜色</span><br><span>for</span> (i <span>in</span> seq_along(strip_index)) {<br>    <span># 设置颜色</span><br>    g$grobs[[strip_index[i]]]$grobs[[<span>1</span>]]$children[[<span>1</span>]]$gp$fill &lt;- new_colors[i]<br>    <span># 设置字体大小</span><br>    g$grobs[[strip_index[i]]]$grobs[[<span>1</span>]]$children[[<span>2</span>]]$children[[<span>1</span>]]$gp$fontsize &lt;- <span>12</span><br>}<br>grid::grid.newpage()<br>grid::grid.draw(g)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016167" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJ2cfhh7Jo0pfYicibrMbU3U9zLJSjXdhLLiczHOUQMakviajPicrWdVdpTcA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJ2cfhh7Jo0pfYicibrMbU3U9zLJSjXdhLLiczHOUQMakviajPicrWdVdpTcA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">可以使用 <code>grid</code> 包中的 <code>gpar</code> 函数来统一设置 <code>gp</code> 所有属性的值，而不是一个个设置，可以参考前面 <code>grid</code> 相关教程 <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkxMjE4NDc2Mw==&amp;mid=2247490833&amp;idx=1&amp;sn=84f06a1a31d8f7a2c0c5b9ac2e177e2d&amp;chksm=c11199c5f66610d3eb0d63e7c363257fc715fdd7afd93e1dfb00919c73a157ff634411d05fc3&amp;scene=21#wechat_redirect" textvalue="R 数据可视化 —— grid 系统（一）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">R 数据可视化 —— grid 系统（一）</a>和<a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzkxMjE4NDc2Mw==&amp;mid=2247490922&amp;idx=1&amp;sn=58821af025b159c3d089e97ed7a09d7b&amp;chksm=c11199bef66610a8b592b87f98271530e044b0e3cb550fb30dcad630058ed9c5297da5a932ed&amp;scene=21#wechat_redirect" textvalue="R 数据可视化 —— grid 系统（二）" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">R 数据可视化 —— grid 系统（二）</a>。</p><p data-tool="mdnice编辑器">对于这种行列充满的情况下，即分面的数量等于行数与列数的乘积（<code>2*2</code>）。如果是没有充满的情况下，例如</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: facet_wrap_odd</span><br><br>p &lt;- ggplot(mpg, aes(displ, hwy)) +<br>    geom_point(data = transform(mpg, class = NULL), colour = <span>"grey85"</span>) +<br>    geom_point(aes(colour = class), show.legend = FALSE) +<br>    facet_wrap(vars(class)) +<br>    theme_bw()<br>p<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016168" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJQAHxwNKjMPlexwK5bh4OcqAnwHVHaBzfwFId13icCkVGBdb9jgsDHgQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJQAHxwNKjMPlexwK5bh4OcqAnwHVHaBzfwFId13icCkVGBdb9jgsDHgQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">暴力法设置填充色</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: grid_facet_wrap_odd</span><br><br><br>new_colors &lt;- c(<span>"#1cc7d0"</span>, <span>"#2dde98"</span>, <span>"#ffc168"</span>, <span>"#ff6c5f"</span>,<br>                <span>"#ff4f81"</span>, <span>"#b84592"</span>, <span>"#8e43e7"</span>)<br><span># 转换成 gtable 对象</span><br>g &lt;- ggplotGrob(p)<br><span># 获取</span><br>strip_index &lt;- <span>which</span>(grepl(<span>"strip-t"</span>, g<span>$layout</span><span>$name</span>))<br><span># 修改 strip 背景颜色</span><br><span>for</span> (i <span>in</span> seq_along(strip_index)) {<br>    <span># 设置颜色</span><br>    g<span>$grobs</span>[[strip_index[i]]]<span>$grobs</span>[[1]]<span>$children</span>[[1]]<span>$gp</span><span>$fill</span> &lt;- new_colors[i]<br>    <span># 字体设置会报错</span><br>}<br>grid::grid.newpage()<br>grid::grid.draw(g)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016173" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJ7icanTxbP2qNFyS3zOYmpe5jQviarMPiaXhNepGMibk7xApUd5ich1UQTOA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJ7icanTxbP2qNFyS3zOYmpe5jQviarMPiaXhNepGMibk7xApUd5ich1UQTOA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">可以看到，有两个分面的填充色是空的。</p><p data-tool="mdnice编辑器">这是因为虽然只有 <code>7</code> 个分面，但还是会创建 <code>9</code> （<code>3*3</code>）个分面，后面两个为空。</p><pre data-tool="mdnice编辑器"><span></span><code>length(strip_index)<br></code></pre><p data-tool="mdnice编辑器">但是虽然我们看到是后面两个为空，但是它们的排列顺序并不是 <code>1-9</code>。我们可以查看一下分面的名称</p><pre data-tool="mdnice编辑器"><span></span><code>g$layout$name[strip_index]<br></code></pre><p data-tool="mdnice编辑器">可以看到，它们是以行列号（好像是先列后行）的形式命名的。</p><p data-tool="mdnice编辑器">猜测一下，后面两个对象应该是空对象</p><pre data-tool="mdnice编辑器"><span></span><code>idx &lt;- which(grepl(<span>"strip-t-2-3"</span>, g$layout$name))<br>g$grobs[[idx]]<br></code></pre><p data-tool="mdnice编辑器">所以只要判断是否为空对象即可，</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: facet_wrap_odd_right</span><br><br>new_colors &lt;- c(<span>"#1cc7d0"</span>, <span>"#2dde98"</span>, <span>"#ffc168"</span>, <span>"#ff6c5f"</span>,<br>                <span>"#ff4f81"</span>, <span>"#b84592"</span>, <span>"#8e43e7"</span>)<br><span># 转换成 gtable 对象</span><br>g &lt;- ggplotGrob(p)<br><span># 获取</span><br>strip_index &lt;- which(grepl(<span>"strip-t"</span>, g$layout$name))<br><span># 修改 strip 背景颜色</span><br>i &lt;- <span>1</span><br><span>for</span> (idx <span>in</span> strip_index) {<br>    <span>if</span> (inherits(g$grobs[[idx]], <span>"zeroGrob"</span>)) <span>next</span><br>    <span># 设置颜色</span><br>    g$grobs[[idx]]$grobs[[<span>1</span>]]$children[[<span>1</span>]]$gp$fill &lt;- new_colors[i]<br>    <span># 设置字体大小</span><br>    g$grobs[[idx]]$grobs[[<span>1</span>]]$children[[<span>2</span>]]$children[[<span>1</span>]]$gp$fontsize &lt;- <span>12</span><br>    i &lt;- i + <span>1</span><br>}<br>grid::grid.newpage()<br>grid::grid.draw(g)<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016169" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJLrVOpvCbMjzjFicPsJtQn1xxl2KlzHibUMyFicUXibXA8SqB5Usel08HbQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJLrVOpvCbMjzjFicPsJtQn1xxl2KlzHibUMyFicUXibXA8SqB5Usel08HbQ/640?wx_fmt=png&amp;from=appmsg"></figure><h3 data-tool="mdnice编辑器"><span></span><span>ggh4x</span><span></span></h3><p data-tool="mdnice编辑器"><code>ggh4x</code> 是 <code>ggplot2</code> 的扩展包。它提供了一些并不完全符合“图形语法”概念的实用功能。提供了更多定制化和灵活性，尤其是在处理复杂布局和图例时非常有用。</p><p data-tool="mdnice编辑器">安装导入</p><pre data-tool="mdnice编辑器"><span></span><code><span># install.packages(ggh4x)</span><br><span>library</span>(ggh4x)<br></code></pre><p data-tool="mdnice编辑器">这里，我们使用这个包提供的分面函数 <code>facet_wrap2</code> 以及矩阵列表 <code>elem_list_rect</code> 函数和字体列表函数 <code>elem_list_text</code></p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: facet_wrap2</span><br><br>ggplot(mpg, aes(displ, hwy)) +<br>    geom_point(data = transform(mpg, class = <span>NULL</span>), colour = <span>"grey85"</span>) +<br>    geom_point(aes(colour = class), show.legend = <span>FALSE</span>) +<br>    facet_wrap2(<br>        vars(class), <br>        strip = strip_nested(<br>            background_x = elem_list_rect(fill = new_colors),<br>            text_x = elem_list_text( <span># 字体大小随机</span><br>                size = sample(<span>12</span>:<span>16</span>, size = <span>7</span>, replace = <span>TRUE</span>)))<br>    ) +<br>    theme_bw()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016171" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJxjE6QuM0j2iaHYc1sFHvEEGaqaficnzxa0DVvMjDHicWvo4IjVibSwdtyQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJxjE6QuM0j2iaHYc1sFHvEEGaqaficnzxa0DVvMjDHicWvo4IjVibSwdtyQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器"><code>facet_grid2</code> 可用于设置网格形式的分面颜色</p><pre data-tool="mdnice编辑器"><span></span><code><span>#| label: facet_grid2</span><br><br>ggplot(mpg, aes(displ, hwy)) +<br>    geom_point(data = transform(mpg, class = <span>NULL</span>), colour = <span>"grey85"</span>) +<br>    geom_point() +<br>    facet_grid2(<br>        cyl ~ drv, axes = <span>"all"</span>,<br>        strip = strip_nested(<br>            background_x = elem_list_rect(fill = new_colors[<span>1</span>:<span>3</span>]),<br>            background_y = elem_list_rect(fill = new_colors[<span>3</span>:<span>7</span>]))<br>    ) +<br>    theme_bw()<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100016170" data-ratio="0.6179941002949852" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJhib7q1Um3C0QaAm5EgQQSJ9nCx9BfPQL3ibssGu6KOjw9tzIIS4RqJvQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1356" src="https://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKMrajRpTiacWam2u38zfsPJhib7q1Um3C0QaAm5EgQQSJ9nCx9BfPQL3ibssGu6KOjw9tzIIS4RqJvQ/640?wx_fmt=png&amp;from=appmsg"></figure><h2 data-tool="mdnice编辑器"><span></span><span>结尾</span><span></span></h2><hr data-tool="mdnice编辑器"><p data-tool="mdnice编辑器">所有文件、代码以及原始文档都上传到了知识星球，任何代码的问题都可以提问，自愿加入。</p><section><mp-common-profile data-pluginname="mpprofile" data-id="MzkxMjE4NDc2Mw==" data-headimg="http://mmbiz.qpic.cn/sz_mmbiz_png/R14BjDEcNWKgcIVlZ69OBM3mfiarb4tHc8aApGDf11AV6iaYYj6CRgf4VLzogibhDtdHo9JUfUZSt4errsCMNmtbg/0?wx_fmt=png" data-nickname="生信杂货铺" data-alias="comelove2020" data-signature="生物信息知识内容分享，学习笔记，资源分享，编程技巧" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><p data-tool="mdnice编辑器"><img data-imgfileid="100016172" data-ratio="1.5822222222222222" data-src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWKMrajRpTiacWam2u38zfsPJ834063IaHYfxzQqicMzYB0FATEicjGywcYmX6JWt1tibZmiazrQsGUgJLg/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1125" src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/R14BjDEcNWKMrajRpTiacWam2u38zfsPJ834063IaHYfxzQqicMzYB0FATEicjGywcYmX6JWt1tibZmiazrQsGUgJLg/640?wx_fmt=jpeg&amp;from=appmsg"></p></section><p><br></p><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/R6qdj0_wI3XTLnra5il2Qg",target="_blank" rel="noopener noreferrer">原文链接</a>
