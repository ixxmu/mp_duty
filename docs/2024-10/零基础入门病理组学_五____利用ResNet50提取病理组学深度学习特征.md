---
title: "零基础入门病理组学（五） | 利用ResNet50提取病理组学深度学习特征"
date: 2024-10-28T22:21:06Z
draft: ["false"]
tags: [
  "fetched",
  "生信作曲家"
]
categories: ["Acdemic"]
---
零基础入门病理组学（五） | 利用ResNet50提取病理组学深度学习特征 by 生信作曲家
------
<div><section><h3><span>前言</span></h3><blockquote><p><span></span><span></span><span></span><span><span></span><span><span></span><span><span></span><span><span><span></span><span><span>生信作曲家一直致力于构建国内<span><strong>和谐、开放、可持续</strong></span><strong>的生物信息交流平台</strong>。生信作曲家的目标是<strong>为每个科研人扫清科研路上的一切障碍，让生物信息学人人可做</strong>。目前，生信作曲家已推出<span><strong>"</strong><strong>跟着一区文章学通机器学习”、</strong><strong>"</strong><strong>跟着一区文章学通单细胞</strong><strong>"、"空间转录组从入门到精通”、孟德尔随机化实战”</strong><strong>、scFEA</strong><strong><strong>、</strong>NATMI、CIBERSORTx、hdWGCNA、cytotalk、metaVIPER算法</strong></span>等多种强力教程，同时也兼具数据整理、可视化等核心入门技术教学，开办<span><strong>空间转录组计划smrsp/sp、孟德尔随机化系列计划IM/MR）、临床数据库系列、肿瘤发文计划RS/max，非肿瘤发文计划note/ultra/pro</strong></span><strong>、暑期集训营和冬季集训营</strong>等多次。辅导同学实现纯生信SCI发表硕果累累，帮助同学实现医学事业路上的理想与追求。</span></span><span></span></span></span><span></span></span><span></span></span><span></span></span><span></span><span></span><span></span><span></span></p></blockquote><p><span>众所周知，病理组学作为新兴领域，已经逐步进入生信人的视野。病理学通过对组织样本的快捷制备（HE切片），能够为生物信息学提供更加</span><span><strong>紧密贴合临床数据、可转化的数据</strong></span><span>，特别是在</span><span><strong>临床可用</strong></span><span><strong>的早期诊断和预后</strong></span><span>！因为我们知道，测序数据用于临床诊断和预后实际上是具备局限性和理想化的，因为<strong>测序数据的经济性、质量控制、时效性等实际上均导致了其不太可能直接迅速用于临床诊断预后</strong>。但这恰恰是病理组学（或者是影像组学）的优势！<br></span></p><p><span><strong><span><br></span></strong></span></p><p><span>但是毫无疑问的是，</span><span><strong>病理组学的学习资源是匮乏的</strong></span><span>。<strong><br></strong></span></p><p><span><strong><br></strong></span></p><p><img data-galleryid="" data-imgfileid="100006733" data-ratio="1.1824074074074074" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibjTb0IFTt7PK0USSbyqVbUvtFktBvbm3PbFDB6YrwCJLRMlxjcHHEIA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibjTb0IFTt7PK0USSbyqVbUvtFktBvbm3PbFDB6YrwCJLRMlxjcHHEIA/640?wx_fmt=png&amp;from=appmsg"></p><p><span></span></p><p><span><br></span></p><p><span>今天，我们学习ResNet50。这是一种</span><span><strong>深度卷积神经网络</strong></span><span>，主要用于图像分类和特征提取。那么，</span><span><strong>为</strong></span><span><strong>什么ResNet50也要被我们学习</strong></span><span>，我们不是已经通过cellprofiler进行特征提取了嘛？</span></p><p>学习ResNet50的重要性在于它提供了另一种特征提取和分析的方式，尽管已经使用CellProfiler进行了特征提取。单resnet50为<span><strong>深度学习</strong></span>，<strong>深</strong>能够自动学习图像中的复杂特征，适应性强，通常能捕捉到CellProfiler可能未能识别的细微变化。</p><p><span></span></p></section><section><p><br></p><h3><span>代码实操</span></h3><p><span><strong><br></strong></span></p><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><p data-tool="mdnice编辑器">首先，我们需要安装一下必备的软件包。注意以下是在jupyter notebook中进行操作。前面的感叹号意为在终端中运行</p><figure data-tool="mdnice编辑器"><img data-imgfileid="100006749" data-ratio="0.45185185185185184" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibO4zdIufcJib7Epic4wjhtHwMOfSfZ0a1w1N7iarYpX0Uiak1TO7YzEGJTA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibO4zdIufcJib7Epic4wjhtHwMOfSfZ0a1w1N7iarYpX0Uiak1TO7YzEGJTA/640?wx_fmt=png&amp;from=appmsg"></figure><pre data-tool="mdnice编辑器"><span></span><code><span>#!pip install torch</span><br><span>#!pip install torchvision</span><br><span># cv2是OpenCV（Open Source Computer Vision Library）的Python接口</span><br><span>#!pip install opencv-python</span><br><span>#!pip install pandas</span><br><br>![](https://files.mdnice.com/user/<span>75769</span>/<span>72</span>d625da<span>-54</span>d9<span>-4</span>ba1-a170<span>-2970</span>a0791673.png)<br><br></code></pre><p data-tool="mdnice编辑器">载入需要的包</p><pre data-tool="mdnice编辑器"><span></span><code><br><span>import</span> torch<br>torch.manual_seed(<span>1314</span>)<br><span>from</span> torch <span>import</span> nn<br><span>import</span> torchvision.models <span>as</span> models<br><span>import</span> torchvision.transforms <span>as</span> transforms<br><span>import</span> cv2<br><br><span>import</span> tqdm<br><span>import</span> torch<br><span>import</span> torch.utils.data<br><span>import</span> torch.nn <span>as</span> nn<br><span>import</span> torchvision.transforms <span>as</span> transforms<br><span>from</span> PIL <span>import</span> Image<br><span>import</span> cv2<br><span>import</span> os<br><span>import</span> pandas <span>as</span> pd<br></code></pre><p data-tool="mdnice编辑器">定义提取工具函数</p><pre data-tool="mdnice编辑器"><span></span><code><span><span>class</span> <span>FeatureExtractor</span><span>(nn.Module)</span>:</span> <span># 提取特征工具</span><br>    <span><span>def</span> <span>__init__</span><span>(self, submodule, extracted_layers)</span>:</span><br>        super(FeatureExtractor, self).__init__()<br>        self.submodule = submodule<br>        self.extracted_layers = extracted_layers<br> <br>    <span><span>def</span> <span>forward</span><span>(self, x)</span>:</span><br>        outputs = []<br>        <span>for</span> name, module <span>in</span> self.submodule._modules.items():<br>            <span>if</span> name == <span>"fc"</span>: <br>                x = x.view(x.size(<span>0</span>), <span>-1</span>)<br>            x = module(x)<br>            <span>if</span> name <span>in</span> self.extracted_layers:<br>                outputs.append(x)<br>        <span>return</span> outputs<br><br><span>## 给出图片文件夹，注意，图片文件夹下是我们对每个样本进行histolab进行分割后的patch(小块），同时也可被称之为tile（瓦片）。</span><br><br>tile_PATH = <span>'/home/你的工作路径/processed_data_tile/'</span>  <span># 图片文件夹路径</span><br>files = os.listdir(tile_PATH )  <span># 获取文件夹中的文件列表</span><br>files<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006750" data-ratio="0.3111111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibPXibIKNT7hgiaRhrk3stcbhOL88GpGbUc9kEvJ8wQRPZko2Kr44p07ZA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibPXibIKNT7hgiaRhrk3stcbhOL88GpGbUc9kEvJ8wQRPZko2Kr44p07ZA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">如图所示，每个TCGA样本单独做一个文件夹，放切片<img data-imgfileid="100006751" data-ratio="0.4601851851851852" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibiaicIOglZqAjUjbC9kvOdTqPxWcjp6AZp96Js0vriadTXStjichCUSpIww/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibiaicIOglZqAjUjbC9kvOdTqPxWcjp6AZp96Js0vriadTXStjichCUSpIww/640?wx_fmt=png&amp;from=appmsg"></p><figure data-tool="mdnice编辑器"><img data-imgfileid="100006752" data-ratio="0.462037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyiboySMnDWicrUAB7hbsx1fN5t8qCgK4om0l97yK9S6AYWOCYhg5Td0AHA/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_jpg/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyiboySMnDWicrUAB7hbsx1fN5t8qCgK4om0l97yK9S6AYWOCYhg5Td0AHA/640?wx_fmt=jpeg&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">接下来获取文件列表</p><pre data-tool="mdnice编辑器"><span></span><code><span>import</span> os<br><br><span><span>def</span> <span>fetch_image_paths</span><span>(directory)</span>:</span><br>    image_files = []<br>    <span># os.walk返回三个值：目录路径、目录名列表、文件名列表</span><br>    <span>for</span> dirpath, dirnames, files <span>in</span> os.walk(directory):<br>        <span>for</span> file <span>in</span> files:<br>            <span># 使用os.path.join连接目录路径与文件名，得到完整的文件路径</span><br>            full_path = os.path.join(dirpath, file)<br>            <span># 检查文件是否是一个图片</span><br>            <span>if</span> full_path.endswith((<span>'.png'</span>, <span>'.jpg'</span>, <span>'.jpeg'</span>)):<br>                <span># 将图片路径添加到列表中</span><br>                image_files.append(full_path)<br>    <span>return</span> image_files<br><br>dir_to_search = tile_PATH   <span># 你的根目录</span><br>image_paths = fetch_image_paths(dir_to_search)<br><br>image_paths<br></code></pre><p data-tool="mdnice编辑器">获取结果如图所示<img data-imgfileid="100006753" data-ratio="0.32592592592592595" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibajrVABHpAdOfo92Dg9boqoRUeQicY9iaLeITrqsqJw9o4DVUhAwoUniaA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibajrVABHpAdOfo92Dg9boqoRUeQicY9iaLeITrqsqJw9o4DVUhAwoUniaA/640?wx_fmt=png&amp;from=appmsg"></p><p data-tool="mdnice编辑器">接下来生成模型我们调用GPU（cuba)，让resnet50运行更快</p><pre data-tool="mdnice编辑器"><span></span><code><br>model = models.resnet50(pretrained=<span>True</span>) <span># 加载resnet50工具,首次需要下载</span><br>model = model.cuda()<br>model.eval()<br>data = {}  <span># 初始化数据字典，其中键将是文件路径，值将是特征</span><br><br><br><span># model3 = FeatureExtractor(model, ['layer3']) # 指定提取 layer3 层特征</span><br>model4 = FeatureExtractor(model, [<span>'layer4'</span>]) <span># 指定提取 layer4 层特征</span><br><br>transform = transforms.Compose([<br>    transforms.ToTensor(),<br>    transforms.Normalize((<span>0.5</span>, <span>0.5</span>, <span>0.5</span>), (<span>0.5</span>, <span>0.5</span>, <span>0.5</span>))])<br></code></pre><p data-tool="mdnice编辑器">接下来应用模型</p><pre data-tool="mdnice编辑器"><span></span><code><span>from</span> tqdm <span>import</span> tqdm<br><span>import</span> numpy <span>as</span> np<br><span>for</span> filename <span>in</span> tqdm(image_paths, desc=<span>"Processing images"</span>):<br>    img_path = os.path.join(filename)<br>    img = cv2.imread(img_path)<br><br>    img = cv2.resize(img, (<span>224</span>, <span>224</span>)) <span>## 缩放</span><br>    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)<br><br>    img = transform(img).cuda()<br>    img = img.unsqueeze(<span>0</span>)<br><br>    <span>with</span> torch.no_grad():<br>        out = model4(img)<br>        features = out[<span>0</span>].squeeze().cpu().numpy()<br>        max_values = np.amax(features, axis=(<span>1</span>,<span>2</span>))<br>        <span># max_values现在是一个14x14的矩阵，其中的每个元素是对应位置上1024个元素中的最大值</span><br>        <span># print(max_values.shape)</span><br>        <span># print(features.shape)</span><br>        <span># feature_reshaped = features.reshape(1, -1)[0]</span><br><br>        data[img_path] = max_values<br>print(<span>"finished"</span>)<br><br>data<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006742" data-ratio="0.337037037037037" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyib6XBQCOdwTvqiaEBnC4JfM3SIVo34yZeS4GwQY2Das9eSq2nDib7NqquA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyib6XBQCOdwTvqiaEBnC4JfM3SIVo34yZeS4GwQY2Das9eSq2nDib7NqquA/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">输出结果</p><pre data-tool="mdnice编辑器"><span></span><code><span># 将数据字典转换为DataFrame</span><br>feature_data = pd.DataFrame.from_dict(data, orient=<span>'index'</span>)<br><br><span># 查看DataFrame的基本信息（可选）</span><br>print(feature_data.head())<br>print(feature_data.shape)<br><br><span># 输出DataFrame</span><br>feature_data<br></code></pre><figure data-tool="mdnice编辑器"><img data-imgfileid="100006743" data-ratio="0.4861111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibljHkR6FqgfqcSApbvBGWab7KrF8m1FJKSPUaibN5ibIJ4P3py3zxfsGQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDibqhY1iaLDia5plqQSWiajkyibljHkR6FqgfqcSApbvBGWab7KrF8m1FJKSPUaibN5ibIJ4P3py3zxfsGQ/640?wx_fmt=png&amp;from=appmsg"></figure><p data-tool="mdnice编辑器">保存结果</p><pre data-tool="mdnice编辑器"><span></span><code>output_path = <span>'/home/你的工作路径/resnet.csv'</span><br>feature_data.to_csv(output_path, index=<span>True</span>)  <span># index=True表示保存索引列</span><br></code></pre></section><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com"><span></span><p><span> <br><br></span></p></section><h3><span>写在后面</span></h3><p><br></p><p><span><span>关注作曲家公众号，和作曲家一起学习交流</span></span><span><strong>规范的</strong></span><span><span>病理组学。<br></span></span></p><p><br><span><span></span></span></p><p>当然，部分病理组学的内容最好<span><strong>还是用GPU加速</strong></span>，让大家的提取特征更加高效！</p><p><br></p><blockquote data-type="1" data-url="http://mp.weixin.qq.com/s?__biz=MzI5ODI0NzM2OQ==&amp;mid=2247490332&amp;idx=1&amp;sn=c5ec7768ef1650e9ffeedadde7db93ee&amp;chksm=eca9eebadbde67aca0a074888154b0ff0a0af251a61ef7398f91e8ead6057ac90e15c431bad4#rd" data-author-name="Bioinfo composer" data-content-utf8-length="11" data-source-title="GPU加持的自研音序云服务器，看看用户评价如何？"><section><p>作曲家服务器拥有GPU</p></section><section data-json="%7B%22type%22%3A%22inner%22%2C%22source%22%3A%22biz%22%2C%22digest%22%3A%22%3Cp%3E%E4%BD%9C%E6%9B%B2%E5%AE%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8B%A5%E6%9C%89GPU%3C%2Fp%3E%22%2C%22digestLen%22%3A11%2C%22text%22%3A%22%22%2C%22article%22%3A%7B%22title%22%3A%22GPU%E5%8A%A0%E6%8C%81%E7%9A%84%E8%87%AA%E7%A0%94%E9%9F%B3%E5%BA%8F%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E7%9C%8B%E7%9C%8B%E7%94%A8%E6%88%B7%E8%AF%84%E4%BB%B7%E5%A6%82%E4%BD%95%EF%BC%9F%22%2C%22url%22%3A%22http%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI5ODI0NzM2OQ%3D%3D%26mid%3D2247490332%26idx%3D1%26sn%3Dc5ec7768ef1650e9ffeedadde7db93ee%26chksm%3Deca9eebadbde67aca0a074888154b0ff0a0af251a61ef7398f91e8ead6057ac90e15c431bad4%23rd%22%2C%22nickname%22%3A%22%E7%94%9F%E4%BF%A1%E4%BD%9C%E6%9B%B2%E5%AE%B6%22%2C%22authorName%22%3A%22Bioinfo%20composer%22%7D%2C%22hasReportOverSize%22%3Afalse%2C%22editorReportData%22%3A%5B%7B%22id%22%3A%22122333%22%2C%22key%22%3A%2278%22%2C%22len%22%3A1%7D%5D%7D"><span>Bioinfo composer，公众号：生信作曲家<a href="http://mp.weixin.qq.com/s?__biz=MzI5ODI0NzM2OQ==&amp;mid=2247490332&amp;idx=1&amp;sn=c5ec7768ef1650e9ffeedadde7db93ee&amp;chksm=eca9eebadbde67aca0a074888154b0ff0a0af251a61ef7398f91e8ead6057ac90e15c431bad4#rd">GPU加持的自研音序云服务器，看看用户评价如何？</a></span></section></blockquote><p><br></p><p><br></p><p><span>                       </span><img data-cropselx1="0" data-cropselx2="307" data-cropsely1="0" data-cropsely2="307" data-galleryid="" data-imgfileid="100006542" data-ratio="1" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaB9Vq4TQbMtR81HOfuhy7jkZsUypgwNYHTiaEFuvXNqI8z2nlDYc7tbrJ4o7W7dAgqRQPp2lDqfLbA/640?wx_fmt=png" data-type="png" data-w="512" src="https://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaB9Vq4TQbMtR81HOfuhy7jkZsUypgwNYHTiaEFuvXNqI8z2nlDYc7tbrJ4o7W7dAgqRQPp2lDqfLbA/640?wx_fmt=png"></p><p><br></p><p><br></p><p><span>关注作曲家公众号，接收更多病理组学相关推送<br></span></p><p><br></p></section><section><mp-common-profile data-pluginname="mpprofile" data-id="MzI5ODI0NzM2OQ==" data-headimg="http://mmbiz.qpic.cn/mmbiz_png/mo60jlFOtaDQIG3BiaPDOAtTJDzqbyPp4crVHnib8fS6Gp6DMjvJJkK9bhPWe6wpNujV93n60FymcjAOfum0t9PA/0?wx_fmt=png" data-nickname="生信作曲家" data-alias="Bioinfo_composer" data-signature="交流生物信息学习经验，分享科研SCI撰写思路和规范，传递最新生物医药资讯。" data-from="0" data-is_biz_ban="0"></mp-common-profile></section><section><br></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/6GUNTz5nQ2oPNYLJRDYxYQ",target="_blank" rel="noopener noreferrer">原文链接</a>
