---
title: "å¦‚ä½•ä½¿ç”¨Celltypistå»ºç«‹å±äºè‡ªå·±çš„æ¨¡å‹"
date: 2023-10-29T00:45:59Z
draft: ["false"]
tags: [
  "fetched",
  "ç”Ÿä¿¡éšç¬”"
]
categories: ["Acdemic"]
---
å¦‚ä½•ä½¿ç”¨Celltypistå»ºç«‹å±äºè‡ªå·±çš„æ¨¡å‹ by ç”Ÿä¿¡éšç¬”
------
<div><section data-tool="mdniceç¼–è¾‘å™¨" data-website="https://www.mdnice.com"><p data-tool="mdniceç¼–è¾‘å™¨">ä½¿ç”¨Celltypistå»ºç«‹å±äºè‡ªå·±çš„å•ç»†èƒlabel transferæ¨¡å‹ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">Celltypist toolæ–‡ç« å‘è¡¨åœ¨scienceæœŸåˆŠä¸Šï¼Œã€ŠCross-tissue immune cell analysis reveals tissue-specific features in humansã€‹ï¼ŒDOI: <span>10.1126/science.abl5197</span></p><p data-tool="mdniceç¼–è¾‘å™¨">å®˜ç½‘é“¾æ¥ï¼šCellTypist | automated cell type annotation for scRNA-seq datasets</p><p data-tool="mdniceç¼–è¾‘å™¨">å¦‚ä½•ä½¿ç”¨Celltypistè¿›è¡Œç»†èƒé¢„æµ‹ï¼Œè¯·çœ‹Ph.D. Zhaoçš„ä¼˜ç§€æ¨æ–‡</p><p data-tool="mdniceç¼–è¾‘å™¨"><a href="https://mp.weixin.qq.com/s?__biz=Mzg5MjcxNzg1NA==&amp;mid=2247484838&amp;idx=1&amp;sn=d02d0ee3daaa0ea69cfbfd11b9fde844&amp;scene=21#wechat_redirect" data-linktype="2">Celltypistï¼šè¶…è¶ŠsingleRçš„å•ç»†èƒæ³¨é‡Šå·¥å…·</a></p><h2 data-tool="mdniceç¼–è¾‘å™¨"><span></span><span>1. ç¯å¢ƒéƒ¨ç½²</span><span> </span></h2><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>condaÂ activateÂ celltypist_envÂ <span>#è¿›å…¥ä¸“é—¨çš„ç¯å¢ƒÂ </span><br>pipÂ installÂ celltypistÂ Â <span>#UsingÂ pipÂ </span><br><span>#Â æˆ–è€…</span><br>condaÂ installÂ -cÂ biocondaÂ -cÂ conda-forgeÂ celltypistÂ <span>#UsingÂ condaÂ </span><br></code></pre><h2 data-tool="mdniceç¼–è¾‘å™¨"><span></span><span>2. Python ç‰ˆæœ¬</span><span> </span></h2><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code><span>import</span>Â osÂ <br><span>import</span>Â scanpyÂ <span>as</span>Â sc<br><span>import</span>Â pandasÂ <span>as</span>Â pd<br><span>import</span>Â celltypist<br><span>from</span>Â celltypistÂ <span>import</span>Â models<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">è®¾ç½®å·¥ä½œè·¯å¾„</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>os.chdir(<span>"//groups//chencp/project/18PDAC_Atlas/data/seq/DISCO_python/"</span>)Â <br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">åŠ è½½æ•°æ®å¹¶ç®€å•å¤„ç†</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>adata_modelÂ =Â sc.read(<span>'CRX030763.h5ad'</span>)<br>sc.pp.normalize_total(adata_model,Â target_sumÂ =Â <span>1e4</span>)<br>sc.pp.log1p(adata_model)<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">çœ‹ä¸‹æ•°æ®å¤„ç†ç»“æœ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>adata_model.X.expm1().sum(axisÂ =Â <span>1</span>)[:<span>10</span>]<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>matrix([[10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.]])<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">å†çœ‹ä¸‹æ•°æ®æƒ…å†µ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>adata_model<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>AnnDataÂ objectÂ withÂ n_obsÂ Ã—Â n_varsÂ =Â 7379Â Ã—Â 33538<br>Â Â Â Â obs:Â <span>'orig.ident'</span>,Â <span>'nCount_RNA'</span>,Â <span>'nFeature_RNA'</span>,Â <span>'percent.mt'</span>,Â <span>'RNA_snn_res.0.8'</span>,Â <span>'seurat_clusters'</span>,Â <span>'cell.type'</span>,Â <span>'cell.type.score'</span>,Â <span>'sampling.weight'</span><br>Â Â Â Â var:Â <span>'vst.mean'</span>,Â <span>'vst.variance'</span>,Â <span>'vst.variance.expected'</span>,Â <span>'vst.variance.standardized'</span>,Â <span>'vst.variable'</span>,Â <span>'gene'</span><br>Â Â Â Â uns:Â <span>'neighbors'</span>,Â <span>'log1p'</span><br>Â Â Â Â obsm:Â <span>'X_pca'</span>,Â <span>'X_umap'</span><br>Â Â Â Â varm:Â <span>'PCs'</span><br>Â Â Â Â obsp:Â <span>'distances'</span><br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">å¼€å§‹å»ºç«‹æ¨¡å‹</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>new_modelÂ =Â celltypist.train(adata_model,Â labelsÂ =Â <span>'cell.type'</span>,Â n_jobsÂ =Â <span>10</span>,Â feature_selectionÂ =Â <span>True</span>)<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>ğŸ³Â PreparingÂ dataÂ beforeÂ training<br>âœ‚ï¸Â 8330Â non-expressedÂ genesÂ areÂ filteredÂ out<br>ğŸ”¬Â InputÂ dataÂ hasÂ 7379Â cellsÂ andÂ 25208Â genes<br>âš–ï¸Â ScalingÂ inputÂ data<br>ğŸ‹ï¸Â TrainingÂ dataÂ usingÂ SGDÂ logisticÂ regression<br>ğŸ”Â SelectingÂ features<br>ğŸ§¬Â 3575Â featuresÂ areÂ selected<br>ğŸ‹ï¸Â StartingÂ theÂ secondÂ roundÂ ofÂ training<br>ğŸ‹ï¸Â TrainingÂ dataÂ usingÂ logisticÂ regression<br>âœ…Â ModelÂ trainingÂ <span>done</span>!<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">7379 ç»†èƒï¼Œ 25208 åŸºå› ï¼Œä»ä¸­æŒ‘é€‰3575ç‰¹å¾è®­ç»ƒæ¨¡å‹ï¼Œæ—¶é—´å¤§æ¦‚æ˜¯3åˆ†é’Ÿå·¦å³ï¼Œ</p><p data-tool="mdniceç¼–è¾‘å™¨">å…¶ä¸­æåˆ°çš„ <code>SGD logistic regression</code>æ¨¡å‹ï¼ŒGPTç»™å‡ºçš„è§£é‡Šæ˜¯ï¼Œ</p><blockquote data-tool="mdniceç¼–è¾‘å™¨"><p>SGD Logistic Regression is a machine learning model for binary classification, where it predicts one of two possible outcomes based on input features. It utilizes a logistic function to map input features to a probability value between 0 and 1, representing the likelihood of belonging to the first category. Training this model involves adjusting parameters using the stochastic gradient descent (SGD) optimization algorithm, making it suitable for large-scale datasets.</p></blockquote><p data-tool="mdniceç¼–è¾‘å™¨">å¤§ä½“æ„æ€æ˜¯è¯´ï¼Œè¿™ä¸ªé€»è¾‘å›å½’æ¨¡å‹æ˜¯ä¸€ç§ç”¨äºäºŒå…ƒåˆ†ç±»é—®é¢˜çš„æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œä½¿ç”¨é€»è¾‘å‡½æ•°æ¥å°†è¾“å…¥ç‰¹å¾æ˜ å°„åˆ°ä¸€ä¸ªä»‹äº0å’Œ1ä¹‹é—´çš„æ¦‚ç‡å€¼ï¼Œè€Œè¿™ä¸ªæ¦‚ç‡å€¼è¡¨ç¤ºæŸä¸ªæ ·æœ¬å±äºç¬¬ä¸€ä¸ªç±»åˆ«çš„å¯èƒ½æ€§ã€‚é€šè¿‡è°ƒä¸æ–­è°ƒæ•´æ¨¡å‹å‚æ•°ï¼Œç›´åˆ°è¾¾åˆ°æ”¶æ•›æ¡ä»¶çš„ç‰¹ç‚¹ä½¿å¾—æ¨¡å‹èƒ½å¤Ÿé€æ­¥é€‚åº”ä¸åŒçš„æ•°æ®ç‚¹ï¼Œç‰¹åˆ«é€‚ç”¨äºå¤§è§„æ¨¡æ•°æ®é›†ã€‚</p><p data-tool="mdniceç¼–è¾‘å™¨">ä¿å­˜æ¨¡å‹æ–¹ä¾¿ä»¥åä½¿ç”¨</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>new_model.write(<span>'celltypist_demo_folder/model_pdac.pkl'</span>)<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">å†æ¬¡åŠ è½½ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>new_modelÂ =Â models.Model.load(<span>'celltypist_demo_folder/model_pdac.pkl'</span>)<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">çœ‹ä¸‹æ¨¡å‹æƒ…å†µ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>new_model<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">åŠ è½½æµ‹è¯•æ•°æ®å¹¶ç®€å•å¤„ç†ï¼Œ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>adata_test.rawÂ =Â adata_test<br>sc.pp.normalize_total(adata_test,Â target_sumÂ =Â <span>1e4</span>)<br>sc.pp.log1p(adata_test)<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">åŒæ ·çœ‹ä¸‹æ•°æ®å¤„ç†ç»“æœï¼Œ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>adata_test.X.expm1().sum(axisÂ =Â <span>1</span>)<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>matrix([[10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â ...,<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.],<br>Â Â Â Â Â Â Â Â [10000.]])<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">ç”»å¼ ç‚¹å›¾çœ‹ä¸‹è¡¨è¾¾æƒ…å†µï¼Œ</p><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-ratio="0.4888888888888889" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHUYexdh27wvhhFCwmMWT6JKX5OicWmVIgyicVKUq3Q1phRUicEFiaRsb6Hg/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHUYexdh27wvhhFCwmMWT6JKX5OicWmVIgyicVKUq3Q1phRUicEFiaRsb6Hg/640?wx_fmt=png"><figcaption>image-20231017115458656</figcaption></figure><p data-tool="mdniceç¼–è¾‘å™¨">è¿›è¡Œé¢„æµ‹ï¼Œå¦‚æœä¹‹å‰æ²¡æœ‰åŠ è½½æ¨¡å‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨è¿™å¼•ç”¨ï¼Œ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>predictionsÂ =Â celltypist.annotate(adata_test,Â modelÂ =Â <span>'celltypist_demo_folder/model_pdac.pkl'</span>,Â majority_votingÂ =Â <span>True</span>,Â modeÂ =Â <span>'probÂ match'</span>,Â p_thresÂ =Â <span>0.5</span>)<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">å°†é¢„æµ‹åŠ è½½åˆ°ç»“æœä¸­å¹¶ç”»å›¾</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>adata_testÂ =Â predictions.to_adata(insert_probÂ =Â <span>True</span>)<br>sc.pl.umap(adata_test,Â colorÂ =Â [<span>'cell.type'</span>,Â <span>'majority_voting'</span>],Â legend_locÂ =Â <span>'onÂ data'</span>)<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><figcaption><br></figcaption><p><img data-galleryid="" data-ratio="0.3731481481481482" data-s="300,640" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHA1o4fbiamGlFKl6mu1e2rfaLUVC5dHUksIhZicUK28MSRq2x5JiczPicRQ/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHA1o4fbiamGlFKl6mu1e2rfaLUVC5dHUksIhZicUK28MSRq2x5JiczPicRQ/640?wx_fmt=png"></p><figcaption><br></figcaption></figure><p data-tool="mdniceç¼–è¾‘å™¨">çœ‹ä¸‹è¯¦ç»†æƒ…å†µï¼Œ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>cross_tabÂ =Â pd.crosstab(adata_test.obs[<span>'cell.type'</span>],Â adata_test.obs[<span>'majority_voting'</span>])<br>cross_tab<br></code></pre><figure data-tool="mdniceç¼–è¾‘å™¨"><img data-ratio="0.46944444444444444" data-src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHTOYkxSlCO1ufsjfxBbVzW2T5Ve4Bn0hC3WVnBxnc85jQHfMyvYTM3g/640?wx_fmt=png" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/sz_mmbiz_png/9LgsctS2IfE1y7ibVRxNY5oUPEVicE3xUHTOYkxSlCO1ufsjfxBbVzW2T5Ve4Bn0hC3WVnBxnc85jQHfMyvYTM3g/640?wx_fmt=png"><figcaption>image-20231017120220216</figcaption></figure><p data-tool="mdniceç¼–è¾‘å™¨">å› ä¸ºcelltypeéå®Œå…¨é‡å ï¼Œä¸”ç»†èƒæ•°é‡æœ‰é™ï¼Œä½†å¯è§æ¨¡å‹æ€»ä½“é¢„æµ‹ç»“æœè¿˜æ˜¯æŒºå¥½çš„ï¼Œå°¤å…¶æ˜¯é¢„æµ‹PDACè‚¿ç˜¤ç»†èƒã€‚</p><h2 data-tool="mdniceç¼–è¾‘å™¨"><span></span><span>3. Rç‰ˆæœ¬çš„å°è¯•</span><span> </span></h2><p data-tool="mdniceç¼–è¾‘å™¨">åŠ è½½ç¯å¢ƒ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code><span>require</span>(Seurat)<br><span>require</span>(data.table)<br><span>library</span>(reticulate)<br>use_condaenv(<span>"celltypist_env"</span>)<br>scanpyÂ =Â import(<span>"scanpy"</span>)<br>celltypistÂ =Â import(<span>"celltypist"</span>)<br>pandasÂ &lt;-Â import(<span>"pandas"</span>)<br>numpyÂ =Â import(<span>"numpy"</span>)<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>setwd(<span>"//groups//chencp/project/18PDAC_Atlas/data/seq/DISCO_python/"</span>)Â <br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">å°†ä¸Šé¢çš„h5adå¯¹è±¡è½¬æ¢æˆrdsåï¼Œè¯»è¿›Rï¼Œ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>adata_modelÂ =Â readRDS(<span>'CRX030763.rds'</span>)<br>adata_testÂ =Â readRDS(<span>'CRX030762.rds'</span>)<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ï¼Œ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>&gt;Â adata_test<br>AnÂ objectÂ ofÂ classÂ SeuratÂ <br>33538Â featuresÂ acrossÂ 2818Â samplesÂ withinÂ 1Â assayÂ <br>ActiveÂ assay:Â RNAÂ (33538Â features,Â 2000Â variableÂ features)<br>Â 2Â dimensionalÂ reductionsÂ calculated:Â pca,Â umap<br>&gt;Â adata_model<br>AnÂ objectÂ ofÂ classÂ SeuratÂ <br>33538Â featuresÂ acrossÂ 7379Â samplesÂ withinÂ 1Â assayÂ <br>ActiveÂ assay:Â RNAÂ (33538Â features,Â 2000Â variableÂ features)<br>Â 2Â dimensionalÂ reductionsÂ calculated:Â pca,Â umap<br></code></pre><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>new_modelÂ =Â celltypist$train(adata_model,Â labelsÂ =Â <span>'cell.type'</span>,Â n_jobsÂ =Â <span>10</span>,Â feature_selectionÂ =Â <span>T</span>)<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">åœ¨è¿›è¡Œæ­¤æ­¥éª¤æ—¶ï¼Œ</p><pre data-tool="mdniceç¼–è¾‘å™¨"><span></span><code>AnÂ objectÂ ofÂ classÂ SeuratÂ <br>33538Â featuresÂ acrossÂ 7379Â samplesÂ withinÂ 1Â assayÂ <br>ActiveÂ assay:Â RNAÂ (33538Â features,Â 2000Â variableÂ features)<br>Â 2Â dimensionalÂ reductionsÂ calculated:Â pca,Â umap<br>ErrorÂ <span>in</span>Â py_call_impl(callable,Â dots<span>$args</span>,Â dots<span>$keywords</span>)Â :Â <br>Â Â EvaluationÂ error:Â UnableÂ toÂ convertÂ RÂ objectÂ toÂ PythonÂ <span>type</span>.<br></code></pre><p data-tool="mdniceç¼–è¾‘å™¨">æ˜¾ç¤ºåœ¨å°†æ¨¡å‹è½¬æ¢æˆRå¯¹è±¡å‡ºäº†é”™è¯¯ï¼Œçœ‹æ¥å¦‚æœè¦ä½¿ç”¨Rç‰ˆæœ¬å°±éœ€è¦é‡æ–°æ”¹å†™æ•´ä¸ªpythonåŒ…äº†ã€‚</p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/-Y9q6xC9LE1rlWU1xJ3ZEw",target="_blank" rel="noopener noreferrer">åŸæ–‡é“¾æ¥</a>
