---
title: "张泽民院士的这篇nature生信文章，审稿人会提问那些技术性问题，明明14是更好的，为什么却选择12个模块"
date: 2025-05-30T00:07:24Z
draft: ["false"]
tags: [
  "fetched",
  "生信钱同学"
]
categories: ["Acdemic"]
---
张泽民院士的这篇nature生信文章，审稿人会提问那些技术性问题，明明14是更好的，为什么却选择12个模块 by 生信钱同学
------
<div><section><span leaf=""><span textstyle="">昨天刚介绍完张泽民老师新发的那篇nature，还是有很多技术上的细节在和大家分享下，这篇文章可以学习的地方非常多，后面有时间慢慢介绍。</span></span></section><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=Mzk0MjcyMDk3Mg==&amp;mid=2247484812&amp;idx=1&amp;sn=c56d8ec6dca9795d686346665c2e9a11&amp;scene=21#wechat_redirect" textvalue="真强，张泽民院士在重庆医科大又发篇nature，单细胞大图谱，代码全看开" data-itemshowtype="0" linktype="text" data-linktype="2">真强，张泽民院士在重庆医科大又发篇nature，单细胞大图谱，代码全看开</a></span><a href="https://mp.weixin.qq.com/s?__biz=Mzk0MjcyMDk3Mg==&amp;mid=2247484812&amp;idx=1&amp;sn=c56d8ec6dca9795d686346665c2e9a11&amp;scene=21#wechat_redirect" imgurl="http://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6laCLSqRicicibcibEVufRQpwYxjwozMBb4fr2SKgY2YjSguZOJUOydero6A/0?wx_fmt=jpeg" linktype="image" tab="innerlink" data-itemshowtype="0" target="_blank" data-linktype="1"><span><img data-ratio="0.9013961605584643" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6laCLSqRicicibcibEVufRQpwYxjwozMBb4fr2SKgY2YjSguZOJUOydero6A/640?wx_fmt=jpeg" data-w="2292" src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6laCLSqRicicibcibEVufRQpwYxjwozMBb4fr2SKgY2YjSguZOJUOydero6A/640?wx_fmt=jpeg"></span></a></section><section><span leaf=""><span textstyle="">审稿人提问了有关</span><a topic-id="mb9kcbwf-ax6zbg" data-topic="1"><span textstyle="">#非负矩阵分解</span></a><span textstyle="">（NMF）模块数量的选择的问题：</span></span><span data-pm-slice="0 0 []"><span leaf=""><span textstyle="">为何选择 12 个细胞模块（CMs）而非补充材料图 S7A 中显示的 k=14 这一更稳定的解决方案：</span></span></span></section><section nodeleaf=""><img data-imgfileid="100010037" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6ldUjT0FObrqrUcPm0asU69NXAnzu4gzUzia09Xx6hY1RAmLIHWgJsUfg/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" type="block" src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6ldUjT0FObrqrUcPm0asU69NXAnzu4gzUzia09Xx6hY1RAmLIHWgJsUfg/640?wx_fmt=jpeg&amp;from=appmsg"></section><section nodeleaf=""><img data-imgfileid="100010038" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6l5hibNNEExYmRh4rtmr7C9QPe8Oarfb2g2UnYsxkicQaeTmQicxNcPEHcw/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" type="block" src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6l5hibNNEExYmRh4rtmr7C9QPe8Oarfb2g2UnYsxkicQaeTmQicxNcPEHcw/640?wx_fmt=jpeg&amp;from=appmsg"></section><section><span leaf=""><span textstyle="">看看作</span></span><span leaf=""><span textstyle="">者的回复：</span></span></section><h3 xmlns="http://www.w3.org/1999/xhtml" data-pm-slice="0 0 []"><strong><span leaf=""><span textstyle="">NMF 秩选择的标准</span></span></strong></h3><ul><li><section><span leaf=""><span textstyle="">作者使用</span></span><strong><span leaf=""><span textstyle="">cophenetic correlation coefficient（CCC）</span></span></strong><span leaf=""><span textstyle=""> 来评估 NMF（非负矩阵分解）的最优秩，该系数用于衡量聚类的稳定性（值越接近 1 表示稳定性越高）。</span></span></section></li><li><section><span leaf=""><span textstyle="">尽管 k=14 的 CCC 值略高，但作者同时考虑了</span></span><strong><span leaf=""><span textstyle="">CCC 的连续性变化</span></span></strong><span leaf=""><span textstyle="">。k=12 时，CCC 呈现连续递增趋势（</span></span><span data-custom-copy-text="\(CCC_{10} &lt; CCC_{11} &lt; CCC_{12}\)"><span leaf=""><span textstyle="">CCC10 &lt; CCC11&lt; CCC12</span></span></span><span leaf=""><span textstyle="">），而 k=14 时 CCC 的变化不连续（</span></span><span data-custom-copy-text="\(CCC_{12} &gt; CCC_{13} &lt; CCC_{14}\)"><span leaf=""><span textstyle="">CCC12 &gt; CCC13&lt; CCC14</span></span></span><span leaf=""><span textstyle="">），不符合 “连续递增” 的稳定性标准。</span></span></section></li></ul><ul><li><section><span leaf=""><span textstyle="">最优秩的选择需同时满足 CCC 最大化和连续性递增”，最终 k=12 在稳定性和生物学合理性之间取得平衡。</span></span></section></li></ul><section><span leaf=""><br></span></section><section><span leaf=""><span textstyle="">这是我们自己做的生信服务器，独享资源，专门给咱们做生信的人配的，感兴趣的可以了解下</span></span></section><section><span leaf=""><a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzkwMzY2NjkwNg==&amp;mid=2247493682&amp;idx=1&amp;sn=b3a6a9bc2bc6dd8a028c81a0fb593852&amp;scene=21#wechat_redirect" textvalue="当前服务器不好用，咱就自己造，我们一定要让大家生信学习的门槛降到最低" data-itemshowtype="0" linktype="text" data-linktype="2"><span textstyle="">当前服务器不好用，咱就自己造，我们一定要让大家生信学习的门槛降到最低</span></a></span></section><section><a href="https://mp.weixin.qq.com/s?__biz=MzkwMzY2NjkwNg==&amp;mid=2247493682&amp;idx=1&amp;sn=b3a6a9bc2bc6dd8a028c81a0fb593852&amp;scene=21#wechat_redirect" imgurl="http://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6lKdhgel6gbiaZxccqpUffztuq0zbKf5gicKkrD9b6PJAbjHL79ARrTYWQ/0?wx_fmt=jpeg" linktype="image" tab="innerlink" data-itemshowtype="0" target="_blank" data-linktype="1"><span><img data-ratio="0.3880248833592535" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6lKdhgel6gbiaZxccqpUffztuq0zbKf5gicKkrD9b6PJAbjHL79ARrTYWQ/640?wx_fmt=jpeg" data-w="2572" src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6lKdhgel6gbiaZxccqpUffztuq0zbKf5gicKkrD9b6PJAbjHL79ARrTYWQ/640?wx_fmt=jpeg"></span></a><section><span leaf=""><br></span></section><section><span leaf=""><br></span></section><section><span leaf=""><span textstyle="">本文感兴趣的代码部分，分析下面这一部分，也就是刚刚咱们讨论的内容</span></span></section><section nodeleaf=""><img data-imgfileid="100010039" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6lGPTD34WNGKqGq8UAlglDtFN4F3XJ6oznybZz92cFq8XLVnAxzicbk9w/640?wx_fmt=jpeg&amp;from=appmsg" data-type="jpeg" type="block" src="https://mmbiz.qpic.cn/mmbiz_jpg/7At0Eia3NQFuRE9Jvgu3VAlrefVmt7ib6lGPTD34WNGKqGq8UAlglDtFN4F3XJ6oznybZz92cFq8XLVnAxzicbk9w/640?wx_fmt=jpeg&amp;from=appmsg"></section><section><span leaf=""><span textstyle="">主要是图C</span></span></section></section><section><ul><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre data-lang="bash"><code><span leaf=""><span># 清空工作环境并加载所需包</span></span></code><code><span leaf=""><span>rm</span>(list = <span>ls</span>())</span></code><code><span leaf="">library(NMF)         <span># 非负矩阵分解</span></span></code><code><span leaf="">library(cluster)     <span># 聚类分析</span></span></code><code><span leaf="">library(dplyr)       <span># 数据处理</span></span></code><code><span leaf="">library(ggplot2)     <span># 绘图</span></span></code><code><span leaf="">library(tidytext)    <span># 文本处理</span></span></code><code><span leaf="">library(patchwork)   <span># 图形拼接</span></span></code><code><span leaf="">library(ComplexHeatmap) <span># 热图绘制</span></span></code><code><span leaf="">library(RColorBrewer) <span># 颜色方案</span></span></code><code><span leaf="">library(circlize)    <span># 环形图</span></span></code><code><span leaf="">library(ggsci)       <span># 科学图表配色</span></span></code><code><span leaf="">library(viridis)     <span># 连续配色方案</span></span></code><code><span leaf="">library(extrafont)   <span># 字体支持</span></span></code><code><span leaf="">library(igraph)      <span># 网络分析</span></span></code><code><span leaf="">library(tidyverse)   <span># 数据科学工具集</span></span></code><code><span leaf="">library(psych)       <span># 心理测量学工具</span></span></code><code><span leaf="">library(mgsub)       <span># 字符串替换</span></span></code><code><span leaf=""><span># 加载预设颜色方案</span></span></code><code><span leaf="">color &lt;- readRDS(<span>"../resource/color_list.rds"</span>)</span></code><code><span leaf=""><span>### 1) 数据准备与筛选</span></span></code><code><span leaf=""><span># 读取元数据并筛选非上皮细胞</span></span></code><code><span leaf="">meta &lt;- read.csv2(<span>"../data/meta_obs_ann_s2_trim.csv2"</span>, row.names = 1)</span></code><code><span leaf="">meta &lt;- meta[meta<span>$ann1</span> != <span>"Epi"</span>, ]  <span># 排除上皮细胞</span></span></code><code><span leaf="">nrow(meta)  <span># 剩余1702037个细胞</span></span></code><code><span leaf=""><span># 仅保留Mix和Total分选类型</span></span></code><code><span leaf="">meta &lt;- meta[meta<span>$cellSort</span> %<span>in</span>% c(<span>"Mix"</span>, <span>"Total"</span>), ]</span></code><code><span leaf="">nrow(meta)  <span># 剩余1448609个细胞</span></span></code><code><span leaf=""><span># 过滤细胞数&lt;100的样本</span></span></code><code><span leaf="">rt_sp &lt;- names(table(meta<span>$sampleID</span>))[table(meta<span>$sampleID</span>) &gt;= 100]</span></code><code><span leaf="">meta &lt;- meta[meta<span>$sampleID</span> %<span>in</span>% rt_sp, ]</span></code><code><span leaf="">nrow(meta)  <span># 剩余1446646个细胞，510个有效样本</span></span></code><code><span leaf=""><span>rm</span>(rt_sp)  <span># 清理临时变量</span></span></code><code><span leaf=""><span>### 2) 构建原始细胞频率矩阵</span></span></code><code><span leaf=""><span># 生成亚群-样本计数矩阵</span></span></code><code><span leaf="">mat_ct &lt;- table(meta<span>$subCluster</span>, meta<span>$sampleID</span>)</span></code><code><span leaf="">mat_ct &lt;- matrix(data = mat_ct, ncol = ncol(mat_ct), dimnames = dimnames(mat_ct)) %&gt;% as.data.frame()</span></code><code><span leaf="">dim(mat_ct)  <span># 76个亚群，510个样本</span></span></code><code><span leaf=""><span># 添加细胞大类注释</span></span></code><code><span leaf="">meta_sc &lt;- readRDS(<span>"../prepare/meta_subCluster.rds"</span>)</span></code><code><span leaf=""><span>id</span> &lt;- match(rownames(mat_ct), meta_sc<span>$subCluster</span>)</span></code><code><span leaf="">mat_ct &lt;- data.frame(majorCluster = <span>factor</span>(meta_sc<span>$majorCluster</span>[<span>id</span>]), mat_ct, check.names = FALSE)</span></code><code><span leaf="">dim(mat_ct)  <span># 增加majorCluster列，共511列</span></span></code><code><span leaf=""><span># 计算细胞类型频率矩阵（按样本归一化）</span></span></code><code><span leaf="">mat_fq &lt;- mat_ct %&gt;%</span></code><code><span leaf="">  group_by(majorCluster) %&gt;%</span></code><code><span leaf="">  mutate_if(is.numeric, .funs = list(~ . / <span>sum</span>(.))) %&gt;%  <span># 按行归一化</span></span></code><code><span leaf="">  as.data.frame()</span></code><code><span leaf="">mat_fq[is.na(mat_fq)] &lt;- 0</span></code><code><span leaf="">rownames(mat_fq) &lt;- rownames(mat_ct)</span></code><code><span leaf=""><span># 移除majorCluster列，保留频率矩阵</span></span></code><code><span leaf="">mat_fq &lt;- mat_fq[, -1]</span></code><code><span leaf="">dim(mat_fq)  <span># 76×510，各亚群在样本中的频率</span></span></code><code><span leaf="">saveRDS(mat_fq, <span>"../prepare/mat_freq_raw.rds"</span>)  <span># 保存原始频率矩阵</span></span></code><code><span leaf=""><span>### 3) 全局归一化频率矩阵</span></span></code><code><span leaf=""><span># 将频率矩阵归一化到[0,1]区间</span></span></code><code><span leaf="">mat_gb_norm &lt;- mat_fq</span></code><code><span leaf="">mat_gb_norm &lt;- mat_gb_norm - apply(mat_gb_norm, MARGIN = 1, FUN = min)  <span># 减去最小值</span></span></code><code><span leaf="">mat_gb_norm &lt;- mat_gb_norm / apply(mat_gb_norm, MARGIN = 1, FUN = max)  <span># 除以最大值</span></span></code><code><span leaf=""><span>sum</span>(is.na(mat_gb_norm))  <span># 检查无缺失值</span></span></code><code><span leaf="">range(mat_gb_norm)  <span># 验证归一化范围</span></span></code><code><span leaf=""><span>### 4) 非负矩阵分解(NMF)</span></span></code><code><span leaf=""><span># 执行NMF分解，K=12个模块</span></span></code><code><span leaf="">K &lt;- 12</span></code><code><span leaf="">res &lt;- nmf(mat_gb_norm, rank = K, method = <span>"nsNMF"</span>, seed = rep(77, 6), nrun = 30)</span></code><code><span leaf="">saveRDS(res, <span>"../prepare/CoVarNet/NMF_K12.rds"</span>)  <span># 保存NMF结果</span></span></code><code><span leaf=""><span># 验证矩阵一致性</span></span></code><code><span leaf=""><span>sum</span>(rownames(res) != rownames(mat_gb_norm))  <span># 行名一致</span></span></code><code><span leaf=""><span>sum</span>(colnames(res) != colnames(mat_gb_norm))  <span># 列名一致</span></span></code><code><span leaf=""><span># 绘制NMF共识图（评估聚类稳定性）</span></span></code><code><span leaf="">pdf(<span>"./consensus_K12.pdf"</span>, width = 8, height = 7)</span></code><code><span leaf="">consensusmap(res, labCol = NA, labRow = NA,</span></code><code><span leaf="">             annColors = list(basis = pal_simpsons()(15), consensus = pal_simpsons()(15)))</span></code><code><span leaf="">dev.off()</span></code><code><span leaf="">png(<span>"./consensus_K12.png"</span>, width = 800, height = 700)</span></code><code><span leaf="">consensusmap(res, labCol = NA, labRow = NA,</span></code><code><span leaf="">             annColors = list(basis = pal_simpsons()(15), consensus = pal_simpsons()(15)))</span></code><code><span leaf="">dev.off()</span></code><code><span leaf=""><span>### 5) 样本CMT注释与熵分析</span></span></code><code><span leaf=""><span># 提取NMF系数矩阵</span></span></code><code><span leaf="">h &lt;- scoef(res)</span></code><code><span leaf="">rownames(h) &lt;- sprintf(<span>"C%02d"</span>, 1:nrow(h))  <span># 重命名行名为C01-C12</span></span></code><code><span leaf=""><span>sum</span>(is.na(h))  <span># 检查无缺失值</span></span></code><code><span leaf=""><span># 关联样本元数据</span></span></code><code><span leaf="">meta_sp &lt;- readRDS(<span>"../prepare/meta_sample.rds"</span>)</span></code><code><span leaf="">meta_sp &lt;- meta_sp[meta_sp<span>$sampleID</span> %<span>in</span>% colnames(res), ]  <span># 筛选有效样本</span></span></code><code><span leaf="">h &lt;- h[, rownames(meta_sp)]  <span># 匹配样本顺序</span></span></code><code><span leaf=""><span># 分配CMT标签（每个样本最大系数对应的模块）</span></span></code><code><span leaf=""><span>id</span> &lt;- apply(h, MARGIN = 2, FUN = which.max)</span></code><code><span leaf="">meta_sp<span>$CMT</span> &lt;- rownames(h)[<span>id</span>]</span></code><code><span leaf=""><span># 计算组织-CMT分布熵（评估模块组织特异性）</span></span></code><code><span leaf="">mat_tissue_CMT &lt;- table(meta_sp<span>$tissue</span>, meta_sp<span>$CMT</span>)</span></code><code><span leaf="">mat_tissue_CMT &lt;- t(t(mat_tissue_CMT) / colSums(mat_tissue_CMT))  <span># 归一化</span></span></code><code><span leaf="">shannon &lt;- apply(mat_tissue_CMT, MARGIN = 2, </span></code><code><span leaf="">                 FUN = <span>function</span>(x) {x &lt;- x[x != 0]; <span>sum</span>(x * log2(x)) * (-1)})  <span># 香农熵</span></span></code><code><span leaf=""><span># 重命名CMT以匹配熵排序</span></span></code><code><span leaf="">name_map &lt;- data.frame(</span></code><code><span leaf="">  int = names(<span>sort</span>(shannon, decreasing = TRUE)),</span></code><code><span leaf="">  entropy = <span>sort</span>(shannon, decreasing = TRUE) %&gt;% unname(),</span></code><code><span leaf="">  CM = sprintf(<span>"CM%02d"</span>, 1:length(shannon)),</span></code><code><span leaf="">  CMT = sprintf(<span>"CMT%02d"</span>, 1:length(shannon))</span></code><code><span leaf="">)</span></code><code><span leaf=""><span># 更新样本CMT标签和NMF系数矩阵名称</span></span></code><code><span leaf=""><span>id</span> &lt;- match(meta_sp<span>$CMT</span>, name_map<span>$int</span>)</span></code><code><span leaf="">meta_sp<span>$CMT</span> &lt;- name_map<span>$CMT</span>[<span>id</span>]</span></code><code><span leaf="">meta_sp &lt;- meta_sp[order(meta_sp<span>$CMT</span>, meta_sp<span>$system</span>, meta_sp<span>$tissue</span>), ]</span></code><code><span leaf=""><span>id</span> &lt;- match(rownames(h), name_map<span>$int</span>)</span></code><code><span leaf="">rownames(h) &lt;- name_map<span>$CM</span>[<span>id</span>]</span></code><code><span leaf="">h &lt;- h[<span>sort</span>(rownames(h)), ]</span></code><code><span leaf="">saveRDS(h, <span>"../prepare/CoVarNet/NMF_h.rds"</span>)       <span># 保存样本-模块系数</span></span></code><code><span leaf="">saveRDS(meta_sp, <span>"../prepare/meta_sample_CMT.rds"</span>) <span># 保存带CMT注释的样本元数据</span></span></code><code><span leaf=""><span>### 6) 提取各模块的亚群权重</span></span></code><code><span leaf=""><span># 提取NMF基矩阵（亚群-模块权重）</span></span></code><code><span leaf="">w &lt;- basis(res)</span></code><code><span leaf="">colnames(w) &lt;- sprintf(<span>"C%02d"</span>, 1:ncol(w))  <span># 临时命名</span></span></code><code><span leaf=""><span>id</span> &lt;- match(colnames(w), name_map<span>$int</span>)</span></code><code><span leaf="">colnames(w) &lt;- name_map<span>$CM</span>[<span>id</span>]  <span># 重命名为CM01-CM12</span></span></code><code><span leaf="">w &lt;- w[, <span>sort</span>(colnames(w))]  <span># 按模块名排序</span></span></code><code><span leaf=""><span># 转换为数据框并排序（每个模块按权重降序排列）</span></span></code><code><span leaf="">w_df &lt;- reshape2::melt(w)</span></code><code><span leaf="">colnames(w_df) &lt;- c(<span>"subCluster"</span>, <span>"cm"</span>, <span>"weight"</span>)</span></code><code><span leaf="">w_df &lt;- w_df %&gt;% group_by(cm) %&gt;% arrange(desc(weight), .by_group = TRUE) %&gt;% as.data.frame()</span></code><code><span leaf="">write.csv(w_df, <span>"../prepare/CoVarNet/NMF_weight_all.csv"</span>, quote = FALSE)  <span># 保存所有权重</span></span></code><code><span leaf=""><span># 提取每个模块权重前15的亚群</span></span></code><code><span leaf="">w_top &lt;- w_df %&gt;% group_by(cm) %&gt;% arrange(desc(weight), .by_group = TRUE) %&gt;% top_n(15, weight) %&gt;% as.data.frame()</span></code><code><span leaf=""><span>### 7) 识别特异性相关的亚群对</span></span></code><code><span leaf=""><span># 计算Pearson相关系数矩阵</span></span></code><code><span leaf="">cor_ls &lt;- t(mat_fq) %&gt;% psych::corr.test(method = <span>"pearson"</span>)</span></code><code><span leaf="">cor_mat &lt;- cor_ls<span>$r</span></span></code><code><span leaf="">cor_mat[lower.tri(cor_mat, diag = TRUE)] &lt;- NA  <span># 下三角设为NA</span></span></code><code><span leaf="">cor_df &lt;- reshape2::melt(cor_mat, na.rm = TRUE)</span></code><code><span leaf="">colnames(cor_df) &lt;- c(<span>"node1"</span>, <span>"node2"</span>, <span>"correlation"</span>)</span></code><code><span leaf=""><span># 提取p值并计算FDR</span></span></code><code><span leaf="">pval_mat &lt;- cor_ls<span>$p</span></span></code><code><span leaf="">pval_mat[lower.tri(pval_mat, diag = TRUE)] &lt;- NA</span></code><code><span leaf="">pval_df &lt;- reshape2::melt(pval_mat, na.rm = TRUE)</span></code><code><span leaf="">colnames(pval_df) &lt;- c(<span>"node1"</span>, <span>"node2"</span>, <span>"pval"</span>)</span></code><code><span leaf="">pval_df<span>$pval_fdr</span> &lt;- p.adjust(pval_df<span>$pval</span>, method = <span>"fdr"</span>)  <span># FDR校正</span></span></code><code><span leaf=""><span># 计算特异性分数(spe)</span></span></code><code><span leaf="">spe_mat &lt;- matrix(NA, nrow(cor_mat), ncol(cor_mat))</span></code><code><span leaf="">colnames(spe_mat) &lt;- rownames(spe_mat) &lt;- rownames(cor_mat)</span></code><code><span leaf="">N &lt;- nrow(spe_mat)</span></code><code><span leaf=""><span>for</span> (i <span>in</span> 1:(N - 1)) {</span></code><code><span leaf="">  <span>for</span> (j <span>in</span> (i + 1):N) {</span></code><code><span leaf="">    <span>bg</span> &lt;- c(cor_mat[i, -i], cor_mat[-c(i, j), j]) %&gt;% unname()  <span># 背景相关系数</span></span></code><code><span leaf="">    spe_mat[i, j] &lt;- mean(<span>bg</span> &lt;= cor_mat[i, j])  <span># 特异性分数</span></span></code><code><span leaf="">  }</span></code><code><span leaf="">}</span></code><code><span leaf="">spe_df &lt;- reshape2::melt(spe_mat, na.rm = TRUE)</span></code><code><span leaf="">colnames(spe_df) &lt;- c(<span>"node1"</span>, <span>"node2"</span>, <span>"spe"</span>)</span></code><code><span leaf=""><span># 合并数据框</span></span></code><code><span leaf="">cor_df &lt;- Reduce(f = merge, x = list(cor_df, pval_df, spe_df))</span></code><code><span leaf=""><span># 添加细胞大类注释</span></span></code><code><span leaf="">cor_df<span>$major1</span> &lt;- meta_sc<span>$majorCluster</span>[match(cor_df<span>$node1</span>, meta_sc<span>$subCluster</span>)]</span></code><code><span leaf="">cor_df<span>$major2</span> &lt;- meta_sc<span>$majorCluster</span>[match(cor_df<span>$node2</span>, meta_sc<span>$subCluster</span>)]</span></code><code><span leaf=""><span>### 8) 绘制网络图谱</span></span></code><code><span leaf=""><span># 提取每个模块前10的亚群</span></span></code><code><span leaf="">w_top10 &lt;- w_df %&gt;% group_by(cm) %&gt;% arrange(desc(weight), .by_group = TRUE) %&gt;% slice(1:10) %&gt;% ungroup()</span></code><code><span leaf=""><span># 筛选有效边（相关系数&gt;0.2，FDR≤0.05，特异性≥阈值）</span></span></code><code><span leaf="">cdt1 &lt;- cor_df<span>$correlation</span> &gt; 0.2</span></code><code><span leaf="">cdt2 &lt;- cor_df<span>$pval_fdr</span> &lt;= 0.05</span></code><code><span leaf="">pl_df &lt;- cor_df[cdt1 &amp; cdt2, ]</span></code><code><span leaf="">n_in_cm &lt;- 10       <span># 每个模块节点数</span></span></code><code><span leaf="">n_all &lt;- nrow(meta_sc) <span># 总亚群数</span></span></code><code><span leaf="">spe_cutoff &lt;- 1 - ((n_in_cm - <span>1</span>) * <span>2</span> - <span>1</span>) / ((n_all - <span>1</span>) * <span>2</span> - <span>1</span>)  # 特异性阈值公式</span></code><code><span leaf="">cdt3 &lt;- pl_df<span>$spe</span> &gt;= spe_cutoff</span></code><code><span leaf="">pl_df &lt;- pl_df[cdt3, ]</span></code><code><span leaf=""># 构建网络对象</span></code><code><span leaf="">graph &lt;- graph_from_data_frame(pl_df, directed = FALSE)</span></code><code><span leaf=""># 设置节点属性</span></code><code><span leaf="">V(graph)<span>$majorCluster</span> &lt;- meta_sc[V(graph)<span>$name</span>, "majorCluster"]</span></code><code><span leaf="">V(graph)<span>$frame</span>.color &lt;- V(graph)<span>$color</span> &lt;- color<span>$majorCluster</span>[V(graph)<span>$majorCluster</span>]</span></code><code><span leaf="">tmp &lt;- strsplit(V(graph)<span>$name</span>, split = "_") %&gt;% unlist()</span></code><code><span leaf="">V(graph)<span>$short_name</span> &lt;- tmp[seq(<span>1</span>, length(V(graph)<span>$name</span>) * <span>3</span>, <span>3</span>)]  # 提取亚群简称</span></code><code><span leaf="">V(graph)<span>$short_name</span> &lt;- gsub(pattern = "^CD", replacement = "", x = V(graph)<span>$short_name</span>)  # 移除CD前缀</span></code><code><span leaf=""># 设置边属性（颜色根据特异性分数）</span></code><code><span leaf="">col_fun &lt;- colorRamp2(</span></code><code><span leaf="">  breaks = quantile(E(graph)<span>$spe</span>, probs = seq(<span>0</span>, <span>1</span>, length = <span>6</span>)),</span></code><code><span leaf="">  colors = pal_material(palette = <span>"grey"</span>, n = 10)(10)[3:8]  <span># 灰色渐变</span></span></code><code><span leaf="">)</span></code><code><span leaf="">E(graph)<span>$color</span> &lt;- col_fun(E(graph)<span>$spe</span>)</span></code><code><span leaf="">E(graph)<span>$width</span> &lt;- 1  <span># 边宽统一为1</span></span></code><code><span leaf=""><span># 绘制全局网络图（完整名称）</span></span></code><code><span leaf="">lgd &lt;- Legend(</span></code><code><span leaf="">  col_fun = col_fun,</span></code><code><span leaf="">  at = c(min(E(graph)<span>$spe</span>), max(E(graph)<span>$spe</span>)),</span></code><code><span leaf="">  labels = c(<span>"Low"</span>, <span>"High"</span>),</span></code><code><span leaf="">  title = expression(<span>"Specificity"</span>),</span></code><code><span leaf="">  direction = <span>"horizontal"</span>,</span></code><code><span leaf="">  grid_height = unit(3, <span>"mm"</span>),</span></code><code><span leaf="">  legend_width = unit(10, <span>"mm"</span>),</span></code><code><span leaf="">  labels_gp = gpar(fontsize = 6),</span></code><code><span leaf="">  title_gp = gpar(fontsize = 6)</span></code><code><span leaf="">)</span></code><code><span leaf="">pdf(<span>"global_full.pdf"</span>, width = 10, height = 10)</span></code><code><span leaf="">par(mar = c(0, 0, 0, 0))</span></code><code><span leaf="">set.seed(42)</span></code><code><span leaf="">plot.igraph(</span></code><code><span leaf="">  graph,</span></code><code><span leaf="">  layout = layout_with_fr,  <span># Fruchterman-Reingold布局</span></span></code><code><span leaf="">  xlim = c(-1.2, 1.2), ylim = c(-1.2, 1.2),</span></code><code><span leaf="">  vertex.size = 3,</span></code><code><span leaf="">  vertex.label = V(graph)<span>$short_name</span>,</span></code><code><span leaf="">  vertex.label.cex = 6 / 12,</span></code><code><span leaf="">  vertex.label.color = <span>"black"</span>,</span></code><code><span leaf="">  vertex.label.family = <span>"Arial"</span></span></code><code><span leaf="">)</span></code><code><span leaf="">draw(lgd, x = unit(0.1, <span>"npc"</span>), y = unit(0.05, <span>"npc"</span>))  <span># 添加图例</span></span></code><code><span leaf="">dev.off()</span></code><code><span leaf=""><span># 绘制每个模块的环形网络图</span></span></code><code><span leaf="">pdf(<span>"Figure2c.pdf"</span>, width = 6, height = 2)</span></code><code><span leaf="">par(mfrow = c(2, 6), mar = c(0, 0, 0, 0) + 0.5)  <span># 2行6列布局</span></span></code><code><span leaf=""><span>for</span> (cm <span>in</span> unique(w_top10<span>$cm</span>)) {</span></code><code><span leaf="">  sub_graph &lt;- subgraph(</span></code><code><span leaf="">    graph,</span></code><code><span leaf="">    vids = intersect(V(graph)<span>$name</span>, w_top10<span>$subCluster</span>[w_top10<span>$cm</span> == cm])</span></code><code><span leaf="">  )</span></code><code><span leaf="">  sub_graph &lt;- delete_vertices(sub_graph, V(sub_graph)[igraph::degree(sub_graph) == 0])  <span># 移除孤立节点</span></span></code><code><span leaf="">  plot.igraph(</span></code><code><span leaf="">    sub_graph,</span></code><code><span leaf="">    layout = layout_in_circle,  <span># 环形布局</span></span></code><code><span leaf="">    xlim = c(-1.2, 1.2), ylim = c(-1.2, 1.2),</span></code><code><span leaf="">    vertex.size = 50,</span></code><code><span leaf="">    vertex.label = V(sub_graph)<span>$short_name</span>,</span></code><code><span leaf="">    vertex.label.cex = 5 / 8,</span></code><code><span leaf="">    vertex.label.color = <span>"black"</span>,</span></code><code><span leaf="">    vertex.label.family = <span>"Arial"</span></span></code><code><span leaf="">  )</span></code><code><span leaf="">  title(cm, cex.main = 7 / 8, line = -0.5, family = <span>"Arial"</span>)  <span># 添加模块标题</span></span></code><code><span leaf="">}</span></code><code><span leaf="">dev.off()</span></code></pre></section><section><section data-role="outer" label="Powered by 135editor.com onekey" data-pm-slice="0 0 []"><section><section data-bdopacity="20%"><section data-bdopacity="40%"><section data-bdopacity="60%"><section data-bdopacity="80%"><section data-bgopacity="90%"><span><span leaf="">Shi, Q., Chen, Y., Li, Y. et al. Cross-tissue multicellular coordination and its rewiring in cancer. Nature (2025).</span></span></section><p data-brushtype="text" data-pm-slice="0 0 []"><strong><strong><strong><span leaf="">后苔↩️之前贴子的岸号即可霍得之前的</span></strong></strong></strong></p><p data-brushtype="text"><strong><strong><strong><strong data-pm-slice="0 0 []"><span leaf="">代码，今日关键词：250529</span></strong></strong></strong></strong></p></section></section></section></section></section></section></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/wia9mgw5NXHRmxN3FxbHaA",target="_blank" rel="noopener noreferrer">原文链接</a>
