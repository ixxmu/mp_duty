---
title: "Seurat和h5ad数据相互转化以及10X多样本数据整理和读取(Python)"
date: 2025-05-18T14:33:20Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
Seurat和h5ad数据相互转化以及10X多样本数据整理和读取(Python) by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><p data-tool="mdnice编辑器"><span leaf="">目前已完成基于R语言的单细胞分析实战系列，涵盖初级、中级和高级三个阶段（每个阶段暂时各包含4篇内容，后续将陆续更新）。接下来，将尝试开展基于Python的单细胞分析实战系列。但在系列内容正式开始之前，笔者认为有必要先学习一下数据转化和读取流程。</span></p><p data-tool="mdnice编辑器"><span leaf="">本次内容涉及到的工程文件可通过网盘获得：中级篇2，链接: https://pan.baidu.com/s/1y-HHLXoXsJbgWKCdz26-gQ 提取码: yx93 。</span></p><p data-tool="mdnice编辑器"><span leaf="">此外，可以向“生信技能树”公众号发送关键词‘单细胞’，直接获取Seurat V5版本的完整代码。</span></p><p data-tool="mdnice编辑器"><span leaf="">首先推荐python官网：https://www.python.org/doc/<img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafA9KgousP3BaKw24HibEYKcNPVapD1VLg1OaJHaaadehxFz9jr58sW4yg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5824074074074074" data-type="png" data-w="1080" data-imgfileid="100046468" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafA9KgousP3BaKw24HibEYKcNPVapD1VLg1OaJHaaadehxFz9jr58sW4yg/640?wx_fmt=png&amp;from=appmsg">里面的教程有多语言版本，可以选择中文<img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAJaicsAfLeZ5JScQq9JqQuDSZQMdjvVJaLC87QOzgN66TRlr89ocaRfw/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6972222222222222" data-type="png" data-w="1080" data-imgfileid="100046471" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAJaicsAfLeZ5JScQq9JqQuDSZQMdjvVJaLC87QOzgN66TRlr89ocaRfw/640?wx_fmt=png&amp;from=appmsg">快速检索就可以查询想要的信息，比如查了一下os库<img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafA6MMz7hVeyqTryGuIey3O71ARVmYtYVWTJtySGjuygxBNyxl9esz3dQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5009259259259259" data-type="png" data-w="1080" data-imgfileid="100046470" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafA6MMz7hVeyqTryGuIey3O71ARVmYtYVWTJtySGjuygxBNyxl9esz3dQ/640?wx_fmt=png&amp;from=appmsg">这个网站可以作为工具手册帮助使用者快速上手，当然大模型辅助也一定是必不可少的。</span></p><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">Seurat和h5ad数据相互转化</span></span><span></span></h4><p data-tool="mdnice编辑器"><span leaf="">后续一定会涉及到数据的相互转化，因此必须学会这个步骤。</span></p><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.导入(Seurat V5对象转换为h5ad数据)</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">R语言部分</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">rm(list = ls())</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(Seurat)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(qs)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(reticulate)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(hdf5r)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(sceasy)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(BiocParallel)</span><span leaf=""><br></span><span leaf="">register(MulticoreParam(workers = </span><span><span leaf="">4</span></span><span leaf="">, progressbar = </span><span><span leaf="">TRUE</span></span><span leaf="">)) </span><span leaf=""><br></span><span leaf="">scRNA_V5 &lt;- qread(</span><span><span leaf="">"CD4+T_final.qs"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">scRNA_V5</span><span leaf=""><br></span><span><span leaf=""># An object of class Seurat </span></span><span leaf=""><br></span><span><span leaf=""># 21308 features across 5912 samples within 1 assay </span></span><span leaf=""><br></span><span><span leaf=""># Active assay: RNA (21308 features, 2000 variable features)</span></span><span leaf=""><br></span><span><span leaf="">#  3 layers present: counts, data, scale.data</span></span><span leaf=""><br></span><span><span leaf="">#  3 dimensional reductions calculated: pca, harmony, umap</span></span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">2.配置python环境</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">linux/终端，numpy不能使用最新版本</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">conda create -n sceasy python=</span><span><span leaf="">3.9</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">conda activate sceasy</span><span leaf=""><br></span><span leaf="">conda install anndata</span><span leaf=""><br></span><span leaf="">conda install scipy</span><span leaf=""><br></span><span leaf="">conda install loompy</span><span leaf=""><br></span><span leaf="">conda install numpy==</span><span><span leaf="">1.24</span></span><span><span leaf="">.4</span></span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.R语言转换</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">再次回到R语言, 在R语言中调用Python环境</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 在R语言中加载python环境</span></span><span leaf=""><br></span><span leaf="">use_condaenv(</span><span><span leaf="">'sceasy'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">loompy &lt;- reticulate::import(</span><span><span leaf="">'loompy'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">py_config()</span><span leaf=""><br></span><span><span leaf=""># python:         /opt/anaconda3/envs/sceasy/bin/python</span></span><span leaf=""><br></span><span><span leaf=""># libpython:      /opt/anaconda3/envs/sceasy/lib/libpython3.9.dylib</span></span><span leaf=""><br></span><span><span leaf=""># pythonhome:     /opt/anaconda3/envs/sceasy:/opt/anaconda3/envs/sceasy</span></span><span leaf=""><br></span><span><span leaf=""># version:        3.9.20 | packaged by conda-forge | (main, Sep 22 2024, 14:06:09)  [Clang 17.0.6 ]</span></span><span leaf=""><br></span><span><span leaf=""># numpy:          /opt/anaconda3/envs/sceasy/lib/python3.9/site-packages/numpy</span></span><span leaf=""><br></span><span><span leaf=""># numpy_version:  1.24.4</span></span><span leaf=""><br></span><span><span leaf=""># loompy:         /opt/anaconda3/envs/sceasy/lib/python3.9/site-packages/loompy</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">开始转换</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># Seurat to AnnData</span></span><span leaf=""><br></span><span leaf="">scRNA_V5[[</span><span><span leaf="">"RNA"</span></span><span leaf="">]] &lt;- as(scRNA_V5[[</span><span><span leaf="">"RNA"</span></span><span leaf="">]], </span><span><span leaf="">"Assay"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sceasy::convertFormat(scRNA_V5, from=</span><span><span leaf="">"seurat"</span></span><span leaf="">, to=</span><span><span leaf="">"anndata"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                      outFile=</span><span><span leaf="">'scRNA_V5.h5ad'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># AnnData object with n_obs × n_vars = 5042 × 20124</span></span><span leaf=""><br></span><span><span leaf="">#     obs: 'nCount_RNA', 'nFeature_RNA', 'Sample', 'Cell.Barcode', 'Type', 'RNA_snn_res.0.1', 'RNA_snn_res.0.2', 'RNA_snn_res.0.3', 'RNA_snn_res.0.4', 'RNA_snn_res.0.5', 'RNA_snn_res.0.6', 'RNA_snn_res.0.7', 'RNA_snn_res.0.8', 'RNA_snn_res.0.9', 'RNA_snn_res.1', 'RNA_snn_res.1.1', 'RNA_snn_res.1.2', 'seurat_clusters', 'celltype', 'seurat_annotation'</span></span><span leaf=""><br></span><span><span leaf="">#     var: 'vf_vst_counts_mean', 'vf_vst_counts_variance', 'vf_vst_counts_variance.expected', 'vf_vst_counts_variance.standardized', 'vf_vst_counts_variable', 'vf_vst_counts_rank', 'var.features', 'var.features.rank'</span></span><span leaf=""><br></span><span><span leaf="">#     obsm: 'X_pca', 'X_harmony', 'X_umap'</span></span><span leaf=""><br></span><span><span leaf=""># Warning message:</span></span><span leaf=""><br></span><span><span leaf=""># In .regularise_df(obj@meta.data, drop_single_values = drop_single_values) :</span></span><span leaf=""><br></span><span><span leaf="">#   Dropping single category variables:orig.ident</span></span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">4.在jupyter lab中确认一下</span></span><span></span></h5><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">打开jupyter lab</span></span><span></span></h6><p data-tool="mdnice编辑器"><span leaf="">首先必须要安装anaconda/miniconda等；</span></p><ol><li><section><span leaf="">直接点击电脑上的anaconda软件(笔者装的事anaconda所以这里这么写了)，进入界面之后点击jupyter lab<img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAxjYsP3QZ39ds8j3O0KGU4XAR7C3uOSeshsE5FicDWBzTDvHfibIFtCibg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.6037037037037037" data-type="png" data-w="1080" data-imgfileid="100046469" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAxjYsP3QZ39ds8j3O0KGU4XAR7C3uOSeshsE5FicDWBzTDvHfibIFtCibg/640?wx_fmt=png&amp;from=appmsg"></span></section></li><li><section><span leaf="">在终端中输入jupyter lab，电脑会自动打开该界面，如果直接以家为自己的工作目录，就直接输入jupyter lab，如果想要切换工作目录，那就要先cd进去，再输入jupyter lab</span></section></li></ol><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># mkdir ~/xxxx</span></span><span leaf=""><br></span><span leaf="">cd ~/xxxx</span><span leaf=""><br></span><span leaf="">jupyter lab</span><span leaf=""><br></span></code></pre><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">注册python内核</span></span><span></span></h6><p data-tool="mdnice编辑器"><span leaf="">激活环境之后，注册小环境对应的内核, 在Jupyter Notebook中运行Python代码时，真正执行这些代码的“引擎”就是ipykernel，Jupyter 提供的是前端界面（网页 Notebook），ipykernel是后端：它运行你的代码，并把结果返回给前端显示。所以先要安装一下ipykernel。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">conda activate sceasy</span><span leaf=""><br></span><span leaf="">pip install ipykernel</span><span leaf=""><br></span><span leaf="">python -m ipykernel install --user --name sceasy --display-name </span><span><span leaf="">"Python(sceasy)"</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">增加了一个新的sceasy内核，以后涉及到数据转化就可以连接该内核。<img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAwctGslhuicJzUyNo7tibhG3ibwTsKtmAhp9ZLTNFRSibDicYaFj0TLTd6LA/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.43703703703703706" data-type="png" data-w="1080" data-imgfileid="100046467" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAwctGslhuicJzUyNo7tibhG3ibwTsKtmAhp9ZLTNFRSibDicYaFj0TLTd6LA/640?wx_fmt=png&amp;from=appmsg">如何删除</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 查看当前列表 </span></span><span leaf=""><br></span><span leaf="">jupyter kernelspec list</span><span leaf=""><br></span><span><span leaf=""># 删除</span></span><span leaf=""><br></span><span leaf="">jupyter kernelspec uninstall sceasy</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 删除conda环境</span></span><span leaf=""><br></span><span leaf="">conda remove --name sceasy --all</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><strong><span leaf="">为什么创建了环境之后还需要注册内核？</span></strong></p><p data-tool="mdnice编辑器"><span leaf="">在回答这个问题前，需要了解一下Conda、Anaconda、Miniconda</span></p><ol><li><section><span leaf="">Conda: 一个开源的软件包管理和环境管理系统，最初是为了支持Python语言而设计的，但现在也可以管理和部署任何语言的软件包和依赖项。它能够帮助用户轻松地安装不同的软件版本，并且可以在相互隔离的环境中管理这些软件包，从而避免版本冲突。Conda 可以通过命令行使用，并且支持多个平台（Windows、macOS 和 Linux）。</span></section></li><li><section><span leaf="">Anaconda: 基于Conda的一个发行版，专为数据科学和机器学习等任务设计。它包括了Conda以及大量的预装软件包、库和工具，比如Jupyter Notebook、Spyder IDE 等。Anaconda发行版非常适合刚开始从事数据分析、科学计算、机器学习等领域的新手，因为它几乎包含了所有常用的库和工具，减少了单独安装配置的时间。然而，由于其庞大的体积（通常超过数GB），对于只需要少量特定工具或库的用户来说，可能会显得过于臃肿。</span></section></li><li><section><span leaf="">Miniconda: 是一个轻量级的Conda安装器，只包含Conda包管理器和Python基础环境。相比完整的 Anaconda 发行版，Miniconda更加精简，允许用户根据自己的需求自定义安装所需的软件包和库。这种方式对于那些已经有特定要求或者希望从头开始构建自己环境的高级用户来说非常合适。Miniconda 提供了一个灵活的基础，用户可以在此基础上通过 Conda 来安装任何需要的包，而不必携带不必要的预装软件。 所以Anaconda和miniconda都是属于conda，并且conda更像是一个管理平台(工具)，管理着软件和环境。</span></section></li></ol><p data-tool="mdnice编辑器"><span leaf="">而Conda环境是一个独立的Python环境，包含特定版本的Python和安装的库，旨在隔离项目依赖和轻松管理依赖。不同项目可能需要不同版本的Python或第三方库，通过创建独立的Conda环境可以避免这些依赖之间的冲突，并允许为每个环境单独安装、更新或删除库而不影响其他环境。Jupyter Notebook或Jupyter Lab是一个交互式编程工具，它本身并不知道Conda环境的存在。为了让Jupyter能够使用某个 Conda环境中的Python和库，需要将该环境注册为一个Jupyter内核。内核是Jupyter的执行引擎，每个 Jupyter实例都会绑定到一个内核，负责运行代码并返回结果，</span><strong><span leaf="">个人理解这里的内核相当于特定扇门或者钥匙把jupyter lab和conda环境打通</span></strong><span leaf="">。即使已经创建了一个 Conda环境，Jupyter并不会自动识别这个环境。因此，需要手动将Conda环境注册为Jupyter内核，以便在Jupyter中选择特定环境对应的内核，确保代码运行在正确的环境中，并能够访问该环境中安装的库（如 pandas、numpy 等）。**再如果觉得迷糊也没关系，简单来说相当于conda环境和jupyter内核其实是互相独立的，使用者只需要知道创建了环境之后再注册一下内核这样就能让他们"步调一致"即可(不然会调用base中的库)**。</span></p><p data-tool="mdnice编辑器"><span leaf="">在python中确认一下h5ad文件</span></p><p data-tool="mdnice编辑器"><span leaf="">安装一些必要的库</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 安装scanpy</span></span><span leaf=""><br></span><span leaf="">pip install scanpy</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">加载库</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">import scanpy as sc</span><span leaf=""><br></span><span leaf="">import os</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 确认路径</span></span><span leaf=""><br></span><span leaf="">os.getcwd()</span><span leaf=""><br></span><span><span leaf=""># '/Users/zaneflying/Desktop/PythonGSE188711'</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">读取数据</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 读取数据</span></span><span leaf=""><br></span><span leaf="">adata = sc.read_h5ad(</span><span><span leaf="">'scRNA_V5.h5ad'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata</span><span leaf=""><br></span><span><span leaf=""># AnnData object with n_obs × n_vars = 5912 × 21308</span></span><span leaf=""><br></span><span><span leaf="">#     obs: 'orig.ident', 'nCount_RNA', 'nFeature_RNA', 'percent_mito', 'percent_ribo', 'percent_hb', 'seurat_clusters', 'RNA_snn_res.0.1', 'RNA_snn_res.0.2', 'RNA_snn_res.0.3', 'RNA_snn_res.0.5', 'RNA_snn_res.0.8', 'RNA_snn_res.1', 'celltype', 'location', 'pANN_0.25', 'contamination', 'RNA_snn_res.0.4', 'RNA_snn_res.0.6', 'RNA_snn_res.0.7', 'RNA_snn_res.0.9', 'RNA_snn_res.1.1', 'RNA_snn_res.1.2', 'RNA_snn_res.1.3', 'RNA_snn_res.1.4', 'RNA_snn_res.1.5', 'RNA_snn_res.1.6', 'RNA_snn_res.1.7', 'RNA_snn_res.1.8', 'RNA_snn_res.1.9', 'RNA_snn_res.2'</span></span><span leaf=""><br></span><span><span leaf="">#     var: 'vf_vst_counts_mean', 'vf_vst_counts_variance', 'vf_vst_counts_variance.expected', 'vf_vst_counts_variance.standardized', 'vf_vst_counts_variable', 'vf_vst_counts_rank', 'var.features', 'var.features.rank'</span></span><span leaf=""><br></span><span><span leaf="">#     obsm: 'X_harmony', 'X_pca', 'X_umap'</span></span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.导入(h5ad数据转换为Seurat对象)</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">R语言部分</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">rm(list = ls())</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(sceasy)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(qs)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(reticulate)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(Seurat)</span><span leaf=""><br></span><span><span leaf="">library</span></span><span leaf="">(BiocParallel)</span><span leaf=""><br></span><span leaf="">register(MulticoreParam(workers = </span><span><span leaf="">4</span></span><span leaf="">, progressbar = </span><span><span leaf="">TRUE</span></span><span leaf="">)) </span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">6.数据转换</span></span><span></span></h5><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># h5ad转为Seurat</span></span><span leaf=""><br></span><span leaf="">sceasy::convertFormat(obj = </span><span><span leaf="">"scRNA_V5.h5ad"</span></span><span leaf="">, </span><span leaf=""><br></span><span leaf="">                      from=</span><span><span leaf="">"anndata"</span></span><span leaf="">,to=</span><span><span leaf="">"seurat"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                      outFile = </span><span><span leaf="">'scRNA_CD4.rds'</span></span><span leaf="">)</span><span leaf=""><br></span><span><span leaf=""># X -&gt; counts</span></span><span leaf=""><br></span><span><span leaf=""># An object of class Seurat </span></span><span leaf=""><br></span><span><span leaf=""># 21308 features across 5912 samples within 1 assay </span></span><span leaf=""><br></span><span><span leaf=""># Active assay: RNA (21308 features, 0 variable features)</span></span><span leaf=""><br></span><span><span leaf="">#  2 layers present: counts, data</span></span><span leaf=""><br></span><span><span leaf="">#  3 dimensional reductions calculated: harmony, pca, umap</span></span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">7.数据确认</span></span><span></span></h5><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">scRNA &lt;- readRDS(</span><span><span leaf="">"./scRNA_CD4.rds"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">rownames(scRNA)</span><span leaf=""><br></span><span leaf="">colnames(scRNA)</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafADgx0OWROicsqgufoLFY2feODDuW9BYibRuBHzOP5p9A8ux4CtkVzIvZg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.4685185185185185" data-type="png" data-w="1080" data-imgfileid="100046476" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafADgx0OWROicsqgufoLFY2feODDuW9BYibRuBHzOP5p9A8ux4CtkVzIvZg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">数据读取流程(Python)</span></span><span></span></h4><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.创建和激活环境</span></span><span></span></h6><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 创建一名为sc的python版本为3.9的环境</span></span><span leaf=""><br></span><span><span leaf=""># -n是 -name的简称</span></span><span leaf=""><br></span><span leaf="">conda create -n sc python=</span><span><span leaf="">3.9</span></span><span leaf=""><br></span><span><span leaf=""># 激活</span></span><span leaf=""><br></span><span leaf="">conda activate sc</span><span leaf=""><br></span></code></pre><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">2.在Jupyter lab中创建内核</span></span><span></span></h6><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">python -m ipykernel install --user --name sc --display-name </span><span><span leaf="">"Python(sc)"</span></span><span leaf=""><br></span></code></pre><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.安装库</span></span><span></span></h6><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">conda install scanpy</span><span leaf=""><br></span></code></pre><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">正式移动和读取文件(Python)</span></span><span></span></h5><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">1.导入所需要的库</span></span><span></span></h6><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">import os</span><span leaf=""><br></span><span leaf="">import shutil</span><span leaf=""><br></span><span leaf="">import re</span><span leaf=""><br></span></code></pre><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">2.查询当前的路径</span></span><span></span></h6><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">os.getcwd()</span><span leaf=""><br></span><span><span leaf="">#'/Users/zaneflying/Desktop/PythonGSE188711'</span></span><span leaf=""><br></span></code></pre><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">3.列出目录下所有包含 'features' 的文件</span></span><span></span></h6><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">fs = [</span><span leaf=""><br></span><span leaf="">    os.path.join(</span><span><span leaf="">'GSE188711_RAW'</span></span><span leaf="">, f)           </span><span><span leaf=""># 拼接出完整路径，如 GSE188711_RAW/GSM5688707_features.tsv.gz</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">for</span></span><span leaf=""> f </span><span><span leaf="">in</span></span><span leaf=""> os.listdir(</span><span><span leaf="">'GSE188711_RAW'</span></span><span leaf="">)       </span><span><span leaf=""># 遍历目录下的所有文件名</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">if</span></span><span leaf=""> </span><span><span leaf="">'features'</span></span><span leaf=""> </span><span><span leaf="">in</span></span><span leaf=""> f                         </span><span><span leaf=""># 只选取文件名中包含 'features' 的文件</span></span><span leaf=""><br></span><span leaf="">]</span><span leaf=""><br></span><span leaf="">print(fs)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">samples1 = fs</span><span leaf=""><br></span><span><span leaf=""># ['GSE188711_RAW/GSM5688707_features_JCA.tsv.gz', 'GSE188711_RAW/GSM5688706_features_WGC.tsv.gz', </span></span><span leaf=""><br></span><span><span leaf=""># 'GSE188711_RAW/GSM5688711_features_R_CRC4.tsv.gz', 'GSE188711_RAW/GSM5688709_features_RS-CRC1.tsv.gz', </span></span><span leaf=""><br></span><span><span leaf=""># 'GSE188711_RAW/GSM5688710_features_R_CRC3.tsv.gz', 'GSE188711_RAW/GSM5688708_features_LS-CRC3.tsv.gz']</span></span><span leaf=""><br></span></code></pre><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">4.用正则表达式替换字符串，得到样本名</span></span><span></span></h6><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">samples2 = [re.sub(r</span><span><span leaf="">'_features'</span></span><span leaf="">, </span><span><span leaf="">''</span></span><span leaf="">, f) </span><span><span leaf="">for</span></span><span leaf=""> f </span><span><span leaf="">in</span></span><span leaf=""> fs]</span><span leaf=""><br></span><span leaf="">samples2 = [re.sub(r</span><span><span leaf="">'\.tsv\.gz$'</span></span><span leaf="">, </span><span><span leaf="">''</span></span><span leaf="">, f) </span><span><span leaf="">for</span></span><span leaf=""> f </span><span><span leaf="">in</span></span><span leaf=""> samples2]</span><span leaf=""><br></span><span leaf="">print(samples2)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">其实这里的样本名可以清洗更加仔细，比如只剩下GSM号码，简洁的好处非常多，建议保持简洁。</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">samples2 = [re.findall(r</span><span><span leaf="">'GSM\d+'</span></span><span leaf="">, f)[</span><span><span leaf="">0</span></span><span leaf="">] </span><span><span leaf="">for</span></span><span leaf=""> f </span><span><span leaf="">in</span></span><span leaf=""> fs]</span><span leaf=""><br></span><span leaf="">print(samples2)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># ['GSM5688707', 'GSM5688706', 'GSM5688711', 'GSM5688709', 'GSM5688710', 'GSM5688708']</span></span><span leaf=""><br></span></code></pre><h6 data-tool="mdnice编辑器"><span></span><span><span leaf="">5.创建文件夹并重命名和移动文件</span></span><span></span></h6><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf=""># 3. 创建 outputs 文件夹（如果不存在）</span></span><span leaf=""><br></span><span leaf="">os.makedirs(</span><span><span leaf="">'outputs'</span></span><span leaf="">, exist_ok=True)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 4. 遍历样本，创建子文件夹并复制文件</span></span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> x, y </span><span><span leaf="">in</span></span><span leaf=""> zip(samples2, samples1):</span><span leaf=""><br></span><span leaf="">    output_dir = os.path.join(</span><span><span leaf="">'outputs'</span></span><span leaf="">, x)</span><span leaf=""><br></span><span leaf="">    os.makedirs(output_dir, exist_ok=True)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 复制并重命名 features 文件</span></span><span leaf=""><br></span><span leaf="">    shutil.copy(y, os.path.join(output_dir, </span><span><span leaf="">'features.tsv.gz'</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 对应的 matrix 文件名替换</span></span><span leaf=""><br></span><span leaf="">    matrix_file = y.replace(</span><span><span leaf="">'features'</span></span><span leaf="">, </span><span><span leaf="">'matrix'</span></span><span leaf="">).replace(</span><span><span leaf="">'.tsv'</span></span><span leaf="">, </span><span><span leaf="">'.mtx'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    shutil.copy(matrix_file, os.path.join(output_dir, </span><span><span leaf="">'matrix.mtx.gz'</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 对应的 barcodes 文件名替换</span></span><span leaf=""><br></span><span leaf="">    barcodes_file = y.replace(</span><span><span leaf="">'features'</span></span><span leaf="">, </span><span><span leaf="">'barcodes'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    shutil.copy(barcodes_file, os.path.join(output_dir, </span><span><span leaf="">'barcodes.tsv.gz'</span></span><span leaf="">))</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAsKgudq6rnDpqzdy2pRvgAIG9d5Xia7gic6qjZUc2A2qGysOiap1nyMpqg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.362962962962963" data-type="png" data-w="1080" data-imgfileid="100046475" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAsKgudq6rnDpqzdy2pRvgAIG9d5Xia7gic6qjZUc2A2qGysOiap1nyMpqg/640?wx_fmt=png&amp;from=appmsg"></span></figure><h5 data-tool="mdnice编辑器"><span></span><span><span leaf="">6.读取文件</span></span><span></span></h5><p data-tool="mdnice编辑器"><span leaf="">6.0 安装库,linux/终端</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">conda install loompy</span><span leaf=""><br></span><span leaf="">pip install numpy==</span><span><span leaf="">1.24</span></span><span><span leaf="">.4</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">6.1 导入</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">import os</span><span leaf=""><br></span><span leaf="">import scanpy as sc</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">6.2 检查路径</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">os.getcwd()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># '/Users/zaneflying/Desktop/PythonGSE188711'</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">6.3 读取样本路径和信息(排除了“.”开头的隐藏文件)</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">dir_path = </span><span><span leaf="">'/Users/zaneflying/Desktop/PythonGSE188711/outputs/'</span></span><span leaf=""><br></span><span leaf="">samples = [s </span><span><span leaf="">for</span></span><span leaf=""> s </span><span><span leaf="">in</span></span><span leaf=""> os.listdir(dir_path) </span><span><span leaf="">if</span></span><span leaf=""> not s.startswith(</span><span><span leaf="">'.'</span></span><span leaf="">)]</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">print(samples)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># ['GSM5688711', 'GSM5688710', 'GSM5688709', 'GSM5688707', 'GSM5688706', 'GSM5688708']</span></span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">6.4 读取样本构建sce_list</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sce_list = []</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> sample </span><span><span leaf="">in</span></span><span leaf=""> samples:</span><span leaf=""><br></span><span leaf="">    sample_path = os.path.join(dir_path, sample)</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 读取10X格式数据</span></span><span leaf=""><br></span><span leaf="">    adata = sc.read_10x_mtx(sample_path, var_names=</span><span><span leaf="">'gene_symbols'</span></span><span leaf="">, cache=True)</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 过滤：至少5个细胞的基因，至少300个基因的细胞 (对应min.cells和min.features)</span></span><span leaf=""><br></span><span leaf="">    sc.pp.filter_genes(adata, min_cells=</span><span><span leaf="">5</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    sc.pp.filter_cells(adata, min_genes=</span><span><span leaf="">300</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf=""># 给AnnData添加项目名称</span></span><span leaf=""><br></span><span leaf="">    adata.obs[</span><span><span leaf="">'project'</span></span><span leaf="">] = sample</span><span leaf=""><br></span><span leaf="">    sce_list.append(adata)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># sce_list 是包含多个AnnData对象的列表</span></span><span leaf=""><br></span></code></pre><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">sce_list</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAn0lUT6mqeSEKK8oK4rINmLjcPia60e7zFiawm3jHx1XSib1aOTq6kMU0Q/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.7535885167464115" data-type="png" data-w="418" data-imgfileid="100046474" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAn0lUT6mqeSEKK8oK4rINmLjcPia60e7zFiawm3jHx1XSib1aOTq6kMU0Q/640?wx_fmt=png&amp;from=appmsg">6.5 合并</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata = sc.concat(sce_list,label=</span><span><span leaf="">'sampleid'</span></span><span leaf="">,index_unique=</span><span><span leaf="">'_'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">adata.obs_names_make_unique()</span><span leaf=""><br></span><span leaf="">adata</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">参数index_unique='-'帮助使用者把样本名和细胞名进行连接。</span></p><p data-tool="mdnice编辑器"><span leaf="">6.6 信息查看<img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafALbmml9NXdWklxibfCNQzJe7eBJuPH2SnDBeS8vic8NNlEN0b794PsB9g/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.44821731748726656" data-type="png" data-w="589" data-imgfileid="100046472" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafALbmml9NXdWklxibfCNQzJe7eBJuPH2SnDBeS8vic8NNlEN0b794PsB9g/640?wx_fmt=png&amp;from=appmsg"></span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.obs_names</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafA7rN7GBibkMEw7Wof159kSSbHrS4X3r5UWL4et3sV6mGysSRI2uNM63A/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.2759146341463415" data-type="png" data-w="656" data-imgfileid="100046473" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafA7rN7GBibkMEw7Wof159kSSbHrS4X3r5UWL4et3sV6mGysSRI2uNM63A/640?wx_fmt=png&amp;from=appmsg"></span></figure><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.obs_keys</span><span leaf=""><br></span></code></pre><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100046477" data-ratio="0.06647398843930635" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafA5OjW03MutpdhNKH7vs90icdbsw6nljkdP7jibUa5OMxeSBibBVeDtEUsQ/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="692" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafA5OjW03MutpdhNKH7vs90icdbsw6nljkdP7jibUa5OMxeSBibBVeDtEUsQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.var_names</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100046481" data-ratio="0.20875420875420875" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAicic568miaV7wtgEWGOyL72PibQwpibqalsgHSXoxJvJruqHGHKUicxkA8jw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="594" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjSZCSbTjdjgiaqtJy9PIwiafAicic568miaV7wtgEWGOyL72PibQwpibqalsgHSXoxJvJruqHGHKUicxkA8jw/640?wx_fmt=png&amp;from=appmsg">保存h5ad文件</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">adata.write(</span><span><span leaf="">'GSE188711.h5ad'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><span leaf="">保存loom文件</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span leaf="">import loompy</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">adata.write_loom(</span><span><span leaf="">'GSE188711.loom'</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h4 data-tool="mdnice编辑器"><span></span><span><span leaf="">参考资料：</span></span><span></span></h4><ol><li><section><span leaf="">python: https://www.python.org/doc/</span></section></li><li><section><span leaf="">sceasy github: https://github.com/cellgeni/sceasy</span></section></li><li><section><span leaf="">Anaconda: https://www.anaconda.com/</span></section></li><li><section><span leaf="">Jupyter: https://jupyter.org/</span></section></li><li><section><span leaf="">pandas: https://pandas.pydata.org/</span></section></li><li><section><span leaf="">os: https://docs.python.org/3/library/os.html</span></section></li><li><section><span leaf="">shutil：https://docs.python.org/3/library/shutil.html</span></section></li><li><section><span leaf="">re: https://docs.python.org/3/library/re.html</span></section></li><li><section><span leaf="">生信技能树：https://mp.weixin.qq.com/s/AVSRSAZDTQHHriMY2YyGOw</span></section></li></ol><p data-tool="mdnice编辑器"><strong><span leaf="">致谢</span></strong><span leaf="">：感谢曾老师以及生信技能树团队全体成员。更多精彩内容可关注公众号：</span><strong><span leaf="">生信技能树，单细胞天地，生信菜鸟团</span></strong><span leaf="">等公众号。</span></p><p data-tool="mdnice编辑器"><strong><span leaf="">注</span></strong><span leaf="">：若对内容有疑惑或者有发现明确错误的朋友，请联系后台(欢迎交流)。</span></p></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/JCGnkNKsQhGgfcazj63Mhw",target="_blank" rel="noopener noreferrer">原文链接</a>
