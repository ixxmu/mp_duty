---
title: "基因表达热图与功能富集分析结果联合展示"
date: 2025-05-14T07:34:15Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞天地"
]
categories: ["Acdemic"]
---
基因表达热图与功能富集分析结果联合展示 by 单细胞天地
------
<div><section data-tool="mdnice编辑器" data-website="https://www.mdnice.com" data-pm-slice="0 0 []"><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">写在开头</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">上周基于文章给的代码以及自己的尝试，复现了一下文章中<a href="https://mp.weixin.qq.com/s?__biz=MzI1Njk4ODE0MQ==&amp;mid=2247529953&amp;idx=1&amp;sn=19d763d16dc53a21241f29b971f3fd10&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">FeaturePlot 批量绘图与美化实战</a></span></p><p data-tool="mdnice编辑器"><span leaf="">也到了我看上的Figure1D啦！</span><strong><span leaf="">用热图的方式可视化了top20的marker基因，也结合了相对应的GO富集分析结果图。</span></strong></p><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100046385" data-ratio="0.6620370370370371" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzkhSonibk8AY5iaSZGsiaND2VtgTbas7cA75o24IBpQW19D8donbketticw/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="1080" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzkhSonibk8AY5iaSZGsiaND2VtgTbas7cA75o24IBpQW19D8donbketticw/640?wx_fmt=png&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">那就一起来看看如何得到这个好看的图叭！</span></strong></p><section nodeleaf=""><mp-common-videosnap data-pluginname="mpvideosnap" data-url="https://findermp.video.qq.com/251/20304/stodownload?encfilekey=rjD5jyTuFrIpZ2ibE8T7Ym3K77SEULgkiaIhHyFqNlVJXxGHk34vIhUgrzh2M8upvQJdOXfMFFnpQT9bdSYPOZzxdajyrCkwbAs5COO8yhxhkXzd3GWNJoIg&amp;token=AxricY7RBHdXj5KDRoaVJzLcgicwMBP8O1V5C0STtrMMB2CicBLbK83kgdoamZnTzxVK1GiaAYaWgRdMsAia7RI05Pibhgc2CFPuRSMZq6O6ZM1pmTmAo1YVIpsnPK5ibyEDLqIYS4leGeUUZnjIWia0Kj9WicOJmjN94NQJ4fNuxdoFoogA&amp;idx=1&amp;hy=SZ&amp;m=&amp;scene=2&amp;uzid=1" data-headimgurl="http://wx.qlogo.cn/finderhead/Q3auHgzwzM7wQicDUgicCRbhXS2icXx0uibhKJpnR2W94icicBzLkEibWlXQQ/0" data-username="v2_060000231003b20faec8c6e4801ecbdccf02ed31b077db445559df851b113daaaeeba59656a6@finder" data-nickname="生信漫漫学" data-desc="基因表达热图与功能富集分析结果联合展示" data-nonceid="3048587090623089788" data-width="1920" data-height="1080" data-type="video" data-id="export/UzFfAgtgekIEAQAAAAAAikkgRDL6GQAAAAstQy6ubaLX4KHWvLEZgBPEuacYETBOetaIzNPgMItQNKhLeCGtRsvmBBbNwt-c"></mp-common-videosnap></section><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">读取数据及获取marker基因</span></span><span></span></h3><p data-tool="mdnice编辑器"><span leaf="">首先把</span><strong><span leaf="">注释信息以及降维聚类分群的结果数据读取进来，并且将注释的metadata信息匹配到降维聚类结果中</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">###加载包和数据----</span></span><span leaf=""><br></span><span leaf="">rm(list=ls())</span><span leaf=""><br></span><span leaf="">options(stringsAsFactors = F) </span><span leaf=""><br></span><span><span leaf="">source</span></span><span leaf="">(</span><span><span leaf="">'scRNA_scripts/lib.R'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">load(</span><span><span leaf="">"sce.all.Rdata"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sce.all.int = readRDS(</span><span><span leaf="">'2-harmony/sce.all_int.rds'</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">sce.all.int@meta.data = sce.all</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">sel.clust = </span><span><span leaf="">"celltype"</span></span><span leaf=""><br></span><span leaf="">sce.all.int &lt;- SetIdent(sce.all.int, value = sel.clust)</span><span leaf=""><br></span><span leaf="">table(sce.all.int@active.ident) </span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><strong><span leaf="">marker基因获取：</span></strong><span leaf="">使用FindAllMarker计算全部细胞亚群的marker基因，然后根据文章图表结果，提取前20的marker基因</span></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#使用FindAllMarker计算marker基因，并提取top20基因----</span></span><span leaf=""><br></span><span leaf="">cell_marker &lt;- FindAllMarkers(sce.all.int, only.pos = TRUE, min.pct = 0.25,  logfc.threshold = 0.25, verbose = FALSE)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">top = cell_marker %&gt;% group_by(cluster) %&gt;% top_n(n = 20, wt = avg_log2FC ) </span><span leaf=""><br></span></code></pre><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">文章代码简析</span></span><span></span></h3><p data-tool="mdnice编辑器"><strong><span leaf="">照例文章也是给了Figure1D的实现代码，但是没有采用文章的分析代码，原因如下：</span></strong></p><ol><li><section><p><span leaf="">由于在分析过程中，文章使用的是SCT的处理方式，而复现的时候数据分析用的是三步法，注释分群信息也有少许区别，所以结果数据不完全一致</span></p></section></li><li><section><p><span leaf="">根据文章代码提取数据可视化没有得到类似的结果，所以进行了调整</span></p></section></li></ol><figure data-tool="mdnice编辑器"><span leaf=""><img data-imgfileid="100046383" data-ratio="1.5294117647058822" data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzKNrgfBxFfoK4jBDRJicx0pyvNsmibsdEcwoTCuJWaW1qMXfRZwAqQXQA/640?wx_fmt=png&amp;from=appmsg" data-type="png" data-w="680" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzKNrgfBxFfoK4jBDRJicx0pyvNsmibsdEcwoTCuJWaW1qMXfRZwAqQXQA/640?wx_fmt=png&amp;from=appmsg"></span></figure><section><span leaf="">3. 文章展示的GO数据编号，在我的富集结果中并不包含全部，所以就根据celltype提取了前三的通路进行展示</span></section><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">######## Figure 1D</span></span><span leaf=""><br></span><span leaf="">top = cell_marker %&gt;% group_by(cluster) %&gt;% top_n(n = 20, wt = avg_log2FC ) </span><span leaf=""><br></span><span leaf="">top = rbind(filter(top,cluster == </span><span><span leaf="">'T cell'</span></span><span leaf="">),filter(top,cluster == </span><span><span leaf="">'Myeloid'</span></span><span leaf="">),filter(top,cluster == </span><span><span leaf="">'B cell'</span></span><span leaf="">),filter(top,cluster == </span><span><span leaf="">'Endo'</span></span><span leaf="">),</span><span leaf=""><br></span><span leaf="">            filter(top,cluster == </span><span><span leaf="">'Mesenchyme'</span></span><span leaf="">),filter(top,cluster == </span><span><span leaf="">'Epi'</span></span><span leaf="">),filter(top,cluster == </span><span><span leaf="">'Malignant'</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">exp = AverageExpression(scdata4,group.by = </span><span><span leaf="">'celltype2'</span></span><span leaf="">,features = top</span><span><span leaf="">$gene</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">scdata4</span><span><span leaf="">$celltype2</span></span><span leaf=""> = factor(scdata4</span><span><span leaf="">$celltype2</span></span><span leaf="">,levels = c(</span><span><span leaf="">'T cell'</span></span><span leaf="">,</span><span><span leaf="">'Myeloid'</span></span><span leaf="">,</span><span><span leaf="">'B cell'</span></span><span leaf="">,</span><span><span leaf="">'Endo'</span></span><span leaf="">,</span><span><span leaf="">'Mesenchyme'</span></span><span leaf="">,</span><span><span leaf="">'Epi'</span></span><span leaf="">,</span><span><span leaf="">'Malignant'</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf="">exp = exp</span><span><span leaf="">$SCT</span></span><span leaf=""><br></span><span leaf="">exp = exp[,c(</span><span><span leaf="">'T cell'</span></span><span leaf="">,</span><span><span leaf="">'Myeloid'</span></span><span leaf="">,</span><span><span leaf="">'B cell'</span></span><span leaf="">,</span><span><span leaf="">'Endo'</span></span><span leaf="">,</span><span><span leaf="">'Mesenchyme'</span></span><span leaf="">,</span><span><span leaf="">'Epi'</span></span><span leaf="">,</span><span><span leaf="">'Malignant'</span></span><span leaf="">)]</span><span leaf=""><br></span><span leaf="">bk &lt;- c(seq(-2,2,by=0.01))</span><span leaf=""><br></span><span leaf="">color = c(colorRampPalette(colors = c(</span><span><span leaf="">"white"</span></span><span leaf="">,</span><span><span leaf="">"#FEF9F7"</span></span><span leaf="">))(length(bk)/2),colorRampPalette(colors = c(</span><span><span leaf="">"#FEF9F7"</span></span><span leaf="">,</span><span><span leaf="">"#FB6848"</span></span><span leaf="">))(length(bk)/2))</span><span leaf=""><br></span><span leaf="">pheatmap(exp, fontsize=6,</span><span leaf=""><br></span><span leaf="">         color  = color,scale = </span><span><span leaf="">'row'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">         border_color = </span><span><span leaf="">"grey60"</span></span><span leaf="">,border=T,</span><span leaf=""><br></span><span leaf="">         cluster_cols = F, cluster_rows = F,</span><span leaf=""><br></span><span leaf="">         show_rownames = F, show_colnames = T)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">library(clusterProfiler)</span><span leaf=""><br></span><span leaf="">res1 = bitr(top</span><span><span leaf="">$gene</span></span><span leaf="">,fromType=  </span><span><span leaf="">"SYMBOL"</span></span><span leaf=""> ,toType=</span><span><span leaf="">"ENTREZID"</span></span><span leaf="">,OrgDb=</span><span><span leaf="">"org.Hs.eg.db"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">rownames(res1) = res1</span><span><span leaf="">$SYMBOL</span></span><span leaf=""><br></span><span leaf="">kk &lt;- enrichKEGG(res1[filter(top,cluster == </span><span><span leaf="">'T cell'</span></span><span leaf="">)</span><span><span leaf="">$gene</span></span><span leaf=""> ,2], pvalueCutoff = 0.05,qvalueCutoff = 0.1)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">ego_BP = data.frame()</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> (i </span><span><span leaf="">in</span></span><span leaf=""> as.character(unique(top</span><span><span leaf="">$cluster</span></span><span leaf="">))) {</span><span leaf=""><br></span><span leaf="">  ego_BP2 &lt;- enrichGO(filter(top,cluster == i)</span><span><span leaf="">$gene</span></span><span leaf="">, </span><span leaf=""><br></span><span leaf="">                     OrgDb = org.Hs.eg.db,ont = </span><span><span leaf="">"BP"</span></span><span leaf="">, keyType = </span><span><span leaf="">'SYMBOL'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                     pAdjustMethod = </span><span><span leaf="">"BH"</span></span><span leaf="">,pvalueCutoff = 0.05,qvalueCutoff = 0.1,readable = FALSE)</span><span leaf=""><br></span><span leaf="">  ego_BP2@result</span><span><span leaf="">$celltype</span></span><span leaf=""> = i</span><span leaf=""><br></span><span leaf="">  ego_BP = rbind(ego_BP,ego_BP2@result[1:10,])</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf="">ego_subset = ego_BP[c(</span><span><span leaf="">'GO:0140131'</span></span><span leaf="">,</span><span><span leaf="">'GO:0035747'</span></span><span leaf="">,</span><span><span leaf="">'GO:0010820'</span></span><span leaf="">,</span><span><span leaf="">'GO:0019886'</span></span><span leaf="">,</span><span><span leaf="">'GO:0060333'</span></span><span leaf="">,</span><span><span leaf="">'GO:0043312'</span></span><span leaf="">,</span><span><span leaf="">'GO:0050864'</span></span><span leaf="">,</span><span><span leaf="">'GO:0050853'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">         </span><span><span leaf="">'GO:0042113'</span></span><span leaf="">,</span><span><span leaf="">'GO:0010739'</span></span><span leaf="">,</span><span><span leaf="">'GO:0042118'</span></span><span leaf="">,</span><span><span leaf="">'GO:004544'</span></span><span leaf="">,</span><span><span leaf="">'GO:0006936'</span></span><span leaf="">,</span><span><span leaf="">'GO:0033275'</span></span><span leaf="">,</span><span><span leaf="">'GO:0030239'</span></span><span leaf="">,</span><span><span leaf="">'GO:0070268'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">         </span><span><span leaf="">'GO:0097284'</span></span><span leaf="">,</span><span><span leaf="">'GO:0043588'</span></span><span leaf="">,   </span><span><span leaf="">'GO:0002576'</span></span><span leaf="">,</span><span><span leaf="">'GO:0034375'</span></span><span leaf="">,</span><span><span leaf="">'GO:0072376'</span></span><span leaf="">),c(2,5,6,7,8,9,10)]</span><span leaf=""><br></span><span leaf="">ego_subset</span><span><span leaf="">$log10</span></span><span leaf=""> = -log10(ego_subset</span><span><span leaf="">$p</span></span><span leaf="">.adjust)</span><span leaf=""><br></span><span leaf="">ego_subset</span><span><span leaf="">$Description</span></span><span leaf=""> = factor(ego_subset</span><span><span leaf="">$Description</span></span><span leaf="">,levels = rev(ego_subset</span><span><span leaf="">$Description</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">ggplot(ego_subset, aes(x=Description, y=log10,fill = Count)) +</span><span leaf=""><br></span><span leaf="">  geom_bar(position = </span><span><span leaf="">"dodge"</span></span><span leaf="">,</span><span><span leaf="">stat</span></span><span leaf=""> = </span><span><span leaf="">"identity"</span></span><span leaf="">,colour=</span><span><span leaf="">"black"</span></span><span leaf="">,width= 0.6)+coord_flip()+</span><span leaf=""><br></span><span leaf="">  scale_fill_gradient2(low = </span><span><span leaf="">"#EFAE95"</span></span><span leaf="">, high = </span><span><span leaf="">"#F37132"</span></span><span leaf="">)</span><span leaf=""><br></span></code></pre><h2 data-cacheurl="" data-remoteid="" data-tool="mdnice编辑器"><span></span><span><span leaf="">复现过程及代码简析</span></span><span></span></h2><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">top20基因热图绘制</span></span><span></span></h3><p data-tool="mdnice编辑器"><strong><span leaf="">因为基于文章的代码没有得到理想的结果，所以还是结合了top20基因的dotplot结果数据进行了可视化</span></strong></p><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">##气泡图联动热图</span></span><span leaf=""><br></span><span leaf="">top_dotplot &lt;- DotPlot(sce.all.int, features = top</span><span><span leaf="">$gene</span></span><span leaf="">)+</span><span leaf=""><br></span><span leaf="">  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))</span><span leaf=""><br></span><span leaf="">top_dotplot</span><span leaf=""><br></span><span><span leaf=""># 假设数据存储在 dotplot_data 中</span></span><span leaf=""><br></span><span leaf="">dotplot_data &lt;- top_dotplot</span><span><span leaf="">$data</span></span><span leaf=""><br></span><span leaf="">class(dotplot_data)</span><span leaf=""><br></span><span><span leaf="">#将数据转换为宽格式，以 `avg.exp.scaled` 为数值</span></span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">library(tidyr)</span><span leaf=""><br></span><span leaf="">library(dplyr)</span><span leaf=""><br></span><span leaf="">heatmap_data &lt;- dotplot_data %&gt;%</span><span leaf=""><br></span><span leaf="">  select(features.plot, id, avg.exp.scaled) %&gt;%</span><span leaf=""><br></span><span leaf="">  pivot_wider(names_from = features.plot, values_from = avg.exp.scaled)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf="">#将细胞分群ID列设置为行名</span></span><span leaf=""><br></span><span leaf="">library(tibble)</span><span leaf=""><br></span><span leaf="">heatmap_data = column_to_rownames(heatmap_data,var = </span><span><span leaf="">"id"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">heatmap_data = t(heatmap_data)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 构建细胞亚群注释</span></span><span leaf=""><br></span><span leaf="">cell_types &lt;- data.frame(</span><span leaf=""><br></span><span leaf="">  CellType = colnames(heatmap_data)</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">rownames(cell_types) &lt;- colnames(heatmap_data)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 设定颜色映射（根据你图片的色调调整）</span></span><span leaf=""><br></span><span leaf="">ann_colors &lt;- list(</span><span leaf=""><br></span><span leaf="">  CellType = c(</span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Tcell"</span></span><span leaf=""> = </span><span><span leaf="">"#E88C28"</span></span><span leaf="">,            </span><span><span leaf=""># 橙</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"myeloids"</span></span><span leaf=""> = </span><span><span leaf="">"#E2511D"</span></span><span leaf="">,         </span><span><span leaf=""># 深橙</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"Bcell"</span></span><span leaf=""> = </span><span><span leaf="">"#EAD8BC"</span></span><span leaf="">,            </span><span><span leaf=""># 浅米色</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"endothelial"</span></span><span leaf=""> = </span><span><span leaf="">"#8BC6B6"</span></span><span leaf="">,      </span><span><span leaf=""># 青绿色</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"myofibroblasts"</span></span><span leaf=""> = </span><span><span leaf="">"#3BA935"</span></span><span leaf="">,   </span><span><span leaf=""># 草绿色</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"macrophages"</span></span><span leaf=""> = </span><span><span leaf="">"#D1796A"</span></span><span leaf="">,      </span><span><span leaf=""># 土红色</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"epithelial"</span></span><span leaf=""> = </span><span><span leaf="">"#DCAAC2"</span></span><span leaf="">,       </span><span><span leaf=""># 粉灰色</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"cycle"</span></span><span leaf=""> = </span><span><span leaf="">"#F09BA0"</span></span><span leaf="">,            </span><span><span leaf=""># 淡粉红</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"mast"</span></span><span leaf=""> = </span><span><span leaf="">"#E3A088"</span></span><span leaf="">,             </span><span><span leaf=""># 橙粉色</span></span><span leaf=""><br></span><span leaf="">    </span><span><span leaf="">"hepatocytes"</span></span><span leaf=""> = </span><span><span leaf="">"#F73C2E"</span></span><span leaf="">       </span><span><span leaf=""># 红色</span></span><span leaf=""><br></span><span leaf="">  )</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 色带</span></span><span leaf=""><br></span><span leaf="">bk &lt;- seq(-2, 2, by = 0.01)</span><span leaf=""><br></span><span leaf="">color &lt;- c(</span><span leaf=""><br></span><span leaf="">  colorRampPalette(colors = c(</span><span><span leaf="">"white"</span></span><span leaf="">, </span><span><span leaf="">"#FEF9F7"</span></span><span leaf="">))(length(bk) / 2),</span><span leaf=""><br></span><span leaf="">  colorRampPalette(colors = c(</span><span><span leaf="">"#FEF9F7"</span></span><span leaf="">, </span><span><span leaf="">"#FB6848"</span></span><span leaf="">))(length(bk) / 2)</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">library(pheatmap)</span><span leaf=""><br></span><span><span leaf=""># 绘制热图</span></span><span leaf=""><br></span><span leaf="">pdf(</span><span><span leaf="">"pheatmap_top20.pdf"</span></span><span leaf="">, width = 10, height = 14)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">pheatmap(</span><span leaf=""><br></span><span leaf="">  heatmap_data,</span><span leaf=""><br></span><span leaf="">  fontsize = 6,</span><span leaf=""><br></span><span leaf="">  color = color,</span><span leaf=""><br></span><span leaf="">  scale = </span><span><span leaf="">'row'</span></span><span leaf="">,</span><span leaf=""><br></span><span><span leaf="">#border_color = "grey60",</span></span><span leaf=""><br></span><span leaf="">  cluster_cols = FALSE,</span><span leaf=""><br></span><span leaf="">  cluster_rows = FALSE,</span><span leaf=""><br></span><span leaf="">  show_rownames = TRUE,</span><span leaf=""><br></span><span leaf="">  show_colnames = TRUE,</span><span leaf=""><br></span><span leaf="">  fontsize_row = 4,</span><span leaf=""><br></span><span leaf="">  fontsize_col = 12,</span><span leaf=""><br></span><span leaf="">  angle_col = </span><span><span leaf="">"45"</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">  annotation_col = cell_types,</span><span leaf=""><br></span><span leaf="">  annotation_colors = ann_colors,</span><span leaf=""><br></span><span leaf="">  legend = T</span><span leaf=""><br></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">dev.off()</span><span leaf=""><br></span></code></pre><p data-tool="mdnice编辑器"><strong><span leaf="">代码简析：</span></strong></p><section><span leaf="">1. 首先基于提取的top20基因，使用dotplot进行可视化，并且保存了相应的结果数据</span></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzBG3SVC89q5bxWrKWEoYDOHpTSCjpXrVKkMibpvTAgGwniaTM3pXZTTsg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5018518518518519" data-type="png" data-w="1080" data-imgfileid="100046386" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzBG3SVC89q5bxWrKWEoYDOHpTSCjpXrVKkMibpvTAgGwniaTM3pXZTTsg/640?wx_fmt=png&amp;from=appmsg"></span></figure><section><span leaf="">2. 基于得到的dotplot结果数据进行整理，提取需要的列，并进行格式转换，以及转置</span></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pza7qKn6asNgugFyHibD3mI2p94O7FlR0m2a1m3bB1hmDfIIcR4pjDGOg/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8944444444444445" data-type="png" data-w="1080" data-imgfileid="100046387" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pza7qKn6asNgugFyHibD3mI2p94O7FlR0m2a1m3bB1hmDfIIcR4pjDGOg/640?wx_fmt=png&amp;from=appmsg"></span></figure><section><span leaf="">3. 使用pheatmap绘图，并且按照注释的细胞亚群注释信息整理设置对应的颜色，将结果导出保存为PDF格式，方便后续拼图</span></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pz31H5DbuiaotXu3MynYPYf8VxjicFyXT9iaHXcYANb7DYovVX7c3KUnSBQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="1.1546296296296297" data-type="png" data-w="1080" data-imgfileid="100046384" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pz31H5DbuiaotXu3MynYPYf8VxjicFyXT9iaHXcYANb7DYovVX7c3KUnSBQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">基因富集分析及可视化</span></span><span></span></h3><pre data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><code><span><span leaf="">#绘制富集分析结果图----</span></span><span leaf=""><br></span><span leaf="">library(clusterProfiler)</span><span leaf=""><br></span><span leaf="">res1 = bitr(top</span><span><span leaf="">$gene</span></span><span leaf="">,fromType=  </span><span><span leaf="">"SYMBOL"</span></span><span leaf=""> ,toType=</span><span><span leaf="">"ENTREZID"</span></span><span leaf="">,OrgDb=</span><span><span leaf="">"org.Hs.eg.db"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf="">rownames(res1) = res1</span><span><span leaf="">$SYMBOL</span></span><span leaf=""><br></span><span leaf="">kk &lt;- enrichKEGG(res1[filter(top,cluster == </span><span><span leaf="">'Tcell'</span></span><span leaf="">)</span><span><span leaf="">$gene</span></span><span leaf=""> ,2], pvalueCutoff = 0.05,qvalueCutoff = 0.1)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">ego_BP = data.frame()</span><span leaf=""><br></span><span leaf="">library(org.Hs.eg.db)</span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> (i </span><span><span leaf="">in</span></span><span leaf=""> as.character(unique(top</span><span><span leaf="">$cluster</span></span><span leaf="">))) {</span><span leaf=""><br></span><span leaf="">  ego_BP2 &lt;- enrichGO(filter(top,cluster == i)</span><span><span leaf="">$gene</span></span><span leaf="">, </span><span leaf=""><br></span><span leaf="">                      OrgDb = org.Hs.eg.db,ont = </span><span><span leaf="">"BP"</span></span><span leaf="">, keyType = </span><span><span leaf="">'SYMBOL'</span></span><span leaf="">,</span><span leaf=""><br></span><span leaf="">                      pAdjustMethod = </span><span><span leaf="">"BH"</span></span><span leaf="">,pvalueCutoff = 0.05,qvalueCutoff = 0.1,readable = FALSE)</span><span leaf=""><br></span><span leaf="">  ego_BP2@result</span><span><span leaf="">$celltype</span></span><span leaf=""> = i</span><span leaf=""><br></span><span leaf="">  ego_BP = rbind(ego_BP,ego_BP2@result[1:10,])</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 获取所有需要的细胞类型</span></span><span leaf=""><br></span><span leaf="">celltypes &lt;- unique(ego_BP</span><span><span leaf="">$celltype</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 初始化一个空的数据框来存储所有细胞类型前三的结果</span></span><span leaf=""><br></span><span leaf="">top3_all_celltypes &lt;- data.frame()</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 对每个细胞类型进行处理</span></span><span leaf=""><br></span><span><span leaf="">for</span></span><span leaf=""> (celltype </span><span><span leaf="">in</span></span><span leaf=""> celltypes) {</span><span leaf=""><br></span><span><span leaf=""># 筛选出当前细胞类型的数据</span></span><span leaf=""><br></span><span leaf="">  celltype_results &lt;- ego_BP[ego_BP</span><span><span leaf="">$celltype</span></span><span leaf=""> == celltype, ]</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 根据p值进行排序并选择前三行</span></span><span leaf=""><br></span><span leaf="">  top3_results &lt;- celltype_results %&gt;% </span><span leaf=""><br></span><span leaf="">    arrange(p.adjust) %&gt;%</span><span leaf=""><br></span><span leaf="">    head(3)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 将结果添加到总的数据框中</span></span><span leaf=""><br></span><span leaf="">  top3_all_celltypes &lt;- rbind(top3_all_celltypes, top3_results)</span><span leaf=""><br></span><span leaf="">}</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 计算-log10调整后的p值</span></span><span leaf=""><br></span><span leaf="">top3_all_celltypes</span><span><span leaf="">$log10</span></span><span leaf=""> = -log10(top3_all_celltypes</span><span><span leaf="">$p</span></span><span leaf="">.adjust)</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 设置GO条目的显示顺序</span></span><span leaf=""><br></span><span leaf="">top3_all_celltypes</span><span><span leaf="">$Description</span></span><span leaf=""> = factor(top3_all_celltypes</span><span><span leaf="">$Description</span></span><span leaf="">, levels = rev(top3_all_celltypes</span><span><span leaf="">$Description</span></span><span leaf="">))</span><span leaf=""><br></span><span leaf=""><br></span><span><span leaf=""># 绘制条形图</span></span><span leaf=""><br></span><span leaf="">ggplot(top3_all_celltypes, aes(x=Description, y=log10, fill=celltype)) +</span><span leaf=""><br></span><span leaf="">  geom_bar(</span><span><span leaf="">stat</span></span><span leaf="">=</span><span><span leaf="">"identity"</span></span><span leaf="">, position=</span><span><span leaf="">"dodge"</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  coord_flip() +</span><span leaf=""><br></span><span leaf="">  scale_fill_manual(values = ann_colors</span><span><span leaf="">$CellType</span></span><span leaf="">) + </span><span><span leaf=""># 使用手动设置的颜色</span></span><span leaf=""><br></span><span leaf="">  theme_minimal() +</span><span leaf=""><br></span><span leaf="">  labs(x = </span><span><span leaf="">"Enriched GO terms"</span></span><span leaf="">, y = </span><span><span leaf="">"-log10(adj.p.value)"</span></span><span leaf="">, fill = </span><span><span leaf="">"Cell Type"</span></span><span leaf="">) +</span><span leaf=""><br></span><span leaf="">  theme(legend.position = </span><span><span leaf="">"bottom"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span><span leaf="">ggsave(</span><span><span leaf="">"Enriched_GO_terms.pdf"</span></span><span leaf="">, width = 10, height = 14, units = </span><span><span leaf="">"in"</span></span><span leaf="">)</span><span leaf=""><br></span><span leaf=""><br></span></code></pre><section><span leaf="">1. 首先使用clusterProfiler包，基于org.Hs.eg.db数据库文件，用for循环一次找到cluster对应的注释结果</span></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzjYuNwf5hzMz6q8ialvXQYKVsBMyKgclticsc1c7HWCJ7aBKR1mlZSH9A/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.5166666666666667" data-type="png" data-w="1080" data-imgfileid="100046391" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzjYuNwf5hzMz6q8ialvXQYKVsBMyKgclticsc1c7HWCJ7aBKR1mlZSH9A/640?wx_fmt=png&amp;from=appmsg"></span></figure><section><span leaf="">2. 获取所有需要的细胞注释类型，初始化一个空的数据框来存储所有细胞类型前三的结果</span></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzcNm3s9icAkNbyFvkloicVpfDMiamqkl1ndZox7QI9UpQ57haHoFgndwiaQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.44722222222222224" data-type="png" data-w="1080" data-imgfileid="100046390" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzcNm3s9icAkNbyFvkloicVpfDMiamqkl1ndZox7QI9UpQ57haHoFgndwiaQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><section><span leaf="">3. 设置GO条目的显示顺序，使用ggplot绘制对应的GO条目图，并且按照细胞注释类型指定对应的颜色，最终也导出为PDF格式</span></section><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzhkUW9jcSeoKwGacyXUSV459N6D8emEYP9zUM24EIEWiah69ITWGjibYQ/640?wx_fmt=png&amp;from=appmsg" data-ratio="0.8648148148148148" data-type="png" data-w="1080" data-imgfileid="100046389" src="https://mmbiz.qpic.cn/mmbiz_png/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzhkUW9jcSeoKwGacyXUSV459N6D8emEYP9zUM24EIEWiah69ITWGjibYQ/640?wx_fmt=png&amp;from=appmsg"></span></figure><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">使用AI进行拼图得到最终结果</span></span><span></span></h3><figure data-tool="mdnice编辑器"><span leaf=""><img data-src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzRMlXHDHYmpuXEnGXahu0masbiblMsxpqykayTfj29zh6Kq6uBic9J9Ig/640?wx_fmt=jpeg&amp;from=appmsg" data-ratio="1.1037037037037036" data-type="jpeg" data-w="1080" data-imgfileid="100046392" src="https://mmbiz.qpic.cn/mmbiz_jpg/siaia0BDGJdjT3VzO4ztZgncBOoQsjS4pzRMlXHDHYmpuXEnGXahu0masbiblMsxpqykayTfj29zh6Kq6uBic9J9Ig/640?wx_fmt=jpeg&amp;from=appmsg"></span></figure><p data-tool="mdnice编辑器"><strong><span leaf="">不足之处：</span></strong></p><ol><li><section><p><span leaf="">最开始拼图的时候使用的是带有灰色背景的热图，后续使用代码去除掉了，大家可以使用没有灰色背景的内容</span></p></section></li><li><section><p><span leaf="">GO条码的注释信息，因为有些较长，所以没有能够完全排列整齐，大家可以使用A3画板拼图试试</span></p></section></li><li><section><p><span leaf="">没有给细胞信息也修改颜色（偷懒了），确实使用AI改色也比较方便，大家可以试试看</span></p></section></li></ol><h3 data-tool="mdnice编辑器"><span data-cacheurl="" data-remoteid=""></span><span></span><span><span leaf="">文末友情宣传</span></span><span></span></h3><p data-tool="mdnice编辑器"><strong><span leaf="">如果你也想做单细胞转录组数据分析，最好是有自己的计算机资源哦，比如我们的<a href="https://mp.weixin.qq.com/s?__biz=MzUzMTEwODk0Ng==&amp;mid=2247530048&amp;idx=1&amp;sn=28aa7bbd5e00521f79e074496a5f5d66&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">满足你生信分析计算需求的低价解决方案</a>，而且还需要有基本的生物信息学基础，也可以看看我们的<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247541231&amp;idx=1&amp;sn=6704a3ae8233d19ca94fd4929b5e1f63&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">生物信息学马拉松授课</a>，你的生物信息学入门课。</span></strong></p><p data-tool="mdnice编辑器"><strong><span leaf="">2025年也会继续学习分享单细胞内容，并且组建了交流群——<a href="https://mp.weixin.qq.com/s?__biz=MzAxMDkxODM1Ng==&amp;mid=2247536175&amp;idx=1&amp;sn=7391227554e6aed88bfc0dbcd8546e78&amp;scene=21#wechat_redirect" textvalue="" target="_blank" linktype="text" data-linktype="2">承包你2025全部的单细胞转录组降维聚类分群</a>，欢迎一起讨论交流学习！</span></strong></p></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/NuIEI6V6Rmo5-XEE_4_XCw",target="_blank" rel="noopener noreferrer">原文链接</a>
