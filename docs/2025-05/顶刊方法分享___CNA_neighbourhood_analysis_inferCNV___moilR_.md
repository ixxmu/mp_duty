---
title: "顶刊方法分享---CNA neighbourhood analysis（inferCNV + moilR）"
date: 2025-05-14T07:33:52Z
draft: ["false"]
tags: [
  "fetched",
  "单细胞空间交响乐"
]
categories: ["Acdemic"]
---
顶刊方法分享---CNA neighbourhood analysis（inferCNV + moilR） by 单细胞空间交响乐
------
<div><h4 data-line="0" data-pm-slice="0 0 []"><span leaf="">作者，Evil Genius</span></h4><h4 data-line="2"><span leaf="">我们在学习了CNV和miloR之后，就要将两者进行联合分析了。</span></h4><h4 data-line="4"><span leaf="">参考文章</span></h4><section nodeleaf=""><img data-imgfileid="100012347" data-type="other" data-ratio="0.49907407407407406" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9iabPjgZgZo27vDZzqex4CzSay9PHlveibJiaOictbLkWdBRuicY8VC7z55A/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9iabPjgZgZo27vDZzqex4CzSay9PHlveibJiaOictbLkWdBRuicY8VC7z55A/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="7"><span leaf="">分析结果</span></h4><section nodeleaf=""><img data-imgfileid="100012345" data-type="other" data-ratio="0.6527777777777778" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9FFCI9c4sibZYRb863icdt3zraOr2QIXdv5qsvlRWdJicWD6wqGra6x4eQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9FFCI9c4sibZYRb863icdt3zraOr2QIXdv5qsvlRWdJicWD6wqGra6x4eQ/640?wx_fmt=other&amp;from=appmsg"></section><section><br></section><section nodeleaf=""><img data-imgfileid="100012348" data-type="other" data-ratio="0.6462962962962963" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9lE9m8QHhejeCdc1KaPVqxaELCjCBNBNlIHhkJwXlRVBicgqia3IT7ppQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9lE9m8QHhejeCdc1KaPVqxaELCjCBNBNlIHhkJwXlRVBicgqia3IT7ppQ/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="11"><span leaf="">其核心就在于结合CNV + miloR的分析内容。</span></h4><h4 data-line="13"><span leaf="">分析方法</span></h4><h5 data-line="14"><span leaf="">首先是CNV分析</span></h5><section nodeleaf=""><img data-imgfileid="100012349" data-type="other" data-ratio="1.0761750405186385" data-w="617" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9aqf3EDU5WAlicZwS0BlAphO9d1fiaBt7zJkkibzrXxOAcbzpSRU288jOw/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9aqf3EDU5WAlicZwS0BlAphO9d1fiaBt7zJkkibzrXxOAcbzpSRU288jOw/640?wx_fmt=other&amp;from=appmsg"></section><h5 data-line="17"><span leaf="">其次是CNA neighbourhood analysis</span></h5><section nodeleaf=""><img data-imgfileid="100012346" data-type="other" data-ratio="0.5066666666666667" data-w="600" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9aHviaibcRqrCGlDSbibXqWo6KGtB32ZCEGET1XJVq0UP9ibf2ADvIe6fIA/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9aHviaibcRqrCGlDSbibXqWo6KGtB32ZCEGET1XJVq0UP9ibf2ADvIe6fIA/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="20"><span leaf="">简单复习一下miloR的分析思路</span></h4><h4 data-line="20"><span leaf=""><img data-imgfileid="100012353" data-ratio="0.5703703703703704" data-type="other" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9RAT4ZjkRMZW0wBWAHSdYfpa136WBQ94OoVmIHg1LsaYx2ubyl3iasmQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9RAT4ZjkRMZW0wBWAHSdYfpa136WBQ94OoVmIHg1LsaYx2ubyl3iasmQ/640?wx_fmt=other&amp;from=appmsg"></span></h4><h4 data-line="12" data-pm-slice="0 0 []"><span leaf="">其核心原理是通过构建细胞邻域（Neighborhood）来检测实验条件或生物状态对特定细胞群体分布的影响。算法核心原理是基于混合模型框架 和 K-最近邻（KNN）图的统计方法。</span></h4><h4 data-line="14"><span leaf="">关键步骤</span></h4><h5 data-line="15"><span leaf="">(1) 构建 KNN 图</span></h5><p data-line="16"><span leaf="">基于降维后的细胞嵌入（如 PCA、UMAP），计算细胞间的欧氏距离，构建 K-最近邻图（KNN graph）。</span><br><span leaf="">每个细胞的邻域定义为与其最近的 k 个邻居（默认 k=30），形成重叠的局部细胞群体。</span></p><h5 data-line="18"><span leaf="">(2) 定义邻域（Neighborhoods）</span></h5><p data-line="19"><span leaf="">对每个细胞，统计其所属的邻域（即作为其他细胞的邻居的次数），形成邻域-细胞矩阵。</span><br><span leaf="">通过 图抽样（graph sampling） 减少冗余，保留代表性邻域。（ The first step in our method is to define a set of representative neighborhoods on the KNN graph, where a neighborhood is defined as the group of cells that are connected to an index cell by an edge in the graph. ）</span></p><h5 data-line="21"><span leaf="">(3) 差异丰度检验。对每个邻域中存在的细胞数量进行计数（每个实验样品），并将其用于条件之间的差异丰度测试。</span></h5><h6 data-line="22"><span leaf="">广义线性混合模型（GLMM）：</span></h6><p data-line="23"><span leaf="">对每个邻域，拟合一个混合模型（如负二项分布或泊松分布），以实验条件（如分组）作为固定效应，样本（个体）作为随机效应，校正批次效应或个体间差异。</span></p><pre><code><span leaf="">counts ~ condition + (1 | sample)</span><br></code></pre><p data-line="27"><span leaf="">其中 counts 是邻域中的细胞数，condition 是分组变量，sample 是样本来源。</span></p><h6 data-line="28"><span leaf="">假设检验：</span></h6><p data-line="29"><span leaf="">通过似然比检验（LRT）或 Wald 检验比较模型（有/无实验条件效应），得到差异丰度的 p 值。</span></p><h5 data-line="30"><span leaf="">(4) 多重检验校正</span></h5><p data-line="31"><span leaf="">使用 FDR（如 Benjamini-Hochberg）校正邻域水平的 p 值，控制假阳性率。</span></p><h5 data-line="32"><span leaf="">(5) 结果可视化</span></h5><p><span leaf="">通过 UMAP 或降维图标记显著差异的邻域，结合火山图展示 logFC 和显著性。</span></p><section><br></section><section nodeleaf=""><img data-imgfileid="100012356" data-type="other" data-ratio="1.7532679738562091" data-w="612" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9BW0BvKp2IthpZ3GV0AnRNJZnrWhMW45pMhuEDgJytmXv40O0pljBKQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9BW0BvKp2IthpZ3GV0AnRNJZnrWhMW45pMhuEDgJytmXv40O0pljBKQ/640?wx_fmt=other&amp;from=appmsg"></section><section><br></section><section nodeleaf=""><img data-imgfileid="100012354" data-type="other" data-ratio="0.3951537744641193" data-w="1073" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic90wibfDr6gZH3PfTucbKsibIYib7rQsTSdQXgVu1ia8mNL7ZSOlQPhWQTjQ/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic90wibfDr6gZH3PfTucbKsibIYib7rQsTSdQXgVu1ia8mNL7ZSOlQPhWQTjQ/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="20"><span leaf="">我们来实现一下,我们从CNV矩阵开始。</span></h4><pre><code><span leaf="">libarary(Seurat)</span><br><span leaf="">library(miloR)</span><br><span leaf="">library(SingleCellExperiment)</span><br><span leaf="">library(scater)</span><br><span leaf="">library(scran)</span><br><span leaf="">library(dplyr)</span><br><span leaf="">library(patchwork)</span><br><br><span leaf="">expression_matrix &lt;- read.csv(</span><span><span leaf="">"cnv_matrix.csv"</span></span><span leaf="">, row.names =</span><span><span leaf="">1</span></span><span leaf="">)</span><br><br><span leaf="">seurat_object &lt;-CreateSeuratObject(counts = expression_matrix)</span><br><br><span leaf="">seurat_object &lt;-NormalizeData(seurat_object)</span><br><span><span leaf="">####这个地方看文献是均一化之后直接进行PCA分析</span></span><br><span leaf="">seurat_object &lt;-RunPCA(seurat_object, features =rownames(seurat_object))</span><br><span><span leaf="">####获取PCA矩阵</span></span><br><span leaf="">pca_matrix = seurat_object@reductions$pca@cell.embeddings</span><br><span leaf="">pca_matrix</span><br></code></pre><section nodeleaf=""><img data-imgfileid="100012351" data-type="other" data-ratio="0.5" data-w="808" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9oKZribMCX6ic0HVmVeFicq0SycD4q5ibVxhbEtEJ3iacpwGAI2pnkMokXNA/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9oKZribMCX6ic0HVmVeFicq0SycD4q5ibVxhbEtEJ3iacpwGAI2pnkMokXNA/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="43"><span leaf="">进行miloR分析</span></h4><pre><code><span leaf="">sce &lt;-SingleCellExperiment(assays=list(counts=seurat_object@assays$RNA@counts, logcounts=seurat_object@assays$RNA@data),reducedDims=SimpleList(PCA=seurat_object@reductions$pca@cell.embeddings))</span><br><span leaf="">milo &lt;-Milo(sce)</span><br><span><span leaf="">###Construct KNN graph</span></span><br><span leaf="">milo &lt;- buildGraph(sce, k =</span><span><span leaf="">30</span></span><span leaf="">, d =</span><span><span leaf="">30</span></span><span leaf="">, reduced.dim =</span><span><span leaf="">"PCA"</span></span><span leaf="">)</span><br><span leaf="">milo &lt;- makeNhoods(milo)</span><br><span><span leaf="">####Defining representative neighbourhoods on the KNN graph</span></span><br><span leaf="">milo &lt;- makeNhoods(milo, prop =</span><span><span leaf="">0</span></span><span leaf="">.</span><span><span leaf="">1</span></span><span leaf="">, k =</span><span><span leaf="">30</span></span><span leaf="">, d=</span><span><span leaf="">30</span></span><span leaf="">, refined =TRUE, reduced_dims =</span><span><span leaf="">"PCA"</span></span><span leaf="">)</span><br><span><span leaf="">####Computing neighbourhood connectivity</span></span><br><span leaf="">milo &lt;- calcNhoodDistance(milo, d=</span><span><span leaf="">30</span></span><span leaf="">, reduced.dim =</span><span><span leaf="">"PCA"</span></span><span leaf="">)</span><br><span><span leaf="">####testing</span></span><br><span><span leaf="">#####注释信息</span></span><br><span leaf="">design &lt;- data.frame(colData(embryo_milo))[,c(</span><span><span leaf="">"sample"</span></span><span leaf="">,</span><span><span leaf="">"disease"</span></span><span leaf="">,</span><span><span leaf="">"celltype"</span></span><span leaf="">)]</span><br><br><span leaf="">milo &lt;- buildNhoodGraph(milo)</span><br><span leaf="">da_results &lt;- testNhoods(milo, design =~ sample + disease, design.df = design)</span><br><br><span leaf="">plotNhoodGroups(embryo_milo, da_results, layout=</span><span><span leaf="">"umap"</span></span><span leaf="">)</span><br></code></pre><section nodeleaf=""><img data-imgfileid="100012350" data-type="other" data-ratio="0.3212962962962963" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9A4T6bDCsd4eMp73JdrfxPiawF3icu7tOCsWgtKn4KuNEU2s5tLsZTAgA/640?wx_fmt=other&amp;from=appmsg" src="https://mmbiz.qpic.cn/mmbiz_jpg/srXAibe95Mmk4SVfFKY95HjDDXNbia9dic9A4T6bDCsd4eMp73JdrfxPiawF3icu7tOCsWgtKn4KuNEU2s5tLsZTAgA/640?wx_fmt=other&amp;from=appmsg"></section><h4 data-line="65"><span leaf="">生活很好，有你更好。</span></h4><section nodeleaf=""><mp-common-cpsad data-templateid="list" data-traceid="076b2e85-8a6b-4b01-a0ea-78e53503cf71" data-goodssouce="1" data-pid="104_2700199265" data-appuin="undefined" data-cpsversion="test/20241128_feat_click_message"></mp-common-cpsad></section><section><span leaf=""><br></span></section><p><mp-style-type data-value="3"></mp-style-type></p></div>  
<hr>
<a href="https://mp.weixin.qq.com/s/cNW1tdL0pvUuyyLlv7L20w",target="_blank" rel="noopener noreferrer">原文链接</a>
